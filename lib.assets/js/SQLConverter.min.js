class SQLConverter{constructor(){this.dbToSqlite={int:"INTEGER",tinyint:"INTEGER",tinyint:"INTEGER",smallint:"INTEGER",mediumint:"INTEGER",bigint:"INTEGER",float:"REAL",double:"REAL",decimal:"REAL",nvarchar:"NVARCHAR",varchar:"NVARCHAR","character varying":"NVARCHAR",char:"TEXT",text:"TEXT",tinytext:"TEXT",mediumtext:"TEXT",longtext:"TEXT",date:"TEXT",datetime:"TEXT",timestamp:"TEXT",time:"TEXT",year:"INTEGER",boolean:"INTEGER",json:"TEXT",jsonb:"TEXT",integer:"INTEGER",serial:"INTEGER",bigserial:"INTEGER","double precision":"REAL",timestamptz:"TEXT"},this.dbToMySQL={INTEGER:"INT",REAL:"FLOAT",TEXT:"TEXT",NVARCHAR:"VARCHAR",VARCHAR:"VARCHAR","CHARACTER VARYING":"VARCHAR","TINYINT(1)":"TINYINT(1)",BOOLEAN:"TINYINT(1)",DATETIME:"DATETIME",DATE:"DATE",TIMESTAMPTZ:"TIMESTAMP","TIMESTAMP WITH TIME ZONE":"TIMESTAMP","TIMESTAMP WITHOUT TIME ZONE":"DATETIME",TIMESTAMP:"TIMESTAMPTZ",JSON:"JSON"},this.dbToPostgreSQL={INTEGER:"INTEGER",REAL:"REAL",TEXT:"TEXT",NVARCHAR:"CHARACTER VARYING",VARCHAR:"CHARACTER VARYING",BOOLEAN:"BOOLEAN",DATETIME:"TIMESTAMP",DATE:"DATE",TIMESTAMPTZ:"TIMESTAMP WITH TIME ZONE",TIMESTAMP:"TIMESTAMP WITH TIME ZONE",DATETIME:"TIMESTAMP WITHOUT TIME ZONE",JSON:"JSONB"}}replaceAll(e,t,T){let l=RegExp(t,"gi");return e.replace(l,T)}translate(e,t){let T=[],l=this.extractDropTableQueries(e,t);for(let r in l)T.push("-- DROP TABLE IF EXISTS "+l[r].table+";");e=this.replaceAll(e,"`",""),e=this.replaceAll(e," timestamp with time zone"," timestamptz"),e=this.replaceAll(e," timestamp without time zone"," timestamp"),e=this.replaceAll(e," character varying"," varchar"),e=this.replaceAll(e,' COLLATE pg_catalog."default"',""),e=this.replaceAll(e," TINYINT(1)"," boolean");let s=new TableParser;s.parseAll(e);let i=s.getResult(),a=[];for(let o in i){let E=this.convertQuery(i[o],t);a.push(E),a.push("")}return T.length>0&&T.push("\r\n\r\n"),T.join("\r\n")+a.join("\r\n")}convertQuery(e,t){return"sqlite"===t?this.toSqliteOut(e,t):"mysql"===t||"mariadb"===t?this.toMySQLOut(e,t):"pgsql"===t||"postgresql"===t?this.toPostgreSQLOut(e,t):void 0}toSqliteOut(e,t){let T={};for(let l in T.tableName=e.tableName,T.primaryKey=e.primaryKey,T.columns=[],e.columns){let r=Object.assign({},e.columns[l]);r.Type=this.toSqliteType(r.Type,r.Length),T.columns.push(r)}return this.toSqliteTable(T,t)}toMySQLOut(e,t){let T={};for(let l in T.tableName=e.tableName,T.primaryKey=e.primaryKey,T.columns=[],e.columns){let r=Object.assign({},e.columns[l]);r.Field=r.Field,r.Type=this.toMySQLType(r.Type,r.Length),T.columns.push(r)}return this.toMySQLTable(T,t)}toPostgreSQLOut(e,t){let T={};for(let l in T.tableName=e.tableName,T.primaryKey=e.primaryKey,T.columns=[],e.columns){let r=Object.assign({},e.columns[l]);r.Type=this.toPostgreSQLType(r.Type,r.Length),T.columns.push(r)}return this.toPostgreSQLTable(T,t)}toSqliteTable(e,t){return this.toTable(e,t)}toMySQLTable(e,t){return this.toTable(e,t)}toPostgreSQLTable(e,t){return this.toTable(e,t)}toTable(e,t){let T=e.tableName;-1!==T.indexOf(".")&&(T=T.split(".")[1]);let l=[];"mysql"===t||"mariadb"===t?T="`"+T+"`":("pgsql"===t||"postgresql"===t)&&(T='"'+T+'"'),l.push("CREATE TABLE IF NOT EXISTS "+T),l.push("(");let r=[];for(let s in e.columns){let i=e.columns[s].Field;("mysql"===t||"mariadb"===t)&&(i="`"+i+"`");let a=e.columns[s].Field===e.primaryKey,o="	"+i+" "+e.columns[s].Type;a?(o+=" PRIMARY KEY",o+=" NOT NULL",e.columns[s].Nullable=!1):e.columns[s].Nullable?o+=" NULL":o+=" NOT NULL";let E=e.columns[s].Default;a||""===E||null===E||(E=this.replaceAll(E,"::character varying",""),""===(E=this.fixDefaultValue(E,t))||null===E||(o+=" DEFAULT "+E)),r.push(o)}return l.push(r.join(",\r\n")),l.push(");"),l.join("\r\n")}fixDefaultValue(e,t){return"sqlite"===t&&-1!==e.toLowerCase().indexOf("now(")&&(e=""),e}toSqliteType(e,t){let T="TEXT";for(let l in this.dbToSqlite)if(this.dbToSqlite.hasOwnProperty(l)){let r=l.toString();if(0===e.toLowerCase().indexOf(r.toLowerCase())){T=this.dbToSqlite[r];break}}if(-1!=e.toUpperCase().indexOf("ENUM")){let{resultArray:s,maxLength:i}=this.parseEnumValue(t);T="NVARCHAR("+(i+2)+")"}else("NVARCHAR"===T||"INT"===T)&&t>0&&(T=T+"("+t+")");return T}toMySQLType(e,t){let T="TEXT";if("TINYINT"===e.toUpperCase()&&1==t)return"TINYINT(1)";if(("TINYINT"===e.toUpperCase()||"SMALLINT"===e.toUpperCase()||"MEDIUMINT"===e.toUpperCase()||"BIGINT"===e.toUpperCase()||"INTEGER"===e.toUpperCase()||"INT"===e.toUpperCase())&&t>0)return`${e}(${t})`;for(let l in this.dbToMySQL)if(this.dbToMySQL.hasOwnProperty(l)){let r=l.toString();if(0===e.toLowerCase().indexOf(r.toLowerCase())){T=this.dbToMySQL[r];break}}if(T=this.replaceAll(T,"TIMESTAMPTZ","TIMESTAMP"),-1!=e.toUpperCase().indexOf("ENUM")){let{resultArray:s,maxLength:i}=this.parseEnumValue(t);T="enum('"+s.join("','")+"')"}return"VARCHAR"===T&&t>0&&(T=T+"("+t+")"),T}toPostgreSQLType(e,t){let T="TEXT";for(let l in this.dbToPostgreSQL)if(this.dbToPostgreSQL.hasOwnProperty(l)){let r=l.toString();if(0===e.toLowerCase().indexOf(r.toLowerCase())){T=this.dbToPostgreSQL[r];break}}if(-1!=e.toUpperCase().indexOf("ENUM")){let{resultArray:s,maxLength:i}=this.parseEnumValue(t);T="CHARACTER VARYING("+(i+2)+")"}else"CHARACTER VARYING"===T&&t>0&&(T=T+"("+t+")");return T}parseEnumValue(e){let t=/'([^']+)'/g,T,l=[];for(;null!==(T=t.exec(e));)l.push(T[1]);let r=l.reduce((e,t)=>t.length>e?t.length:e,0);return{resultArray:l,maxLength:r}}extractDropTableQueries(e,t){let T=e.replace(/`/g,""),l=/DROP TABLE IF EXISTS ([^\s]+)/gi,r,s=[];for(;null!==(r=l.exec(T));){let i=this.extractTableName(r[1]);"pgsql"===t?i='"'+i+'"':("mysql"===t||"mariadb"===t)&&(i="`"+i+"`"),console.log(i),s.push({table:i})}return s}extractTableName(e){return e.includes(".")?e.split(".")[1]:e}}