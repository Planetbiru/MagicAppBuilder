class SQLConverter{constructor(){this.dbToSqlite={int:"INTEGER",bit:"BOOLEAN","tinyint(1)":"BOOLEAN",tinyint:"INTEGER",smallint:"INTEGER",mediumint:"INTEGER",bigint:"INTEGER",real:"REAL",float:"REAL",double:"REAL",decimal:"REAL",nvarchar:"NVARCHAR",varchar:"NVARCHAR","character varying":"NVARCHAR",char:"NVARCHAR",tinytext:"TEXT",mediumtext:"TEXT",longtext:"TEXT",text:"TEXT",datetime2:"TIMESTAMP",datetime:"DATETIME",timestamp:"TIMESTAMP",date:"DATE",time:"TIME",year:"INTEGER",boolean:"INTEGER",json:"TEXT",jsonb:"TEXT",integer:"INTEGER",serial:"INTEGER",bigserial:"INTEGER","double precision":"REAL",timestamptz:"TIMESTAMP"},this.dbToMySQL={bigint:"BIGINT",serial:"BIGINT",bigserial:"BIGINT",mediumint:"MEDIUMINT",smallint:"SMALLINT",integer:"INT",double:"DOUBLE",float:"FLOAT",real:"DOUBLE",decimal:"DECIMAL",numeric:"NUMERIC",tinytext:"TINYTEXT",mediumtext:"MEDIUMTEXT",longtext:"LONGTEXT",text:"TEXT",nvarchar:"VARCHAR",varchar:"VARCHAR","character varying":"VARCHAR","tinyint(1)":"TINYINT(1)",tinyint:"TINYINT",boolean:"TINYINT(1)",bit:"TINYINT(1)",int:"INT",datetime2:"TIMESTAMP",datetime:"DATETIME",date:"DATE",timestamptz:"TIMESTAMP","timestamp with time zone":"TIMESTAMP","timestamp without time zone":"DATETIME",timestamp:"TIMESTAMPTZ",json:"JSON",enum:"ENUM",set:"SET",char:"CHAR"},this.dbToPostgreSQL={bigint:"BIGINT",mediumint:"INTEGER",smallint:"INTEGER","tinyint(1)":"BOOLEAN",tinyint:"INTEGER",integer:"INTEGER",int:"INTEGER",real:"REAL",longtext:"TEXT",mediumtext:"TEXT",smalltext:"TEXT",tinytext:"TEXT",text:"TEXT","character varying":"CHARACTER VARYING",nvarchar:"CHARACTER VARYING",varchar:"CHARACTER VARYING",char:"CHARACTER",boolean:"BOOLEAN",bit:"BOOLEAN",datetime2:"TIMESTAMP WITH TIME ZONE",datetime:"TIMESTAMP WITHOUT TIME ZONE",date:"DATE",timestamptz:"TIMESTAMP WITH TIME ZONE",timestamp:"TIMESTAMP WITH TIME ZONE",time:"TIME",json:"JSONB"}}replaceAll(e,t,i){if(void 0===e)return null;let r=RegExp(t,"gi");return e.replace(r,i)}translate(e,t){let i=[],r=this.extractDropTableQueries(e,t);for(let s in r)i.push("-- DROP TABLE IF EXISTS "+r[s].table+";");e=this.replaceAll(e,"`",""),e=this.replaceAll(e," timestamp with time zone"," timestamptz"),e=this.replaceAll(e," timestamp without time zone"," timestamp"),e=this.replaceAll(e," character varying"," varchar"),e=this.replaceAll(e,' COLLATE pg_catalog."default"',""),e=this.replaceAll(e," TINYINT(1)"," boolean");let l=new TableParser;l.parseAll(e);let a=l.getResult(),n=[];for(let T in a){let o=this.convertQuery(a[T],t);n.push(o),n.push("")}return i.length>0&&i.push("\r\n\r\n"),i.join("\r\n")+n.join("\r\n")}convertQuery(e,t){return this.isSQLite(t)?this.toSqliteOut(e,t):this.isMySQL(t)?this.toMySQLOut(e,t):this.isPGSQL(t)?this.toPostgreSQLOut(e,t):void 0}toSqliteOut(e,t){let i={tableName:e.tableName,primaryKey:e.primaryKey,foreignKeys:e.foreignKeys,columns:e.columns.map(e=>{let t={...e};return t.Type=this.toSqliteType(t.Type,t.Length),t})};return this.toSqliteTable(i,t)}toMySQLOut(e,t){let i={tableName:e.tableName,primaryKey:e.primaryKey,foreignKeys:e.foreignKeys,columns:e.columns.map(e=>{let t={...e,Field:e.Field};return t.Type=this.toMySQLType(t.Type,t.Length,t.EnumValues),t})};return this.toMySQLTable(i,t)}toPostgreSQLOut(e,t){let i={tableName:e.tableName,primaryKey:e.primaryKey,foreignKeys:e.foreignKeys,columns:e.columns.map(e=>{let t={...e};return t.Type=this.toPostgreSQLType(t.Type,t.Length),t})};return this.toPostgreSQLTable(i,t)}toSqliteTable(e,t){return this.toTable(e,t)}toMySQLTable(e,t){return this.toTable(e,t)}toPostgreSQLTable(e,t){return this.toTable(e,t)}isMySQL(e){return"mysql"===e||"mariadb"===e}isPGSQL(e){return"pgsql"===e||"postgresql"===e}isSQLite(e){return"sqlite"===e}isReal(e){return -1!=e.toUpperCase().indexOf("FLOAT")||-1!=e.toUpperCase().indexOf("DOUBLE")||-1!=e.toUpperCase().indexOf("REAL")||-1!=e.toUpperCase().indexOf("DECIMAL")}isBoolean(e){return"BOOLEAN"==e.toUpperCase()||"BOOL"==e.toUpperCase()||"TINYINT(1)"==e.toUpperCase()}isTinyInt1(e,t){return"TINYINT"===e.toUpperCase()&&1==t||"BIT"===e.toUpperCase()||"BOOLEAN"===e.toUpperCase()}isInteger(e){return"TINYINT"===e.toUpperCase()||"SMALLINT"===e.toUpperCase()||"MEDIUMINT"===e.toUpperCase()||"BIGINT"===e.toUpperCase()||"INTEGER"===e.toUpperCase()||"INT"===e.toUpperCase()}isAutoIncrement(e,t){return this.isMySQL(t)&&e}isNotEmpty(e){return null!=e&&""!=e}hasDefaultValue(e,t){return!e&&null!==t&&""!==t}fixTableName(e,t){return -1!==e.indexOf(".")&&(e=e.split(".")[1]),this.isMySQL(t)?e="`"+e+"`":this.isPGSQL(t)&&(e='"'+e+'"'),e}fixColumnName(e,t){return this.isMySQL(t)&&(e="`"+e+"`"),e}getDefaultData(e,t){let i="";return"NULL"==e.toUpperCase()?i+=" DEFAULT NULL":this.isBoolean(t)?i+=" DEFAULT "+this.convertToBolean(e):-1!=t.toUpperCase().indexOf("INT")?i+=" DEFAULT "+this.convertToInteger(e):this.isReal(t)?i+=" DEFAULT "+this.convertToReal(e):i+=" DEFAULT "+e,i}toTable(e,t){let i=e.tableName,r=[];r.push(`CREATE TABLE IF NOT EXISTS ${i=this.fixTableName(i,t)} (`);let s=[];for(let l in e.columns){let a=this.fixColumnName(e.columns[l].Field,t),n=e.columns[l].Type,T=e.columns[l].Key||e.columns[l].Field===e.primaryKey,o="	"+a+" "+n;T?(o+=" PRIMARY KEY",this.isAutoIncrement(e.columns[l].AutoIncrement,t)&&(o+=" AUTO_INCREMENT"),e.columns[l].Nullable=!1):e.columns[l].Nullable?o+=" NULL":o+=" NOT NULL";let E=e.columns[l].Default;this.hasDefaultValue(T,E)&&(E=this.replaceAll(E,"::character varying",""),E=this.fixDefaultValue(E,t),this.isNotEmpty(E)&&(o+=this.getDefaultData(E,n))),null!=e.columns[l].Comment&&(o+=` COMMENT '${this.addslashes(e.columns[l].Comment)}'`),s.push(o)}let u=[];if(e.foreignKeys){let p=Array.isArray(e.foreignKeys)?e.foreignKeys:Object.values(e.foreignKeys);for(let N of p){let A=this.fixColumnName(N.columnName,t),m,I=`	FOREIGN KEY (${A}) REFERENCES ${this.fixTableName(N.referencedTable,t)} (${this.fixColumnName(N.referencedColumn,t)})`;N.onUpdate&&"NO ACTION"!==N.onUpdate&&(I+=` ON UPDATE ${N.onUpdate}`),N.onDelete&&"NO ACTION"!==N.onDelete&&(I+=` ON DELETE ${N.onDelete}`),u.push(I)}}r.push(s.concat(u).join(",\r\n")),r.push(");");let h=r.join("\r\n");return h.replace(/boolean\s+null\s+default\s+true/gi,"BOOLEAN NULL DEFAULT 1").replace(/boolean\s+null\s+default\s+false/gi,"BOOLEAN NULL DEFAULT 0").replace(/boolean\s+default\s+true/gi,"BOOLEAN NULL DEFAULT 1").replace(/boolean\s+default\s+false/gi,"BOOLEAN NULL DEFAULT 0")}addslashes(e){return e.replace(/'/g,"''")}convertToInteger(e){let t=e.replace(/^'|'$/g,"");return""===t?0:parseInt(t,10)}convertToReal(e){let t=e.replace(/^'|'$/g,"");if(""===t)return 0;let i=parseFloat(t);return isNaN(i)?0:i}convertToBolean(e){return -1!=e.indexOf("1")||-1!=e.toUpperCase().indexOf("TRUE")?"TRUE":"FALSE"}fixDefaultValue(e,t){return this.isSQLite(t)&&-1!==e.toLowerCase().indexOf("now(")&&(e=""),e}toSqliteType(e,t){if(this.isTinyInt1(e,t))return"BOOLEAN";let i="TEXT";for(let r in this.dbToSqlite)if(this.dbToSqlite.hasOwnProperty(r)){let s=r.toString();if(e.toLowerCase().startsWith(s.toLowerCase())){i=this.dbToSqlite[s];break}}if(-1!=e.toUpperCase().indexOf("ENUM")||-1!=e.toUpperCase().indexOf("SET")){let{resultArray:l,maxLength:a}=this.parseEnumValue(t);i="NVARCHAR("+(a+2)+")"}else("NVARCHAR"===i||"INT"===i)&&t>0&&(i=i+"("+t+")");return i}toMySQLType(e,t,i){let r="TEXT";if(this.isTinyInt1(e,t))return"TINYINT(1)";if(this.isInteger(e)&&t>0)return`${e}(${t})`;for(let s in this.dbToMySQL)if(this.dbToMySQL.hasOwnProperty(s)){let l=s.toString();if(e.toLowerCase().startsWith(l.toLowerCase())){r=this.dbToMySQL[l];break}}if(r=this.replaceAll(r,"TIMESTAMPTZ","TIMESTAMP"),-1!=e.toUpperCase().indexOf("ENUM"))r="ENUM('"+i.join("','")+"')";else if(-1!=e.toUpperCase().indexOf("SET"))r="SET('"+i.join("','")+"')";else if(-1!=e.toUpperCase().indexOf("DECIMAL")){let{resultArray:a,maxLength:n}=this.parseNumericType(t);r="DECIMAL("+a.join(",")+")"}else if(-1!=e.toUpperCase().indexOf("NUMERIC")){let{resultArray:T,maxLength:o}=this.parseNumericType(t);r="NUMERIC("+T.join(",")+")"}return("VARCHAR"===r||"CHAR"===r)&&t>0&&(r=r+"("+t+")"),r}toPostgreSQLType(e,t){let i="TEXT";for(let r in this.dbToPostgreSQL)if(this.dbToPostgreSQL.hasOwnProperty(r)){let s=r.toString();if(e.toLowerCase().startsWith(s.toLowerCase())){i=this.dbToPostgreSQL[s];break}}if(-1!=e.toUpperCase().indexOf("TINYINT")&&1==t)i="BOOLEAN";else if(-1!=e.toUpperCase().indexOf("ENUM")||-1!=e.toUpperCase().indexOf("SET")){let{resultArray:l,maxLength:a}=this.parseEnumValue(t);i="CHARACTER VARYING("+(a+2)+")"}else("CHARACTER VARYING"===i||"CHARACTER"===i||"CHAR"===i)&&t>0&&(i=i+"("+t+")");return i}parseEnumValue(e){let t=/'([^']+)'/g,i,r=[];for(;null!==(i=t.exec(e));)r.push(i[1]);let s=r.reduce((e,t)=>t.length>e?t.length:e,0);return{resultArray:r,maxLength:s}}parseNumericType(e){let t=/([A-Za-z0-9_]+)/g,i,r=[];for(;null!==(i=t.exec(e));)r.push(i[1]);let s=r.reduce((e,t)=>t.length>e?t.length:e,0);return{resultArray:r,maxLength:s}}extractDropTableQueries(e,t){let i=e.replace(/`/g,""),r=/DROP TABLE IF EXISTS ([^\s]+)/gi,s,l=[];for(;null!==(s=r.exec(i));){let a=this.extractTableName(s[1]);this.isPGSQL(t)?a='"'+a+'"':this.isMySQL(t)&&(a="`"+a+"`"),l.push({table:a})}return l}extractTableName(e){return e.includes(".")&&(e=e.split(".")[1]),e.replace(/[^a-zA-Z0-9_]/g,"")}}