class SQLConverter{constructor(){this.dbToSqlite={int:"INTEGER","tinyint(1)":"BOOLEAN",tinyint:"INTEGER",smallint:"INTEGER",mediumint:"INTEGER",bigint:"INTEGER",real:"REAL",float:"REAL",double:"REAL",decimal:"REAL",nvarchar:"NVARCHAR",varchar:"NVARCHAR","character varying":"NVARCHAR",char:"TEXT",tinytext:"TEXT",mediumtext:"TEXT",longtext:"TEXT",text:"TEXT",datetime:"DATETIME",timestamp:"TIMESTAMP",date:"DATE",time:"TIME",year:"INTEGER",boolean:"INTEGER",json:"TEXT",jsonb:"TEXT",integer:"INTEGER",serial:"INTEGER",bigserial:"INTEGER","double precision":"REAL",timestamptz:"TEXT"},this.dbToMySQL={integer:"INT",int:"INT",real:"FLOAT",tinytext:"TINYTEXT",mediumtext:"MEDIUMTEXT",longtext:"LONGTEXT",text:"TEXT",nvarchar:"VARCHAR",varchar:"VARCHAR","character varying":"VARCHAR","tinyint(1)":"TINYINT(1)",boolean:"TINYINT(1)",datetime:"DATETIME",date:"DATE",timestamptz:"TIMESTAMP","timestamp with time zone":"TIMESTAMP","timestamp without time zone":"DATETIME",timestamp:"TIMESTAMPTZ",json:"JSON"},this.dbToPostgreSQL={integer:"INTEGER",real:"REAL",text:"TEXT","tinyint(1)":"BOOLEAN",nvarchar:"CHARACTER VARYING",varchar:"CHARACTER VARYING",boolean:"BOOLEAN",datetime:"TIMESTAMP",date:"DATE",timestamptz:"TIMESTAMP WITH TIME ZONE",timestamp:"TIMESTAMP WITH TIME ZONE",datetime:"TIMESTAMP WITHOUT TIME ZONE",json:"JSONB"}}replaceAll(e,t,r){let l=RegExp(t,"gi");return e.replace(l,r)}translate(e,t){let r=[],l=this.extractDropTableQueries(e,t);for(let a in l)r.push("-- DROP TABLE IF EXISTS "+l[a].table+";");e=this.replaceAll(e,"`",""),e=this.replaceAll(e," timestamp with time zone"," timestamptz"),e=this.replaceAll(e," timestamp without time zone"," timestamp"),e=this.replaceAll(e," character varying"," varchar"),e=this.replaceAll(e,' COLLATE pg_catalog."default"',""),e=this.replaceAll(e," TINYINT(1)"," boolean");let i=new TableParser;i.parseAll(e);let s=i.getResult(),T=[];for(let o in s){let n=this.convertQuery(s[o],t);T.push(n),T.push("")}return r.length>0&&r.push("\r\n\r\n"),r.join("\r\n")+T.join("\r\n")}convertQuery(e,t){return"sqlite"===t?this.toSqliteOut(e,t):"mysql"===t||"mariadb"===t?this.toMySQLOut(e,t):"pgsql"===t||"postgresql"===t?this.toPostgreSQLOut(e,t):void 0}toSqliteOut(e,t){let r={};for(let l in r.tableName=e.tableName,r.primaryKey=e.primaryKey,r.columns=[],e.columns){let a=Object.assign({},e.columns[l]);a.Type=this.toSqliteType(a.Type,a.Length),r.columns.push(a)}return this.toSqliteTable(r,t)}toMySQLOut(e,t){let r={};for(let l in r.tableName=e.tableName,r.primaryKey=e.primaryKey,r.columns=[],e.columns){let a=Object.assign({},e.columns[l]);a.Field=a.Field,a.Type=this.toMySQLType(a.Type,a.Length),r.columns.push(a)}return this.toMySQLTable(r,t)}toPostgreSQLOut(e,t){let r={};for(let l in r.tableName=e.tableName,r.primaryKey=e.primaryKey,r.columns=[],e.columns){let a=Object.assign({},e.columns[l]);a.Type=this.toPostgreSQLType(a.Type,a.Length),r.columns.push(a)}return this.toPostgreSQLTable(r,t)}toSqliteTable(e,t){return this.toTable(e,t)}toMySQLTable(e,t){return this.toTable(e,t)}toPostgreSQLTable(e,t){return this.toTable(e,t)}toTable(e,t){let r=e.tableName;-1!==r.indexOf(".")&&(r=r.split(".")[1]);let l=[];"mysql"===t||"mariadb"===t?r="`"+r+"`":("pgsql"===t||"postgresql"===t)&&(r='"'+r+'"'),l.push("CREATE TABLE IF NOT EXISTS "+r),l.push("(");let a=[];for(let i in e.columns){let s=e.columns[i].Field;("mysql"===t||"mariadb"===t)&&(s="`"+s+"`");let T=e.columns[i].Type,o=e.columns[i].Field===e.primaryKey,n="	"+s+" "+T;o?(n+=" PRIMARY KEY",n+=" NOT NULL",e.columns[i].Nullable=!1):e.columns[i].Nullable?n+=" NULL":n+=" NOT NULL";let p=e.columns[i].Default;o||""===p||null===p||(p=this.replaceAll(p,"::character varying",""),""!=(p=this.fixDefaultValue(p,t))&&null!=p&&("NULL"==p.toUpperCase()?n+=" DEFAULT NULL":"BOOLEAN"==T.toUpperCase()||"TINYINT(1)"==T.toUpperCase()?n+=" DEFAULT "+(-1!=p.indexOf("1")?"TRUE":"FALSE"):-1!=T.toUpperCase().indexOf("INT")?n+=" DEFAULT "+this.convertToInteger(p):-1!=T.toUpperCase().indexOf("FLOAT")||-1!=T.toUpperCase().indexOf("DOUBLE")||-1!=T.toUpperCase().indexOf("REAL")|-1!=T.toUpperCase().indexOf("DECIMAL")?n+=" DEFAULT "+this.convertToReal(p):n+=" DEFAULT "+p)),a.push(n)}return l.push(a.join(",\r\n")),l.push(");"),l.join("\r\n")}convertToInteger(e){let t=e.replace(/^'|'$/g,"");return""===t?0:parseInt(t,10)}convertToReal(e){let t=e.replace(/^'|'$/g,"");if(""===t)return 0;let r=parseFloat(t);return isNaN(r)?0:r}fixDefaultValue(e,t){return"sqlite"===t&&-1!==e.toLowerCase().indexOf("now(")&&(e=""),e}toSqliteType(e,t){if("tinyint"==e.toLowerCase()&&1==t)return"BOOLEAN";let r="TEXT";for(let l in this.dbToSqlite)if(this.dbToSqlite.hasOwnProperty(l)){let a=l.toString();if(e.toLowerCase().startsWith(a.toLowerCase())){r=this.dbToSqlite[a];break}}if(-1!=e.toUpperCase().indexOf("ENUM")){let{resultArray:i,maxLength:s}=this.parseEnumValue(t);r="NVARCHAR("+(s+2)+")"}else("NVARCHAR"===r||"INT"===r)&&t>0&&(r=r+"("+t+")");return r}toMySQLType(e,t){let r="TEXT";if("TINYINT"===e.toUpperCase()&&1==t)return"TINYINT(1)";if(("TINYINT"===e.toUpperCase()||"SMALLINT"===e.toUpperCase()||"MEDIUMINT"===e.toUpperCase()||"BIGINT"===e.toUpperCase()||"INTEGER"===e.toUpperCase()||"INT"===e.toUpperCase())&&t>0)return`${e}(${t})`;for(let l in this.dbToMySQL)if(this.dbToMySQL.hasOwnProperty(l)){let a=l.toString();if(e.toLowerCase().startsWith(a.toLowerCase())){r=this.dbToMySQL[a];break}}if(r=this.replaceAll(r,"TIMESTAMPTZ","TIMESTAMP"),-1!=e.toUpperCase().indexOf("ENUM")){let{resultArray:i,maxLength:s}=this.parseEnumValue(t);r="enum('"+i.join("','")+"')"}return"VARCHAR"===r&&t>0&&(r=r+"("+t+")"),r}toPostgreSQLType(e,t){let r="TEXT";for(let l in this.dbToPostgreSQL)if(this.dbToPostgreSQL.hasOwnProperty(l)){let a=l.toString();if(e.toLowerCase().startsWith(a.toLowerCase())){r=this.dbToPostgreSQL[a];break}}if(-1!=e.toUpperCase().indexOf("TINYINT")&&1==t)r="BOOLEAN";else if(-1!=e.toUpperCase().indexOf("ENUM")){let{resultArray:i,maxLength:s}=this.parseEnumValue(t);r="CHARACTER VARYING("+(s+2)+")"}else"CHARACTER VARYING"===r&&t>0&&(r=r+"("+t+")");return r}parseEnumValue(e){let t=/'([^']+)'/g,r,l=[];for(;null!==(r=t.exec(e));)l.push(r[1]);let a=l.reduce((e,t)=>t.length>e?t.length:e,0);return{resultArray:l,maxLength:a}}extractDropTableQueries(e,t){let r=e.replace(/`/g,""),l=/DROP TABLE IF EXISTS ([^\s]+)/gi,a,i=[];for(;null!==(a=l.exec(r));){let s=this.extractTableName(a[1]);"pgsql"===t?s='"'+s+'"':("mysql"===t||"mariadb"===t)&&(s="`"+s+"`"),i.push({table:s})}return i}extractTableName(e){return e.includes(".")?e.split(".")[1]:e}}