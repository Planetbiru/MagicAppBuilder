let lastActiveTime=Date.now(),showLoginAlert=!1;document.addEventListener("DOMContentLoaded",function(){startSessionRefreshLoop(),document.addEventListener("visibilitychange",()=>{if("visible"===document.visibilityState){let e=Date.now(),t=e-lastActiveTime;t>getIddleDuration()?checkSessionStatus():lastActiveTime=e}}),window.addEventListener("storage",function(e){"MagicAppBuilder.lougout"===e.key&&"true"===e.newValue&&showSessionExpiredNotice(),"MagicAppBuilder.login"===e.key&&"true"===e.newValue&&hideSessionExpiredNotice(),e.key===getLocalStorageKey("workspace-id")&&null!==e.newValue&&loadAllResource(),e.key===getLocalStorageKey("application-id")&&null!==e.newValue&&onSetDefaultApplication()}),window.localStorage.setItem("MagicAppBuilder.login","true"),setTimeout(function(){window.localStorage.setItem("MagicAppBuilder.login","false")},400)});const userEvents=["click","mousemove","keydown","wheel","touchstart"];for(const evtName of userEvents)document.addEventListener(evtName,()=>{let e=Date.now(),t=e-lastActiveTime;t>getIddleDuration()&&checkSessionStatus(),lastActiveTime=e});function getIddleDuration(){let e=document.querySelector('meta[name="iddle-duration"]'),t=e?.getAttribute("content"),i=1e3*parseInt(t,10);return isNaN(i)?3e5:i}function checkSessionStatus(){fetch("lib.ajax/session-check.php",{method:"POST",credentials:"include"}).then(e=>e.json()).then(e=>{if(e.loggedIn){let t=document.getElementById("session-expired-alert");t&&(t.parentNode.removeChild(t),showLoginAlert=!1),$("#loginModal").modal("hide"),window.localStorage.setItem("MagicAppBuilder.login","true"),setTimeout(function(){window.localStorage.setItem("MagicAppBuilder.login","false")},400)}else showSessionExpiredNotice(),window.localStorage.setItem("MagicAppBuilder.logout","true"),setTimeout(function(){window.localStorage.setItem("MagicAppBuilder.logout","false")},400)}).catch(e=>{console.error("Failed to check session:",e)})}function showSessionExpiredNotice(){if(document.getElementById("session-expired-alert"))return;let e=document.createElement("div");e.id="session-expired-alert",e.className="alert alert-warning alert-dismissible fade show session-expired-alert",e.setAttribute("role","alert"),e.innerHTML=`
    <strong>Session expired!</strong> Please log in to continue.
    <button type="button" class="btn btn-sm btn-outline-dark ml-3" onclick="$('#loginModal').modal('show')">
        Log In
    </button>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
`,document.body.appendChild(e),showLoginAlert=!0}function hideSessionExpiredNotice(){$("#loginModal").modal("hide");let e=document.querySelector("#session-expired-alert");e.parentNode.removeChild(e)}function refreshSession(){fetch("lib.ajax/session-refresh.php",{method:"GET",credentials:"include"}).then(e=>{if(!e.ok)throw Error("Session refresh failed")}).catch(e=>{console.error("Failed to update session:",e)})}function startSessionRefreshLoop(){let e=getSessionRefreshInterval();setInterval(()=>{"visible"!==document.visibilityState||showLoginAlert||refreshSession()},e)}function getSessionRefreshInterval(){let e=document.querySelector('meta[name="session-refresh-interval"]'),t=e?.getAttribute("content"),i=1e3*parseInt(t,10);return isNaN(i)?3e5:i}