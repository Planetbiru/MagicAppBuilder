class TableParser{constructor(e){this.tableInfo=[],this.data={},this.init(),null!=e&&this.parseAll(e)}init(){this.typeList="TIMESTAMPTZ,TIMESTAMP,SERIAL4,BIGSERIAL,INT2,INT4,INT8,TINYINT,BIGINT,LONGTEXT,MEDIUMTEXT,TEXT,NVARCHAR,VARCHAR,ENUM,SET,NUMERIC,DECIMAL,CHAR,REAL,FLOAT,INTEGER,INT,DATETIME2,DATETIME,DATE,DOUBLE,BOOLEAN,BOOL,TIME,UUID,MONEY,BLOB,BIT,JSON,JSONB".split(",")}parseInsertQuery(e){let t=e.trim(),s=t.match(/INSERT INTO\s+(`[^`]+`|\[[^\]]+\]|"[^"]+"|[\w.]+)\s*(?:\(([^)]*?)\))?\s*VALUES\s*(.*)/is);if(!s)return null;let r=s[1].replace(/^[`\["]|[`\]"]$/g,""),i=s[2]?s[2].match(/(`[^`]+`|\[[^\]]+\]|"[^"]+"|[^,]+)/g).map(e=>e.trim().replace(/^[`\["]|[`\]"]$/g,"")):[],l=s[3],a=this.extractRowStrings(l),n=a.map(e=>this.parseRow(e)),u=n.map(e=>{let t={};for(let s=0;s<i.length;s++)t[i[s]]=e[s];return t});return{tableName:r,columns:i,rows:u}}extractRowStrings(e){let t=[],s="",r=!1,i=!1,l=!1,a=0;for(let n=0;n<e.length;n++){let u=e[n],p=e[n+1];l?(s+=u,l=!1):"\\"===u?(s+=u,l=!0):"'"!==u||i?'"'!==u||r?"("!==u||r||i?")"!==u||r||i?s+=u:(s+=u,0==--a&&(s.startsWith("(")&&s.endsWith(")")?t.push(s.substring(1,s.length-1)):t.push(s),s="")):(0===a&&(s=""),s+=u,a++):(s+=u,i&&'"'===p?(s+=p,n++):i=!i):(s+=u,r&&"'"===p?(s+=p,n++):r=!r)}return t}customTrim(e){return e.trim()}parseRow(e){let t=[],s="",r=!1,i=!1,l=!1,a=()=>{let e=s,r=this.customTrim(e),i;i=r?/^null$/i.test(r)?null:!!/^true$/i.test(r)||!/^false$/i.test(r)&&((r.startsWith("E'")||r.startsWith("e'"))&&r.endsWith("'")?r.slice(2,-1).replace(/\\(.)/g,(e,t)=>{switch(t){case"b":return"\b";case"f":return"\f";case"n":return"\n";case"r":return"\r";case"t":return"	";default:return t}}).replace(/''/g,"'"):r.startsWith("'")&&r.endsWith("'")?r.slice(1,-1).replace(/''/g,"'").replace(/\\(["'\\])/g,"$1"):r.startsWith('"')&&r.endsWith('"')?r.slice(1,-1).replace(/''/g,"'").replace(/\\\\/g,"\\").replace(/\\"/g,'"'):isNaN(r)||""===r?r:Number(r)):"",t.push(i),s=""};for(let n=0;n<e.length;n++){let u=e[n],p=e[n+1];l?(s+=u,l=!1):"\\"===u?(s+=u,l=!0):"'"!==u||i?'"'!==u||r?","!==u||r||i?s+=u:a():(s+=u,i&&'"'===p?(s+=p,n++):i=!i):(s+=u,r&&"'"===p?(s+=p,n++):r=!r)}return a(),t}inArray(e,t){return e.includes(t)}isPrimaryKey(e){let t=e.toUpperCase().replace(/\s+/g," ").trim();return t.includes("PRIMARY KEY")}isAutoIncrement(e){let t=e.toUpperCase().replace(/\s+/g," ").trim(),s=!1;return(s=t.includes("AUTO_INCREMENT")||t.includes("AUTOINCREMENT"))||(s=t.includes("SERIAL")||t.includes("BIGSERIAL")||t.includes("NEXTVAL")),s}parseTable(e){e=(e=e.replace(/(\bnvarchar\s*)\(\s*max\s*\)/gi,"TEXT")).replace(/(\bvarchar\s*)\(\s*max\s*\)/gi,"TEXT");let t=/(constraint\s+.*|primary\s+key\s*\([^)]+\)|\w+\s+key.*|\w+\s+bigserial.*|\w+\s+serial4.*|\w+\s+serial8.*|\w+\s+tinyint.*|\w+\s+bigint.*|\w+\s+longtext.*|\w+\s+mediumtext.*|\w+\s+text.*|\w+\s+nvarchar.*|\w+\s+varchar.*|\w+\s+char.*|\w+\s+real.*|\w+\s+float.*|\w+\s+integer.*|\w+\s+int.*|\w+\s+datetime2.*|\w+\s+datetime.*|\w+\s+date.*|\w+\s+double.*|\w+\s+timestamp.*|\w+\s+timestamptz.*|\w+\s+boolean.*|\w+\s+bool.*|\w+\s+enum\s*\(([^)]+)\)|\w+\s+set\s*\(([^)]+)\)|\w+\s+numeric\s*\(([^)]+)\)|\w+\s+decimal\s*\(([^)]+)\)|\w+\s+float\s*\(([^)]+)\)|\w+\s+int2.*|\w+\s+int4.*|\w+\s+int8.*|\w+\s+time.*|\w+\s+uuid.*|\w+\s+money.*|\w+\s+blob.*|\w+\s+bit.*|\w+\s+json.*)/gim,s=/(?<fname>\w+)\s+(?<ftype>\w+)(?<fattr>.*)/gi,r=/enum\s*\(([^)]+)\)/i,i=/set\s*\(([^)]+)\)/i,l=/numeric\s*\(([^)]+)\)/i,a=/decimal\s*\(([^)]+)\)/i,n=/not\s+null/i,u=/primary\s+key/i,p=/default\s+([^'"]+|'[^']*'|\"[^\"]*\")\s*(comment\s+'[^']*')?/i,c=/COMMENT\s*'([^']*)'/i,m=/(PRIMARY|UNIQUE) KEY[a-zA-Z_0-9\s]+\(([a-zA-Z_0-9,\s]+)\)/gi,o=/primary\s+key\s*\(([^)]+)\)/i,T=/(?:CONSTRAINT\s+(?<fkname>["`][^"`]+["`]|\w+)\s+)?FOREIGN\s+KEY\s*\((?<col>[^)]+)\)\s+REFERENCES\s+(?<refTable>["`][^"`]+["`]|[\w\.]+)\s*\((?<refCol>[^)]+)\)(?:\s+ON\s+UPDATE\s+(?<onUpdate>NO\s+ACTION|RESTRICT|CASCADE|SET\s+NULL|SET\s+DEFAULT))?(?:\s+ON\s+DELETE\s+(?<onDelete>NO\s+ACTION|RESTRICT|CASCADE|SET\s+NULL|SET\s+DEFAULT))?/gi,E=/(?<!PRIMARY\s|FOREIGN\s)(?:(UNIQUE)\s+)?(?:INDEX|KEY)\s*(?:`([^`]+)`|(\w+))?\s*\(([^)]+)\)/gi,h=/(create\s+table\s+if\s+not\s+exists|create\s+table)\s(?<tb>.*)\s\(/gim.exec(e),d=h.groups.tb,g=[],I=null,f=[],A=[],N=[],_=[];for(;null!=(h=t.exec(e));){let R=h[0],w=R;w=w.replace(/[\r\n]+/g," "),s.lastIndex=0;let y=s.exec(R),L=y[2],C=L,S=!1,U=null,b=null,$=y.groups.fname.trim();if(r.test(w)&&(b=(U=r.exec(w)[1]).split(",").map(e=>e.trim().replace(/['"]/g,""))),null==b&&i.test(w)&&(b=(U=i.exec(w)[1]).split(",").map(e=>e.trim().replace(/['"]/g,""))),null==b&&l.test(w)&&(b=(U=l.exec(w)[1]).split(",").map(e=>e.trim().replace(/['"]/g,""))),null==b&&a.test(w)&&(b=(U=a.exec(w)[1]).split(",").map(e=>e.trim().replace(/['"]/g,""))),this.isValidType(L.toString())||this.isValidType(C.toString())){let O=y.groups.fattr.replace(",","").trim(),x=!n.test(O),M=O.replace(n,"");S=u.test(M)||this.isPrimaryKey(w);let D=this.isAutoIncrement(w),B=p.exec(M),P=B&&B[1]?B[1].trim():null,W=this.getLength(O);""==W&&null!=b&&(W="'"+b.join("','")+"'"),P=this.fixDefaultValue(P,L,W);let F=c.exec(M),K=F&&F[1]?F[1].trim():null;if(L=L.trim(),S&&A.push($),!this.inArray(f,$)){S&&(x=!1);let Q={Field:$,Type:L,Length:W,Key:S,Nullable:x,Default:P,AutoIncrement:D,EnumValues:b,Comment:K};g.push(Q),f.push($)}}else if(this.isPrimaryKey(w)){let Y=h[1],V=/\((.*)\)/,X=Y.match(V);null==I&&(I=X?X[1]:null)}T.lastIndex=0;let k;for(;null!=(k=T.exec(R));){let v=k.groups.col.trim(),G=k.groups.fkname?k.groups.fkname.replace(/["`]/g,""):null,j=k.groups.refTable.trim().replace(/["`]/g,"");if(null===G){let q;G=`fk_${d.replace(/["`\[\]]/g,"").trim()}_${v.replace(/["`\[\]]/g,"").replace(/,\s*/g,"_").trim()}`}N.push({name:G,columnName:v,referencedTable:j,referencedColumn:k.groups.refCol.trim(),onUpdate:k.groups.onUpdate||null,onDelete:k.groups.onDelete||null})}if(null!=I)for(let z in I=I.split("(").join("").split(")").join(""),g)g[z].Field==I&&(g[z].Key=!0);if(m.test(R)&&u.test(R)){let H=R.replace(R.match(u)[0],""),Z=(H=H.replace("(","").replace(")","")).split(",").map(e=>e.trim());for(let J in g)this.inArray(Z,g[J].Field)&&(g[J].Key=!0)}if(o.test(w)){let ee=o.exec(w);if(ee&&ee[1]){let et=ee[1].split(",").map(e=>e.trim());for(let es in A.push(...et),g)this.inArray(et,g[es].Field)&&(g[es].Key=!0)}}}null==I&&A.length>0&&(I=A[0]),null!=I&&(g=this.updatePrimaryKey(g,I)),E.lastIndex=0;let er;for(;null!==(er=E.exec(e));){let ei=(er[2]||er[3]||"").trim(),el=er[4].split(",").map(e=>e.trim().replace(/[`"']/g,"")),ea=void 0!==er[1];"PRIMARY"!==ei.toUpperCase()&&_.push({name:ei,columns:el,unique:ea})}return{tableName:d,columns:g,primaryKey:I,foreignKeys:N,indexes:_}}updatePrimaryKey(e,t){return e.forEach(function(s,r){t.trim()==s.Field.trim()&&(e[r].Key=!0)}),e}fixDefaultValue(e,t,s){return e?this.isBoolean(t,s)?e=this.toBoolean(e):-1!=e.toUpperCase().indexOf("NULL")?e="NULL":this.isNumber(e)?e="'"+e.toString()+"'":/^(CURRENT_TIMESTAMP|NOW\(\))$/i.test(e)?e=e.toUpperCase():this.isDateTime(e)?e=this.createDate(e):/^TRUE/i.test(e)?e="TRUE":/^FALSE/i.test(e)?e="FALSE":/^CURRENT_TIMESTAMP\s+ON\s+UPDATE\s+CURRENT_TIMESTAMP$/i.test(e)?e=e.toUpperCase():/^CURRENT_TIMESTAMP\s+ON\s+INSERT\s+CURRENT_TIMESTAMP$/i.test(e)&&(e=e.toUpperCase()):e=null,e}toBoolean(e){return -1!=e.toUpperCase().indexOf("TRUE")||-1!=e.indexOf("1")?"TRUE":"FALSE"}createDate(e){return null==e?null:(e=e.trim(),this.isInQuotes(e)?e=e.slice(1,-1):e.startsWith("'")?e=e.substring(1):e.endsWith("'")&&(e=e.substring(0,e.length-3)),`'${e}'`)}isDateTime(e){return/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d{6}/.test(e)||/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(e)||/\d{4}-\d{2}-\d{2}/.test(e)||/\d{2}:\d{2}:\d{2}/.test(e)}isBoolean(e,t){return -1!=e.toUpperCase().indexOf("BOOL")||-1!=e.toUpperCase().indexOf("TINYINT")&&1==t}isInQuotes(e){return e.startsWith("'")&&e.endsWith("'")}isNumber(e){return!isNaN(e)&&""!==e}getLength(e){if(e.includes("(")&&e.includes(")")){let t=e.match(/\((\d+)\)/);return t?t[1]:""}return""}isValidType(e){return this.typeList.includes(e.toUpperCase())}parseAll(e){let t=[],s=this.parseSQL(e);for(let r in s){let i=this.formatSQL(s[r].query);try{let l=this.parseTable(i);t.push(l)}catch(a){}}this.tableInfo=t}parseData(e){this.data={};let t=this.parseSQL(e);for(let s in t){let r=this.parseInsertQuery(t[s].query);null!=r&&null!=r.tableName&&""!==r.tableName&&void 0!==r.rows&&Array.isArray(r.rows)&&r.rows.length>0&&(void 0===this.data[r.tableName]&&(this.data[r.tableName]=[]),this.data[r.tableName].push(...r.rows))}}formatSQL(e){return e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\s+/g," ")).replace(/\bCREATE\s+TABLE\s+/i,"CREATE TABLE ")).replace(/\bIF\s+NOT\s+EXISTS\s+/i,"IF NOT EXISTS ")).replace(/\s*\(/," (")).replace(/\s*\)\s*;/,"\r\n);")).replace(/\(\s*/,"(\n	",e)).replace(/,\s*/g,",\n	")).replace("CREATE TABLE","\nCREATE TABLE",e)}parseSQL(e){let t=(e=(e=e.replace(/\n/g,"\r\n")).replace(/\r\r\n/g,"\r\n")).split("\r\n"),s=[];t.forEach(e=>{(e=e.trim()).startsWith("-- ")||"--"===e||""===e||s.push(e)});let r=0,i=0,l=1,a=-1,n=";",u=[],p=[];(t=s).forEach(e=>{""===e&&1===r&&(u[a]+="\r\n"),0===r&&(e.trim().startsWith("--")?(i=1,a++,l=1,r=0):i=0),0===i&&(1===l&&(u[++a]="",p[a]=n,l=0),u[a]+=e+"\r\n",p[a]=n,l=(e=e.trim()).length-n.length-1,e.substring(l).includes(n)||e===n?(a++,l=1,r=0):(l=0,r=1),p[a]=n,e.toLowerCase().startsWith("delimiter "))&&(n=(e=e.trim().replace(/\s+/g," ")).split(" ")[1],p[++a]=n,l=1,r=0)});let c=[];return u.forEach((e,t)=>{let s=p[t];e.toLowerCase().startsWith("delimiter ")||(e=(e=e.trim()).substring(0,e.length-s.length),c.push({query:e,delimiter:s}))}),c}getResult(){return this.tableInfo}}