class TableParser{constructor(e){this.tableInfo=[],this.init(),null!=e&&this.parseAll(e)}init(){this.typeList="TIMESTAMPTZ,TIMESTAMP,SERIAL4,BIGSERIAL,INT2,INT4,INT8,TINYINT,BIGINT,LONGTEXT,MEDIUMTEXT,TEXT,NVARCHAR,VARCHAR,ENUM,SET,NUMERIC,DECIMAL,CHAR,REAL,FLOAT,INTEGER,INT,DATETIME2,DATETIME,DATE,DOUBLE,BOOLEAN,BOOL,TIME,UUID,MONEY,BLOB,BIT,JSON".split(",")}inArray(e,t){return e.includes(t)}isPrimaryKey(e){let t=e.toUpperCase().replace(/\s+/g," ").trim();return t.includes("PRIMARY KEY")}isAutoIncrement(e){let t=e.toUpperCase().replace(/\s+/g," ").trim(),s=!1;return(s=t.includes("AUTO_INCREMENT"))||(s=t.includes("SERIAL")||t.includes("BIGSERIAL")||t.includes("NEXTVAL")),s}parseTable(e){e=(e=e.replace(/(\bnvarchar\s*)\(\s*max\s*\)/gi,"TEXT")).replace(/(\bvarchar\s*)\(\s*max\s*\)/gi,"TEXT");let t=/(\w+\s+key.*|\w+\s+bigserial|\w+\s+serial4|\w+\s+serial8|\w+\s+tinyint.*|\w+\s+bigint.*|\w+\s+longtext.*|\w+\s+mediumtext.*|\w+\s+text.*|\w+\s+nvarchar.*|\w+\s+varchar.*|\w+\s+char.*|\w+\s+real.*|\w+\s+float.*|\w+\s+integer.*|\w+\s+int.*|\w+\s+datetime2.*|\w+\s+datetime.*|\w+\s+date.*|\w+\s+double.*|\w+\s+timestamp.*|\w+\s+timestamptz.*|\w+\s+boolean.*|\w+\s+bool.*|\w+\s+enum\s*\(([^)]+)\)|\w+\s+set\s*\(([^)]+)\)|\w+\s+numeric\s*\(([^)]+)\)|\w+\s+decimal\s*\(([^)]+)\)|\w+\s+float\s*\(([^)]+)\)|\w+\s+int2.*|\w+\s+int4.*|\w+\s+int8.*|\w+\s+time.*|\w+\s+uuid.*|\w+\s+money.*|\w+\s+blob.*|\w+\s+bit.*|\w+\s+json.*)/gim,s=/(?<fname>\w+)\s+(?<ftype>\w+)(?<fattr>.*)/gi,i=/enum\s*\(([^)]+)\)/i,r=/set\s*\(([^)]+)\)/i,l=/numeric\s*\(([^)]+)\)/i,a=/decimal\s*\(([^)]+)\)/i,n=/not\s+null/i,u=/primary\s+key/i,p=/default\s+([^'"]+|'[^']*'|\"[^\"]*\")\s*(comment\s+'[^']*')?/i,T=/COMMENT\s*'([^']*)'/i,m=/(PRIMARY|UNIQUE) KEY[a-zA-Z_0-9\s]+\(([a-zA-Z_0-9,\s]+)\)/gi,c=/(create\s+table\s+if\s+not\s+exists|create\s+table)\s(?<tb>.*)\s\(/gim.exec(e),E=c.groups.tb,o=[],h=null,d=[],I=[];for(;null!=(c=t.exec(e));){let A=c[0],g=A;g=g.replace(/[\r\n]+/g," "),s.lastIndex=0;let w=s.exec(A),f=w[2],N=f,R=!1,L=null,_=null,y=w.groups.fname.trim();if(i.test(g)&&(_=(L=i.exec(g)[1]).split(",").map(e=>e.trim().replace(/['"]/g,""))),null==_&&r.test(g)&&(_=(L=r.exec(g)[1]).split(",").map(e=>e.trim().replace(/['"]/g,""))),null==_&&l.test(g)&&(_=(L=l.exec(g)[1]).split(",").map(e=>e.trim().replace(/['"]/g,""))),null==_&&a.test(g)&&(_=(L=a.exec(g)[1]).split(",").map(e=>e.trim().replace(/['"]/g,""))),this.isValidType(f.toString())||this.isValidType(N.toString())){let U=w.groups.fattr.replace(",","").trim(),b=!n.test(U),C=U.replace(n,"");R=u.test(C)||this.isPrimaryKey(g);let M=this.isAutoIncrement(g),S=p.exec(C),O=S&&S[1]?S[1].trim():null,x=this.getLength(U);""==x&&null!=_&&(x="'"+_.join("','")+"'"),O=this.fixDefaultValue(O,f,x);let $=T.exec(C),B=$&&$[1]?$[1].trim():null;if(f=f.trim(),R&&I.push(y),!this.inArray(d,y)){R&&(b=!1);let P={Field:y,Type:f,Length:x,Key:R,Nullable:b,Default:O,AutoIncrement:M,EnumValues:_,Comment:B};o.push(P),d.push(y)}}else if(this.isPrimaryKey(g)){let D=c[1],K=/\((.*)\)/,F=D.match(K);null==h&&(h=F?F[1]:null)}if(null!=h)for(let V in h=h.split("(").join("").split(")").join(""),o)o[V].Field==h&&(o[V].Key=!0);if(m.test(A)&&u.test(A)){let W=A.replace(A.match(u)[0],""),X=(W=W.replace("(","").replace(")","")).split(",").map(e=>e.trim());for(let Q in o)this.inArray(X,o[Q].Field)&&(o[Q].Key=!0)}}return null==h&&I.length>0&&(h=I[0]),null!=h&&(o=this.updatePrimaryKey(o,h)),{tableName:E,columns:o,primaryKey:h}}updatePrimaryKey(e,t){return e.forEach(function(s,i){t.trim()==s.Field.trim()&&(e[i].Key=!0)}),e}fixDefaultValue(e,t,s){return e?this.isBoolean(t,s)?e=this.toBoolean(e):-1!=e.toUpperCase().indexOf("NULL")?e="NULL":this.isNumber(e)?e="'"+e.toString()+"'":/^(CURRENT_TIMESTAMP|NOW\(\))$/i.test(e)?e=e.toUpperCase():this.isDateTime(e)?e=this.createDate(e):/^TRUE/i.test(e)?e="TRUE":/^FALSE/i.test(e)?e="FALSE":/^CURRENT_TIMESTAMP\s+ON\s+UPDATE\s+CURRENT_TIMESTAMP$/i.test(e)?e=e.toUpperCase():/^CURRENT_TIMESTAMP\s+ON\s+INSERT\s+CURRENT_TIMESTAMP$/i.test(e)&&(e=e.toUpperCase()):e=null,e}toBoolean(e){return -1!=e.toUpperCase().indexOf("TRUE")||-1!=e.indexOf("1")?"TRUE":"FALSE"}createDate(e){return null==e?null:(e=e.trim(),this.isInQuotes(e)?e=e.slice(1,-1):e.startsWith("'")?e=e.substring(1):e.endsWith("'")&&(e=e.substring(0,e.length-3)),`'${e}'`)}isDateTime(e){return/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d{6}/.test(e)||/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(e)||/\d{4}-\d{2}-\d{2}/.test(e)||/\d{2}:\d{2}:\d{2}/.test(e)}isBoolean(e,t){return -1!=e.toUpperCase().indexOf("BOOL")||-1!=e.toUpperCase().indexOf("TINYINT")&&1==t}isInQuotes(e){return e.startsWith("'")&&e.endsWith("'")}isNumber(e){return!isNaN(e)&&""!==e}getLength(e){if(e.includes("(")&&e.includes(")")){let t=e.match(/\((\d+)\)/);return t?t[1]:""}return""}isValidType(e){return this.typeList.includes(e.toUpperCase())}parseAll(e){let t=[],s=this.parseSQL(e);for(let i in s){let r=this.formatSQL(s[i].query);try{let l=this.parseTable(r);t.push(l)}catch(a){console.log(a.message)}}this.tableInfo=t}formatSQL(e){return e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\s+/g," ")).replace(/\bCREATE\s+TABLE\s+/i,"CREATE TABLE ")).replace(/\bIF\s+NOT\s+EXISTS\s+/i,"IF NOT EXISTS ")).replace(/\s*\(/," (")).replace(/\s*\)\s*;/,"\r\n);")).replace(/\(\s*/,"(\n	",e)).replace(/,\s*/g,",\n	")).replace("CREATE TABLE","\nCREATE TABLE",e)}parseSQL(e){let t=(e=(e=e.replace(/\n/g,"\r\n")).replace(/\r\r\n/g,"\r\n")).split("\r\n"),s=[];t.forEach(e=>{(e=e.trim()).startsWith("-- ")||"--"===e||""===e||s.push(e)});let i=0,r=0,l=1,a=-1,n=";",u=[],p=[];(t=s).forEach(e=>{""===e&&1===i&&(u[a]+="\r\n"),0===i&&(e.trim().startsWith("--")?(r=1,a++,l=1,i=0):r=0),0===r&&(1===l&&(u[++a]="",p[a]=n,l=0),u[a]+=e+"\r\n",p[a]=n,l=(e=e.trim()).length-n.length-1,e.substring(l).includes(n)||e===n?(a++,l=1,i=0):(l=0,i=1),p[a]=n,e.toLowerCase().startsWith("delimiter "))&&(n=(e=e.trim().replace(/\s+/g," ")).split(" ")[1],p[++a]=n,l=1,i=0)});let T=[];return u.forEach((e,t)=>{let s=p[t];e.toLowerCase().startsWith("delimiter ")||(e=(e=e.trim()).substring(0,e.length-s.length),T.push({query:e,delimiter:s}))}),T}getResult(){return this.tableInfo}}