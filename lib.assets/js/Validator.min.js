class ValidationBuilder{constructor(e,t,i,a){this.baseSelector=e,this.modalSelector=t,this.jsonOutputSelector=i,this.rowSelector=a,this.baseElement=document.querySelector(e),this.modalElement=document.querySelector(t),this.currentField=null,this.currentIndex=null,this.currentMaximumLength=null,this.validationsPerField={},this.propsContainer=this.modalElement.querySelector(".validation-props"),this.applyInsertCheckbox=this.modalElement.querySelector(".apply-insert"),this.applyUpdateCheckbox=this.modalElement.querySelector(".apply-update"),this.schema=this.initSchema(),this.bindFieldButtons(),this.initValidationSelector()}closeValidationModal(){return $(this.baseSelector).modal("hide"),this}closeAddValidationModal(){return new bootstrap.Modal(this.modalElement).hide(),$(this.modalSelector).modal("hide"),this}initSchema(){return{Required:["message"],NotEmpty:["message"],NotBlank:["message"],Min:["value","message"],Max:["value","message"],DecimalMin:["value","message"],DecimalMax:["value","message"],Range:["min","max","message"],Size:["min","max","message"],Length:["min","max","message"],Digits:["integer","fraction","message"],Positive:["message"],PositiveOrZero:["message"],Negative:["message"],NegativeOrZero:["message"],Pattern:["regexp","message"],Email:["message"],Url:["message"],Ip:["message"],DateFormat:["format","message"],Phone:["message"],NoHtml:["message"],Past:["message"],Future:["message"],PastOrPresent:["message"],FutureOrPresent:["message"],AssertTrue:["message"],Alpha:["message"],AlphaNumeric:["message"],StartsWith:["prefix","caseSensitive","message"],EndsWith:["suffix","caseSensitive","message"],Contains:["substring","caseSensitive","message"],BeforeDate:["date","message"],AfterDate:["date","message"],Enum:["allowedValues","caseSensitive","message"]}}bindFieldButtons(){let e=this;return $(document).on("click",e.rowSelector+" .validation-button",function(t){let i=$(this).closest(".validation-item")[0];e.currentField=i.dataset.fieldName,e.currentMaximumLength=i.dataset.maximumLength,$(".field-to-validate").text(i.dataset.fieldName),e.applyInsertCheckbox&&(e.applyInsertCheckbox.disabled=!0),e.applyUpdateCheckbox&&(e.applyUpdateCheckbox.disabled=!0),e.renderValidations(),$(e.baseSelector).modal("show")}),$(document).on("click",this.baseSelector+" .add-validation",function(t){e.currentIndex=null,e.modalElement.querySelector(".validation-type").value="",e.propsContainer.innerHTML="",e.applyInsertCheckbox&&(e.applyInsertCheckbox.disabled=!0,e.applyInsertCheckbox.checked=!1),e.applyUpdateCheckbox&&(e.applyUpdateCheckbox.disabled=!0,e.applyUpdateCheckbox.checked=!1),e.updateDropDown(),$(e.modalSelector).modal("show")}),$(document).on("click",this.baseSelector+" .add-validation-merged",function(t){e.currentField=$(this)[0].closest(".validation-item").dataset.fieldName,e.currentIndex=null,e.modalElement.querySelector(".validation-type").value="",e.propsContainer.innerHTML="",e.updateDropDown(),$(e.modalSelector).modal("show")}),this}updateDropDown(e){let t=this.validationsPerField[this.currentField],i=[];"undefined"!==t&&t&&t.forEach(e=>{i.push(e.type)});let a=this.modalElement.querySelector(".validation-type");return a.querySelectorAll("option").forEach(t=>{let a=t.getAttribute("value"),l=a!=e&&i.includes(a);t.disabled=l}),this}initValidationSelector(){let e=this.modalElement.querySelector(".validation-type");for(let t in this.schema){let i=document.createElement("option");i.value=t,i.textContent=t,e.appendChild(i)}return e.addEventListener("change",()=>this.renderPropsInputs()),this}renderPropsInputs(e={}){let t=this.modalElement.querySelector(".validation-type").value;return this.propsContainer.innerHTML="",(this.schema[t]||[]).forEach(t=>{let i=document.createElement("div");i.className="mb-2",i.innerHTML=`<label class="form-label">${t}</label><input type="text" class="form-control" data-prop="${t}" placeholder="${t}" value="${e[t]||""}">`,this.propsContainer.appendChild(i)}),this.applyInsertCheckbox&&(this.applyInsertCheckbox.disabled=!1,this.applyInsertCheckbox.checked=!0===e.applyInsert),this.applyUpdateCheckbox&&(this.applyUpdateCheckbox.disabled=!1,this.applyUpdateCheckbox.checked=!0===e.applyUpdate),this.autopopulateMinMax(t),this}autopopulateMinMax(e){("Size"==e||"Length"==e)&&this.currentMaximumLength&&(this.propsContainer.querySelector('input[data-prop="min"').value=0,this.propsContainer.querySelector('input[data-prop="max"').value=this.currentMaximumLength)}saveValidation(){let e=this.modalElement.querySelector(".validation-type").value;if(!e||!this.currentField)return;let t={};this.propsContainer.querySelectorAll("input").forEach(e=>{t[e.dataset.prop]=e.value});let i={type:e,...t,applyInsert:this.applyInsertCheckbox.checked,applyUpdate:this.applyUpdateCheckbox.checked};this.validationsPerField[this.currentField]||(this.validationsPerField[this.currentField]=[]),null!==this.currentIndex?this.validationsPerField[this.currentField][this.currentIndex]=i:this.validationsPerField[this.currentField].push(i);let a=this.baseElement.querySelector(".field-validations-list"),l=this.validationsPerField[this.currentField]||[];return this.renderFieldValidations(a,this.currentField,l),$(this.modalSelector).modal("hide"),this}saveValidationToSelectedField(){let e=this.modalElement.querySelector(".validation-type").value;if(!e||!this.currentField)return;let t={};this.propsContainer.querySelectorAll("input").forEach(e=>{t[e.dataset.prop]=e.value});let i={type:e,...t};return this.validationsPerField[this.currentField]||(this.validationsPerField[this.currentField]=[]),null!==this.currentIndex?this.validationsPerField[this.currentField][this.currentIndex]=i:this.validationsPerField[this.currentField].push(i),this.baseElement.querySelector(".field-validations-list"),this.validationsPerField[this.currentField],this.renderValidationsMerged(),$(this.modalSelector).modal("hide"),this}renderValidationsMerged(){let e=this,t=this.baseElement.querySelectorAll(".validation-item");t.forEach(t=>{let i=t.dataset.fieldName,a=this.validationsPerField[i]||[];e.renderFieldValidationsMerged(t.querySelector(".field-validations-list"),i,a)})}saveAllValidation(e){return validation=this.getValidation(e),this.markValidation()}markValidation(){let e=Object.keys(this.validationsPerField),t=document.querySelectorAll(this.rowSelector);return t.forEach(t=>{let i=t.dataset.fieldName;t.dataset.hasValidation=e.includes(i)?"true":"false"}),this}renderValidations(){let e=this.currentField,t=this.baseElement.querySelector(".field-validations-list"),i=this.validationsPerField[e]||[];return this.renderFieldValidations(t,e,i)}renderFieldValidations(e,t,i){return e.innerHTML="",(i||[]).forEach((i,a)=>{let l=Object.entries(i).filter(([e])=>"type"!==e&&"applyInsert"!==e&&"applyUpdate"!==e).map(([e,t])=>`${e}="${t}"`).join(", "),s="";s+='<div class="validation-targets">',s+='<div class="form-check form-check-inline">',s+=`<input class="form-check-input " type="checkbox" disabled ${i.applyInsert?"checked":""}>`,s+='<label class="form-check-label">Insert</label>',s+="</div>",s+='<div class="form-check form-check-inline">',s+=`<input class="form-check-input" type="checkbox" disabled ${i.applyUpdate?"checked":""}>`,s+='<label class="form-check-label">Update</label>',s+="</div>",s+="</div>";let n=document.createElement("div");n.className="field-validations d-flex justify-content-between align-items-center mb-2",n.innerHTML=`
            <div>
              <span>@${i.type}(${l})</span>
              ${s}
            </div>
            <div>
              <button type="button" class="btn btn-sm btn-primary me-1" onclick="validatorBuilder.editValidation('${t}', ${a})"><i class="fa-solid fa-pencil"></i></button>
              <button type="button" class="btn btn-sm btn-danger" onclick="validatorBuilder.deleteValidation('${t}', ${a})"><i class="fa-solid fa-trash-can"></i></button>
            </div>`,e.appendChild(n)}),document.querySelector(this.jsonOutputSelector).textContent=JSON.stringify(this.validationsPerField,null,2),this}renderFieldValidationsMerged(e,t,i){return e.innerHTML="",(i||[]).forEach((i,a)=>{let l=Object.entries(i).filter(([e])=>"type"!==e&&"applyInsert"!==e&&"applyUpdate"!==e).map(([e,t])=>`${e}="${t}"`).join(", "),s=document.createElement("div");s.className="field-validations d-flex justify-content-between align-items-center mb-2",s.innerHTML=`
            <div>
              <span>@${i.type}(${l})</span>
              
            </div>
            <div>
              <button type="button" class="btn btn-sm btn-primary me-1" onclick="valBuilder.editValidation('${t}', ${a})"><i class="fa-solid fa-pencil"></i></button>
              <button type="button" class="btn btn-sm btn-danger" onclick="valBuilder.deleteValidation('${t}', ${a})"><i class="fa-solid fa-trash-can"></i></button>
            </div>`,e.appendChild(s)}),document.querySelector(this.jsonOutputSelector).textContent=JSON.stringify(this.validationsPerField,null,2),this}deleteValidation(e,t){return this.validationsPerField[e].splice(t,1),0===this.validationsPerField[e].length&&delete this.validationsPerField[e],this.renderValidations(),this}editValidation(e,t,i){this.currentField=e,this.currentIndex=t,this.currentMaximumLength=i;let a=this.validationsPerField[e][t];this.modalElement.querySelector(".validation-type").value=a.type,this.renderPropsInputs(a),this.updateDropDown(a.type),$(this.modalSelector).modal("show")}getValidation(e){return e&&$(this.baseSelector).modal("hide"),this.validationsPerField}setValidation(e){return this.validationsPerField=e,this}}