class EntityRenderer{constructor(t){this.selector=t,this.svg=document.querySelector(this.selector),this.tables={},this.xPadding=5,this.yPadding=5,this.betweenX=20,this.betweenY=20,this.tableWidth=250,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.entityStrokeWidth="0.5",this.stroke="#8496B1",this.columnTextColor="#3a4255",this.columnHeight=20,this.columnTypeFontSize=9,this.columnFontSize=11,this.headerBackgroundColor="#d8e8ff",this.buttonSpace=16,this.buttonMargin=6,this.buttonWidth=14,this.buttonHeight=14,this.buttonFontSize=10,this.tableFontSize=12,this.relationStrokeWidth=.7}createERD(t,e,i){this.svg=document.querySelector(this.selector),this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let s=this.xPadding,n=this.yPadding,a=s,r=n,h=0,l=0;this.data.entities.forEach(t=>{let i=this.createTable(t,t.index,a,r);this.tables[t.name]={table:i,xPos:a,yPos:r},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,a+=this.betweenX+this.tableWidth,++l>h&&(h=l),a>e-this.tableWidth-1&&(a=s,r+=this.maxCol*this.columnHeight+this.betweenY+30,this.maxCol=0,l=0),this.maxTop=r});let o=r;l>0?o+=this.maxCol*this.columnHeight+30:o-=this.betweenY;let d=2*this.xPadding+h*(this.betweenX+this.tableWidth)-this.betweenX+2,c=2*this.yPadding+o-2;this.svg.setAttribute("height",c),this.svg.setAttribute("width",d),i&&this.createRelationships(),this.svg=document.querySelector(this.selector)}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")&&!e.primaryKey){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.buttonSpace+this.buttonMargin}createTable(t,e,i,s){let n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("data-entity",t.name),n.classList.add("svg-entity"),n.setAttribute("transform",`translate(${i}, ${s})`);let a=t.columns.length*this.columnHeight+26,r=this.createSvgRect(0,0,this.tableWidth,a,"#ffffff",this.stroke,this.entityStrokeWidth);n.appendChild(r);let h=this.createSvgRect(1,1,this.tableWidth-2,24,this.headerBackgroundColor);n.appendChild(h);let l=this.createSvgForeignText(10,5,this.tableWidth-95,18,t.name);return n.appendChild(l),[{icon:"\uD83D\uDCC4",offset:5,className:"view-data-icon"},{icon:"⬅️",offset:4,className:"move-up-icon"},{icon:"➡️",offset:3,className:"move-down-icon"},{icon:"✏️",offset:2,className:"edit-icon"},{icon:"❌",offset:1,className:"delete-icon"}].forEach(({icon:t,offset:i,className:s})=>{let a=this.tableWidth-this.createOffset(i),r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",a),r.setAttribute("y",17),r.setAttribute("font-size",this.buttonFontSize),r.textContent=t,n.appendChild(r);let h=document.createElementNS("http://www.w3.org/2000/svg","rect");h.setAttribute("x",a),h.setAttribute("y",7),h.setAttribute("width",this.buttonWidth),h.setAttribute("height",this.buttonHeight),h.setAttribute("fill","transparent"),h.setAttribute("class",s),h.setAttribute("data-index",e),h.style.cursor="pointer",n.appendChild(h)}),t.columns.forEach((t,e)=>{let i=40+e*this.columnHeight,s=26+e*this.columnHeight;if(t.primaryKey){let a=this.createSvgRect(1,s+1,this.tableWidth-2,this.columnHeight-2,"#f4f8ff");n.appendChild(a)}let r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",10),r.setAttribute("y",i),r.setAttribute("font-size",this.columnFontSize),r.setAttribute("fill",this.columnTextColor),r.textContent=t.name,r.classList.add("diagram-column-name"),n.appendChild(r);let h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",this.tableWidth-10),h.setAttribute("y",i),h.setAttribute("font-size",this.columnTypeFontSize),h.setAttribute("fill",this.columnTextColor),h.setAttribute("text-anchor","end");let l=this.getFormattedType(t);h.textContent=l,n.appendChild(h);let o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",0),o.setAttribute("y1",s),o.setAttribute("x2",this.tableWidth),o.setAttribute("y2",s),o.setAttribute("stroke",this.stroke),o.setAttribute("stroke-width",this.entityStrokeWidth),n.appendChild(o)}),this.svg.appendChild(n),n}createSvgRect(t,e,i,s,n="transparent",a="none",r=0){let h=document.createElementNS("http://www.w3.org/2000/svg","rect");return h.setAttribute("x",t),h.setAttribute("y",e),h.setAttribute("width",i),h.setAttribute("height",s),h.setAttribute("fill",n),h.setAttribute("stroke",a),h.setAttribute("stroke-width",r),h}createSvgForeignText(t,e,i,s,n){let a=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");a.setAttribute("x",t),a.setAttribute("y",e),a.setAttribute("width",i),a.setAttribute("height",s);let r=document.createElement("div");return r.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),r.style.cssText=`font-size: 12px; font-family: sans-serif; color: #1d3c86; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: ${s}px;`,r.textContent=n,a.appendChild(r),a}getFormattedType(t){return this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`}createRelationship(t,e,i){let s=e.name.replace("_id",""),n=this.getEntityByName(s);if(null!=n){let a=this.getColumnIndex(n,e.name),r=this.tables[t.name].table,h=this.tables[s].table,l=i*this.columnHeight+this.tables[t.name].yPos+36,o=parseInt(r.getAttribute("transform").split(",")[0].replace("translate(","")),d=parseInt(h.getAttribute("transform").split(",")[0].replace("translate(","")),c=a*this.columnHeight+this.tables[s].yPos+36,g,m;o==d?(o+=4,d+=4,g=o-8,m=d-8):o<=d?(o+=this.tableWidth,o-=4,d+=4,g=o+8,m=d-8):(d+=this.tableWidth,o+=4,d-=4,g=o-8,m=d+8);let u=document.createElementNS("http://www.w3.org/2000/svg","circle"),p=document.createElementNS("http://www.w3.org/2000/svg","circle");u.setAttribute("cx",o),u.setAttribute("cy",l),u.setAttribute("r",3),u.setAttribute("fill","#2A56BD"),p.setAttribute("cx",d),p.setAttribute("cy",c),p.setAttribute("r",3),p.setAttribute("fill","#CC0088");let b=document.createElementNS("http://www.w3.org/2000/svg","path"),w=`M ${o} ${l} L ${g} ${l} L ${m} ${c} L ${d} ${c}`;b.setAttribute("d",w),b.setAttribute("stroke","#2A56BD"),b.setAttribute("stroke-width",this.relationStrokeWidth),b.setAttribute("fill","transparent"),this.svg.appendChild(b),this.svg.appendChild(u),this.svg.appendChild(p)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}downloadSVG(){let t=this.getFileName()+".svg";this.exportToSVG(this.svg,t)}downloadPNG(){let t=this.getFileName()+".png";this.exportToPNG(this.svg,t)}downloadMD(){let t=this.getFileName()+".md";this.exportToMD(t)}getFileName(){let t=document.querySelector(".diagram-list.tabs").querySelector('.diagram-tab.active input[type="text"]'),e=document.querySelector('meta[name="application-id"]').getAttribute("content"),i=document.querySelector('meta[name="database-name"]').getAttribute("content"),s="",n="";return n=""!=i?i:e,s=null!=t?n+" - "+t.value:n}generateSVGString(t){let e=t.clientWidth,i=t.clientHeight+2,s=new XMLSerializer().serializeToString(t);return`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${e}" height="${i}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                        .move-up-icon, .move-down-icon, .edit-icon, .delete-icon {
                            display: none;
                            visibility: hidden;
                            opacity: 0;
                            pointer-events: none;
                        }
                    ]]>
                </style>
            </defs>
            ${s}
        </svg>`}exportToSVG(t,e="exported-image.svg"){let i=this.generateSVGString(t),s=new Blob([i],{type:"image/svg+xml"}),n=URL.createObjectURL(s),a=document.createElement("a");a.href=n,a.download=e,a.click(),URL.revokeObjectURL(n)}exportToPNG(t,e="exported-image.png"){let i=t.clientWidth,s=t.clientHeight,n=document.createElement("canvas");n.width=i,n.height=s;let a=n.getContext("2d"),r=this.generateSVGString(t),h="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(r),l=new Image;l.onload=function(){a.drawImage(l,0,0);let t=n.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},l.onerror=function(t){console.error("Error loading the SVG image:",t)},l.src=h}exportToMD(t="exported-image.md"){let e=this,i=`# Entity-Relationship Diagram

`;i+=`This diagram represents the entities and their relationships in the database.

`,i+=`## Entities

`,this.data.entities.forEach(t=>{i+=`### ${t.name}

`,t.description&&(i+=`**Description:** ${t.description}

`),t.creationDate&&(i+=`**Created on:** ${e.formatDate(t.creationDate)}
`),t.creator&&""!==t.creator&&"{{userName}}"!==t.creator&&(i+=`**Created by:** ${t.creator}
`),t.modificationDate&&(i+=`**Updated on:** ${e.formatDate(t.modificationDate)}
`),t.modifier&&""!==t.modifier&&"{{userName}}"!==t.modifier&&(i+=`**Updated by:** ${t.modifier}
`),i+=`
`;let s="Column Name",n="Type",a="Null",r=Math.max(...t.columns.map(t=>t.name.length),s.length),h=Math.max(...t.columns.map(t=>this.getFormattedType(t).length),n.length),l=Math.max(a.length,4);r<30&&(r=30),h<13&&(h=13),i+=`| ${s.padEnd(r)} | ${n.padEnd(h)} | ${a.padEnd(l)} | ${"Key".padEnd(3)} | ${"AI".padEnd(3)} |
`,i+=`| ${"-".repeat(r)} | ${"-".repeat(h)} | ${"-".repeat(l)} | ${"-".repeat(3)} | ${"-".repeat(3)} |
`,t.columns.forEach(t=>{let e=this.getFormattedType(t),s=t.nullable?"YES":"NO",n=t.primaryKey?"YES":"NO",a=t.autoIncrement?"YES":"NO";i+=`| ${t.name.padEnd(r)} | ${e.padEnd(h)} | ${s.padEnd(l)} | ${n.padEnd(3)} | ${a.padEnd(3)} |
`}),i+=`
`}),i+=`
`;let s=new Blob([i],{type:"text/markdown"}),n=URL.createObjectURL(s),a=document.createElement("a");a.href=n,a.download=t,a.click(),URL.revokeObjectURL(n)}formatDate(t){let e=new Date(t);return e.toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(",","")}getSVGElement(){return this.svg}}