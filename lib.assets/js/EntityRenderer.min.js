class EntityRenderer{constructor(t){this.selector=t,this.svg=qs(this.selector),this.tables={},this.xPadding=5,this.yPadding=5,this.betweenX=20,this.betweenY=20,this.tableWidth=220,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.entityStrokeWidth="0.5",this.stroke="#8496B1",this.columnTextColor="#3a4255",this.columnHeight=20,this.columnTypeFontSize=9,this.columnFontSize=11,this.headerBackgroundColor="#d8e8ff",this.buttonSpace=16,this.buttonMargin=6,this.buttonWidth=14,this.buttonHeight=14,this.buttonFontSize=10,this.tableFontSize=12,this.relationStrokeWidth=.7}createERD(t,e,i,s){this.svg=qs(this.selector),this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let n=this.xPadding,a=this.yPadding,r=n,l=a,o=0,h=0;this.data.entities.forEach(t=>{let a=this.createTable(t,t.index,r,l,i,s);this.tables[t.name]={table:a,xPos:r,yPos:l},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,r+=this.betweenX+this.tableWidth,++h>o&&(o=h),r>e-this.tableWidth-1&&(r=n,l+=this.maxCol*this.columnHeight+this.betweenY+30,this.maxCol=0,h=0),this.maxTop=l});let d=l;h>0?d+=this.maxCol*this.columnHeight+30:d-=this.betweenY;let c=2*this.xPadding+o*(this.betweenX+this.tableWidth)-this.betweenX+2,g=2*this.yPadding+d-2;this.svg.setAttribute("height",g),this.svg.setAttribute("width",c),s?this.createFkRelationships():i&&this.createAutoRelationships(),this.svg=qs(this.selector)}createFkRelationships(){Object.values(this.data.entities).forEach(t=>{let e=Array.isArray(t.foreignKeys)?t.foreignKeys:Object.values(t.foreignKeys||{});e.forEach(e=>{let i=e.referencedTable,s=e.referencedColumn,n=this.getColumnIndex(t,e.columnName);this.createRelationship(t,e.columnName,n,i,s)})})}createAutoRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.buttonSpace+this.buttonMargin}hasForeignKeys(t,e){return!!t?.foreignKeys&&(Array.isArray(t.foreignKeys)?t.foreignKeys.some(t=>t.columnName===e):t.foreignKeys.hasOwnProperty(e)&&void 0!==t.foreignKeys[e])}createTable(t,e,i,s,n,a){let r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("data-entity",t.name),r.classList.add("svg-entity"),r.setAttribute("data-index",e),r.setAttribute("transform",`translate(${i}, ${s})`);let l=t.columns.length*this.columnHeight+26,o=this.createSvgRect(0,0,this.tableWidth,l,"#ffffff",this.stroke,this.entityStrokeWidth);o.setAttribute("rx",1),o.setAttribute("ry",1),r.appendChild(o);let h=this.createSvgRect(1,1,this.tableWidth-2,24,this.headerBackgroundColor);r.appendChild(h);let d=this.createSvgForeignText(10,5,this.tableWidth-95,18,t.name);r.appendChild(d),[{icon:"\uD83D\uDCC4",offset:5,className:"view-data-icon"},{icon:"⬅️",offset:4,className:"move-up-icon"},{icon:"➡️",offset:3,className:"move-down-icon"},{icon:"✏️",offset:2,className:"edit-icon"},{icon:"❌",offset:1,className:"delete-icon"}].forEach(({icon:t,offset:i,className:s})=>{let n=this.tableWidth-this.createOffset(i),a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",n),a.setAttribute("y",17),a.setAttribute("font-size",this.buttonFontSize),a.textContent=t,r.appendChild(a);let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x",n),l.setAttribute("y",7),l.setAttribute("width",this.buttonWidth),l.setAttribute("height",this.buttonHeight),l.setAttribute("fill","transparent"),l.setAttribute("class",s),l.setAttribute("data-index",e),l.style.cursor="pointer",r.appendChild(l)});let c=document.createElementNS("http://www.w3.org/2000/svg","g");return c.classList.add("svg-entity-columns"),t.columns.forEach((e,i)=>{let s=document.createElementNS("http://www.w3.org/2000/svg","g");s.classList.add("svg-entity-column");let n=40+i*this.columnHeight,r=26+i*this.columnHeight,l=document.createElementNS("http://www.w3.org/2000/svg","text");if(l.setAttribute("x",10),l.setAttribute("y",n),l.setAttribute("font-size",this.columnFontSize),l.setAttribute("fill",this.columnTextColor),l.textContent=e.name,l.classList.add("svg-column-name"),e.primaryKey){let o=this.createSvgRect(1,r+1,this.tableWidth-2,this.columnHeight-2,"#fff4f4bb");c.appendChild(o),l.setAttribute("data-primary-key","true")}if(a&&this.hasForeignKeys(t,e.name)){let h=this.createSvgRect(1,r+1,this.tableWidth-2,this.columnHeight-2,"#f4f8ffbb");c.appendChild(h),l.setAttribute("data-foreign-key","true")}s.appendChild(l);let d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",this.tableWidth-10),d.setAttribute("y",n),d.setAttribute("font-size",this.columnTypeFontSize),d.setAttribute("fill",this.columnTextColor),d.setAttribute("text-anchor","end"),d.classList.add("svg-column-type");let g=this.getFormattedType(e);d.textContent=g,s.appendChild(d);let u=document.createElementNS("http://www.w3.org/2000/svg","line");u.setAttribute("x1",0),u.setAttribute("y1",r),u.setAttribute("x2",this.tableWidth),u.setAttribute("y2",r),u.setAttribute("stroke",this.stroke),u.setAttribute("stroke-width",this.entityStrokeWidth),s.appendChild(u),c.appendChild(s)}),r.appendChild(c),this.svg.appendChild(r),r}createSvgRect(t,e,i,s,n="transparent",a="none",r=0){let l=document.createElementNS("http://www.w3.org/2000/svg","rect");return l.setAttribute("x",t),l.setAttribute("y",e),l.setAttribute("width",i),l.setAttribute("height",s),l.setAttribute("fill",n),l.setAttribute("stroke",a),l.setAttribute("stroke-width",r),l}createSvgForeignText(t,e,i,s,n){let a=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");a.setAttribute("x",t),a.setAttribute("y",e),a.setAttribute("width",i),a.setAttribute("height",s);let r=document.createElement("div");return r.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),r.style.cssText=`font-size: 12px; font-family: sans-serif; color: #1d3c86; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: ${s}px; text-align:left;`,r.textContent=n,a.appendChild(r),a}getFormattedType(t){return this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`}createRelationship(t,e,i,s=null,n=null){s=s||e.name.replace("_id","");let a=this.getEntityByName(s);if(null!=a){let r=this.getColumnIndex(a,n||e.name),l=this.tables[t.name].table,o=this.tables[s].table,h=i*this.columnHeight+this.tables[t.name].yPos+36,d=parseInt(l.getAttribute("transform").split(",")[0].replace("translate(","")),c=parseInt(o.getAttribute("transform").split(",")[0].replace("translate(","")),g=r*this.columnHeight+this.tables[s].yPos+36,u,m;d==c?(d+=4,c+=4,u=d-8,m=c-8):d<=c?(d+=this.tableWidth,d-=4,c+=4,u=d+8,m=c-8):(c+=this.tableWidth,d+=4,c-=4,u=d-8,m=c+8);let p=document.createElementNS("http://www.w3.org/2000/svg","circle"),b=document.createElementNS("http://www.w3.org/2000/svg","circle");p.setAttribute("cx",d),p.setAttribute("cy",h),p.setAttribute("r",3),p.setAttribute("fill","#2A56BD"),b.setAttribute("cx",c),b.setAttribute("cy",g),b.setAttribute("r",3),b.setAttribute("fill","#CC0088");let w=document.createElementNS("http://www.w3.org/2000/svg","path"),f=`M ${d} ${h} L ${u} ${h} L ${m} ${g} L ${c} ${g}`;w.setAttribute("d",f),w.setAttribute("stroke","#2A56BD"),w.setAttribute("stroke-width",this.relationStrokeWidth),w.setAttribute("fill","transparent"),this.svg.appendChild(w),this.svg.appendChild(p),this.svg.appendChild(b)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}downloadSVG(){let t=this.getFileName()+".svg";this.exportToSVG(this.svg,t)}downloadPNG(){let t=this.getFileName()+".png";this.exportToPNG(this.svg,t)}downloadMD(){let t=this.getFileName()+".md";this.exportToMD(t)}getFileName(){let t=qs(".diagram-list.tabs").querySelector('.diagram-tab.active input[type="text"]'),e=qs('meta[name="schema-name"]').getAttribute("content"),i="";return null!=t?e+" - "+t.value:e}generateSVGString(t){let e=t.clientWidth,i=t.clientHeight+2,s=new XMLSerializer().serializeToString(t);return`
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${e}" height="${i}">
    <defs>
        <style type="text/css">
            <![CDATA[
                text {
                    font-family: 'Arial', sans-serif;
                }
                .move-up-icon, .move-down-icon, .edit-icon, .delete-icon {
                    display: none;
                    visibility: hidden;
                    opacity: 0;
                    pointer-events: none;
                }
            ]]>
        </style>
    </defs>
    ${s}
</svg>
`}exportToSVG(t,e="exported-image.svg"){let i=this.generateSVGString(t),s=new Blob([i],{type:"image/svg+xml"}),n=URL.createObjectURL(s),a=document.createElement("a");a.href=n,a.download=e,a.click(),URL.revokeObjectURL(n)}exportToPNG(t,e="exported-image.png"){let i=t.clientWidth,s=t.clientHeight,n=document.createElement("canvas");n.width=i,n.height=s;let a=n.getContext("2d"),r=this.generateSVGString(t),l="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(r),o=new Image;o.onload=function(){a.drawImage(o,0,0);let t=n.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},o.onerror=function(t){console.error("Error loading the SVG image:",t)},o.src=l}exportToMD(t="exported.md"){let e=this,i=`# Entity Documentation

`;i+=`This document provides an overview of all entity structures in the system, including table metadata and column definitions.

`,i+=`---

`,i+=`## Entities

`,this.data.entities.forEach(t=>{i+=`### ${t.name}

`,t.description&&(i+=`**Description:** ${t.description}

`),t.creationDate&&(i+=`**Created on:** ${e.formatDate(t.creationDate)}
`),t.creator&&""!==t.creator&&"{{userName}}"!==t.creator&&(i+=`**Created by:** ${t.creator}
`),t.modificationDate&&(i+=`**Updated on:** ${e.formatDate(t.modificationDate)}
`),t.modifier&&""!==t.modifier&&"{{userName}}"!==t.modifier&&(i+=`**Updated by:** ${t.modifier}
`),i+=`
`;let s="Column Name",n="Type",a="Null",r=Math.max(...t.columns.map(t=>t.name.length),s.length),l=Math.max(...t.columns.map(t=>this.getFormattedType(t).length),n.length),o=Math.max(a.length,4);r<30&&(r=30),l<13&&(l=13),i+=`| ${s.padEnd(r)} | ${n.padEnd(l)} | ${a.padEnd(o)} | ${"Key".padEnd(3)} | ${"AI".padEnd(3)} |
`,i+=`| ${"-".repeat(r)} | ${"-".repeat(l)} | ${"-".repeat(o)} | ${"-".repeat(3)} | ${"-".repeat(3)} |
`,t.columns.forEach(t=>{let e=this.getFormattedType(t),s=t.nullable?"YES":"NO",n=t.primaryKey?"YES":"NO",a=t.autoIncrement?"YES":"NO";i+=`| ${t.name.padEnd(r)} | ${e.padEnd(l)} | ${s.padEnd(o)} | ${n.padEnd(3)} | ${a.padEnd(3)} |
`}),i+=`
`}),i+=`---

`,i+=`*Generated automatically by MagicAppBuilder.*
`,i+=`*This file reflects the current state of the data entities in the system as of ${e.formatDate(new Date)}.*
`;let s=new Blob([i],{type:"text/markdown"}),n=URL.createObjectURL(s),a=document.createElement("a");a.href=n,a.download=t,a.click(),URL.revokeObjectURL(n)}formatDate(t){let e=new Date(t);return e.toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(",","")}getSVGElement(){return this.svg}}