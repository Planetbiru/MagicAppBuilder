class EntityRenderer{constructor(t){this.svg=t,this.tables={},this.spacing=260,this.tableWidth=240,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.mod=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"]}createERD(t,e){this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let i=0,s=0;this.data.entities.forEach((t,r)=>{let l=this.createTable(t,r,i,s);this.tables[t.name]={table:l,xPos:i,yPos:s},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,i+=this.spacing,this.mod++,i>e-this.spacing&&(i=0,s+=20*this.maxCol+60,this.maxCol=0,this.mod=0),this.maxTop=s});let r=s-20;this.mod>0&&(r+=20*this.maxCol+60),this.svg.setAttribute("height",r),this.createRelationships()}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")&&!e.primaryKey){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createTable(t,e,i,s){let r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("transform",`translate(${i}, ${s})`);let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("width",this.tableWidth),l.setAttribute("height",20*t.columns.length+28),l.setAttribute("fill","transparent"),l.setAttribute("stroke","#8496B1"),l.setAttribute("stroke-width","0.5"),r.appendChild(l);let a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",1),a.setAttribute("y",1),a.setAttribute("width",this.tableWidth-2),a.setAttribute("height",24),a.setAttribute("fill","#E0EDFF"),r.appendChild(a);let n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("x",10),n.setAttribute("y",17),n.setAttribute("font-size","12"),n.setAttribute("text-anchor","left"),n.setAttribute("stroke-width","0.5"),n.setAttribute("fill","#1d3c86"),n.textContent=t.name,r.appendChild(n);let h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",this.tableWidth-42),h.setAttribute("y",17),h.setAttribute("font-size","10"),h.setAttribute("fill","#ffffff"),h.textContent="✏️",r.appendChild(h);let o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",this.tableWidth-42),o.setAttribute("y",7),o.setAttribute("width",14),o.setAttribute("height",14),o.setAttribute("fill","transparent"),r.appendChild(o);let d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",this.tableWidth-22),d.setAttribute("y",17),d.setAttribute("font-size","10"),d.setAttribute("fill","#ffffff"),d.textContent="❌",r.appendChild(d);let $=document.createElementNS("http://www.w3.org/2000/svg","rect");return $.setAttribute("x",this.tableWidth-22),$.setAttribute("y",7),$.setAttribute("width",14),$.setAttribute("height",14),$.setAttribute("fill","transparent"),r.appendChild($),o.style.cursor="pointer",$.style.cursor="pointer",o.setAttribute("onclick",`editor.editEntity(${e})`),$.setAttribute("onclick",`editor.deleteEntity(${e})`),t.columns.forEach((t,e)=>{let i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("x",10),i.setAttribute("y",40+20*e),i.setAttribute("font-size","12"),i.setAttribute("fill","#3a4255"),i.textContent=t.name,r.appendChild(i);let s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",this.tableWidth-10),s.setAttribute("y",40+20*e),s.setAttribute("font-size","10"),s.setAttribute("fill","#3a4255");let l;l=this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`,s.textContent=l,s.setAttribute("text-anchor","end"),r.appendChild(s);let a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",0),a.setAttribute("y1",26+20*e),a.setAttribute("x2",this.tableWidth),a.setAttribute("y2",26+20*e),a.setAttribute("stroke","#8496B1"),a.setAttribute("stroke-width","0.3"),r.appendChild(a)}),this.svg.appendChild(r),r}createRelationship(t,e,i){let s=e.name.replace("_id",""),r=this.getEntityByName(s),l=this.getColumnIndex(r,e.name),a=this.tables[t.name].table,n=this.tables[s].table,h=20*i+this.tables[t.name].yPos+35,o=20*l+this.tables[s].yPos+35,d=parseInt(a.getAttribute("transform").split(",")[0].replace("translate(","")),$=parseInt(n.getAttribute("transform").split(",")[0].replace("translate(","")),b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",d+this.tableWidth),b.setAttribute("y1",h),b.setAttribute("x2",$),b.setAttribute("y2",o),b.setAttribute("stroke","#2E4C95"),b.setAttribute("stroke-width","0.7"),this.svg.appendChild(b)}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}exportToSVG(t,e="exported-image.svg"){let i=new XMLSerializer().serializeToString(t),s=`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${width}" height="${height}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                    ]]>
                </style>
            </defs>
            ${i}
        </svg>`,r=new Blob([s],{type:"image/svg+xml"}),l=URL.createObjectURL(r),a=document.createElement("a");a.href=l,a.download=e,a.click(),URL.revokeObjectURL(l)}exportToPNG(t,e="exported_image.png"){let i=t.clientWidth,s=t.clientHeight,r=document.createElement("canvas");r.width=i,r.height=s;let l=r.getContext("2d"),a=new XMLSerializer().serializeToString(t),n=`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${i}" height="${s}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                    ]]>
                </style>
            </defs>
            ${a}
        </svg>`,h="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),o=new Image;o.onload=function(){l.drawImage(o,0,0);let t=r.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},o.onerror=function(t){console.error("Error loading the SVG image:",t)},o.src=h}editEntity(t){console.log("Editing entity:",t)}deleteEntity(t){console.log("Deleting entity:",t)}}