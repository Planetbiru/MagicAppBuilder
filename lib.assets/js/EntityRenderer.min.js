class EntityRenderer{constructor(t){this.selector=t,this.svg=document.querySelector(this.selector),this.tables={},this.xPadding=5,this.yPadding=5,this.betweenX=20,this.betweenY=20,this.tableWidth=250,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.entityStrokeWidth="0.5",this.stroke="#8496B1",this.columnTextColor="#3a4255",this.columnHeight=20,this.columnTypeFontSize=9,this.columnFontSize=11,this.headerBackgroundColor="#d8e8ff",this.buttonSpace=16,this.buttonMargin=6,this.buttonWidth=14,this.buttonHeight=14,this.buttonFontSize=10,this.tableFontSize=12,this.relationStrokeWidth=.7}createERD(t,e,i){this.svg=document.querySelector(this.selector),this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let s=this.xPadding,n=this.yPadding,r=s,h=n,a=0,l=0;this.data.entities.forEach((t,i)=>{let n=this.createTable(t,t.index,r,h);this.tables[t.name]={table:n,xPos:r,yPos:h},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,r+=this.betweenX+this.tableWidth,++l>a&&(a=l),r>e-this.tableWidth-1&&(r=s,h+=this.maxCol*this.columnHeight+this.betweenY+30,this.maxCol=0,l=0),this.maxTop=h});let o=h;l>0?o+=this.maxCol*this.columnHeight+30:o-=this.betweenY;let c=2*this.xPadding+a*(this.betweenX+this.tableWidth)-this.betweenX+2,d=2*this.yPadding+o-2;this.svg.setAttribute("height",d),this.svg.setAttribute("width",c),i&&this.createRelationships(),this.svg=document.querySelector(this.selector)}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")&&!e.primaryKey){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.buttonSpace+this.buttonMargin}createTable(t,e,i,s){let n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("data-entity",t.name),n.classList.add("svg-entity"),n.setAttribute("transform",`translate(${i}, ${s})`);let r=t.columns.length*this.columnHeight+26,h=this.createSvgRect(0,0,this.tableWidth,r,"#ffffff",this.stroke,this.entityStrokeWidth);n.appendChild(h);let a=this.createSvgRect(1,1,this.tableWidth-2,24,this.headerBackgroundColor);n.appendChild(a);let l=this.createSvgForeignText(10,5,this.tableWidth-80,18,t.name);return n.appendChild(l),[{icon:"⬅️",offset:4,className:"move-up-icon"},{icon:"➡️",offset:3,className:"move-down-icon"},{icon:"✏️",offset:2,className:"edit-icon"},{icon:"❌",offset:1,className:"delete-icon"}].forEach(({icon:t,offset:i,className:s})=>{let r=this.tableWidth-this.createOffset(i),h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",r),h.setAttribute("y",17),h.setAttribute("font-size",this.buttonFontSize),h.textContent=t,n.appendChild(h);let a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",r),a.setAttribute("y",7),a.setAttribute("width",this.buttonWidth),a.setAttribute("height",this.buttonHeight),a.setAttribute("fill","transparent"),a.setAttribute("class",s),a.setAttribute("data-index",e),a.style.cursor="pointer",n.appendChild(a)}),t.columns.forEach((t,e)=>{let i=40+e*this.columnHeight,s=26+e*this.columnHeight;if(t.primaryKey){let r=this.createSvgRect(1,s+1,this.tableWidth-2,this.columnHeight-2,"#f4f8ff");n.appendChild(r)}let h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",10),h.setAttribute("y",i),h.setAttribute("font-size",this.columnFontSize),h.setAttribute("fill",this.columnTextColor),h.textContent=t.name,h.classList.add("diagram-column-name"),n.appendChild(h);let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",this.tableWidth-10),a.setAttribute("y",i),a.setAttribute("font-size",this.columnTypeFontSize),a.setAttribute("fill",this.columnTextColor),a.setAttribute("text-anchor","end");let l=this.getFormattedType(t);a.textContent=l,n.appendChild(a);let o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",0),o.setAttribute("y1",s),o.setAttribute("x2",this.tableWidth),o.setAttribute("y2",s),o.setAttribute("stroke",this.stroke),o.setAttribute("stroke-width",this.entityStrokeWidth),n.appendChild(o)}),this.svg.appendChild(n),n}createSvgRect(t,e,i,s,n="transparent",r="none",h=0){let a=document.createElementNS("http://www.w3.org/2000/svg","rect");return a.setAttribute("x",t),a.setAttribute("y",e),a.setAttribute("width",i),a.setAttribute("height",s),a.setAttribute("fill",n),a.setAttribute("stroke",r),a.setAttribute("stroke-width",h),a}createSvgForeignText(t,e,i,s,n){let r=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");r.setAttribute("x",t),r.setAttribute("y",e),r.setAttribute("width",i),r.setAttribute("height",s);let h=document.createElement("div");return h.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),h.style.cssText=`font-size: 12px; font-family: sans-serif; color: #1d3c86; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: ${s}px;`,h.textContent=n,r.appendChild(h),r}getFormattedType(t){return this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`}createRelationship(t,e,i){let s=e.name.replace("_id",""),n=this.getEntityByName(s);if(null!=n){let r=this.getColumnIndex(n,e.name),h=this.tables[t.name].table,a=this.tables[s].table,l=i*this.columnHeight+this.tables[t.name].yPos+36,o=parseInt(h.getAttribute("transform").split(",")[0].replace("translate(","")),c=parseInt(a.getAttribute("transform").split(",")[0].replace("translate(","")),d=r*this.columnHeight+this.tables[s].yPos+36,g,u;o==c?(o+=4,c+=4,g=o-8,u=c-8):o<=c?(o+=this.tableWidth,o-=4,c+=4,g=o+8,u=c-8):(c+=this.tableWidth,o+=4,c-=4,g=o-8,u=c+8);let b=document.createElementNS("http://www.w3.org/2000/svg","circle"),m=document.createElementNS("http://www.w3.org/2000/svg","circle");b.setAttribute("cx",o),b.setAttribute("cy",l),b.setAttribute("r",3),b.setAttribute("fill","#2A56BD"),m.setAttribute("cx",c),m.setAttribute("cy",d),m.setAttribute("r",3),m.setAttribute("fill","#CC0088");let p=document.createElementNS("http://www.w3.org/2000/svg","path"),w=`M ${o} ${l} L ${g} ${l} L ${u} ${d} L ${c} ${d}`;p.setAttribute("d",w),p.setAttribute("stroke","#2A56BD"),p.setAttribute("stroke-width",this.relationStrokeWidth),p.setAttribute("fill","transparent"),this.svg.appendChild(p),this.svg.appendChild(b),this.svg.appendChild(m)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}downloadSVG(){let t=this.getFileName()+".svg";this.exportToSVG(this.svg,t)}downloadPNG(){let t=this.getFileName()+".png";this.exportToPNG(this.svg,t)}getFileName(){let t=document.querySelector(".diagram-list.tabs").querySelector('.diagram-tab.active input[type="text"]'),e=document.querySelector('meta[name="application-id"]').getAttribute("content"),i=document.querySelector('meta[name="database-name"]').getAttribute("content"),s="",n="";return n=""!=i?i:e,s=null!=t?n+" - "+t.value:n}generateSVGString(t){let e=t.clientWidth,i=t.clientHeight+2,s=new XMLSerializer().serializeToString(t);return`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${e}" height="${i}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                        .move-up-icon, .move-down-icon, .edit-icon, .delete-icon {
                            display: none;
                            visibility: hidden;
                            opacity: 0;
                            pointer-events: none;
                        }
                    ]]>
                </style>
            </defs>
            ${s}
        </svg>`}exportToSVG(t,e="exported-image.svg"){let i=this.generateSVGString(t),s=new Blob([i],{type:"image/svg+xml"}),n=URL.createObjectURL(s),r=document.createElement("a");r.href=n,r.download=e,r.click(),URL.revokeObjectURL(n)}exportToPNG(t,e="exported-image.png"){let i=t.clientWidth,s=t.clientHeight,n=document.createElement("canvas");n.width=i,n.height=s;let r=n.getContext("2d"),h=this.generateSVGString(t),a="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(h),l=new Image;l.onload=function(){r.drawImage(l,0,0);let t=n.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},l.onerror=function(t){console.error("Error loading the SVG image:",t)},l.src=a}getSVGElement(){return this.svg}}