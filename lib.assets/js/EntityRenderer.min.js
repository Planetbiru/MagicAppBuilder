class EntityRenderer{constructor(t){this.svg=t,this.tables={},this.xPadding=5,this.yPadding=5,this.betweenX=24,this.betweenY=24,this.tableWidth=260,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.entityStrokeWidth="0.5",this.stroke="#8496B1",this.columnTextColor="#3a4255",this.columnHeight=20,this.columnTypeFontSize=9,this.columnFontSize=11,this.headerBackgroundColor="#d8e8ff",this.buttonSpace=16,this.buttonMargin=6,this.buttonWidth=14,this.buttonHeight=14,this.buttonFontSize=10,this.tableFontSize=12,this.relationStrokeWidth=.7}createERD(t,e,i){this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let s=this.xPadding,h=this.yPadding,r=s,n=h,l=0,a=0;this.data.entities.forEach((t,i)=>{let h=this.createTable(t,i,r,n);this.tables[t.name]={table:h,xPos:r,yPos:n},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,r+=this.betweenX+this.tableWidth,++a>l&&(l=a),r>e-this.tableWidth-1&&(r=s,n+=this.maxCol*this.columnHeight+this.betweenY+30,this.maxCol=0,a=0),this.maxTop=n});let o=n;a>0?o+=this.maxCol*this.columnHeight+30:o-=this.betweenY;let u=2*this.xPadding+l*(this.betweenX+this.tableWidth)-this.betweenX+2,b=2*this.yPadding+o-2;this.svg.setAttribute("height",b),this.svg.setAttribute("width",u),i&&this.createRelationships()}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")&&!e.primaryKey){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.buttonSpace+this.buttonMargin}createTable(t,e,i,s){let h=document.createElementNS("http://www.w3.org/2000/svg","g");h.setAttribute("transform",`translate(${i}, ${s})`);let r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("width",this.tableWidth),r.setAttribute("height",t.columns.length*this.columnHeight+26),r.setAttribute("fill","#ffffff"),r.setAttribute("stroke",this.stroke),r.setAttribute("stroke-width",this.entityStrokeWidth),h.appendChild(r);let n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",1),n.setAttribute("y",1),n.setAttribute("width",this.tableWidth-2),n.setAttribute("height",24),n.setAttribute("fill",this.headerBackgroundColor),h.appendChild(n);let l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",10),l.setAttribute("y",17),l.setAttribute("font-size",this.tableFontSize),l.setAttribute("text-anchor","left"),l.setAttribute("fill","#1d3c86"),l.textContent=t.name,h.appendChild(l);let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",this.tableWidth-this.createOffset(4)),a.setAttribute("y",17),a.setAttribute("font-size",this.buttonFontSize),a.textContent="⬅️",h.appendChild(a);let o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",this.tableWidth-this.createOffset(4)),o.setAttribute("y",7),o.setAttribute("width",this.buttonWidth),o.setAttribute("height",this.buttonHeight),o.setAttribute("fill","transparent"),o.setAttribute("class","move-up-icon"),o.setAttribute("data-index",e),h.appendChild(o);let u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",this.tableWidth-this.createOffset(3)),u.setAttribute("y",17),u.setAttribute("font-size",this.buttonFontSize),u.textContent="➡️",h.appendChild(u);let b=document.createElementNS("http://www.w3.org/2000/svg","rect");b.setAttribute("x",this.tableWidth-this.createOffset(3)),b.setAttribute("y",7),b.setAttribute("width",this.buttonWidth),b.setAttribute("height",this.buttonHeight),b.setAttribute("fill","transparent"),b.setAttribute("class","move-down-icon"),b.setAttribute("data-index",e),h.appendChild(b);let d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",this.tableWidth-this.createOffset(2)),d.setAttribute("y",17),d.setAttribute("font-size",this.buttonFontSize),d.textContent="✏️",h.appendChild(d);let g=document.createElementNS("http://www.w3.org/2000/svg","rect");g.setAttribute("x",this.tableWidth-this.createOffset(2)),g.setAttribute("y",7),g.setAttribute("width",this.buttonWidth),g.setAttribute("height",this.buttonHeight),g.setAttribute("fill","transparent"),g.setAttribute("class","edit-icon"),g.setAttribute("data-index",e),h.appendChild(g);let c=document.createElementNS("http://www.w3.org/2000/svg","text");c.setAttribute("x",this.tableWidth-this.createOffset(1)),c.setAttribute("y",17),c.setAttribute("font-size",this.buttonFontSize),c.textContent="❌",h.appendChild(c);let w=document.createElementNS("http://www.w3.org/2000/svg","rect");return w.setAttribute("x",this.tableWidth-this.createOffset(1)),w.setAttribute("y",7),w.setAttribute("width",this.buttonWidth),w.setAttribute("height",this.buttonHeight),w.setAttribute("fill","transparent"),w.setAttribute("class","delete-icon"),w.setAttribute("data-index",e),h.appendChild(w),o.style.cursor="pointer",b.style.cursor="pointer",g.style.cursor="pointer",w.style.cursor="pointer",t.columns.forEach((t,e)=>{if(t.primaryKey){let i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("x",1),i.setAttribute("y",26+e*this.columnHeight+1),i.setAttribute("width",this.tableWidth-2),i.setAttribute("height",this.columnHeight-2),i.setAttribute("fill","#f4f8ff"),h.appendChild(i)}let s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",10),s.setAttribute("y",40+e*this.columnHeight),s.setAttribute("font-size",this.columnFontSize),s.setAttribute("fill",this.columnTextColor),s.textContent=t.name,h.appendChild(s);let r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",this.tableWidth-10),r.setAttribute("y",40+e*this.columnHeight),r.setAttribute("font-size",this.columnTypeFontSize),r.setAttribute("fill",this.columnTextColor);let n;n=this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`,r.textContent=n,r.setAttribute("text-anchor","end"),h.appendChild(r);let l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",0),l.setAttribute("y1",26+e*this.columnHeight),l.setAttribute("x2",this.tableWidth),l.setAttribute("y2",26+e*this.columnHeight),l.setAttribute("stroke",this.stroke),l.setAttribute("stroke-width",this.entityStrokeWidth),h.appendChild(l)}),this.svg.appendChild(h),h}createRelationship(t,e,i){let s=e.name.replace("_id",""),h=this.getEntityByName(s);if(null!=h){let r=this.getColumnIndex(h,e.name),n=this.tables[t.name].table,l=this.tables[s].table,a=i*this.columnHeight+this.tables[t.name].yPos+36,o=parseInt(n.getAttribute("transform").split(",")[0].replace("translate(",""))+this.tableWidth,u=parseInt(l.getAttribute("transform").split(",")[0].replace("translate(","")),b=r*this.columnHeight+this.tables[s].yPos+36,d=document.createElementNS("http://www.w3.org/2000/svg","circle"),g=document.createElementNS("http://www.w3.org/2000/svg","circle"),c=(o-=4)+6,w=(u+=4)-6;d.setAttribute("cx",o),d.setAttribute("cy",a),d.setAttribute("r",3),d.setAttribute("fill","#2A56BD"),g.setAttribute("cx",u),g.setAttribute("cy",b),g.setAttribute("r",3),g.setAttribute("fill","#CC0088"),this.svg.appendChild(d),this.svg.appendChild(g);let A=document.createElementNS("http://www.w3.org/2000/svg","path"),p=`M ${o} ${a} L ${c} ${a} L ${w} ${b} L ${u} ${b}`;A.setAttribute("d",p),A.setAttribute("stroke","#2A56BD"),A.setAttribute("stroke-width",this.relationStrokeWidth),A.setAttribute("fill","transparent"),this.svg.appendChild(A)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}downloadSVG(){this.exportToSVG(this.svg)}downloadPNG(){this.exportToPNG(this.svg)}exportToSVG(t,e="exported-image.svg"){let i=t.clientWidth,s=t.clientHeight+2,h=new XMLSerializer().serializeToString(t),r=`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${i}" height="${s}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                    ]]>
                </style>
            </defs>
            ${h}
        </svg>`,n=new Blob([r],{type:"image/svg+xml"}),l=URL.createObjectURL(n),a=document.createElement("a");a.href=l,a.download=e,a.click(),URL.revokeObjectURL(l)}exportToPNG(t,e="exported-image.png"){let i=t.clientWidth,s=t.clientHeight,h=document.createElement("canvas");h.width=i,h.height=s;let r=h.getContext("2d"),n=new XMLSerializer().serializeToString(t),l=`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${i}" height="${s}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                    ]]>
                </style>
            </defs>
            ${n}
        </svg>`,a="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(l),o=new Image;o.onload=function(){r.drawImage(o,0,0);let t=h.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},o.onerror=function(t){console.error("Error loading the SVG image:",t)},o.src=a}}