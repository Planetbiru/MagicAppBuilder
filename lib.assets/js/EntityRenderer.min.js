class EntityRenderer{constructor(t){this.svg=t,this.tables={},this.spacing=260,this.tableWidth=240,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.mod=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.btnSpace=16,this.btnMargin=2}createERD(t,e){this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let i=0,s=0;this.data.entities.forEach((t,r)=>{let a=this.createTable(t,r,i,s);this.tables[t.name]={table:a,xPos:i,yPos:s},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,i+=this.spacing,this.mod++,i>e-this.spacing&&(i=0,s+=20*this.maxCol+60,this.maxCol=0,this.mod=0),this.maxTop=s});let r=s-20;this.mod>0&&(r+=20*this.maxCol+60),this.svg.setAttribute("height",r),this.createRelationships()}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")&&!e.primaryKey){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.btnSpace+this.btnMargin}createTable(t,e,i,s){let r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("transform",`translate(${i}, ${s})`);let a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("width",this.tableWidth),a.setAttribute("height",20*t.columns.length+28),a.setAttribute("fill","transparent"),a.setAttribute("stroke","#8496B1"),a.setAttribute("stroke-width","0.5"),r.appendChild(a);let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x",1),l.setAttribute("y",1),l.setAttribute("width",this.tableWidth-2),l.setAttribute("height",24),l.setAttribute("fill","#E0EDFF"),r.appendChild(l);let n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("x",10),n.setAttribute("y",17),n.setAttribute("font-size","12"),n.setAttribute("text-anchor","left"),n.setAttribute("stroke-width","0.5"),n.setAttribute("fill","#1d3c86"),n.textContent=t.name,r.appendChild(n);let h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",this.tableWidth-this.createOffset(4)),h.setAttribute("y",17),h.setAttribute("font-size","10"),h.textContent="⬆️",r.appendChild(h);let o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",this.tableWidth-this.createOffset(4)),o.setAttribute("y",7),o.setAttribute("width",14),o.setAttribute("height",14),o.setAttribute("fill","transparent"),o.setAttribute("class","move-up-btn"),o.setAttribute("data-index",e),r.appendChild(o);let b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("x",this.tableWidth-this.createOffset(3)),b.setAttribute("y",17),b.setAttribute("font-size","10"),b.textContent="⬇️",r.appendChild(b);let d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x",this.tableWidth-this.createOffset(3)),d.setAttribute("y",7),d.setAttribute("width",14),d.setAttribute("height",14),d.setAttribute("fill","transparent"),d.setAttribute("class","move-down-btn"),d.setAttribute("data-index",e),r.appendChild(d);let u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",this.tableWidth-this.createOffset(2)),u.setAttribute("y",17),u.setAttribute("font-size","10"),u.textContent="✏️",r.appendChild(u);let $=document.createElementNS("http://www.w3.org/2000/svg","rect");$.setAttribute("x",this.tableWidth-this.createOffset(2)),$.setAttribute("y",7),$.setAttribute("width",14),$.setAttribute("height",14),$.setAttribute("fill","transparent"),$.setAttribute("class","edit-icon"),$.setAttribute("data-index",e),r.appendChild($);let w=document.createElementNS("http://www.w3.org/2000/svg","text");w.setAttribute("x",this.tableWidth-this.createOffset(1)),w.setAttribute("y",17),w.setAttribute("font-size","10"),w.textContent="❌",r.appendChild(w);let g=document.createElementNS("http://www.w3.org/2000/svg","rect");return g.setAttribute("x",this.tableWidth-this.createOffset(1)),g.setAttribute("y",7),g.setAttribute("width",14),g.setAttribute("height",14),g.setAttribute("fill","transparent"),g.setAttribute("class","delete-icon"),g.setAttribute("data-index",e),r.appendChild(g),o.style.cursor="pointer",d.style.cursor="pointer",$.style.cursor="pointer",g.style.cursor="pointer",t.columns.forEach((t,e)=>{let i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("x",10),i.setAttribute("y",40+20*e),i.setAttribute("font-size","12"),i.setAttribute("fill","#3a4255"),i.textContent=t.name,r.appendChild(i);let s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",this.tableWidth-10),s.setAttribute("y",40+20*e),s.setAttribute("font-size","10"),s.setAttribute("fill","#3a4255");let a;a=this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`,s.textContent=a,s.setAttribute("text-anchor","end"),r.appendChild(s);let l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",0),l.setAttribute("y1",26+20*e),l.setAttribute("x2",this.tableWidth),l.setAttribute("y2",26+20*e),l.setAttribute("stroke","#8496B1"),l.setAttribute("stroke-width","0.3"),r.appendChild(l)}),this.svg.appendChild(r),r}createRelationship(t,e,i){let s=e.name.replace("_id",""),r=this.getEntityByName(s);if(null!=r){let a=this.getColumnIndex(r,e.name),l=this.tables[t.name].table,n=this.tables[s].table,h=20*i+this.tables[t.name].yPos+35,o=20*a+this.tables[s].yPos+35,b=parseInt(l.getAttribute("transform").split(",")[0].replace("translate(","")),d=parseInt(n.getAttribute("transform").split(",")[0].replace("translate(","")),u=document.createElementNS("http://www.w3.org/2000/svg","line");u.setAttribute("x1",b+this.tableWidth),u.setAttribute("y1",h),u.setAttribute("x2",d),u.setAttribute("y2",o),u.setAttribute("stroke","#2E4C95"),u.setAttribute("stroke-width","0.7"),this.svg.appendChild(u)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}exportToSVG(t,e="exported-image.svg"){let i=new XMLSerializer().serializeToString(t),s=`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${width}" height="${height}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                    ]]>
                </style>
            </defs>
            ${i}
        </svg>`,r=new Blob([s],{type:"image/svg+xml"}),a=URL.createObjectURL(r),l=document.createElement("a");l.href=a,l.download=e,l.click(),URL.revokeObjectURL(a)}exportToPNG(t,e="exported_image.png"){let i=t.clientWidth,s=t.clientHeight,r=document.createElement("canvas");r.width=i,r.height=s;let a=r.getContext("2d"),l=new XMLSerializer().serializeToString(t),n=`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${i}" height="${s}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                    ]]>
                </style>
            </defs>
            ${l}
        </svg>`,h="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),o=new Image;o.onload=function(){a.drawImage(o,0,0);let t=r.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},o.onerror=function(t){console.error("Error loading the SVG image:",t)},o.src=h}editEntity(t){console.log("Editing entity:",t)}deleteEntity(t){console.log("Deleting entity:",t)}}