class EntityRenderer{constructor(t){this.svg=t,this.tables={},this.spacing=260,this.tableWidth=240,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.btnSpace=16,this.btnMargin=2}createERD(t,e){this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let i=0,s=0,r=0,a=0;this.data.entities.forEach((t,l)=>{let h=this.createTable(t,l,i,s);this.tables[t.name]={table:h,xPos:i,yPos:s},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,i+=this.spacing,++a>r&&(r=a),i>e-this.tableWidth-2&&(i=0,s+=20*this.maxCol+40,this.maxCol=0,a=0),this.maxTop=s});let l=s-20;a>0&&(l+=20*this.maxCol+60),this.svg.setAttribute("height",l+10);let h=r*this.spacing-(this.spacing-this.tableWidth)+2;console.log(r,h,this.spacing,this.tableWidth),this.svg.setAttribute("width",h),this.createRelationships()}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")&&!e.primaryKey){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.btnSpace+this.btnMargin}createTable(t,e,i,s){let r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("transform",`translate(${i}, ${s})`);let a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("width",this.tableWidth),a.setAttribute("height",20*t.columns.length+28),a.setAttribute("fill","#ffffff"),a.setAttribute("stroke","#8496B1"),a.setAttribute("stroke-width","0.5"),r.appendChild(a);let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x",1),l.setAttribute("y",1),l.setAttribute("width",this.tableWidth-2),l.setAttribute("height",24),l.setAttribute("fill","#d8e8ff"),r.appendChild(l);let h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",10),h.setAttribute("y",17),h.setAttribute("font-size","12"),h.setAttribute("text-anchor","left"),h.setAttribute("stroke-width","0.5"),h.setAttribute("fill","#1d3c86"),h.textContent=t.name,r.appendChild(h);let n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("x",this.tableWidth-this.createOffset(4)),n.setAttribute("y",17),n.setAttribute("font-size","10"),n.textContent="⬆️",r.appendChild(n);let o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",this.tableWidth-this.createOffset(4)),o.setAttribute("y",7),o.setAttribute("width",14),o.setAttribute("height",14),o.setAttribute("fill","transparent"),o.setAttribute("class","move-up-btn"),o.setAttribute("data-index",e),r.appendChild(o);let b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("x",this.tableWidth-this.createOffset(3)),b.setAttribute("y",17),b.setAttribute("font-size","10"),b.textContent="⬇️",r.appendChild(b);let d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x",this.tableWidth-this.createOffset(3)),d.setAttribute("y",7),d.setAttribute("width",14),d.setAttribute("height",14),d.setAttribute("fill","transparent"),d.setAttribute("class","move-down-btn"),d.setAttribute("data-index",e),r.appendChild(d);let u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",this.tableWidth-this.createOffset(2)),u.setAttribute("y",17),u.setAttribute("font-size","10"),u.textContent="✏️",r.appendChild(u);let w=document.createElementNS("http://www.w3.org/2000/svg","rect");w.setAttribute("x",this.tableWidth-this.createOffset(2)),w.setAttribute("y",7),w.setAttribute("width",14),w.setAttribute("height",14),w.setAttribute("fill","transparent"),w.setAttribute("class","edit-icon"),w.setAttribute("data-index",e),r.appendChild(w);let $=document.createElementNS("http://www.w3.org/2000/svg","text");$.setAttribute("x",this.tableWidth-this.createOffset(1)),$.setAttribute("y",17),$.setAttribute("font-size","10"),$.textContent="❌",r.appendChild($);let g=document.createElementNS("http://www.w3.org/2000/svg","rect");return g.setAttribute("x",this.tableWidth-this.createOffset(1)),g.setAttribute("y",7),g.setAttribute("width",14),g.setAttribute("height",14),g.setAttribute("fill","transparent"),g.setAttribute("class","delete-icon"),g.setAttribute("data-index",e),r.appendChild(g),o.style.cursor="pointer",d.style.cursor="pointer",w.style.cursor="pointer",g.style.cursor="pointer",t.columns.forEach((t,e)=>{if(t.primaryKey){let i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("x",1),i.setAttribute("y",27+20*e),i.setAttribute("width",this.tableWidth-2),i.setAttribute("height",20),i.setAttribute("fill","#f4f8ff"),r.appendChild(i)}let s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",10),s.setAttribute("y",40+20*e),s.setAttribute("font-size","12"),s.setAttribute("fill","#3a4255"),s.textContent=t.name,r.appendChild(s);let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",this.tableWidth-10),a.setAttribute("y",40+20*e),a.setAttribute("font-size","10"),a.setAttribute("fill","#3a4255");let l;l=this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`,a.textContent=l,a.setAttribute("text-anchor","end"),r.appendChild(a);let h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",0),h.setAttribute("y1",26+20*e),h.setAttribute("x2",this.tableWidth),h.setAttribute("y2",26+20*e),h.setAttribute("stroke","#8496B1"),h.setAttribute("stroke-width","0.3"),r.appendChild(h)}),this.svg.appendChild(r),r}createRelationship(t,e,i){let s=e.name.replace("_id",""),r=this.getEntityByName(s);if(null!=r){let a=this.getColumnIndex(r,e.name),l=this.tables[t.name].table,h=this.tables[s].table,n=20*i+this.tables[t.name].yPos+35,o=20*a+this.tables[s].yPos+35,b=parseInt(l.getAttribute("transform").split(",")[0].replace("translate(",""))+this.tableWidth,d=parseInt(h.getAttribute("transform").split(",")[0].replace("translate(","")),u=document.createElementNS("http://www.w3.org/2000/svg","line");u.setAttribute("x1",b-4),u.setAttribute("y1",n),u.setAttribute("x2",d+4),u.setAttribute("y2",o),u.setAttribute("stroke","#2E4C95"),u.setAttribute("stroke-width","0.7"),this.svg.appendChild(u)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}downloadSVG(){this.exportToSVG(this.svg)}downloadPNG(){this.exportToPNG(this.svg)}exportToSVG(t,e="exported-image.svg"){let i=t.clientWidth,s=t.clientHeight+2,r=new XMLSerializer().serializeToString(t),a=`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${i}" height="${s}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                    ]]>
                </style>
            </defs>
            ${r}
        </svg>`,l=new Blob([a],{type:"image/svg+xml"}),h=URL.createObjectURL(l),n=document.createElement("a");n.href=h,n.download=e,n.click(),URL.revokeObjectURL(h)}exportToPNG(t,e="exported_image.png"){let i=t.clientWidth,s=t.clientHeight,r=document.createElement("canvas");r.width=i,r.height=s;let a=r.getContext("2d"),l=new XMLSerializer().serializeToString(t),h=`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${i}" height="${s}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                    ]]>
                </style>
            </defs>
            ${l}
        </svg>`,n="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(h),o=new Image;o.onload=function(){a.drawImage(o,0,0);let t=r.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},o.onerror=function(t){console.error("Error loading the SVG image:",t)},o.src=n}}