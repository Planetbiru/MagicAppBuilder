class EntityRenderer{constructor(t){this.selector=t,this.svg=document.querySelector(this.selector),this.tables={},this.xPadding=5,this.yPadding=5,this.betweenX=20,this.betweenY=20,this.tableWidth=250,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.entityStrokeWidth="0.5",this.stroke="#8496B1",this.columnTextColor="#3a4255",this.columnHeight=20,this.columnTypeFontSize=9,this.columnFontSize=11,this.headerBackgroundColor="#d8e8ff",this.buttonSpace=16,this.buttonMargin=6,this.buttonWidth=14,this.buttonHeight=14,this.buttonFontSize=10,this.tableFontSize=12,this.relationStrokeWidth=.7}createERD(t,e,i){this.svg=document.querySelector(this.selector),this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let s=this.xPadding,r=this.yPadding,h=s,n=r,l=0,a=0;this.data.entities.forEach((t,i)=>{let r=this.createTable(t,t.index,h,n);this.tables[t.name]={table:r,xPos:h,yPos:n},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,h+=this.betweenX+this.tableWidth,++a>l&&(l=a),h>e-this.tableWidth-1&&(h=s,n+=this.maxCol*this.columnHeight+this.betweenY+30,this.maxCol=0,a=0),this.maxTop=n});let o=n;a>0?o+=this.maxCol*this.columnHeight+30:o-=this.betweenY;let u=2*this.xPadding+l*(this.betweenX+this.tableWidth)-this.betweenX+2,d=2*this.yPadding+o-2;this.svg.setAttribute("height",d),this.svg.setAttribute("width",u),i&&this.createRelationships(),this.svg=document.querySelector(this.selector)}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")&&!e.primaryKey){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.buttonSpace+this.buttonMargin}createTable(t,e,i,s){let r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("data-entity",t.name),r.classList.add("svg-entity"),r.setAttribute("transform",`translate(${i}, ${s})`);let h=document.createElementNS("http://www.w3.org/2000/svg","rect");h.setAttribute("width",this.tableWidth),h.setAttribute("height",t.columns.length*this.columnHeight+26),h.setAttribute("fill","#ffffff"),h.setAttribute("stroke",this.stroke),h.setAttribute("stroke-width",this.entityStrokeWidth),r.appendChild(h);let n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",1),n.setAttribute("y",1),n.setAttribute("width",this.tableWidth-2),n.setAttribute("height",24),n.setAttribute("fill",this.headerBackgroundColor),r.appendChild(n);let l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",10),l.setAttribute("y",17),l.setAttribute("font-size",this.tableFontSize),l.setAttribute("text-anchor","left"),l.setAttribute("fill","#1d3c86"),l.textContent=t.name,r.appendChild(l);let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",this.tableWidth-this.createOffset(4)),a.setAttribute("y",17),a.setAttribute("font-size",this.buttonFontSize),a.textContent="⬅️",r.appendChild(a);let o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",this.tableWidth-this.createOffset(4)),o.setAttribute("y",7),o.setAttribute("width",this.buttonWidth),o.setAttribute("height",this.buttonHeight),o.setAttribute("fill","transparent"),o.setAttribute("class","move-up-icon"),o.setAttribute("data-index",e),r.appendChild(o);let u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",this.tableWidth-this.createOffset(3)),u.setAttribute("y",17),u.setAttribute("font-size",this.buttonFontSize),u.textContent="➡️",r.appendChild(u);let d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x",this.tableWidth-this.createOffset(3)),d.setAttribute("y",7),d.setAttribute("width",this.buttonWidth),d.setAttribute("height",this.buttonHeight),d.setAttribute("fill","transparent"),d.setAttribute("class","move-down-icon"),d.setAttribute("data-index",e),r.appendChild(d);let b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("x",this.tableWidth-this.createOffset(2)),b.setAttribute("y",17),b.setAttribute("font-size",this.buttonFontSize),b.textContent="✏️",r.appendChild(b);let c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",this.tableWidth-this.createOffset(2)),c.setAttribute("y",7),c.setAttribute("width",this.buttonWidth),c.setAttribute("height",this.buttonHeight),c.setAttribute("fill","transparent"),c.setAttribute("class","edit-icon"),c.setAttribute("data-index",e),r.appendChild(c);let g=document.createElementNS("http://www.w3.org/2000/svg","text");g.setAttribute("x",this.tableWidth-this.createOffset(1)),g.setAttribute("y",17),g.setAttribute("font-size",this.buttonFontSize),g.textContent="❌",r.appendChild(g);let p=document.createElementNS("http://www.w3.org/2000/svg","rect");return p.setAttribute("x",this.tableWidth-this.createOffset(1)),p.setAttribute("y",7),p.setAttribute("width",this.buttonWidth),p.setAttribute("height",this.buttonHeight),p.setAttribute("fill","transparent"),p.setAttribute("class","delete-icon"),p.setAttribute("data-index",e),r.appendChild(p),o.style.cursor="pointer",d.style.cursor="pointer",c.style.cursor="pointer",p.style.cursor="pointer",t.columns.forEach((t,e)=>{if(t.primaryKey){let i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("x",1),i.setAttribute("y",26+e*this.columnHeight+1),i.setAttribute("width",this.tableWidth-2),i.setAttribute("height",this.columnHeight-2),i.setAttribute("fill","#f4f8ff"),r.appendChild(i)}let s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",10),s.setAttribute("y",40+e*this.columnHeight),s.setAttribute("font-size",this.columnFontSize),s.setAttribute("fill",this.columnTextColor),s.textContent=t.name,s.classList.add("diagram-column-name"),r.appendChild(s);let h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",this.tableWidth-10),h.setAttribute("y",40+e*this.columnHeight),h.setAttribute("font-size",this.columnTypeFontSize),h.setAttribute("fill",this.columnTextColor);let n;n=this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`,h.textContent=n,h.setAttribute("text-anchor","end"),r.appendChild(h);let l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",0),l.setAttribute("y1",26+e*this.columnHeight),l.setAttribute("x2",this.tableWidth),l.setAttribute("y2",26+e*this.columnHeight),l.setAttribute("stroke",this.stroke),l.setAttribute("stroke-width",this.entityStrokeWidth),r.appendChild(l)}),this.svg.appendChild(r),r}createRelationship(t,e,i){let s=e.name.replace("_id",""),r=this.getEntityByName(s);if(null!=r){let h=this.getColumnIndex(r,e.name),n=this.tables[t.name].table,l=this.tables[s].table,a=i*this.columnHeight+this.tables[t.name].yPos+36,o=parseInt(n.getAttribute("transform").split(",")[0].replace("translate(","")),u=parseInt(l.getAttribute("transform").split(",")[0].replace("translate(","")),d=h*this.columnHeight+this.tables[s].yPos+36,b,c;o==u?(o+=4,u+=4,b=o-8,c=u-8):o<=u?(o+=this.tableWidth,o-=4,u+=4,b=o+8,c=u-8):(u+=this.tableWidth,o+=4,u-=4,b=o-8,c=u+8);let g=document.createElementNS("http://www.w3.org/2000/svg","circle"),p=document.createElementNS("http://www.w3.org/2000/svg","circle");g.setAttribute("cx",o),g.setAttribute("cy",a),g.setAttribute("r",3),g.setAttribute("fill","#2A56BD"),p.setAttribute("cx",u),p.setAttribute("cy",d),p.setAttribute("r",3),p.setAttribute("fill","#CC0088");let w=document.createElementNS("http://www.w3.org/2000/svg","path"),A=`M ${o} ${a} L ${b} ${a} L ${c} ${d} L ${u} ${d}`;w.setAttribute("d",A),w.setAttribute("stroke","#2A56BD"),w.setAttribute("stroke-width",this.relationStrokeWidth),w.setAttribute("fill","transparent"),this.svg.appendChild(w),this.svg.appendChild(g),this.svg.appendChild(p)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}downloadSVG(){let t=this.getFileName()+".svg";this.exportToSVG(this.svg,t)}downloadPNG(){let t=this.getFileName()+".png";this.exportToPNG(this.svg,t)}getFileName(){let t=document.querySelector(".diagram-list.tabs").querySelector('.diagram-tab.active input[type="text"]'),e=document.querySelector('meta[name="application-id"]').getAttribute("content"),i=document.querySelector('meta[name="database-name"]').getAttribute("content"),s="",r="";return r=""!=i?i:e,s=null!=t?r+" - "+t.value:r}generateSVGString(t){let e=t.clientWidth,i=t.clientHeight+2,s=new XMLSerializer().serializeToString(t);return`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${e}" height="${i}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                        .move-up-icon, .move-down-icon, .edit-icon, .delete-icon {
                            display: none;
                            visibility: hidden;
                            opacity: 0;
                            pointer-events: none;
                        }
                    ]]>
                </style>
            </defs>
            ${s}
        </svg>`}exportToSVG(t,e="exported-image.svg"){let i=this.generateSVGString(t),s=new Blob([i],{type:"image/svg+xml"}),r=URL.createObjectURL(s),h=document.createElement("a");h.href=r,h.download=e,h.click(),URL.revokeObjectURL(r)}exportToPNG(t,e="exported-image.png"){let i=t.clientWidth,s=t.clientHeight,r=document.createElement("canvas");r.width=i,r.height=s;let h=r.getContext("2d"),n=this.generateSVGString(t),l="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),a=new Image;a.onload=function(){h.drawImage(a,0,0);let t=r.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},a.onerror=function(t){console.error("Error loading the SVG image:",t)},a.src=l}getSVGElement(){return this.svg}}