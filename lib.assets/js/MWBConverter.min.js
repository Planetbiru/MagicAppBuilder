class MWBConverter{constructor(){this.zip=null,this.xmlDoc=null,this.sqliteBinary=null,this.sqliteDb=null,this.idMap={}}async loadFile(e,t={mwb:!1}){this.idMap={},this.sqliteDb=null;let n="";if(t.mwb)try{this.zip=await JSZip.loadAsync(e);let l=this.zip.file("@db/data.db");l&&(this.sqliteBinary=await l.async("uint8array"));let a=this.zip.file("document.mwb.xml");if(a)n=await a.async("string");else throw Error("Valid ZIP file, but 'document.mwb.xml' not found inside.")}catch(i){try{if(!(n=await this.readFileAsText(e)).trim().startsWith("<"))throw Error("Unrecognized file format. Please upload a valid .mwb or .xml file.")}catch(r){throw Error("Failed to read file: "+r.message)}}else if(!(n=await this.readFileAsText(e)).trim().startsWith("<"))throw Error("Unrecognized file format. Please upload a valid .mwb or .xml file.");let u=new DOMParser;this.xmlDoc=u.parseFromString(n,"text/xml");let s=this.xmlDoc.querySelector("parsererror");if(s)throw Error("XML Parsing Error: "+s.textContent);this.buildIdMap()}async loadBinary(e,t={mwb:!1}){this.idMap={},this.sqliteDb=null;let n="",l;if(e instanceof Uint8Array)l=e;else if(e instanceof ArrayBuffer)l=new Uint8Array(e);else throw Error("Input must be Uint8Array or ArrayBuffer.");if(t.mwb)try{this.zip=await JSZip.loadAsync(l);let a=this.zip.file("@db/data.db");a&&(this.sqliteBinary=await a.async("uint8array"));let i=this.zip.file("document.mwb.xml");if(i)n=await i.async("string");else throw Error("Valid ZIP file, but 'document.mwb.xml' not found inside.")}catch(r){try{let u=new TextDecoder("utf-8");if(!(n=u.decode(l)).trim().startsWith("<"))throw Error("Unrecognized file format. Please upload valid MWB or XML data.")}catch(s){throw Error("Failed to read binary data: "+s.message)}}else{let y=new TextDecoder("utf-8");if(!(n=y.decode(l)).trim().startsWith("<"))throw Error("Unrecognized file format. Please upload valid XML data.")}let o=new DOMParser;this.xmlDoc=o.parseFromString(n,"text/xml");let c=this.xmlDoc.querySelector("parsererror");if(c)throw Error("XML Parsing Error: "+c.textContent);this.buildIdMap()}async loadSqlite(){try{"undefined"==typeof initSqlJs&&await this.loadScript("schema-editor/wasm/sql-wasm.js"),MWBConverter.sqlEnginePromise||(MWBConverter.sqlEnginePromise=initSqlJs({locateFile:e=>"../lib.assets/wasm/sql-wasm.wasm"}));let e=await MWBConverter.sqlEnginePromise;this.sqliteDb=new e.Database(this.sqliteBinary)}catch(t){console.error("Failed to load SQLite database:",t),MWBConverter.sqlEnginePromise=null}}loadScript(e){return new Promise((t,n)=>{let l=document.createElement("script");l.src=e,l.onload=t,l.onerror=n,document.head.appendChild(l)})}readFileAsText(e){return new Promise((t,n)=>{let l=new FileReader;l.onload=e=>t(e.target.result),l.onerror=e=>n(e.target.error),l.readAsText(e)})}buildIdMap(){let e=this.xmlDoc.querySelectorAll('value[struct-name="db.mysql.Table"]');e.forEach(e=>{let t=e.getAttribute("id"),n=this.getValue(e,"name");this.idMap[t]={type:"table",name:n};let l=this.getNode(e,"columns");if(l)for(let a of l.children){let i=a.getAttribute("id"),r=this.getValue(a,"name");this.idMap[i]={type:"column",name:r,table:n}}})}getEntities(){let e=[];if(!this.xmlDoc)return console.error("XML Document not loaded. Make sure loadFile/loadBinary is called."),[];let t=this.xmlDoc.querySelectorAll('value[struct-name="db.mysql.Table"]'),n=Date.now();return t.forEach((t,l)=>{let a=this.getValue(t,"name");if(!a)return;let i=this.getValue(t,"comment")||"",r=[],u=this.getNode(t,"columns"),s=this.getNode(t,"primaryKey"),y=s?s.textContent:null,o=[];if(y){let c=this.getNode(t,"indices");if(c){for(let p of c.children)if(p.getAttribute("id")===y){let m=this.getNode(p,"columns");if(m)for(let d of m.children){let v=this.getNode(d,"referencedColumn");v&&o.push(v.textContent)}break}}}if(u)for(let g of u.children){let k=g.getAttribute("id"),h=this.getValue(g,"name"),b=this.getNode(g,"simpleType"),f=b?b.textContent:"",x=f.split("."),E=x[x.length-1],$=E?E.toUpperCase():"VARCHAR";$=this.fixType($);let j=this.getValue(g,"length"),N="";j&&parseInt(j)>-1&&(N=j);let w=1==this.getValue(g,"isNotNull"),C=1==this.getValue(g,"autoIncrement"),D=this.getValue(g,"defaultValue"),I=1==this.getValue(g,"defaultValueIsNull");I?D="NULL":(null===D||""===D)&&(D=null);let q=this.getValue(g,"comment");r.push({name:h,type:$,length:N,nullable:!w,default:D,primaryKey:o.includes(k),autoIncrement:C,values:null,description:q||null})}let T=[],S=this.getNode(t,"foreignKeys");if(S)for(let M of S.children){let P=this.getValue(M,"deleteRule"),A=this.getValue(M,"updateRule"),U=this.getNode(M,"referencedTable"),O=U?U.textContent:null,L=O&&this.idMap[O]?this.idMap[O].name:null,_=[],R=this.getNode(M,"columns");if(R)for(let F of R.children){let V=F.textContent;this.idMap[V]&&_.push(this.idMap[V].name)}let K=this.getValue(M,"name");!K&&(_.length>0?K=`fk_${a}_${_[0]}`:L&&(K=`fk_${a}_${L}`));let B=[],G=this.getNode(M,"referencedColumns");if(G)for(let z of G.children){let Y=z.textContent;this.idMap[Y]&&B.push(this.idMap[Y].name)}_.length>0&&T.push({name:K,columnName:_.join(","),referencedTable:L,referencedColumn:B.join(","),onUpdate:A,onDelete:P})}""!=a&&r.length>0&&e.push({index:l,name:a,columns:r,data:[],description:i,creationDate:n,modificationDate:n,creator:"{{userName}}",modifier:"{{userName}}",foreignKeys:T})}),e}async getEntityData(){await this.loadSqlite();let e={};if(!this.xmlDoc)return e;let t=this.xmlDoc.querySelectorAll('value[struct-name="db.mysql.Table"]');return t.forEach(t=>{let n=this.getValue(t,"name");if(!n)return;e[n]=[];let l=!1;if(this.sqliteDb){let a=this.getNode(t,"columns"),i=t.getAttribute("id"),r=i.replace(/[{}]/g,""),u=null,s=e=>{try{let t=this.sqliteDb.exec(`SELECT name FROM sqlite_master WHERE type='table' AND name='${e}'`);return t.length>0}catch(n){return!1}};if(s(i)?u=i:s(r)?u=r:s(n)&&(u=n),u)try{let y=this.sqliteDb.exec(`SELECT * FROM "${u}"`);if(y.length>0&&y[0].values.length>0){let o=y[0].columns,c=y[0].values,p={};o.forEach((e,t)=>{let n=e.replace(/[{}]/g,"");p[n]=t});let m={};if(a)for(let d of a.children){let v=d.getAttribute("id"),g=this.getValue(d,"name"),k=v.replace(/[{}]/g,"");p.hasOwnProperty(k)&&(m[g]=p[k])}c.forEach(t=>{let l={};for(let[a,i]of Object.entries(m))l[a]=t[i];e[n].push(l)}),l=!0}}catch(h){console.error("Error reading SQLite data for entity "+n,h)}}if(!l){let b=this.getNode(t,"inserts");if(b)for(let f of b.children){let x=[],E=this.getNode(f,"columns");if(E)for(let $ of E.children)x.push($.textContent);let j=this.getNode(f,"rows");if(j&&x.length>0)for(let N of j.children){let w={},C=this.getNode(N,"values");if(C){let D=0;for(let I of C.children){if(D<x.length){let q=I.textContent;"NULL"===q&&(q=null),w[x[D]]=q}D++}}e[n].push(w)}}}}),e}getSql(){let e="-- Generated by MagicAppBuilder\n";e+="-- Date: "+new Date().toISOString().slice(0,19).replace("T"," ")+"\n\n",e+="SET FOREIGN_KEY_CHECKS = 0;\n\n";let t=this.xmlDoc.querySelectorAll('value[struct-name="db.mysql.Table"]');return t.forEach(t=>{let n=this.getValue(t,"name");if(!n)return;let l=this.getValue(t,"tableEngine")||"InnoDB",a=this.getValue(t,"defaultCharacterSetName")||"utf8mb4",i=this.getValue(t,"defaultCollationName");e+=`CREATE TABLE IF NOT EXISTS \`${n}\` (
`;let r=[],u=this.getNode(t,"columns");if(u)for(let s of u.children)r.push(this.parseColumn(s));let y=this.getNode(t,"primaryKey"),o=y?y.textContent:null,c=this.getNode(t,"indices");if(c)for(let p of c.children){let m=p.getAttribute("id"),d=m===o,v=[],g=this.getNode(p,"columns");if(g)for(let k of g.children){let h=this.getNode(k,"referencedColumn"),b=h?h.textContent:null;if(this.idMap[b]){let f=this.idMap[b].name,x=this.getValue(k,"columnLength");x&&parseInt(x)>0&&(f+=`(${x})`),v.push(`\`${f}\``)}}if(0!==v.length){if(d)r.push(`  PRIMARY KEY (${v.join(", ")})`);else{let E=this.getValue(p,"name"),$=1==this.getValue(p,"unique"),j=$?"UNIQUE INDEX":"INDEX";r.push(`  ${j} \`${E}\` (${v.join(", ")})`)}}}let N=this.getNode(t,"foreignKeys");if(N)for(let w of N.children){let C=this.getNode(w,"referencedTable"),D=C?C.textContent:null;if(!this.idMap[D])continue;let I=this.idMap[D].name,q=[],T=[],S=this.getNode(w,"columns");if(S)for(let M of S.children){let P=M.textContent;this.idMap[P]&&(q.push(`\`${this.idMap[P].name}\``),T.push(this.idMap[P].name))}let A=this.getValue(w,"name")||(T.length>0?`fk_${n}_${T[0]}`:`fk_${n}_${I}`),U=[],O=this.getNode(w,"referencedColumns");if(O)for(let L of O.children){let _=L.textContent;this.idMap[_]&&U.push(`\`${this.idMap[_].name}\``)}if(q.length>0&&U.length>0){let R=this.getValue(w,"deleteRule"),F=this.getValue(w,"updateRule"),V=`  CONSTRAINT \`${A}\` FOREIGN KEY (${q.join(", ")})`;V+=` REFERENCES \`${I}\` (${U.join(", ")})`,R&&"NO ACTION"!==R&&(V+=` ON DELETE ${R}`),F&&"NO ACTION"!==F&&(V+=` ON UPDATE ${F}`),r.push(V)}}e+=r.join(",\n"),e+=`
) ENGINE=${l} DEFAULT CHARSET=${a}`,i&&(e+=` COLLATE=${i}`),e+=";\n\n"}),e}async getSqlInsert(){await this.loadSqlite();let e="-- Generated by MagicAppBuilder\n";e+="-- Date: "+new Date().toISOString().slice(0,19).replace("T"," ")+"\n\n",e+="SET FOREIGN_KEY_CHECKS = 0;\n\n";let t=this.xmlDoc.querySelectorAll('value[struct-name="db.mysql.Table"]');return t.forEach(t=>{let n=this.getValue(t,"name");if(n&&this.sqliteDb){let l=t.getAttribute("id");try{let a=this.sqliteDb.exec(`SELECT name FROM sqlite_master WHERE type='table' AND name='${l}'`);if(a.length>0){let i=this.sqliteDb.exec(`SELECT * FROM "${l}"`);if(i.length>0&&i[0].values.length>0){let r=i[0].columns,u=i[0].values,s={};r.forEach((e,t)=>{let n=e.replace(/[{}]/g,"");s[n]=t});let y=[],o=[],c=this.getNode(t,"columns");if(c)for(let p of c.children){let m=p.getAttribute("id"),d=this.getValue(p,"name"),v=m.replace(/[{}]/g,"");s.hasOwnProperty(v)&&(y.push(`\`${d}\``),o.push(s[v]))}if(y.length>0){let g=y.join(", ");u.forEach(t=>{let l=o.map(e=>{let n=t[e];return null===n?"NULL":"number"==typeof n?n:`'${String(n).replace(/'/g,"\\'")}'`});e+=`INSERT INTO \`${n}\` (${g}) VALUES (${l.join(", ")});
`}),e+="\n"}}}}catch(k){console.error(`Error extracting data for table ${n}:`,k)}}}),e+="SET FOREIGN_KEY_CHECKS = 1;\n\n"}getDiagrams(){let e=[];if(!this.xmlDoc)return console.error("XML Document not loaded. Make sure loadFile/loadBinary is called."),[];let t=this.xmlDoc.querySelectorAll('value[struct-name="workbench.physical.Diagram"]');return t.forEach((t,n)=>{let l=this.getValue(t,"name"),a=[],i=this.getNode(t,"figures");if(i){for(let r of i.children)if("workbench.physical.TableFigure"===r.getAttribute("struct-name")){let u=this.getNode(r,"table");if(u){let s=u.textContent;this.idMap[s]&&a.push(this.idMap[s].name)}}}let y=t.getAttribute("id").replace(/[{}]/g,"");y="diagram_"+(y=y.split("#").join("")).split("-").join(""),e.push({id:y,name:l,entities:a,sortOrder:n})}),e}parseColumn(e){let t=this.getValue(e,"name"),n=this.getNode(e,"simpleType"),l=n?n.textContent:"",a=l.split("."),i=a[a.length-1],r=i.toUpperCase(),u=parseInt(this.getValue(e,"length")),s=parseInt(this.getValue(e,"precision")),y=parseInt(this.getValue(e,"scale"));["VARCHAR","CHAR","BINARY","VARBINARY","BIT"].includes(r)?u>-1&&(r+=`(${u})`):["DECIMAL","FLOAT","DOUBLE","REAL"].includes(r)?s>-1&&y>-1?r+=`(${s}, ${y})`:s>-1&&(r+=`(${s})`):["TINYINT","SMALLINT","MEDIUMINT","INT","BIGINT"].includes(r)?u>-1&&(r+=`(${u})`):"TIMESTAMP_F"===r?r="TIMESTAMP":"DATETIME_F"===r?r="DATETIME":"TIME_F"===r&&(r="TIME");let o=`  \`${t}\` ${r}`,c=this.getNode(e,"flags");if(c)for(let p of c.children)"UNSIGNED"===p.textContent&&(o+=" UNSIGNED"),"ZEROFILL"===p.textContent&&(o+=" ZEROFILL");let m=this.getValue(e,"isNotNull");o+=1==m?" NOT NULL":" NULL",1==this.getValue(e,"autoIncrement")&&(o+=" AUTO_INCREMENT");let d=this.getValue(e,"defaultValue"),v=this.getValue(e,"defaultValueIsNull");1==v?o+=" DEFAULT NULL":""!==d&&null!==d&&(o+=` DEFAULT ${d}`);let g=this.getValue(e,"comment");return g&&(o+=` COMMENT '${g.replace(/'/g,"\\'")}'`),o}fixType(e){switch(e){case"TIMESTAMP_F":e="TIMESTAMP";break;case"DATETIME_F":e="DATETIME";break;case"TIME_F":e="TIME"}return e}getValue(e,t){let n=this.getNode(e,t);return n?n.textContent:null}getNode(e,t){if(!e)return null;for(let n=0;n<e.children.length;n++)if(e.children[n].getAttribute("key")===t)return e.children[n];return null}async convertJsonToMwbOld(e){let t=new JSZip,n=e.entities,l=this._generateUUID(),a=this._generateUUID(),i=this._generateUUID(),r=this._generateUUID(),u=this._generateUUID(),s={},y=[];n.forEach(e=>{let t=e.columns.map(e=>({...e,id:this._generateUUID()})),n={};t.forEach(e=>{e.name&&(n[e.name.trim()]=e)});let l=e.foreignKeys||{};s[e.name.trim()]={id:this._generateUUID(),figureId:null,name:e.name,columns:t,colMap:n,data:e.data,foreignKeys:l}});let o='<?xml version="1.0"?>\n';for(let c in o+='<data grt_format="2.0" document_type="MySQL Workbench Model" version="1.4.4">\n',o+=`  <value type="object" struct-name="workbench.Document" id="${l}" struct-checksum="0x0">
`,o+=`    <value type="object" struct-name="workbench.logical.Model" id="${a}" key="logicalModel">
`,o+=`      <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="workbench.logical.Diagram" key="diagrams"/>
`,o+='      <value type="dict" key="customData"/>\n',o+=`      <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Marker" key="markers"/>
`,o+='      <value type="dict" key="options"/>\n',o+='      <value type="string" key="name"></value>\n',o+=`      <link type="object" struct-name="GrtObject" key="owner">${l}</link>
`,o+="    </value>\n",o+=`    <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="workbench.OverviewPanel" key="overviewPanels"/>
`,o+=`    <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="workbench.physical.Model" key="physicalModels">
`,o+=`      <value type="object" struct-name="workbench.physical.Model" id="${i}">
`,o+=`        <value type="object" struct-name="db.mysql.Catalog" id="${r}" key="catalog">
`,o+=`          <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.LogFileGroup" key="logFileGroups"/>
`,o+=`          <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Schema" key="schemata">
`,o+=`            <value type="object" struct-name="db.mysql.Schema" id="${u}">
`,o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.RoutineGroup" key="routineGroups"/>
`,o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Routine" key="routines"/>
`,o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Sequence" key="sequences"/>
`,o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.StructuredDatatype" key="structuredTypes"/>
`,o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Synonym" key="synonyms"/>
`,o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Table" key="tables">
`,s){let p=s[c];o+=`                <value type="object" struct-name="db.mysql.Table" id="${p.id}">
`,o+='                  <value type="string" key="avgRowLength"></value>\n',o+='                  <value type="int" key="checksum">0</value>\n',o+=`                  <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Column" key="columns">
`,p.columns.forEach(e=>{o+=`                    <value type="object" struct-name="db.mysql.Column" id="${e.id}">
`,o+=`                      <value type="int" key="autoIncrement">${e.autoIncrement?1:0}</value>
`,o+='                      <value type="string" key="characterSetName"></value>\n',o+=`                      <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.CheckConstraint" key="checks"/>
`,o+='                      <value type="string" key="collationName"></value>\n',o+='                      <value type="string" key="comment"></value>\n',o+='                      <value type="string" key="datatypeExplicitParams"></value>\n';let t="com.mysql.rdbms.mysql.datatype.varchar",n=(e.type||"").toLowerCase();n.includes("tinyint")?t="com.mysql.rdbms.mysql.datatype.tinyint":n.includes("bigint")?t="com.mysql.rdbms.mysql.datatype.bigint":n.includes("int")?t="com.mysql.rdbms.mysql.datatype.int":n.includes("longtext")?t="com.mysql.rdbms.mysql.datatype.longtext":n.includes("mediumtext")?t="com.mysql.rdbms.mysql.datatype.mediumtext":n.includes("text")?t="com.mysql.rdbms.mysql.datatype.text":n.includes("date")?t="com.mysql.rdbms.mysql.datatype.date":n.includes("datetime")?t="com.mysql.rdbms.mysql.datatype.datetime":n.includes("timestamp")?t="com.mysql.rdbms.mysql.datatype.timestamp":n.includes("float")?t="com.mysql.rdbms.mysql.datatype.float":n.includes("double")?t="com.mysql.rdbms.mysql.datatype.double":n.includes("decimal")?t="com.mysql.rdbms.mysql.datatype.decimal":n.includes("year")&&(t="com.mysql.rdbms.mysql.datatype.year");let l="",a=0;null===e.default||"NULL"===e.default?(l="NULL",a=1):void 0!==e.default&&null!==e.default&&(l=e.default),o+=`                      <value type="string" key="defaultValue">${l}</value>
`,o+=`                      <value type="int" key="defaultValueIsNull">${a}</value>
`,o+='                      <value type="string" key="expression"></value>\n',o+=`                      <value _ptr_="${this._generatePtr()}" type="list" content-type="string" key="flags"/>
`,o+='                      <value type="int" key="generated">0</value>\n',o+='                      <value type="string" key="generatedStorage"></value>\n',o+=`                      <value type="int" key="isNotNull">${!1===e.nullable?1:0}</value>
`;let i=-1;e.length&&parseInt(e.length)>0&&(i=parseInt(e.length)),o+=`                      <value type="int" key="length">${i}</value>
`,o+=`                      <value type="string" key="name">${e.name}</value>
`,o+=`                      <value type="string" key="oldName">${e.name}</value>
`,o+=`                      <link type="object" struct-name="GrtObject" key="owner">${p.id}</link>
`,o+='                      <value type="int" key="precision">-1</value>\n',o+='                      <value type="int" key="scale">-1</value>\n',o+=`                      <link type="object" struct-name="db.SimpleDatatype" key="simpleType">${t}</link>
`,o+="                    </value>\n"}),o+="                  </value>\n",o+='                  <value type="string" key="comment"></value>\n',o+='                  <value type="int" key="commentedOut">0</value>\n',o+='                  <value type="string" key="connectionString"></value>\n',o+='                  <value type="string" key="createDate">'+new Date().toISOString()+"</value>\n",o+='                  <value type="dict" key="customData"/>\n',o+='                  <value type="string" key="defaultCharacterSetName">utf8mb4</value>\n',o+='                  <value type="string" key="defaultCollationName"></value>\n',o+='                  <value type="int" key="delayKeyWrite">0</value>\n',o+=`                  <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.ForeignKey" key="foreignKeys">
`;let m=[],d=(e,t)=>{let n=t;if("object"==typeof t&&null!==t&&(n=t.name||t.fieldName||t.column||t.field),!n)return null;if(e[n=String(n).trim()])return e[n].id;let l=String(n).toLowerCase();for(let a in e)if(a.toLowerCase()===l)return e[a].id;return null};if(p.foreignKeys){let v=[];Array.isArray(p.foreignKeys)?v=p.foreignKeys.map(e=>({key:null,fk:e})):p.foreignKeys&&"object"==typeof p.foreignKeys&&(v=Object.entries(p.foreignKeys).map(([e,t])=>({key:e.trim(),fk:t}))),v.forEach(({key:e,fk:t})=>{let n=s[t.referencedTable?String(t.referencedTable).trim():""];if(!n&&t.referencedTable){let l=String(t.referencedTable).trim().toLowerCase();for(let a in s)if(a.toLowerCase()===l){n=s[a];break}}if(!n)return;let i=t.columns||t.column||t.fields||t.field||t.columnName;if(!i){if(e&&p.colMap[e])i=[e];else{let r=`${n.name}_id`;p.colMap[r]&&(i=[r])}}i&&!Array.isArray(i)&&(i="string"==typeof i&&i.includes(",")?i.split(",").map(e=>e.trim()):[i]),i||(i=[]);let u=t.referencedColumns||t.referencedColumn||t.referencedFields||t.referencedField||[];if(Array.isArray(u)||(u="string"==typeof u&&u.includes(",")?u.split(",").map(e=>e.trim()):[u]),0===u.length||1===u.length&&!u[0]){let o=n.columns.filter(e=>e.primaryKey||e.pk);u=o.map(e=>e.name)}m.push({def:t,refTable:n,id:this._generateUUID(),indexId:this._generateUUID(),name:t.name||(e&&!p.colMap[e]?e:`fk_${p.name}_${n.name}`),indexName:`fk_${p.name}_${n.name}_idx`,cols:i,refCols:u}),y.push({id:m[m.length-1].id,name:m[m.length-1].name,ownerName:p.name,referencedName:n.name})})}m.forEach(e=>{let t=e.refTable;o+=`                    <value type="object" struct-name="db.mysql.ForeignKey" id="${e.id}">
`,o+=`                      <link type="object" struct-name="db.mysql.Table" key="referencedTable">${t.id}</link>
`,o+=`                      <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.Column" key="columns">
`,e.cols.forEach(e=>{let t=d(p.colMap,e);t&&(o+=`                        <link type="object">${t}</link>
`)}),o+=`                      </value>
`,o+='                      <value type="dict" key="customData"/>\n',o+='                      <value type="int" key="deferability">0</value>\n',o+=`                      <value type="string" key="deleteRule">${e.def.onDelete||"NO ACTION"}</value>
`,o+=`                      <link type="object" struct-name="db.Index" key="index">${e.indexId}</link>
`,o+='                      <value type="int" key="mandatory">1</value>\n',o+='                      <value type="int" key="many">1</value>\n',o+='                      <value type="int" key="modelOnly">0</value>\n',o+=`                      <link type="object" struct-name="db.Table" key="owner">${p.id}</link>
`,o+=`                      <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.Column" key="referencedColumns">
`,e.refCols.forEach(e=>{let n=d(t.colMap,e);n&&(o+=`                        <link type="object">${n}</link>
`)}),o+=`                      </value>
`,o+='                      <value type="int" key="referencedMandatory">1</value>\n',o+=`                      <value type="string" key="updateRule">${e.def.onUpdate||"NO ACTION"}</value>
`,o+='                      <value type="string" key="comment"></value>\n',o+=`                      <value type="string" key="name">${e.name}</value>
`,o+=`                      <value type="string" key="oldName"></value>
`,o+=`                    </value>
`}),o+=`                  </value>
`,o+=`                  <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Index" key="indices">
`;let g=p.columns.filter(e=>e.primaryKey),k=null;g.length>0&&(o+=`                    <value type="object" struct-name="db.mysql.Index" id="${k=this._generateUUID()}">
`,o+='                      <value type="string" key="algorithm"></value>\n',o+=`                      <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.IndexColumn" key="columns">
`,g.forEach(e=>{o+=`                        <value type="object" struct-name="db.mysql.IndexColumn" id="${this._generateUUID()}">
`,o+='                          <value type="int" key="columnLength">0</value>\n',o+='                          <value type="string" key="comment"></value>\n',o+='                          <value type="int" key="descend">0</value>\n',o+='                          <value type="string" key="expression"></value>\n',o+='                          <value type="string" key="name"></value>\n',o+=`                          <link type="object" struct-name="GrtObject" key="owner">${k}</link>
`,o+=`                          <link type="object" struct-name="db.Column" key="referencedColumn">${e.id}</link>
`,o+="                        </value>\n"}),o+="                      </value>\n",o+='                      <value type="string" key="comment"></value>\n',o+='                      <value type="int" key="commentedOut">0</value>\n',o+='                      <value type="string" key="createDate"></value>\n',o+='                      <value type="dict" key="customData"/>\n',o+='                      <value type="int" key="deferability">0</value>\n',o+='                      <value type="string" key="indexKind"></value>\n',o+='                      <value type="string" key="indexType">PRIMARY</value>\n',o+='                      <value type="int" key="isPrimary">1</value>\n',o+='                      <value type="int" key="keyBlockSize">0</value>\n',o+='                      <value type="string" key="lastChangeDate"></value>\n',o+='                      <value type="string" key="lockOption"></value>\n',o+='                      <value type="int" key="modelOnly">0</value>\n',o+='                      <value type="string" key="name">PRIMARY</value>\n',o+='                      <value type="string" key="oldName">PRIMARY</value>\n',o+=`                      <link type="object" struct-name="GrtNamedObject" key="owner">${p.id}</link>
`,o+='                      <value type="string" key="temp_sql"></value>\n',o+='                      <value type="int" key="unique">0</value>\n',o+='                      <value type="int" key="visible">1</value>\n',o+='                      <value type="string" key="withParser"></value>\n',o+="                    </value>\n"),m.forEach(e=>{o+=`                    <value type="object" struct-name="db.mysql.Index" id="${e.indexId}">
`,o+='                      <value type="string" key="algorithm"></value>\n',o+=`                      <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.IndexColumn" key="columns">
`,e.cols.forEach(t=>{let n=d(p.colMap,t);if(n){let l=this._generateUUID();o+=`                        <value type="object" struct-name="db.mysql.IndexColumn" id="${l}">
`,o+='                          <value type="int" key="columnLength">0</value>\n',o+='                          <value type="string" key="comment"></value>\n',o+='                          <value type="int" key="descend">0</value>\n',o+='                          <value type="string" key="expression"></value>\n',o+='                          <value type="string" key="name"></value>\n',o+=`                          <link type="object" struct-name="GrtObject" key="owner">${e.indexId}</link>
`,o+=`                          <link type="object" struct-name="db.Column" key="referencedColumn">${n}</link>
`,o+="                        </value>\n"}}),o+="                      </value>\n",o+='                      <value type="string" key="indexKind"></value>\n',o+='                      <value type="int" key="keyBlockSize">0</value>\n',o+='                      <value type="string" key="lockOption"></value>\n',o+='                      <value type="int" key="visible">1</value>\n',o+='                      <value type="string" key="withParser"></value>\n',o+='                      <value type="string" key="comment"></value>\n',o+='                      <value type="int" key="deferability">0</value>\n',o+='                      <value type="string" key="indexType">INDEX</value>\n',o+='                      <value type="int" key="isPrimary">0</value>\n',o+=`                      <value type="string" key="name">${e.indexName}</value>
`,o+='                      <value type="int" key="unique">0</value>\n',o+='                      <value type="int" key="commentedOut">0</value>\n',o+='                      <value type="string" key="createDate"></value>\n',o+='                      <value type="dict" key="customData"/>\n',o+='                      <value type="string" key="lastChangeDate"></value>\n',o+='                      <value type="int" key="modelOnly">0</value>\n',o+=`                      <link type="object" struct-name="GrtNamedObject" key="owner">${p.id}</link>
`,o+='                      <value type="string" key="temp_sql"></value>\n',o+=`                      <value type="string" key="oldName"></value>
`,o+="                    </value>\n"}),o+="                  </value>\n",o+='                  <value type="string" key="keyBlockSize"></value>\n',o+='                  <value type="string" key="maxRows"></value>\n',o+='                  <value type="string" key="mergeInsert"></value>\n',o+='                  <value type="string" key="mergeUnion"></value>\n',o+='                  <value type="string" key="minRows"></value>\n',o+='                  <value type="string" key="nextAutoInc"></value>\n',o+='                  <value type="string" key="packKeys"></value>\n',o+='                  <value type="int" key="partitionCount">0</value>\n',o+=`                  <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.PartitionDefinition" key="partitionDefinitions"/>
`,o+='                  <value type="string" key="partitionExpression"></value>\n',o+='                  <value type="int" key="partitionKeyAlgorithm">0</value>\n',o+='                  <value type="string" key="partitionType"></value>\n',o+='                  <value type="string" key="password"></value>\n',k&&(o+=`                  <link type="object" struct-name="db.mysql.Index" key="primaryKey">${k}</link>
`),o+='                  <value type="string" key="raidChunkSize"></value>\n',o+='                  <value type="string" key="raidChunks"></value>\n',o+='                  <value type="string" key="raidType"></value>\n',o+='                  <value type="string" key="rowFormat"></value>\n',o+='                  <value type="string" key="statsAutoRecalc"></value>\n',o+='                  <value type="string" key="statsPersistent"></value>\n',o+='                  <value type="int" key="statsSamplePages">0</value>\n',o+='                  <value type="int" key="subpartitionCount">0</value>\n',o+='                  <value type="string" key="subpartitionExpression"></value>\n',o+='                  <value type="int" key="subpartitionKeyAlgorithm">0</value>\n',o+='                  <value type="string" key="subpartitionType"></value>\n',o+='                  <value type="string" key="tableDataDir"></value>\n',o+='                  <value type="string" key="tableEngine">InnoDB</value>\n',o+='                  <value type="string" key="tableIndexDir"></value>\n',o+='                  <value type="string" key="tableSpace"></value>\n',o+=`                  <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Trigger" key="triggers"/>
`,o+='                  <value type="int" key="isStub">0</value>\n',o+='                  <value type="int" key="isSystem">0</value>\n',o+='                  <value type="int" key="isTemporary">0</value>\n',o+='                  <value type="string" key="keyBlockSize"></value>\n',o+='                  <value type="string" key="lastChangeDate">'+new Date().toISOString()+"</value>\n",o+='                  <value type="string" key="maxRows"></value>\n',o+='                  <value type="string" key="mergeInsert"></value>\n',o+='                  <value type="string" key="mergeUnion"></value>\n',o+='                  <value type="string" key="minRows"></value>\n',o+='                  <value type="int" key="modelOnly">0</value>\n',o+=`                  <value type="string" key="name">${p.name}</value>
`,o+='                  <value type="string" key="nextAutoInc"></value>\n',o+=`                  <value type="string" key="oldName">${p.name}</value>
`,o+=`                  <link type="object" struct-name="GrtNamedObject" key="owner">${u}</link>
`,o+='                  <value type="string" key="packKeys"></value>\n',o+='                  <value type="int" key="partitionCount">0</value>\n',o+=`                  <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.PartitionDefinition" key="partitionDefinitions"/>
`,o+='                  <value type="string" key="partitionExpression"></value>\n',o+='                  <value type="int" key="partitionKeyAlgorithm">0</value>\n',o+='                  <value type="string" key="partitionType"></value>\n',o+='                  <value type="string" key="password"></value>\n',k&&(o+=`                  <link type="object" struct-name="db.mysql.Index" key="primaryKey">${k}</link>
`),o+='                  <value type="string" key="raidChunkSize"></value>\n',o+='                  <value type="string" key="raidChunks"></value>\n',o+='                  <value type="string" key="raidType"></value>\n',o+='                  <value type="string" key="rowFormat"></value>\n',o+='                  <value type="string" key="statsAutoRecalc"></value>\n',o+='                  <value type="string" key="statsPersistent"></value>\n',o+='                  <value type="int" key="statsSamplePages">0</value>\n',o+='                  <value type="int" key="subpartitionCount">0</value>\n',o+='                  <value type="string" key="subpartitionExpression"></value>\n',o+='                  <value type="int" key="subpartitionKeyAlgorithm">0</value>\n',o+='                  <value type="string" key="subpartitionType"></value>\n',o+='                  <value type="string" key="tableDataDir"></value>\n',o+='                  <value type="string" key="tableEngine">InnoDB</value>\n',o+='                  <value type="string" key="tableIndexDir"></value>\n',o+='                  <value type="string" key="tableSpace"></value>\n',o+='                  <value type="string" key="temp_sql"></value>\n',o+='                  <value type="string" key="temporaryScope"></value>\n',o+=`                  <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Trigger" key="triggers"/>
`,o+="                </value>\n"}o+="              </value>\n",o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.View" key="views"/>
`,o+='              <value type="string" key="defaultCharacterSetName">utf8</value>\n',o+='              <value type="string" key="defaultCollationName">utf8_general_ci</value>\n',o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.Event" key="events"/>
`,o+='              <value type="dict" key="customData"/>\n',o+='              <value type="int" key="modelOnly">0</value>\n',o+='              <value type="string" key="name">mydb</value>\n',o+=`              <link type="object" struct-name="GrtNamedObject" key="owner">${r}</link>
`,o+='              <value type="string" key="oldName">mydb</value>\n',o+="            </value>\n",o+="          </value>\n",o+=`          <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.ServerLink" key="serverLinks"/>
`,o+=`          <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mysql.Tablespace" key="tablespaces"/>
`,o+=`          <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.CharacterSet" key="characterSets"/>
`,o+=`          <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.UserDatatype" key="userDatatypes"/>
`,o+=`          <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.User" key="users"/>
`,o+='          <value type="string" key="name">default</value>\n',o+=`          <link type="object" struct-name="GrtObject" key="owner">${i}</link>
`,o+="        </value>\n",o+='        <value type="string" key="connectionNotation">fromcolumn</value>\n',o+=`        <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.mgmt.Connection" key="connections"/>
`,o+=`        <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="workbench.physical.Diagram" key="diagrams">
`;let h=null;for(let b of e.diagrams){let f=this._generateUUID();h||(h=f);let x=this._generateUUID();o+=`          <value type="object" struct-name="workbench.physical.Diagram" id="${f}">
`,o+='            <value type="int" key="closed">0</value>\n',o+=`            <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Connection" key="connections">
`;let E={};for(let $ of b.entities)E[$]=this._generateUUID();y.forEach(e=>{let t=E[e.ownerName],n=E[e.referencedName];t&&n&&(o+=`              <value type="object" struct-name="workbench.physical.Connection" id="${this._generateUUID()}">
`,o+=`                <value type="string" key="caption">${e.name}</value>
`,o+='                <value type="real" key="captionXOffs">0</value>\n',o+='                <value type="real" key="captionYOffs">0</value>\n',o+='                <value type="string" key="comment"></value>\n',o+='                <value type="real" key="endCaptionXOffs">0</value>\n',o+='                <value type="real" key="endCaptionYOffs">0</value>\n',o+='                <value type="string" key="extraCaption"></value>\n',o+='                <value type="real" key="extraCaptionXOffs">0</value>\n',o+='                <value type="real" key="extraCaptionYOffs">0</value>\n',o+=`                <link type="object" struct-name="db.ForeignKey" key="foreignKey">${e.id}</link>
`,o+='                <value type="real" key="middleSegmentOffset">0</value>\n',o+='                <value type="real" key="startCaptionXOffs">0</value>\n',o+='                <value type="real" key="startCaptionYOffs">0</value>\n',o+='                <value type="int" key="drawSplit">0</value>\n',o+=`                <link type="object" struct-name="model.Figure" key="endFigure">${n}</link>
`,o+=`                <link type="object" struct-name="model.Figure" key="startFigure">${t}</link>
`,o+=`                <link type="object" struct-name="model.Diagram" key="owner">${f}</link>
`,o+='                <value type="int" key="visible">1</value>\n',o+='                <value type="string" key="name"></value>\n',o+="              </value>\n")}),o+=`            </value>
`,o+='            <value type="string" key="description"></value>\n',o+=`            <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Figure" key="figures">
`;let j=40,N=40;for(let w of b.entities){let C=s[w];if(!C)continue;let D=E[w],I=80+20*C.columns.length;o+=`              <value type="object" struct-name="workbench.physical.TableFigure" id="${D}">
`,o+='                <value type="int" key="columnsExpanded">1</value>\n',o+='                <value type="int" key="foreignKeysExpanded">0</value>\n',o+='                <value type="int" key="indicesExpanded">0</value>\n',o+='                <value type="int" key="summarizeDisplay">-1</value>\n',o+=`                <link type="object" struct-name="db.Table" key="table">${C.id}</link>
`,o+='                <value type="int" key="triggersExpanded">0</value>\n',o+='                <value type="string" key="color">#98BFDA</value>\n',o+='                <value type="int" key="expanded">1</value>\n',o+=`                <value type="real" key="height">${I}</value>
`,o+=`                <link type="object" struct-name="model.Layer" key="layer">${x}</link>
`,o+=`                <value type="real" key="left">${j}</value>
`,o+='                <value type="int" key="locked">0</value>\n',o+='                <value type="int" key="manualSizing">0</value>\n',o+=`                <value type="real" key="top">${N}</value>
`,o+=`                <value type="real" key="width">220</value>
`,o+=`                <link type="object" struct-name="model.Diagram" key="owner">${f}</link>
`,o+='                <value type="int" key="visible">1</value>\n',o+=`                <value type="string" key="name">${C.name}</value>
`,o+="              </value>\n",(j+=260)>1600&&(j=40,N+=400)}for(let q of(o+="            </value>\n",o+='            <value type="real" key="height">1380.95</value>\n',o+=`            <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Layer" key="layers"/>
`,o+=`            <value type="string" key="name">${b.name}</value>
`,o+='            <value type="dict" key="options"/>\n',o+=`            <link type="object" struct-name="model.Model" key="owner">${i}</link>
`,o+=`            <value type="object" struct-name="workbench.physical.Layer" id="${x}" key="rootLayer">
`,o+='              <value type="string" key="color"></value>\n',o+='              <value type="string" key="description"></value>\n',o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Figure" key="figures">
`,b.entities)){let T=E[q];T&&(o+=`                <link type="object">${T}</link>
`)}o+="              </value>\n",o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Group" key="groups"/>
`,o+='              <value type="real" key="height">3000</value>\n',o+='              <value type="real" key="left">0</value>\n',o+=`              <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Layer" key="subLayers"/>
`,o+='              <value type="real" key="top">0</value>\n',o+='              <value type="real" key="width">3000</value>\n',o+=`              <link type="object" struct-name="model.Diagram" key="owner">${f}</link>
`,o+='              <value type="int" key="visible">1</value>\n',o+='              <value type="string" key="name"></value>\n',o+="            </value>\n",o+=`            <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Object" key="selection"/>
`,o+='            <value type="int" key="updateBlocked">0</value>\n',o+='            <value type="real" key="width">1972</value>\n',o+='            <value type="real" key="x">0</value>\n',o+='            <value type="real" key="y">0</value>\n',o+='            <value type="real" key="zoom">1</value>\n',o+="          </value>\n"}o+="        </value>\n",o+='        <value type="string" key="figureNotation">workbench/default</value>\n',o+=`        <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="GrtStoredNote" key="notes"/>
`,o+='        <link type="object" struct-name="db.mgmt.Rdbms" key="rdbms">com.mysql.rdbms.mysql</link>\n',o+=`        <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="db.Script" key="scripts"/>
`,o+='        <value type="dict" key="syncProfiles"/>\n',o+=`        <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="GrtObject" key="tagCategories"/>
`,o+=`        <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="meta.Tag" key="tags"/>
`,o+=`        <link type="object" struct-name="model.Diagram" key="currentDiagram">${h}</link>
`,o+='        <value type="dict" key="customData"/>\n',o+=`        <value _ptr_="${this._generatePtr()}" type="list" content-type="object" content-struct-name="model.Marker" key="markers"/>
`,o+='        <value type="dict" key="options"/>\n',o+='        <value type="string" key="name"></value>\n',o+=`        <link type="object" struct-name="GrtObject" key="owner">${l}</link>
`,o+="      </value>\n",o+="    </value>\n",o+='    <value type="dict" key="customData"/>\n',o+=`    <value type="object" struct-name="app.DocumentInfo" id="${this._generateUUID()}" key="info">
`,o+='      <value type="string" key="dateCreated">'+new Date().toISOString()+"</value>\n",o+='      <value type="string" key="description"></value>\n',o+='      <value type="string" key="version">1.0</value>\n',o+='      <value type="string" key="name">Properties</value>\n',o+=`      <link type="object" struct-name="GrtObject" key="owner">${l}</link>
`,o+="    </value>\n",o+=`    <value type="object" struct-name="app.PageSettings" id="${this._generateUUID()}" key="pageSettings">
`,o+='      <value type="string" key="name"></value>\n',o+=`      <link type="object" struct-name="GrtObject" key="owner">${l}</link>
`,o+="    </value>\n",o+='    <value type="string" key="name"></value>\n',o+="  </value>\n",o+="</data>",t.file("document.mwb.xml",o);let S=!1;for(let M in s)if(s[M].data&&s[M].data.length>0){S=!0;break}"undefined"==typeof initSqlJs&&await this.loadScript("schema-editor/wasm/sql-wasm.js");let P=await initSqlJs({locateFile:e=>"../lib.assets/wasm/sql-wasm.wasm"}),A=new P.Database;for(let U in s){let O=s[U];if(O.data&&O.data.length>0){let L=O.columns.map(e=>`"${e.id}" TEXT`).join(", ");A.run(`CREATE TABLE "${O.id}" (${L});`);let _=`INSERT INTO "${O.id}" VALUES (${O.columns.map(()=>"?").join(", ")})`,R=A.prepare(_);O.data.forEach(e=>{let t=O.columns.map(t=>{let n=e[t.name];return null==n?null:String(n)});R.run(t)}),R.free()}}let F=A.export();return t.file("@db/data.db",F),t}_generatePtr(){return"0000023C"+"xxxxxxxx".replace(/[x]/g,function(e){return(16*Math.random()|0).toString(16)}).toUpperCase()}_generateUUID(){let e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}).toUpperCase();return`{${e}}`}}