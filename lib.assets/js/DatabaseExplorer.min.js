let tabsLinkContainer,currentMarginLeft=0,converter=null,editor,entityRenderer,diagramRenderer={},reservedColumns={},resizablePanels,scrollElement=null;const SCROLL_POSITION_KEY="scrollPosition.tableList";let timeout=setTimeout("",1e4),tableIndex=0,maxTableIndex=0,exportConfig={},exportTableList=[],fileName="",downloadName="",timeoutDownload=setTimeout("",100),isExporting=!1;function debounce(e,t){let a;return function(){clearTimeout(a),a=setTimeout(e,t)}}function getMetaValues(){return{applicationId:document.querySelector('meta[name="application-id"]').getAttribute("content"),databaseName:document.querySelector('meta[name="database-name"]').getAttribute("content"),databaseSchema:document.querySelector('meta[name="database-schema"]').getAttribute("content"),databaseType:document.querySelector('meta[name="database-type"]').getAttribute("content"),hash:document.querySelector('meta[name="hash"]').getAttribute("content")}}function setMetaValues(e,t,a,r,n){document.querySelector('meta[name="application-id"]').setAttribute("content",e),document.querySelector('meta[name="database-name"]').setAttribute("content",t),document.querySelector('meta[name="database-schema"]').setAttribute("content",a),document.querySelector('meta[name="database-type"]').setAttribute("content",r),document.querySelector('meta[name="hash"]').setAttribute("content",n)}function saveScrollPosition(){scrollElement&&localStorage.setItem(SCROLL_POSITION_KEY,scrollElement.scrollTop.toString())}function restoreScrollPosition(){if(!(scrollElement=document.querySelector(".table-list")))return;let e=localStorage.getItem(SCROLL_POSITION_KEY);null!==e&&(scrollElement.scrollTop=parseInt(e,10))}function initTableScrollPosition(){if(!(scrollElement=document.querySelector(".table-list")))return;let e=debounce(saveScrollPosition,300);scrollElement.addEventListener("scroll",e),restoreScrollPosition()}function init(){converter=new SQLConverter;let e=document.getElementById("queryTranslatorModal"),t=document.getElementById("entityEditorModal"),a=document.querySelectorAll(".cancel-button"),r=document.querySelector(".import-structure"),n=document.querySelector(".open-entity-editor"),i=document.querySelector(".open-structure"),o=document.querySelector(".translate-structure"),l=document.querySelector(".import-from-entity"),c=document.querySelector(".clear"),s=document.querySelector(".original"),d=document.querySelector('[name="query"]'),u=document.querySelectorAll(".cell-delete a");initTableScrollPosition(),r&&(r.onclick=function(){e.style.display="block",s.focus()}),n&&(n.onclick=function(){t.style.display="block",resizablePanels.loadPanelWidth(),editor.updateDiagram()}),a&&a.forEach(function(e){e.onclick=function(e){e.target.closest(".modal").style.display="none"}}),c&&(c.onclick=function(){s.value=""}),o&&(o.onclick=function(){let t=s.value,a=document.querySelector('meta[name="database-type"]').getAttribute("content"),r=converter.translate(t,a);document.querySelector('[name="query"]').value=r,e.style.display="none"}),i&&(i.onclick=function(){document.querySelector(".structure-sql").click()}),l&&(l.onclick=function(){let e=document.querySelector('meta[name="database-type"]').getAttribute("content"),a=editor.generateSQL(e);document.querySelector('[name="query"]').value=a.join("\r\n"),t.style.display="none"}),u&&u.length>0&&u.forEach(function(e){e.addEventListener("click",function(e){e.preventDefault();let t=e.target,a=t.dataset.schema,r=t.dataset.table,n=t.dataset.primaryKey,i=t.dataset.value,o="";o=`DELETE FROM ${""!=a?`${a}.${r}`:r} WHERE ${n} = '${i}';\r
`;d.value.startsWith("DELETE FROM ")&&(o=d.value+o),d.value=o})}),window.onclick=function(t){t.target==e&&(e.style.display="none")},document.querySelector(".structure-sql").addEventListener("change",function(e){openStructure(this.files[0])}),document.getElementById("tableFilter").addEventListener("input",function(e){let t=e.target.value.toLowerCase().trim(),a=document.querySelector(".object-container .table-list"),r=a.querySelectorAll("li");r.forEach(e=>{let a=e.getAttribute("title"),r=a?a.toLowerCase():"";e.style.display=r.includes(t)?"":"none"})}),document.querySelector(".draw-relationship").addEventListener("change",function(e){editor.refreshEntities(),editor.updateDiagram()}),document.addEventListener("change",function(e){if(e.target.classList.contains("check-group-structure")){let t=e.target.dataset.group,a=e.target.checked;document.querySelectorAll(".check-structure-"+t).forEach(e=>{e.checked=a})}if(e.target.classList.contains("check-group-data")){let r=e.target.dataset.group,n=e.target.checked;document.querySelectorAll(".check-data-"+r).forEach(e=>{e.checked=n})}}),document.querySelector(".check-all-entity-data").addEventListener("change",e=>{let t=e.target.checked,a=e.target.closest("table").querySelector("tbody").querySelectorAll(".selected-entity-data");a&&a.forEach(e=>{e.checked=t}),editor.exportToSQL()}),document.querySelector(".right-panel .table-list-for-export").addEventListener("change",e=>{(e.target.classList.contains("selected-entity-structure")||e.target.classList.contains("selected-entity-data"))&&editor.exportToSQL(),e.target.classList.contains("export-structure-system")&&(document.querySelectorAll(".entity-structure-system").forEach(t=>{t.checked=e.target.checked}),editor.exportToSQL()),e.target.classList.contains("export-structure-custom")&&(document.querySelectorAll(".entity-structure-custom").forEach(t=>{t.checked=e.target.checked}),editor.exportToSQL()),e.target.classList.contains("export-data-system")&&(document.querySelectorAll(".entity-data-system").forEach(t=>{t.checked=e.target.checked}),editor.exportToSQL()),e.target.classList.contains("export-data-custom")&&(document.querySelectorAll(".entity-data-custom").forEach(t=>{t.checked=e.target.checked}),editor.exportToSQL())}),document.querySelector(".entity-selector-container").addEventListener("change",function(e){("SELECT"===e.target.tagName||"INPUT"===e.target.tagName)&&setTimeout(function(){saveFormState(e.target.form)},400)}),document.querySelector(".entity-type-selector").addEventListener("change",function(e){setTimeout(function(){saveFormState(e.target.form)},400)});let{applicationId:p,databaseName:y,databaseSchema:f,databaseType:m,hash:h}=getMetaValues();loadDatabaseIndex(p,h);loadGraphQlEntityFromServer(p,m,y,f,document.querySelector(".graphql-app-profile").value,function(e){editor.graphqlAppData=e}),window.addEventListener("storage",function(e){if("graphql-app-profile"==e.key){let t=JSON.parse(e.newValue),{applicationId:a,databaseName:r,databaseSchema:n,databaseType:i,hash:o}=getMetaValues();a==t.applicationId&&r==t.databaseName&&n==t.databaseSchema&&i==t.databaseType&&o==t.hash&&loadApplicationData(t.applicationId,t.databaseName,t.databaseSchema,t.databaseType,t.hash)}})}function onChangeDatabase(e){let t=e.options[e.selectedIndex].dataset;loadApplicationData(t.applicationId,t.databaseName,t.databaseSchema,t.databaseType,t.hash)}function loadDatabaseIndex(e,t){$.ajax({type:"GET",url:"../lib.ajax/load-entiy-index.php",data:{applicationId:e},dataType:"json",success:function(a){let r=document.querySelector(".schema-selector");for(let n in r.innerHTML="",a)if(a.hasOwnProperty(n)){let i=document.createElement("option");i.value=n,i.textContent=a[n].label,n==t&&i.setAttribute("selected","selected"),i.dataset.applicationId=e,i.dataset.databaseType=a[n].databaseType,i.dataset.databaseName=a[n].databaseName,i.dataset.databaseSchema=a[n].databaseSchema,i.dataset.hash=n,r.appendChild(i)}},error:function(e){console.error(e)}})}function qsa(e){return document.querySelectorAll(e)}function qs(e){return document.querySelector(e)}function saveFormState(e){let t=e.querySelector('.entity-type-checker[data-entity-type="custom"]').checked,a=e.querySelector('.entity-type-checker[data-entity-type="system"]').checked,r=e.querySelector(".in-memory-cache-checker").checked,n=e.querySelector(".programming-language-selector").value,i=e.querySelectorAll(".entity-selector-table"),o=e.querySelectorAll(".entity-table"),l={},c={},s=e.querySelector(".graphql-app-profile").value;i.forEach(e=>{let t=e.querySelector(".entity-selector");l[t.value]=t.checked}),o.forEach(e=>{let t=e.dataset.entity;c[t]={},e.querySelector("tbody").querySelectorAll("tr").forEach(e=>{let a=e.dataset.col,r={};if(r.checked=e.querySelector(".check-column").checked,e.querySelector(".filter-graphql")){let n=e.querySelector(".filter-graphql").value;r.filter=n}if(e.querySelector(".textarea-graphql")){let i=e.querySelector(".textarea-graphql").checked;r.textareaColumns=i}if(e.querySelector(".pk-value-graphql")){let o=e.querySelector(".pk-value-graphql").value;r.primaryKeyValue=o}c[t][a]=r})});let d={custom:t,system:a,inMemoryCache:r,entitySelector:l,entities:c,programmingLanguage:n};editor.graphqlAppData=d;let{applicationId:u,databaseName:p,databaseSchema:y,databaseType:f}=getMetaValues();sendGraphQlEntityToServer(u,f,p,y,d,s)}function restoreField(e,t,a,r="checkbox"){if(void 0===a)return;let n=e.querySelector(t);n&&("checkbox"===r?n.checked=a:"select"===r&&(n.value=a))}function loadFormState(e,t){if(e&&t){if(restoreField(e,'.entity-type-checker[data-entity-type="custom"]',t.custom,"checkbox"),restoreField(e,'.entity-type-checker[data-entity-type="system"]',t.system,"checkbox"),restoreField(e,".in-memory-cache-checker",t.inMemoryCache,"checkbox"),restoreField(e,".programming-language-selector",t.programmingLanguage,"select"),t.entitySelector&&"object"==typeof t.entitySelector){for(let a in t.entitySelector)if(Object.hasOwnProperty.call(t.entitySelector,a)){let r=e.querySelector(`.entity-selector[value="${a}"]`);r&&(r.checked=t.entitySelector[a])}}if(t.entities&&"object"==typeof t.entities)for(let n in t.entities)for(let i in t.entities[n]){let o=t.entities[n][i],l=e.querySelector(`table[data-entity="${n}"] tr[data-col="${i}"]`);if(!l)continue;l.querySelector(".check-column").checked=o.checked;let c=l.querySelector(`select.filter-graphql[data-col="${i}"]`);c&&void 0!==o.filter&&(c.value=o.filter);let s=l.querySelector(`input.textarea-graphql[data-col="${i}"]`);s&&void 0!==o.textareaColumns&&(s.checked=o.textareaColumns);let d=l.querySelector(`select.pk-value-graphql[data-col="${i}"]`);d&&void 0!==o.primaryKeyValue&&(d.value=o.primaryKeyValue)}}}async function sendGraphQlEntityToServer(e,t,a,r,n,i){let o=buildUrl("graphql-entity",e,t,a,r,"",i),l=JSON.stringify(n);try{let c=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8","X-Requested-With":"xmlhttprequest"},body:l});if(!c.ok)return console.error("An error occurred while sending data to the server:",c.status,c.statusText),null;let s=await c.json();return s}catch(d){return console.error("Network error while sending data to the server:",d),null}}function loadGraphQlEntityFromServer(e,t,a,r,n,i){let o=buildUrl("graphql-entity",e,t,a,r,"",n);fetch(o,{method:"GET",headers:{Accept:"application/json","X-Requested-With":"xmlhttprequest"}}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{"function"==typeof i&&i(e)}).catch(e=>{console.error("An error occurred while fetching data from the server:",e)})}function openStructure(e){let t=new FileReader,a=e.slice(0,512);t.onload=function(t){let a=new Uint8Array(t.target.result);looksLikeSQLite(a)?openSQLiteStructure(e):readAsText(e)},t.onerror=()=>console.error("Failed to read file header."),t.readAsArrayBuffer(a)}function readAsText(e){let t=new FileReader;t.onload=function(e){try{document.querySelector(".original").value=e.target.result}catch(t){console.error("Error displaying file content: "+t.message)}},t.onerror=()=>console.error("Failed to read file content."),t.readAsText(e)}function looksLikeSQLite(e){return[83,81,76,105,116,101,32,102,111,114,109,97,116,32,51,0].every((t,a)=>e[a]===t)}function openSQLiteStructure(e){let t=new FileReader;t.onload=function(e){try{let t=e.target.result,a=new Uint8Array(t);initSqlJs({locateFile:e=>"../lib.assets/wasm/sql-wasm.wasm"}).then(e=>{let t=new e.Database(a),r=t.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");if(0===r.length||0===r[0].values.length){document.querySelector(".original").value="-- No tables found in database.";return}let n=r[0].values.map(e=>e[0]),i="-- SQL Structure Export\n\n";n.forEach(e=>{let a=t.exec(`PRAGMA table_info(${e});`);if(a.length>0){let r=a[0].values.map(e=>{let t=e[1],a=e[2],r=1===e[3]?"NOT NULL":"",n=null!=e[4]?`DEFAULT ${e[4]}`:"",i=1===e[5]?"PRIMARY KEY":"";return`	${t} ${a} ${r} ${n} ${i}`.replace(/\s+/g," ").trim()}).join(",\n");i+=`-- Table: ${e}
`,i+=`CREATE TABLE ${e} (
${r}
);

`}}),document.querySelector(".original").value=i}).catch(e=>{console.error("SQL.js initialization error:",e),document.querySelector(".original").value="-- Failed to initialize SQL.js."})}catch(r){console.error("Error processing SQLite file:",r),document.querySelector(".original").value="-- Error reading SQLite database."}},t.onerror=()=>{console.error("Failed to read SQLite file."),document.querySelector(".original").value="-- Unable to read file."},t.readAsArrayBuffer(e)}function isEditableElement(e){return"INPUT"===e.tagName||"TEXTAREA"===e.tagName||e.isContentEditable}function loadApplicationData(e,t,a,r,n){setMetaValues(e,t,a,r,n),fetchEntityFromServer(e,r,t,a),fetchConfigFromServer(e,r,t,a)}function syncDatabaseSchema(){let{applicationId:e,databaseName:t,databaseSchema:a,databaseType:r,hash:n}=getMetaValues(),i={applicationId:e,databaseName:t,databaseSchema:a,databaseType:r,hash:n};i.time=new Date().getTime(),window.localStorage.setItem("graphql-app-profile",JSON.stringify(i))}function downloadHTML(){editor.showExportHTMLDialog()}function enableArrowKeyNavigation(e){document.querySelector(e)?.addEventListener("keydown",function(e){if(!(e.target instanceof HTMLInputElement)||"text"!==e.target.type)return;let t=e.key;if("ArrowUp"!==t&&"ArrowDown"!==t)return;let a=e.target,r=a.closest("td"),n=r?.parentElement;if(!n)return;let i=[...n.children].indexOf(r),o="ArrowUp"===t?n.previousElementSibling:n.nextElementSibling;function l(e){return e&&null!==e.offsetParent&&"hidden"!==window.getComputedStyle(e).visibility}for(;o;){let c=o.children[i];if(c){let s=c.querySelector('input[type="text"]');if(l(s)){e.preventDefault(),s.focus(),s.select();break}}o="ArrowUp"===t?o.previousElementSibling:o.nextElementSibling}})}function parseCSVLine(e){let t=[],a="",r=!1;for(let n=0;n<e.length;n++){let i=e[n],o=e[n+1];r?'"'===i&&'"'===o?(a+='"',n++):'"'===i?r=!1:a+=i:'"'===i?r=!0:","===i?(t.push(a),a=""):a+=i}return t.push(a),t}function checkAllDiagram(e){e.preventDefault();let t=e.target.checked;e.target.closest("ul").querySelectorAll("input.diagram-to-export").forEach(e=>{e.checked=t})}function startExportDatabase(e,t){isExporting||(isExporting=!0,exportDatabase(e,t))}function exportDatabase(e,t){let{applicationId:a,databaseName:r,databaseSchema:n,databaseType:i}=getMetaValues();exportTableList=[],clearTimeout(timeoutDownload),tableIndex=0,fileName=new Date().getTime()+".sql",downloadName=""!=a?a+"-"+fileName:"magicappbuilder-"+fileName,$(e).find("tbody").find("tr").each(function(){let e=$(this).attr("data-table-name"),t=$(this).find('input[name="structure_export[]"]').is(":checked"),a=$(this).find('input[name="data_export[]"]').is(":checked");$(this).attr("data-status","none"),(t||a)&&exportTableList.push({tableName:e,structure:t,data:a})}),maxTableIndex=exportTableList.length,exportConfig={applicationId:a,databaseType:i,databaseName:r,schemaName:n},exportTable(e,t)}function exportTable(e,t){if(tableIndex>=maxTableIndex){isExporting=!1,"function"==typeof t&&t();let a=document.createElement("iframe");a.style.display="none",a.src="export-download.php?fileName="+encodeURIComponent(fileName)+"&downloadName="+encodeURIComponent(downloadName),document.body.appendChild(a),setTimeout(()=>{document.body.removeChild(a)},5e3)}else{let r=exportTableList[tableIndex],n=$(e).find("table tbody").find('tr[data-table-name="'+r.tableName+'"]');n.length&&n.attr("data-status","in-progress");let i=document.querySelector('[name="target_database_type"]').value;$.ajax({type:"POST",url:"export-database.php",data:{...exportConfig,tableName:r.tableName,includeStructure:r.structure?1:0,includeData:r.data?1:0,fileName:fileName,targetDatabaseType:i},dataType:"json",success:function(a){a.success?(n.length&&n.attr("data-status","finish"),tableIndex++,exportTable(e,t)):n.length&&n.attr("data-status","error")},error:function(){isExporting=!1,n.length&&n.attr("data-status","error")}})}}function listTableToExport(e,t){let{applicationId:a,databaseName:r,databaseSchema:n,databaseType:i}=getMetaValues();$(e).find(".modal-body").empty().append('<div style="text-align: center;"><span class="animation-wave"><span></span></span></div>'),$.ajax({type:"GET",url:"table-list.php",data:{applicationId:a,databaseType:i,databaseName:r,schemaName:n,tableName:t},success:function(t){$(e).find(".modal-body").empty().append(t),$("#cstructure").on("change",function(){let e=$(this)[0].checked;$(".check-for-structure").each(function(){$(this)[0].checked=e})}),$("#cdata").on("change",function(){let e=$(this)[0].checked;$(".check-for-data").each(function(){$(this)[0].checked=e})})}}),$.ajax({type:"GET",url:"export-clean-up.php",success:function(e){}})}function showExportDialog(e,t,a,r,n,i){let o=document.querySelector(e),l=o.querySelector(".button-ok"),c=o.querySelector(".button-cancel");function s(){i(!0)}function d(){i(!1)}return o.querySelector(".modal-header h3").innerHTML=a,o.querySelector(".modal-body").innerHTML=t,l.innerHTML=r,c.innerHTML=n,o.style.display="block",l.removeEventListener("click",s),c.removeEventListener("click",d),l.addEventListener("click",s),c.addEventListener("click",d),o}function updateMarginLeft(e){currentMarginLeft+=e;let t=tabsLinkContainer.querySelector("ul");currentMarginLeft=Math.max(Math.min(currentMarginLeft,0),-(t.scrollWidth-tabsLinkContainer.offsetWidth)),t.style.marginLeft=`${currentMarginLeft}px`}function moveTabToFirst(){currentMarginLeft=0;let e=tabsLinkContainer.querySelector("ul");currentMarginLeft=Math.max(Math.min(currentMarginLeft,0),-(e.scrollWidth-tabsLinkContainer.offsetWidth)),e.style.marginLeft=`${currentMarginLeft}px`}function moveTabToLast(){let e=tabsLinkContainer.querySelector("ul");currentMarginLeft=tabsLinkContainer.offsetWidth-e.scrollWidth,e.style.marginLeft=`${currentMarginLeft}px`}function downloadSVG(){editor.downloadSVG()}function downloadPNG(){editor.downloadPNG()}function downloadMD(){editor.downloadMD()}function showConfirmationDialog(e,t,a,r,n){let i=document.querySelector("#asyncConfirm"),o=i.querySelector(".confirm-ok"),l=i.querySelector(".confirm-cancel");o=removeAllEventListeners(o),l=removeAllEventListeners(l),i.querySelector(".modal-header h3").innerHTML=t,i.querySelector(".modal-body").innerHTML=e,o.innerHTML=a,l.innerHTML=r,i.style.display="block",o.addEventListener("click",function e(){i.style.display="none",n(!0)}),l.addEventListener("click",function e(){i.style.display="none",n(!1)})}function removeAllEventListeners(e){let t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t}function sendEntityToServer(e,t,a,r,n){let i=new XMLHttpRequest,o=buildUrl("entity",e,t,a,r,"");i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.onreadystatechange=function(){if(4===i.readyState){if(200===i.status){let{applicationId:e,databaseName:t,databaseSchema:a,databaseType:r,hash:n}=getMetaValues();loadDatabaseIndex(e,n)}else console.error("An error occurred while sending data to the server")}},i.send(JSON.stringify({applicationId:e,databaseType:t,databaseName:a,databaseSchema:r,entities:n}))}function sendDiagramToServer(e,t,a,r,n){let i=new XMLHttpRequest,o=buildUrl("entity",e,t,a,r,"");i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.onreadystatechange=function(){4===i.readyState&&(200===i.status||console.error("An error occurred while sending data to the server"))},i.send(JSON.stringify({applicationId:e,databaseType:t,databaseName:a,databaseSchema:r,diagrams:n}))}function fetchEntityFromServer(e,t,a,r,n,i){let o=new XMLHttpRequest,l=buildUrl("entity",e,t,a,r,"");o.open("GET",l,!0),o.onreadystatechange=function(){if(4===o.readyState){if(200===o.status){let e=o.responseText;try{let t=JSON.parse(e);if(t&&t.entities){let a=editor.createEntitiesFromJSON(t);a?(editor.entities=a.entities||[],editor.diagrams=a.diagrams||[]):(editor.entities=[],editor.diagrams=[]),editor.refreshEntities(),editor.clearDiagrams(),editor.clearGeneratedQuery(),editor.prepareDiagram(),i&&i(null,t)}else editor.entities=[],editor.diagrams=[],editor.refreshEntities(),editor.clearDiagrams(),editor.clearGeneratedQuery(),editor.prepareDiagram()}catch(r){editor.entities=[],editor.diagrams=[],editor.refreshEntities(),editor.clearDiagrams(),editor.clearGeneratedQuery(),editor.prepareDiagram(),console.error("Error parsing JSON from fetchEntityFromServer:",r.message,e)}}else console.error("An error occurred while fetching data from the server. Status:",o.status)}},o.send()}function sendTemplateToServer(e,t,a,r,n){let i={applicationId:e,databaseType:t,databaseName:a,databaseSchema:r,template:JSON.stringify(n)},o=new XMLHttpRequest,l=buildUrl("template",e,t,a,r,"");o.open("POST",l,!0),o.setRequestHeader("Content-Type","application/json"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status||console.error("An error occurred while sending data to the server"))},o.send(JSON.stringify(i))}function fetchTemplateFromServer(e,t,a,r,n,i){if(""!=e){let o=new XMLHttpRequest,l=buildUrl("template",e,t,a,r,"");o.open("GET",l,!0),o.onreadystatechange=function(){if(4===o.readyState){if(200===o.status){let e=o.responseText;try{let t=JSON.parse(e);editor.template=editor.createTemplateFromJSON(t),"function"==typeof i&&i(t)}catch(a){console.error(a)}}else console.error("An error occurred while fetching data from the server. Status:",o.status)}},o.send()}}function sendConfigToServer(e,t,a,r,n){let i=new XMLHttpRequest,o=buildUrl("config",e,t,a,r,"");i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.onreadystatechange=function(){4===i.readyState&&(200===i.status||console.error("An error occurred while sending data to the server"))},i.send(JSON.stringify({applicationId:e,databaseType:t,databaseName:a,databaseSchema:r,config:n}))}function fetchConfigFromServer(e,t,a,r,n,i){let o=new XMLHttpRequest,l=buildUrl("config",e,t,a,r,"");o.open("GET",l,!0),o.onreadystatechange=function(){if(4===o.readyState){if(200===o.status){let e=o.responseText;try{let t=JSON.parse(e);editor.defaultDataType=t.defaultDataType+"",editor.defaultDataLength=t.defaultDataLength+"",editor.primaryKeyDataType=t.primaryKeyDataType+"",editor.primaryKeyDataLength=t.primaryKeyDataLength+""}catch(a){console.error(a)}}else console.error("An error occurred while fetching data from the server. Status:",o.status)}},o.send()}function buildUrl(e,t,a,r,n,i,o){return"template"==e?`../lib.ajax/load-template-data.php?applicationId=${encodeURIComponent(t)}&databaseType=${encodeURIComponent(a)}&databaseName=${encodeURIComponent(r)}&databaseSchema=${encodeURIComponent(n)}&entities=${encodeURIComponent(JSON.stringify(i))}`:"config"==e?`../lib.ajax/load-config-data.php?applicationId=${encodeURIComponent(t)}&databaseType=${encodeURIComponent(a)}&databaseName=${encodeURIComponent(r)}&databaseSchema=${encodeURIComponent(n)}&entities=${encodeURIComponent(JSON.stringify(i))}`:"graphql-entity"==e?`../lib.ajax/load-graphql-entity-data.php?applicationId=${encodeURIComponent(t)}&databaseType=${encodeURIComponent(a)}&databaseName=${encodeURIComponent(r)}&databaseSchema=${encodeURIComponent(n)}&entities=${encodeURIComponent(JSON.stringify(i))}&profile=${o}`:`../lib.ajax/load-entity-data.php?applicationId=${encodeURIComponent(t)}&databaseType=${encodeURIComponent(a)}&databaseName=${encodeURIComponent(r)}&databaseSchema=${encodeURIComponent(n)}&entities=${encodeURIComponent(JSON.stringify(i))}`}function disableOtherOptions(e){let t=e.value;for(let a of e.options)a.disabled=a.value!==t}function enableAllOptions(e){for(let t of e.options)t.disabled=!1}document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelectorAll(".collapsible .button-toggle");entityRenderer=new EntityRenderer(".erd-svg"),e.forEach(function(e){e.addEventListener("click",function(e){e.target.closest(".collapsible").classList.toggle("open")})}),editor=new EntityEditor(".entity-editor",{defaultDataType:"VARCHAR",defaultDataLength:50,primaryKeyDataType:"BIGINT",primaryKeyDataLength:20,callbackLoadEntity:function(){let{applicationId:e,databaseName:t,databaseSchema:a,databaseType:r}=getMetaValues();fetchEntityFromServer(e,r,t,a),fetchConfigFromServer(e,r,t,a)},callbackSaveEntity:function(e){let{applicationId:t,databaseName:a,databaseSchema:r,databaseType:n}=getMetaValues();sendEntityToServer(t,n,a,r,e),syncDatabaseSchema()},callbackSaveDiagram:function(e){let{applicationId:t,databaseName:a,databaseSchema:r,databaseType:n}=getMetaValues();sendDiagramToServer(t,n,a,r,e),syncDatabaseSchema()},callbackLoadTemplate:function(){let{applicationId:e,databaseName:t,databaseSchema:a,databaseType:r}=getMetaValues();fetchTemplateFromServer(e,r,t,a,null,function(e){reservedColumns=e})},callbackSaveTemplate:function(e){let{applicationId:t,databaseName:a,databaseSchema:r,databaseType:n}=getMetaValues();sendTemplateToServer(t,n,a,r,e)},callbackSaveConfig:function(e){let{applicationId:t,databaseName:a,databaseSchema:r,databaseType:n}=getMetaValues();sendConfigToServer(t,n,a,r,e)}}),document.addEventListener("paste",async function(e){let t=e.target;editor.clearBeforeImport=!1;let a=isEditableElement(t);if(!a&&t&&t.closest(".entity-editor")){e.preventDefault();let r;try{let n=await navigator.clipboard.read();for(let i of n)if(i.types.includes("text/html")){let o=await i.getType("text/html"),l=await o.text(),c=document.createElement("div");c.innerHTML=l;let s=c.querySelectorAll("table");if(s&&s.length>0){r=editor.parseHtmlToJSON(s[0]),editor.importFromData(r);return}}let d=await navigator.clipboard.readText();if(/create\s+table/i.test(d.trim())||/insert\s+into/i.test(d.trim()))editor.parseCreateTable(d,function(e){let{applicationId:t,databaseName:a,databaseSchema:r,databaseType:n}=getMetaValues();sendEntityToServer(t,n,a,r,e)});else if(/[\"']__magic_signature__[\"']\s*:\s*[\"']MAGICAPPBUILDER-DB-DESIGN-V1[\"']/.test(d))try{editor.importJSONData(d,function(e,t){let{applicationId:a,databaseName:r,databaseSchema:n,databaseType:i}=getMetaValues();sendEntityToServer(a,i,r,n,e),sendDiagramToServer(a,i,r,n,t)})}catch(u){console.error("Invalid JSON format despite having signature:",u)}else editor.isMarkdownTable(d)?editor.importFromMarkdown(d,function(e){editor.renderEntities();let{applicationId:t,databaseName:a,databaseSchema:r,databaseType:n}=getMetaValues();sendEntityToServer(t,n,a,r,e)}):(r=editor.parseTextToJSON(d),editor.importFromData(r))}catch(p){console.error("Failed to read from clipboard:",p)}}}),document.querySelector('[type="submit"].execute').addEventListener("click",function(e){e.preventDefault(),showConfirmationDialog("Are you sure you want to execute the query?","Execute Query Confirmation","Yes","No",function(t){t&&e.target.closest("form").submit()})}),document.querySelector('[type="button"].save').addEventListener("click",function(e){e.preventDefault();let t=document.querySelector('textarea[name="query"]').value.trim();if(t.length>0){let a=new Blob([t],{type:"text/plain"}),r=URL.createObjectURL(a),n=document.createElement("a");n.href=r,n.download="query.sql",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r)}});let t=document.querySelector('[type="submit"][name="___export_table___"]');null!=t&&t.addEventListener("click",function(e){let t=e.target.getAttribute("value");e.preventDefault(),showConfirmationDialog("Are you sure you want to export the data from the table?","Export Confirmation","Yes","No",function(a){if(a){let r=document.createElement("input");r.type="hidden",r.name="___export_table___",r.value=t,e.target.closest("form").appendChild(r),e.target.closest("form").submit(),e.target.closest("form").removeChild(r)}})});let a=document.querySelector('[type="submit"][name="___export_database___"]');null!=a&&a.addEventListener("click",function(e){let t=e.target.getAttribute("value");e.preventDefault();let a="#exportModal";showExportDialog(a,'<div class="loading-animation"></div>',"Export Database","Yes","No",function(e){if(e){let t=document.querySelector('[name="target_database_type"]');disableOtherOptions(t),startExportDatabase(a,function(){enableAllOptions(t)})}else enableAllOptions(document.querySelector('[name="target_database_type"]')),document.querySelector("#exportModal").style.display="none"}),listTableToExport(a,t)}),window.addEventListener("resize",function(){editor.refreshEntities(),editor.updateDiagram()}),document.querySelector(".add-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("ul"),a=editor.getNewDiagramName(),r=new Date().getTime();editor.addDiagram(t,a,"diagram-"+r,[],!1,!0),editor.saveDiagram()}),document.querySelector('[data-id="all-entities"]').addEventListener("click",function(e){e.preventDefault();let t=e.target.parentNode,a=document.querySelector(".diagram-container");t.closest("ul").querySelectorAll("li.diagram-tab").forEach(e=>{e.classList.remove("active")}),a.querySelectorAll(".diagram").forEach(e=>{e.classList.remove("active")}),t.classList.add("active"),a.querySelector("#all-entities").classList.add("active"),document.querySelector(".entity-editor .left-panel .table-list").querySelectorAll("li").forEach(e=>{let t=e.querySelector('input[type="checkbox"]');t.checked=!1,t.disabled=!0})}),document.addEventListener("change",function(e){if(e.target.closest('.table-list input[type="checkbox"]')){let t=document.querySelector(".diagram-container .diagram.active"),a=(t.dataset.entities||"").split(","),r=new Set;e.target.closest(".table-list").querySelectorAll('input[type="checkbox"]').forEach(e=>{let t=e.dataset.name;e.checked&&r.add(t)});let n=a.filter(e=>r.has(e));r.forEach(e=>{n.includes(e)||n.push(e)}),t.setAttribute("data-entities",n.join(",")),editor.saveDiagram()}editor.updateDiagram()}),document.addEventListener("change",e=>{let t=e.target;if("id1"===t.id&&e.isTrusted){let a=t.closest("ul"),r=null;if(a){let n=a.querySelectorAll('input[type="checkbox"]'),i=t.checked;if(n.forEach(e=>{e.checked!==i&&(e.checked=i);let t=`.selected-entity[data-name="${e.dataset.name}"]`,a=document.querySelector(t);a&&(a.checked=e.checked,r=a)}),r){let o=new Event("change",{bubbles:!0});o.isSimulated=!0,r.dispatchEvent(o)}}}}),resizablePanels=new ResizablePanels(".entity-editor",".left-panel",".right-panel",".resize-bar",200),tabsLinkContainer=document.querySelector(".tabs-link-container"),qs(".tab-mover li a.move-first").addEventListener("click",function(e){e.preventDefault(),moveTabToFirst()}),qs(".tab-mover li a.move-last").addEventListener("click",function(e){e.preventDefault(),moveTabToLast()}),document.querySelector(".tab-mover li a.move-left").addEventListener("click",function(e){e.preventDefault(),updateMarginLeft(30)}),document.querySelector(".tab-mover li a.move-right").addEventListener("click",function(e){e.preventDefault(),updateMarginLeft(-30)}),tabsLinkContainer.addEventListener("wheel",e=>{e.preventDefault();let t=e.deltaY||e.detail||e.wheelDelta;updateMarginLeft(t>0?-30:30)}),document.querySelector(".export-data-entity").addEventListener("click",function(){editor.exportData()}),document.querySelector(".import-data-entity").addEventListener("click",function(){document.querySelector("#importDataFileInput").click()}),document.querySelector(".add-data-entity").addEventListener("click",function(e){editor.addData(!0)}),document.querySelector(".clear-data-entity").addEventListener("click",function(){editor.clearData()}),document.querySelector(".save-data-entity").addEventListener("click",function(){editor.saveData()}),document.querySelector("#importDataFileInput").addEventListener("change",function(e){let t=e.target.files[0];t&&editor.importSheetFile(t,function(e,t,a,r,n){n.forEach(e=>{let t=editor.addData();if(t){let a={};for(let r of Object.keys(e)){let n=editor.snakeize(r);a[n]=e[r]}let i=t.querySelectorAll("input.entity-data-cell");i.forEach(e=>{let t=e.dataset.col;e.value=a[t]??""})}})})}),enableArrowKeyNavigation("#table-entity-editor"),enableArrowKeyNavigation("#table-template-editor"),init(),$('input[data-type="datetime"]').length&&$('input[data-type="datetime"]').datetimepicker({format:"Y-m-d H:i:s"}),$('input[data-type="date"]').length&&$('input[data-type="date"]').datetimepicker({timepicker:!1,format:"Y-m-d"}),$('input[data-type="time"]').length&&$('input[data-type="time"]').datetimepicker({datepicker:!1,format:"H:i:s"}),initAllEntitiesContextMenu(document.querySelector("#all-entities .erd-svg"))});