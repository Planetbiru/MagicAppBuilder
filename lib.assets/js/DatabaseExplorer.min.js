let tabsLinkContainer,currentMarginLeft=0,converter=null,editor,entityRenderer,diagramRenderer={},resizablePanels,scrollElement=null;const SCROLL_POSITION_KEY="scrollPosition.tableList";let timeout=setTimeout("",1e4);function debounce(e,t){let a;return function(){clearTimeout(a),a=setTimeout(e,t)}}function saveScrollPosition(){scrollElement&&localStorage.setItem(SCROLL_POSITION_KEY,scrollElement.scrollTop.toString())}function restoreScrollPosition(){if(!(scrollElement=document.querySelector(".table-list")))return;let e=localStorage.getItem(SCROLL_POSITION_KEY);null!==e&&(scrollElement.scrollTop=parseInt(e,10))}function initTableScrollPosition(){if(!(scrollElement=document.querySelector(".table-list")))return;let e=debounce(saveScrollPosition,300);scrollElement.addEventListener("scroll",e),restoreScrollPosition()}function init(){converter=new SQLConverter;let e=document.getElementById("queryTranslatorModal"),t=document.getElementById("entityEditorModal"),a=document.querySelectorAll(".cancel-button"),r=document.querySelector(".import-structure"),n=document.querySelector(".open-entity-editor"),i=document.querySelector(".open-structure"),o=document.querySelector(".translate-structure"),l=document.querySelector(".import-from-entity"),c=document.querySelector(".clear"),s=document.querySelector(".original"),d=document.querySelector(".query-generated"),u=document.querySelector('[name="query"]'),m=document.querySelectorAll(".cell-delete a");initTableScrollPosition(),r.onclick=function(){e.style.display="block",s.focus()},n.onclick=function(){t.style.display="block",resizablePanels.loadPanelWidth(),editor.updateDiagram()},a.forEach(function(e){e.onclick=function(e){e.target.closest(".modal").style.display="none"}}),c.onclick=function(){s.value=""},o.onclick=function(){let t=s.value,a=document.querySelector('meta[name="database-type"]').getAttribute("content"),r=converter.translate(t,a);document.querySelector('[name="query"]').value=r,e.style.display="none"},i.onclick=function(){document.querySelector(".structure-sql").click()},l.onclick=function(){let e=d.value,a=document.querySelector('meta[name="database-type"]').getAttribute("content"),r="";r="mysql"!=a.toLowerCase()&&"mariadb"!=a.toLowerCase()?converter.translate(e,a):e,document.querySelector('[name="query"]').value=r,t.style.display="none"},m.forEach(function(e){e.addEventListener("click",function(e){e.preventDefault();let t=e.target.getAttribute("data-schema"),a=e.target.getAttribute("data-table"),r=e.target.getAttribute("data-primary-key"),n=e.target.getAttribute("data-value"),i="";i=`DELETE FROM ${""!=t?`${t}.${a}`:a} WHERE ${r} = '${n}';\r
`;u.value.startsWith("DELETE FROM ")&&(i=u.value+i),u.value=i})}),window.onclick=function(t){t.target==e&&(e.style.display="none")},document.querySelector(".structure-sql").addEventListener("change",function(e){openStructure(this.files[0])}),document.querySelector(".draw-relationship").addEventListener("change",function(e){editor.refreshEntities(),editor.updateDiagram()})}function openStructure(e){let t=new FileReader;t.onload=function(e){try{document.querySelector(".original").value=e.target.result}catch(t){console.log("Error parsing JSON: "+t.message)}},t.readAsText(e)}document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelectorAll(".collapsible .button-toggle");entityRenderer=new EntityRenderer(".erd-svg"),e.forEach(function(e){e.addEventListener("click",function(e){e.target.closest(".collapsible").classList.toggle("open")})}),editor=new EntityEditor(".entity-editor",{defaultDataType:"VARCHAR",defaultDataLength:50,primaryKeyDataType:"BIGINT",primaryKeyDataLength:20,callbackLoadEntity:function(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),a=document.querySelector('meta[name="database-schema"]').getAttribute("content"),r=document.querySelector('meta[name="database-type"]').getAttribute("content");fetchEntityFromServer(e,r,t,a),fetchConfigFromServer(e,r,t,a)},callbackSaveEntity:function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),r=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,r,e)},callbackSaveDiagram:function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),r=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendDiagramToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,r,e)},callbackLoadTemplate:function(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),a=document.querySelector('meta[name="database-schema"]').getAttribute("content");fetchTemplateFromServer(e,document.querySelector('meta[name="database-type"]').getAttribute("content"),t,a)},callbackSaveTemplate:function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),r=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendTemplateToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,r,e)},callbackSaveConfig:function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),r=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendConfigToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,r,e)}}),document.querySelector('[type="submit"].execute').addEventListener("click",function(e){e.preventDefault(),showConfirmationDialog("Are you sure you want to execute the query?","Execute Query Confirmation","Yes","No",function(t){t&&e.target.closest("form").submit()})}),document.querySelector('[type="button"].save').addEventListener("click",function(e){e.preventDefault();let t=document.querySelector('textarea[name="query"]').value.trim();if(t.length>0){let a=new Blob([t],{type:"text/plain"}),r=URL.createObjectURL(a),n=document.createElement("a");n.href=r,n.download="query.sql",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r)}});let t=document.querySelector('[type="submit"][name="___export_table___"]');null!=t&&t.addEventListener("click",function(e){let t=e.target.getAttribute("value");e.preventDefault(),showConfirmationDialog("Are you sure you want to export the data from the table?","Export Confirmation","Yes","No",function(a){if(a){let r=document.createElement("input");r.type="hidden",r.name="___export_table___",r.value=t,e.target.closest("form").appendChild(r),e.target.closest("form").submit(),e.target.closest("form").removeChild(r)}})});let a=document.querySelector('[type="submit"][name="___export_database___"]');null!=a&&a.addEventListener("click",function(e){let t=e.target.getAttribute("value");e.preventDefault();let a="#exportModal";showExprtDialog(a,'<div class="loading-animation"></div>',"Export Database","Yes","No",function(e){e?startExportDatabase(a):document.querySelector("#exportModal").style.display="none"}),listTableToExport(a,t)}),window.addEventListener("resize",function(){editor.refreshEntities(),editor.updateDiagram()}),document.querySelector(".add-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("ul"),a=new Date().getTime();editor.addDiagram(t,"New Diagram","diagram-"+a,[],!1),editor.saveDiagram()}),document.querySelector('[data-id="all-entities"]').addEventListener("click",function(e){e.preventDefault();let t=e.target.parentNode,a=document.querySelector(".diagram-container");t.closest("ul").querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.classList.remove("active")}),a.querySelectorAll(".diagram").forEach((e,t)=>{e.classList.remove("active")}),t.classList.add("active"),a.querySelector("#all-entities").classList.add("active"),document.querySelector(".entity-editor .left-panel .table-list").querySelectorAll("li").forEach((e,t)=>{let a=e.querySelector('input[type="checkbox"]');a.checked=!1,a.disabled=!0})}),document.addEventListener("change",function(e){if(e.target.closest('.table-list input[type="checkbox"]')){let t=document.querySelector(".diagram-container .diagram.active"),a=t.getAttribute("data-entities").split(","),r=new Set;e.target.closest(".table-list").querySelectorAll('input[type="checkbox"]').forEach(e=>{let t=e.getAttribute("data-name");e.checked&&r.add(t)});let n=a.filter(e=>r.has(e));r.forEach(e=>{n.includes(e)||n.push(e)}),t.setAttribute("data-entities",n.join(",")),editor.saveDiagram()}editor.updateDiagram()}),resizablePanels=new ResizablePanels(".entity-editor",".left-panel",".right-panel",".resize-bar",200),tabsLinkContainer=document.querySelector(".tabs-link-container"),document.querySelector(".tab-mover li a.move-left").addEventListener("click",function(e){e.preventDefault(),updateMarginLeft(-30)}),document.querySelector(".tab-mover li a.move-right").addEventListener("click",function(e){e.preventDefault(),updateMarginLeft(30)}),tabsLinkContainer.addEventListener("wheel",e=>{e.preventDefault();let t=e.deltaY||e.detail||e.wheelDelta;updateMarginLeft(t>0?-30:30)}),init(),$('input[data-type="datetime"]').length&&$('input[data-type="datetime"]').datetimepicker({format:"Y-m-d H:i:s"}),$('input[data-type="date"]').length&&$('input[data-type="date"]').datetimepicker({timepicker:!1,format:"Y-m-d"}),$('input[data-type="time"]').length&&$('input[data-type="time"]').datetimepicker({datepicker:!1,format:"H:i:s"})});let tableIndex=0,maxTableIndex=0,exportConfig={},exportTableList=[],exportFileName="",timeoutDownload=setTimeout("",100),isExporting=!1;function startExportDatabase(e){isExporting||(isExporting=!0,exportDatabase(e))}function exportDatabase(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-type"]').getAttribute("content"),r=document.querySelector('meta[name="database-name"]').getAttribute("content"),n=document.querySelector('meta[name="database-schema"]').getAttribute("content");exportTableList=[],clearTimeout(timeoutDownload),tableIndex=0,exportFileName=new Date().getTime()+".sql",$(e).find("tbody").find("tr").each(function(){let e=$(this).attr("data-table-name"),t=$(this).find('input[name="structure_export[]"]').is(":checked"),a=$(this).find('input[name="data_export[]"]').is(":checked");$(this).attr("data-status","none"),(t||a)&&exportTableList.push({tableName:e,structure:t,data:a})}),maxTableIndex=exportTableList.length,exportConfig={applicationId:t,databaseType:a,databaseName:r,schemaName:n},exportTable(e)}function exportTable(e){if(tableIndex>=maxTableIndex)isExporting=!1,window.open("export-download.php?fileName="+encodeURIComponent(exportFileName));else{let t=exportTableList[tableIndex],a=$(e).find("table tbody").find('tr[data-table-name="'+t.tableName+'"]').attr("data-status","none");null!=a&&a.attr("data-status","in-progress"),$.ajax({type:"POST",url:"export-database.php",data:{...exportConfig,tableName:t.tableName,includeStructure:t.structure?1:0,includeData:t.data?1:0,fileName:exportFileName},dataType:"json",success:function(t){t.success?(null!=a&&a.attr("data-status","finish"),timeoutDownload=setTimeout(function(){tableIndex++,exportTable(e)},20)):null!=a&&a.attr("data-status","error")},error:function(){null!=a&&a.attr("data-status","error")}})}}function listTableToExport(e,t){let a=document.querySelector('meta[name="application-id"]').getAttribute("content"),r=document.querySelector('meta[name="database-type"]').getAttribute("content"),n=document.querySelector('meta[name="database-name"]').getAttribute("content"),i=document.querySelector('meta[name="database-schema"]').getAttribute("content");$.ajax({type:"GET",url:"table-list.php",data:{applicationId:a,databaseType:r,databaseName:n,schemaName:i,tableName:t},success:function(t){$(e).find(".modal-body").empty().append(t),$("#cstructure").on("change",function(){let e=$(this)[0].checked;$(".check-for-structure").each(function(){$(this)[0].checked=e})}),$("#cdata").on("change",function(){let e=$(this)[0].checked;$(".check-for-data").each(function(){$(this)[0].checked=e})})}})}function showExprtDialog(e,t,a,r,n,i){let o=document.querySelector(e),l=o.querySelector(".button-ok"),c=o.querySelector(".button-cancel");function s(){i(!0)}function d(){i(!1)}return o.querySelector(".modal-header h3").innerHTML=a,o.querySelector(".modal-body").innerHTML=t,l.innerHTML=r,c.innerHTML=n,o.style.display="block",l.removeEventListener("click",s),c.removeEventListener("click",d),l.addEventListener("click",s),c.addEventListener("click",d),o}function updateMarginLeft(e){currentMarginLeft+=e;let t=tabsLinkContainer.querySelector("ul");currentMarginLeft=Math.max(Math.min(currentMarginLeft,0),-(t.scrollWidth-tabsLinkContainer.offsetWidth)),t.style.marginLeft=`${currentMarginLeft}px`}function downloadSVG(){let e=document.querySelector(".diagram-container").querySelector(".diagram.active");if(e){let t=e.getAttribute("id");"all-entities"==t?entityRenderer.downloadSVG():diagramRenderer[t].downloadSVG()}}function downloadPNG(){let e=document.querySelector(".diagram-container").querySelector(".diagram.active");if(e){let t=e.getAttribute("id");"all-entities"==t?entityRenderer.downloadPNG():diagramRenderer[t].downloadPNG()}}function showConfirmationDialog(e,t,a,r,n){let i=document.querySelector("#asyncConfirm"),o=i.querySelector(".confirm-ok"),l=i.querySelector(".confirm-cancel");o=removeAllEventListeners(o),l=removeAllEventListeners(l),i.querySelector(".modal-header h3").innerHTML=t,i.querySelector(".modal-body").innerHTML=e,o.innerHTML=a,l.innerHTML=r,i.style.display="block",o.addEventListener("click",function e(){i.style.display="none",n(!0)}),l.addEventListener("click",function e(){i.style.display="none",n(!1)})}function removeAllEventListeners(e){let t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t}function sendEntityToServer(e,t,a,r,n){let i={applicationId:e,databaseType:t,databaseName:a,databaseSchema:r,entities:JSON.stringify(n)},o=new XMLHttpRequest,l=buildUrl("entity",e,t,a,r,"");o.open("POST",l,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status||console.log("An error occurred while sending data to the server"))};let c=new URLSearchParams(i).toString();o.send(c)}function sendDiagramToServer(e,t,a,r,n){let i={applicationId:e,databaseType:t,databaseName:a,databaseSchema:r,diagrams:JSON.stringify(n)},o=new XMLHttpRequest,l=buildUrl("entity",e,t,a,r,"");o.open("POST",l,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status||console.log("An error occurred while sending data to the server"))};let c=new URLSearchParams(i).toString();o.send(c)}function fetchEntityFromServer(e,t,a,r,n,i){let o=new XMLHttpRequest,l=buildUrl("entity",e,t,a,r,"");o.open("GET",l,!0),o.onreadystatechange=function(){if(4===o.readyState){if(200===o.status){let e=o.responseText;try{let t=JSON.parse(e),a=editor.createEntitiesFromJSON(t);editor.entities=a.entities||[],editor.diagrams=a.diagrams||[],editor.refreshEntities(),editor.prepareDiagram(),i&&i(null,t)}catch(r){}}else console.error("An error occurred while fetching data from the server. Status:",o.status)}},o.send()}function sendTemplateToServer(e,t,a,r,n){let i={applicationId:e,databaseType:t,databaseName:a,databaseSchema:r,template:JSON.stringify(n)},o=new XMLHttpRequest,l=buildUrl("template",e,t,a,r,"");o.open("POST",l,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status||console.log("An error occurred while sending data to the server"))};let c=new URLSearchParams(i).toString();o.send(c)}function fetchTemplateFromServer(e,t,a,r,n,i){let o=new XMLHttpRequest,l=buildUrl("template",e,t,a,r,"");o.open("GET",l,!0),o.onreadystatechange=function(){if(4===o.readyState){if(200===o.status){let e=o.responseText;try{let t=JSON.parse(e);editor.template=editor.createTemplateFromJSON(t)}catch(a){console.error(a)}}else console.error("An error occurred while fetching data from the server. Status:",o.status)}},o.send()}function sendConfigToServer(e,t,a,r,n){let i={applicationId:e,databaseType:t,databaseName:a,databaseSchema:r,config:JSON.stringify(n)},o=new XMLHttpRequest,l=buildUrl("config",e,t,a,r,"");o.open("POST",l,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status||console.log("An error occurred while sending data to the server"))};let c=new URLSearchParams(i).toString();o.send(c)}function fetchConfigFromServer(e,t,a,r,n,i){let o=new XMLHttpRequest,l=buildUrl("config",e,t,a,r,"");o.open("GET",l,!0),o.onreadystatechange=function(){if(4===o.readyState){if(200===o.status){let e=o.responseText;try{let t=JSON.parse(e);editor.defaultDataType=t.defaultDataType+"",editor.defaultDataLength=t.defaultDataLength+"",editor.primaryKeyDataType=t.primaryKeyDataType+"",editor.primaryKeyDataLength=t.primaryKeyDataLength+""}catch(a){console.error(a)}}else console.error("An error occurred while fetching data from the server. Status:",o.status)}},o.send()}function buildUrl(e,t,a,r,n,i){return"template"==e?`../lib.ajax/load-template-data.php?applicationId=${encodeURIComponent(t)}&databaseType=${encodeURIComponent(a)}&databaseName=${encodeURIComponent(r)}&databaseSchema=${encodeURIComponent(n)}&entities=${encodeURIComponent(JSON.stringify(i))}`:"config"==e?`../lib.ajax/load-config-data.php?applicationId=${encodeURIComponent(t)}&databaseType=${encodeURIComponent(a)}&databaseName=${encodeURIComponent(r)}&databaseSchema=${encodeURIComponent(n)}&entities=${encodeURIComponent(JSON.stringify(i))}`:`../lib.ajax/load-entity-data.php?applicationId=${encodeURIComponent(t)}&databaseType=${encodeURIComponent(a)}&databaseName=${encodeURIComponent(r)}&databaseSchema=${encodeURIComponent(n)}&entities=${encodeURIComponent(JSON.stringify(i))}`}