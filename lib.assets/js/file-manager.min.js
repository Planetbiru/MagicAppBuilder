let contentModified=!0,fileManagerEditor=null,currentMode=null,modeInput=null;function initFileManager(){document.getElementById("dir-tree").addEventListener("click",function(e){if(e.target){if(e.target.classList.contains("dir")){let t=e.target.dataset.dir,n=e.target.closest("li"),i=n.querySelector("ul");i?n.setAttribute("data-open","true"===n.getAttribute("data-open")?"false":"true"):(i=document.createElement("ul"),n.appendChild(i),loadDirContent(t,i,n),n.setAttribute("data-open","true"))}else if(e.target.classList.contains("file")){let l=e.target;openFile(l.dataset.file,l.dataset.extension)}}}),document.querySelector(".btn-save-file").addEventListener("click",function(e){let t;saveFile(document.querySelector(".file-path").value,fileManagerEditor.getValue())}),document.querySelector(".btn-open-file").addEventListener("click",function(e){let t=document.querySelector(".file-path").value,n=getFileExtension(t);openTextFile(t,n)}),initCodeMirror()}function getCaller(){try{throw Error()}catch(e){let t=e.stack.split("\n");if(t.length>2){let n=t[2],i=n.match(/at (\w+)/);return i?i[1]:"Unknown"}return"Unknown"}}function resetFileManager(){let e=document.querySelector("#dir-tree");fileManagerEditor&&fileManagerEditor.setValue(""),document.querySelector(".btn-save-file").disabled=!0,document.querySelector("#dir-tree").innerHTML="",document.querySelector(".file-path").value="",loadDirContent("",e,null,!0)}function getFileExtension(e){let t=e.match(/\.(\w+)$/);return t?t[1]:""}function format(){let e=fileManagerEditor.lineCount();fileManagerEditor.autoFormatRange({line:0,ch:0},{line:e})}function loadDirContent(e,t,n,i){null!=n&&n.setAttribute("data-loading","true"),increaseAjaxPending(),fetch("lib.ajax/file-manager-load-dir.php?dir="+encodeURIComponent(e)).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=n&&n.removeAttribute("data-loading"),displayDirContent(e,t,i)}).catch(e=>{console.error("There was a problem with the fetch operation:",e),decreaseAjaxPending(),null!=n&&n.removeAttribute("data-loading")})}function displayDirContent(e,t,n){t.innerHTML="",e.forEach(function(e){if("dir"===e.type){let n=document.createElement("li");n.dataset.type=e.type;let i=document.createElement("span");i.textContent=e.name,i.dataset.dir=e.path,i.classList.add("dir"),n.appendChild(i),t.appendChild(n)}else if("file"===e.type){let l=document.createElement("li");l.dataset.type=e.type;let a=document.createElement("span");a.textContent=e.name,a.dataset.file=e.path,a.dataset.extension=e.extension,a.classList.add("file"),l.appendChild(a),t.appendChild(l)}})}function initCodeMirror(){modeInput=document.getElementById("filename"),CodeMirror.modeURL="../lib.assets/cm/mode/%N/%N.js",fileManagerEditor=CodeMirror.fromTextArea(document.getElementById("code"),{lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,indentUnit:4,indentWithTabs:!0}),window.addEventListener("resize",function(e){let t=document.querySelector("#file-content").offsetWidth-16,n=window.innerHeight-160;fileManagerEditor.setSize(t,n)});let e=document.querySelector("#file-content").offsetWidth-16,t=window.innerHeight-160;fileManagerEditor.setSize(e,t)}function saveFile(e,t){let n=new FormData;n.append("file",e),n.append("content",t),increaseAjaxPending(),fetch("lib.ajax/file-manager-save-file.php",{method:"POST",body:n}).then(e=>e.text()).then(e=>{console.log("File saved successfully:",e),decreaseAjaxPending()}).catch(e=>{console.error("Error saving file:",e),decreaseAjaxPending()})}function openFile(e,t){["jpg","jpeg","png","gif","webp","bmp","svg","mp4","mp3","avi","exe","pdf"].includes(t.toLowerCase())?["jpg","jpeg","png","gif","webp","bmp","svg"].includes(t.toLowerCase())?(setDisplayMode("image"),increaseAjaxPending(),fetch("lib.ajax/file-manager-load-image.php?file="+encodeURIComponent(e)).then(e=>e.text()).then(e=>{let t=document.querySelector(".media-display"),n=document.createElement("img");n.src=e,n.style.maxWidth="100%",n.style.maxHeight="400px",t.appendChild(n),decreaseAjaxPending()}).catch(e=>{decreaseAjaxPending()})):fileDiv.textContent="Cannot open this file.":(null===currentMode&&changeMode(e,t),openTextFile(e,t))}function openTextFile(e,t){document.querySelector(".btn-open-file").disabled=!0,document.querySelector(".btn-save-file").disabled=!0,setDisplayMode("text"),document.querySelector(".file-path").value=e,fileManagerEditor.setValue("Loading..."),changeMode("any.txt","txt"),increaseAjaxPending(),fetch("lib.ajax/file-manager-load-file.php?file="+encodeURIComponent(e)).then(e=>e.text()).then(n=>{changeMode(e,t),fileManagerEditor.setValue(n),document.querySelector(".btn-open-file").disabled=!1,document.querySelector(".btn-save-file").disabled=!1,decreaseAjaxPending()}).catch(e=>{document.querySelector(".btn-open-file").disabled=!1,document.querySelector(".btn-save-file").disabled=!1,setDisplayMode(""),decreaseAjaxPending()})}function setDisplayMode(e){"text"===e?(document.querySelector(".image-mode").style.display="none",document.querySelector(".text-mode").style.display="block"):"image"===e&&(document.querySelector(".text-mode").style.display="none",document.querySelector(".image-mode").style.display="block")}function changeMode(e,t){currentMode=t;let n=e,i,l,a=/.+\.([^.]+)$/.exec(n);if(a){let r=CodeMirror.findModeByExtension(a[1]);r&&(i=r.mode,l=r.mime)}else if(/\//.test(n)){let o=CodeMirror.findModeByMIME(n);o&&(i=o.mode,l=n)}else i=l=n;i&&(fileManagerEditor.setOption("mode",l),CodeMirror.autoLoadMode(fileManagerEditor,i))}