class EntityRenderer{constructor(t){this.selector=t,this.svg=document.querySelector(this.selector),this.tables={},this.xPadding=5,this.yPadding=5,this.betweenX=20,this.betweenY=20,this.tableWidth=250,this.maxTop=0,this.maxCol=0,this.lastMaxCol=0,this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.entityStrokeWidth="0.5",this.stroke="#8496B1",this.columnTextColor="#3a4255",this.columnHeight=20,this.columnTypeFontSize=9,this.columnFontSize=11,this.headerBackgroundColor="#d8e8ff",this.buttonSpace=16,this.buttonMargin=6,this.buttonWidth=14,this.buttonHeight=14,this.buttonFontSize=10,this.tableFontSize=12,this.relationStrokeWidth=.7}createERD(t,e,i){this.svg=document.querySelector(this.selector),this.lastMaxCol=0,this.maxCol=0,this.svg.innerHTML="",this.data=t,this.svg.setAttribute("width",e);let s=this.xPadding,a=this.yPadding,n=s,r=a,l=0,o=0;this.data.entities.forEach(t=>{let i=this.createTable(t,t.index,n,r);this.tables[t.name]={table:i,xPos:n,yPos:r},this.maxCol<t.columns.length&&(this.maxCol=t.columns.length),this.lastMaxCol=this.maxCol,n+=this.betweenX+this.tableWidth,++o>l&&(l=o),n>e-this.tableWidth-1&&(n=s,r+=this.maxCol*this.columnHeight+this.betweenY+30,this.maxCol=0,o=0),this.maxTop=r});let h=r;o>0?h+=this.maxCol*this.columnHeight+30:h-=this.betweenY;let d=2*this.xPadding+l*(this.betweenX+this.tableWidth)-this.betweenX+2,c=2*this.yPadding+h-2;this.svg.setAttribute("height",c),this.svg.setAttribute("width",d),i&&this.createRelationships(),this.svg=document.querySelector(this.selector)}createRelationships(){this.data.entities.forEach(t=>{t.columns.forEach((e,i)=>{if(e.name.endsWith("_id")&&!e.primaryKey){let s=e.name.replace("_id","");t.name!=s&&this.tables[s]&&this.createRelationship(t,e,i)}})})}createOffset(t){return t*this.buttonSpace+this.buttonMargin}createTable(t,e,i,s){let a=document.createElementNS("http://www.w3.org/2000/svg","g");a.setAttribute("data-entity",t.name),a.classList.add("svg-entity"),a.setAttribute("data-index",e),a.setAttribute("transform",`translate(${i}, ${s})`);let n=t.columns.length*this.columnHeight+26,r=this.createSvgRect(0,0,this.tableWidth,n,"#ffffff",this.stroke,this.entityStrokeWidth);a.appendChild(r);let l=this.createSvgRect(1,1,this.tableWidth-2,24,this.headerBackgroundColor);a.appendChild(l);let o=this.createSvgForeignText(10,5,this.tableWidth-95,18,t.name);return a.appendChild(o),[{icon:"\uD83D\uDCC4",offset:5,className:"view-data-icon"},{icon:"⬅️",offset:4,className:"move-up-icon"},{icon:"➡️",offset:3,className:"move-down-icon"},{icon:"✏️",offset:2,className:"edit-icon"},{icon:"❌",offset:1,className:"delete-icon"}].forEach(({icon:t,offset:i,className:s})=>{let n=this.tableWidth-this.createOffset(i),r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",n),r.setAttribute("y",17),r.setAttribute("font-size",this.buttonFontSize),r.textContent=t,a.appendChild(r);let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x",n),l.setAttribute("y",7),l.setAttribute("width",this.buttonWidth),l.setAttribute("height",this.buttonHeight),l.setAttribute("fill","transparent"),l.setAttribute("class",s),l.setAttribute("data-index",e),l.style.cursor="pointer",a.appendChild(l)}),t.columns.forEach((t,e)=>{let i=40+e*this.columnHeight,s=26+e*this.columnHeight;if(t.primaryKey){let n=this.createSvgRect(1,s+1,this.tableWidth-2,this.columnHeight-2,"#f4f8ff");a.appendChild(n)}let r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",10),r.setAttribute("y",i),r.setAttribute("font-size",this.columnFontSize),r.setAttribute("fill",this.columnTextColor),r.textContent=t.name,r.classList.add("diagram-column-name"),a.appendChild(r);let l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",this.tableWidth-10),l.setAttribute("y",i),l.setAttribute("font-size",this.columnTypeFontSize),l.setAttribute("fill",this.columnTextColor),l.setAttribute("text-anchor","end");let o=this.getFormattedType(t);l.textContent=o,a.appendChild(l);let h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",0),h.setAttribute("y1",s),h.setAttribute("x2",this.tableWidth),h.setAttribute("y2",s),h.setAttribute("stroke",this.stroke),h.setAttribute("stroke-width",this.entityStrokeWidth),a.appendChild(h)}),this.svg.appendChild(a),a}createSvgRect(t,e,i,s,a="transparent",n="none",r=0){let l=document.createElementNS("http://www.w3.org/2000/svg","rect");return l.setAttribute("x",t),l.setAttribute("y",e),l.setAttribute("width",i),l.setAttribute("height",s),l.setAttribute("fill",a),l.setAttribute("stroke",n),l.setAttribute("stroke-width",r),l}createSvgForeignText(t,e,i,s,a){let n=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");n.setAttribute("x",t),n.setAttribute("y",e),n.setAttribute("width",i),n.setAttribute("height",s);let r=document.createElement("div");return r.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),r.style.cssText=`font-size: 12px; font-family: sans-serif; color: #1d3c86; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: ${s}px;`,r.textContent=a,n.appendChild(r),n}getFormattedType(t){return this.withLengthTypes.includes(t.type)&&t.length>0?`${t.type}(${t.length})`:this.withRangeTypes.includes(t.type)&&null!=t.values?`${t.type}(${t.values})`:`${t.type}`}createRelationship(t,e,i){let s=e.name.replace("_id",""),a=this.getEntityByName(s);if(null!=a){let n=this.getColumnIndex(a,e.name),r=this.tables[t.name].table,l=this.tables[s].table,o=i*this.columnHeight+this.tables[t.name].yPos+36,h=parseInt(r.getAttribute("transform").split(",")[0].replace("translate(","")),d=parseInt(l.getAttribute("transform").split(",")[0].replace("translate(","")),c=n*this.columnHeight+this.tables[s].yPos+36,u,m;h==d?(h+=4,d+=4,u=h-8,m=d-8):h<=d?(h+=this.tableWidth,h-=4,d+=4,u=h+8,m=d-8):(d+=this.tableWidth,h+=4,d-=4,u=h-8,m=d+8);let g=document.createElementNS("http://www.w3.org/2000/svg","circle"),p=document.createElementNS("http://www.w3.org/2000/svg","circle");g.setAttribute("cx",h),g.setAttribute("cy",o),g.setAttribute("r",3),g.setAttribute("fill","#2A56BD"),p.setAttribute("cx",d),p.setAttribute("cy",c),p.setAttribute("r",3),p.setAttribute("fill","#CC0088");let b=document.createElementNS("http://www.w3.org/2000/svg","path"),w=`M ${h} ${o} L ${u} ${o} L ${m} ${c} L ${d} ${c}`;b.setAttribute("d",w),b.setAttribute("stroke","#2A56BD"),b.setAttribute("stroke-width",this.relationStrokeWidth),b.setAttribute("fill","transparent"),this.svg.appendChild(b),this.svg.appendChild(g),this.svg.appendChild(p)}}getEntityByName(t){return this.data.entities.find(e=>e.name===t)}getColumnIndex(t,e){return t.columns.findIndex(t=>t.name===e)}downloadSVG(){let t=this.getFileName()+".svg";this.exportToSVG(this.svg,t)}downloadPNG(){let t=this.getFileName()+".png";this.exportToPNG(this.svg,t)}downloadMD(){let t=this.getFileName()+".md";this.exportToMD(t)}getFileName(){let t=document.querySelector(".diagram-list.tabs").querySelector('.diagram-tab.active input[type="text"]'),e=document.querySelector('meta[name="application-id"]').getAttribute("content"),i=document.querySelector('meta[name="database-name"]').getAttribute("content"),s="",a="";return a=""!=i?i:e,s=null!=t?a+" - "+t.value:a}generateSVGString(t){let e=t.clientWidth,i;return`
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${e}" height="${t.clientHeight+2}">
            <defs>
                <style type="text/css">
                    <![CDATA[
                        text {
                            font-family: 'Arial', sans-serif;
                        }
                        .move-up-icon, .move-down-icon, .edit-icon, .delete-icon {
                            display: none;
                            visibility: hidden;
                            opacity: 0;
                            pointer-events: none;
                        }
                    ]]>
                </style>
            </defs>
            ${new XMLSerializer().serializeToString(t)}
        </svg>`}exportToSVG(t,e="exported-image.svg"){let i=this.generateSVGString(t),s=new Blob([i],{type:"image/svg+xml"}),a=URL.createObjectURL(s),n=document.createElement("a");n.href=a,n.download=e,n.click(),URL.revokeObjectURL(a)}exportToPNG(t,e="exported-image.png"){let i=t.clientWidth,s=t.clientHeight,a=document.createElement("canvas");a.width=i,a.height=s;let n=a.getContext("2d"),r=this.generateSVGString(t),l="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(r),o=new Image;o.onload=function(){n.drawImage(o,0,0);let t=a.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()},o.onerror=function(t){console.error("Error loading the SVG image:",t)},o.src=l}exportToMD(t="exported.md"){let e=this,i=`# Entity Documentation

`;i+=`This document provides an overview of all entity structures in the system, including table metadata and column definitions.

`,i+=`---

`,i+=`## Entities

`,this.data.entities.forEach(t=>{i+=`### ${t.name}

`,t.description&&(i+=`**Description:** ${t.description}

`),t.creationDate&&(i+=`**Created on:** ${e.formatDate(t.creationDate)}
`),t.creator&&""!==t.creator&&"{{userName}}"!==t.creator&&(i+=`**Created by:** ${t.creator}
`),t.modificationDate&&(i+=`**Updated on:** ${e.formatDate(t.modificationDate)}
`),t.modifier&&""!==t.modifier&&"{{userName}}"!==t.modifier&&(i+=`**Updated by:** ${t.modifier}
`),i+=`
`;let s="Column Name",a="Type",n="Null",r=Math.max(...t.columns.map(t=>t.name.length),s.length),l=Math.max(...t.columns.map(t=>this.getFormattedType(t).length),a.length),o=Math.max(n.length,4);r<30&&(r=30),l<13&&(l=13),i+=`| ${s.padEnd(r)} | ${a.padEnd(l)} | ${n.padEnd(o)} | ${"Key".padEnd(3)} | ${"AI".padEnd(3)} |
`,i+=`| ${"-".repeat(r)} | ${"-".repeat(l)} | ${"-".repeat(o)} | ${"-".repeat(3)} | ${"-".repeat(3)} |
`,t.columns.forEach(t=>{let e=this.getFormattedType(t),s=t.nullable?"YES":"NO",a;i+=`| ${t.name.padEnd(r)} | ${e.padEnd(l)} | ${s.padEnd(o)} | ${(t.primaryKey?"YES":"NO").padEnd(3)} | ${(t.autoIncrement?"YES":"NO").padEnd(3)} |
`}),i+=`
`}),i+=`---

`,i+=`*Generated automatically by MagicAppBuilder.*
`,i+=`*This file reflects the current state of the data entities in the system as of ${e.formatDate(new Date)}.*
`;let s=new Blob([i],{type:"text/markdown"}),a=URL.createObjectURL(s),n=document.createElement("a");n.href=a,n.download=t,n.click(),URL.revokeObjectURL(a)}formatDate(t){return new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(",","")}getSVGElement(){return this.svg}}