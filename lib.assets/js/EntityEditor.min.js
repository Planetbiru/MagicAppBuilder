class EntityEditor{constructor(e,t={}){this.setting={defaultDataType:"VARCHAR",defaultDataLength:"48",primaryKeyDataType:"VARCHAR",primaryKeyDataLength:"40"},this.keyWords=["absolute","action","add","after","aggregate","alias","all","allocate","alter","analyse","analyze","and","any","are","array","as","asc","assertion","at","authorization","avg","before","begin","between","binary","bit","bit_length","blob","boolean","both","breadth","by","call","cascade","cascaded","case","cast","catalog","char","character","character_length","char_length","check","class","clob","close","coalesce","collate","collation","column","commit","completion","connect","connection","constraint","constraints","constructor","continue","convert","corresponding","count","create","cross","cube","current","current_date","current_path","current_role","current_time","current_timestamp","current_user","cursor","cycle","data","date","day","deallocate","dec","decimal","declare","default","deferrable","deferred","delete","depth","deref","desc","describe","descriptor","destroy","destructor","deterministic","diagnostics","dictionary","disconnect","distinct","do","domain","double","drop","dynamic","each","else","end","end-exec","equals","escape","every","except","exception","exec","execute","exists","external","extract","false","fetch","first","float","for","foreign","found","free","from","full","function","general","get","global","go","goto","grant","group","grouping","having","host","hour","identity","ignore","immediate","in","indicator","initialize","initially","inner","inout","input","insensitive","insert","int","integer","intersect","interval","into","is","isolation","iterate","join","key","language","large","last","lateral","leading","left","less","level","like","limit","local","localtime","localtimestamp","locator","lower","map","match","max","min","minute","modifies","modify","month","names","national","natural","nchar","nclob","new","next","no","none","not","null","nullif","numeric","object","octet_length","of","off","offset","old","on","only","open","operation","option","or","order","ordinality","out","outer","output","overlaps","pad","parameter","parameters","partial","path","placing","position","postfix","precision","prefix","preorder","prepare","preserve","primary","prior","privileges","procedure","public","read","reads","real","recursive","ref","references","referencing","relative","restrict","result","return","returns","revoke","right","role","rollback","rollup","routine","row","rows","savepoint","schema","scope","scroll","search","second","section","select","sequence","session","session_user","set","sets","size","smallint","some","space","specific","specifictype","sql","sqlcode","sqlerror","sqlexception","sqlstate","sqlwarning","start","state","statement","static","structure","substring","sum","system_user","table","temporary","terminate","than","then","time","timestamp","timezone_hour","timezone_minute","to","trailing","transaction","translate","translation","treat","trigger","trim","true","under","union","unique","unknown","unnest","update","upper","usage","user","using","value","values","varchar","variable","varying","view","when","whenever","where","with","without","work","write","year","zone"],Object.assign(this.setting,t),this.selector=e,this.entities=[],this.diagrams=[],this.currentEntityIndex=-1,this.mysqlDataTypes=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT","NUMERIC","DECIMAL","DOUBLE","FLOAT","BIT","DATE","TIME","DATETIME","TIMESTAMP","YEAR","LONGTEXT","MEDIUMTEXT","TEXT","TINYTEXT","VARCHAR","CHAR","ENUM","SET","LONGBLOB","MEDIUMBLOB","BLOB","TINYBLOB","UUID","VARBINARY","BINARY","POLYGON","LINESTRING","POINT","GEOMETRY","JSON",],this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.defaultLength={BIGINT:20,INT:11,MEDIUMINT:8,SMALLINT:5,TINYINT:4},this.autonumberTypes=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT"],this.addDomListeners(),this.callbackLoadEntity=this.setting.callbackLoadEntity,this.callbackSaveEntity=this.setting.callbackSaveEntity,this.callbackSaveDiagram=this.setting.callbackSaveDiagram,this.callbackLoadTemplate=this.setting.callbackLoadTemplate,this.callbackSaveTemplate=this.setting.callbackSaveTemplate,this.callbackSaveConfig=this.setting.callbackSaveConfig,this.defaultDataType=this.setting.defaultDataType+"",this.defaultDataLength=this.setting.defaultDataLength+"",this.primaryKeyDataType=this.setting.primaryKeyDataType+"",this.primaryKeyDataLength=this.setting.primaryKeyDataLength+"","function"==typeof this.callbackLoadEntity&&this.callbackLoadEntity(),"function"==typeof this.callbackLoadTemplate&&this.callbackLoadTemplate(),this.template={columns:[]},this.clearBeforeImport=!0,this.dragSrcRow=null,this.tbody=null,this.operation="create",this.currentEntityData=[],this.indexDraft=[],this.systemEntities=["admin","admin_level","admin_profile","admin_role","menu_cache","menu_group_translation","menu_translation","message","message_folder","module","module_group","notification","user_activity","user_password_history",],this.db=null,this.parsedTableData={},this.maxLength={},this.graphqlAppData={custom:!0,system:!1,inMemoryCache:!1,entities:[],entitySelector:[]},this.graphqlAppProfile={},this.foreignKeyDraft={}}getEntityByName(e){for(let t of this.entities)if(e===t.name)return t;return null}generateColumnFromSchemaProperties(e,t){let a=this,i=t.map(t=>{let i=a.snakeize(t.name),n=a.isLikePk(e,i),l=a.graphQLtoSQLType(t.type,n),r=l.columnType,s=l.length;return new Column(i,r,s,t.nullable,null,n,!1,null,null)});return i}graphQLtoSQLType(e,t){let a="TEXT",i="",n={String:"TEXT",Int:"BIGINT",Float:"DOUBLE",Boolean:"TINYINT",ID:"VARCHAR"};return void 0!==n[e]&&(a=n[e]),"TEXT"==a&&t&&(a="VARCHAR"),"VARCHAR"==a?i="255":"BIGINT"==a?i="20":"Boolean"==e&&(i="1"),{columnType:a,length:i}}isLikePk(e,t){return`${e}_id`==t}addDomListeners(){let e=this;qs(".check-all-entity-structure").addEventListener("change",t=>{let a=t.target.checked,i=t.target.closest("table").querySelector("tbody").querySelectorAll(".selected-entity-structure");i&&i.forEach(e=>{e.checked=a}),e.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex())}),document.addEventListener("change",function(t){if(t.target.classList.contains("column-primary-key")){let a=t.target.checked,i=t.target.closest("tr");a?(i.querySelector(".column-type").value=e.primaryKeyDataType,e.updateColumnLengthInput(i.querySelector(".column-type")),i.querySelector(".column-length").value=e.primaryKeyDataLength,i.querySelector(".column-nullable").checked=!1,i.querySelector(".column-nullable").disabled=!0,i.querySelector(".column-primary-key").checked?(e.autonumberTypes.includes(i.querySelector(".column-type").value)?i.querySelector(".column-autoIncrement").disabled=!1:(i.querySelector(".column-autoIncrement").disabled=!0,i.querySelector(".column-autoIncrement").checked=!1),i.classList.add("is-primary-key")):i.classList.remove("is-primary-key")):(i.querySelector(".column-nullable").disabled=!1,i.classList.remove("is-primary-key"))}}),qs(this.selector+" .import-file-json").addEventListener("change",function(){let e=this.files[0];e?editor.importJSON(e,function(e,t){let{applicationId:a,databaseName:i,databaseSchema:n,databaseType:l}=getMetaValues();sendEntityToServer(a,l,i,n,e),sendDiagramToServer(a,l,i,n,t)}):console.error("Please select a JSON file first.")}),qs(this.selector+" .import-file-sql").addEventListener("change",function(){let e=this.files[0];e?editor.importSQLFile(e,function(e){let{applicationId:t,databaseName:a,databaseSchema:i,databaseType:n}=getMetaValues();sendEntityToServer(t,n,a,i,e)}):console.error("Please select a JSON file first.")}),qs(this.selector+" .import-file-sheet").addEventListener("change",function(){let t=this.files[0];t?editor.importSheetFile(t,function(t,a,i,n,l){if("csv"==t||"dbf"==t){let r=e.toValidTableName(a),s=e.generateCreateTable(n,l);e.currentEntityData=l,e.importFromSheet(s,r)}else if("xls"==t||"xlsx"==t||"ods"==t){let o=e.toValidTableName(i),c=e.generateCreateTable(n,l);e.currentEntityData=l,e.importFromSheet(c,o)}}):console.error("Please select a JSON file first.")}),qs(this.selector+" .import-file-graphql").addEventListener("change",function(){let e=this.files[0];e?editor.processGraphQLSchema(e,function(e){let{applicationId:t,databaseName:a,databaseSchema:i,databaseType:n}=getMetaValues();sendEntityToServer(t,n,a,i,e)}):console.error("Please select a GraphQL Schema file first.")}),qs(this.selector).addEventListener("keypress",function(t){"Enter"==t.key&&(t.target.closest(".entity-container .entity-name")||t.target.closest(".entity-container .column-name")?e.addColumnIfValid(t.target):t.target.closest(".template-container .column-name")&&e.addColumnTemplateIfValid(t.target))}),this.initIconEvent()}addColumnIfValid(e){let t=e.value.toLowerCase();this.keyWords.some(e=>e.toLowerCase()===t)?this.showAlertDialog(`The word "${e.value}" is reserved and cannot be used. Please choose another one.`,"Reserved Word","Close",function(){e.select()}):this.addColumn(!0)}addColumnTemplateIfValid(e){let t=e.value.toLowerCase();this.keyWords.some(e=>e.toLowerCase()===t)?this.showAlertDialog(`The word "${e.value}" is reserved and cannot be used. Please choose another one.`,"Reserved Word","Close",function(){e.select()}):this.addColumnTemplate(!0)}initIconEvent(){let e=this;entityRenderer.svg.addEventListener("click",function(t){t.target.closest(".erd-svg .view-data-icon")&&e.viewData(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .move-down-icon")&&e.moveEntityUp(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .move-up-icon")&&e.moveEntityDown(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .edit-icon")&&e.editEntity(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .delete-icon")&&e.deleteEntity(parseInt(t.target.dataset.index))})}isForeignKeyContains(e,t){if(!e)return!1;let a=Array.isArray(e)?e:Object.values(e);return a.some(e=>e.columnName==t)}hasColumnIndex(e,t){if(!e)return!1;let a=Array.isArray(e)?e:Object.values(e);return a.some(e=>e.columns&&e.columns.includes(t))}getForeignKeyByColumnName(e,t){if(!e)return null;let a=Array.isArray(e)?e:Object.values(e);return a.find(e=>e.columnName==t)||null}showEditor(e=-1){if(e>=0){this.operation="update",this.currentEntityIndex=e;let t=this.entities[e];this.indexDraft=JSON.parse(JSON.stringify(t.indexes||[])),qs(this.selector).dataset.state="update",qs(this.selector+" .entity-name").value=t.name,qs(this.selector+" .entity-columns-table-body").innerHTML="",t.columns.forEach(e=>this.addColumnToTable(e,!1,!1))}else{this.operation="create",this.indexDraft=[],this.currentEntityIndex=-1;let a=this.getNewTableName();qs(this.selector).dataset.state="create",qs(this.selector+" .entity-name").value=a,qs(this.selector+" .entity-columns-table-body").innerHTML=""}qs(this.selector+" .button-container").style.display="none",qs(this.selector+" .entity-container").style.display="block",qs(this.selector+" .template-container").style.display="none",qs(this.selector+" .editor-form").style.display="block",-1==e&&qs(this.selector+" .entity-name").select()}getNewTableName(){let e=0,t="new_table",a=this.entities.map(e=>e.name.toLowerCase());for(;a.includes(t.toLowerCase());)t=`new_table_${++e}`;return t}importFromSheet(e,t){this.operation="create",this.currentEntityIndex=-1,t=t||this.getNewTableName(),qs(this.selector+" .entity-name").value=t,qs(this.selector+" .entity-columns-table-body").innerHTML="",e.forEach(e=>{this.addColumnToTable(e,!1,!0)}),qs(this.selector+" .button-container").style.display="none",qs(this.selector+" .entity-container").style.display="block",qs(this.selector+" .template-container").style.display="none",qs(this.selector+" .editor-form").style.display="block",qs(this.selector+" .entity-name").select()}addColumnToTable(e,t=!1,a=!1){let i=qs(this.selector+" .entity-columns-table-body"),n=document.createElement("tr"),l=null==e.length?"":e.length.toString().replace(/\D/g,""),r=null==e.values?"":e.values,s=null==e.default?"":e.default,o=e.type.split("(")[0].trim(),c="disabled",d=e.name,h=this.maxLength[d]??"0";"BIGINT"==o.toUpperCase()&&""==l?l="20":"0"!=h&&(l=h);let m="";e.primaryKey?m+=" disabled":e.nullable&&(m+=" checked"),(e.primaryKey&&-1!=o.toLowerCase().indexOf("int")||e.autoIncrement)&&(c="");let u=e.description?e.description:"",p=this.entities?.[this.currentEntityIndex],y=this.isForeignKeyContains(p?.foreignKeys,e.name),g=this.hasColumnIndex(p?.indexes,e.name);y&&n.classList.add("has-foreign-key"),g&&n.classList.add("has-index"),e.primaryKey&&n.classList.add("is-primary-key"),n.innerHTML=`
<td class="drag-handle"></td>
<td class="column-action">
    <button onclick="editor.foreignKeyEdit(this)" class="icon-emoji icon-edit"></button>
    <button onclick="editor.removeColumn(this)" class="icon-emoji icon-delete"></button>
    <button onclick="editor.moveUp(this)" class="icon-emoji icon-move-up"></button>
    <button onclick="editor.moveDown(this)" class="icon-emoji icon-move-down"></button>
</td>
<td class="entity-column-name"><input type="text" class="column-name" value="${e.name}" data-original-name="${d}" placeholder="Column Name"></td>
<td>
    <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
        ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===o?"selected":""}>${e}</option>`).join("")}
    </select>
</td>
<td><input type="text" class="column-length" value="${l}" max="${h}" placeholder="Length" style="display: ${this.withLengthTypes.includes(o)?"inline-block":"none"};"></td>
<td><input type="text" class="column-enum" value="${r}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(o)||this.withRangeTypes.includes(o)?"inline":"none"};"></td>
<td><input type="text" class="column-default" value="${s}" placeholder="Default Value"></td>
<td class="column-nl"><input type="checkbox" class="column-nullable"${m}></td>
<td class="column-pk"><input type="checkbox" class="column-primary-key" ${e.primaryKey?"checked":""}></td>
<td class="column-ai"><input type="checkbox" class="column-autoIncrement" ${e.autoIncrement?"checked":""} ${c}></td>
            <td><input type="text" class="column-description" value="${u}" placeholder="Description"></td>
        `,i.appendChild(n),this.initDraggableRow(n),t&&n.querySelector(".column-name").select()}showIndexEditor(e){if(!e){this.showAlertDialog("Please enter an entity name first.","Entity Name Required","OK");return}let t=qs("#indexEditorModal");if(!t){console.error("Index editor modal (#indexEditorModal) not found in the DOM.");return}t.querySelector(".label-entity-name").innerHTML=`Entity Name : <strong>${e.name}</strong>`;let a=t.querySelector("#index-editor-table tbody");a.innerHTML="",this.indexDraft=e.indexes;let i=[];e.columns.forEach(e=>{i.push(e.name)}),(this.indexDraft||[]).forEach(e=>{this.addIndexRowToModal(a,i,e)}),t.querySelector(".add-index-row").onclick=()=>{this.addIndexRowToModal(a,i)},t.querySelector(".add-index-from-fk").onclick=()=>{this.addIndexFromForeignKey(a,i,e)},t.querySelector(".save-indexes").onclick=()=>{let i=[];a.querySelectorAll("tr").forEach(e=>{let t=e.querySelector(".index-name").value.trim(),a=e.querySelector(".index-unique").checked,n=Array.from(e.querySelector(".index-columns").selectedOptions).map(e=>e.value);t&&n.length>0&&i.push({name:t,columns:n,unique:a})}),this.indexDraft=i,e.indexes=i;this.entities?.[this.currentEntityIndex]?.name==e.name&&qsa(this.selector+" #table-entity-editor tbody tr").forEach(e=>{let t=e.querySelector(".column-name").value;this.hasColumnIndex(this.indexDraft,t)?e.classList.add("has-index"):e.classList.remove("has-index")}),t.style.display="none",this.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex()),this.callbackSaveEntity(this.entities)},t.style.display="block"}addIndexRowToModal(e,t,a={}){let i=document.createElement("tr"),n=a.name||"",l=a.columns||[],r=a.unique||!1,s=t.map(e=>`<option value="${e}" ${l.includes(e)?"selected":""}>${e}</option>`).join("");i.innerHTML=`
            <td align="center"><a href="javascript:" class="remove-index-row">❌</a></td>
            <td class="td-index-name"><input type="text" class="form-control index-name" value="${n}" placeholder="e.g., idx_name_status"></td>
            <td class="td-index-columns">
                <select class="form-control index-columns" multiple style="min-height: 80px;">
                    ${s}
                </select>
            </td>
            <td class="td-index-unique"><input type="checkbox" class="index-unique" ${r?"checked":""}></td>
        `,i.querySelector(".remove-index-row").onclick=()=>{i.remove()},e.appendChild(i)}addIndexFromForeignKey(e,t,a){let i=[];e.querySelectorAll("tr").forEach(e=>{let t=e.querySelector(".index-name").value,a=Array.from(e.querySelector(".index-columns").selectedOptions).map(e=>e.value);i.push({name:t,columns:a})});let n=a.foreignKeys||[];Array.isArray(n)||(n=Object.values(n)),n.forEach(a=>{if(!a.columnName)return;let n=a.name||"";n=n.startsWith("fk_")?"idx_"+n.substring(3):"idx_"+n;let l=a.columnName.split(",").map(e=>e.trim());i.some(e=>{if(e.name==n)return!0;if(e.columns.length!==l.length)return!1;for(let t=0;t<l.length;t++)if(e.columns[t]!==l[t])return!1;return!0})||(this.addIndexRowToModal(e,t,{name:n,columns:l,unique:!1}),i.push({name:n,columns:l}))})}foreignKeyEdit(e){let t=e.closest("tr"),a=t.querySelector(".column-name").value,i=qs(this.selector+" .entity-name").value;a&&this.showForeignKeyEditor(i,a,t)}showForeignKeyEditor(e,t,a){let i=this,n=qs("#foreignKeyModal"),l=`fk_${e}_${t}`,r=this.getEntityByName(e);this.foreignKeyDraft[e]&&Array.isArray(this.foreignKeyDraft[e])||(this.foreignKeyDraft[e]=r.foreignKeys);let s=this.getForeignKeyByColumnName(r.foreignKeys,t)||null;n.querySelector(".reference_table_selector").innerHTML="";let o="",c="",d="";if(this.entities.forEach(a=>{if(a.name!==e){let i=document.createElement("option");i.value=a.name,i.textContent=a.name,n.querySelector(".reference_table_selector").appendChild(i),(s?.referencedTable==a.name||`${a.name}_id`==t)&&(i.selected=!0,d=a.name)}}),s?(o=s.referencedTable,c=s.referencedColumn,l=s.name):(c=t,o=d),n.querySelector(".entity_name_selector").value=e,n.querySelector(".column_name_selector").value=t,n.querySelector(".foreign_key_name_selector").value=t,n.querySelector(".reference_table_selector").addEventListener("change",function(){let e=this.value,t=editor.getEntityByName(e),a=n.querySelector(".reference_column_selector");a.innerHTML="",t&&t.columns.forEach(e=>{let t=document.createElement("option");t.value=e.name,t.textContent=e.name,a.appendChild(t)})}),o){let h=editor.getEntityByName(o),m=n.querySelector(".reference_column_selector");m.innerHTML="",h&&h.columns.forEach(e=>{let t=document.createElement("option");t.value=e.name,t.textContent=e.name,e.name==c&&(t.selected=!0),m.appendChild(t)})}let u=qs(".save-foreign-key"),p=qs(".cancel-foreign-key"),y=qs(".delete-foreign-key"),g=()=>{let l=n.querySelector(".reference_table_selector").value,r=n.querySelector(".reference_column_selector").value,s=n.querySelector(".on_update_action_selector").value,o=n.querySelector(".on_delete_action_selector").value,c=n.querySelector(".foreign_key_name_selector").value;i.foreignKeyDraft[e]=i.foreignKeyDraft[e]||[],i.foreignKeyDraft[e].push({name:c,columnName:t,referencedTable:l,referencedColumn:r,onUpdate:s,onDelete:o}),a.classList.add("has-foreign-key"),u.removeEventListener("click",g),p.removeEventListener("click",f),n.style.display="none",i.exportToSQL(i.getSelectedDialect(),i.isGenerateForeignKey(),i.isGenerateIndex())},f=()=>{u.removeEventListener("click",g),p.removeEventListener("click",f),n.style.display="none"},E=()=>{let l=[];i.foreignKeyDraft[e]?.forEach(e=>{e.columnName!=t&&l.push(e)}),a.classList.remove("has-foreign-key"),i.foreignKeyDraft[e]=l,n.style.display="none"};n.style.display="block",u.onclick=g,p.onclick=f,y.onclick=E}excludeSuffixId(e){return e.length>3&&e.endsWith("_id")?e.substring(0,e.length-3):e}createInputText(e,t){return`<input type="text" class="form-control ${e}" value="${t}">`}createSelectOption(e,t,a,i=null){if(!Array.isArray(a))return console.warn("Options must be an array."),"";let n=e=>String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),l="";i&&(l=` onchange="${i}"`);let r=`<select${e?` class="form-control ${n(e)}"`:""}${l}>\r
`;return r+=`<option value=""></option>\r
`,a.forEach(e=>{let a="",i="";"string"==typeof e?(a=e,i=e):"object"==typeof e&&null!==e&&(a=e.value??"",i=e.label??e.value??"");let l=null!=t&&a==t?" selected":"";r+=`<option value="${n(a)}"${l}>${n(i)}</option>\r
`}),r+=`</select>\r
`}removeForeignKey(e){let t=e.closest("tr");return t.parentNode.removeChild(t),!1}addForeignKey(e){let t=e.closest(".modal").querySelector("tbody"),a=selectedElement.dataset.entity,i=[],n=[],l="";t.querySelectorAll(".column-name")?.forEach(e=>{i.push(e.value)});let r=this.getEntityByName(a);r.columns.forEach(e=>{n.push(e.name),i.includes(e.name)||e.primaryKey||""!=l||(l=e.name)});let s={name:`fk_${a}_${l}`,columnName:l,referencedTable:null,referencedColumn:null,onUpdate:"NO ACTION",onDelete:"NO ACTION",draft:!0};t.appendChild(this.createForeignKeyRow(s,r))}updateForeignKeyColumn(e){let t=e.closest("tr"),a=e.value,i=selectedElement.dataset.entity,n=`${i}_${a}`;t.querySelector(".foreign-key-name").value=n}updateForeignKeyReferencedColumn(e){let t=e.closest("tr"),a=e.value,i=t.querySelector(".referenced-column"),n=i.value;i.dataset.currentValue=n;let l=this.getEntityByName(a),r=t.querySelector(".referenced-column");r.innerHTML="",l&&l.columns.forEach(e=>{r.appendChild(this.createOption(e))})}createOption(e){let t=document.createElement("option");return t.value=e.name,t.textContent=e.name,e.primaryKey&&t.setAttribute("selected","selected"),t}createForeignKeyRow(e,t){let a=[],i=[],n=[];if(this.entities.forEach(e=>{a.push(e.name)}),t.columns.forEach(e=>{i.push(e.name)}),!e.referencedTable){let l=this.excludeSuffixId(e.columnName);l&&a.includes(l)&&(e.referencedTable=l)}this.getEntityByName(e.referencedTable)?.columns.forEach(t=>{n.push(t.name),!e.referencedColumn&&t.primaryKey&&(e.referencedColumn=t.name)});let r=["NO ACTION","RESTRICT","CASCADE","SET NULL"],s=document.createElement("tr");return s.innerHTML=`<td align="center"><a href="javascript:" onclick="return editor.removeForeignKey(this)">❌</a></td>
        <td>${this.createSelectOption("column-name",e.columnName,i,"editor.updateForeignKeyColumn(this)")}</td>
        <td>${this.createInputText("foreign-key-name",e.name)}</td>
        <td>${this.createSelectOption("referenced-table",e.referencedTable,a,"editor.updateForeignKeyReferencedColumn(this)")}</td>
        <td>${this.createSelectOption("referenced-column",e.referencedColumn,n)}</td>
        <td>${this.createSelectOption("on-update",e.onUpdate,r)}</td>
        <td>${this.createSelectOption("on-delete",e.onDelete,r)}</td>`,e.draft?s.classList.add("pk-draft"):s.classList.add("pk-saved"),s}editForeignKeys(){let e=qs(".entity-container #entity-name").value,t=this.getEntityByName(e);this.showForeignKeyEditorBulk(t)}manageIndexes(){let e=qs(".entity-container #entity-name").value,t=this.getEntityByName(e);this.showIndexEditor(t)}editForeignKeyContextMenu(e){let t=this.getEntityByName(selectedElement.dataset.entity);return this.showForeignKeyEditorBulk(t),e.preventDefault(),e.stopPropagation(),!1}showForeignKeyEditorBulk(e){if(!e){this.showAlertDialog("Please enter an entity name first.","Entity Name Required","OK");return}let t=qs("#foreignKeyBulkModal"),a=[];this.entities.forEach(e=>{a.push(e.name)});let i=qs(".save-foreign-key-bulk"),n=qs(".cancel-foreign-key-bulk"),l=e.foreignKeys||[];if(Array.isArray(l)){let r={};l.forEach(e=>r[e.columnName]=e),this.foreignKeyDraft[e.name]=JSON.parse(JSON.stringify(r))}else this.foreignKeyDraft[e.name]=JSON.parse(JSON.stringify(l));e.columns.forEach(t=>{let i=this.excludeSuffixId(t.name);i!=e.name&&!this.foreignKeyDraft[e.name][t.name]&&i&&a.includes(i)&&t.name.endsWith("_id")&&(this.foreignKeyDraft[e.name][t.name]={name:`fk_${e.name}_${t.name}`,columnName:t.name,referencedTable:i,referencedColumn:t.name,onUpdate:"NO ACTION",onDelete:"NO ACTION",draft:!0})});let s=t.querySelector(".foreign-key-editor-table tbody");t.querySelector(".label-entity-name").innerHTML=`Entity Name : <strong>${e.name}</strong>`,s.innerHTML="",Object.entries(this.foreignKeyDraft[e.name]).forEach(([t,a])=>{s.appendChild(this.createForeignKeyRow(a,e))}),t.style.display="block";let o=()=>{let a={},l=!0,r=s.querySelectorAll("tr");if(r&&r.forEach(e=>{let t=e.querySelector(".foreign-key-name").value,i=e.querySelector(".column-name").value,n=e.querySelector(".referenced-table").value,r=e.querySelector(".referenced-column").value,s=e.querySelector(".on-update").value,o=e.querySelector(".on-delete").value;if(""==t.trim()||""==i.trim()||""==n.trim()||""==r.trim()||""==s.trim()||""==o.trim()){let c=`Invalid foreign key definition for ${i}.`;this.showAlertDialog(c,"Invalid Foreign Key","Close"),l=!1;return}a[i]={name:t,columnName:i,referencedTable:n,referencedColumn:r,onUpdate:s,onDelete:o}}),l){e.foreignKeys=Object.values(a),this.callbackSaveEntity(this.entities),this.renderEntities(),this.updateDiagram();let d=qs(".tabs-link-container li.diagram-tab.active");d&&this.selectDiagram(d),this.cancelEdit(),i.removeEventListener("click",o),n.removeEventListener("click",c),t.style.display="none",this.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex())}},c=()=>{i.removeEventListener("click",o),n.removeEventListener("click",c),t.style.display="none"};i.addEventListener("click",o),n.addEventListener("click",c),hideContextMenu()}initDraggableRow(e){let t=this;(void 0===t.tbody||null===t.tbody)&&(t.tbody=e.closest("tbody")),"true"!==e.dataset.hasDragEvent&&(e.dataset.hasDragEvent="true",e.addEventListener("mousedown",function(t){let a=t.target.tagName,i=["INPUT","TEXTAREA","SELECT"].includes(a);e.setAttribute("draggable",i?"false":"true")}),e.addEventListener("dragstart",function(e){t.dragSrcRow=this,this.classList.add("dragging"),e.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",function(){this.classList.remove("dragging")}),e.addEventListener("dragover",function(e){e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("over")}),e.addEventListener("dragleave",function(){this.classList.remove("over")}),e.addEventListener("drop",function(e){e.preventDefault();let a=this.closest("tbody");if(t.dragSrcRow!==this){let i=Array.from(a.children),n=i.indexOf(t.dragSrcRow),l=i.indexOf(this);n<l?a.insertBefore(t.dragSrcRow,this.nextSibling):a.insertBefore(t.dragSrcRow,this),"function"==typeof t.updateRowNumbers&&t.updateRowNumbers()}this.classList.remove("over")}))}addColumn(e=!1){let t=this.selector+" .entity-container .entity-name",a=qs(t),i=a.value;if("create"==this.operation&&this.isEntityExists(i)){this.showConfirmationDialog(`Entity '${i}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(a.value=`${i}_new`,a.select())});return}let n=qsa(this.selector+" .entity-container .column-name").length,l=0===n?`${i}_id`:`${i}_col${0===n?"":n+1}`,r=new Column(l,this.defaultDataType,this.defaultDataLength);r.nullable=!0,this.addColumnToTable(r,e,!0);let s=qs(this.selector+" .entity-container .table-container");s.scrollTop=s.scrollHeight}isEntityExists(e){for(let t of this.entities)if(t.name===e)return!0;return!1}hasPrimaryKey(){let e=qsa(this.selector+" #table-entity-editor .column-primary-key");for(let t of e)if(t.checked)return!0;return!1}saveEntity(){let e=this.selector+" .entity-container .entity-name",t=qs(e),a=t.value;if(!this.hasPrimaryKey()){this.showAlertDialog("A primary key is required before saving the entity.","Primary Key Required","OK");return}let i=this.checkDuplicatedColumn();if(i){this.showAlertDialog(`Duplicate column name: '${i.name}'`,"Duplicated Column Name","OK",function(){i.element.select()});return}if("create"==this.operation&&this.isEntityExists(a)){this.showConfirmationDialog(`Entity '${a}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(t.value=`${a}_new`,t.select())});return}this.doSaveEntity();let n=qs(".tabs-link-container li.diagram-tab.active");n&&this.selectDiagram(n)}checkDuplicatedColumn(){let e=[],t=qsa(this.selector+" #table-entity-editor .column-name");for(let a=0;a<t.length;a++){let i=t[a].value;if(e.includes(i))return{index:a,name:i,element:t[a]};e.push(i)}return null}doSaveEntity(){let e=qs(this.selector+" .entity-name").value,t=[],a=[],i=qsa(this.selector+" #table-entity-editor .column-name"),n=qsa(this.selector+" #table-entity-editor .column-type"),l=qsa(this.selector+" #table-entity-editor .column-nullable"),r=qsa(this.selector+" #table-entity-editor .column-default"),s=qsa(this.selector+" #table-entity-editor .column-primary-key"),o=qsa(this.selector+" #table-entity-editor .column-autoIncrement"),c=qsa(this.selector+" #table-entity-editor .column-length"),d=qsa(this.selector+" #table-entity-editor .column-enum"),h=qsa(this.selector+" #table-entity-editor .column-description"),m=[];for(let u=0;u<i.length;u++){let p=new Column(i[u].value,n[u].value,c[u].value||null,l[u].checked,r[u].value||null,s[u].checked,o[u].checked,d[u].value||null,h[u].value||null);i[u].dataset.originalName&&i[u].dataset.originalName!=i[u].value&&m.push({original:i[u].dataset.originalName,new:i[u].value}),t.push(p),a.push(new Column(i[u].dataset.originalName,n[u].value,c[u].value||null,l[u].checked,r[u].value||null,s[u].checked,o[u].checked,d[u].value||null,h[u].value||null))}if(m.forEach(e=>{this.entities[this.currentEntityIndex]&&this.entities[this.currentEntityIndex].data&&this.entities[this.currentEntityIndex]&&this.entities[this.currentEntityIndex].data.forEach(t=>{t.hasOwnProperty(e.original)&&(t[e.new]=t[e.original],delete t[e.original])})}),this.currentEntityIndex>=0){this.entities[this.currentEntityIndex].name=e,this.entities[this.currentEntityIndex].index=this.currentEntityIndex,this.entities[this.currentEntityIndex].columns=t,this.entities[this.currentEntityIndex].modificationDate=new Date().getTime(),this.entities[this.currentEntityIndex].modifier="{{userName}}";let y=this.foreignKeyDraft[e]?Object.values(this.foreignKeyDraft[e]):null;this.entities[this.currentEntityIndex].indexes=this.indexDraft,this.entities[this.currentEntityIndex].foreignKeys=y||this.entities[this.currentEntityIndex].foreignKeys||[],this.foreignKeyDraft[e]=null}else{let g=new Entity(e,this.entities.length);t.forEach(e=>g.addColumn(e));let f=this.snakeizeData(this.currentEntityData,a);m.forEach(e=>{f.forEach(t=>{t.hasOwnProperty(e.original)&&(t[e.new]=t[e.original],delete t[e.original])})}),g.setData(f),g.modificationDate=new Date().getTime(),g.creationDate=g.modificationDate,g.creator="{{userName}}",g.modifier="{{userName}}",g.indexes=this.indexDraft,g.foreignKeys=this.foreignKeyDraft[e]?Object.values(this.foreignKeyDraft[e]):[],this.foreignKeyDraft[e]=null,this.entities.push(g)}this.indexDraft=[],this.renderEntities(),this.updateDiagram(),this.cancelEdit(),this.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex()),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}updateDiagram(){let e=this;qs(".diagram-container").querySelectorAll(".diagram-entity").forEach(t=>{let a=t.getAttribute("id"),i=t.closest(".left-panel").offsetWidth,n=(t.dataset.entities||"").split(","),l=[];n.forEach(t=>{let a=e.getEntityByName(t);null!=a&&l.push(a)}),(isNaN(i)||i<240)&&(i=240),diagramRenderer[a].createERD({entities:l},i-240,qs("#draw-auto-relationship").checked,qs("#draw-fk-relationship").checked);let r=t.querySelector("svg");e.removeDiagramEventListener(r),e.addDiagramEventListener(r)})}saveDiagram(){let e=this.getCheckedEntities(),t=[],a=0;Object.entries(e).forEach(([e,i],n)=>{let l=qs(`.tabs-link-container [data-id="${e}"] input`).value;t.push({id:e,name:l,sortOrder:a,entities:i}),a++}),this.diagrams=t,"function"==typeof this.callbackSaveDiagram&&this.callbackSaveDiagram(t)}showEditorTemplate(){this.currentEntityIndex=-2,qs(this.selector+" .template-columns-table-body").innerHTML="",this.template.columns.forEach(e=>this.addColumnToTemplate(e)),qs(this.selector+" .button-container").style.display="none",qs(this.selector+" .entity-container").style.display="none",qs(this.selector+" .template-container").style.display="block",qs(this.selector+" .editor-form").style.display="block"}addColumnTemplate(e){this.addColumnToTemplate({name:"",type:"VARCHAR",length:"50",nullable:!0,default:null,values:""},e);let t=qs(this.selector+" .template-container .table-container");t.scrollTop=t.scrollHeight}addColumnToTemplate(e,t){let a=qs(this.selector+" .template-columns-table-body"),i=document.createElement("tr"),n=null==e.length?"":e.length.replace(/\D/g,""),l=null==e.default?"":e.default,r=e.type.split("(")[0].trim(),s=e.description?e.description:"";i.innerHTML=`
<td class="drag-handle"></td>
<td class="column-action">
    <button onclick="editor.removeColumn(this)" class="icon-emoji icon-delete"></button>
    <button onclick="editor.moveUp(this)" class="icon-emoji icon-move-up"></button>
    <button onclick="editor.moveDown(this)" class="icon-emoji icon-move-down"></button>
</td>
<td><input type="text" class="column-name" value="${e.name}" placeholder="Column Name"></td>
<td>
    <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
        ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===r?"selected":""}>${e}</option>`).join("")}
    </select>
</td>
<td><input type="text" class="column-length" value="${n}" placeholder="Length" style="display: ${this.withLengthTypes.includes(r)?"inline":"none"};"></td>
<td><input type="text" class="column-enum" value="${e.values}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(r)||this.withRangeTypes.includes(r)?"inline":"none"};"></td>
<td><input type="text" class="column-default" value="${l}" placeholder="Default Value"></td>
<td class="column-nl"><input type="checkbox" class="column-nullable" ${e.nullable?"checked":""}></td>
<td><input type="text" class="column-description" value="${s}" placeholder="Description"></td>
        `,a.appendChild(i),this.initDraggableRow(i),t&&i.querySelector(".column-name").select()}saveTemplate(){let e=[],t=qsa(this.selector+" .table-template-editor .column-name"),a=qsa(this.selector+" .table-template-editor .column-type"),i=qsa(this.selector+" .table-template-editor .column-nullable"),n=qsa(this.selector+" .table-template-editor .column-default"),l=qsa(this.selector+" .table-template-editor .column-length"),r=qsa(this.selector+" .table-template-editor .column-description");for(let s=0;s<t.length;s++){let o=new Column(t[s].value,a[s].value,l[s].value||null,i[s].checked,n[s].value||null,!1,null,null,r[s].value||null);e.push(o)}this.template.columns=e,qs(this.selector+" .entity-container").style.display="block",qs(this.selector+" .template-container").style.display="none","function"==typeof this.callbackSaveTemplate&&this.callbackSaveTemplate(this.template)}cancelEditTemplate(){qs(this.selector+" .entity-container").style.display="block",qs(this.selector+" .template-container").style.display="none"}addColumnFromTemplate(){let e=this.selector+" .entity-container .entity-name",t=qs(e),a=t.value;if("create"==this.operation&&this.isEntityExists(a)){this.showConfirmationDialog(`Entity '${a}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(t.value=`${a}_new`,t.select())});return}let i=[],n=qsa(this.selector+" #table-entity-editor .column-name");for(let l of n)i.push(l.value);this.template.columns.forEach(e=>{i.includes(e.name)||this.addColumnToTable(e,focus,!0)});let r=qs(this.selector+" .entity-container .table-container");r.scrollTop=r.scrollHeight}removeColumn(e){let t=e.closest("tr");t.remove()}moveUp(e){let t=e.closest("tr"),a=t.closest("tbody"),i=t.previousElementSibling;i&&a.insertBefore(t,i)}moveDown(e){let t=e.closest("tr"),a=t.closest("tbody"),i=t.nextElementSibling;i&&a.insertBefore(i,t)}createEntitiesFromJSON(e){let t=[];return e.entities.forEach(e=>{let a=new Entity(e.name,e.index);e.columns.forEach(e=>{let t=new Column(e.name,e.type,e.length,e.nullable,e.default,e.primaryKey,e.autoIncrement,"null"!==e.values?e.values:"",e.description);a.addColumn(t)}),a.creationDate=e.creationDate||null,a.modificationDate=e.modificationDate||null,a.creator=e.creator,a.modifier=e.modifier,a.description=e.description||"",a.foreignKeys=Array.isArray(e.foreignKeys)?e.foreignKeys:Object.values(e.foreignKeys||{}),a.indexes=Array.isArray(e.indexes)?e.indexes:Object.values(e.indexes||{}),a.setData(e.data),t.push(a)}),{entities:t,diagrams:e.diagrams}}createTemplateFromJSON(e){let t=[];return e.columns.forEach(e=>{let a=new Column(e.name,e.type,e.length,e.nullable,e.default,"null"!==e.values?e.values:"",null,null,e.description);t.push(a)}),{columns:t}}createEntitiesFromSQL(e){let t=this,a=[];return e.forEach((e,i)=>{let n=new Entity(t.snakeize(e.tableName),i);e.columns.forEach(e=>{let a=new Column(t.snakeize(e.Field),e.Type.toUpperCase(),e.Length,e.Nullable,e.Default,e.Key,e.AutoIncrement,null!=e.EnumValues&&"object"==typeof e.EnumValues?e.EnumValues.join(", "):null,null);n.addColumn(a)}),n.creationDate=new Date().getTime(),n.modificationDate=n.creationDate,n.creator="{{userName}}",n.modifier="{{userName}}",n.foreignKeys=Array.isArray(e.foreignKeys)?e.foreignKeys:Object.values(e.foreignKeys||{}),n.indexes=Array.isArray(e.indexes)?e.indexes:Object.values(e.indexes||{}),a.push(n)}),a}getCheckedEntities(){let e={};return qsa(".diagram-entity.tab-content").forEach(t=>{let a=t.getAttribute("id"),i=t.dataset.entities;e[a]=i?i.split(","):[]}),e}setCheckedEntities(e){qsa(".diagram-entity.tab-content").forEach(t=>{let a=e[t.getAttribute("id")];a&&t.setAttribute("data-entities",a.join(","))})}restoreCheckedEntitiesFromCurrentDiagram(){let e=qs(".tabs-link-container .diagram-tab.active");this.selectDiagram(e)}restoreCheckedEntities(){let e=qs(".diagram-entity.tab-content.active");if(e){let t=e.dataset.entities,a=t?t.split(","):[];qsa('.left-panel .table-list [type="checkbox"]').forEach(e=>{e.checked=a.includes(e.dataset.name),e.disabled=!1})}}renderEntities(){let e=this,t=qs(this.selector+" .entities-container"),a=[],i=[],n=qsa(this.selector+" .right-panel .selected-entity-structure:checked"),l=qsa(this.selector+" .right-panel .selected-entity-data:checked");n.forEach(e=>a.push(e.dataset.name)),l.forEach(e=>i.push(e.dataset.name));let r=qs(this.selector+" .table-list-for-export"),s=qs(this.selector+" .left-panel .table-list"),o=qs(this.selector+" .draw-auto-relationship").checked,c=qs(this.selector+" .draw-fk-relationship").checked;if(s.innerHTML="",r.innerHTML="",this.entities.some(t=>!e.systemEntities.includes(t.name.toLowerCase()))){let d=document.createElement("tr");d.classList.add("group-header"),d.innerHTML=`
<td>
        <label><input type="checkbox" class="export-structure-custom" /> S</label>
</td>
<td>
    <label><input type="checkbox" class="export-data-custom"/> D</label>
</td>
<td>[Custom Entities]</td>
            `,r.appendChild(d)}let h=0;if(this.entities.forEach((t,a)=>{!e.systemEntities.includes(t.name.toLowerCase())&&(e.appendBuildTableRow(r,t,h,"custom"),h++)}),this.entities.some(t=>e.systemEntities.includes(t.name.toLowerCase()))){let m=document.createElement("tr");m.classList.add("group-header"),m.innerHTML=`
<td>
    <label><input type="checkbox" class="export-structure-system" /> S</label>
</td>
<td>
    <label><input type="checkbox" class="export-data-system"/> D</label>
</td>
<td>[Systen Entities]</td>
                `,r.appendChild(m)}this.entities.forEach((t,a)=>{e.systemEntities.includes(t.name.toLowerCase())&&(e.appendBuildTableRow(r,t,h,"system"),h++)}),this.entities.forEach((e,t)=>{let a=document.createElement("li");a.innerHTML=`
<input type="checkbox" class="selected-entity" data-name="${e.name}" value="${t}" />
<a class="edit-table" href="javascript:">✏️</a>
<a class="delete-table" href="javascript:">❌</a> ${e.name}
            `,a.setAttribute("data-index",t),a.setAttribute("title",e.name),s.appendChild(a),a.querySelector("a.edit-table").addEventListener("click",e=>{editor.editEntity(parseInt(e.target.parentNode.dataset.index))}),a.querySelector("a.delete-table").addEventListener("click",e=>{editor.deleteEntity(parseInt(e.target.parentNode.dataset.index))})});let u=this.entities.length;qs(this.selector+" .entity-count").textContent=u>0?`(${u})`:"",a.forEach(e=>{let t=qs(`.right-panel input[data-name="${e}"].selected-entity-structure`);t&&(t.checked=!0)}),i.forEach(e=>{let t=qs(`.right-panel input[data-name="${e}"].selected-entity-data`);t&&(t.checked=!0)});let p=t.closest(".left-panel").offsetWidth;(isNaN(p)||0==p)&&(p=parseInt(resizablePanels.getLeftPanelWidth())),(isNaN(p)||0==p)&&(p=240),p-=240,entityRenderer.createERD(editor.getData(),p,o,c)}appendBuildTableRow(e,t,a,i){let n=document.createElement("tr");n.innerHTML=`
<td>
    <label><input type="checkbox" class="selected-entity-structure entity-structure-${i}" data-name="${t.name}" value="${a}" /> S</label>
</td>
<td>
    <label><input type="checkbox" class="selected-entity-data entity-data-${i}" data-name="${t.name}" value="${a}" /> D</label>
</td>
<td>${t.name}</td>
        `,e.appendChild(n)}refreshEntities(){let e=this;setTimeout(function(){let t=e.getCheckedEntities();e.renderEntities(),e.updateDiagram(),e.setCheckedEntities(t),e.restoreCheckedEntities()},!0)}prepareDiagram(){let e=this,t=qs(".tabs-link-container .diagram-list.tabs");this.diagrams.length>0&&this.diagrams.forEach(a=>{e.addDiagram(t,a.name,a.id,a.entities,!0)});let a=qs(".diagram-list.tabs");currentMarginLeft=-(t.scrollWidth-a.offsetWidth),t.style.marginLeft=`${currentMarginLeft}px`}selectDiagram(e){let t=qs(".diagram-container"),a=[];if(e){e.closest("ul").querySelectorAll("li.diagram-tab").forEach(e=>{e.classList.remove("active")}),e.closest("ul").querySelector("li.all-entities").classList.remove("active"),t.querySelectorAll("div.diagram").forEach(e=>{e.classList.remove("active")}),e.classList.add("active");let i=e.dataset.id,n=t.querySelector("#"+i);n.classList.add("active");a=(n.dataset.entities||"").split(",")}qs(".entity-editor .table-list").querySelectorAll("li").forEach(e=>{let t=e.querySelector('input[type="checkbox"]'),i=t.dataset.name;a.length>0&&""!==i&&(t.checked=a.includes(i)),t.disabled=!1}),this.updateDiagram()}addDiagram(e,t,a,i,n,l=!1){let r=this;n=n||!1;let s=`
<input type="text" value="${t}">
<a href="#tab1" class="tab-link select-diagram">${t}</a>
<a
    href="javascript:" class="update-diagram"><span class="icon-emoji icon-ok"></span></a><a
    href="javascript:" class="edit-diagram"><span class="icon-emoji icon-edit"></span></a><a
    href="javascript:" class="delete-diagram"><span class="icon-emoji icon-delete"></span></a>
        `,o=document.createElement("li");o.innerHTML=s,o.setAttribute("data-edit-mode",n?"false":"true"),o.querySelector("a.tab-link").setAttribute("href","#"+t),o.setAttribute("data-id",a),o.classList.add("diagram-tab");let c=e.lastElementChild;e.insertBefore(o,c),o.querySelector("input").select(),o.querySelector("input").addEventListener("keypress",function(e){if("Enter"==e.key){let t=e.target.value;o.querySelector(".tab-link").innerText=t,o.setAttribute("data-edit-mode","false"),r.updateDiagram(),r.saveDiagram()}}),e.querySelectorAll("li.diagram-tab").forEach(e=>{e.classList.remove("active")}),o.classList.add("active");let d=qs(".diagram-container");d.querySelectorAll(".diagram").forEach(e=>{e.classList.remove("active")});let h=document.createElement("div");h.setAttribute("id",a),h.classList.add("diagram"),h.classList.add("diagram-entity"),h.classList.add("tab-content"),h.classList.add("active"),h.dataset.entities=i.join(","),h.dataset.name=t;let m=document.createElementNS("http://www.w3.org/2000/svg","svg");m.setAttribute("width",4),m.setAttribute("height",4),m.classList.add("erd-svg"),initDiagramContextMenu(m),h.appendChild(m),d.appendChild(h),diagramRenderer[a]=new EntityRenderer(`.diagram-container #${a} .erd-svg`),e.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.setAttribute("data-index",t)}),this.selectDiagram(o),this.updateDiagram(),o.querySelector(".select-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li");r.selectDiagram(t)}),o.querySelector(".update-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a=t.querySelector("input").value;t.querySelector(".tab-link").innerText=a,t.setAttribute("data-edit-mode","false"),r.updateDiagram(),r.saveDiagram(),r.restoreCheckedEntitiesFromCurrentDiagram()}),o.querySelector(".edit-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a=t.querySelector(".tab-link").innerText,i=t.querySelector("input");i.value=a,t.setAttribute("data-edit-mode","true"),i.select(),r.updateDiagram(),r.restoreCheckedEntitiesFromCurrentDiagram()}),o.querySelector(".delete-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li").querySelector('input[type="text"]').value;r.showConfirmationDialog(`<p>Are you sure you want to delete the diagram &quot;${t}&quot;?</p>`,"Delete Confirmation","Yes","No",function(t){if(t){let a=e.target.closest("li"),i="#"+a.dataset.id,n=a.closest("ul");a.parentNode.removeChild(a);let l=d.querySelector(i);l.parentNode.removeChild(l),n.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.setAttribute("data-index",t)}),r.updateDiagram(),r.saveDiagram()}})}),null===tabDragger&&(tabDragger=new TabDragger(e,function(){let e=r.getDiagrams();r.callbackSaveDiagram(e)})).initAll(),tabDragger.makeDraggable(o);let u=-10-o.offsetWidth;l&&updateMarginLeft(u)}addDiagramEventListener(e){let t=this;e._clickHandler||(e._clickHandler=function(e){t.editEventListener(e)}),e.addEventListener("click",e._clickHandler)}getNewDiagramName(){let e="New Diagram",t=this.getDiagrams(),a=e,i=0,n=!0;for(;n;)for(let l of(n=!1,t))if(l.name===a){n=!0,a=`${e} ${++i}`;break}return a}getDiagrams(){let e=[];return qs(".diagram-list.tabs").querySelectorAll("li.diagram-tab").forEach((t,a)=>{e.push({id:t.dataset.id,name:t.querySelector("input").value,sortOrder:a,entities:qs(".diagram-container").querySelector(`#${t.dataset.id}`).dataset.entities.split(",")})}),e}removeDiagramEventListener(e){e._clickHandler&&(e.removeEventListener("click",e._clickHandler),delete e._clickHandler)}clearDiagrams(){qs(".diagram-list.tabs .all-entities").classList.add("active");let e=qsa(".diagram-tab");e&&e.forEach(e=>{e.parentNode.removeChild(e)});let t=qsa(".diagram-entity.tab-content");t&&t.forEach(e=>{e.parentNode.removeChild(e)}),qs(".diagram-container #all-entities").classList.add("active");let a=qs(".diagram-list.tabs");a.style.marginLeft="0px",a.scrollLeft=0,a.width="auto",a.parentNode.scrollLeft=0,currentMarginLeft=132}clearEntities(){let e=qs(".diagram-container .all-entities");if(e){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");e.appendChild(t)}}editEventListener(e){if(e.target.closest(".erd-svg .view-data-icon")){let t=parseInt(e.target.dataset.index);this.viewData(t)}if(e.target.closest(".erd-svg .move-down-icon")){let a=e.target.closest(".diagram-entity").dataset.entities,i=e.target.closest(".svg-entity").dataset.entity,n=this.arrayElementOperation(a,i,1);e.target.closest(".diagram-entity").setAttribute("data-entities",n),this.updateDiagram(),this.saveDiagram()}if(e.target.closest(".erd-svg .move-up-icon")){let l=e.target.closest(".diagram-entity").dataset.entities,r=e.target.closest(".svg-entity").dataset.entity,s=this.arrayElementOperation(l,r,-1);e.target.closest(".diagram-entity").setAttribute("data-entities",s),this.updateDiagram(),this.saveDiagram()}if(e.target.closest(".erd-svg .edit-icon")){let o=parseInt(e.target.dataset.index);this.editEntity(o)}if(e.target.closest(".erd-svg .delete-icon")){let c=e.target.closest(".diagram-entity").dataset.entities,d=e.target.closest(".svg-entity").dataset.entity,h=this.removeUniqueElements(c.split(","),d).join(",");qs(`.selected-entity[data-name="${d}"]`).checked=!1,e.target.closest(".diagram-entity").setAttribute("data-entities",h),this.updateDiagram(),this.saveDiagram()}}removeUniqueElements(e,t){return e.filter(a=>!(a===t&&e.indexOf(a)===e.lastIndexOf(a)))}arrayElementOperation(e,t,a){let i=e.split(","),n=i.indexOf(t);if(-1===n||-1===a&&0===n||1===a&&n===i.length-1)return e;let l=n+a;return[i[n],i[l]]=[i[l],i[n]],i.join(",")}viewData(e=-1){let t=this,a;if(e<0&&(e=this.currentEntityIndex),e>=0){let i=(a=this.entities[e]).data.length;if(i>1e3){let n=`<p>This entity contains ${i} records.<br />Opening such a large dataset may cause your browser to become unresponsive or even crash due to running out of memory.<br />Do you still want to proceed?</p>`;t.showConfirmationDialog(n,"Warning: Large Dataset Detected","Open Anyway","Cancel",function(i){i&&t.showEntityDataDialog(a,e,`Entity Data - ${a.name}`)})}else t.showEntityDataDialog(a,e,`Entity Data - ${a.name}`)}else t.showAlertDialog("Entity data is only available after you save this entity.","Information","OK")}moveEntityUp(e){if(this.cancelEdit(),e<this.entities.length-1){let t=this.entities[e];this.entities[e]=this.entities[e+1],this.entities[e+1]=t,this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex()),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}}moveEntityDown(e){if(this.cancelEdit(),e>0){let t=this.entities[e];this.entities[e]=this.entities[e-1],this.entities[e-1]=t,this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex()),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}}sortEntities(){this.entities.sort((e,t)=>e.name>t.name?1:e.name<t.name?-1:0),this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex()),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}sortAndGroupEntities(){let e=this,t=[],a=[];this.entities.forEach(i=>{e.systemEntities.includes(i.name)?a.push(i):t.push(i)}),t.sort((e,t)=>e.name.localeCompare(t.name)),a.sort((e,t)=>e.name.localeCompare(t.name)),this.entities=[...t,...a],this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex()),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}updateEntityIndex(){this.entities.forEach((e,t)=>{e.index=t})}editEntity(e){this.currentEntityIndex=e,this.showEditor(e)}deleteEntity(e){let t=this,a=t.entities[e].name;t.showConfirmationDialog(`<p>Are you sure you want to delete the entity &quot;${a}&quot;?</p>`,"Delete Confirmation","Yes","No",function(a){a&&(t.entities.splice(e,1),t.updateEntityIndex(),t.renderEntities(),t.restoreCheckedEntitiesFromCurrentDiagram(),t.exportToSQL(t.getSelectedDialect(),t.isGenerateForeignKey(),t.isGenerateIndex()),"function"==typeof t.callbackSaveEntity&&t.callbackSaveEntity(t.entities))})}cancelEdit(){qs(this.selector+" .editor-form").style.display="none",qs(this.selector+" .button-container").style.display="block"}updateColumnLengthInput(e){let t=e.closest("tr"),a=e.value,i=t.querySelector(".column-length"),n=t.querySelector(".column-enum");if(this.withLengthTypes.includes(a)?i.style.display="inline":i.style.display="none",this.withValueTypes.includes(a)||this.withRangeTypes.includes(a)?n.style.display="inline":n.style.display="none",void 0!==this.defaultLength[a]){let l=this.defaultLength[a];i.value=l}t.querySelector(".column-primary-key").checked&&(this.autonumberTypes.includes(t.querySelector(".column-type").value)?(t.querySelector(".column-autoIncrement").disabled=!1,t.classList.add("is-primary-key")):(t.querySelector(".column-autoIncrement").disabled=!0,t.querySelector(".column-autoIncrement").checked=!1,t.classList.remove("is-primary-key")))}async downloadMWB(){let e=await new MWBConverter().convertJsonToMwbOld({entities:this.entities,diagrams:this.getDiagrams()}),t=await e.generateAsync({type:"blob"}),{applicationId:a,databaseName:i,databaseSchema:n,databaseType:l}=getMetaValues(),r=`${a} - ${i}.mwb`,s=URL.createObjectURL(t),o=document.createElement("a");o.href=s,o.download=r,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}exportToSQL(e="mysql",t=!1,a=!0){let i=this.generateSQL(e,t,a);qs(this.selector+" .query-generated").value=i.join("\r\n")}generateSQL(e,t=!1,a=!1){let i=[];t&&i.push(this.getDisableForeignKeySQL(e));let n=qsa(this.selector+" .right-panel .selected-entity-structure:checked");n.forEach(n=>{let l=n.dataset.name,r=this.getEntityByName(l);r&&i.push(r.toSQL(e,t,a))});let l=qsa(this.selector+" .right-panel .selected-entity-data:checked");return l.forEach(t=>{let a=t.dataset.name,n=this.getEntityByName(a);if(n){let l=n.toSQLInsert(e);""!=l&&i.push(l)}}),t&&i.push(this.getEnableForeignKeySQL(e)),i}getDisableForeignKeySQL(e){let t=(e||"").toLowerCase();return t.startsWith("mysql")||t.startsWith("mariadb")?"-- DISABLE FOREIGN KEY CHECKS\r\nSET FOREIGN_KEY_CHECKS = 0;\r\n":t.startsWith("sqlite")?"-- DISABLE FOREIGN KEY CHECKS\r\nPRAGMA foreign_keys = OFF;\r\n":t.startsWith("postgres")?"-- DISABLE FOREIGN KEY CHECKS\r\nSET session_replication_role = replica;\r\n":t.startsWith("sqlserver")||t.startsWith("mssql")?"-- Disable FK per table required in SQL Server":""}getEnableForeignKeySQL(e){let t=(e||"").toLowerCase();return t.startsWith("mysql")||t.startsWith("mariadb")?"-- ENABLE FOREIGN KEY CHECKS\r\nSET FOREIGN_KEY_CHECKS = 1;\r\n":t.startsWith("sqlite")?"-- ENABLE FOREIGN KEY CHECKS\r\nPRAGMA foreign_keys = ON;\r\n":t.startsWith("postgres")?"-- ENABLE FOREIGN KEY CHECKS\r\nSET session_replication_role = DEFAULT;\r\n":t.startsWith("sqlserver")||t.startsWith("mssql")?"-- Enable FK per table required in SQL Server":""}clearGeneratedQuery(){qs(".query-generated").value="",qs(".check-all-entity-structure").checked=!1,qs(".check-all-entity-data").checked=!1}checkEntityTypes(e){"custom"==e.dataset.entityType?qsa(".entity-selector-table-container.custom-entity .entity-selector").forEach(t=>{t.checked=e.checked}):"system"==e.dataset.entityType&&qsa(".entity-selector-table-container.system-entity .entity-selector").forEach(t=>{t.checked=e.checked})}inMemoryCacheChange(e){}baseColumnName(e){return e?e.endsWith("_id")?e.substring(0,e.length-3):e:""}getSelectedEntities(){let e=this,t={entities:[]},a=this.entities,i=qsa('input[type="checkbox"].entity-selector');if(i.length){let n=[];i.forEach(e=>{e.checked&&n.push(e.value)}),a&&a.forEach(a=>{if(n.includes(a.name)){let i=qs(`table[data-entity="${a.name}"]`),l=this.cloneEntity(a,i);l.data=[];let r=[],s=[];l.columns.forEach(t=>{if(t.primaryKey){let a=i.querySelector(`select.pk-value-graphql[data-col="${t.name}"]`);a?t.primaryKeyValue=a.value:t.primaryKeyValue="autogenerated"}let l=i.querySelector(`select.filter-graphql[data-col="${t.name}"]`).value;if(""!=l){let o={name:t.name,type:"string",operator:-1!==l.indexOf("CONTAINS")?"CONTAINS":"EQUALS",element:-1!==l.indexOf("select")?"select":"text"},c=e.baseColumnName(o.name);"select"==o.element&&n.includes(c)&&(o.entity=c),r.push(o)}let d=i.querySelector(`input.textarea-graphql[data-col="${t.name}"]`);d&&d.checked&&s.push(t.name)}),r.length>0&&(l.filters=r),l.filterEntities=0==r.length?0:l.filters.filter(e=>null!=e.entity).length,s.length>0&&(l.textareaColumns=s),t.entities.push(l)}})}return t}cloneEntity(e,t){let a=JSON.parse(JSON.stringify(e));if(t){let i=t.querySelectorAll("input.check-column");if(i?.length){let n=[];i.forEach(e=>{e.checked&&n.push(e.value)}),n.length&&(a.columns=a.columns.filter(e=>n.includes(e.name)))}}return a}exportGraphQLSchema(e){let t=e.programmingLanguage||"php";fetch("../lib.ajax/graphql-generator.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(async e=>{let a=null,i=e.headers.get("Content-Disposition");if(i&&i.includes("filename=")){let n=i.match(/filename\*?=(?:UTF-8''|["']?)([^"';\n]+)/i);n&&n[1]&&(a=decodeURIComponent(n[1]))}if(!a){let{applicationId:l}=getMetaValues();l||(l="app"),a=`${l}-graphql-${t}.zip`}let r=await e.blob(),s=window.URL.createObjectURL(r),o=document.createElement("a");o.href=s,o.download=a,document.body.appendChild(o),o.click(),o.remove(),window.URL.revokeObjectURL(s)}).catch(e=>{console.error("Error generating GraphQL schema:",e)})}handleOkGenerate(){let e={schema:this.getSelectedEntities(),reservedColumns:reservedColumns,withFrontend:!1,inMemoryCache:qs(".in-memory-cache-checker").checked,applicationId:qs('meta[name="application-id"]').getAttribute("content"),programmingLanguage:qs(".programming-language-selector").value};this.exportGraphQLSchema(e)}handleOkGenerateWithFrontend(){let e={schema:this.getSelectedEntities(),reservedColumns:reservedColumns,withFrontend:!0,inMemoryCache:qs(".in-memory-cache-checker").checked,applicationId:qs('meta[name="application-id"]').getAttribute("content"),programmingLanguage:qs(".programming-language-selector").value};this.exportGraphQLSchema(e)}handleCancelGenerate(){qs("#graphqlGeneratorModal").style.display="none"}showEntitySelector(){let e=qs(".entity-selector-container");e.innerHTML="";let t=qs("#graphqlGeneratorModal");t.querySelector(".modal-header h3").innerHTML="GraphQL Generator",this.loadGraphQlAppProfile(),this.createEntitySelectorTables(e);loadFormState(e.closest("form"),this.graphqlAppData),this.loadGraphQlAppConfiguration(),t.style.display="block"}loadGraphQlAppProfile(){let e=this,{applicationId:t,databaseName:a,databaseSchema:i,databaseType:n}=getMetaValues();fetch(`../lib.ajax/load-graphql-entity-index.php?applicationId=${encodeURIComponent(t)}&databaseType=${encodeURIComponent(n)}&databaseName=${encodeURIComponent(a)}&databaseSchema=${encodeURIComponent(i)}`,{method:"GET"}).then(e=>e.json()).then(t=>{e.graphqlAppProfile=t;let a=qs(".graphql-app-profile");a.innerHTML="";let i="";for(let n in e.graphqlAppProfile){let l=e.graphqlAppProfile[n],r=new Option(l.profileLabel,l.profileName);l.selected&&(i=l.profileName),a.add(r)}a.value=i}).catch(e=>{console.error("Failed to fetch GraphQL profile data:",e)})}loadGraphQlAppConfiguration(){let e=this,t=qs(".entity-selector-container").closest("form"),{applicationId:a,databaseName:i,databaseSchema:n,databaseType:l}=getMetaValues(),r=qs(".graphql-app-profile").value;loadGraphQlEntityFromServer(a,l,i,n,r,function(a){loadFormState(t,a),e.graphqlAppData=a})}createEntitySelectorTables(e){let t="name";reservedColumns&&reservedColumns.columns&&reservedColumns.columns.forEach(e=>{"name"==e.key&&(t=e.name)}),this.entities.forEach(a=>{this.systemEntities.includes(a.name)||this.createEntitySelectorTable(a,e,!0,t)}),this.entities.forEach(a=>{this.systemEntities.includes(a.name)&&this.createEntitySelectorTable(a,e,!1,t)})}checkAllColumns(e){let t=e.closest("table");t&&t.querySelectorAll("input.check-column").forEach(t=>{t.checked=e.checked})}getPrimaryKeyValue(e){return e.primaryKey?`
            <select class="form-control pk-value-graphql" data-col="${e.name}">
                <option value="autogenerated">Autogenerated</option>
                <option value="manual-insert">Manual Insert</option>
                <option value="manual-all">Manual All</option>
            </select>
            `:""}createEntitySelectorTable(e,t,a,i){let n=document.createElement("div");n.classList.add("mb-4"),n.classList.add("entity-selector-table-container"),this.systemEntities.includes(e.name)?n.classList.add("system-entity"):n.classList.add("custom-entity");let l=document.createElement("input");l.type="checkbox",l.className="entity-selector",l.value=e.name,l.checked=a;let r=document.createElement("td");r.appendChild(l),r.appendChild(document.createTextNode(" ")),r.appendChild(document.createTextNode(e.name));let s=document.createElement("table");s.classList.add("entity-selector-table");let o=document.createElement("tr");o.appendChild(r),s.appendChild(o),n.appendChild(s);let c=document.createElement("table");c.className="table table-bordered table-striped table-sm entity-table",c.dataset.entity=e.name,c.style.width="100%",c.style.tableLayout="fixed";let d=document.createElement("thead");d.innerHTML=`
<tr>
    <th style="width: 30px;"><input type="checkbox" class="check-all" onchange="editor.checkAllColumns(this)" checked=""></th>
    <th style="width: 22%;">Column</th>
    <th style="width: 14%;">Type</th>
    <th style="width: 8%;">PK</th>
    <th style="width: 8%;">Serial</th>
    <th style="width: 8%;">Null</th>
    <th style="width: 35px;">TA</th>
    <th style="width: 16%;">Filter</th>
    <th>PK Value</th>
</tr>
        `,c.appendChild(d);let h=document.createElement("tbody");e.columns.forEach(e=>{let t=document.createElement("tr"),a=e.type||"";null!=e.length&&""!==e.length&&(a+=`(${e.length})`),t.dataset.col=e.name;let n="",l=-1!=e.type.toLowerCase().indexOf("text")?" checked":"";e.primaryKey||e.name.endsWith("_id")||(n=`<input type="checkbox" class="textarea-graphql" data-col="${e.name}"${l}>`),t.innerHTML=`
<td><input type="checkbox" class="check-column" value="${e.name||""}" checked></td>
<td>${e.name||""}</td>
<td>${a}</td>
<td style="text-align: center;">${e.primaryKey?"YES":"NO"}</td>
<td style="text-align: center;">${e.autoIncrement?"YES":"NO"}</td>
<td style="text-align: center;">${e.nullable?"YES":"NO"}</td>
<td style="text-align: center;">${n}</td>
<td>${this.getFilterType(e,i)}</td>
<td>${this.getPrimaryKeyValue(e)}</td>
`,h.appendChild(t)}),c.appendChild(h),n.appendChild(c),t.appendChild(n)}getFilterType(e,t){let a="";return e.primaryKey||(e.name==t?a="text-CONTAINS":e.name.endsWith("_id")&&(a="select-EQUALS")),`
<select class="form-control filter-graphql" data-col="${e.name}">
    <option value="">Not Applicable</option>
    <option value="text-CONTAINS"${"text-CONTAINS"==a?" selected":""}>Text Contains</option>
    <option value="text-EQUALS"${"text-EQUALS"==a?" selected":""}>Text Equals</option>
    <option value="select-EQUALS"${"select-EQUALS"==a?" selected":""}>Select Equals</option>
</select>
`}copyTableStructure(e){let t=this,a=qs('meta[name="database-type"]').getAttribute("content"),i=[];i.push(this.getEntityByName(selectedElement.dataset.entity).toSQL(a)),navigator.clipboard.writeText(i.join("")).then(()=>{t.showCopyEffect(e.clientX,e.clientY),hideContextMenu()}).catch(e=>{})}copyTableIndexes(e){let t=this,a=qs('meta[name="database-type"]').getAttribute("content"),i=this.getEntityByName(selectedElement.dataset.entity).createIndexStatements(a);navigator.clipboard.writeText(i.join("\r\n")+"\r\n").then(()=>{t.showCopyEffect(e.clientX,e.clientY),hideContextMenu()}).catch(e=>{})}copyTableData(e){let t=this,a=qs('meta[name="database-type"]').getAttribute("content"),i=[];i.push(this.getEntityByName(selectedElement.dataset.entity).toSQLInsert(a)),navigator.clipboard.writeText(i.join("")).then(()=>{t.showCopyEffect(e.clientX,e.clientY),hideContextMenu()}).catch(e=>{})}copyTableStructureAndData(e){let t=this,a=qs('meta[name="database-type"]').getAttribute("content"),i=[],n=this.getEntityByName(selectedElement.dataset.entity);i.push(n.toSQL(a)),i.push(n.toSQLInsert(a)),navigator.clipboard.writeText(i.join("")).then(()=>{t.showCopyEffect(e.clientX,e.clientY),hideContextMenu()}).catch(e=>{})}duplicateEntity(){let e=this.getEntityByName(selectedElement.dataset.entity);this.currentEntityData=JSON.parse(JSON.stringify(e.data));let t=`${e.name}_copy`,a=this.toValidTableName(t),i=e.columns;this.importFromSheet(i,a),hideContextMenu()}editEntityContextMenu(){hideContextMenu(),this.editEntity(parseInt(selectedElement.dataset.index))}dataEntityContextMenu(){hideContextMenu(),this.viewData(parseInt(selectedElement.dataset.index))}editIndexContextMenu(e){let t=this.getEntityByName(selectedElement.dataset.entity);hideContextMenu(),this.showIndexEditor(t)}downloadSVG(){let e=qs(".diagram-container").querySelector(".diagram.active");if(e){let t=e.getAttribute("id");"all-entities"==t?entityRenderer.downloadSVG():diagramRenderer[t].downloadSVG()}}downloadEntitySVG(e){this.downloadSVG(),this.showDownloadEffect(e.clientX,e.clientY),hideContextMenu()}downloadPNG(){let e=qs(".diagram-container").querySelector(".diagram.active");if(e){let t=e.getAttribute("id");"all-entities"==t?entityRenderer.downloadPNG():diagramRenderer[t].downloadPNG()}}downloadEntityPNG(e){hideContextMenu(),this.downloadPNG(),this.showDownloadEffect(e.clientX,e.clientY)}downloadMD(){let e=qs(".diagram-container").querySelector(".diagram.active");if(e){let t=e.getAttribute("id");"all-entities"==t?entityRenderer.downloadMD():diagramRenderer[t].downloadMD()}}downloadDiagramMD(e){hideContextMenu(),this.downloadMD(),this.showDownloadEffect(e.clientX,e.clientY)}showCopyEffect(e,t){let a=document.createElement("div");a.className="copy-feedback",a.style.left=`${e-32}px`,a.style.top=`${t-32}px`,document.body.appendChild(a),setTimeout(()=>{a.remove()},400)}showDownloadEffect(e,t){let a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("class","download-feedback"),a.setAttribute("width","64"),a.setAttribute("height","64"),a.setAttribute("viewBox","0 0 64 64"),a.innerHTML=`
<svg height="64px" width="64px" version="1.1" id="DownloadArrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 166.356 166.356" xml:space="preserve" fill="#4CAF50"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path style="fill:#4CAF50;" d="M83.172,164.348L0,81.188h48.606V2.008h69.144v79.18h48.606L83.172,164.348z M14.404,87.155 l68.768,68.756l68.774-68.756h-40.163V7.975h-57.21v79.18H14.404z"></path> </g> </g> </g></svg>
        `,a.style.left=`${e-32}px`,a.style.top=`${t-182}px`,document.body.appendChild(a),setTimeout(()=>{a.remove()},400)}generateFileName(e){return e.databaseName&&e.databaseSchema?`${e.databaseName}-${e.databaseSchema}`:e.databaseName?`${e.databaseName}`:`${e.applicationId}`}exportJSON(e){let t=this.generateFileName(e),a=new Date,i=a.toISOString().replace(/[-T:\.Z]/g,"_");i.endsWith("_")&&(i=i.slice(0,-1));let n=`${t}_${i}.json`,l=JSON.stringify(e),r=new Blob([l],{type:"application/json"}),s=URL.createObjectURL(r),o=document.createElement("a");o.href=s,o.download=n,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}downloadSQL(){let{applicationId:e,databaseName:t,databaseSchema:a,databaseType:i}=getMetaValues(),n=this.generateFileName({applicationId:e,databaseType:i,databaseName:t,databaseSchema:a}),l=new Date,r=l.toISOString().replace(/[-T:\.Z]/g,"_");r.endsWith("_")&&(r=r.slice(0,-1));let s=`${n}_${r}.sql`,o=new Blob([qs(this.selector+" .query-generated").value],{type:"text/plain"}),c=URL.createObjectURL(o),d=document.createElement("a");d.href=c,d.download=s,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(c)}importJSON(e,t){let a=this,i=new FileReader;i.onload=function(e){let i=e.target.result;try{a.importJSONData(i,t)}catch(n){console.error("Error parsing JSON: "+n.message)}},i.readAsText(e)}importJSONData(e,t){let a=this,i=JSON.parse(e),n=editor.createEntitiesFromJSON(i);a.clearEntities(),a.clearDiagrams(),a.entities=n.entities,a.diagrams=n.diagrams||[],a.prepareDiagram(),a.updateDiagram(),a.renderEntities(),"function"==typeof t&&t(a.entities,a.diagrams)}importMySQLWorkbench(e,t){let a=this,i=new FileReader;i.onload=async function(e){let i=e.target.result,n=new MWBConverter;try{await n.loadBinary(i,{mwb:!0});let l=n.getEntities(),r=n.getDiagrams();if(l&&l.length>0){if(a.clearBeforeImport)a.entities=l||[],a.diagrams=r||[],a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{let s=[];a.entities.forEach(e=>{s.push(e.name)}),l.forEach(e=>{let t=Entity.valueOf(e);t.columns&&t.columns.length>0&&!s.includes(t.name)&&(t.index=a.entities.length,a.entities.push(t))}),r.forEach(e=>{a.diagrams.map(e=>e.name).includes(e.name)||a.diagrams.push(e)}),a.prepareDiagram(),a.updateDiagram(),a.saveDiagram(),a.renderEntities()}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram(),(async()=>{try{let e=await n.getEntityData();if(!e||"object"!=typeof e){console.warn("No entity data returned from MWB");return}for(let[t,i]of Object.entries(e)){let l=a.getEntityByName(t);if(!l)continue;if(!Array.isArray(l.columns)){console.warn(`Entity ${t} has no columns defined`);continue}let r=a.snakeizeData(i,l.columns);l.data=r}a.callbackSaveEntity(a.entities)}catch(s){console.error("Failed to fetch or apply MWB entity data:",s)}})()}}catch(o){console.error("Error importing MWB file:",o),a.showAlertDialog("Error importing MWB file: "+o.message,"Alert","OK")}},i.readAsArrayBuffer(e)}importSQLFile(e,t){let a=this,i=new FileReader,n=e.slice(0,512);i.onload=function(i){let n=new Uint8Array(i.target.result);a.looksLikeMySqlWorkbench(n)?a.importMySQLWorkbench(e,t):a.looksLikeSQLite(n)?a.importSQLite(e,t):a.importSQLQuery(e,t)},i.onerror=()=>a.showAlertDialog("Failed to read file.","Alert","OK"),i.readAsArrayBuffer(n)}looksLikeSQLite(e){return[83,81,76,105,116,101,32,102,111,114,109,97,116,32,51,0].every((t,a)=>e[a]===t)}looksLikeMySqlWorkbench(e){return 80===e[0]&&75===e[1]}importSQLQuery(e,t){let a=this,i=new FileReader;i.onload=function(e){let i=e.target.result;try{let n=new SQLConverter,l=n.translate(i,"mysql").replace(/`/g,""),r=new TableParser(l);r.parseData(i);let s=a.snakeizeObjectKeys(r.data),o=a.createEntitiesFromSQL(r.tableInfo);if(o&&o.length){if(a.clearBeforeImport)a.entities=o,o.forEach(e=>{let t=e.name;s[t]&&e.setData(a.snakeizeData(s[t],e.columns))}),a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{a.entities||(a.entities=[]);let c=a.entities.map(e=>e.name);o.forEach(e=>{let t=e.name;c.includes(e.name)?s[t]&&a.getEntityByName(t).appendData(a.snakeizeData(s[t],e.columns)):(e.index=a.entities.length,s[t]&&e.setData(a.snakeizeData(s[t],e.columns)),a.entities.push(e))}),a.renderEntities()}}else if(s){for(let d in s)if(s.hasOwnProperty(d)){let h=a.getEntityByName(d);h&&h.appendData(s[d])}}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram()}catch(m){console.error("Error parsing SQL: "+m.message)}},i.onerror=()=>{a.showAlertDialog("Failed to read file.","Alert","OK")},i.readAsText(e)}importSQLite(e,t){if(!e)return;let a=this,i=new FileReader;i.onload=function(e){let i=e.target.result,n=new Uint8Array(i);initSqlJs({locateFile:e=>"../lib.assets/wasm/sql-wasm.wasm"}).then(e=>{a.db=new e.Database(n);let i=a.db.exec("SELECT name FROM sqlite_master WHERE type='table';"),l=[];if(i[0].values.forEach((e,t)=>{let i=e[0],n=new Entity(a.snakeize(i),t),r=a.db.exec(`SELECT * FROM ${i};`);if(r.length>0){let s=r[0].columns,o=r[0].values;n.creationDate=new Date().getTime(),n.modificationDate=n.creationDate,n.creator="{{userName}}",n.modifier="{{userName}}",n.data=o.map(e=>{let t={};return s.forEach((i,n)=>{let l=a.snakeize(i);t[l]=e[n]}),t})}else n.setData(null);let c=a.db.exec(`PRAGMA table_info(${i});`);if(c.length>0){let d=!1,h=c[0].values.filter(e=>e[5]).length>1;c[0].values.forEach(e=>{let t="INTEGER"==e[2].toUpperCase()&&e[5];(d||h)&&(t=!1);let i=a.snakeize(e[1]),l=a.toMySqlType(e[2]),r=a.getColumnSize(e[2]),s=1===e[3],o=e[4],c=e[5];(null==r||0==r)&&"BIGINT"==l&&(r="20");let m=new Column(i,l,r,s,o,c,t,null);n.addColumn(m),d&&(d=!1)}),l.push(n)}}),a.clearBeforeImport)a.entities=l,a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{let r=[];a.entities.forEach(e=>{r.push(e.name)}),l.forEach(e=>{r.includes(e.name)?tableParser.data?.[e.name]&&a.getEntityByName(e.name).appendData(e.getData()):(e.index=a.entities.length,a.entities.push(e))}),a.renderEntities()}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram()})},i.readAsArrayBuffer(e)}toMySqlType(e){if(!e)return"TEXT";let t=e.trim().toUpperCase();for(let[a,i]of[[/NVARCHAR/,"VARCHAR"],[/INT/,"BIGINT"],[/(CHAR|CLOB|TEXT)/,"TEXT"],[/BLOB/,"BLOB"],[/(REAL|FLOA|DOUB)/,"DOUBLE"],[/(NUMERIC|DECIMAL)/,"DECIMAL"],[/BOOLEAN/,"TINYINT"],[/TIMESTAMP/,"TIMESTAMP"],[/(DATE|TIME)/,"DATETIME"]])if(a.test(t))return i;return e}getColumnSize(e){if(!e)return null;if(-1!==e.toUpperCase().indexOf("BOOL"))return 1;let t=e.match(/\((\d+)\)/);return t&&t[1]?parseInt(t[1]):null}toValidTableName(e){return e.replace(/\.[^/.]+$/,"").replace(/[^a-zA-Z0-9]+/g,"_").toLowerCase().replace(/^_+|_+$/g,"")}importSheetFile(e,t){let a=this,i=e.name.split(".").pop().toLowerCase(),n=new FileReader;n.onload=function(n){let l=n.target.result;if("csv"===i){let r=Papa.parse(l,{header:!0}),s=r.meta.fields,o=r.data;t(i,e.name,null,s,o)}else if("dbf"===i){let c=new DBFParser(l),d=c.parse(),h=c.fields.map(e=>e.name);t(i,e.name,null,h,d)}else if("xlsx"===i||"xls"===i||"ods"===i){let m=new Uint8Array(l),u=XLSX.read(m,{type:"array"}),p=a=>{let n=u.SheetNames[a],l=XLSX.utils.sheet_to_json(u.Sheets[n],{defval:""});if(l.length>0){let r=Object.keys(l[0]);t(i,e.name,n,r,l)}};if(u.SheetNames.length>1){let y=`
<table class="two-side-table">
    <tbody>
        <tr>
            <td>Sheet to Import</td>
            <td>
                <select id="sheet-index" class="form-control">
                    ${u.SheetNames.map((e,t)=>`<option value="${t}">${t+1}. ${e}</option>`).join("")}
                </select>
            </td>
        </tr>
    </tbody>
</table>
                    `;a.showConfirmationDialog(y,"Select Sheet","OK","Cancel",function(e){if(e){let t=parseInt(qs("#sheet-index").value);p(t)}})}else p(0)}else a.showAlertDialog(`Unsupported file format: ${i}`,"Alert","OK")},"csv"===i?n.readAsText(e):n.readAsArrayBuffer(e)}importGraphQLSchema(){this.clearBeforeImport=!1,qs(this.selector+" .import-file-graphql").click()}processGraphQLSchema(e,t){let a=this,i=e.name.split(".").pop().toLowerCase(),n=new FileReader;n.onload=function(e){let n=e.target.result;if("graphql"===i){let l=GraphQLSchemaUtils.parseGraphQLSchema(n),r=GraphQLSchemaUtils.normalizeEntity(l.types,"snake"),s=GraphQLSchemaUtils.normalizeEntity(l.inputs,"snake"),o=[],c=0;for(let[d,h]of(a.clearBeforeImport||(c=a.entities.length),Object.entries(r))){let m=a.toValidTableName(d),u=a.generateColumnFromSchemaProperties(m,h),p=new Entity(a.snakeize(m),c);u.forEach(e=>{p.addColumn(e)}),o.push(p),c++}for(let[y,g]of Object.entries(s)){let f=a.toValidTableName(y),E=a.generateColumnFromSchemaProperties(f,g),b=new Entity(a.snakeize(f),c);E.forEach(e=>{b.addColumn(e)}),o.push(b),c++}if(a.clearBeforeImport)a.entities=o,a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{let v=[];a.entities.forEach(e=>{v.push(e.name)}),o.forEach(e=>{v.includes(e.name)||(e.index=a.entities.length,a.entities.push(e))}),a.renderEntities()}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram()}else a.showAlertDialog(`Unsupported file format: ${i}`,"Alert","OK")},n.readAsText(e)}parseFromMarkdown(e){let t=Date.now(),a=e.trim().split(/\r?\n/),i=[],n=0,l=0;for(;n<a.length;){let r=a[n].trim();if(r.startsWith("|")&&n+1<a.length&&a[n+1].includes("---")){let s=a[n];a[n+1];let o=[];for(n+=2;n<a.length&&a[n].trim().startsWith("|");)o.push(a[n]),n++;let c=s.replace(/^\||\|$/g,"").split("|").map(e=>e.trim()),d=o.map(e=>e.replace(/^\||\|$/g,"").split("|").map(e=>e.trim())),h=c.map((e,t)=>({name:this.snakeize(e),type:"VARCHAR",length:"50",nullable:!0,default:null,primaryKey:0===t,autoIncrement:!1,values:null,description:null})),m=d.map(e=>{let t={};return c.forEach((a,i)=>{t[this.snakeize(a)]=""===e[i]?null:e[i]}),t}),u=this.createTableName(l+1,t);i.push({index:l++,name:u,columns:h,data:m,description:"",creationDate:Date.now(),modificationDate:Date.now(),creator:"{{userName}}",modifier:"{{userName}}"})}else n++}return i}importFromMarkdown(e,t){let a=this.entities.length,i=this.parseFromMarkdown(e);i.forEach(e=>{let t=this.snakeize(e.name);if(!this.isEntityExists(t)){let i=new Entity(t,a);e.columns.forEach(e=>{let t=new Column(e.name,e.type,e.length,e.nullable,e.default,e.primaryKey,e.autoIncrement,e.description);i.addColumn(t)}),i.data=e.data,this.entities.push(i),a++}}),"function"==typeof t&&t(this.entities)}createTableName(e,t){return`table_${t}_${e}`}isMarkdownTable(e){return/^\s*\|(.+)\|\s*\r?\n\s*\|?[-:]+[-| :]*\|?\s*$/m.test(e)}fixPrimaryKeys(e){let t=this;return e.forEach(a=>{let i=a.columns.filter(e=>e.primaryKey);i.length>0&&i.forEach(i=>{if("VARCHAR"==i.type&&"255"==i.length){let n=t.getRealTypeFromOtherEntities(e,a.name,i.name);i.type=n.type,i.length=n.length}})}),e}getRealTypeFromOtherEntities(e,t,a){let i={},n={};e.forEach(e=>{e.name!==t&&e.columns.forEach(e=>{e.name===a&&(i[e.type]=(i[e.type]||0)+1,n[e.length]=(n[e.length]||0)+1)})});let l=(e,t)=>{let a=Object.entries(e);return 0===a.length?t:a.sort((e,t)=>t[1]-e[1])[0][0]};return{type:l(i,"VARCHAR"),length:l(n,"255")}}triggerImportFromClipboard(){this.importFromClipboardManually(),hideContextMenu()}async importFromClipboardManually(){this.clearBeforeImport=!1;try{let e=await navigator.clipboard.read(),t;for(let a of e)if(a.types.includes("text/html")){let i=await a.getType("text/html"),n=await i.text(),l=document.createElement("div");l.innerHTML=n;let r=l.querySelectorAll("table");if(r&&r.length>0){t=this.parseHtmlToJSON(r[0]),this.importFromData(t);return}}let s=await navigator.clipboard.readText();if(/create\s+table/i.test(s.trim())||/insert\s+into/i.test(s.trim()))this.parseCreateTable(s,function(e){let{applicationId:t,databaseName:a,databaseSchema:i,databaseType:n}=getMetaValues();sendEntityToServer(t,n,a,i,e)});else if(/[\"']__magic_signature__[\"']\s*:\s*[\"']MAGICAPPBUILDER-DB-DESIGN-V1[\"']/.test(s))try{editor.importJSONData(s,function(e,t){let{applicationId:a,databaseName:i,databaseSchema:n,databaseType:l}=getMetaValues();sendEntityToServer(a,l,i,n,e),sendDiagramToServer(a,l,i,n,t)})}catch(o){console.error("Invalid JSON format despite having signature:",o)}else _this.isMarkdownTable(s)?_this.importFromMarkdown(s,function(e){_this.renderEntities();let{applicationId:t,databaseName:a,databaseSchema:i,databaseType:n}=getMetaValues();sendEntityToServer(t,n,a,i,e)}):(t=this.parseTextToJSON(s),this.importFromData(t))}catch(c){console.error("Failed to read clipboard: ",c)}}parseCreateTable(e,t){let a=this,i=new SQLConverter,n=i.translate(e,"mysql").replace(/`/g,""),l=new TableParser(n);l.parseData(e);let r=editor.createEntitiesFromSQL(l.tableInfo);if(r&&r.length){if(a.clearBeforeImport)a.entities=r,r.forEach(e=>{let t=e.name;l.data?.[t]&&e.setData(l.data[t])}),a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{let s=a.entities.map(e=>e.name);r.forEach(e=>{s.includes(e.name)?l.data?.[e.name]&&a.getEntityByName(e.name).appendData(l.data[e.name]):(e.index=a.entities.length,l.data?.[e.name]&&e.setData(l.data[e.name]),a.entities.push(e))}),a.renderEntities()}}else if(l.data){for(let o in l.data)if(l.data.hasOwnProperty(o)){let c=a.getEntityByName(o);c&&c.appendData(l.data[o])}}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram()}importFromData(e){let t=e.headers.length>=2&&e.data.length>=1,a=e.headers.length>=1&&e.data.length>=2;if(!t&&!a){console.warn("Import aborted: Not enough columns or rows in clipboard data.");return}let i=this.generateCreateTable(e.headers,e.data);this.importFromSheet(i,this.getNewTableName()),this.currentEntityData=e.data}parseTextToJSON(e){let t=e.trim().replace(/\r\n/g,"\n").split("\n").map(e=>e.split("	").map(e=>e.trim()));for(;t.length&&t[0].every(e=>""===e);)t.shift();for(;t.length&&t[t.length-1].every(e=>""===e);)t.pop();function a(e){return 0===e.length||0===e[0].length?[]:e[0].map((t,a)=>e.map(e=>e[a]))}let i=a(t);for(;i.length&&i[0].every(e=>""===e);)i.shift();for(;i.length&&i[i.length-1].every(e=>""===e);)i.pop();if((t=a(i)).length<2)return{headers:[],data:[]};let n=t[0].map(e=>{var t;return t=e,t?t.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()):""}),l=t.slice(1).map(e=>{let t={};return n.forEach((a,i)=>{t[a]=e[i]??""}),t});return{headers:n,data:l}}isFromMagicAppBuilder(e){let t=!1;return e&&e.length>0&&e.forEach(e=>{e.classList.contains("entity-table")&&e.classList.contains("entity-table-magicappbuilder")&&(t=!0)}),t}parseHtmlTableFromDocument(e){e&&e.length>0&&e.forEach(e=>{if(e.classList.contains("entity-table")&&e.classList.contains("entity-table-magicappbuilder")){let t=e.dataset.name;if(t&&!this.getEntityByName(t)){let a=0,i=0,n=0,l=0,r=0,s=0,o=0,c=0;if(e.querySelectorAll("thead tr th").forEach((e,t)=>{let d=e.textContent.trim().toLowerCase();d.includes("name")?a=t:d.includes("type")?i=t:d.includes("length")?n=t:d.includes("nullable")?l=t:d.includes("default")?r=t:d.includes("pk")||d.includes("primary")?s=t:d.includes("serial")||d.includes("increment")||d.includes("identity")?o=t:(d.includes("description")||d.includes("comment"))&&(c=t)}),e.tBodies&&e.tBodies.length>0){let d=[];e.querySelectorAll("tbody tr").forEach(e=>{let t=e.querySelectorAll("td"),h=t[a]?.textContent.trim()||"",m=t[i]?.textContent.trim()||"VARCHAR",u=t[n]?.textContent.trim()||"",p="true"===(t[l]?.textContent.trim()||"").toLowerCase(),y=t[r]?.textContent.trim()||"",g="true"===(t[s]?.textContent.trim()||"").toLowerCase(),f="true"===(t[o]?.textContent.trim()||"").toLowerCase(),E=t[c]?.textContent.trim()||"",b=new Column(h,m,u,p,y,g,f,"",E);d.push(b)});let h=new Entity(t,this.entities.length);d.length>0&&(h.columns=d,this.entities.push(h))}}}}),this.renderEntities(),this.callbackSaveEntity(this.entities)}parseHtmlToJSON(e){let t=[],a=[],i=[];function n(e){return e?e.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()):""}if(e.tHead){let l=e.tHead.querySelector("tr");a=Array.from(l.children).map(e=>n(e.textContent.trim())),i=Array.from(e.tBodies?.[0]?.rows||[])}else{let r=Array.from(e.rows);if(r.length>0){let s=r[0];a=Array.from(s.children).map(e=>n(e.textContent.trim())),i=r.slice(1)}}if(0===a.length)return{headers:[],data:[]};for(let o of i){let c={},d=Array.from(o.cells);for(let h=0;h<a.length;h++){let m=a[h],u=d[h];u?c[m]=u.textContent.trim():c[m]=null}t.push(c)}return{headers:a,data:t}}snakeizeData(e,t){let a=t.map(e=>e.name),i=[];if(Array.isArray(e))for(let n of e){let l={};for(let r of Object.keys(n)){let s=this.snakeize(r);a.includes(s)&&(l[s]=n[r])}i.push(l)}return i}snakeizeKey(e){let t=[];if(Array.isArray(e))for(let a of e){let i={};for(let n of Object.keys(a)){let l=this.snakeize(n);i[l]=a[n]}t.push(i)}return t}snakeizeObjectKeys(e){let t={};for(let a in e)if(Object.prototype.hasOwnProperty.call(e,a)){let i=this.snakeize(a);t[i]=e[a]}return t}guessType(e){let t=!0,a=!0,i=!0,n=!1;for(let l of e.slice(0,24)){if(null==l)return"TEXT";l="string"!=typeof l?String(l).trim():l.trim(),/^0\d+/.test(l)&&(t=!1,a=!1),/^[-+]?\d+\.\d+$/.test(l)&&(n=!0),/^[-+]?\d+$/.test(l)||(t=!1),/^[-+]?\d+(\.\d+)?$/.test(l)||(a=!1),/^(true|false|yes|no|1|0)$/i.test(l)||(i=!1)}return a&&n?"FLOAT":t?"BIGINT":i?"BOOLEAN":"TEXT"}generateCreateTable(e,t){let a=this;this.maxLength={};let i=e.map(e=>{let i=a.snakeize(e),n=t.map(t=>t[e]),l=0;n.forEach(e=>{if("string"==typeof e||"number"==typeof e){let t=String(e).length;t>l&&(l=t)}}),a.maxLength[i]=10*Math.ceil(l/10);let r=a.guessType(n);return new Column(i,r,null,!0,null,!1,!1,null,null)});return i}snakeize(e){return e.replace(/[_\-]+/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/[^a-zA-Z0-9 ]+/g,"").toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()).replace(/\s+/g,"_").toLowerCase().replace(/^_+|_+$/g,"").replace(/__+/g,"_")}uploadEntities(){this.clearBeforeImport=!0,qs(this.selector+" .import-file-json").click()}importSQL(){this.clearBeforeImport=!1,qs(this.selector+" .import-file-sql").click()}importSheet(){this.clearBeforeImport=!1,qs(this.selector+" .import-file-sheet").click()}async downloadEntities(){let{applicationId:e,databaseName:t,databaseSchema:a,databaseType:i}=getMetaValues(),n=buildUrl("entity",e,i,t,a,[]);try{let l=await fetch(n);if(!l.ok)throw Error(`Failed to fetch: ${l.status} ${l.statusText}`);let r=await l.text(),s=new Blob([r],{type:"application/json"}),o=URL.createObjectURL(s),c=document.createElement("a");c.href=o,c.download=e+".json",c.click(),URL.revokeObjectURL(o)}catch(d){console.error("Error downloading entities:",d)}}getData(){return{entities:this.entities}}showAlertDialog(e,t,a,i){let n=qs("#asyncAlert"),l=n.querySelector(".alert-ok");function r(){n.style.display="none","function"==typeof i&&i()}l=this.removeAllEventListeners(l),n.querySelector(".modal-header h3").innerHTML=t,n.querySelector(".modal-body").innerHTML=e,l.innerHTML=a,n.style.display="block",l._handler&&l.removeEventListener("click",l._handler),l._handler=r,l.addEventListener("click",r),l.focus()}showConfirmationDialog(e,t,a,i,n){let l=qs("#asyncConfirm"),r=l.querySelector(".confirm-ok"),s=l.querySelector(".confirm-cancel");function o(){l.style.display="none",n(!0)}function c(){l.style.display="none",n(!1)}r=this.removeAllEventListeners(r),s=this.removeAllEventListeners(s),l.querySelector(".modal-header h3").innerHTML=t,l.querySelector(".modal-body").innerHTML=e,r.innerHTML=a,s.innerHTML=i,l.style.display="block",r._handler&&r.removeEventListener("click",r._handler),s._handler&&s.removeEventListener("click",s._handler),r._handler=o,s._handler=c,r.addEventListener("click",o),s.addEventListener("click",c)}showDescriptionDialog(){let e=this,t=e.entities[e.currentEntityIndex].name,a=e.entities[e.currentEntityIndex].description||"",i="#exportModal";showExportDialog(i,'<textarea class="description-textarea" placeholder="Enter description here..." spellcheck="false" autocomplete="off"></textarea>',`Entity Description - ${t}`,"Save","Cancel",function(t){t&&(e.entities[e.currentEntityIndex].description=qs(i+" .description-textarea").value,e.callbackSaveEntity(e.entities)),qs(i).style.display="none"}),qs(i+" .description-textarea").value=a}removeAllEventListeners(e){let t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t}createDataTypeOption(e,t){let a="";return a+=`<select name="${e}" onchange="editor.setDefaultLength(this, '${t}')">\r
`,this.mysqlDataTypes.forEach(e=>{a+=`<option value="${e}">${e}</option>\r
`}),a+="</select>"}setDefaultLength(e,t){let a=e.value;void 0!==this.defaultLength[a]&&(qs(t).value=this.defaultLength[a])}preference(){let e=this;e.showSettingDialog(`
<table class="two-side-table">
    <tbody>
        <tr>
            <td>Primary Key Type</td>
            <td>${e.createDataTypeOption("primary_key_type","#primary_key_length")}</td>
        </tr>
        <tr>
            <td>Primary Key Length</td>
            <td><input type="text" name="primary_key_length" id="primary_key_length" value=""></td>
        </tr>
        <tr>
            <td>Column Type</td>
            <td>${e.createDataTypeOption("column_type","#column_length")}</td>
        </tr>
        <tr>
            <td>Column Length</td>
            <td><input type="text" name="column_length" id="column_length" value=""></td>
        </tr>
    </tbody>
</table>
`,"Preferences","OK","Cancel",function(t){t&&(e.primaryKeyDataType=qs('[name="primary_key_type"]').value,e.primaryKeyDataLength=qs('[name="primary_key_length"]').value,e.defaultDataType=qs('[name="column_type"]').value,e.defaultDataLength=qs('[name="column_length"]').value,"function"==typeof e.callbackSaveConfig&&e.callbackSaveConfig({primaryKeyDataType:e.primaryKeyDataType,primaryKeyDataLength:e.primaryKeyDataLength,defaultDataType:e.defaultDataType,defaultDataLength:e.defaultDataLength}))}),qs('[name="primary_key_type"]').value=e.primaryKeyDataType,qs('[name="primary_key_length"]').value=e.primaryKeyDataLength,qs('[name="column_type"]').value=e.defaultDataType,qs('[name="column_length"]').value=e.defaultDataLength}showSettingDialog(e,t,a,i,n){let l=qs("#settingModal"),r=l.querySelector(".confirm-ok"),s=l.querySelector(".confirm-cancel");l.querySelector(".modal-header h3").innerHTML=t,l.querySelector(".modal-body").innerHTML=e,r.innerHTML=a,s.innerHTML=i,l.style.display="block",r._handler&&r.removeEventListener("click",r._handler),s._handler&&s.removeEventListener("click",s._handler);let o=()=>{l.style.display="none",n(!0)},c=()=>{l.style.display="none",n(!1)};r._handler=o,s._handler=c,r.addEventListener("click",o),s.addEventListener("click",c)}showEntityDataDialog(e,t,a){let i=qs("#entityDataEditorModal"),n=i.querySelector(".modal-header h3"),l=i.querySelector(".modal-body"),r=e.data||[];i.dataset.index=t,n.innerHTML=a||"Entity Data",l.innerHTML="";let s=document.createElement("div");s.style.overflow="auto",s.style.maxHeight="400px";let o=document.createElement("table");o.className="data-preview-table",o.style.width="100%",o.style.borderCollapse="collapse";let c=document.createElement("thead"),d=document.createElement("tr"),h=document.createElement("th");h.classList.add("td-remover"),d.appendChild(h);let m=document.createElement("tbody");o.appendChild(c),o.appendChild(m),s.appendChild(o),l.appendChild(s);let u=document.createElement("div");u.innerHTML=`
<div class="suggestions-container"><span class="suggestions"></span> &nbsp;</div>
Fix Date Time
<select id="selector-fix-date-time" class="form-control">
</select>
Format
<select id="format-preference" class="form-control">
    <option value="mdy">mdy</option>
    <option value="dmy">dmy</option>
    <option value="ymd">ymd</option>
</select>
Mode
<select id="date-time-mode" class="form-control">
    <option value="datetime">datetime</option>
    <option value="date">date</option>
    <option value="time">time</option>
</select>
<button ="button-fix-date-time" class="btn btn-primary" onclick="editor.fixDateTime(this.closest('div').querySelector('#selector-fix-date-time').value, this.closest('div').querySelector('#format-preference').value, this.closest('div').querySelector('#date-time-mode').value)">Fix Data</button>
<span class="autocomplete-list-container" data-empty="true"></span>
        `;let p=document.createElement("option");p.value="",p.textContent="Select Column",u.classList.add("button-area"),l.appendChild(u),u.querySelector("select").appendChild(p),i.style.display="block",e.columns.forEach(e=>{let t=document.createElement("th");t.classList.add("entity-column"),t.textContent=e.name,t.dataset.name=e.name,d.appendChild(t);let a=document.createElement("option");a.value=e.name,a.textContent=e.name,u.querySelector("select").appendChild(a)}),c.appendChild(d),r.forEach((t,a)=>{let i=document.createElement("tr"),n=document.createElement("td");n.classList.add("td-remover");let l=document.createElement("a");l.className="delete-row",l.href="javascript:",l.textContent="❌",n.appendChild(l),i.appendChild(n),e.columns.forEach((e,n)=>{let l=this.createEntityDataCell(a,n,e,t[e.name]??"");i.appendChild(l)}),m.appendChild(i),l.addEventListener("click",function(e){e.preventDefault(),m.removeChild(i)})})}manageGraphQlAppProfile(){let e=this;this.showProfileDialog(document.createElement("div"),"GraphQl Application","OK","Cancel",function(t){if(t){let a=qs(".graphql-app-profile"),i=a.value;a.innerHTML="";let n="";for(let l in e.graphqlAppProfile){let r=e.graphqlAppProfile[l],s=new Option(r.profileLabel,r.profileName);a.add(s),""==n&&(n=r.profileName)}""==i&&(i=n),e.gqlSetActiveProfile(i),e.gqlSaveProfile()}}),this.gqlRenderTable()}gqlSaveProfile(){let{applicationId:e,databaseName:t,databaseSchema:a,databaseType:i}=getMetaValues();fetch(`../lib.ajax/load-graphql-entity-index.php?applicationId=${encodeURIComponent(e)}&databaseType=${encodeURIComponent(i)}&databaseName=${encodeURIComponent(t)}&databaseSchema=${encodeURIComponent(a)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.graphqlAppProfile)}).then(e=>e.json()).then(e=>{}).catch(e=>{console.error("Failed to send GraphQL profile data:",e)})}gqlRenderTable(e=!1){let t=qs("#profileModal .modal-body");t.innerHTML=`
<table id="optionTable" class="table dialog-table profile-table">
    <thead>
        <tr>
            <td width="30%">Value</td>
            <td width="55%">Text</td>
            <td width="15%">Action</td>
        </tr>
    </thead>
    <tbody></tbody>
</table>
        `;let a=document.createElement("tbody");for(let i in this.graphqlAppProfile)if(this.graphqlAppProfile.hasOwnProperty(i)){let n=this.graphqlAppProfile[i],l=document.createElement("tr");l.dataset.key=i,l.dataset.hasData=n.hasData?"true":"false",l.innerHTML=`
<td><input type="text" class="form-control profile-name" value="${n.profileName}"></td>
<td><input type="text" class="form-control profile-label" value="${n.profileLabel}"></td>
<td>
    <button class="btn btn-tn" onclick="editor.gqlDeleteRow(this)">Delete</button>
</td>
                `,a.appendChild(l)}let r=document.createElement("tr");r.innerHTML=`
<td><input type="text" class="form-control profile-name" placeholder="Value"></td>
<td><input type="text" class="form-control profile-label" placeholder="Text"></td>
<td><button class="btn btn-tn" onclick="editor.gqlAddRow(this)">Add</button></td>
        `,r.dataset.hasData="false",a.appendChild(r),t.querySelector("table").appendChild(a),e&&r.querySelector(".profile-name").focus()}gqlSetActiveProfile(e){if(""!=e&&this.graphqlAppProfile[e])for(let t in this.graphqlAppProfile)t==e?this.graphqlAppProfile[t].selected=!0:this.graphqlAppProfile[t].selected=!1}gqlChangeProfile(){let e=qs(".graphql-app-profile");this.gqlSaveProfile(e.value),this.loadGraphQlAppConfiguration()}gqlAddRow(e){this.gqlUpdateRow(e)}gqlUpdateRow(e){let t=e.closest("tr"),a=t.querySelector("input.profile-name").value.trim(),i=t.querySelector("input.profile-label").value.trim(),n=t.dataset.hasData;a&&i&&(this.graphqlAppProfile[a]={profileName:a,profileLabel:i,hasData:"true"==n},this.gqlRenderTable())}gqlDeleteRow(e){let t=this,a=e.closest("tr"),i=a.querySelector("input.profile-name").value,n=a.querySelector("input.profile-label").value;i&&("true"==a.dataset.hasData?this.showConfirmationDialog(`Deleting this profile file also delete data saved in the server.<br>Are you sure you want to detele "${n}"?`,"Delete Profile Confirmation","OK","Cancel",function(e){e&&(delete t.graphqlAppProfile[i],t.gqlRenderTable())}):(delete this.graphqlAppProfile[i],this.gqlRenderTable()))}showProfileDialog(e,t,a,i="",n=null){let l=qs("#profileModal"),r=l.querySelector(".confirm-ok"),s=l.querySelector(".confirm-cancel");function o(){l.style.display="none",n(!0)}function c(){l.style.display="none",n(!1)}l.querySelector(".modal-header h3").innerHTML=t,l.querySelector(".modal-body").innerHTML="",l.querySelector(".modal-body").appendChild(e),r.innerHTML=a,i.length>0?(s.innerHTML=i,s.style.display=""):(s.innerHTML="",s.style.display="none"),l.style.display="block",r._handler&&r.removeEventListener("click",r._handler),s._handler&&s.removeEventListener("click",s._handler),r._handler=o,s._handler=c,r.addEventListener("click",o),s.addEventListener("click",c)}createEntityDataCell(e,t,a,i="",n=!1,l=null){let r=document.createElement("td");r.classList.add("entity-column");let s=document.createElement("input");if(s.type="text",s.classList.add("entity-data-cell"),s.name=`cell-${e}-${t}`,s.dataset.row=e,s.dataset.col=a.name,s.dataset.type=a.type,s.value=i??"",s.setAttribute("autocomplete","off"),s.style.width="100%",s.style.boxSizing="border-box",n){let o=qs(".suggestions");s.setAttribute("list",l),s.addEventListener("input",()=>{let e=s.value,t=qsa("#"+l+" option"),a=!1;for(let i of t)if(i.value===e){o.textContent=i.dataset.info||"",a=!0;break}a||(o.textContent="")})}return r.appendChild(s),r}exportData(){let e=this.entities[this.currentEntityIndex],t=[],a=[];qs(".data-preview-table").querySelector("thead").querySelectorAll("th.entity-column").forEach(e=>{t.push(e.dataset.name)});let i=qs(".data-preview-table").querySelector("tbody").querySelectorAll("tr");i&&i.forEach(e=>{let t={};e.querySelectorAll("td.entity-column").forEach(e=>{let a=e.querySelector("input");a&&a.name&&(t[a.dataset.col]=a.value)}),a.push(t)});let n=[];n.push(t.join(",")),a.forEach(e=>{let a=t.map(t=>`"${(e[t]||"").replace(/"/g,'""')}"`);n.push(a.join(","))});let l=n.join("\n"),r=new Blob([l],{type:"text/csv"}),s=URL.createObjectURL(r),o=document.createElement("a");o.href=s,o.download=`${e.name}.csv`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}clearData(){this.showConfirmationDialog("Are you sure you want to delete all data?","Clear Entity Data Confirmation","Yes","No",e=>{e&&(qs(".data-preview-table tbody").innerHTML="")})}isAutocompleteListEmpty(){return"true"==qs(".autocomplete-list-container").dataset.empty}addAutocompleteList(e){if(this.isAutocompleteListEmpty()){let t=qs(".autocomplete-list-container");t.dataset.empty="false",t.innerHTML="",e.columns.forEach(e=>{if(e.name.length>3&&e.name.endsWith("_id")){let a=e.name.substring(0,e.name.length-3),i=this.getEntityByName(a);if(i&&i.data.length>0){let n=document.createElement("datalist");n.setAttribute("id",`list${a}`),i.data.forEach(t=>{let a=document.createElement("option"),i=t[e.name],l=t.name||t.nama||t.description||"";void 0!==i&&(a.value=t[e.name],a.dataset.info=l,n.appendChild(a))}),t.appendChild(n)}}})}}addData(e=!1){let t=qs("#entityDataEditorModal"),a=parseInt(t.dataset.index),i=this.entities[a];e&&this.addAutocompleteList(i);let n=t.querySelector(".data-preview-table tbody");if(!n)return console.warn("Table body for entity data editor not found."),null;let l=n.rows.length,r=document.createElement("tr"),s=document.createElement("td");s.classList.add("td-remover");let o=document.createElement("a");return o.className="delete-row",o.href="javascript:void(0);",o.textContent="❌",s.appendChild(o),r.appendChild(s),i.columns.forEach((t,a)=>{let i=null;e&&t.name.length>3&&t.name.endsWith("_id")&&(i=`list${t.name.substring(0,t.name.length-3)}`);let n=this.createEntityDataCell(l,a,t,"",e,i);r.appendChild(n)}),o.addEventListener("click",function(e){e.preventDefault(),r.remove()}),n.appendChild(r),r}saveData(){let e=qs("#entityDataEditorModal"),t=parseInt(e.dataset.index),a=this.entities[t],i=e.querySelectorAll(".data-preview-table input"),n={};i.forEach(e=>{let t=e.dataset.row,a=e.dataset.col;n[t]||(n[t]={}),n[t][a]=e.value});let l=Object.keys(n).sort((e,t)=>parseInt(e)-parseInt(t)).map(e=>n[e]);a.setData(l);let{applicationId:r,databaseName:s,databaseSchema:o,databaseType:c}=getMetaValues();sendEntityToServer(r,c,s,o,this.entities),this.exportToSQL(this.getSelectedDialect(),this.isGenerateForeignKey(),this.isGenerateIndex()),e.style.display="none"}async exportHTMLDocument(e,t=!1){let a=[],i=[];e.forEach(e=>{e.entities&&e.entities.forEach(e=>{e&&!a.includes(e)&&a.push(e)});let t=qs(`#${e.id}`);if(t){t.dataset.name=e.name;let n=t.cloneNode(!0);i.push(n)}});let n=document.createElement("div");for(let l of(n.classList.add("export-container"),e)){let r=document.createElement("div");r.className="diagram-section";let s=i.find(e=>e.dataset.name===l.name);if(s){let o=document.createElement("div");o.className="svg-wrapper";let c=document.createElement("h3");if(c.textContent=`Diagram: ${s.dataset.name}`,o.appendChild(c),t)try{let d=s.querySelector("svg"),h=await convertSvgToPng(d),m=document.createElement("img");m.src=h,o.appendChild(m)}catch(u){console.error("❌ Failed to convert SVG to PNG",u),o.appendChild(s)}else o.appendChild(s);r.appendChild(o)}l.entities&&l.entities.forEach(e=>{let t=this.getEntityByName(e);if(t){let a=document.createElement("div");a.className="table-wrapper";let i=document.createElement("h3");i.textContent=`Entity: ${e}`,a.appendChild(i),t.description?.trim()&&t.description.trim().split(/\r?\n/).map(e=>e.trim()).filter(e=>""!==e).forEach(e=>{let t=document.createElement("p");t.textContent=e,a.appendChild(t)});let n=this.createHtmlEntity(t);a.appendChild(n),r.appendChild(a)}}),n.appendChild(r)}let p=document.createElement("div");p.classList.add("table-wrapper");let y=document.createElement("h3");y.textContent="Table: Entities Ordered by Dependency Depth",p.appendChild(y);let g=this.sortEntitiesByDepth(this.calculateEntityDepth(this.entities)),f=document.createElement("table"),E=document.createElement("thead"),b=document.createElement("tbody"),v=document.createElement("tr");f.appendChild(E),f.appendChild(b),E.appendChild(v);let x=document.createElement("th");x.classList.add("column-number"),x.textContent="#",v.appendChild(x);let C=document.createElement("th");C.textContent="Entity Name",v.appendChild(C);let D=document.createElement("th");D.textContent="Dependency Depth",v.appendChild(D),g.forEach((e,t)=>{let a=e.depth-1;a<0&&(a=0);let i=document.createElement("tr"),n=document.createElement("td");n.classList.add("column-number"),n.textContent=`${t+1}`,i.appendChild(n);let l=document.createElement("td");l.textContent=e.name,i.appendChild(l);let r=document.createElement("td");r.textContent=a,i.appendChild(r),b.appendChild(i)}),p.appendChild(f),n.appendChild(p);let S=new Date,L=S.toLocaleString(),k=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Exported Diagrams</title>
<style>
    body { font-family: Arial; font-size: 12px; margin: 20px; }
    .document-center { text-align: center; }
    .generated-info { text-align: center; font-size: 11px; color: #666; margin-bottom: 20px; }

    .diagram-section {
        margin-bottom: 30px;
        border-radius: 8px;
        padding: 10px;
        page-break-after: always;
    }

    @media screen {
        .diagram-section {
            border: 1px solid #ccc;
            border-radius: 8px;
        }
    }

    @media print {
        .diagram-section {
            border: none !important;
            border-radius: 0 !important;
        }
    }

    .svg-wrapper { text-align: center; margin-bottom: 10px; }
    .svg-wrapper svg { max-width: 100%; height: auto; }
    .table-wrapper { overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; font-size: 11px; }
    th, td { border: 1px solid #999; padding: 6px; text-align: left; }
    th { background-color: #eee; }

    @media print {
        body { font-size: 10px; margin: 10mm; }
        h3 { font-size: 14px; margin-bottom: 5px; }
        .svg-wrapper svg, .table-wrapper table { page-break-inside: avoid; }
    }
    .column-number{
        width: 16px;
    }
    th.column-number{
        text-align: center;
    }
    td.column-number{
        text-align: right;
    }
</style></head>
<body>
    <h1 class="document-center">Entity Relationship Diagram</h1>
    <div class="generated-info">Generated at: ${L}</div>
    ${n.innerHTML}
</body></html>
`,w=new Blob([k],{type:"text/html"}),T=URL.createObjectURL(w),$=document.createElement("a");$.href=T,$.download="diagrams.html",$.click(),URL.revokeObjectURL(T)}createHtmlEntity(e){let t=this,a=document.createElement("table");a.dataset.name=e.name,a.classList.add("entity-table"),a.classList.add("entity-table-magicappbuilder");let i=document.createElement("thead"),n=document.createElement("tr"),l=["20%","14%","9%","9%","9%","8%","8%","23%"],r=["Column Name","Type","Length","Nullable","Default","PK","Serial","Description"];["columnName","type","length","nullable","default","primaryKey","autoIncrement","description"].forEach((e,t)=>{let a=document.createElement("th");a.textContent=r[t],a.style.width=l[t],n.appendChild(a)}),i.appendChild(n),a.appendChild(i);let s=document.createElement("tbody");return e.columns.forEach(e=>{let a=t.createHtmlColumn(e);s.appendChild(a)}),a.appendChild(s),a}createHtmlColumn(e){let t=document.createElement("tr");return e.primaryKey=1==e.primaryKey||!0===e.primaryKey,["name","type","length","nullable","default","primaryKey","autoIncrement","description"].forEach(a=>{let i=document.createElement("td");i.textContent="boolean"==typeof e[a]?!0===e[a]?"true":"false":e[a],t.appendChild(i)}),t}camelToTitle(e){return e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase())}showExportHTMLDialog(){let e=document.createElement("div");e.classList.add("diagram-export-selector");let t=document.createElement("ul"),a=qsa(".diagram-tab");if(a){let i=document.createElement("input"),n=document.createElement("label"),l="cbd-all",r=document.createElement("li");n.setAttribute("for",l),n.textContent="Select All",i.setAttribute("type","checkbox"),i.id=l,i.setAttribute("onchange","checkAllDiagram(event)"),r.appendChild(i),r.appendChild(document.createTextNode(" ")),r.appendChild(n),t.appendChild(r);let s=document.createElement("li"),o=document.createElement("ul");t.appendChild(s),s.appendChild(o),a.forEach((e,t)=>{let a=e.querySelector("input");r=document.createElement("li");let i=document.createElement("input");n=document.createElement("label"),l=`cbd-${t}`,n.setAttribute("for",l),n.textContent=a.value,i.setAttribute("type","checkbox"),i.setAttribute("value",e.dataset.index),i.classList.add("diagram-to-export"),i.id=l,r.appendChild(i),r.appendChild(document.createTextNode(" ")),r.appendChild(n),o.appendChild(r)}),r=document.createElement("li");let c=document.createElement("input");n=document.createElement("label"),l="export-use-png",n.setAttribute("for",l),n.textContent="Export Image as PNG instead of SVG",c.setAttribute("type","checkbox"),c.id=l,c.classList.add("export-as-png"),r.appendChild(c),r.appendChild(document.createTextNode(" ")),r.appendChild(n),t.appendChild(r)}e.appendChild(t),editor.showConfirmationDialog(e.outerHTML,"Export Document","Export","Cancel",function(e){if(e){let t=qsa(".diagram-to-export"),a=[];t.forEach(e=>{if(e.checked){let t=parseInt(e.value);a.push(editor.diagrams[t])}});let i=document.getElementById("export-use-png").checked;editor.exportHTMLDocument(a,i)}})}calculateEntityDepth(e,t=!1){let a=Object.fromEntries(e.map(e=>[e.name,e])),i={};for(let n of e){let l=n.columns.filter(e=>e.name.endsWith("_id")).map(e=>e.name.replace(/_id$/,"")).filter(e=>e!==n.name&&a[e]);i[n.name]=l}let r=new Map;function s(e,t=new Set){if(r.has(e))return r.get(e);if(t.has(e))return 0;t.add(e);let a=i[e]||[],n=a.length>0?Math.max(...a.map(e=>s(e,new Set(t)))):0,l=n+1;return r.set(e,l),l}for(let o of e)o.depth=s(o.name);if(t){let c=Math.max(...e.map(e=>e.depth));for(let d of e)d.depth=c-d.depth}return e}sortEntitiesByDepth(e,t=!1){if(t){let a=Math.max(...e.map(e=>e.depth));for(let i of e)i.depth=a-i.depth}return[...e].sort((e,t)=>e.depth-t.depth)}parseDateTime(e,t="ymd"){if(e instanceof Date&&!isNaN(e.getTime()))return e;if("number"==typeof e){let a=new Date(Date.UTC(1899,11,30)),i=new Date(a.getTime()+864e5*(e>60?e-1:e));return isNaN(i.getTime())?null:i}if("string"!=typeof e)return null;let n=e.trim(),l=new Date(n);if(!isNaN(l.getTime()))return l;let r={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11,january:0,february:1,march:2,april:3,june:5,july:6,august:7,september:8,october:9,november:10,december:11},s=n.match(/^(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})(?:[,\s]+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$|^([A-Za-z]+)\s+(\d{1,2}),?\s+(\d{4})(?:[,\s]+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);if(s){let o,c,d,h,m,u;if(s[1]?(o=parseInt(s[1],10),c=r[s[2].toLowerCase()],d=parseInt(s[3],10),h=parseInt(s[4]||"0",10),m=parseInt(s[5]||"0",10),u=parseInt(s[6]||"0",10)):(o=parseInt(s[8],10),c=r[s[7].toLowerCase()],d=parseInt(s[9],10),h=parseInt(s[10]||"0",10),m=parseInt(s[11]||"0",10),u=parseInt(s[12]||"0",10)),void 0!==c&&!isNaN(o)&&!isNaN(d)){let p=new Date(d,c,o,h,m,u||0);if(p.getDate()===o&&p.getMonth()===c)return p}}let y=n.match(/^(\d{1,4})[\/\-](\d{1,2})[\/\-](\d{1,4})(?:[\sT](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);if(y){let g,f,E,b=parseInt(y[1],10),v=parseInt(y[2],10),x=parseInt(y[3],10),C=parseInt(y[4]||"0",10),D=parseInt(y[5]||"0",10),S=parseInt(y[6]||"0",10);switch(t){case"dmy":E=b,f=v,g=x;break;case"mdy":f=b,E=v,g=x;break;default:g=b,f=v,E=x}let L=new Date(g,f-1,E,C,D,S);if(!isNaN(L.getTime())&&L.getFullYear()===g&&L.getMonth()===f-1&&L.getDate()===E)return L}return null}formatDateTimeForMySQL(e,t="datetime"){if(!(e instanceof Date)||isNaN(e))return"";let a=e=>e.toString().padStart(2,"0"),i=e.getFullYear(),n=a(e.getMonth()+1),l=a(e.getDate()),r=a(e.getHours()),s=a(e.getMinutes()),o=a(e.getSeconds());switch(t){case"date":return`${i}-${n}-${l}`;case"time":return`${r}:${s}:${o}`;default:return`${i}-${n}-${l} ${r}:${s}:${o}`}}fixDateTime(e,t="ymd",a="datetime"){let i=this,n=qs(".data-preview-table tbody").querySelectorAll(`[data-col="${e}"]`);n&&n.length>0&&n.forEach(e=>{let n=i.parseDateTime(e.value,t);null!=n&&(e.value=i.formatDateTimeForMySQL(n,a))})}deleteAllEntities(){let e=this;hideContextMenu(),this.showConfirmationDialog("Deleting all entities cannot be undone. This action will also delete all diagrams.<br>It is recommended to create a backup before proceeding.<br><br>Are you sure you want to delete them now?","Delete All Entities","Confirm","Cancel",t=>{t&&(e.diagrams=[],e.destroyAllDiagram(),e.callbackSaveDiagram(e.diagrams),e.entities=[],e.renderEntities(),e.callbackSaveEntity(e.entities))})}deleteAllDiagrams(){let e=this;hideContextMenu(),this.showConfirmationDialog("Deleting all diagrams cannot be undone. It is recommended to create a backup before proceeding.<br>Are you sure you want to delete them now?","Delete All Diagrams","Confirm","Cancel",t=>{t&&(e.diagrams=[],e.destroyAllDiagram(),e.callbackSaveDiagram(e.diagrams))})}destroyAllDiagram(){let e=qsa(".entities-container .diagram-list.tabs .diagram-tab"),t=qsa(".entities-container .diagram-container .diagram-entity");e?.length&&e.forEach(e=>{e.parentNode.removeChild(e)}),t?.length&&t.forEach(e=>{e.parentNode.removeChild(e)})}getSelectedDialect(){return qs('meta[name="database-type"]').getAttribute("content")}isGenerateForeignKey(){return qs(".with-foreign-key").checked}isGenerateIndex(){return qs(".with-index").checked}}let tabDragger=null;