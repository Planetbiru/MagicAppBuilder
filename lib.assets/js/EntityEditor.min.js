class EntityEditor{constructor(e,t={}){this.setting={defaultDataType:"VARCHAR",defaultDataLength:"48",primaryKeyDataType:"VARCHAR",primaryKeyDataLength:"40"},this.keyWords="absolute,action,add,after,aggregate,alias,all,allocate,alter,analyse,analyze,and,any,are,array,as,asc,assertion,at,authorization,avg,before,begin,between,binary,bit,bit_length,blob,boolean,both,breadth,by,call,cascade,cascaded,case,cast,catalog,char,character,character_length,char_length,check,class,clob,close,coalesce,collate,collation,column,commit,completion,connect,connection,constraint,constraints,constructor,continue,convert,corresponding,count,create,cross,cube,current,current_date,current_path,current_role,current_time,current_timestamp,current_user,cursor,cycle,data,date,day,deallocate,dec,decimal,declare,default,deferrable,deferred,delete,depth,deref,desc,describe,descriptor,destroy,destructor,deterministic,diagnostics,dictionary,disconnect,distinct,do,domain,double,drop,dynamic,each,else,end,end-exec,equals,escape,every,except,exception,exec,execute,exists,external,extract,false,fetch,first,float,for,foreign,found,free,from,full,function,general,get,global,go,goto,grant,group,grouping,having,host,hour,identity,ignore,immediate,in,indicator,initialize,initially,inner,inout,input,insensitive,insert,int,integer,intersect,interval,into,is,isolation,iterate,join,key,language,large,last,lateral,leading,left,less,level,like,limit,local,localtime,localtimestamp,locator,lower,map,match,max,min,minute,modifies,modify,month,names,national,natural,nchar,nclob,new,next,no,none,not,null,nullif,numeric,object,octet_length,of,off,offset,old,on,only,open,operation,option,or,order,ordinality,out,outer,output,overlaps,pad,parameter,parameters,partial,path,placing,position,postfix,precision,prefix,preorder,prepare,preserve,primary,prior,privileges,procedure,public,read,reads,real,recursive,ref,references,referencing,relative,restrict,result,return,returns,revoke,right,role,rollback,rollup,routine,row,rows,savepoint,schema,scope,scroll,search,second,section,select,sequence,session,session_user,set,sets,size,smallint,some,space,specific,specifictype,sql,sqlcode,sqlerror,sqlexception,sqlstate,sqlwarning,start,state,statement,static,structure,substring,sum,system_user,table,temporary,terminate,than,then,time,timestamp,timezone_hour,timezone_minute,to,trailing,transaction,translate,translation,treat,trigger,trim,true,under,union,unique,unknown,unnest,update,upper,usage,user,using,value,values,varchar,variable,varying,view,when,whenever,where,with,without,work,write,year,zone".split(","),Object.assign(this.setting,t),this.selector=e,this.entities=[],this.diagrams=[],this.currentEntityIndex=-1,this.mysqlDataTypes=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT","NUMERIC","DECIMAL","DOUBLE","FLOAT","BIT","DATE","TIME","DATETIME","TIMESTAMP","YEAR","LONGTEXT","MEDIUMTEXT","TEXT","TINYTEXT","VARCHAR","CHAR","ENUM","SET","LONGBLOB","MEDIUMBLOB","BLOB","TINYBLOB","UUID","VARBINARY","BINARY","POLYGON","LINESTRING","POINT","GEOMETRY","JSON",],this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.defaultLength={BIGINT:20,INT:11,MEDIUMINT:8,SMALLINT:5,TINYINT:4},this.autonumberTypes=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT"],this.addDomListeners(),this.callbackLoadEntity=this.setting.callbackLoadEntity,this.callbackSaveEntity=this.setting.callbackSaveEntity,this.callbackSaveDiagram=this.setting.callbackSaveDiagram,this.callbackLoadTemplate=this.setting.callbackLoadTemplate,this.callbackSaveTemplate=this.setting.callbackSaveTemplate,this.callbackSaveConfig=this.setting.callbackSaveConfig,this.defaultDataType=this.setting.defaultDataType+"",this.defaultDataLength=this.setting.defaultDataLength+"",this.primaryKeyDataType=this.setting.primaryKeyDataType+"",this.primaryKeyDataLength=this.setting.primaryKeyDataLength+"","function"==typeof this.callbackLoadEntity&&this.callbackLoadEntity(),"function"==typeof this.callbackLoadTemplate&&this.callbackLoadTemplate(),this.template={columns:[]},this.clearBeforeImport=!0,this.dragSrcRow=null,this.tbody=null,this.operation="create",this.currentEntityData=[],this.systemEntities=["admin","admin_level","admin_profile","admin_role","menu_cache","menu_group_translation","menu_translation","message","message_folder","module","module_group","notification","user_activity","user_password_history",],this.db=null}getEntityByName(e){for(let t of this.entities)if(e===t.name)return t;return null}addDomListeners(){let e=this;document.querySelector(".check-all-entity-structure").addEventListener("change",t=>{let a=t.target.checked,l=t.target.closest("table").querySelector("tbody").querySelectorAll(".selected-entity-structure");l&&l.forEach(e=>{e.checked=a}),e.exportToSQL()}),document.addEventListener("change",function(t){if(t.target.classList.contains("column-primary-key")){let a=t.target.checked,l=t.target.closest("tr");a?(l.querySelector(".column-type").value=e.primaryKeyDataType,e.updateColumnLengthInput(l.querySelector(".column-type")),l.querySelector(".column-length").value=e.primaryKeyDataLength,l.querySelector(".column-nullable").checked=!1,l.querySelector(".column-nullable").disabled=!0,l.querySelector(".column-primary-key").checked&&(e.autonumberTypes.includes(l.querySelector(".column-type").value)?l.querySelector(".column-autoIncrement").disabled=!1:(l.querySelector(".column-autoIncrement").disabled=!0,l.querySelector(".column-autoIncrement").checked=!1))):l.querySelector(".column-nullable").disabled=!1}}),document.querySelector(this.selector+" .import-file-json").addEventListener("change",function(){let e=this.files[0];e?editor.importJSON(e,function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),l=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,l,e)}):console.log("Please select a JSON file first.")}),document.querySelector(this.selector+" .import-file-sql").addEventListener("change",function(){let e=this.files[0];e?editor.importSQLFile(e,function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),l=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,l,e)}):console.log("Please select a JSON file first.")}),document.querySelector(this.selector+" .import-file-sheet").addEventListener("change",function(){let e=this.files[0];e?editor.importSheetFile(e):console.log("Please select a JSON file first.")}),document.querySelector(this.selector).addEventListener("keypress",function(t){"Enter"==t.key&&(t.target.closest(".entity-container .entity-name")||t.target.closest(".entity-container .column-name")?e.addColumnIfValid(t.target):t.target.closest(".template-container .column-name")&&e.addColumnTemplateIfValid(t.target))}),this.initIconEvent()}addColumnIfValid(e){let t=e.value.toLowerCase();this.keyWords.some(e=>e.toLowerCase()===t)?this.showAlertDialog(`The word "${e.value}" is reserved and cannot be used. Please choose another one.`,"Reserved Word","Close",function(){e.select()}):this.addColumn(!0)}addColumnTemplateIfValid(e){let t=e.value.toLowerCase();this.keyWords.some(e=>e.toLowerCase()===t)?this.showAlertDialog(`The word "${e.value}" is reserved and cannot be used. Please choose another one.`,"Reserved Word","Close",function(){e.select()}):this.addColumnTemplate(!0)}initIconEvent(){let e=this;entityRenderer.svg.addEventListener("click",function(t){t.target.closest(".erd-svg .view-data-icon")&&e.viewData(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .move-down-icon")&&e.moveEntityUp(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .move-up-icon")&&e.moveEntityDown(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .edit-icon")&&e.editEntity(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .delete-icon")&&e.deleteEntity(parseInt(t.target.dataset.index))})}showEditor(e=-1){if(e>=0){this.operation="update",this.currentEntityIndex=e;let t=this.entities[e];document.querySelector(this.selector+" .entity-name").value=t.name,document.querySelector(this.selector+" .entity-columns-table-body").innerHTML="",t.columns.forEach(e=>this.addColumnToTable(e))}else{this.operation="create",this.currentEntityIndex=-1;let a=this.getNewTableName();document.querySelector(this.selector+" .entity-name").value=a,document.querySelector(this.selector+" .entity-columns-table-body").innerHTML=""}document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none",document.querySelector(this.selector+" .editor-form").style.display="block",-1==e&&document.querySelector(this.selector+" .entity-name").select()}getNewTableName(){let e=0,t="new_table",a=this.entities.map(e=>e.name.toLowerCase());for(;a.includes(t.toLowerCase());)t=`new_table_${++e}`;return t}importFromSheet(e,t){this.operation="create",this.currentEntityIndex=-1,t=t||this.getNewTableName(),document.querySelector(this.selector+" .entity-name").value=t,document.querySelector(this.selector+" .entity-columns-table-body").innerHTML="",e.forEach(e=>{this.addColumnToTable(e)}),document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none",document.querySelector(this.selector+" .editor-form").style.display="block",document.querySelector(this.selector+" .entity-name").select()}addColumnToTable(e,t=!1){let a=document.querySelector(this.selector+" .entity-columns-table-body"),l=document.createElement("tr"),i=null==e.length?"":e.length.toString().replace(/\D/g,""),r=null==e.default?"":e.default,n=e.type.split("(")[0].trim(),s="";e.primaryKey?s="disabled":e.nullable&&(s="checked"),l.innerHTML=`
            <td class="drag-handle"></td>
            <td class="column-action">
                <button onclick="editor.removeColumn(this)" class="icon-delete"></button>
                <button onclick="editor.moveUp(this)" class="icon-move-up"></button>
                <button onclick="editor.moveDown(this)" class="icon-move-down"></button>    
            </td>
            <td><input type="text" class="column-name" value="${e.name}" placeholder="Column Name"></td>
            <td>
                <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
                    ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===n?"selected":""}>${e}</option>`).join("")}
                </select>
            </td>
            <td><input type="text" class="column-length" value="${i}" placeholder="Length" style="display: ${this.withLengthTypes.includes(n)?"inline-block":"none"};"></td>
            <td><input type="text" class="column-enum" value="${e.values}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(n)||this.withRangeTypes.includes(n)?"inline":"none"};"></td>
            <td><input type="text" class="column-default" value="${r}" placeholder="Default Value"></td>
            <td class="column-nl"><input type="checkbox" class="column-nullable" ${s}></td>
            <td class="column-pk"><input type="checkbox" class="column-primary-key" ${e.primaryKey?"checked":""}></td>
            <td class="column-ai"><input type="checkbox" class="column-autoIncrement" ${e.autoIncrement?"checked":""} ${e.autoIncrement?"":"disabled"}></td>
        `,a.appendChild(l),this.initDraggableRow(l),t&&l.querySelector(".column-name").select()}initDraggableRow(e){let t=this;(void 0===t.tbody||null===t.tbody)&&(t.tbody=e.closest("tbody")),"true"!==e.dataset.hasDragEvent&&(e.dataset.hasDragEvent="true",e.addEventListener("mousedown",function(t){let a=t.target.tagName,l=["INPUT","TEXTAREA","SELECT"].includes(a);e.setAttribute("draggable",l?"false":"true")}),e.addEventListener("dragstart",function(e){t.dragSrcRow=this,this.classList.add("dragging"),e.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",function(){this.classList.remove("dragging")}),e.addEventListener("dragover",function(e){e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("over")}),e.addEventListener("dragleave",function(){this.classList.remove("over")}),e.addEventListener("drop",function(e){if(e.preventDefault(),t.dragSrcRow!==this){let a=Array.from(t.tbody.children),l=a.indexOf(t.dragSrcRow),i=a.indexOf(this);l<i?t.tbody.insertBefore(t.dragSrcRow,this.nextSibling):t.tbody.insertBefore(t.dragSrcRow,this),"function"==typeof t.updateRowNumbers&&t.updateRowNumbers()}this.classList.remove("over")}))}addColumn(e=!1){let t=this.selector+" .entity-container .entity-name",a=document.querySelector(t),l=a.value;if("create"==this.operation&&this.isEntityExists(l)){this.showConfirmationDialog(`Entity '${l}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(a.value=`${l}_new`,a.select())});return}let i=document.querySelectorAll(this.selector+" .entity-container .column-name").length,r=0===i?`${l}_id`:`${l}_col${0===i?"":i+1}`,n=new Column(r,this.defaultDataType,this.defaultDataLength);n.nullable=!0,this.addColumnToTable(n,e);let s=document.querySelector(this.selector+" .entity-container .table-container");s.scrollTop=s.scrollHeight}isEntityExists(e){for(let t of this.entities)if(t.name===e)return!0;return!1}saveEntity(){let e=this.selector+" .entity-container .entity-name",t=document.querySelector(e),a=t.value;if("create"==this.operation&&this.isEntityExists(a)){this.showConfirmationDialog(`Entity '${a}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(t.value=`${a}_new`,t.select())});return}this.doSaveEntity();let l=document.querySelector(".tabs-link-container li.diagram-tab.active");l&&this.selectDiagram(l)}doSaveEntity(){let e=document.querySelector(this.selector+" .entity-name").value,t=[],a=document.querySelectorAll(this.selector+" #table-entity-editor .column-name"),l=document.querySelectorAll(this.selector+" #table-entity-editor .column-type"),i=document.querySelectorAll(this.selector+" #table-entity-editor .column-nullable"),r=document.querySelectorAll(this.selector+" #table-entity-editor .column-default"),n=document.querySelectorAll(this.selector+" #table-entity-editor .column-primary-key"),s=document.querySelectorAll(this.selector+" #table-entity-editor .column-autoIncrement"),o=document.querySelectorAll(this.selector+" #table-entity-editor .column-length"),c=document.querySelectorAll(this.selector+" #table-entity-editor .column-enum");for(let d=0;d<a.length;d++){let u=new Column(a[d].value,l[d].value,o[d].value||null,i[d].checked,r[d].value||null,n[d].checked,s[d].checked,c[d].value||null);t.push(u)}if(this.currentEntityIndex>=0)this.entities[this.currentEntityIndex].name=e,this.entities[this.currentEntityIndex].index=this.currentEntityIndex,this.entities[this.currentEntityIndex].columns=t;else{let m=new Entity(e,this.entities.length);t.forEach(e=>m.addColumn(e)),m.setData(this.snakeizeData(this.currentEntityData,t)),this.entities.push(m)}this.renderEntities(),this.updateDiagram(),this.cancelEdit(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}updateDiagram(){let e=this;document.querySelector(".diagram-container").querySelectorAll(".diagram-entity").forEach(t=>{let a=t.getAttribute("id"),l=t.closest(".left-panel").offsetWidth,i=(t.dataset.entities||"").split(","),r=[];i.forEach(t=>{let a=e.getEntityByName(t);null!=a&&r.push(a)}),diagramRenderer[a].createERD({entities:r},l-240,document.querySelector("#draw-relationship").checked);let n=t.querySelector("svg");e.removeDiagramEventListener(n),e.addDiagramEventListener(n)})}saveDiagram(){let e=this.getCheckedEntities(),t=[],a=0;Object.entries(e).forEach(([e,l])=>{let i=document.querySelector(`.tabs-link-container [data-id="${e}"] input`).value;t.push({id:e,name:i,sortOrder:a,entities:l}),a++}),"function"==typeof this.callbackSaveDiagram&&this.callbackSaveDiagram(t)}showEditorTemplate(){this.currentEntityIndex=-2,document.querySelector(this.selector+" .template-columns-table-body").innerHTML="",this.template.columns.forEach(e=>this.addColumnToTemplate(e)),document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .entity-container").style.display="none",document.querySelector(this.selector+" .template-container").style.display="block",document.querySelector(this.selector+" .editor-form").style.display="block"}addColumnTemplate(e){this.addColumnToTemplate({name:"",type:"VARCHAR",length:"50",nullable:!0,default:null,values:""},e);let t=document.querySelector(this.selector+" .template-container .table-container");t.scrollTop=t.scrollHeight}addColumnToTemplate(e,t){let a=document.querySelector(this.selector+" .template-columns-table-body"),l=document.createElement("tr"),i=null==e.length?"":e.length.replace(/\D/g,""),r=null==e.default?"":e.default,n=e.type.split("(")[0].trim();l.innerHTML=`
            <td class="drag-handle"></td>
            <td class="column-action">
                <button onclick="editor.removeColumn(this)" class="icon-delete"></button>
                <button onclick="editor.moveUp(this)" class="icon-move-up"></button>
                <button onclick="editor.moveDown(this)" class="icon-move-down"></button>    
            </td>
            <td><input type="text" class="column-name" value="${e.name}" placeholder="Column Name"></td>
            <td>
                <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
                    ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===n?"selected":""}>${e}</option>`).join("")}
                </select>
            </td>
            <td><input type="text" class="column-length" value="${i}" placeholder="Length" style="display: ${this.withLengthTypes.includes(n)?"inline":"none"};"></td>
            <td><input type="text" class="column-enum" value="${e.values}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(n)||this.withRangeTypes.includes(n)?"inline":"none"};"></td>
            <td><input type="text" class="column-default" value="${r}" placeholder="Default Value"></td>
            <td class="column-nl"><input type="checkbox" class="column-nullable" ${e.nullable?"checked":""}></td>
        `,a.appendChild(l),this.initDraggableRow(l),t&&l.querySelector(".column-name").select()}saveTemplate(){let e=[],t=document.querySelectorAll(this.selector+" .table-template-editor .column-name"),a=document.querySelectorAll(this.selector+" .table-template-editor .column-type"),l=document.querySelectorAll(this.selector+" .table-template-editor .column-nullable"),i=document.querySelectorAll(this.selector+" .table-template-editor .column-default"),r=document.querySelectorAll(this.selector+" .table-template-editor .column-length"),n=document.querySelectorAll(this.selector+" .table-template-editor .column-enum");for(let s=0;s<t.length;s++){let o=new Column(t[s].value,a[s].value,r[s].value||null,l[s].checked,i[s].value||null,n[s].value||null);e.push(o)}this.template.columns=e,document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none","function"==typeof this.callbackSaveTemplate&&this.callbackSaveTemplate(this.template)}cancelEditTemplate(){document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none"}addColumnFromTemplate(){let e=this.selector+" .entity-container .entity-name",t=document.querySelector(e),a=t.value;if("create"==this.operation&&this.isEntityExists(a)){this.showConfirmationDialog(`Entity '${a}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(t.value=`${a}_new`,t.select())});return}let l=[],i=document.querySelectorAll(this.selector+" #table-entity-editor .column-name");for(let r of i)l.push(r.value);this.template.columns.forEach(e=>{l.includes(e.name)||this.addColumnToTable(e,focus)});let n=document.querySelector(this.selector+" .entity-container .table-container");n.scrollTop=n.scrollHeight}removeColumn(e){let t=e.closest("tr");t.remove()}moveUp(e){let t=e.closest("tr"),a=t.closest("tbody"),l=t.previousElementSibling;l&&a.insertBefore(t,l)}moveDown(e){let t=e.closest("tr"),a=t.closest("tbody"),l=t.nextElementSibling;l&&a.insertBefore(l,t)}createEntitiesFromJSON(e){let t=[];return e.entities.forEach(e=>{let a=new Entity(e.name,e.index);e.columns.forEach(e=>{let t=new Column(e.name,e.type,e.length,e.nullable,e.default,e.primaryKey,e.autoIncrement,"null"!==e.values?e.values:"");a.addColumn(t)}),a.setData(e.data),t.push(a)}),{entities:t,diagrams:e.diagrams}}createTemplateFromJSON(e){let t=[];return e.columns.forEach(e=>{let a=new Column(e.name,e.type,e.length,e.nullable,e.default,"null"!==e.values?e.values:"");t.push(a)}),{columns:t}}createEntitiesFromSQL(e){let t=[];return e.forEach((e,a)=>{let l=new Entity(e.tableName,a);e.columns.forEach(e=>{let t=new Column(e.Field,e.Type.toUpperCase(),e.Length,e.Nullable,e.Default,e.Key,e.AutoIncrement,null!=e.EnumValues&&"object"==typeof e.EnumValues?e.EnumValues.join(", "):null);l.addColumn(t)}),t.push(l)}),t}getCheckedEntities(){let e={};return document.querySelectorAll(".diagram-entity.tab-content").forEach(t=>{let a=t.getAttribute("id"),l=t.dataset.entities;e[a]=l?l.split(","):[]}),e}setCheckedEntities(e){document.querySelectorAll(".diagram-entity.tab-content").forEach(t=>{let a=e[t.getAttribute("id")];a&&t.setAttribute("data-entities",a.join(","))})}restoreCheckedEntitiesFromCurrentDiagram(){let e=document.querySelector(".tabs-link-container .diagram-tab.active");this.selectDiagram(e)}restoreCheckedEntities(){let e=document.querySelector(".diagram-entity.tab-content.active");if(e){let t=e.dataset.entities,a=t?t.split(","):[];document.querySelectorAll('.left-panel .table-list [type="checkbox"]').forEach(e=>{e.checked=a.includes(e.dataset.name),e.disabled=!1})}}renderEntities(){let e=this,t=document.querySelector(this.selector+" .entities-container"),a=[],l=[],i=document.querySelectorAll(this.selector+" .right-panel .selected-entity-structure:checked"),r=document.querySelectorAll(this.selector+" .right-panel .selected-entity-data:checked");i.forEach(e=>a.push(e.dataset.name)),r.forEach(e=>l.push(e.dataset.name));let n=document.querySelector(this.selector+" .table-list-for-export"),s=document.querySelector(this.selector+" .left-panel .table-list"),o=document.querySelector(this.selector+" .draw-relationship").checked;if(s.innerHTML="",n.innerHTML="",this.entities.some(t=>!e.systemEntities.includes(t.name.toLowerCase()))){let c=document.createElement("tr");c.classList.add("group-header"),c.innerHTML=`<td>
                    <label><input type="checkbox" class="export-structure-custom" /> S</label>
                </td>
                <td>
                    <label><input type="checkbox" class="export-data-custom"/> D</label>
                </td>
                <td>[Custom Entities]</td>`,n.appendChild(c)}if(this.entities.forEach((t,a)=>{e.systemEntities.includes(t.name.toLowerCase())||e.appendBuildTableRow(n,t,a,"custom")}),this.entities.some(t=>e.systemEntities.includes(t.name.toLowerCase()))){let d=document.createElement("tr");d.classList.add("group-header"),d.innerHTML=`<td>
                    <label><input type="checkbox" class="export-structure-system" /> S</label>
                </td>
                <td>
                    <label><input type="checkbox" class="export-data-system"/> D</label>
                </td>
                <td>[Systen Entities]</td>`,n.appendChild(d)}this.entities.forEach((t,a)=>{e.systemEntities.includes(t.name.toLowerCase())&&e.appendBuildTableRow(n,t,a,"system")}),this.entities.forEach((e,t)=>{let a=document.createElement("li");a.innerHTML=`
                <input type="checkbox" class="selected-entity" data-name="${e.name}" value="${t}" />
                <a class="edit-table" href="javascript:">✏️</a>
                <a class="delete-table" href="javascript:">❌</a> ${e.name}
            `,a.setAttribute("data-index",t),a.setAttribute("title",e.name),s.appendChild(a),a.querySelector("a.edit-table").addEventListener("click",e=>{editor.editEntity(parseInt(e.target.parentNode.dataset.index))}),a.querySelector("a.delete-table").addEventListener("click",e=>{editor.deleteEntity(parseInt(e.target.parentNode.dataset.index))})});let u=this.entities.length;document.querySelector(this.selector+" .entity-count").textContent=u>0?`(${u})`:"",a.forEach(e=>{let t=document.querySelector(`.right-panel input[data-name="${e}"].selected-entity-structure`);t&&(t.checked=!0)}),l.forEach(e=>{let t=document.querySelector(`.right-panel input[data-name="${e}"].selected-entity-data`);t&&(t.checked=!0)});let m=t.closest(".left-panel").offsetWidth;0===m&&(m=resizablePanels.getLeftPanelWidth()),m-=200,entityRenderer.createERD(editor.getData(),m-40,o)}appendBuildTableRow(e,t,a,l){let i=document.createElement("tr");i.innerHTML=`
            <td>
                <label><input type="checkbox" class="selected-entity-structure entity-structure-${l}" data-name="${t.name}" value="${a}" /> S</label>
            </td>
            <td>
                <label><input type="checkbox" class="selected-entity-data entity-data-${l}" data-name="${t.name}" value="${a}" /> D</label>
            </td>
            <td>${t.name}</td>
        `,e.appendChild(i)}refreshEntities(){let e=this;setTimeout(function(){let t=e.getCheckedEntities();e.renderEntities(),e.updateDiagram(),e.setCheckedEntities(t),e.restoreCheckedEntities()},!0)}prepareDiagram(){let e=this;this.diagrams.length>0&&this.diagrams.forEach(t=>{let a=document.querySelector(".tabs-link-container .diagram-list.tabs");e.addDiagram(a,t.name,t.id,t.entities,!0)})}selectDiagram(e){let t=document.querySelector(".diagram-container"),a=[];if(e){e.closest("ul").querySelectorAll("li.diagram-tab").forEach(e=>{e.classList.remove("active")}),e.closest("ul").querySelector("li.all-entities").classList.remove("active"),t.querySelectorAll("div.diagram").forEach(e=>{e.classList.remove("active")}),e.classList.add("active");let l=e.dataset.id,i=t.querySelector("#"+l);i.classList.add("active");a=(i.dataset.entities||"").split(",")}document.querySelector(".entity-editor .table-list").querySelectorAll("li").forEach(e=>{let t=e.querySelector('input[type="checkbox"]'),l=t.dataset.name;a.length>0&&""!==l&&(t.checked=a.includes(l)),t.disabled=!1}),this.updateDiagram()}addDiagram(e,t,a,l,i){let r=this;i=i||!1;let n=`
        <input type="text" value="${t}">
        <a href="#tab1" class="tab-link select-diagram">${t}</a> 
        <a 
            href="javascript:" class="update-diagram"><span class="icon-ok"></span></a><a 
            href="javascript:" class="edit-diagram"><span class="icon-edit"></span></a><a 
            href="javascript:" class="delete-diagram"><span class="icon-delete"></span></a>
        `,s=document.createElement("li");s.innerHTML=n,s.setAttribute("data-edit-mode",i?"false":"true"),s.querySelector("a.tab-link").setAttribute("href","#"+t),s.setAttribute("data-id",a),s.classList.add("diagram-tab");let o=e.lastElementChild;e.insertBefore(s,o),s.querySelector("input").select(),s.querySelector("input").addEventListener("keypress",function(e){if("Enter"==e.key){let t=e.target.value;s.querySelector(".tab-link").innerText=t,s.setAttribute("data-edit-mode","false"),r.updateDiagram(),r.saveDiagram()}}),e.querySelectorAll("li.diagram-tab").forEach(e=>{e.classList.remove("active")}),s.classList.add("active");let c=document.querySelector(".diagram-container");c.querySelectorAll(".diagram").forEach(e=>{e.classList.remove("active")});let d=document.createElement("div");d.setAttribute("id",a),d.classList.add("diagram"),d.classList.add("diagram-entity"),d.classList.add("tab-content"),d.classList.add("active"),d.setAttribute("data-entities",l.join(","));let u=document.createElementNS("http://www.w3.org/2000/svg","svg");u.setAttribute("width",4),u.setAttribute("height",4),u.classList.add("erd-svg"),initDiagramContextMenu(u),d.appendChild(u),c.appendChild(d),diagramRenderer[a]=new EntityRenderer(`.diagram-container #${a} .erd-svg`),e.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.setAttribute("data-index",t)}),this.selectDiagram(s),this.updateDiagram(),s.querySelector(".select-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li");r.selectDiagram(t)}),s.querySelector(".update-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a=t.querySelector("input").value;t.querySelector(".tab-link").innerText=a,t.setAttribute("data-edit-mode","false"),r.updateDiagram(),r.saveDiagram(),r.restoreCheckedEntitiesFromCurrentDiagram()}),s.querySelector(".edit-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a=t.querySelector(".tab-link").innerText,l=t.querySelector("input");l.value=a,t.setAttribute("data-edit-mode","true"),l.select(),r.updateDiagram(),r.restoreCheckedEntitiesFromCurrentDiagram()}),s.querySelector(".delete-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li").querySelector('input[type="text"]').value;r.showConfirmationDialog(`<p>Are you sure you want to delete the diagram &quot;${t}&quot;?</p>`,"Delete Confirmation","Yes","No",function(t){if(t){let a=e.target.closest("li"),l="#"+a.dataset.id,i=a.closest("ul");a.parentNode.removeChild(a);let n=c.querySelector(l);n.parentNode.removeChild(n),i.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.setAttribute("data-index",t)}),r.updateDiagram(),r.saveDiagram()}})}),null===tabDragger&&(tabDragger=new TabDragger(e,function(){let e=r.getDiagrams();r.callbackSaveDiagram(e)})).initAll(),tabDragger.makeDraggable(s);updateMarginLeft(-10-s.offsetWidth)}addDiagramEventListener(e){let t=this;e._clickHandler||(e._clickHandler=function(e){t.editEventListener(e)}),e.addEventListener("click",e._clickHandler)}getNewDiagramName(){let e="New Diagram",t=this.getDiagrams(),a=e,l=0,i=!0;for(;i;)for(let r of(i=!1,t))if(r.name===a){i=!0,a=`${e} ${++l}`;break}return a}getDiagrams(){let e=[];return document.querySelector(".diagram-list.tabs").querySelectorAll("li.diagram-tab").forEach((t,a)=>{e.push({id:t.dataset.id,name:t.querySelector("input").value,sortOrder:a,entities:document.querySelector(".diagram-container").querySelector(`#${t.dataset.id}`).dataset.entities.split(",")})}),e}removeDiagramEventListener(e){e._clickHandler&&(e.removeEventListener("click",e._clickHandler),delete e._clickHandler)}clearDiagrams(){document.querySelector(".diagram-list.tabs .all-entities").classList.add("active");let e=document.querySelectorAll(".diagram-tab");e&&e.forEach(e=>{e.parentNode.removeChild(e)});let t=document.querySelectorAll(".diagram-entity.tab-content");t&&t.forEach(e=>{e.parentNode.removeChild(e)}),document.querySelector(".diagram-container #all-entities").classList.add("active")}clearEntities(){let e=document.querySelector(".diagram-container .all-entities");if(e){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");e.appendChild(t)}}editEventListener(e){if(e.target.closest(".erd-svg .view-data-icon")){let t=parseInt(e.target.dataset.index);this.viewData(t)}if(e.target.closest(".erd-svg .move-down-icon")){let a=e.target.closest(".diagram-entity").dataset.entities,l=e.target.closest(".svg-entity").dataset.entity,i=this.arrayElementOperation(a,l,1);e.target.closest(".diagram-entity").setAttribute("data-entities",i),this.updateDiagram(),this.saveDiagram()}if(e.target.closest(".erd-svg .move-up-icon")){let r=e.target.closest(".diagram-entity").dataset.entities,n=e.target.closest(".svg-entity").dataset.entity,s=this.arrayElementOperation(r,n,-1);e.target.closest(".diagram-entity").setAttribute("data-entities",s),this.updateDiagram(),this.saveDiagram()}if(e.target.closest(".erd-svg .edit-icon")){let o=parseInt(e.target.dataset.index);this.editEntity(o)}if(e.target.closest(".erd-svg .delete-icon")){let c=e.target.closest(".diagram-entity").dataset.entities,d=e.target.closest(".svg-entity").dataset.entity,u=this.removeUniqueElements(c.split(","),d).join(",");document.querySelector(`.selected-entity[data-name="${d}"]`).checked=!1,e.target.closest(".diagram-entity").setAttribute("data-entities",u),this.updateDiagram(),this.saveDiagram()}}removeUniqueElements(e,t){return e.filter(a=>!(a===t&&e.indexOf(a)===e.lastIndexOf(a)))}arrayElementOperation(e,t,a){let l=e.split(","),i=l.indexOf(t);if(-1===i||-1===a&&0===i||1===a&&i===l.length-1)return e;let r=i+a;return[l[i],l[r]]=[l[r],l[i]],l.join(",")}viewData(e){this.currentEntityIndex=e;let t=this.entities[e];this.showEntityDataDialog(t,`Entity Data - ${t.name}`)}moveEntityUp(e){if(this.cancelEdit(),e<this.entities.length-1){let t=this.entities[e];this.entities[e]=this.entities[e+1],this.entities[e+1]=t,this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}}moveEntityDown(e){if(this.cancelEdit(),e>0){let t=this.entities[e];this.entities[e]=this.entities[e-1],this.entities[e-1]=t,this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}}sortEntities(){this.entities.sort((e,t)=>e.name>t.name?1:e.name<t.name?-1:0),this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}sortAndGroupEntities(){let e=this,t=[],a=[];this.entities.forEach(l=>{e.systemEntities.includes(l.name)?a.push(l):t.push(l)}),t.sort((e,t)=>e.name.localeCompare(t.name)),a.sort((e,t)=>e.name.localeCompare(t.name)),this.entities=[...t,...a],this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}updateEntityIndex(){this.entities.forEach((e,t)=>{e.index=t})}editEntity(e){this.currentEntityIndex=e,this.showEditor(e)}deleteEntity(e){let t=this,a=t.entities[e].name;t.showConfirmationDialog(`<p>Are you sure you want to delete the entity &quot;${a}&quot;?</p>`,"Delete Confirmation","Yes","No",function(a){a&&(t.entities.splice(e,1),t.renderEntities(),t.restoreCheckedEntitiesFromCurrentDiagram(),t.exportToSQL(),"function"==typeof t.callbackSaveEntity&&t.callbackSaveEntity(t.entities))})}cancelEdit(){document.querySelector(this.selector+" .editor-form").style.display="none",document.querySelector(this.selector+" .button-container").style.display="block"}updateColumnLengthInput(e){let t=e.closest("tr"),a=e.value,l=t.querySelector(".column-length"),i=t.querySelector(".column-enum");if(this.withLengthTypes.includes(a)?l.style.display="inline":l.style.display="none",this.withValueTypes.includes(a)||this.withRangeTypes.includes(a)?i.style.display="inline":i.style.display="none",void 0!==this.defaultLength[a]){let r=this.defaultLength[a];l.value=r}t.querySelector(".column-primary-key").checked&&(this.autonumberTypes.includes(t.querySelector(".column-type").value)?t.querySelector(".column-autoIncrement").disabled=!1:(t.querySelector(".column-autoIncrement").disabled=!0,t.querySelector(".column-autoIncrement").checked=!1))}exportToSQL(e="mysql"){let t=this.generateSQL(e);document.querySelector(this.selector+" .query-generated").value=t.join("\r\n")}generateSQL(e){let t=[],a=document.querySelectorAll(this.selector+" .right-panel .selected-entity-structure:checked");a.forEach(a=>{let l=parseInt(a.value),i=this.entities[l];i&&t.push(i.toSQL(e))});let l=document.querySelectorAll(this.selector+" .right-panel .selected-entity-data:checked");return l.forEach(a=>{let l=parseInt(a.value),i=this.entities[l];if(i){let r=i.toSQLInsert(e);""!=r&&t.push(r)}}),t}generateFileName(e){return e.databaseName&&e.databaseSchema?`${e.databaseName}-${e.databaseSchema}`:e.databaseName?`${e.databaseName}`:`${e.applicationId}`}exportJSON(e){let t=this.generateFileName(e),a=new Date,l=a.toISOString().replace(/[-T:\.Z]/g,"_");l.endsWith("_")&&(l=l.slice(0,-1));let i=`${t}_${l}.json`,r=JSON.stringify(e),n=new Blob([r],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=i,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}downloadSQL(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),a=document.querySelector('meta[name="database-schema"]').getAttribute("content"),l=document.querySelector('meta[name="database-type"]').getAttribute("content"),i=this.generateFileName({applicationId:e,databaseType:l,databaseName:t,databaseSchema:a}),r=new Date,n=r.toISOString().replace(/[-T:\.Z]/g,"_");n.endsWith("_")&&(n=n.slice(0,-1));let s=`${i}_${n}.sql`,o=new Blob([document.querySelector(this.selector+" .query-generated").value],{type:"text/plain"}),c=URL.createObjectURL(o),d=document.createElement("a");d.href=c,d.download=s,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(c)}importJSON(e,t){let a=this,l=new FileReader;l.onload=function(e){let l=e.target.result;try{let i=JSON.parse(l),r=editor.createEntitiesFromJSON(i);a.clearEntities(),a.clearDiagrams(),a.entities=r.entities,a.diagrams=r.diagrams||[],a.prepareDiagram(),a.updateDiagram(),a.renderEntities(),"function"==typeof t&&t(a.entities)}catch(n){console.log("Error parsing JSON: "+n.message)}},l.readAsText(e)}importSQLFile(e,t){let a=this,l=new FileReader,i=e.slice(0,512);l.onload=function(l){let i=new Uint8Array(l.target.result);a.looksLikeSQLite(i)?a.importSQLite(e,t):a.importSQLQuery(e,t)},l.onerror=()=>a.showAlertDialog("Failed to read file.","Alert","OK"),l.readAsArrayBuffer(i)}looksLikeSQLite(e){return[83,81,76,105,116,101,32,102,111,114,109,97,116,32,51,0].every((t,a)=>e[a]===t)}importSQLQuery(e,t){let a=this,l=new FileReader;l.onload=function(e){let l=e.target.result;try{l=new SQLConverter().translate(l,"mysql").split("`").join("");let i=new TableParser(l),r=editor.createEntitiesFromSQL(i.tableInfo);if(a.clearBeforeImport)a.entities=r,a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{let n=[];a.entities.forEach(e=>{n.push(e.name)}),r.forEach(e=>{n.includes(e.name)||(e.index=a.entities.length,a.entities.push(e))}),a.renderEntities()}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram()}catch(s){console.log("Error parsing JSON: "+s.message)}},l.onerror=()=>{a.showAlertDialog("Failed to read file.","Alert","OK")},l.readAsText(e)}importSQLite(e,t){if(!e)return;let a=this,l=new FileReader;l.onload=function(e){let l=e.target.result,i=new Uint8Array(l);initSqlJs({locateFile:e=>"../lib.assets/wasm/sql-wasm.wasm"}).then(e=>{a.db=new e.Database(i);let l=a.db.exec("SELECT name FROM sqlite_master WHERE type='table';"),r=[];if(l[0].values.forEach((e,t)=>{let l=e[0],i=new Entity(a.snakeize(l),t),n=a.db.exec(`SELECT * FROM ${l};`);if(n.length>0){let s=n[0].columns,o=n[0].values;i.data=o.map(e=>{let t={};return s.forEach((l,i)=>{let r=a.snakeize(l);t[r]=e[i]}),t})}else i.setData(null);let c=a.db.exec(`PRAGMA table_info(${l});`);c.length>0&&(c[0].values.forEach(e=>{let t=new Column(a.snakeize(e[1]),a.toMySqlType(e[2]),a.getColumnSize(e[2]),1===e[3],e[4],e[5],!1,null);i.addColumn(t)}),r.push(i))}),a.clearBeforeImport)a.entities=r,a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{let n=[];a.entities.forEach(e=>{n.push(e.name)}),r.forEach(e=>{n.includes(e.name)||(e.index=a.entities.length,a.entities.push(e))}),a.renderEntities()}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram()})},l.readAsArrayBuffer(e)}toMySqlType(e){if(!e)return"TEXT";let t=e.trim().toUpperCase();for(let[a,l]of[[/NVARCHAR/,"VARCHAR"],[/INT/,"BIGINT"],[/(CHAR|CLOB|TEXT)/,"TEXT"],[/BLOB/,"BLOB"],[/(REAL|FLOA|DOUB)/,"DOUBLE"],[/(NUMERIC|DECIMAL)/,"DECIMAL"],[/BOOLEAN/,"TINYINT"],[/TIMESTAMP/,"TIMESTAMP"],[/(DATE|TIME)/,"DATETIME"]])if(a.test(t))return l;return e}getColumnSize(e){if(!e)return null;if(-1!==e.toUpperCase().indexOf("BOOL"))return 1;let t=e.match(/\((\d+)\)/);return t&&t[1]?parseInt(t[1]):null}toValidTableName(e){return e.replace(/\.[^/.]+$/,"").replace(/[^a-zA-Z0-9]+/g,"_").toLowerCase().replace(/^_+|_+$/g,"")}importSheetFile(e){let t=this,a=e.name.split(".").pop().toLowerCase(),l=new FileReader;l.onload=function(l){let i=l.target.result;if("csv"===a){let r=Papa.parse(i,{header:!0}),n=r.meta.fields,s=r.data,o=t.toValidTableName(e.name),c=t.generateCreateTable(n,s);t.importFromSheet(c,o),t.currentEntityData=s}else if("xlsx"===a||"xls"===a){let d=new Uint8Array(i),u=XLSX.read(d,{type:"array"}),m=a=>{let l=u.SheetNames[a],i=XLSX.utils.sheet_to_json(u.Sheets[l],{defval:""});if(t.currentEntityData=i,i.length>0){let r=Object.keys(i[0]),n=t.toValidTableName(e.name)+"_"+t.toValidTableName(l),s=t.generateCreateTable(r,i);t.importFromSheet(s,n)}};if(u.SheetNames.length>1){let h=`
                        <table class="two-side-table">
                            <tbody>
                                <tr>
                                    <td>Sheet to Import</td>
                                    <td>
                                        <select id="sheet-index" class="form-control">
                                            ${u.SheetNames.map((e,t)=>`<option value="${t}">${t+1}. ${e}</option>`).join("")}
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    `;t.showConfirmationDialog(h,"Select Sheet","OK","Cancel",function(e){e&&m(parseInt(document.querySelector("#sheet-index").value))})}else m(0)}else t.showAlertDialog(`Unsupported file format: ${a}`,"Alert","OK")},"csv"===a?l.readAsText(e):l.readAsArrayBuffer(e)}snakeizeData(e,t){let a=t.map(e=>e.name),l=[];if(Array.isArray(e))for(let i of e){let r={};for(let n of Object.keys(i)){let s=this.snakeize(n);a.includes(s)&&(r[s]=i[n])}l.push(r)}return l}snakeizeKey(e){let t=[];if(Array.isArray(e))for(let a of e){let l={};for(let i of Object.keys(a)){let r=this.snakeize(i);l[r]=a[i]}t.push(l)}return t}guessType(e){let t=!0,a=!0,l=!0,i=!0;for(let r of e.slice(0,10))null!=r&&""!==(r="string"!=typeof r?String(r).trim():r.trim())&&(/^[-+]?\d+$/.test(r)||(t=!1),/^[-+]?\d+(\.\d+)?$/.test(r)||(a=!1),/^(true|false|yes|no|1|0)$/i.test(r)||(l=!1),isNaN(Date.parse(r))&&(i=!1));return a?"FLOAT":t?"BIGINT":l?"BOOLEAN":i?"TIMESTAMP":"TEXT"}generateCreateTable(e,t){let a=this,l=e.map(e=>{let l=a.snakeize(e),i=t.map(t=>t[e]),r=a.guessType(i);return new Column(l,r,null,!0,null,!1,!1,null)});return l}snakeize(e){return e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1_$2").replace(/\s+/g,"_").replace(/[^\w]/g,"").toLowerCase().replace(/^_+|_+$/g,"")}uploadEntities(){this.clearBeforeImport=!0,document.querySelector(this.selector+" .import-file-json").click()}importSQL(){this.clearBeforeImport=!0,document.querySelector(this.selector+" .import-file-sql").click()}importSheet(){this.clearBeforeImport=!0,document.querySelector(this.selector+" .import-file-sheet").click()}appendFromSQL(){this.clearBeforeImport=!1,document.querySelector(this.selector+" .import-file-sql").click()}downloadEntities(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),a=document.querySelector('meta[name="database-schema"]').getAttribute("content"),l=document.querySelector('meta[name="database-type"]').getAttribute("content"),i={applicationId:e,databaseType:l,databaseName:t,databaseSchema:a,entities:this.entities,diagrams:this.getDiagrams()};this.exportJSON(i)}getData(){return{entities:this.entities}}showAlertDialog(e,t,a,l){let i=document.querySelector("#asyncAlert"),r=i.querySelector(".alert-ok");r=this.removeAllEventListeners(r),i.querySelector(".modal-header h3").innerHTML=t,i.querySelector(".modal-body").innerHTML=e,r.innerHTML=a,i.style.display="block",r.addEventListener("click",function e(){i.style.display="none","function"==typeof l&&l()}),r.focus()}showConfirmationDialog(e,t,a,l,i){let r=document.querySelector("#asyncConfirm"),n=r.querySelector(".confirm-ok"),s=r.querySelector(".confirm-cancel");n=this.removeAllEventListeners(n),s=this.removeAllEventListeners(s),r.querySelector(".modal-header h3").innerHTML=t,r.querySelector(".modal-body").innerHTML=e,n.innerHTML=a,s.innerHTML=l,r.style.display="block",n.addEventListener("click",function e(){r.style.display="none",i(!0)}),s.addEventListener("click",function e(){r.style.display="none",i(!1)})}removeAllEventListeners(e){let t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t}createDataTypeOption(e,t){let a="";return a+=`<select name="${e}" onchange="editor.setDefaultLength(this, '${t}')">\r
`,this.mysqlDataTypes.forEach(e=>{a+=`<option value="${e}">${e}</option>\r
`}),a+="</select>"}setDefaultLength(e,t){let a=e.value;void 0!==this.defaultLength[a]&&(document.querySelector(t).value=this.defaultLength[a])}preference(){let e=this;e.showSettingDialog(`
            <table class="two-side-table">
                <tbody>
                    <tr>
                        <td>Primary Key Type</td>
                        <td>${e.createDataTypeOption("primary_key_type","#primary_key_length")}</td>
                    </tr>
                    <tr>
                        <td>Primary Key Length</td>
                        <td><input type="text" name="primary_key_length" id="primary_key_length" value=""></td>
                    </tr>
                    <tr>
                        <td>Column Type</td>
                        <td>${e.createDataTypeOption("column_type","#column_length")}</td>
                    </tr>
                    <tr>
                        <td>Column Length</td>
                        <td><input type="text" name="column_length" id="column_length" value=""></td>
                    </tr>
                </tbody>
            </table>
            `,"Preferences","OK","Cancel",function(t){t&&(e.primaryKeyDataType=document.querySelector('[name="primary_key_type"]').value,e.primaryKeyDataLength=document.querySelector('[name="primary_key_length"]').value,e.defaultDataType=document.querySelector('[name="column_type"]').value,e.defaultDataLength=document.querySelector('[name="column_length"]').value,"function"==typeof e.callbackSaveConfig&&e.callbackSaveConfig({primaryKeyDataType:e.primaryKeyDataType,primaryKeyDataLength:e.primaryKeyDataLength,defaultDataType:e.defaultDataType,defaultDataLength:e.defaultDataLength}))}),document.querySelector('[name="primary_key_type"]').value=e.primaryKeyDataType,document.querySelector('[name="primary_key_length"]').value=e.primaryKeyDataLength,document.querySelector('[name="column_type"]').value=e.defaultDataType,document.querySelector('[name="column_length"]').value=e.defaultDataLength}showSettingDialog(e,t,a,l,i){let r=document.querySelector("#settingModal"),n=r.querySelector(".confirm-ok"),s=r.querySelector(".confirm-cancel");function o(){r.style.display="none",i(!0)}function c(){r.style.display="none",i(!1)}r.querySelector(".modal-header h3").innerHTML=t,r.querySelector(".modal-body").innerHTML=e,n.innerHTML=a,s.innerHTML=l,r.style.display="block",n.removeEventListener("click",o),s.removeEventListener("click",c),n.addEventListener("click",o),s.addEventListener("click",c)}showEntityDataDialog(e,t){let a=document.querySelector("#entityDataEditorModal"),l=a.querySelector(".modal-header h3"),i=a.querySelector(".modal-body"),r=e.data||[];l.innerHTML=t||"Entity Data",i.innerHTML="";let n=document.createElement("div");n.style.overflow="auto",n.style.maxHeight="400px";let s=document.createElement("table");s.className="data-preview-table",s.style.width="100%",s.style.borderCollapse="collapse";let o=document.createElement("thead"),c=document.createElement("tr"),d=document.createElement("th");d.classList.add("td-remover"),c.appendChild(d),e.columns.forEach(e=>{let t=document.createElement("th");t.textContent=e.name,t.style.padding="6px",t.style.background="#f8f8f8",c.appendChild(t)}),o.appendChild(c),s.appendChild(o);let u=document.createElement("tbody");r.forEach((t,a)=>{let l=document.createElement("tr"),i=document.createElement("td");i.classList.add("td-remover");let r=document.createElement("a");r.className="delete-row",r.href="javascript:",r.textContent="❌",i.appendChild(r),l.appendChild(i),e.columns.forEach((e,i)=>{let r=this.createEntityDataCell(a,i,e,t[e.name]??"");l.appendChild(r)}),u.appendChild(l),r.addEventListener("click",function(e){e.preventDefault(),u.removeChild(l)})}),s.appendChild(u),n.appendChild(s),i.appendChild(n),a.style.display="block"}createEntityDataCell(e,t,a,l=""){let i=document.createElement("td"),r=document.createElement("input");return r.type="text",r.classList.add("entity-data-cell"),r.name=`cell-${e}-${t}`,r.dataset.row=e,r.dataset.col=a.name,r.dataset.type=a.type,r.value=l??"",r.style.width="100%",r.style.boxSizing="border-box",i.appendChild(r),i}addData(){let e=this.entities[this.currentEntityIndex],t=document.querySelector("#entityDataEditorModal"),a=t.querySelector(".data-preview-table tbody");if(!a)return;let l=a.rows.length,i=document.createElement("tr"),r=document.createElement("td");r.classList.add("td-remover");let n=document.createElement("a");n.className="delete-row",n.href="javascript:",n.textContent="❌",r.appendChild(n),i.appendChild(r),e.columns.forEach((e,t)=>{let a=this.createEntityDataCell(l,t,e,"");i.appendChild(a),n.addEventListener("click",function(e){e.preventDefault(),tbody.removeChild(tr)})}),a.appendChild(i)}saveData(){let e=this.entities[this.currentEntityIndex],t=document.querySelector("#entityDataEditorModal"),a=t.querySelectorAll(".data-preview-table input"),l={};a.forEach(e=>{let t=e.dataset.row,a=e.dataset.col;l[t]||(l[t]={}),l[t][a]=e.value});let i=Object.keys(l).sort((e,t)=>parseInt(e)-parseInt(t)).map(e=>l[e]);e.data=i;let r=document.querySelector('meta[name="application-id"]').getAttribute("content"),n=document.querySelector('meta[name="database-name"]').getAttribute("content"),s=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(r,document.querySelector('meta[name="database-type"]').getAttribute("content"),n,s,this.entities),t.style.display="none"}}let tabDragger=null;