class Column{constructor(e,t="VARCHAR",a="",l=!1,i="",n=!1,r=!1,s=""){this.name=e,this.type=t,this.length=a,this.nullable=l,this.default=i,this.primaryKey=n,this.autoIncrement=r,this.values=s}toSQL(){let e=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT","NUMERIC","DECIMAL","DOUBLE","FLOAT"],t="";if(this.hasValue(["ENUM","SET"]))t=`${this.name} ${this.type}(${this.values.split(",").map(e=>`'${e.trim()}'`).join(", ")})`;else if(this.hasRange(["NUMERIC","DECIMAL","DOUBLE","FLOAT"])){let a=this.values.split(",").map(e=>e.trim()),l=(a=a.filter(e=>Number.isInteger(parseFloat(e)))).join(", ");t=a.length<2?`${this.name} ${this.type}`:`${this.name} ${this.type}(${l})`}else t=this.hasLength(["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"])?`${this.name} ${this.type}(${this.length})`:`${this.name} ${this.type}`;return this.primaryKey?t+=" NOT NULL PRIMARY KEY":t+=this.nullable?" NULL":" NOT NULL",this.autoIncrement&&(t+=" AUTO_INCREMENT"),this.hasDefault()&&(this.isTypeBoolean(this.type,this.length)?t+=` DEFAULT ${this.toBoolean(this.default)}`:this.isTypeNumeric(this.type,e)?t+=` DEFAULT ${this.toNumeric(this.default)}`:e.includes(this.type)&&!isNaN(this.default)?t+=` DEFAULT ${this.default}`:t+=` DEFAULT ${this.fixDefaultColumnValue(this.default)}`),t}toNumeric(e){let t=e;return""==(t=(t=t.replace(/^"(.*)"$/,"$1")).replace(/^'(.*)'$/,"$1"))?"0":t}isTypeNumeric(e,t){return t.includes(e.toUpperCase())}fixDefaultColumnValue(e){return e?-1!=e.toUpperCase().indexOf("NULL")?e="NULL":this.isNumber(e)?e="'"+e.toString()+"'":/^(CURRENT_TIMESTAMP|NOW\(\))$/i.test(e)?e=e.toUpperCase():e.startsWith("'")&&e.endsWith("'")&&/\d{4}-\d{2}-\d{2}/.test(e.slice(1,-1))?e="'"+e.slice(1,-1)+"'":/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(e)?e="'"+e+"'":/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d{6}/.test(e)?e="'"+e+"'":/^(TRUE|FALSE)$/i.test(e)?e=e.toUpperCase():/^CURRENT_TIMESTAMP\s+ON\s+UPDATE\s+CURRENT_TIMESTAMP$/i.test(e)?e=e.toUpperCase():/^CURRENT_TIMESTAMP\s+ON\s+INSERT\s+CURRENT_TIMESTAMP$/i.test(e)?e=e.toUpperCase():this.isInQuotes(e)&&(e="'"+e.slice(1,-1)+"'"):e=null,e}isInQuotes(e){return e.startsWith("'")&&e.endsWith("'")}isNumber(e){return!isNaN(e)&&""!==e}toBoolean(e){return -1!==e.toLowerCase().indexOf("false")?"FALSE":0!==parseInt(e)||"true"===e.toLowerCase()?"TRUE":"FALSE"}fixDefaultValue(e,t,a){let l=e;return this.isTypeBoolean(t,a)?l=0!=e&&"true"===e.toString().toLowerCase()?"true":"false":this.isNativeValue(e)?l=e:this.isTypeText(t)?l=`'${e.replace(/'/g,"\\'")}'`:this.isTypeInteger(t)?l=parseInt(e.replace(/[^\d]/g,""),10):this.isTypeFloat(t)&&(l=parseFloat(e.replace(/[^\d.]/g,""))),l}isTypeBoolean(e,t){return"boolean"===e.toLowerCase()||"bool"===e.toLowerCase()||"bit"===e.toLowerCase()||"tinyint"===e.toLowerCase()&&1==t}isNativeValue(e){return"true"===e.toLowerCase()||"false"===e.toLowerCase()||"null"===e.toLowerCase()}isTypeText(e){return["char","varchar","text","tinytext","mediumtext","longtext","enum","set"].includes(e.toLowerCase())}isTypeInteger(e){return["tinyint","smallint","mediumint","int","bigint","integer"].includes(e.toLowerCase())}isTypeFloat(e){return["float","double","decimal","numeric"].includes(e.toLowerCase())}isTypeDate(e){return["date","datetime","timestamp","time","year"].includes(e.toLowerCase())}isTypeBinary(e){return["blob","tinyblob","mediumblob","longblob"].includes(e.toLowerCase())}hasRange(e){return e.includes(this.type)&&this.values}hasValue(e){return e.includes(this.type)&&this.values}hasLength(e){return this.length&&e.includes(this.type)}hasDefault(){return this.default&&"null"!==this.default.toLowerCase()}}class Entity{constructor(e){this.name=e,this.columns=[]}addColumn(e){this.columns.push(e)}removeColumn(e){this.columns.splice(e,1)}toSQL(){let e=`CREATE TABLE IF NOT EXISTS ${this.name} (\r
`;return this.columns.forEach(t=>{e+=`	${t.toSQL()},\r
`}),e=e.slice(0,-3),e+="\r\n);\r\n\r\n"}}function Diagram(e,t,a){this.entitieNames=[],this.name=e,this.sortOrder=t,this.originalEntities=a,this.active=!1,this.createERD=function(e,t){this.entityRenderer.createERD(this.getData(),e,t)},this.getData=function(){let e=[];for(let t of this.originalEntities)this.entitieNames.includes(t.name)&&e.push(t);return e}}class EntityEditor{constructor(e,t={}){this.setting={defaultDataType:"VARCHAR",defaultDataLength:"48",primaryKeyDataType:"VARCHAR",primaryKeyDataLength:"40"},this.keyWords="absolute,action,add,after,aggregate,alias,all,allocate,alter,analyse,analyze,and,any,are,array,as,asc,assertion,at,authorization,avg,before,begin,between,binary,bit,bit_length,blob,boolean,both,breadth,by,call,cascade,cascaded,case,cast,catalog,char,character,character_length,char_length,check,class,clob,close,coalesce,collate,collation,column,commit,completion,connect,connection,constraint,constraints,constructor,continue,convert,corresponding,count,create,cross,cube,current,current_date,current_path,current_role,current_time,current_timestamp,current_user,cursor,cycle,data,date,day,deallocate,dec,decimal,declare,default,deferrable,deferred,delete,depth,deref,desc,describe,descriptor,destroy,destructor,deterministic,diagnostics,dictionary,disconnect,distinct,do,domain,double,drop,dynamic,each,else,end,end-exec,equals,escape,every,except,exception,exec,execute,exists,external,extract,false,fetch,first,float,for,foreign,found,free,from,full,function,general,get,global,go,goto,grant,group,grouping,having,host,hour,identity,ignore,immediate,in,indicator,initialize,initially,inner,inout,input,insensitive,insert,int,integer,intersect,interval,into,is,isolation,iterate,join,key,language,large,last,lateral,leading,left,less,level,like,limit,local,localtime,localtimestamp,locator,lower,map,match,max,min,minute,modifies,modify,month,names,national,natural,nchar,nclob,new,next,no,none,not,null,nullif,numeric,object,octet_length,of,off,offset,old,on,only,open,operation,option,or,order,ordinality,out,outer,output,overlaps,pad,parameter,parameters,partial,path,placing,position,postfix,precision,prefix,preorder,prepare,preserve,primary,prior,privileges,procedure,public,read,reads,real,recursive,ref,references,referencing,relative,restrict,result,return,returns,revoke,right,role,rollback,rollup,routine,row,rows,savepoint,schema,scope,scroll,search,second,section,select,sequence,session,session_user,set,sets,size,smallint,some,space,specific,specifictype,sql,sqlcode,sqlerror,sqlexception,sqlstate,sqlwarning,start,state,statement,static,structure,substring,sum,system_user,table,temporary,terminate,than,then,time,timestamp,timezone_hour,timezone_minute,to,trailing,transaction,translate,translation,treat,trigger,trim,true,under,union,unique,unknown,unnest,update,upper,usage,user,using,value,values,varchar,variable,varying,view,when,whenever,where,with,without,work,write,year,zone".split(","),Object.assign(this.setting,t),this.selector=e,this.entities=[],this.diagrams=[],this.currentEntityIndex=-1,this.mysqlDataTypes=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT","NUMERIC","DECIMAL","DOUBLE","FLOAT","BIT","DATE","TIME","DATETIME","TIMESTAMP","YEAR","LONGTEXT","MEDIUMTEXT","TEXT","TINYTEXT","VARCHAR","CHAR","ENUM","SET","LONGBLOB","MEDIUMBLOB","BLOB","TINYBLOB","UUID","VARBINARY","BINARY","POLYGON","LINESTRING","POINT","GEOMETRY","JSON",],this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.defaultLength={BIGINT:20,INT:11,MEDIUMINT:8,SMALLINT:5,TINYINT:4},this.addDomListeners(),this.callbackLoadEntity=this.setting.callbackLoadEntity,this.callbackSaveEntity=this.setting.callbackSaveEntity,this.callbackSaveDiagram=this.setting.callbackSaveDiagram,this.callbackLoadTemplate=this.setting.callbackLoadTemplate,this.callbackSaveTemplate=this.setting.callbackSaveTemplate,this.callbackSaveConfig=this.setting.callbackSaveConfig,this.defaultDataType=this.setting.defaultDataType+"",this.defaultDataLength=this.setting.defaultDataLength+"",this.primaryKeyDataType=this.setting.primaryKeyDataType+"",this.primaryKeyDataLength=this.setting.primaryKeyDataLength+"","function"==typeof this.callbackLoadEntity&&this.callbackLoadEntity(),"function"==typeof this.callbackLoadTemplate&&this.callbackLoadTemplate(),this.template={columns:[]}}addDomListeners(){let e=this;document.querySelector(".check-all-entity").addEventListener("change",e=>{let t=e.target.checked,a=e.target.closest(".right-panel").querySelectorAll(".selected-entity");a&&a.forEach((e,a)=>{e.checked=t}),this.exportToSQL()}),document.querySelector(this.selector+" .right-panel .table-list-for-export").addEventListener("change",e=>{e.target.classList.contains("selected-entity")&&this.exportToSQL()}),document.addEventListener("change",function(t){if(t.target.classList.contains("column-primary-key")){let a=t.target.checked,l=t.target.closest("tr");a?(l.querySelector(".column-type").value=e.primaryKeyDataType,e.updateColumnLengthInput(l.querySelector(".column-type")),l.querySelector(".column-length").value=e.primaryKeyDataLength,l.querySelector(".column-nullable").checked=!1,l.querySelector(".column-nullable").disabled=!0):l.querySelector(".column-nullable").disabled=!1}}),document.querySelector(this.selector+" .import-file-json").addEventListener("change",function(){let e=this.files[0];e?editor.importJSON(e,function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),l=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,l,e)}):console.log("Please select a JSON file first.")}),document.querySelector(this.selector+" .import-file-sql").addEventListener("change",function(){let e=this.files[0];e?editor.importSQLFile(e,function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),l=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,l,e)}):console.log("Please select a JSON file first.")}),document.querySelector(this.selector).addEventListener("keypress",function(t){"Enter"==t.key&&(t.target.closest(".entity-container .entity-name")||t.target.closest(".entity-container .column-name")?e.addColumnIfValid(t.target):t.target.closest(".template-container .column-name")&&e.addColumnTemplateIfValid(t.target))}),this.initIconEvent()}addColumnIfValid(e){let t=e.value.toLowerCase();this.keyWords.some(e=>e.toLowerCase()===t)?this.showAlertDialog(`The word "${e.value}" is reserved and cannot be used. Please choose another one.`,"Reserved Word","Close",function(){e.select()}):this.addColumn(!0)}addColumnTemplateIfValid(e){let t=e.value.toLowerCase();this.keyWords.some(e=>e.toLowerCase()===t)?this.showAlertDialog(`The word "${e.value}" is reserved and cannot be used. Please choose another one.`,"Reserved Word","Close",function(){e.select()}):this.addColumnTemplate(!0)}initIconEvent(){let e=this;entityRenderer.svg.addEventListener("click",function(t){t.target.closest(".erd-svg .move-down-icon")&&e.moveEntityUp(parseInt(t.target.getAttribute("data-index"))),t.target.closest(".erd-svg .move-up-icon")&&e.moveEntityDown(parseInt(t.target.getAttribute("data-index"))),t.target.closest(".erd-svg .edit-icon")&&e.editEntity(parseInt(t.target.getAttribute("data-index"))),t.target.closest(".erd-svg .delete-icon")&&e.deleteEntity(parseInt(t.target.getAttribute("data-index")))})}showEditor(e=-1){if(e>=0){this.currentEntityIndex=e;let t=this.entities[e];document.querySelector(this.selector+" .entity-name").value=t.name,document.querySelector(this.selector+" .entity-columns-table-body").innerHTML="",t.columns.forEach(e=>this.addColumnToTable(e))}else{this.currentEntityIndex=-1;let a="new_table";for(let l in this.entities){let i=!1;for(let n in this.entities)(a=`new_table_${parseInt(l)+2}`).toLowerCase()==this.entities[n].name.toLowerCase()&&(i=!0);if(!i)break}document.querySelector(this.selector+" .entity-name").value=a,document.querySelector(this.selector+" .entity-columns-table-body").innerHTML=""}document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none",document.querySelector(this.selector+" .editor-form").style.display="block",-1==e&&document.querySelector(this.selector+" .entity-name").select()}addColumnToTable(e,t=!1){let a=document.querySelector(this.selector+" .entity-columns-table-body"),l=document.createElement("tr"),i=null==e.length?"":e.length.replace(/\D/g,""),n=null==e.default?"":e.default,r=e.type.split("(")[0].trim(),s="";e.primaryKey?s="disabled":e.nullable&&(s="checked"),l.innerHTML=`
            <td class="column-action">
                <button onclick="editor.removeColumn(this)" class="icon-delete"></button>
                <button onclick="editor.moveUp(this)" class="icon-move-up"></button>
                <button onclick="editor.moveDown(this)" class="icon-move-down"></button>    
            </td>
            <td><input type="text" class="column-name" value="${e.name}" placeholder="Column Name"></td>
            <td>
                <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
                    ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===r?"selected":""}>${e}</option>`).join("")}
                </select>
            </td>
            <td><input type="text" class="column-length" value="${i}" placeholder="Length" style="display: ${this.withLengthTypes.includes(r)?"inline":"none"};"></td>
            <td><input type="text" class="column-enum" value="${e.values}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(r)||this.withRangeTypes.includes(r)?"inline":"none"};"></td>
            <td><input type="text" class="column-default" value="${n}" placeholder="Default Value"></td>
            <td class="column-nl"><input type="checkbox" class="column-nullable" ${s}></td>
            <td class="column-pk"><input type="checkbox" class="column-primary-key" ${e.primaryKey?"checked":""}></td>
            <td class="column-ai"><input type="checkbox" class="column-autoIncrement" ${e.autoIncrement?"checked":""}></td>
        `,a.appendChild(l),t&&l.querySelector(".column-name").select()}addColumn(e=!1){let t=document.querySelector(this.selector+" .entity-container .entity-name").value,a=document.querySelectorAll(this.selector+" .entity-container .column-name").length,l=0==a?`${t}_id`:`${t}_col${a<=0?"":a+1}`,i=new Column(l,this.defaultDataType,this.defaultDataLength);i.nullable=!0,this.addColumnToTable(i,e);let n=document.querySelector(this.selector+" .entity-container .table-container");n.scrollTop=n.scrollHeight}saveEntity(){let e=document.querySelector(this.selector+" .entity-name").value,t=[],a=document.querySelectorAll(this.selector+" #table-entity-editor .column-name"),l=document.querySelectorAll(this.selector+" #table-entity-editor .column-type"),i=document.querySelectorAll(this.selector+" #table-entity-editor .column-nullable"),n=document.querySelectorAll(this.selector+" #table-entity-editor .column-default"),r=document.querySelectorAll(this.selector+" #table-entity-editor .column-primary-key"),s=document.querySelectorAll(this.selector+" #table-entity-editor .column-autoIncrement"),o=document.querySelectorAll(this.selector+" #table-entity-editor .column-length"),c=document.querySelectorAll(this.selector+" #table-entity-editor .column-enum");for(let u=0;u<a.length;u++){let d=new Column(a[u].value,l[u].value,o[u].value||null,i[u].checked,n[u].value||null,r[u].checked,s[u].checked,c[u].value||null);t.push(d)}if(this.currentEntityIndex>=0)this.entities[this.currentEntityIndex].name=e,this.entities[this.currentEntityIndex].columns=t;else{let h=new Entity(e);t.forEach(e=>h.addColumn(e)),this.entities.push(h)}this.renderEntities(),this.updateDiagram(),this.cancelEdit(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}updateDiagram(){document.querySelector(".diagram-container").querySelectorAll(".diagram-entity").forEach((e,t)=>{let a=e.getAttribute("id"),l=e.closest(".left-panel").offsetWidth,i=(e.getAttribute("data-entities")||"").split(","),n=[];editor.entities.forEach(e=>{i.includes(e.name)&&n.push(e)}),diagramRenderer[a].createERD({entities:n},l-240,!0)})}saveDiagram(){let e=this.getCheckedEntities(),t=[];Object.entries(e).forEach(([e,a])=>{let l=document.querySelector(`.tabs-link-container [data-id="${e}"] input`).value;t.push({id:e,name:l,entities:a})}),"function"==typeof this.callbackSaveDiagram&&this.callbackSaveDiagram(t)}showEditorTemplate(){this.currentEntityIndex=-2,document.querySelector(this.selector+" .template-columns-table-body").innerHTML="",this.template.columns.forEach(e=>this.addColumnToTemplate(e)),document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .entity-container").style.display="none",document.querySelector(this.selector+" .template-container").style.display="block",document.querySelector(this.selector+" .editor-form").style.display="block"}addColumnTemplate(e){this.addColumnToTemplate({name:"",type:"VARCHAR",length:"50",nullable:!0,default:null,values:""},e);let t=document.querySelector(this.selector+" .template-container .table-container");t.scrollTop=t.scrollHeight}addColumnToTemplate(e,t){let a=document.querySelector(this.selector+" .template-columns-table-body"),l=document.createElement("tr"),i=null==e.length?"":e.length.replace(/\D/g,""),n=null==e.default?"":e.default,r=e.type.split("(")[0].trim();l.innerHTML=`
            <td class="column-action">
                <button onclick="editor.removeColumn(this)" class="icon-delete"></button>
                <button onclick="editor.moveUp(this)" class="icon-move-up"></button>
                <button onclick="editor.moveDown(this)" class="icon-move-down"></button>    
            </td>
            <td><input type="text" class="column-name" value="${e.name}" placeholder="Column Name"></td>
            <td>
                <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
                    ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===r?"selected":""}>${e}</option>`).join("")}
                </select>
            </td>
            <td><input type="text" class="column-length" value="${i}" placeholder="Length" style="display: ${this.withLengthTypes.includes(r)?"inline":"none"};"></td>
            <td><input type="text" class="column-enum" value="${e.values}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(r)||this.withRangeTypes.includes(r)?"inline":"none"};"></td>
            <td><input type="text" class="column-default" value="${n}" placeholder="Default Value"></td>
            <td class="column-nl"><input type="checkbox" class="column-nullable" ${e.nullable?"checked":""}></td>
        `,a.appendChild(l),t&&l.querySelector(".column-name").select()}saveTemplate(){let e=[],t=document.querySelectorAll(this.selector+" .table-template-editor .column-name"),a=document.querySelectorAll(this.selector+" .table-template-editor .column-type"),l=document.querySelectorAll(this.selector+" .table-template-editor .column-nullable"),i=document.querySelectorAll(this.selector+" .table-template-editor .column-default"),n=document.querySelectorAll(this.selector+" .table-template-editor .column-length"),r=document.querySelectorAll(this.selector+" .table-template-editor .column-enum");for(let s=0;s<t.length;s++){let o=new Column(t[s].value,a[s].value,n[s].value||null,l[s].checked,i[s].value||null,r[s].value||null);e.push(o)}this.template.columns=e,document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none","function"==typeof this.callbackSaveTemplate&&this.callbackSaveTemplate(this.template)}cancelEditTemplate(){document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none"}addColumnFromTemplate(){let e=[],t=document.querySelectorAll(this.selector+" #table-entity-editor .column-name");for(let a of t)e.push(a.value);this.template.columns.forEach(t=>{e.includes(t.name)||this.addColumnToTable(t,focus)});let l=document.querySelector(this.selector+" .entity-container .table-container");l.scrollTop=l.scrollHeight}removeColumn(e){let t=e.closest("tr");t.remove()}moveUp(e){let t=e.closest("tr"),a=t.closest("tbody"),l=t.previousElementSibling;l&&a.insertBefore(t,l)}moveDown(e){let t=e.closest("tr"),a=t.closest("tbody"),l=t.nextElementSibling;l&&a.insertBefore(l,t)}createEntitiesFromJSON(e){let t=[];return e.entities.forEach(e=>{let a=new Entity(e.name);e.columns.forEach(e=>{let t=new Column(e.name,e.type,e.length,e.nullable,e.default,e.primaryKey,e.autoIncrement,"null"!==e.values?e.values:"");a.addColumn(t)}),t.push(a)}),{entities:t,diagrams:e.diagrams}}createTemplateFromJSON(e){let t=[];return e.columns.forEach(e=>{let a=new Column(e.name,e.type,e.length,e.nullable,e.default,"null"!==e.values?e.values:"");t.push(a)}),{columns:t}}createEntitiesFromSQL(e){let t=[];return e.forEach(e=>{let a=new Entity(e.tableName);e.columns.forEach(e=>{let t=new Column(e.Field,e.Type.toUpperCase(),e.Length,e.Nullable,e.Default,e.Key,e.AutoIncrement,null!=e.EnumValues&&"object"==typeof e.EnumValues?e.EnumValues.join(", "):null);a.addColumn(t)}),t.push(a)}),t}getCheckedEntities=function(){let e={};return document.querySelectorAll(".diagram-entity.tab-content").forEach(t=>{let a=t.getAttribute("id"),l=t.getAttribute("data-entities");e[a]=l?l.split(","):[]}),e};setCheckedEntities=function(e){document.querySelectorAll(".diagram-entity.tab-content").forEach(t=>{let a=e[t.getAttribute("id")];a&&t.setAttribute("data-entities",a.join(","))})};restoreCheckedEntities=function(){let e=document.querySelector(".diagram-entity.tab-content.active");if(e){let t=e.getAttribute("data-entities"),a=t?t.split(","):[];document.querySelectorAll('.left-panel .table-list [type="checkbox"]').forEach(e=>{e.checked=a.includes(e.getAttribute("data-name")),e.disabled=!1})}};renderEntities(){let e=document.querySelector(this.selector+" .entities-container"),t=[],a=document.querySelectorAll(this.selector+" .right-panel .selected-entity:checked");a&&a.forEach(e=>{t.push(e.getAttribute("data-name"))});let l=document.querySelector(this.selector+" .table-list-for-export"),i=document.querySelector(this.selector+" .left-panel .table-list"),n=document.querySelector(this.selector+" .draw-relationship").checked;i.innerHTML="",l.innerHTML="",this.entities.forEach((e,t)=>{let a=document.createElement("li"),n=document.createElement("li");a.innerHTML=`
            <label><input type="checkbox" class="selected-entity" data-name="${e.name}" value="${t}" />${e.name}</label>
            `,n.innerHTML=`<input type="checkbox" class="selected-entity" data-name="${e.name}" value="${t}" 
            /><a class="edit-table" href="javascript:">✏️</a><a class="delete-table" href="javascript:">❌</a> ${e.name}`,n.setAttribute("data-index",t),n.setAttribute("title",e.name),i.appendChild(n),n.querySelector("a.edit-table").addEventListener("click",function(e){editor.editEntity(parseInt(e.target.parentNode.getAttribute("data-index")))}),n.querySelector("a.delete-table").addEventListener("click",function(e){editor.deleteEntity(parseInt(e.target.parentNode.getAttribute("data-index")))}),l.appendChild(a)});let r=this.entities.length,s=r>0?`(${r})`:"";document.querySelector(this.selector+" .entity-count").textContent=s,t.forEach(e=>{let t=document.querySelector(`.right-panel input[data-name="${e}"]`);t&&(t.checked=!0)});let o=e.closest(".left-panel").offsetWidth;0==o&&(o=resizablePanels.getLeftPanelWidth()),o-=200,entityRenderer.createERD(editor.getData(),o-40,n)}refreshEntities(){let e=this;setTimeout(function(){let t=e.getCheckedEntities();e.renderEntities(),e.updateDiagram(),e.setCheckedEntities(t),e.restoreCheckedEntities()},!0)}prepareDiagram(){let e=this;this.diagrams.length>0&&this.diagrams.forEach(t=>{let a=document.querySelector(".tabs-link-container .diagram-list.tabs");e.addDiagram(a,t.name,t.id,t.entities,!0)})}selectDiagram(e){let t=document.querySelector(".diagram-container");e.closest("ul").querySelectorAll("li.diagram-tab").forEach(e=>{e.classList.remove("active")}),e.closest("ul").querySelector("li.all-entities").classList.remove("active"),t.querySelectorAll("div.diagram").forEach(e=>{e.classList.remove("active")}),e.classList.add("active");let a=e.getAttribute("data-id"),l=t.querySelector("#"+a);l.classList.add("active");let i=(l.getAttribute("data-entities")||"").split(",");document.querySelector(".entity-editor .table-list").querySelectorAll("li").forEach(e=>{let t=e.querySelector('input[type="checkbox"]'),a=t.getAttribute("data-name");i.length>0&&""!==a&&(t.checked=i.includes(a)),t.disabled=!1}),this.updateDiagram()}addDiagram(e,t,a,l,i){let n=this;i=i||!1;let r=`
        <input type="text" value="${t}">
        <a href="#tab1" class="tab-link select-diagram">${t}</a> 
        <a 
            href="javascript:" class="update-diagram"><span class="icon-ok"></span></a><a 
            href="javascript:" class="edit-diagram"><span class="icon-edit"></span></a><a 
            href="javascript:" class="delete-diagram"><span class="icon-delete"></span></a>
        `,s=document.createElement("li");s.innerHTML=r,s.setAttribute("data-edit-mode",i?"false":"true"),s.querySelector("a.tab-link").setAttribute("href","#"+t),s.setAttribute("data-id",a),s.classList.add("diagram-tab");let o=e.lastElementChild;e.insertBefore(s,o),s.querySelector("input").select(),s.querySelector("input").addEventListener("keypress",function(e){if("Enter"==e.key){let t=e.target.value;s.querySelector(".tab-link").innerText=t,s.setAttribute("data-edit-mode","false"),n.updateDiagram(),n.saveDiagram()}}),e.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.classList.remove("active")}),s.classList.add("active");let c=document.querySelector(".diagram-container");c.querySelectorAll(".diagram").forEach((e,t)=>{e.classList.remove("active")});let u=document.createElement("div");u.setAttribute("id",a),u.classList.add("diagram"),u.classList.add("diagram-entity"),u.classList.add("tab-content"),u.classList.add("active"),u.setAttribute("data-entities",l.join(","));let d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.setAttribute("width",4),d.setAttribute("height",4),d.classList.add("erd-svg"),u.appendChild(d),c.appendChild(u),diagramRenderer[a]=new EntityRenderer(`.diagram-container #${a} .erd-svg`),e.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.setAttribute("data-index",t)}),this.selectDiagram(s),this.updateDiagram(),s.querySelector(".select-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li");n.selectDiagram(t)}),s.querySelector(".update-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a=t.querySelector("input").value;t.querySelector(".tab-link").innerText=a,t.setAttribute("data-edit-mode","false"),n.updateDiagram(),n.saveDiagram()}),s.querySelector(".edit-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a=t.querySelector(".tab-link").innerText,l=t.querySelector("input");l.value=a,t.setAttribute("data-edit-mode","true"),l.select(),n.updateDiagram()}),s.querySelector(".delete-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a="#"+t.getAttribute("data-id"),l=t.closest("ul");t.parentNode.removeChild(t);let i=c.querySelector(a);i.parentNode.removeChild(i),l.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.setAttribute("data-index",t)}),n.updateDiagram(),n.saveDiagram()})}moveEntityUp(e){if(this.cancelEdit(),e<this.entities.length-1){let t=this.entities[e];this.entities[e]=this.entities[e+1],this.entities[e+1]=t,this.renderEntities(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}}moveEntityDown(e){if(this.cancelEdit(),e>0){let t=this.entities[e];this.entities[e]=this.entities[e-1],this.entities[e-1]=t,this.renderEntities(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}}sortEntities(){this.entities.sort((e,t)=>e.name>t.name?1:e.name<t.name?-1:0),this.renderEntities(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}editEntity(e){this.currentEntityIndex=e,this.showEditor(e)}deleteEntity(e){let t=this,a=t.entities[e].name;t.showConfirmationDialog(`<p>Are you sure you want to delete the entity &quot;${a}&quot;?</p>`,"Delete Confirmation","Yes","No",function(a){a&&(t.entities.splice(e,1),t.renderEntities(),t.exportToSQL(),"function"==typeof t.callbackSaveEntity&&t.callbackSaveEntity(t.entities))})}cancelEdit(){document.querySelector(this.selector+" .editor-form").style.display="none",document.querySelector(this.selector+" .button-container").style.display="block"}updateColumnLengthInput(e){let t=e.closest("tr"),a=e.value,l=t.querySelector(".column-length"),i=t.querySelector(".column-enum");if(this.withLengthTypes.includes(a)?l.style.display="inline":l.style.display="none",this.withValueTypes.includes(a)||this.withRangeTypes.includes(a)?i.style.display="inline":i.style.display="none",void 0!==this.defaultLength[a]){let n=this.defaultLength[a];l.value=n}}exportToSQL(){let e=[],t=document.querySelectorAll(this.selector+" .right-panel .selected-entity:checked");t.forEach((t,a)=>{let l=parseInt(t.value),i=this.entities[l];i&&e.push(i.toSQL())}),document.querySelector(this.selector+" .query-generated").value=e.join("\r\n")}exportJSON(e){let t=`${e.databaseName}-${e.databaseSchema}`,a=new Date,l=a.toISOString().replace(/[-T:\.Z]/g,"_");l.endsWith("_")&&(l=l.slice(0,-1));let i=`${t}_${l}.json`,n=JSON.stringify(e),r=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(r),o=document.createElement("a");o.href=s,o.download=i,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}downloadSQL(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),a=document.querySelector('meta[name="database-schema"]').getAttribute("content"),l=document.querySelector('meta[name="database-type"]').getAttribute("content"),i={applicationId:e,databaseType:l,databaseName:t,databaseSchema:a},n=`${i.databaseName}-${i.databaseSchema}`,r=new Date,s=r.toISOString().replace(/[-T:\.Z]/g,"_");s.endsWith("_")&&(s=s.slice(0,-1));let o=`${n}_${s}.sql`,c=new Blob([document.querySelector(this.selector+" .query-generated").value],{type:"text/plain"}),u=URL.createObjectURL(c),d=document.createElement("a");d.href=u,d.download=o,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(u)}importJSON(e,t){let a=this,l=new FileReader;l.onload=function(e){let l=e.target.result;try{let i=JSON.parse(l);a.entities=editor.createEntitiesFromJSON(i.entities),a.renderEntities(),"function"==typeof t&&t(a.entities)}catch(n){console.log("Error parsing JSON: "+n.message)}},l.readAsText(e)}importSQLFile(e,t){let a=this,l=new FileReader;l.onload=function(e){let l=e.target.result;try{l=new SQLConverter().translate(l,"mysql").split("`").join("");let i=new TableParser(l);a.entities=editor.createEntitiesFromSQL(i.tableInfo),a.renderEntities(),"function"==typeof t&&t(a.entities)}catch(n){console.log("Error parsing JSON: "+n.message)}},l.readAsText(e)}uploadEntities(){document.querySelector(this.selector+" .import-file-json").click()}importSQL(){document.querySelector(this.selector+" .import-file-sql").click()}downloadEntities(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),a=document.querySelector('meta[name="database-schema"]').getAttribute("content"),l=document.querySelector('meta[name="database-type"]').getAttribute("content"),i={applicationId:e,databaseType:l,databaseName:t,databaseSchema:a,entities:this.entities};this.exportJSON(i)}getData(){return{entities:this.entities}}showAlertDialog(e,t,a,l){let i=document.querySelector("#asyncAlert"),n=i.querySelector(".alert-ok");n=this.removeAllEventListeners(n),i.querySelector(".modal-header h3").innerHTML=t,i.querySelector(".modal-body").innerHTML=e,n.innerHTML=a,i.style.display="block",n.addEventListener("click",function e(){i.style.display="none","function"==typeof l&&l()}),n.focus()}showConfirmationDialog(e,t,a,l,i){let n=document.querySelector("#asyncConfirm"),r=n.querySelector(".confirm-ok"),s=n.querySelector(".confirm-cancel");r=this.removeAllEventListeners(r),s=this.removeAllEventListeners(s),n.querySelector(".modal-header h3").innerHTML=t,n.querySelector(".modal-body").innerHTML=e,r.innerHTML=a,s.innerHTML=l,n.style.display="block",r.addEventListener("click",function e(){n.style.display="none",i(!0)}),s.addEventListener("click",function e(){n.style.display="none",i(!1)})}removeAllEventListeners(e){let t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t}createDataTypeOption(e,t){let a="";return a+=`<select name="${e}" onchange="editor.setDefaultLength(this, '${t}')">\r
`,this.mysqlDataTypes.forEach((e,t)=>{a+=`<option value="${e}">${e}</option>\r
`}),a+="</select>"}setDefaultLength(e,t){let a=e.value;void 0!==this.defaultLength[a]&&(document.querySelector(t).value=this.defaultLength[a])}preference(){let e=this;e.showSettingDialog(`
            <table class="two-side-table">
                <tbody>
                    <tr>
                        <td>Primary Key Type</td>
                        <td>${e.createDataTypeOption("primary_key_type","#primary_key_length")}</td>
                    </tr>
                    <tr>
                        <td>Primary Key Length</td>
                        <td><input type="text" name="primary_key_length" id="primary_key_length" value=""></td>
                    </tr>
                    <tr>
                        <td>Column Type</td>
                        <td>${e.createDataTypeOption("column_type","#column_length")}</td>
                    </tr>
                    <tr>
                        <td>Column Length</td>
                        <td><input type="text" name="column_length" id="column_length" value=""></td>
                    </tr>
                </tbody>
            </table>
            `,"Preferences","OK","Cancel",function(t){t&&(e.primaryKeyDataType=document.querySelector('[name="primary_key_type"]').value,e.primaryKeyDataLength=document.querySelector('[name="primary_key_length"]').value,e.defaultDataType=document.querySelector('[name="column_type"]').value,e.defaultDataLength=document.querySelector('[name="column_length"]').value,"function"==typeof e.callbackSaveConfig&&e.callbackSaveConfig({primaryKeyDataType:e.primaryKeyDataType,primaryKeyDataLength:e.primaryKeyDataLength,defaultDataType:e.defaultDataType,defaultDataLength:e.defaultDataLength}))}),document.querySelector('[name="primary_key_type"]').value=e.primaryKeyDataType,document.querySelector('[name="primary_key_length"]').value=e.primaryKeyDataLength,document.querySelector('[name="column_type"]').value=e.defaultDataType,document.querySelector('[name="column_length"]').value=e.defaultDataLength}showSettingDialog(e,t,a,l,i){let n=document.querySelector("#settingModal"),r=n.querySelector(".confirm-ok"),s=n.querySelector(".confirm-cancel");function o(){n.style.display="none",i(!0)}function c(){n.style.display="none",i(!1)}n.querySelector(".modal-header h3").innerHTML=t,n.querySelector(".modal-body").innerHTML=e,r.innerHTML=a,s.innerHTML=l,n.style.display="block",r.removeEventListener("click",o),s.removeEventListener("click",c),r.addEventListener("click",o),s.addEventListener("click",c)}}