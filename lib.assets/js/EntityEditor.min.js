class EntityEditor{constructor(e,t={}){this.setting={defaultDataType:"VARCHAR",defaultDataLength:"48",primaryKeyDataType:"VARCHAR",primaryKeyDataLength:"40"},this.keyWords=["absolute","action","add","after","aggregate","alias","all","allocate","alter","analyse","analyze","and","any","are","array","as","asc","assertion","at","authorization","avg","before","begin","between","binary","bit","bit_length","blob","boolean","both","breadth","by","call","cascade","cascaded","case","cast","catalog","char","character","character_length","char_length","check","class","clob","close","coalesce","collate","collation","column","commit","completion","connect","connection","constraint","constraints","constructor","continue","convert","corresponding","count","create","cross","cube","current","current_date","current_path","current_role","current_time","current_timestamp","current_user","cursor","cycle","data","date","day","deallocate","dec","decimal","declare","default","deferrable","deferred","delete","depth","deref","desc","describe","descriptor","destroy","destructor","deterministic","diagnostics","dictionary","disconnect","distinct","do","domain","double","drop","dynamic","each","else","end","end-exec","equals","escape","every","except","exception","exec","execute","exists","external","extract","false","fetch","first","float","for","foreign","found","free","from","full","function","general","get","global","go","goto","grant","group","grouping","having","host","hour","identity","ignore","immediate","in","indicator","initialize","initially","inner","inout","input","insensitive","insert","int","integer","intersect","interval","into","is","isolation","iterate","join","key","language","large","last","lateral","leading","left","less","level","like","limit","local","localtime","localtimestamp","locator","lower","map","match","max","min","minute","modifies","modify","month","names","national","natural","nchar","nclob","new","next","no","none","not","null","nullif","numeric","object","octet_length","of","off","offset","old","on","only","open","operation","option","or","order","ordinality","out","outer","output","overlaps","pad","parameter","parameters","partial","path","placing","position","postfix","precision","prefix","preorder","prepare","preserve","primary","prior","privileges","procedure","public","read","reads","real","recursive","ref","references","referencing","relative","restrict","result","return","returns","revoke","right","role","rollback","rollup","routine","row","rows","savepoint","schema","scope","scroll","search","second","section","select","sequence","session","session_user","set","sets","size","smallint","some","space","specific","specifictype","sql","sqlcode","sqlerror","sqlexception","sqlstate","sqlwarning","start","state","statement","static","structure","substring","sum","system_user","table","temporary","terminate","than","then","time","timestamp","timezone_hour","timezone_minute","to","trailing","transaction","translate","translation","treat","trigger","trim","true","under","union","unique","unknown","unnest","update","upper","usage","user","using","value","values","varchar","variable","varying","view","when","whenever","where","with","without","work","write","year","zone"],Object.assign(this.setting,t),this.selector=e,this.entities=[],this.diagrams=[],this.currentEntityIndex=-1,this.mysqlDataTypes=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT","NUMERIC","DECIMAL","DOUBLE","FLOAT","BIT","DATE","TIME","DATETIME","TIMESTAMP","YEAR","LONGTEXT","MEDIUMTEXT","TEXT","TINYTEXT","VARCHAR","CHAR","ENUM","SET","LONGBLOB","MEDIUMBLOB","BLOB","TINYBLOB","UUID","VARBINARY","BINARY","POLYGON","LINESTRING","POINT","GEOMETRY","JSON",],this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.defaultLength={BIGINT:20,INT:11,MEDIUMINT:8,SMALLINT:5,TINYINT:4},this.autonumberTypes=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT"],this.addDomListeners(),this.callbackLoadEntity=this.setting.callbackLoadEntity,this.callbackSaveEntity=this.setting.callbackSaveEntity,this.callbackSaveDiagram=this.setting.callbackSaveDiagram,this.callbackLoadTemplate=this.setting.callbackLoadTemplate,this.callbackSaveTemplate=this.setting.callbackSaveTemplate,this.callbackSaveConfig=this.setting.callbackSaveConfig,this.defaultDataType=this.setting.defaultDataType+"",this.defaultDataLength=this.setting.defaultDataLength+"",this.primaryKeyDataType=this.setting.primaryKeyDataType+"",this.primaryKeyDataLength=this.setting.primaryKeyDataLength+"","function"==typeof this.callbackLoadEntity&&this.callbackLoadEntity(),"function"==typeof this.callbackLoadTemplate&&this.callbackLoadTemplate(),this.template={columns:[]},this.clearBeforeImport=!0,this.dragSrcRow=null,this.tbody=null,this.operation="create",this.currentEntityData=[],this.systemEntities=["admin","admin_level","admin_profile","admin_role","menu_cache","menu_group_translation","menu_translation","message","message_folder","module","module_group","notification","user_activity","user_password_history",],this.db=null,this.parsedTableData={},this.maxLength={}}getEntityByName(e){for(let t of this.entities)if(e===t.name)return t;return null}addDomListeners(){let e=this;document.querySelector(".check-all-entity-structure").addEventListener("change",t=>{let a=t.target.checked,i=t.target.closest("table").querySelector("tbody").querySelectorAll(".selected-entity-structure");i&&i.forEach(e=>{e.checked=a}),e.exportToSQL()}),document.addEventListener("change",function(t){if(t.target.classList.contains("column-primary-key")){let a=t.target.checked,i=t.target.closest("tr");a?(i.querySelector(".column-type").value=e.primaryKeyDataType,e.updateColumnLengthInput(i.querySelector(".column-type")),i.querySelector(".column-length").value=e.primaryKeyDataLength,i.querySelector(".column-nullable").checked=!1,i.querySelector(".column-nullable").disabled=!0,i.querySelector(".column-primary-key").checked&&(e.autonumberTypes.includes(i.querySelector(".column-type").value)?i.querySelector(".column-autoIncrement").disabled=!1:(i.querySelector(".column-autoIncrement").disabled=!0,i.querySelector(".column-autoIncrement").checked=!1))):i.querySelector(".column-nullable").disabled=!1}}),document.querySelector(this.selector+" .import-file-json").addEventListener("change",function(){let e=this.files[0];e?editor.importJSON(e,function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),i=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,i,e)}):console.log("Please select a JSON file first.")}),document.querySelector(this.selector+" .import-file-sql").addEventListener("change",function(){let e=this.files[0];e?editor.importSQLFile(e,function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),a=document.querySelector('meta[name="database-name"]').getAttribute("content"),i=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),a,i,e)}):console.log("Please select a JSON file first.")}),document.querySelector(this.selector+" .import-file-sheet").addEventListener("change",function(){let t=this.files[0];t?editor.importSheetFile(t,function(t,a,i,l,r){if("csv"==t||"dbf"==t){let n=e.toValidTableName(a),o=e.generateCreateTable(l,r);e.currentEntityData=r,e.importFromSheet(o,n)}else if("xls"==t||"xlsx"==t||"ods"==t){let s=e.toValidTableName(i),c=e.generateCreateTable(l,r);e.currentEntityData=r,e.importFromSheet(c,s)}}):console.log("Please select a JSON file first.")}),document.querySelector(this.selector).addEventListener("keypress",function(t){"Enter"==t.key&&(t.target.closest(".entity-container .entity-name")||t.target.closest(".entity-container .column-name")?e.addColumnIfValid(t.target):t.target.closest(".template-container .column-name")&&e.addColumnTemplateIfValid(t.target))}),this.initIconEvent()}addColumnIfValid(e){let t=e.value.toLowerCase();this.keyWords.some(e=>e.toLowerCase()===t)?this.showAlertDialog(`The word "${e.value}" is reserved and cannot be used. Please choose another one.`,"Reserved Word","Close",function(){e.select()}):this.addColumn(!0)}addColumnTemplateIfValid(e){let t=e.value.toLowerCase();this.keyWords.some(e=>e.toLowerCase()===t)?this.showAlertDialog(`The word "${e.value}" is reserved and cannot be used. Please choose another one.`,"Reserved Word","Close",function(){e.select()}):this.addColumnTemplate(!0)}initIconEvent(){let e=this;entityRenderer.svg.addEventListener("click",function(t){t.target.closest(".erd-svg .view-data-icon")&&e.viewData(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .move-down-icon")&&e.moveEntityUp(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .move-up-icon")&&e.moveEntityDown(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .edit-icon")&&e.editEntity(parseInt(t.target.dataset.index)),t.target.closest(".erd-svg .delete-icon")&&e.deleteEntity(parseInt(t.target.dataset.index))})}showEditor(e=-1){if(e>=0){this.operation="update",this.currentEntityIndex=e;let t=this.entities[e];document.querySelector(this.selector).dataset.state="update",document.querySelector(this.selector+" .entity-name").value=t.name,document.querySelector(this.selector+" .entity-columns-table-body").innerHTML="",t.columns.forEach(e=>this.addColumnToTable(e,!1,!1))}else{this.operation="create",this.currentEntityIndex=-1;let a=this.getNewTableName();document.querySelector(this.selector).dataset.state="create",document.querySelector(this.selector+" .entity-name").value=a,document.querySelector(this.selector+" .entity-columns-table-body").innerHTML=""}document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none",document.querySelector(this.selector+" .editor-form").style.display="block",-1==e&&document.querySelector(this.selector+" .entity-name").select()}getNewTableName(){let e=0,t="new_table",a=this.entities.map(e=>e.name.toLowerCase());for(;a.includes(t.toLowerCase());)t=`new_table_${++e}`;return t}importFromSheet(e,t){this.operation="create",this.currentEntityIndex=-1,t=t||this.getNewTableName(),document.querySelector(this.selector+" .entity-name").value=t,document.querySelector(this.selector+" .entity-columns-table-body").innerHTML="",e.forEach(e=>{this.addColumnToTable(e,!1,!0)}),document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none",document.querySelector(this.selector+" .editor-form").style.display="block",document.querySelector(this.selector+" .entity-name").select()}addColumnToTable(e,t=!1,a=!1){let i=document.querySelector(this.selector+" .entity-columns-table-body"),l=document.createElement("tr"),r=null==e.length?"":e.length.toString().replace(/\D/g,""),n=null==e.values?"":e.values,o=null==e.default?"":e.default,s=e.type.split("(")[0].trim(),c="disabled",d=e.name,u=this.maxLength[d]??"0";"BIGINT"==s.toUpperCase()&&""==r?r="20":"0"!=u&&(r=u);let m="";e.primaryKey?m="disabled":e.nullable&&(m="checked"),(e.primaryKey&&-1!=s.toLowerCase().indexOf("int")||e.autoIncrement)&&(c="");let h=e.description?e.description:"";l.innerHTML=`
            <td class="drag-handle"></td>
            <td class="column-action">
                <button onclick="editor.removeColumn(this)" class="icon-emoji icon-delete"></button>
                <button onclick="editor.moveUp(this)" class="icon-emoji icon-move-up"></button>
                <button onclick="editor.moveDown(this)" class="icon-emoji icon-move-down"></button>    
            </td>
            <td><input type="text" class="column-name" value="${e.name}" data-original-name="${d}" placeholder="Column Name"></td>
            <td>
                <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
                    ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===s?"selected":""}>${e}</option>`).join("")}
                </select>
            </td>
            <td><input type="text" class="column-length" value="${r}" max="${u}" placeholder="Length" style="display: ${this.withLengthTypes.includes(s)?"inline-block":"none"};"></td>
            <td><input type="text" class="column-enum" value="${n}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(s)||this.withRangeTypes.includes(s)?"inline":"none"};"></td>
            <td><input type="text" class="column-default" value="${o}" placeholder="Default Value"></td>
            <td class="column-nl"><input type="checkbox" class="column-nullable" ${m}></td>
            <td class="column-pk"><input type="checkbox" class="column-primary-key" ${e.primaryKey?"checked":""}></td>
            <td class="column-ai"><input type="checkbox" class="column-autoIncrement" ${e.autoIncrement?"checked":""} ${c}></td>
            <td><input type="text" class="column-description" value="${h}" placeholder="Description"></td>
        `,i.appendChild(l),this.initDraggableRow(l),t&&l.querySelector(".column-name").select()}initDraggableRow(e){let t=this;(void 0===t.tbody||null===t.tbody)&&(t.tbody=e.closest("tbody")),"true"!==e.dataset.hasDragEvent&&(e.dataset.hasDragEvent="true",e.addEventListener("mousedown",function(t){let a=t.target.tagName,i=["INPUT","TEXTAREA","SELECT"].includes(a);e.setAttribute("draggable",i?"false":"true")}),e.addEventListener("dragstart",function(e){t.dragSrcRow=this,this.classList.add("dragging"),e.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",function(){this.classList.remove("dragging")}),e.addEventListener("dragover",function(e){e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.add("over")}),e.addEventListener("dragleave",function(){this.classList.remove("over")}),e.addEventListener("drop",function(e){if(e.preventDefault(),t.dragSrcRow!==this){let a=Array.from(t.tbody.children),i=a.indexOf(t.dragSrcRow),l=a.indexOf(this);i<l?t.tbody.insertBefore(t.dragSrcRow,this.nextSibling):t.tbody.insertBefore(t.dragSrcRow,this),"function"==typeof t.updateRowNumbers&&t.updateRowNumbers()}this.classList.remove("over")}))}addColumn(e=!1){let t=this.selector+" .entity-container .entity-name",a=document.querySelector(t),i=a.value;if("create"==this.operation&&this.isEntityExists(i)){this.showConfirmationDialog(`Entity '${i}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(a.value=`${i}_new`,a.select())});return}let l=document.querySelectorAll(this.selector+" .entity-container .column-name").length,r=0===l?`${i}_id`:`${i}_col${0===l?"":l+1}`,n=new Column(r,this.defaultDataType,this.defaultDataLength);n.nullable=!0,this.addColumnToTable(n,e,!0);let o=document.querySelector(this.selector+" .entity-container .table-container");o.scrollTop=o.scrollHeight}isEntityExists(e){for(let t of this.entities)if(t.name===e)return!0;return!1}hasPrimaryKey(){let e=document.querySelectorAll(this.selector+" #table-entity-editor .column-primary-key");for(let t of e)if(t.checked)return!0;return!1}saveEntity(){let e=this.selector+" .entity-container .entity-name",t=document.querySelector(e),a=t.value;if(!this.hasPrimaryKey()){this.showAlertDialog("A primary key is required before saving the entity.","Primary Key Required","OK");return}let i=this.checkDuplicatedColumn();if(i){this.showAlertDialog(`Duplicate column name: '${i.name}'`,"Duplicated Column Name","OK",function(){i.element.select()});return}if("create"==this.operation&&this.isEntityExists(a)){this.showConfirmationDialog(`Entity '${a}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(t.value=`${a}_new`,t.select())});return}this.doSaveEntity();let l=document.querySelector(".tabs-link-container li.diagram-tab.active");l&&this.selectDiagram(l)}checkDuplicatedColumn(){let e=[],t=document.querySelectorAll(this.selector+" #table-entity-editor .column-name");for(let a=0;a<t.length;a++){let i=t[a].value;if(e.includes(i))return{index:a,name:i,element:t[a]};e.push(i)}return null}doSaveEntity(){let e=document.querySelector(this.selector+" .entity-name").value,t=[],a=[],i=document.querySelectorAll(this.selector+" #table-entity-editor .column-name"),l=document.querySelectorAll(this.selector+" #table-entity-editor .column-type"),r=document.querySelectorAll(this.selector+" #table-entity-editor .column-nullable"),n=document.querySelectorAll(this.selector+" #table-entity-editor .column-default"),o=document.querySelectorAll(this.selector+" #table-entity-editor .column-primary-key"),s=document.querySelectorAll(this.selector+" #table-entity-editor .column-autoIncrement"),c=document.querySelectorAll(this.selector+" #table-entity-editor .column-length"),d=document.querySelectorAll(this.selector+" #table-entity-editor .column-enum"),u=document.querySelectorAll(this.selector+" #table-entity-editor .column-description"),m=[];for(let h=0;h<i.length;h++){let p=new Column(i[h].value,l[h].value,c[h].value||null,r[h].checked,n[h].value||null,o[h].checked,s[h].checked,d[h].value||null,u[h].value||null);i[h].dataset.originalName&&i[h].dataset.originalName!=i[h].value&&m.push({original:i[h].dataset.originalName,new:i[h].value}),t.push(p),a.push(new Column(i[h].dataset.originalName,l[h].value,c[h].value||null,r[h].checked,n[h].value||null,o[h].checked,s[h].checked,d[h].value||null,u[h].value||null))}if(m.forEach(e=>{this.entities[this.currentEntityIndex]&&this.entities[this.currentEntityIndex].data&&this.entities[this.currentEntityIndex]&&this.entities[this.currentEntityIndex].data.forEach(t=>{t.hasOwnProperty(e.original)&&(t[e.new]=t[e.original],delete t[e.original])})}),this.currentEntityIndex>=0)this.entities[this.currentEntityIndex].name=e,this.entities[this.currentEntityIndex].index=this.currentEntityIndex,this.entities[this.currentEntityIndex].columns=t,this.entities[this.currentEntityIndex].modificationDate=new Date().getTime(),this.entities[this.currentEntityIndex].modifier="{{userName}}";else{let y=new Entity(e,this.entities.length);t.forEach(e=>y.addColumn(e));let g=this.snakeizeData(this.currentEntityData,a);m.forEach(e=>{g.forEach(t=>{t.hasOwnProperty(e.original)&&(t[e.new]=t[e.original],delete t[e.original])})}),y.setData(g),y.modificationDate=new Date().getTime(),y.creationDate=y.modificationDate,y.creator="{{userName}}",y.modifier="{{userName}}",this.entities.push(y)}this.renderEntities(),this.updateDiagram(),this.cancelEdit(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}updateDiagram(){let e=this;document.querySelector(".diagram-container").querySelectorAll(".diagram-entity").forEach(t=>{let a=t.getAttribute("id"),i=t.closest(".left-panel").offsetWidth,l=(t.dataset.entities||"").split(","),r=[];l.forEach(t=>{let a=e.getEntityByName(t);null!=a&&r.push(a)}),(isNaN(i)||i<240)&&(i=240),diagramRenderer[a].createERD({entities:r},i-240,document.querySelector("#draw-relationship").checked);let n=t.querySelector("svg");e.removeDiagramEventListener(n),e.addDiagramEventListener(n)})}saveDiagram(){let e=this.getCheckedEntities(),t=[],a=0;Object.entries(e).forEach(([e,i],l)=>{let r=document.querySelector(`.tabs-link-container [data-id="${e}"] input`).value;t.push({id:e,name:r,sortOrder:a,entities:i}),a++}),this.diagrams=t,"function"==typeof this.callbackSaveDiagram&&this.callbackSaveDiagram(t)}showEditorTemplate(){this.currentEntityIndex=-2,document.querySelector(this.selector+" .template-columns-table-body").innerHTML="",this.template.columns.forEach(e=>this.addColumnToTemplate(e)),document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .entity-container").style.display="none",document.querySelector(this.selector+" .template-container").style.display="block",document.querySelector(this.selector+" .editor-form").style.display="block"}addColumnTemplate(e){this.addColumnToTemplate({name:"",type:"VARCHAR",length:"50",nullable:!0,default:null,values:""},e);let t=document.querySelector(this.selector+" .template-container .table-container");t.scrollTop=t.scrollHeight}addColumnToTemplate(e,t){let a=document.querySelector(this.selector+" .template-columns-table-body"),i=document.createElement("tr"),l=null==e.length?"":e.length.replace(/\D/g,""),r=null==e.default?"":e.default,n=e.type.split("(")[0].trim(),o=e.description?e.description:"";i.innerHTML=`
            <td class="drag-handle"></td>
            <td class="column-action">
                <button onclick="editor.removeColumn(this)" class="icon-emoji icon-delete"></button>
                <button onclick="editor.moveUp(this)" class="icon-emoji icon-move-up"></button>
                <button onclick="editor.moveDown(this)" class="icon-emoji icon-move-down"></button>    
            </td>
            <td><input type="text" class="column-name" value="${e.name}" placeholder="Column Name"></td>
            <td>
                <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
                    ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===n?"selected":""}>${e}</option>`).join("")}
                </select>
            </td>
            <td><input type="text" class="column-length" value="${l}" placeholder="Length" style="display: ${this.withLengthTypes.includes(n)?"inline":"none"};"></td>
            <td><input type="text" class="column-enum" value="${e.values}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(n)||this.withRangeTypes.includes(n)?"inline":"none"};"></td>
            <td><input type="text" class="column-default" value="${r}" placeholder="Default Value"></td>
            <td class="column-nl"><input type="checkbox" class="column-nullable" ${e.nullable?"checked":""}></td>
            <td><input type="text" class="column-description" value="${o}" placeholder="Description"></td>
        `,a.appendChild(i),this.initDraggableRow(i),t&&i.querySelector(".column-name").select()}saveTemplate(){let e=[],t=document.querySelectorAll(this.selector+" .table-template-editor .column-name"),a=document.querySelectorAll(this.selector+" .table-template-editor .column-type"),i=document.querySelectorAll(this.selector+" .table-template-editor .column-nullable"),l=document.querySelectorAll(this.selector+" .table-template-editor .column-default"),r=document.querySelectorAll(this.selector+" .table-template-editor .column-length"),n=document.querySelectorAll(this.selector+" .table-template-editor .column-enum"),o=document.querySelectorAll(this.selector+" .table-template-editor .column-description");for(let s=0;s<t.length;s++){let c=new Column(t[s].value,a[s].value,r[s].value||null,i[s].checked,l[s].value||null,n[s].value||null,null,null,o[s].value||null);e.push(c)}this.template.columns=e,document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none","function"==typeof this.callbackSaveTemplate&&this.callbackSaveTemplate(this.template)}cancelEditTemplate(){document.querySelector(this.selector+" .entity-container").style.display="block",document.querySelector(this.selector+" .template-container").style.display="none"}addColumnFromTemplate(){let e=this.selector+" .entity-container .entity-name",t=document.querySelector(e),a=t.value;if("create"==this.operation&&this.isEntityExists(a)){this.showConfirmationDialog(`Entity '${a}' already exists.`,"Duplicate Entity Detected","Rename","Close",e=>{e&&(t.value=`${a}_new`,t.select())});return}let i=[],l=document.querySelectorAll(this.selector+" #table-entity-editor .column-name");for(let r of l)i.push(r.value);this.template.columns.forEach(e=>{i.includes(e.name)||this.addColumnToTable(e,focus,!0)});let n=document.querySelector(this.selector+" .entity-container .table-container");n.scrollTop=n.scrollHeight}removeColumn(e){let t=e.closest("tr");t.remove()}moveUp(e){let t=e.closest("tr"),a=t.closest("tbody"),i=t.previousElementSibling;i&&a.insertBefore(t,i)}moveDown(e){let t=e.closest("tr"),a=t.closest("tbody"),i=t.nextElementSibling;i&&a.insertBefore(i,t)}createEntitiesFromJSON(e){let t=[];return e.entities.forEach(e=>{let a=new Entity(e.name,e.index);e.columns.forEach(e=>{let t=new Column(e.name,e.type,e.length,e.nullable,e.default,e.primaryKey,e.autoIncrement,"null"!==e.values?e.values:"",e.description);a.addColumn(t)}),a.creationDate=e.creationDate||null,a.modificationDate=e.modificationDate||null,a.creator=e.creator,a.modifier=e.modifier,a.description=e.description||"",a.setData(e.data),t.push(a)}),{entities:t,diagrams:e.diagrams}}createTemplateFromJSON(e){let t=[];return e.columns.forEach(e=>{let a=new Column(e.name,e.type,e.length,e.nullable,e.default,"null"!==e.values?e.values:"",null,null,e.description);t.push(a)}),{columns:t}}createEntitiesFromSQL(e){let t=[];return e.forEach((e,a)=>{let i=new Entity(e.tableName,a);e.columns.forEach(e=>{let t=new Column(e.Field,e.Type.toUpperCase(),e.Length,e.Nullable,e.Default,e.Key,e.AutoIncrement,null!=e.EnumValues&&"object"==typeof e.EnumValues?e.EnumValues.join(", "):null,null);i.addColumn(t)}),i.creationDate=new Date().getTime(),i.modificationDate=i.creationDate,i.creator="{{userName}}",i.modifier="{{userName}}",t.push(i)}),t}getCheckedEntities(){let e={};return document.querySelectorAll(".diagram-entity.tab-content").forEach(t=>{let a=t.getAttribute("id"),i=t.dataset.entities;e[a]=i?i.split(","):[]}),e}setCheckedEntities(e){document.querySelectorAll(".diagram-entity.tab-content").forEach(t=>{let a=e[t.getAttribute("id")];a&&t.setAttribute("data-entities",a.join(","))})}restoreCheckedEntitiesFromCurrentDiagram(){let e=document.querySelector(".tabs-link-container .diagram-tab.active");this.selectDiagram(e)}restoreCheckedEntities(){let e=document.querySelector(".diagram-entity.tab-content.active");if(e){let t=e.dataset.entities,a=t?t.split(","):[];document.querySelectorAll('.left-panel .table-list [type="checkbox"]').forEach(e=>{e.checked=a.includes(e.dataset.name),e.disabled=!1})}}renderEntities(){let e=this,t=document.querySelector(this.selector+" .entities-container"),a=[],i=[],l=document.querySelectorAll(this.selector+" .right-panel .selected-entity-structure:checked"),r=document.querySelectorAll(this.selector+" .right-panel .selected-entity-data:checked");l.forEach(e=>a.push(e.dataset.name)),r.forEach(e=>i.push(e.dataset.name));let n=document.querySelector(this.selector+" .table-list-for-export"),o=document.querySelector(this.selector+" .left-panel .table-list"),s=document.querySelector(this.selector+" .draw-relationship").checked;if(o.innerHTML="",n.innerHTML="",this.entities.some(t=>!e.systemEntities.includes(t.name.toLowerCase()))){let c=document.createElement("tr");c.classList.add("group-header"),c.innerHTML=`<td>
                    <label><input type="checkbox" class="export-structure-custom" /> S</label>
                </td>
                <td>
                    <label><input type="checkbox" class="export-data-custom"/> D</label>
                </td>
                <td>[Custom Entities]</td>`,n.appendChild(c)}let d=0;if(this.entities.forEach((t,a)=>{!e.systemEntities.includes(t.name.toLowerCase())&&(e.appendBuildTableRow(n,t,d,"custom"),d++)}),this.entities.some(t=>e.systemEntities.includes(t.name.toLowerCase()))){let u=document.createElement("tr");u.classList.add("group-header"),u.innerHTML=`<td>
                    <label><input type="checkbox" class="export-structure-system" /> S</label>
                </td>
                <td>
                    <label><input type="checkbox" class="export-data-system"/> D</label>
                </td>
                <td>[Systen Entities]</td>`,n.appendChild(u)}this.entities.forEach((t,a)=>{e.systemEntities.includes(t.name.toLowerCase())&&(e.appendBuildTableRow(n,t,d,"system"),d++)}),this.entities.forEach((e,t)=>{let a=document.createElement("li");a.innerHTML=`
                <input type="checkbox" class="selected-entity" data-name="${e.name}" value="${t}" />
                <a class="edit-table" href="javascript:">✏️</a>
                <a class="delete-table" href="javascript:">❌</a> ${e.name}
            `,a.setAttribute("data-index",t),a.setAttribute("title",e.name),o.appendChild(a),a.querySelector("a.edit-table").addEventListener("click",e=>{editor.editEntity(parseInt(e.target.parentNode.dataset.index))}),a.querySelector("a.delete-table").addEventListener("click",e=>{editor.deleteEntity(parseInt(e.target.parentNode.dataset.index))})});let m=this.entities.length;document.querySelector(this.selector+" .entity-count").textContent=m>0?`(${m})`:"",a.forEach(e=>{let t=document.querySelector(`.right-panel input[data-name="${e}"].selected-entity-structure`);t&&(t.checked=!0)}),i.forEach(e=>{let t=document.querySelector(`.right-panel input[data-name="${e}"].selected-entity-data`);t&&(t.checked=!0)});let h=t.closest(".left-panel").offsetWidth;(isNaN(h)||0==h)&&(h=parseInt(resizablePanels.getLeftPanelWidth())),(isNaN(h)||0==h)&&(h=240),h-=240,entityRenderer.createERD(editor.getData(),h,s)}appendBuildTableRow(e,t,a,i){let l=document.createElement("tr");l.innerHTML=`
            <td>
                <label><input type="checkbox" class="selected-entity-structure entity-structure-${i}" data-name="${t.name}" value="${a}" /> S</label>
            </td>
            <td>
                <label><input type="checkbox" class="selected-entity-data entity-data-${i}" data-name="${t.name}" value="${a}" /> D</label>
            </td>
            <td>${t.name}</td>
        `,e.appendChild(l)}refreshEntities(){let e=this;setTimeout(function(){let t=e.getCheckedEntities();e.renderEntities(),e.updateDiagram(),e.setCheckedEntities(t),e.restoreCheckedEntities()},!0)}prepareDiagram(){let e=this;this.diagrams.length>0&&this.diagrams.forEach(t=>{let a=document.querySelector(".tabs-link-container .diagram-list.tabs");e.addDiagram(a,t.name,t.id,t.entities,!0)})}selectDiagram(e){let t=document.querySelector(".diagram-container"),a=[];if(e){e.closest("ul").querySelectorAll("li.diagram-tab").forEach(e=>{e.classList.remove("active")}),e.closest("ul").querySelector("li.all-entities").classList.remove("active"),t.querySelectorAll("div.diagram").forEach(e=>{e.classList.remove("active")}),e.classList.add("active");let i=e.dataset.id,l=t.querySelector("#"+i);l.classList.add("active");a=(l.dataset.entities||"").split(",")}document.querySelector(".entity-editor .table-list").querySelectorAll("li").forEach(e=>{let t=e.querySelector('input[type="checkbox"]'),i=t.dataset.name;a.length>0&&""!==i&&(t.checked=a.includes(i)),t.disabled=!1}),this.updateDiagram()}addDiagram(e,t,a,i,l){let r=this;l=l||!1;let n=`
        <input type="text" value="${t}">
        <a href="#tab1" class="tab-link select-diagram">${t}</a> 
        <a 
            href="javascript:" class="update-diagram"><span class="icon-emoji icon-ok"></span></a><a 
            href="javascript:" class="edit-diagram"><span class="icon-emoji icon-edit"></span></a><a 
            href="javascript:" class="delete-diagram"><span class="icon-emoji icon-delete"></span></a>
        `,o=document.createElement("li");o.innerHTML=n,o.setAttribute("data-edit-mode",l?"false":"true"),o.querySelector("a.tab-link").setAttribute("href","#"+t),o.setAttribute("data-id",a),o.classList.add("diagram-tab");let s=e.lastElementChild;e.insertBefore(o,s),o.querySelector("input").select(),o.querySelector("input").addEventListener("keypress",function(e){if("Enter"==e.key){let t=e.target.value;o.querySelector(".tab-link").innerText=t,o.setAttribute("data-edit-mode","false"),r.updateDiagram(),r.saveDiagram()}}),e.querySelectorAll("li.diagram-tab").forEach(e=>{e.classList.remove("active")}),o.classList.add("active");let c=document.querySelector(".diagram-container");c.querySelectorAll(".diagram").forEach(e=>{e.classList.remove("active")});let d=document.createElement("div");d.setAttribute("id",a),d.classList.add("diagram"),d.classList.add("diagram-entity"),d.classList.add("tab-content"),d.classList.add("active"),d.dataset.entities=i.join(","),d.dataset.name=t;let u=document.createElementNS("http://www.w3.org/2000/svg","svg");u.setAttribute("width",4),u.setAttribute("height",4),u.classList.add("erd-svg"),initDiagramContextMenu(u),d.appendChild(u),c.appendChild(d),diagramRenderer[a]=new EntityRenderer(`.diagram-container #${a} .erd-svg`),e.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.setAttribute("data-index",t)}),this.selectDiagram(o),this.updateDiagram(),o.querySelector(".select-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li");r.selectDiagram(t)}),o.querySelector(".update-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a=t.querySelector("input").value;t.querySelector(".tab-link").innerText=a,t.setAttribute("data-edit-mode","false"),r.updateDiagram(),r.saveDiagram(),r.restoreCheckedEntitiesFromCurrentDiagram()}),o.querySelector(".edit-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li"),a=t.querySelector(".tab-link").innerText,i=t.querySelector("input");i.value=a,t.setAttribute("data-edit-mode","true"),i.select(),r.updateDiagram(),r.restoreCheckedEntitiesFromCurrentDiagram()}),o.querySelector(".delete-diagram").addEventListener("click",function(e){e.preventDefault();let t=e.target.closest("li").querySelector('input[type="text"]').value;r.showConfirmationDialog(`<p>Are you sure you want to delete the diagram &quot;${t}&quot;?</p>`,"Delete Confirmation","Yes","No",function(t){if(t){let a=e.target.closest("li"),i="#"+a.dataset.id,l=a.closest("ul");a.parentNode.removeChild(a);let n=c.querySelector(i);n.parentNode.removeChild(n),l.querySelectorAll("li.diagram-tab").forEach((e,t)=>{e.setAttribute("data-index",t)}),r.updateDiagram(),r.saveDiagram()}})}),null===tabDragger&&(tabDragger=new TabDragger(e,function(){let e=r.getDiagrams();r.callbackSaveDiagram(e)})).initAll(),tabDragger.makeDraggable(o);updateMarginLeft(-10-o.offsetWidth)}addDiagramEventListener(e){let t=this;e._clickHandler||(e._clickHandler=function(e){t.editEventListener(e)}),e.addEventListener("click",e._clickHandler)}getNewDiagramName(){let e="New Diagram",t=this.getDiagrams(),a=e,i=0,l=!0;for(;l;)for(let r of(l=!1,t))if(r.name===a){l=!0,a=`${e} ${++i}`;break}return a}getDiagrams(){let e=[];return document.querySelector(".diagram-list.tabs").querySelectorAll("li.diagram-tab").forEach((t,a)=>{e.push({id:t.dataset.id,name:t.querySelector("input").value,sortOrder:a,entities:document.querySelector(".diagram-container").querySelector(`#${t.dataset.id}`).dataset.entities.split(",")})}),e}removeDiagramEventListener(e){e._clickHandler&&(e.removeEventListener("click",e._clickHandler),delete e._clickHandler)}clearDiagrams(){document.querySelector(".diagram-list.tabs .all-entities").classList.add("active");let e=document.querySelectorAll(".diagram-tab");e&&e.forEach(e=>{e.parentNode.removeChild(e)});let t=document.querySelectorAll(".diagram-entity.tab-content");t&&t.forEach(e=>{e.parentNode.removeChild(e)}),document.querySelector(".diagram-container #all-entities").classList.add("active")}clearEntities(){let e=document.querySelector(".diagram-container .all-entities");if(e){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");e.appendChild(t)}}editEventListener(e){if(e.target.closest(".erd-svg .view-data-icon")){let t=parseInt(e.target.dataset.index);this.viewData(t)}if(e.target.closest(".erd-svg .move-down-icon")){let a=e.target.closest(".diagram-entity").dataset.entities,i=e.target.closest(".svg-entity").dataset.entity,l=this.arrayElementOperation(a,i,1);e.target.closest(".diagram-entity").setAttribute("data-entities",l),this.updateDiagram(),this.saveDiagram()}if(e.target.closest(".erd-svg .move-up-icon")){let r=e.target.closest(".diagram-entity").dataset.entities,n=e.target.closest(".svg-entity").dataset.entity,o=this.arrayElementOperation(r,n,-1);e.target.closest(".diagram-entity").setAttribute("data-entities",o),this.updateDiagram(),this.saveDiagram()}if(e.target.closest(".erd-svg .edit-icon")){let s=parseInt(e.target.dataset.index);this.editEntity(s)}if(e.target.closest(".erd-svg .delete-icon")){let c=e.target.closest(".diagram-entity").dataset.entities,d=e.target.closest(".svg-entity").dataset.entity,u=this.removeUniqueElements(c.split(","),d).join(",");document.querySelector(`.selected-entity[data-name="${d}"]`).checked=!1,e.target.closest(".diagram-entity").setAttribute("data-entities",u),this.updateDiagram(),this.saveDiagram()}}removeUniqueElements(e,t){return e.filter(a=>!(a===t&&e.indexOf(a)===e.lastIndexOf(a)))}arrayElementOperation(e,t,a){let i=e.split(","),l=i.indexOf(t);if(-1===l||-1===a&&0===l||1===a&&l===i.length-1)return e;let r=l+a;return[i[l],i[r]]=[i[r],i[l]],i.join(",")}viewData(e=-1){let t=this;e<0?e=this.currentEntityIndex:this.currentEntityIndex=e;let a=this.entities[e],i=a.data.length;if(i>1e3){let l=`<p>This entity contains ${i} records.<br />Opening such a large dataset may cause your browser to become unresponsive or even crash due to running out of memory.<br />Do you still want to proceed?</p>`;t.showConfirmationDialog(l,"Warning: Large Dataset Detected","Open Anyway","Cancel",function(e){e&&t.showEntityDataDialog(a,`Entity Data - ${a.name}`)})}else t.showEntityDataDialog(a,`Entity Data - ${a.name}`)}moveEntityUp(e){if(this.cancelEdit(),e<this.entities.length-1){let t=this.entities[e];this.entities[e]=this.entities[e+1],this.entities[e+1]=t,this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}}moveEntityDown(e){if(this.cancelEdit(),e>0){let t=this.entities[e];this.entities[e]=this.entities[e-1],this.entities[e-1]=t,this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}}sortEntities(){this.entities.sort((e,t)=>e.name>t.name?1:e.name<t.name?-1:0),this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}sortAndGroupEntities(){let e=this,t=[],a=[];this.entities.forEach(i=>{e.systemEntities.includes(i.name)?a.push(i):t.push(i)}),t.sort((e,t)=>e.name.localeCompare(t.name)),a.sort((e,t)=>e.name.localeCompare(t.name)),this.entities=[...t,...a],this.updateEntityIndex(),this.renderEntities(),this.restoreCheckedEntitiesFromCurrentDiagram(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}updateEntityIndex(){this.entities.forEach((e,t)=>{e.index=t})}editEntity(e){this.currentEntityIndex=e,this.showEditor(e)}deleteEntity(e){let t=this,a=t.entities[e].name;t.showConfirmationDialog(`<p>Are you sure you want to delete the entity &quot;${a}&quot;?</p>`,"Delete Confirmation","Yes","No",function(a){a&&(t.entities.splice(e,1),t.updateEntityIndex(),t.renderEntities(),t.restoreCheckedEntitiesFromCurrentDiagram(),t.exportToSQL(),"function"==typeof t.callbackSaveEntity&&t.callbackSaveEntity(t.entities))})}cancelEdit(){document.querySelector(this.selector+" .editor-form").style.display="none",document.querySelector(this.selector+" .button-container").style.display="block"}updateColumnLengthInput(e){let t=e.closest("tr"),a=e.value,i=t.querySelector(".column-length"),l=t.querySelector(".column-enum");if(this.withLengthTypes.includes(a)?i.style.display="inline":i.style.display="none",this.withValueTypes.includes(a)||this.withRangeTypes.includes(a)?l.style.display="inline":l.style.display="none",void 0!==this.defaultLength[a]){let r=this.defaultLength[a];i.value=r}t.querySelector(".column-primary-key").checked&&(this.autonumberTypes.includes(t.querySelector(".column-type").value)?t.querySelector(".column-autoIncrement").disabled=!1:(t.querySelector(".column-autoIncrement").disabled=!0,t.querySelector(".column-autoIncrement").checked=!1))}exportToGraphQL(e="schema.graphql",t=!0){let a={CHAR:"String",VARCHAR:"String",TEXT:"String",LONGTEXT:"String",INT:"Int",INTEGER:"Int",BIGINT:"Int",SMALLINT:"Int",TINYINT:"Boolean",DECIMAL:"Float",NUMERIC:"Float",FLOAT:"Float",DOUBLE:"Float",REAL:"Float",BOOLEAN:"Boolean",DATE:"String",DATETIME:"String",TIMESTAMP:"String",TIME:"String",ENUM:"String",SET:"String"},i=e=>e.replace(/_([a-z])/g,(e,t)=>t.toUpperCase()),l=e=>{let t=i(e);return t.charAt(0).toUpperCase()+t.slice(1)},r=`# GraphQL Schema generated by MagicAppBuilder

`;this.entities.forEach(e=>{r+=`type ${l(e.name)} {
`,e.columns.forEach(n=>{let o=!1;if(n.name.endsWith("_id")){let s=n.name.slice(0,-3),c=this.entities.find(e=>e.name.toLowerCase()===s.toLowerCase());if(c&&c.name.toLowerCase()!==e.name.toLowerCase()){let d=l(c.name),u=i(c.name);r+=`    ${u}: ${d}${n.nullable?"":"!"}
`,o=!0}}if(!(t&&o)){let m;m=n.primaryKey?"ID":a[n.type.toUpperCase()]||"String",n.nullable||(m+="!"),r+=`    ${i(n.name)}: ${m}
`}}),r+=`}

`}),this.entities.forEach(e=>{r+=`input ${l(e.name)+"Input"} {
`;let t=e.columns.filter(e=>e.primaryKey),n=t.length>1;e.columns.forEach(t=>{let l=t.name.endsWith("_id")&&this.entities.some(a=>a.name.toLowerCase()===t.name.slice(0,-3).toLowerCase()&&a.name.toLowerCase()!==e.name.toLowerCase()),o;o=t.primaryKey||l?"ID":a[t.type.toUpperCase()]||"String";let s=n&&t.primaryKey||l&&!t.nullable||!t.primaryKey&&!l&&!t.nullable;s&&(o+="!"),r+=`    ${i(t.name)}: ${o}
`}),r+=`}

`});let n=new Blob([r],{type:"text/plain"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=e,s.click(),URL.revokeObjectURL(o)}exportToSQL(e="mysql"){let t=this.generateSQL(e);document.querySelector(this.selector+" .query-generated").value=t.join("\r\n")}generateSQL(e){let t=[],a=document.querySelectorAll(this.selector+" .right-panel .selected-entity-structure:checked");a.forEach(a=>{let i=parseInt(a.value),l=this.entities[i];l&&t.push(l.toSQL(e))});let i=document.querySelectorAll(this.selector+" .right-panel .selected-entity-data:checked");return i.forEach(a=>{let i=parseInt(a.value),l=this.entities[i];if(l){let r=l.toSQLInsert(e);""!=r&&t.push(r)}}),t}copyTableStructure(e){let t=this,a=document.querySelector('meta[name="database-type"]').getAttribute("content"),i=[];i.push(this.getEntityByName(selectedElement.dataset.entity).toSQL(a)),navigator.clipboard.writeText(i.join("")).then(()=>{t.showCopyEffect(e.clientX,e.clientY),hideContextMenu()}).catch(e=>{})}copyTableData(e){let t=this,a=document.querySelector('meta[name="database-type"]').getAttribute("content"),i=[];i.push(this.getEntityByName(selectedElement.dataset.entity).toSQLInsert(a)),navigator.clipboard.writeText(i.join("")).then(()=>{t.showCopyEffect(e.clientX,e.clientY),hideContextMenu()}).catch(e=>{})}copyTableStructureAndData(e){let t=this,a=document.querySelector('meta[name="database-type"]').getAttribute("content"),i=[],l=this.getEntityByName(selectedElement.dataset.entity);i.push(l.toSQL(a)),i.push(l.toSQLInsert(a)),navigator.clipboard.writeText(i.join("")).then(()=>{t.showCopyEffect(e.clientX,e.clientY),hideContextMenu()}).catch(e=>{})}editEntityContextMenu(){hideContextMenu(),this.editEntity(parseInt(selectedElement.dataset.index))}dataEntityContextMenu(){hideContextMenu(),this.viewData(parseInt(selectedElement.dataset.index))}downloadSVG(){let e=document.querySelector(".diagram-container").querySelector(".diagram.active");if(e){let t=e.getAttribute("id");"all-entities"==t?entityRenderer.downloadSVG():diagramRenderer[t].downloadSVG()}}downloadEntitySVG(e){this.downloadSVG(),this.showDownloadEffect(e.clientX,e.clientY),hideContextMenu()}downloadPNG(){let e=document.querySelector(".diagram-container").querySelector(".diagram.active");if(e){let t=e.getAttribute("id");"all-entities"==t?entityRenderer.downloadPNG():diagramRenderer[t].downloadPNG()}}downloadEntityPNG(e){hideContextMenu(),this.downloadPNG(),this.showDownloadEffect(e.clientX,e.clientY)}downloadMD(){let e=document.querySelector(".diagram-container").querySelector(".diagram.active");if(e){let t=e.getAttribute("id");"all-entities"==t?entityRenderer.downloadMD():diagramRenderer[t].downloadMD()}}downloadDiagramMD(e){hideContextMenu(),this.downloadMD(),this.showDownloadEffect(e.clientX,e.clientY)}showCopyEffect(e,t){let a=document.createElement("div");a.className="copy-feedback",a.style.left=`${e-32}px`,a.style.top=`${t-32}px`,document.body.appendChild(a),setTimeout(()=>{a.remove()},400)}showDownloadEffect(e,t){let a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("class","download-feedback"),a.setAttribute("width","64"),a.setAttribute("height","64"),a.setAttribute("viewBox","0 0 64 64"),a.innerHTML=`
        <svg height="64px" width="64px" version="1.1" id="DownloadArrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 166.356 166.356" xml:space="preserve" fill="#4CAF50"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path style="fill:#4CAF50;" d="M83.172,164.348L0,81.188h48.606V2.008h69.144v79.18h48.606L83.172,164.348z M14.404,87.155 l68.768,68.756l68.774-68.756h-40.163V7.975h-57.21v79.18H14.404z"></path> </g> </g> </g></svg>
        `,a.style.left=`${e-32}px`,a.style.top=`${t-182}px`,document.body.appendChild(a),setTimeout(()=>{a.remove()},400)}generateFileName(e){return e.databaseName&&e.databaseSchema?`${e.databaseName}-${e.databaseSchema}`:e.databaseName?`${e.databaseName}`:`${e.applicationId}`}exportJSON(e){let t=this.generateFileName(e),a=new Date,i=a.toISOString().replace(/[-T:\.Z]/g,"_");i.endsWith("_")&&(i=i.slice(0,-1));let l=`${t}_${i}.json`,r=JSON.stringify(e),n=new Blob([r],{type:"application/json"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=l,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}downloadSQL(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),a=document.querySelector('meta[name="database-schema"]').getAttribute("content"),i=document.querySelector('meta[name="database-type"]').getAttribute("content"),l=this.generateFileName({applicationId:e,databaseType:i,databaseName:t,databaseSchema:a}),r=new Date,n=r.toISOString().replace(/[-T:\.Z]/g,"_");n.endsWith("_")&&(n=n.slice(0,-1));let o=`${l}_${n}.sql`,s=new Blob([document.querySelector(this.selector+" .query-generated").value],{type:"text/plain"}),c=URL.createObjectURL(s),d=document.createElement("a");d.href=c,d.download=o,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(c)}importJSON(e,t){let a=this,i=new FileReader;i.onload=function(e){let i=e.target.result;try{let l=JSON.parse(i),r=editor.createEntitiesFromJSON(l);a.clearEntities(),a.clearDiagrams(),a.entities=r.entities,a.diagrams=r.diagrams||[],a.prepareDiagram(),a.updateDiagram(),a.renderEntities(),"function"==typeof t&&t(a.entities)}catch(n){console.log("Error parsing JSON: "+n.message)}},i.readAsText(e)}importSQLFile(e,t){let a=this,i=new FileReader,l=e.slice(0,512);i.onload=function(i){let l=new Uint8Array(i.target.result);a.looksLikeSQLite(l)?a.importSQLite(e,t):a.importSQLQuery(e,t)},i.onerror=()=>a.showAlertDialog("Failed to read file.","Alert","OK"),i.readAsArrayBuffer(l)}looksLikeSQLite(e){return[83,81,76,105,116,101,32,102,111,114,109,97,116,32,51,0].every((t,a)=>e[a]===t)}importSQLQuery(e,t){let a=this,i=new FileReader;i.onload=function(e){let i=e.target.result;try{let l=new SQLConverter,r=l.translate(i,"mysql").replace(/`/g,""),n=new TableParser(r);n.parseData(i);let o=editor.createEntitiesFromSQL(n.tableInfo);if(a.clearBeforeImport)a.entities=o,o.forEach(e=>{let t=e.name;n.data?.[t]&&e.setData(n.data[t])}),a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{let s=a.entities.map(e=>e.name);o.forEach(e=>{s.includes(e.name)||(e.index=a.entities.length,n.data?.[e.name]&&e.setData(n.data[e.name]),a.entities.push(e))}),a.renderEntities()}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram()}catch(c){console.log("Error parsing SQL: "+c.message)}},i.onerror=()=>{a.showAlertDialog("Failed to read file.","Alert","OK")},i.readAsText(e)}importSQLite(e,t){if(!e)return;let a=this,i=new FileReader;i.onload=function(e){let i=e.target.result,l=new Uint8Array(i);initSqlJs({locateFile:e=>"../lib.assets/wasm/sql-wasm.wasm"}).then(e=>{a.db=new e.Database(l);let i=a.db.exec("SELECT name FROM sqlite_master WHERE type='table';"),r=[];if(i[0].values.forEach((e,t)=>{let i=e[0],l=new Entity(a.snakeize(i),t),n=a.db.exec(`SELECT * FROM ${i};`);if(n.length>0){let o=n[0].columns,s=n[0].values;l.creationDate=new Date().getTime(),l.modificationDate=l.creationDate,l.creator="{{userName}}",l.modifier="{{userName}}",l.data=s.map(e=>{let t={};return o.forEach((i,l)=>{let r=a.snakeize(i);t[r]=e[l]}),t})}else l.setData(null);let c=a.db.exec(`PRAGMA table_info(${i});`);c.length>0&&(c[0].values.forEach(e=>{let t=new Column(a.snakeize(e[1]),a.toMySqlType(e[2]),a.getColumnSize(e[2]),1===e[3],e[4],e[5],!1,null);l.addColumn(t)}),r.push(l))}),a.clearBeforeImport)a.entities=r,a.clearEntities(),a.clearDiagrams(),a.renderEntities();else{let n=[];a.entities.forEach(e=>{n.push(e.name)}),r.forEach(e=>{n.includes(e.name)||(e.index=a.entities.length,a.entities.push(e))}),a.renderEntities()}"function"==typeof t&&t(a.entities),a.restoreCheckedEntitiesFromCurrentDiagram()})},i.readAsArrayBuffer(e)}toMySqlType(e){if(!e)return"TEXT";let t=e.trim().toUpperCase();for(let[a,i]of[[/NVARCHAR/,"VARCHAR"],[/INT/,"BIGINT"],[/(CHAR|CLOB|TEXT)/,"TEXT"],[/BLOB/,"BLOB"],[/(REAL|FLOA|DOUB)/,"DOUBLE"],[/(NUMERIC|DECIMAL)/,"DECIMAL"],[/BOOLEAN/,"TINYINT"],[/TIMESTAMP/,"TIMESTAMP"],[/(DATE|TIME)/,"DATETIME"]])if(a.test(t))return i;return e}getColumnSize(e){if(!e)return null;if(-1!==e.toUpperCase().indexOf("BOOL"))return 1;let t=e.match(/\((\d+)\)/);return t&&t[1]?parseInt(t[1]):null}toValidTableName(e){return e.replace(/\.[^/.]+$/,"").replace(/[^a-zA-Z0-9]+/g,"_").toLowerCase().replace(/^_+|_+$/g,"")}importSheetFile(e,t){let a=this,i=e.name.split(".").pop().toLowerCase(),l=new FileReader;l.onload=function(l){let r=l.target.result;if("csv"===i){let n=Papa.parse(r,{header:!0}),o=n.meta.fields,s=n.data;t(i,e.name,null,o,s)}else if("dbf"===i){let c=new DBFParser(r),d=c.parse(),u=c.fields.map(e=>e.name);t(i,e.name,null,u,d)}else if("xlsx"===i||"xls"===i||"ods"===i){let m=new Uint8Array(r),h=XLSX.read(m,{type:"array"}),p=a=>{let l=h.SheetNames[a],r=XLSX.utils.sheet_to_json(h.Sheets[l],{defval:""});if(r.length>0){let n=Object.keys(r[0]);t(i,e.name,l,n,r)}};if(h.SheetNames.length>1){let y=`
                        <table class="two-side-table">
                            <tbody>
                                <tr>
                                    <td>Sheet to Import</td>
                                    <td>
                                        <select id="sheet-index" class="form-control">
                                            ${h.SheetNames.map((e,t)=>`<option value="${t}">${t+1}. ${e}</option>`).join("")}
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    `;a.showConfirmationDialog(y,"Select Sheet","OK","Cancel",function(e){e&&p(parseInt(document.querySelector("#sheet-index").value))})}else p(0)}else a.showAlertDialog(`Unsupported file format: ${i}`,"Alert","OK")},"csv"===i?l.readAsText(e):l.readAsArrayBuffer(e)}triggerImportFromClipboard(){this.importFromClipboardManually()}async importFromClipboardManually(){try{let e=await navigator.clipboard.read(),t;for(let a of e)if(a.types.includes("text/html")){let i=await a.getType("text/html"),l=await i.text(),r=document.createElement("div");r.innerHTML=l;let n=r.querySelectorAll("table");if(n&&n.length>0){t=this.parseHtmlToJSON(n[0]),this.importFromClipboard(t);return}}let o=await navigator.clipboard.readText();t=this.parseTextToJSON(o),this.importFromClipboard(t)}catch(s){console.error("Failed to read clipboard: ",s)}}importFromClipboard(e){let t=e.headers.length>=2&&e.data.length>=1,a=e.headers.length>=1&&e.data.length>=2;if(!t&&!a){console.warn("Import aborted: Not enough columns or rows in clipboard data.");return}let i=this.generateCreateTable(e.headers,e.data);this.importFromSheet(i,this.getNewTableName()),this.currentEntityData=e.data}parseTextToJSON(e){let t=e.trim().replace(/\r\n/g,"\n").split("\n").map(e=>e.split("	").map(e=>e.trim()));for(;t.length&&t[0].every(e=>""===e);)t.shift();for(;t.length&&t[t.length-1].every(e=>""===e);)t.pop();function a(e){return 0===e.length||0===e[0].length?[]:e[0].map((t,a)=>e.map(e=>e[a]))}let i=a(t);for(;i.length&&i[0].every(e=>""===e);)i.shift();for(;i.length&&i[i.length-1].every(e=>""===e);)i.pop();if((t=a(i)).length<2)return{headers:[],data:[]};let l=t[0].map(e=>{var t;return t=e,t?t.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()):""}),r=t.slice(1).map(e=>{let t={};return l.forEach((a,i)=>{t[a]=e[i]??""}),t});return{headers:l,data:r}}parseHtmlToJSON(e){let t=[],a=[],i=[];function l(e){return e?e.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()):""}if(e.tHead){let r=e.tHead.querySelector("tr");a=Array.from(r.children).map(e=>l(e.textContent.trim())),i=Array.from(e.tBodies?.[0]?.rows||[])}else{let n=Array.from(e.rows);if(n.length>0){let o=n[0];a=Array.from(o.children).map(e=>l(e.textContent.trim())),i=n.slice(1)}}if(0===a.length)return{headers:[],data:[]};for(let s of i){let c={},d=Array.from(s.cells);for(let u=0;u<a.length;u++){let m=a[u],h=d[u];h?c[m]=h.textContent.trim():c[m]=null}t.push(c)}return{headers:a,data:t}}snakeizeData(e,t){let a=t.map(e=>e.name),i=[];if(Array.isArray(e))for(let l of e){let r={};for(let n of Object.keys(l)){let o=this.snakeize(n);a.includes(o)&&(r[o]=l[n])}i.push(r)}return i}snakeizeKey(e){let t=[];if(Array.isArray(e))for(let a of e){let i={};for(let l of Object.keys(a)){let r=this.snakeize(l);i[r]=a[l]}t.push(i)}return t}guessType(e){let t=!0,a=!0,i=!0,l=!1;for(let r of e.slice(0,24)){if(null==r)return"TEXT";r="string"!=typeof r?String(r).trim():r.trim(),/^0\d+/.test(r)&&(t=!1,a=!1),/^[-+]?\d+\.\d+$/.test(r)&&(l=!0),/^[-+]?\d+$/.test(r)||(t=!1),/^[-+]?\d+(\.\d+)?$/.test(r)||(a=!1),/^(true|false|yes|no|1|0)$/i.test(r)||(i=!1)}return a&&l?"FLOAT":t?"BIGINT":i?"BOOLEAN":"TEXT"}generateCreateTable(e,t){let a=this;this.maxLength={};let i=e.map(e=>{let i=a.snakeize(e),l=t.map(t=>t[e]),r=0;l.forEach(e=>{if("string"==typeof e||"number"==typeof e){let t=String(e).length;t>r&&(r=t)}}),a.maxLength[i]=10*Math.ceil(r/10);let n=a.guessType(l);return new Column(i,n,null,!0,null,!1,!1,null,null)});return i}snakeize(e){return e.replace(/[_\-]+/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/[^a-zA-Z0-9 ]+/g,"").toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()).replace(/\s+/g,"_").toLowerCase().replace(/^_+|_+$/g,"").replace(/__+/g,"_")}uploadEntities(){this.clearBeforeImport=!0,document.querySelector(this.selector+" .import-file-json").click()}importSQL(){this.clearBeforeImport=!1,document.querySelector(this.selector+" .import-file-sql").click()}importSheet(){this.clearBeforeImport=!1,document.querySelector(this.selector+" .import-file-sheet").click()}async downloadEntities(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),a=document.querySelector('meta[name="database-schema"]').getAttribute("content"),i=buildUrl("entity",e,document.querySelector('meta[name="database-type"]').getAttribute("content"),t,a,[]);try{let l=await fetch(i);if(!l.ok)throw Error(`Failed to fetch: ${l.status} ${l.statusText}`);let r=await l.text(),n=new Blob([r],{type:"application/json"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=e+".json",s.click(),URL.revokeObjectURL(o)}catch(c){console.error("Error downloading entities:",c)}}getData(){return{entities:this.entities}}showAlertDialog(e,t,a,i){let l=document.querySelector("#asyncAlert"),r=l.querySelector(".alert-ok");r=this.removeAllEventListeners(r),l.querySelector(".modal-header h3").innerHTML=t,l.querySelector(".modal-body").innerHTML=e,r.innerHTML=a,l.style.display="block",r.addEventListener("click",function e(){l.style.display="none","function"==typeof i&&i()}),r.focus()}showConfirmationDialog(e,t,a,i,l){let r=document.querySelector("#asyncConfirm"),n=r.querySelector(".confirm-ok"),o=r.querySelector(".confirm-cancel");n=this.removeAllEventListeners(n),o=this.removeAllEventListeners(o),r.querySelector(".modal-header h3").innerHTML=t,r.querySelector(".modal-body").innerHTML=e,n.innerHTML=a,o.innerHTML=i,r.style.display="block",n.addEventListener("click",function e(){r.style.display="none",l(!0)}),o.addEventListener("click",function e(){r.style.display="none",l(!1)})}showDescriptionDialog(){let e=this,t=e.entities[e.currentEntityIndex].name,a=e.entities[e.currentEntityIndex].description||"",i="#exportModal";showExportDialog(i,'<textarea class="description-textarea" placeholder="Enter description here..." spellcheck="false" autocomplete="off"></textarea>',`Entity Description - ${t}`,"Save","Cancel",function(t){t&&(e.entities[e.currentEntityIndex].description=document.querySelector(i+" .description-textarea").value,e.callbackSaveEntity(e.entities)),document.querySelector(i).style.display="none"}),document.querySelector(i+" .description-textarea").value=a}removeAllEventListeners(e){let t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t}createDataTypeOption(e,t){let a="";return a+=`<select name="${e}" onchange="editor.setDefaultLength(this, '${t}')">\r
`,this.mysqlDataTypes.forEach(e=>{a+=`<option value="${e}">${e}</option>\r
`}),a+="</select>"}setDefaultLength(e,t){let a=e.value;void 0!==this.defaultLength[a]&&(document.querySelector(t).value=this.defaultLength[a])}preference(){let e=this;e.showSettingDialog(`
            <table class="two-side-table">
                <tbody>
                    <tr>
                        <td>Primary Key Type</td>
                        <td>${e.createDataTypeOption("primary_key_type","#primary_key_length")}</td>
                    </tr>
                    <tr>
                        <td>Primary Key Length</td>
                        <td><input type="text" name="primary_key_length" id="primary_key_length" value=""></td>
                    </tr>
                    <tr>
                        <td>Column Type</td>
                        <td>${e.createDataTypeOption("column_type","#column_length")}</td>
                    </tr>
                    <tr>
                        <td>Column Length</td>
                        <td><input type="text" name="column_length" id="column_length" value=""></td>
                    </tr>
                </tbody>
            </table>
            `,"Preferences","OK","Cancel",function(t){t&&(e.primaryKeyDataType=document.querySelector('[name="primary_key_type"]').value,e.primaryKeyDataLength=document.querySelector('[name="primary_key_length"]').value,e.defaultDataType=document.querySelector('[name="column_type"]').value,e.defaultDataLength=document.querySelector('[name="column_length"]').value,"function"==typeof e.callbackSaveConfig&&e.callbackSaveConfig({primaryKeyDataType:e.primaryKeyDataType,primaryKeyDataLength:e.primaryKeyDataLength,defaultDataType:e.defaultDataType,defaultDataLength:e.defaultDataLength}))}),document.querySelector('[name="primary_key_type"]').value=e.primaryKeyDataType,document.querySelector('[name="primary_key_length"]').value=e.primaryKeyDataLength,document.querySelector('[name="column_type"]').value=e.defaultDataType,document.querySelector('[name="column_length"]').value=e.defaultDataLength}showSettingDialog(e,t,a,i,l){let r=document.querySelector("#settingModal"),n=r.querySelector(".confirm-ok"),o=r.querySelector(".confirm-cancel");function s(){r.style.display="none",l(!0)}function c(){r.style.display="none",l(!1)}r.querySelector(".modal-header h3").innerHTML=t,r.querySelector(".modal-body").innerHTML=e,n.innerHTML=a,o.innerHTML=i,r.style.display="block",n.removeEventListener("click",s),o.removeEventListener("click",c),n.addEventListener("click",s),o.addEventListener("click",c)}showEntityDataDialog(e,t){let a=document.querySelector("#entityDataEditorModal"),i=a.querySelector(".modal-header h3"),l=a.querySelector(".modal-body"),r=e.data||[];i.innerHTML=t||"Entity Data",l.innerHTML="";let n=document.createElement("div");n.style.overflow="auto",n.style.maxHeight="400px";let o=document.createElement("table");o.className="data-preview-table",o.style.width="100%",o.style.borderCollapse="collapse";let s=document.createElement("thead"),c=document.createElement("tr"),d=document.createElement("th");d.classList.add("td-remover"),c.appendChild(d);let u=document.createElement("tbody");o.appendChild(s),o.appendChild(u),n.appendChild(o),l.appendChild(n);let m=document.createElement("div");m.innerHTML=`
        Fix Date Time 
        <select id="selector-fix-date-time" class="form-control">
        </select>
        Format
        <select id="format-preference" class="form-control">
            <option value="mdy">mdy</option>
            <option value="dmy">dmy</option>
            <option value="ymd">ymd</option>
        </select>
        Mode
        <select id="date-time-mode" class="form-control">
            <option value="datetime">datetime</option>
            <option value="date">date</option>
            <option value="time">time</option>
        </select>
        <button ="button-fix-date-time" class="btn btn-primary" onclick="editor.fixDateTime(this.closest('div').querySelector('#selector-fix-date-time').value, this.closest('div').querySelector('#format-preference').value, this.closest('div').querySelector('#date-time-mode').value)">Fix Data</button>
        `;let h=document.createElement("option");h.value="",h.textContent="Select Column",m.classList.add("button-area"),l.appendChild(m),m.querySelector("select").appendChild(h),a.style.display="block",e.columns.forEach(e=>{let t=document.createElement("th");t.classList.add("entity-column"),t.textContent=e.name,t.dataset.name=e.name,c.appendChild(t);let a=document.createElement("option");a.value=e.name,a.textContent=e.name,m.querySelector("select").appendChild(a)}),s.appendChild(c),r.forEach((t,a)=>{let i=document.createElement("tr"),l=document.createElement("td");l.classList.add("td-remover");let r=document.createElement("a");r.className="delete-row",r.href="javascript:",r.textContent="❌",l.appendChild(r),i.appendChild(l),e.columns.forEach((e,l)=>{let r=this.createEntityDataCell(a,l,e,t[e.name]??"");i.appendChild(r)}),u.appendChild(i),r.addEventListener("click",function(e){e.preventDefault(),u.removeChild(i)})})}createEntityDataCell(e,t,a,i=""){let l=document.createElement("td");l.classList.add("entity-column");let r=document.createElement("input");return r.type="text",r.classList.add("entity-data-cell"),r.name=`cell-${e}-${t}`,r.dataset.row=e,r.dataset.col=a.name,r.dataset.type=a.type,r.value=i??"",r.style.width="100%",r.style.boxSizing="border-box",l.appendChild(r),l}exportData(){let e=this.entities[this.currentEntityIndex],t=[],a=[];document.querySelector(".data-preview-table").querySelector("thead").querySelectorAll("th.entity-column").forEach(e=>{t.push(e.dataset.name)});let i=document.querySelector(".data-preview-table").querySelector("tbody").querySelectorAll("tr");i&&i.forEach(e=>{let t={};e.querySelectorAll("td.entity-column").forEach(e=>{let a=e.querySelector("input");a&&a.name&&(t[a.dataset.col]=a.value)}),a.push(t)});let l=[];l.push(t.join(",")),a.forEach(e=>{let a=t.map(t=>`"${(e[t]||"").replace(/"/g,'""')}"`);l.push(a.join(","))});let r=l.join("\n"),n=new Blob([r],{type:"text/csv"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=`${e.name}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}clearData(){this.showConfirmationDialog("Are you sure you want to delete all data?","Clear Entity Data Confirmation","Yes","No",e=>{e&&(document.querySelector(".data-preview-table tbody").innerHTML="")})}addData(){let e=this.entities[this.currentEntityIndex],t=document.querySelector("#entityDataEditorModal"),a=t.querySelector(".data-preview-table tbody");if(!a)return console.warn("Table body for entity data editor not found."),null;let i=a.rows.length,l=document.createElement("tr"),r=document.createElement("td");r.classList.add("td-remover");let n=document.createElement("a");return n.className="delete-row",n.href="javascript:void(0);",n.textContent="❌",r.appendChild(n),l.appendChild(r),e.columns.forEach((e,t)=>{let a=this.createEntityDataCell(i,t,e,"");l.appendChild(a)}),n.addEventListener("click",function(e){e.preventDefault(),l.remove()}),a.appendChild(l),l}saveData(){let e=this.entities[this.currentEntityIndex],t=document.querySelector("#entityDataEditorModal"),a=t.querySelectorAll(".data-preview-table input"),i={};a.forEach(e=>{let t=e.dataset.row,a=e.dataset.col;i[t]||(i[t]={}),i[t][a]=e.value});let l=Object.keys(i).sort((e,t)=>parseInt(e)-parseInt(t)).map(e=>i[e]);e.data=l;let r=document.querySelector('meta[name="application-id"]').getAttribute("content"),n=document.querySelector('meta[name="database-name"]').getAttribute("content"),o=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendEntityToServer(r,document.querySelector('meta[name="database-type"]').getAttribute("content"),n,o,this.entities),this.exportToSQL(),t.style.display="none"}async exportHTMLDocument(e,t=!1){let a=[],i=[];e.forEach(e=>{e.entities&&e.entities.forEach(e=>{e&&!a.includes(e)&&a.push(e)});let t=document.querySelector(`#${e.id}`);if(t){t.dataset.name=e.name;let l=t.cloneNode(!0);i.push(l)}});let l=document.createElement("div");for(let r of(l.classList.add("export-container"),e)){let n=document.createElement("div");n.className="diagram-section";let o=i.find(e=>e.dataset.name===r.name);if(o){let s=document.createElement("div");s.className="svg-wrapper";let c=document.createElement("h3");if(c.textContent=`Diagram: ${o.dataset.name}`,s.appendChild(c),t)try{let d=o.querySelector("svg"),u=await convertSvgToPng(d),m=document.createElement("img");m.src=u,s.appendChild(m)}catch(h){console.error("❌ Failed to convert SVG to PNG",h),s.appendChild(o)}else s.appendChild(o);n.appendChild(s)}r.entities&&r.entities.forEach(e=>{let t=this.getEntityByName(e);if(t){let a=document.createElement("div");a.className="table-wrapper";let i=document.createElement("h3");i.textContent=`Entity: ${e}`,a.appendChild(i),t.description?.trim()&&t.description.trim().split(/\r?\n/).map(e=>e.trim()).filter(e=>""!==e).forEach(e=>{let t=document.createElement("p");t.textContent=e,a.appendChild(t)});let l=this.createHtmlEntity(t);a.appendChild(l),n.appendChild(a)}}),l.appendChild(n)}let p=document.createElement("div");p.classList.add("table-wrapper");let y=document.createElement("h3");y.textContent="Table: Entities Ordered by Dependency Depth",p.appendChild(y);let g=this.sortEntitiesByDepth(this.calculateEntityDepth(this.entities)),f=document.createElement("table"),b=document.createElement("thead"),E=document.createElement("tbody"),v=document.createElement("tr");f.appendChild(b),f.appendChild(E),b.appendChild(v);let S=document.createElement("th");S.classList.add("column-number"),S.textContent="#",v.appendChild(S);let w=document.createElement("th");w.textContent="Entity Name",v.appendChild(w);let C=document.createElement("th");C.textContent="Dependency Depth",v.appendChild(C),g.forEach((e,t)=>{let a=document.createElement("tr"),i=document.createElement("td");i.classList.add("column-number"),i.textContent=`${t+1}`,a.appendChild(i);let l=document.createElement("td");l.textContent=e.name,a.appendChild(l);let r=document.createElement("td");r.textContent=e.depth,a.appendChild(r),E.appendChild(a)}),p.appendChild(f),l.appendChild(p);let D=new Date,T=D.toLocaleString(),L=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Exported Diagrams</title>
            <style>
                body { font-family: Arial; font-size: 12px; margin: 20px; }
                .document-center { text-align: center; }
                .generated-info { text-align: center; font-size: 11px; color: #666; margin-bottom: 20px; }

                .diagram-section {
                    margin-bottom: 30px;
                    border-radius: 8px;
                    padding: 10px;
                    page-break-after: always;
                }

                @media screen {
                    .diagram-section {
                        border: 1px solid #ccc;
                        border-radius: 8px;
                    }
                }

                @media print {
                    .diagram-section {
                        border: none !important;
                        border-radius: 0 !important;
                    }
                }

                .svg-wrapper { text-align: center; margin-bottom: 10px; }
                .svg-wrapper svg { max-width: 100%; height: auto; }
                .table-wrapper { overflow-x: auto; }
                table { border-collapse: collapse; width: 100%; font-size: 11px; }
                th, td { border: 1px solid #999; padding: 6px; text-align: left; }
                th { background-color: #eee; }

                @media print {
                    body { font-size: 10px; margin: 10mm; }
                    h3 { font-size: 14px; margin-bottom: 5px; }
                    .svg-wrapper svg, .table-wrapper table { page-break-inside: avoid; }
                }
                .column-number{
                    width: 16px;
                }
                th.column-number{
                    text-align: center;
                }
                td.column-number{
                    text-align: right;
                }
            </style></head>
            <body>
                <h1 class="document-center">Entity Relationship Diagram</h1>
                <div class="generated-info">Generated at: ${T}</div>
                ${l.innerHTML}
            </body></html>`,x=new Blob([L],{type:"text/html"}),q=URL.createObjectURL(x),k=document.createElement("a");k.href=q,k.download="diagrams.html",k.click(),URL.revokeObjectURL(q)}createHtmlEntity(e){let t=this,a=document.createElement("table"),i=document.createElement("thead"),l=document.createElement("tr"),r=["20%","14%","9%","9%","9%","8%","8%","23%"],n=["Column Name","Type","Length","Nullable","Default","PK","Serial","Description"];["columnName","type","length","nullable","default","primaryKey","autoIncrement","description"].forEach((e,t)=>{let a=document.createElement("th");a.textContent=n[t],a.style.width=r[t],l.appendChild(a)}),i.appendChild(l),a.appendChild(i);let o=document.createElement("tbody");return e.columns.forEach(e=>{let a=t.createHtmlColumn(e);o.appendChild(a)}),a.appendChild(o),a}createHtmlColumn(e){let t=document.createElement("tr");return e.primaryKey=1==e.primaryKey||!0===e.primaryKey,["name","type","length","nullable","default","primaryKey","autoIncrement","description"].forEach(a=>{let i=document.createElement("td");i.textContent="boolean"==typeof e[a]?!0===e[a]?"true":"false":e[a],t.appendChild(i)}),t}camelToTitle(e){return e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase())}showExportHTMLDialog(){let e=document.createElement("div");e.classList.add("diagram-export-selector");let t=document.createElement("ul"),a=document.querySelectorAll(".diagram-tab");if(a){let i=document.createElement("input"),l=document.createElement("label"),r="cbd-all",n=document.createElement("li");l.setAttribute("for",r),l.textContent="Select All",i.setAttribute("type","checkbox"),i.id=r,i.setAttribute("onchange","checkAllDiagram(event)"),n.appendChild(i),n.appendChild(document.createTextNode(" ")),n.appendChild(l),t.appendChild(n);let o=document.createElement("li"),s=document.createElement("ul");t.appendChild(o),o.appendChild(s),a.forEach((e,t)=>{let a=e.querySelector("input");n=document.createElement("li");let i=document.createElement("input");l=document.createElement("label"),r=`cbd-${t}`,l.setAttribute("for",r),l.textContent=a.value,i.setAttribute("type","checkbox"),i.setAttribute("value",e.dataset.index),i.classList.add("diagram-to-export"),i.id=r,n.appendChild(i),n.appendChild(document.createTextNode(" ")),n.appendChild(l),s.appendChild(n)}),n=document.createElement("li");let c=document.createElement("input");l=document.createElement("label"),r="export-use-png",l.setAttribute("for",r),l.textContent="Export Image as PNG instead of SVG",c.setAttribute("type","checkbox"),c.id=r,c.classList.add("export-as-png"),n.appendChild(c),n.appendChild(document.createTextNode(" ")),n.appendChild(l),t.appendChild(n)}e.appendChild(t),editor.showConfirmationDialog(e.outerHTML,"Export Document","Export","Cancel",function(e){if(e){let t=document.querySelectorAll(".diagram-to-export"),a=[];t.forEach(e=>{if(e.checked){let t=parseInt(e.value);a.push(editor.diagrams[t])}});let i=document.getElementById("export-use-png").checked;editor.exportHTMLDocument(a,i)}})}calculateEntityDepth(e,t=!1){let a=Object.fromEntries(e.map(e=>[e.name,e])),i={};for(let l of e){let r=l.columns.filter(e=>e.name.endsWith("_id")).map(e=>e.name.replace(/_id$/,"")).filter(e=>e!==l.name&&a[e]);i[l.name]=r}let n=new Map;function o(e,t=new Set){if(n.has(e))return n.get(e);if(t.has(e))return 0;t.add(e);let a=i[e]||[],l=a.length>0?Math.max(...a.map(e=>o(e,new Set(t)))):0,r=l+1;return n.set(e,r),r}for(let s of e)s.depth=o(s.name);if(t){let c=Math.max(...e.map(e=>e.depth));for(let d of e)d.depth=c-d.depth}return e}sortEntitiesByDepth(e,t=!1){if(t){let a=Math.max(...e.map(e=>e.depth));for(let i of e)i.depth=a-i.depth}return[...e].sort((e,t)=>e.depth-t.depth)}parseDateTime(e,t="ymd"){if(e instanceof Date&&!isNaN(e.getTime()))return e;if("number"==typeof e){let a=new Date(Date.UTC(1899,11,30)),i=new Date(a.getTime()+864e5*(e>60?e-1:e));return isNaN(i.getTime())?null:i}if("string"!=typeof e)return null;let l=e.trim(),r=new Date(l);if(!isNaN(r.getTime()))return r;let n={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11,january:0,february:1,march:2,april:3,june:5,july:6,august:7,september:8,october:9,november:10,december:11},o=l.match(/^(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})(?:[,\s]+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$|^([A-Za-z]+)\s+(\d{1,2}),?\s+(\d{4})(?:[,\s]+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);if(o){let s,c,d,u,m,h;if(o[1]?(s=parseInt(o[1],10),c=n[o[2].toLowerCase()],d=parseInt(o[3],10),u=parseInt(o[4]||"0",10),m=parseInt(o[5]||"0",10),h=parseInt(o[6]||"0",10)):(s=parseInt(o[8],10),c=n[o[7].toLowerCase()],d=parseInt(o[9],10),u=parseInt(o[10]||"0",10),m=parseInt(o[11]||"0",10),h=parseInt(o[12]||"0",10)),void 0!==c&&!isNaN(s)&&!isNaN(d)){let p=new Date(d,c,s,u,m,h||0);if(p.getDate()===s&&p.getMonth()===c)return p}}let y=l.match(/^(\d{1,4})[\/\-](\d{1,2})[\/\-](\d{1,4})(?:[\sT](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);if(y){let g,f,b,E=parseInt(y[1],10),v=parseInt(y[2],10),S=parseInt(y[3],10),w=parseInt(y[4]||"0",10),C=parseInt(y[5]||"0",10),D=parseInt(y[6]||"0",10);switch(t){case"dmy":b=E,f=v,g=S;break;case"mdy":f=E,b=v,g=S;break;default:g=E,f=v,b=S}let T=new Date(g,f-1,b,w,C,D);if(!isNaN(T.getTime())&&T.getFullYear()===g&&T.getMonth()===f-1&&T.getDate()===b)return T}return null}formatDateTimeForMySQL(e,t="datetime"){if(!(e instanceof Date)||isNaN(e))return"";let a=e=>e.toString().padStart(2,"0"),i=e.getFullYear(),l=a(e.getMonth()+1),r=a(e.getDate()),n=a(e.getHours()),o=a(e.getMinutes()),s=a(e.getSeconds());switch(t){case"date":return`${i}-${l}-${r}`;case"time":return`${n}:${o}:${s}`;default:return`${i}-${l}-${r} ${n}:${o}:${s}`}}fixDateTime(e,t="ymd",a="datetime"){let i=this,l=document.querySelector(".data-preview-table tbody").querySelectorAll(`[data-col="${e}"]`);l&&l.length>0&&l.forEach(e=>{let l=i.parseDateTime(e.value,t);null!=l&&(e.value=i.formatDateTimeForMySQL(l,a))})}}let tabDragger=null;