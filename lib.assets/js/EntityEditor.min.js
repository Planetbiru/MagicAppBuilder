class Column{constructor(e,t="VARCHAR",l="",i=!1,n="",s=!1,a=!1,r=""){this.name=e,this.type=t,this.length=l,this.nullable=i,this.default=n,this.primaryKey=s,this.autoIncrement=a,this.values=r}toSQL(){let e=`${this.name} ${this.type}`;if(["ENUM","SET"].includes(this.type)&&this.values){let t=this.values.split(",").map(e=>`'${e.trim()}'`).join(", ");e=`${this.name} ${this.type}(${t})`}else if(["NUMERIC","DECIMAL","DOUBLE","FLOAT"].includes(this.type)&&this.values){let l=this.values.split(",").map(e=>`${e.trim()}`).join(", ");e=`${this.name} ${this.type}(${l})`}else this.length&&["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"].includes(this.type)&&(e+=`(${this.length})`);return this.nullable&&!this.primaryKey?e+=" NULL":e+=" NOT NULL",this.primaryKey&&(e+=" PRIMARY KEY"),this.autoIncrement&&(e+=" AUTO_INCREMENT"),this.default&&"null"!==this.default.toLowerCase()&&(["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT","NUMERIC","DECIMAL","DOUBLE","FLOAT"].includes(this.type)&&!isNaN(this.default)?e+=` DEFAULT ${this.default}`:e+=` DEFAULT '${this.default}'`),e}}class Entity{constructor(e){this.name=e,this.columns=[]}addColumn(e){this.columns.push(e)}removeColumn(e){this.columns.splice(e,1)}toSQL(){let e=`-- Entity: ${this.name}\r
`;return e+=`CREATE TABLE IF NOT EXISTS ${this.name} (\r
`,this.columns.forEach(t=>{e+=`	${t.toSQL()},\r
`}),e=e.slice(0,-3),e+="\r\n);\r\n\r\n"}}class EntityEditor{constructor(e,t={}){this.setting={defaultDataType:"VARCHAR",defaultDataLength:"48",primaryKeyDataType:"VARCHAR",primaryKeyDataLength:"40"},Object.assign(this.setting,t),this.selector=e,this.entities=[],this.currentEntityIndex=-1,this.mysqlDataTypes=["BIGINT","INT","MEDIUMINT","SMALLINT","TINYINT","NUMERIC","DECIMAL","DOUBLE","FLOAT","BIT","DATE","TIME","DATETIME","TIMESTAMP","YEAR","LONGTEXT","MEDIUMTEXT","TEXT","TINYTEXT","VARCHAR","CHAR","ENUM","SET","LONGBLOB","MEDIUMBLOB","BLOB","TINYBLOB","UUID","VARBINARY","BINARY","POLYGON","LINESTRING","POINT","GEOMETRY","JSON",],this.withLengthTypes=["VARCHAR","CHAR","VARBINARY","BINARY","TINYINT","SMALLINT","MEDIUMINT","INT","INTEGER","BIGINT","BIT"],this.withValueTypes=["ENUM","SET"],this.withRangeTypes=["NUMERIC","DECIMAL","DOUBLE","FLOAT"],this.addDomListeners(),this.callbackLoadEntity=this.setting.callbackLoadEntity,this.callbackSaveEntity=this.setting.callbackSaveEntity,this.defaultDataType=this.setting.defaultDataType+"",this.defaultDataLength=this.setting.defaultDataLength+"",this.primaryKeyDataType=this.setting.primaryKeyDataType+"",this.primaryKeyDataLength=this.setting.primaryKeyDataLength+"","function"==typeof this.callbackLoadEntity&&this.callbackLoadEntity()}addDomListeners(){document.querySelector(this.selector+" .check-all-entity").addEventListener("change",e=>{let t=e.target.checked,l=document.querySelectorAll(this.selector+" .selected-entity");l&&l.forEach((e,l)=>{e.checked=t}),this.exportToSQL()}),document.querySelector(this.selector+" .table-list").addEventListener("change",e=>{e.target.classList.contains("selected-entity")&&this.exportToSQL()});let e=this;document.addEventListener("change",function(t){if(t.target.classList.contains("column-primary-key")){let l=t.target.checked;if(l){let i=t.target.closest("tr");i.querySelector(".column-type").value=e.primaryKeyDataType,e.updateColumnLengthInput(i.querySelector(".column-type")),i.querySelector(".column-length").value=e.primaryKeyDataLength}}}),document.querySelector(this.selector+" .import-file").addEventListener("change",function(){let e=this.files[0];e?editor.importJSON(e,function(e){let t=document.querySelector('meta[name="application-id"]').getAttribute("content"),l=document.querySelector('meta[name="database-name"]').getAttribute("content"),i=document.querySelector('meta[name="database-schema"]').getAttribute("content");sendToServer(t,document.querySelector('meta[name="database-type"]').getAttribute("content"),l,i,e)}):console.log("Please select a JSON file first.")})}showEditor(e=-1){if(e>=0){this.currentEntityIndex=e;let t=this.entities[e];document.querySelector(this.selector+" .entity-name").value=t.name,document.querySelector(this.selector+" .columns-table-body").innerHTML="",t.columns.forEach(e=>this.addColumnToTable(e))}else{this.currentEntityIndex=-1;let l="new_table";for(let i in this.entities){let n=!1;for(let s in this.entities)(l=`new_table_${parseInt(i)+2}`).toLowerCase()==this.entities[s].name.toLowerCase()&&(n=!0);if(!n)break}document.querySelector(this.selector+" .entity-name").value=l,document.querySelector(this.selector+" .columns-table-body").innerHTML=""}document.querySelector(this.selector+" .button-container").style.display="none",document.querySelector(this.selector+" .editor-form").style.display="block",-1==e&&document.querySelector(this.selector+" .entity-name").select()}addColumnToTable(e,t=!1){let l=document.querySelector(this.selector+" .columns-table-body"),i=document.createElement("tr"),n=null==e.length?"":e.length.replace(/\D/g,""),s=null==e.default?"":e.default,a=e.type.split("(")[0].trim();i.innerHTML=`
            <td class="column-action">
                <button onclick="editor.removeColumn(this)">❌</button>
                <button onclick="editor.moveUp(this)">⬆️</button>
                <button onclick="editor.moveDown(this)">⬇️</button>    
            </td>
            <td><input type="text" class="column-name" value="${e.name}" placeholder="Column Name"></td>
            <td>
                <select class="column-type" onchange="editor.updateColumnLengthInput(this)">
                    ${this.mysqlDataTypes.map(e=>`<option value="${e}" ${e===a?"selected":""}>${e}</option>`).join("")}
                </select>
            </td>
            <td><input type="text" class="column-length" value="${n}" placeholder="Length" style="display: ${this.withLengthTypes.includes(a)?"inline":"none"};"></td>
            <td><input type="text" class="column-enum" value="${e.values}" placeholder="Values (comma separated)" style="display: ${this.withValueTypes.includes(a)||this.withRangeTypes.includes(a)?"inline":"none"};"></td>
            <td><input type="text" class="column-default" value="${s}" placeholder="Default Value"></td>
            <td class="column-nl"><input type="checkbox" class="column-nullable" ${e.nullable?"checked":""}></td>
            <td class="column-pk"><input type="checkbox" class="column-primary-key" ${e.primaryKey?"checked":""}></td>
            <td class="column-ai"><input type="checkbox" class="column-autoIncrement" ${e.autoIncrement?"checked":""}></td>
        `,l.appendChild(i),t&&i.querySelector(".column-name").select()}addColumn(e=!1){let t=document.querySelector(this.selector+" .entity-name").value,l=document.querySelectorAll(this.selector+" .column-name").length,i=0==l?`${t}_id`:`${t}_col${l<=0?"":l+1}`,n=new Column(i,this.defaultDataType,this.defaultDataLength);this.addColumnToTable(n,e)}removeColumn(e){let t=e.closest("tr");t.remove()}moveUp(e){let t=e.closest("tr"),l=document.querySelector(this.selector+" .columns-table-body"),i=t.previousElementSibling;i&&l.insertBefore(t,i)}moveDown(e){let t=e.closest("tr"),l=document.querySelector(this.selector+" .columns-table-body"),i=t.nextElementSibling;i&&l.insertBefore(i,t)}saveEntity(){let e=document.querySelector(this.selector+" .entity-name").value,t=[],l=document.querySelectorAll(this.selector+" .column-name"),i=document.querySelectorAll(this.selector+" .column-type"),n=document.querySelectorAll(this.selector+" .column-nullable"),s=document.querySelectorAll(this.selector+" .column-default"),a=document.querySelectorAll(this.selector+" .column-primary-key"),r=document.querySelectorAll(this.selector+" .column-autoIncrement"),c=document.querySelectorAll(this.selector+" .column-length"),o=document.querySelectorAll(this.selector+" .column-enum");for(let u=0;u<l.length;u++){let h=new Column(l[u].value,i[u].value,c[u].value||null,n[u].checked,s[u].value||null,a[u].checked,r[u].checked,o[u].value||null);t.push(h)}if(this.currentEntityIndex>=0)this.entities[this.currentEntityIndex].name=e,this.entities[this.currentEntityIndex].columns=t;else{let y=new Entity(e);t.forEach(e=>y.addColumn(e)),this.entities.push(y)}this.renderEntities(),this.cancelEdit(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}createEntitiesFromJSON(e){let t=[];return e.forEach(e=>{let l=new Entity(e.name);e.columns.forEach(e=>{let t=new Column(e.name,e.type,e.length,e.nullable,e.default,e.primaryKey,e.autoIncrement,"null"!==e.values?e.values:"");l.addColumn(t)}),t.push(l)}),t}renderEntities(){let e=document.querySelector(this.selector+" .entities-container");e.innerHTML="";let t=[],l=document.querySelectorAll(this.selector+" .selected-entity:checked");l&&l.forEach(e=>{t.push(e.getAttribute("data-name"))});let i=document.querySelector(this.selector+" .table-list");i.innerHTML="";let n=this.withLengthTypes;this.entities.forEach((t,l)=>{let s=document.createElement("div");s.classList.add("entity");let a=t.columns.map(e=>n.includes(e.type)&&e.length>0?`<li data-primary-key="${e.primaryKey?"true":"false"}">${e.name} <span class="data-type">${e.type}(${e.length})</span></li>`:`<li data-primary-key="${e.primaryKey?"true":"false"}">${e.name} <span class="data-type">${e.type}</span></li>`).join("");s.innerHTML=`
                <div class="entity-header">
                    <button onclick="editor.deleteEntity(${l})">❌</button>
                    <button onclick="editor.editEntity(${l})">✏️</button>
                    <h4>${t.name}</h4>
                </div>
                <div class="entity-body">
                    <ul>${a}</ul>
                </div>
            `,e.appendChild(s);let r=document.createElement("li");r.innerHTML=`
            <label><input type="checkbox" class="selected-entity" data-name="${t.name}" value="${l}" />${t.name}</label>
            `,i.appendChild(r)}),t.forEach(e=>{let t=document.querySelector(`input[data-name="${e}"]`);t&&(t.checked=!0)})}editEntity(e){this.currentEntityIndex=e,this.showEditor(e)}deleteEntity(e){this.entities.splice(e,1),this.renderEntities(),this.exportToSQL(),"function"==typeof this.callbackSaveEntity&&this.callbackSaveEntity(this.entities)}cancelEdit(){document.querySelector(this.selector+" .editor-form").style.display="none",document.querySelector(this.selector+" .button-container").style.display="block"}updateColumnLengthInput(e){let t=e.closest("tr"),l=e.value,i=t.querySelector(".column-length"),n=t.querySelector(".column-enum");this.withLengthTypes.includes(l)?i.style.display="inline":i.style.display="none",this.withValueTypes.includes(l)||this.withRangeTypes.includes(l)?n.style.display="inline":n.style.display="none"}exportToSQL(){let e=[],t=document.querySelectorAll(this.selector+" .selected-entity:checked");t.forEach((t,l)=>{let i=parseInt(t.value),n=this.entities[i];n&&e.push(n.toSQL())}),document.querySelector(this.selector+" .query-generated").value=e.join("\r\n")}exportJSON(e){let t=`${e.databaseName}-${e.databaseSchema}`,l=new Date,i=l.toISOString().replace(/[-T:\.Z]/g,"_");i.endsWith("_")&&(i=i.slice(0,-1));let n=`${t}_${i}.json`,s=JSON.stringify(e),a=new Blob([s],{type:"application/json"}),r=URL.createObjectURL(a),c=document.createElement("a");c.href=r,c.download=n,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)}importJSON(e,t){let l=this,i=new FileReader;i.onload=function(e){let i=e.target.result;try{let n=JSON.parse(i);l.entities=editor.createEntitiesFromJSON(n.entities),l.renderEntities(),"function"==typeof t&&t(l.entities)}catch(s){console.log("Error parsing JSON: "+s.message)}},i.readAsText(e)}importEntities(){document.querySelector(this.selector+" .import-file").click()}exportEntities(){let e=document.querySelector('meta[name="application-id"]').getAttribute("content"),t=document.querySelector('meta[name="database-name"]').getAttribute("content"),l=document.querySelector('meta[name="database-schema"]').getAttribute("content"),i=document.querySelector('meta[name="database-type"]').getAttribute("content"),n={applicationId:e,databaseType:i,databaseName:t,databaseSchema:l,entities:this.entities};this.exportJSON(n)}}