let selectedItem=null,contentModified=!0,currentMode=null;function initFileManager(){document.getElementById("dir-tree").addEventListener("click",function(e){if(e.target){if(e.target.classList.contains("dir")){let t=e.target.dataset.dir,n=e.target.closest("li"),i=n.querySelector("ul");i?n.setAttribute("data-open","true"===n.getAttribute("data-open")?"false":"true"):(i=document.createElement("ul"),n.appendChild(i),loadDirContent(t,i,n),n.setAttribute("data-open","true"))}else if(e.target.classList.contains("file")){let a=e.target;openFile(a.dataset.file,a.dataset.extension)}}}),document.querySelector(".btn-save-file").addEventListener("click",function(e){let t;saveFile(document.querySelector(".file-path").value,fileManagerEditor.getValue())}),document.querySelector(".btn-open-file").addEventListener("click",function(e){let t=document.querySelector(".file-path").value,n=getFileExtension(t);openTextFile(t,n)});let e=document.getElementById("dir-tree"),t=document.getElementById("context-menu");e.addEventListener("contextmenu",function(e){e.preventDefault();let n=e.target.closest("li");if(n&&n.dataset&&n.dataset.type){selectedItem=e.target;let i="",a=n.dataset.type;"file"===a?i=n.querySelector("span").dataset.file:"dir"===a&&(i=n.querySelector("span").dataset.dir);let l=e.pageX,o=e.pageY;t.className="context-menu";let r=t.querySelector("ul");r.innerHTML="","file"===a?(r.innerHTML=`
              <li data-type="file" data-operation="open" data-file="${i}">Open File</li>
              <li data-type="file" data-operation="rename" data-file="${i}">Rename File</li>
              <li data-type="file" data-operation="download" data-file="${i}">Download File</li>
              <li data-type="file" data-operation="delete" data-file="${i}">Delete File</li>
              `,o+t.offsetHeight>window.innerHeight&&(o=window.innerHeight-t.offsetHeight-10),t.style.left=`${l}px`,t.style.top=`${o}px`,t.style.display="block"):"dir"===a?(r.innerHTML=`
              <li data-type="dir" data-operation="new-file" data-dir="${i}">Create New File</li>
              <li data-type="dir" data-operation="new-dir" data-dir="${i}">Create New Directory</li>
              <li data-type="dir" data-operation="upload-file" data-dir="${i}">Upload Files</li>
              <li data-type="dir" data-operation="open" data-dir="${i}">Expand Directory</li>
              <li data-type="dir" data-operation="refresh-dir" data-dir="${i}">Reload Directory</li>
              <li data-type="dir" data-operation="rename" data-dir="${i}">Rename Directory</li>
              <li data-type="dir" data-operation="compress" data-dir="${i}">Download Directory</li>
              <li data-type="dir" data-operation="delete" data-dir="${i}">Delete Directory</li>
              `,o+t.offsetHeight>window.innerHeight&&(o=window.innerHeight-t.offsetHeight-10),t.style.left=`${l}px`,t.style.top=`${o}px`,t.style.display="block"):(showRootContextMenu(e,t),e.preventDefault(),e.stopPropagation())}else showRootContextMenu(e,t),e.preventDefault(),e.stopPropagation()}),document.querySelector(".root-directory").addEventListener("contextmenu",function(e){showRootContextMenu(e,t),e.stopPropagation(),e.preventDefault()}),document.addEventListener("click",function(){t.style.display="none"}),t.addEventListener("click",function(e){let n=e.target.closest("li");if(null!=n){let i=n.dataset.operation;if(i){let a="",l=n.dataset.type;switch("file"===l?a=n.dataset.file:"dir"===l&&(a=n.dataset.dir),i){case"root-new-file":createNewFile("");break;case"reset":resetFileManager();break;case"root-dowload":downloadFile("","dir");break;case"new-file":createNewFile(a);break;case"upload-file":uploadFile(a);break;case"new-dir":createNewDirectory(a);break;case"root-new-dir":createNewDirectory("");break;case"open":selectedItem.click();break;case"refresh-dir":refreshDirectory(a);break;case"rename":renameFile(a,l);break;case"download":downloadFile(a,l);break;case"delete":deleteFile(a,l);break;case"compress":compressDirectory(a)}t.style.display="none"}}}),document.querySelector(".file-path").addEventListener("change",function(e){let t=e.target.value,n=getFileExtension(t);n&&changeMode(t,n)}),initCodeMirror(),fileManagerEditor.refresh()}function showRootContextMenu(e,t){e.preventDefault(),selectedItem=null;let n=e.pageX,i=e.pageY;t.className="context-menu";let a=t.querySelector("ul");a.innerHTML=`
    <li data-type="dir" data-operation="root-new-file" data-dir="">Create New File</li>
    <li data-type="dir" data-operation="root-new-dir" data-dir="">Create New Directory</li>
    <li data-type="dir" data-operation="upload-file" data-dir="">Upload Files</li>
    <li data-type="dir" data-operation="reset" data-dir="">Reset Content</li>
    <li data-type="dir" data-operation="root-dowload" data-dir="">Download All</li>
    `,i+t.offsetHeight>window.innerHeight&&(i=window.innerHeight-t.offsetHeight-10),t.style.left=`${n}px`,t.style.top=`${i}px`,t.style.display="block"}function uploadFile(e){let t=document.createElement("input");t.type="file",t.accept="*",t.multiple=!0,t.style.display="none",t.addEventListener("change",function(t){let n=t.target.files;if(n){let i=new FormData;for(let a=0;a<n.length;a++)i.append("files[]",n[a]);i.append("dir",e),increaseAjaxPending(),fetch("lib.ajax/file-manager-upload.php",{method:"POST",body:i}).then(e=>e.json()).then(e=>{if(decreaseAjaxPending(),"success"==e.status){if(null!=selectedItem){let t=selectedItem.closest("li"),n=t.querySelector("ul");null==n&&(n=document.createElement("ul"),t.appendChild(n)),null!=t&&(displayDirContent(e.dirs,n,!0),t.setAttribute("data-open","true"))}else resetFileManager()}else console.error("Error uploading file:",e.error)}).catch(e=>{decreaseAjaxPending(),console.error("Error uploading file:",e)})}}),t.click()}function createNewFile(e){let t=""!==e?e+"/new-file.txt":"new-file.txt";document.querySelector(".file-path").value=t,document.querySelector(".btn-save-file").disabled=!1,fileManagerEditor.setValue(""),changeMode(t,"txt"),setDisplayMode("text"),fileManagerEditor.focus()}function createNewDirectory(e){let t="new-directory";""!=e&&(t=e+"/"+t),asyncPrompt("Enter new directory name","Create Directory",[{caption:"OK",fn:function(e){let t=null,n=null,i="/";null!=selectedItem&&(t=selectedItem.closest("li"),n=selectedItem.closest("li").querySelector("ul"),i=t?t.querySelector("span").dataset.dir:"/"),increaseAjaxPending(),fetch("lib.ajax/file-manager-create-directory.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,type:"dir",dir:i})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=t&&t.removeAttribute("data-loading"),e.dirs?null!=t&&null!=n?displayDirContent(e.dirs,n,!0):resetFileManager():"/"==i?resetFileManager():loadDirContent(i,n,t,!0)}).catch(e=>{decreaseAjaxPending(),null!=t&&t.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"Cancel",fn:function(){},class:"btn-secondary"}],t,function(){})}function renameFile(e,t){asyncPrompt("Enter new name for "+e,"Rename",[{caption:"OK",fn:function(n){let i=selectedItem.closest("ul").closest("li"),a=selectedItem.closest("ul"),l=i?i.querySelector("span").dataset.dir:"/";increaseAjaxPending(),fetch("lib.ajax/file-manager-rename.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,newName:n,type:t})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=i&&i.removeAttribute("data-loading"),e.dirs?displayDirContent(e.dirs,a,!0):"/"==l?resetFileManager():loadDirContent(l,a,i,!0)}).catch(e=>{decreaseAjaxPending(),null!=i&&i.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"Cancel",fn:function(){},class:"btn-secondary"}],e,function(e){})}function downloadFile(e,t){let n=`lib.ajax/file-manager-download.php?name=${encodeURIComponent(e)}&type=${encodeURIComponent(t)}`,i=document.createElement("a");i.href=n,i.download=e,i.click()}function deleteFile(e,t){asyncAlert("Do you want to delete "+e+"?","Confirmation",[{caption:"Yes",fn(){let n=selectedItem.closest("li");increaseAjaxPending(),fetch("lib.ajax/file-manager-delete.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,type:t})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=n&&n.parentNode.removeChild(n)}).catch(e=>{decreaseAjaxPending(),null!=n&&n.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"No",fn(){},class:"btn-secondary"}])}function compressDirectory(e){asyncAlert("Do you want to compress "+e+"?","Confirmation",[{caption:"Yes",fn(){let t=`lib.ajax/file-manager-download.php?name=${encodeURIComponent(e)}&type=dir`,n=document.createElement("a");n.href=t,n.download=e,n.click()},class:"btn-primary"},{caption:"No",fn(){},class:"btn-secondary"}])}function getCaller(){try{throw Error()}catch(e){let t=e.stack.split("\n");if(t.length>2){let n=t[2],i=n.match(/at (\w+)/);return i?i[1]:"Unknown"}return"Unknown"}}function resetFileManager(){let e=document.querySelector("#dir-tree");fileManagerEditor&&fileManagerEditor.setValue(""),document.querySelector(".btn-save-file").disabled=!0,document.querySelector("#dir-tree").innerHTML="",document.querySelector(".file-path").value="",loadDirContent("",e,null,!0)}function getFileExtension(e){let t=/\.(\w+)$/.exec(e);return t?t[1]:""}function format(){let e=fileManagerEditor.lineCount();fileManagerEditor.autoFormatRange({line:0,ch:0},{line:e})}function refreshDirectory(e){let t=selectedItem.closest("li"),n=t.querySelector("ul");null==n&&(n=document.createElement("ul"),t.appendChild(n)),loadDirContent(e,n,t,!0),null!=t&&t.setAttribute("data-open","true")}function loadDirContent(e,t,n,i){null!=n&&n.setAttribute("data-loading","true"),increaseAjaxPending(),$.ajax({url:"lib.ajax/file-manager-load-dir.php",method:"GET",data:{dir:e},dataType:"json",success:function(e){decreaseAjaxPending(),null!=n&&n.removeAttribute("data-loading"),displayDirContent(e,t,i)},error:function(e,t,i){decreaseAjaxPending(),null!=n&&n.removeAttribute("data-loading"),console.error("AJAX Error:",t,i)}})}function displayDirContent(e,t,n){t.innerHTML="",e.forEach(function(e){if("dir"===e.type){let n=document.createElement("li");n.dataset.type=e.type;let i=document.createElement("span");i.textContent=e.name,i.dataset.dir=e.path,i.classList.add("dir"),n.appendChild(i),t.appendChild(n)}else if("file"===e.type){let a=document.createElement("li");a.dataset.type=e.type;let l=document.createElement("span");l.textContent=e.name,l.dataset.file=e.path,l.dataset.extension=e.extension,l.classList.add("file"),a.appendChild(l),t.appendChild(a)}})}function getDirectoryName(e){if("string"!=typeof e||""===e.trim())return console.warn("Invalid path provided"),"";e=e.trim().replace(/\/+$/,"");let t=e.lastIndexOf("/");return t<=0?"":e.substring(0,t).replace(/^\/+/,"")}function saveFile(e,t){let n=new FormData;n.append("file",e),n.append("content",t),increaseAjaxPending(),fetch("lib.ajax/file-manager-save-file.php",{method:"POST",body:n}).then(e=>e.json()).then(e=>{decreaseAjaxPending();let t=null,n=null,i=getDirectoryName(document.querySelector(".file-path").value);if(i.length>0){let a=`span[data-dir="${i}"]`;n=document.querySelector(a).closest("li")}null!=selectedItem?(n=selectedItem.closest("li"),null==(t=selectedItem.closest("li").querySelector("ul"))&&(t=document.createElement("ul"),n.appendChild(t)),e.dirs)?(n.removeAttribute("data-loading"),displayDirContent(e.dirs,t,!0),null!=n&&n.setAttribute("data-open","true")):loadDirContent("",document.querySelector("#dir-tree"),null,!0):null!=n&&e.dirs?(n.removeAttribute("data-loading"),displayDirContent(e.dirs,t,!0),null!=n&&n.setAttribute("data-open","true")):loadDirContent("",document.querySelector("#dir-tree"),null,!0)}).catch(e=>{decreaseAjaxPending()})}function openFile(e,t){t||(t=getFileExtension(e)),["jpg","jpeg","png","gif","webp","bmp","svg","ico","mp4","mp3","avi","exe","pdf"].includes(t.toLowerCase())?["jpg","jpeg","png","gif","webp","bmp","svg","ico"].includes(t.toLowerCase())?(setDisplayMode("image"),increaseAjaxPending(),fetch("lib.ajax/file-manager-load-image.php?file="+encodeURIComponent(e)).then(e=>e.text()).then(e=>{let t=document.querySelector(".media-display"),n=document.createElement("img");n.src=e,n.style.maxWidth="100%",n.style.maxHeight="400px",t.innerHTML="",t.appendChild(n),decreaseAjaxPending()}).catch(e=>{decreaseAjaxPending()})):fileDiv.textContent="Cannot open this file.":(null===currentMode&&changeMode(e,t),openTextFile(e,t))}function openTextFile(e,t){document.querySelector(".btn-open-file").disabled=!0,document.querySelector(".btn-save-file").disabled=!0,setDisplayMode("text"),document.querySelector(".file-path").value=e,fileManagerEditor.setValue("Loading..."),changeMode("any.txt","txt"),increaseAjaxPending(),fetch("lib.ajax/file-manager-load-file.php?file="+encodeURIComponent(e)).then(e=>e.text()).then(n=>{changeMode(e,t),fileManagerEditor.setValue(n),document.querySelector(".btn-open-file").disabled=!1,document.querySelector(".btn-save-file").disabled=!1,decreaseAjaxPending()}).catch(e=>{document.querySelector(".btn-open-file").disabled=!1,document.querySelector(".btn-save-file").disabled=!1,setDisplayMode(""),decreaseAjaxPending()})}function setDisplayMode(e){"text"===e?(document.querySelector(".image-mode").style.display="none",document.querySelector(".text-mode").style.display="block"):"image"===e&&(document.querySelector(".text-mode").style.display="none",document.querySelector(".image-mode").style.display="block")}function changeMode(e,t){currentMode=t;let n=e,i,a,l=/.+\.([^.]+)$/.exec(n);if(l){let o=CodeMirror.findModeByExtension(l[1]);o&&(i=o.mode,a=o.mime)}else if(/\//.test(n)){let r=CodeMirror.findModeByMIME(n);r&&(i=r.mode,a=n)}else i=a=n;i&&(fileManagerEditor.setOption("mode",a),CodeMirror.autoLoadMode(fileManagerEditor,i))}const editorModeMap={yaml:{mode:"text/x-yaml",indentUnit:2},yml:{mode:"text/x-yaml",indentUnit:2},js:{mode:"text/javascript",indentUnit:2},json:{mode:"application/json",indentUnit:2},css:{mode:"text/css",indentUnit:2},xml:{mode:"application/xml",indentUnit:2},html:{mode:"text/html",indentUnit:2},htm:{mode:"text/html",indentUnit:2},md:{mode:"text/x-markdown",indentUnit:2},markdown:{mode:"text/x-markdown",indentUnit:2},ts:{mode:"text/typescript",indentUnit:2},tsx:{mode:"text/typescript",indentUnit:2},jsx:{mode:"text/jsx",indentUnit:2},vue:{mode:"text/x-vue",indentUnit:2},rb:{mode:"text/x-ruby",indentUnit:2},sh:{mode:"text/x-sh",indentUnit:2},conf:{mode:"text/x-properties",indentUnit:2},cfg:{mode:"text/x-properties",indentUnit:2},properties:{mode:"text/x-properties",indentUnit:2},ini:{mode:"text/x-properties",indentUnit:2},env:{mode:"text/x-properties",indentUnit:2},php:{mode:"application/x-httpd-php",indentUnit:4},py:{mode:"text/x-python",indentUnit:4},java:{mode:"text/x-java",indentUnit:4},c:{mode:"text/x-csrc",indentUnit:4},cpp:{mode:"text/x-csrc",indentUnit:4},h:{mode:"text/x-csrc",indentUnit:4},go:{mode:"text/x-go",indentUnit:4},sql:{mode:"text/x-sql",indentUnit:4},log:{mode:"text/plain",indentUnit:2},txt:{mode:"text/plain",indentUnit:2},csv:{mode:"text/plain",indentUnit:2}};function initCodeMirror(){if("undefined"==typeof CodeMirror){console.error("CodeMirror library not found. Please ensure codemirror.js is loaded.");return}modeInput=document.getElementById("filename"),CodeMirror.modeURL="lib.assets/cm/mode/%N/%N.js",fileManagerEditor=CodeMirror.fromTextArea(document.getElementById("code"),{lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,indentUnit:4,indentWithTabs:!1}),window.setEditorModeByFilename=function(e){let t="text/plain",n=2,i=!1,a=e.lastIndexOf("."),l=a>-1?e.substring(a+1).toLowerCase():"",o=editorModeMap[l];if(o)t=o.mode,n=o.indentUnit,void 0!==o.indentWithTabs&&(i=o.indentWithTabs);else if(l){let r=CodeMirror.findModeByExtension(l);r&&(t=r.mime)}fileManagerEditor.setOption("mode",t),fileManagerEditor.setOption("indentWithTabs",i),fileManagerEditor.setOption("indentUnit",n);let d=CodeMirror.findModeByMIME(t)?.mode||t;CodeMirror.autoLoadMode(fileManagerEditor,d),console.log(`Editor mode set to: ${t} for file: ${e} (Indent: ${n} spaces, Tabs: ${i?"Yes":"No"})`)},window.addEventListener("resize",function(e){let t=document.querySelector("#file-content").offsetWidth-16,n=document.innerHeight-160;fileManagerEditor.setSize(t,n)});let e=document.querySelector("#file-content").offsetWidth-16,t=document.innerHeight-160;fileManagerEditor.setSize(e,t)}