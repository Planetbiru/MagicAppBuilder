let selectedItem=null,contentModified=!0,currentMode=null;function initFileManager(){document.getElementById("dir-tree").addEventListener("click",function(e){if(e.target){if(e.target.classList.contains("dir")){let t=e.target.dataset.dir,a=e.target.closest("li"),l=a.querySelector("ul");l?a.setAttribute("data-open","true"===a.getAttribute("data-open")?"false":"true"):(l=document.createElement("ul"),a.appendChild(l),loadDirContent(t,l,a),a.setAttribute("data-open","true"))}else if(e.target.classList.contains("file")){let n=e.target;openFile(n.dataset.file,n.dataset.extension)}}}),document.querySelector(".btn-save-file").addEventListener("click",function(e){let t;saveFile(document.querySelector(".file-path").value,fileManagerEditor.getValue())}),document.querySelector(".btn-open-file").addEventListener("click",function(e){let t=document.querySelector(".file-path").value,a=getFileExtension(t);openTextFile(t,a)});let e=document.getElementById("dir-tree"),t=document.getElementById("context-menu");e.addEventListener("contextmenu",function(e){e.preventDefault();let a=e.target.closest("li");if(a&&a.dataset&&a.dataset.type){selectedItem=e.target;let l="",n=a.dataset.type;"file"===n?l=a.querySelector("span").dataset.file:"dir"===n&&(l=a.querySelector("span").dataset.dir);let i=e.pageX,r=e.pageY;t.className="context-menu";let o=t.querySelector("ul");o.innerHTML="","file"===n?(o.innerHTML=`
              <li data-type="file" data-operation="open" data-file="${l}">Open File</li>
              <li data-type="file" data-operation="rename" data-file="${l}">Rename File</li>
              <li data-type="file" data-operation="download" data-file="${l}">Download File</li>
              <li data-type="file" data-operation="delete" data-file="${l}">Delete File</li>
              `,r+t.offsetHeight>window.innerHeight&&(r=window.innerHeight-t.offsetHeight-10),t.style.left=`${i}px`,t.style.top=`${r}px`,t.style.display="block"):"dir"===n?(o.innerHTML=`
              <li data-type="dir" data-operation="new-file" data-dir="${l}">Create New File</li>
              <li data-type="dir" data-operation="new-dir" data-dir="${l}">Create New Directory</li>
              <li data-type="dir" data-operation="upload-file" data-dir="${l}">Upload Files</li>
              <li data-type="dir" data-operation="open" data-dir="${l}">Expand Directory</li>
              <li data-type="dir" data-operation="refresh-dir" data-dir="${l}">Reload Directory</li>
              <li data-type="dir" data-operation="rename" data-dir="${l}">Rename Directory</li>
              <li data-type="dir" data-operation="compress" data-dir="${l}">Download Directory</li>
              <li data-type="dir" data-operation="delete" data-dir="${l}">Delete Directory</li>
              `,r+t.offsetHeight>window.innerHeight&&(r=window.innerHeight-t.offsetHeight-10),t.style.left=`${i}px`,t.style.top=`${r}px`,t.style.display="block"):(showRootContextMenu(e,t),e.preventDefault(),e.stopPropagation())}else showRootContextMenu(e,t),e.preventDefault(),e.stopPropagation()}),document.querySelector(".root-directory").addEventListener("contextmenu",function(e){showRootContextMenu(e,t),e.stopPropagation(),e.preventDefault()}),document.addEventListener("click",function(){t.style.display="none"}),t.addEventListener("click",function(e){let a=e.target.closest("li");if(null!=a){let l=a.dataset.operation;if(l){let n="",i=a.dataset.type;switch("file"===i?n=a.dataset.file:"dir"===i&&(n=a.dataset.dir),l){case"root-new-file":createNewFile("");break;case"reset":resetFileManager();break;case"root-dowload":downloadFile("","dir");break;case"new-file":createNewFile(n);break;case"upload-file":uploadFile(n);break;case"new-dir":createNewDirectory(n);break;case"root-new-dir":createNewDirectory("");break;case"open":selectedItem.click();break;case"refresh-dir":refreshDirectory(n);break;case"rename":renameFile(n,i);break;case"download":downloadFile(n,i);break;case"delete":deleteFile(n,i);break;case"compress":compressDirectory(n)}t.style.display="none"}}}),document.querySelector(".file-path").addEventListener("change",function(e){let t=e.target.value,a=getFileExtension(t);a&&changeMode(t,a)}),initCodeMirror(),fileManagerEditor.refresh()}function showRootContextMenu(e,t){e.preventDefault(),selectedItem=null;let a=e.pageX,l=e.pageY;t.className="context-menu";let n=t.querySelector("ul");n.innerHTML=`
    <li data-type="dir" data-operation="root-new-file" data-dir="">Create New File</li>
    <li data-type="dir" data-operation="root-new-dir" data-dir="">Create New Directory</li>
    <li data-type="dir" data-operation="upload-file" data-dir="">Upload Files</li>
    <li data-type="dir" data-operation="reset" data-dir="">Reset Content</li>
    <li data-type="dir" data-operation="root-dowload" data-dir="">Download All</li>
    `,l+t.offsetHeight>window.innerHeight&&(l=window.innerHeight-t.offsetHeight-10),t.style.left=`${a}px`,t.style.top=`${l}px`,t.style.display="block"}function uploadFile(e){let t=document.createElement("input");t.type="file",t.accept="*",t.multiple=!0,t.style.display="none",t.addEventListener("change",function(t){let a=t.target.files;if(a){let l=new FormData;for(let n=0;n<a.length;n++)l.append("files[]",a[n]);l.append("dir",e),increaseAjaxPending(),fetch("lib.ajax/file-manager-upload.php",{method:"POST",body:l}).then(e=>e.json()).then(e=>{if(decreaseAjaxPending(),"success"==e.status){if(null!=selectedItem){let t=selectedItem.closest("li"),a=t.querySelector("ul");null==a&&(a=document.createElement("ul"),t.appendChild(a)),null!=t&&(displayDirContent(e.dirs,a,!0),t.setAttribute("data-open","true"))}else resetFileManager()}else console.error("Error uploading file:",e.error)}).catch(e=>{decreaseAjaxPending(),console.error("Error uploading file:",e)})}}),t.click()}function createNewFile(e){let t=""!==e?e+"/new-file.txt":"new-file.txt";document.querySelector(".file-path").value=t,document.querySelector(".btn-save-file").disabled=!1,fileManagerEditor.setValue(""),changeMode(t,"txt"),setDisplayMode("text"),fileManagerEditor.focus()}function createNewDirectory(e){let t="new-directory";""!=e&&(t=e+"/"+t),asyncPrompt("Enter new directory name","Create Directory",[{caption:"OK",fn:function(e){let t=null,a=null,l="/";null!=selectedItem&&(t=selectedItem.closest("li"),a=selectedItem.closest("li").querySelector("ul"),l=t?t.querySelector("span").dataset.dir:"/"),increaseAjaxPending(),fetch("lib.ajax/file-manager-create-directory.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,type:"dir",dir:l})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=t&&t.removeAttribute("data-loading"),e.dirs?null!=t&&null!=a?displayDirContent(e.dirs,a,!0):resetFileManager():"/"==l?resetFileManager():loadDirContent(l,a,t,!0)}).catch(e=>{decreaseAjaxPending(),null!=t&&t.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"Cancel",fn:function(){},class:"btn-secondary"}],t,function(){})}function renameFile(e,t){asyncPrompt("Enter new name for "+e,"Rename",[{caption:"OK",fn:function(a){let l=selectedItem.closest("ul").closest("li"),n=selectedItem.closest("ul"),i=l?l.querySelector("span").dataset.dir:"/";increaseAjaxPending(),fetch("lib.ajax/file-manager-rename.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,newName:a,type:t})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=l&&l.removeAttribute("data-loading"),e.dirs?displayDirContent(e.dirs,n,!0):"/"==i?resetFileManager():loadDirContent(i,n,l,!0)}).catch(e=>{decreaseAjaxPending(),null!=l&&l.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"Cancel",fn:function(){},class:"btn-secondary"}],e,function(e){})}function downloadFile(e,t){let a=`lib.ajax/file-manager-download.php?name=${encodeURIComponent(e)}&type=${encodeURIComponent(t)}`,l=document.createElement("a");l.href=a,l.download=e,l.click()}function deleteFile(e,t){asyncAlert("Do you want to delete "+e+"?","Confirmation",[{caption:"Yes",fn(){let a=selectedItem.closest("li");increaseAjaxPending(),fetch("lib.ajax/file-manager-delete.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,type:t})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=a&&a.parentNode.removeChild(a)}).catch(e=>{decreaseAjaxPending(),null!=a&&a.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"No",fn(){},class:"btn-secondary"}])}function compressDirectory(e){asyncAlert("Do you want to compress "+e+"?","Confirmation",[{caption:"Yes",fn(){let t=`lib.ajax/file-manager-download.php?name=${encodeURIComponent(e)}&type=dir`,a=document.createElement("a");a.href=t,a.download=e,a.click()},class:"btn-primary"},{caption:"No",fn(){},class:"btn-secondary"}])}function getCaller(){try{throw Error()}catch(e){let t=e.stack.split("\n");if(t.length>2){let a=t[2],l=a.match(/at (\w+)/);return l?l[1]:"Unknown"}return"Unknown"}}function resetFileManager(){let e=document.querySelector("#dir-tree");fileManagerEditor&&fileManagerEditor.setValue(""),document.querySelector(".btn-save-file").disabled=!0,document.querySelector("#dir-tree").innerHTML="",document.querySelector(".file-path").value="",loadDirContent("",e,null,!0)}function getFileExtension(e){let t=/\.(\w+)$/.exec(e);return t?t[1]:""}function format(){let e=fileManagerEditor.lineCount();fileManagerEditor.autoFormatRange({line:0,ch:0},{line:e})}function refreshDirectory(e){let t=selectedItem.closest("li"),a=t.querySelector("ul");null==a&&(a=document.createElement("ul"),t.appendChild(a)),loadDirContent(e,a,t,!0),null!=t&&t.setAttribute("data-open","true")}function loadDirContent(e,t,a,l){null!=a&&a.setAttribute("data-loading","true"),increaseAjaxPending(),$.ajax({url:"lib.ajax/file-manager-load-dir.php",method:"GET",data:{dir:e},dataType:"json",success:function(e){decreaseAjaxPending(),null!=a&&a.removeAttribute("data-loading"),displayDirContent(e,t,l)},error:function(e,t,l){decreaseAjaxPending(),null!=a&&a.removeAttribute("data-loading"),console.error("AJAX Error:",t,l)}})}function displayDirContent(e,t,a){t.innerHTML="",e.forEach(function(e){if("dir"===e.type){let a=document.createElement("li");a.dataset.type=e.type;let l=document.createElement("span");l.textContent=e.name,l.dataset.dir=e.path,l.classList.add("dir"),a.appendChild(l),t.appendChild(a)}else if("file"===e.type){let n=document.createElement("li");n.dataset.type=e.type;let i=document.createElement("span");i.textContent=e.name,i.dataset.file=e.path,i.dataset.extension=e.extension,i.classList.add("file"),n.appendChild(i),t.appendChild(n)}})}function getDirectoryName(e){if("string"!=typeof e||""===e.trim())return console.warn("Invalid path provided"),"";e=e.trim().replace(/\/+$/,"");let t=e.lastIndexOf("/");return t<=0?"":e.substring(0,t).replace(/^\/+/,"")}function saveFile(e,t){let a=new FormData;a.append("file",e),a.append("content",t),increaseAjaxPending(),fetch("lib.ajax/file-manager-save-file.php",{method:"POST",body:a}).then(e=>e.json()).then(e=>{decreaseAjaxPending();let t=null,a=null,l=getDirectoryName(document.querySelector(".file-path").value);if(l.length>0){let n=`span[data-dir="${l}"]`;a=document.querySelector(n).closest("li")}null!=selectedItem?(a=selectedItem.closest("li"),null==(t=selectedItem.closest("li").querySelector("ul"))&&(t=document.createElement("ul"),a.appendChild(t)),e.dirs)?(a.removeAttribute("data-loading"),displayDirContent(e.dirs,t,!0),null!=a&&a.setAttribute("data-open","true")):loadDirContent("",document.querySelector("#dir-tree"),null,!0):null!=a&&e.dirs?(a.removeAttribute("data-loading"),displayDirContent(e.dirs,t,!0),null!=a&&a.setAttribute("data-open","true")):loadDirContent("",document.querySelector("#dir-tree"),null,!0)}).catch(e=>{decreaseAjaxPending()})}function openFile(e,t){t||(t=getFileExtension(e)),["jpg","jpeg","png","gif","webp","bmp","svg","ico","mp4","mp3","avi","exe","pdf"].includes(t.toLowerCase())?["jpg","jpeg","png","gif","webp","bmp","svg","ico"].includes(t.toLowerCase())?(setDisplayMode("image"),increaseAjaxPending(),fetch("lib.ajax/file-manager-load-image.php?file="+encodeURIComponent(e)).then(e=>e.text()).then(e=>{let t=document.querySelector(".media-display"),a=document.createElement("img");a.src=e,a.style.maxWidth="100%",a.style.maxHeight="400px",t.innerHTML="",t.appendChild(a),decreaseAjaxPending()}).catch(e=>{decreaseAjaxPending()})):fileDiv.textContent="Cannot open this file.":(null===currentMode&&changeMode(e,t),openTextFile(e,t))}function openTextFile(e,t){document.querySelector(".btn-open-file").disabled=!0,document.querySelector(".btn-save-file").disabled=!0,setDisplayMode("text"),document.querySelector(".file-path").value=e,fileManagerEditor.setValue("Loading..."),changeMode("any.txt","txt"),increaseAjaxPending(),fetch("lib.ajax/file-manager-load-file.php?file="+encodeURIComponent(e)).then(e=>e.text()).then(a=>{changeMode(e,t),fileManagerEditor.setValue(a),document.querySelector(".btn-open-file").disabled=!1,document.querySelector(".btn-save-file").disabled=!1,decreaseAjaxPending()}).catch(e=>{document.querySelector(".btn-open-file").disabled=!1,document.querySelector(".btn-save-file").disabled=!1,setDisplayMode(""),decreaseAjaxPending()})}function setDisplayMode(e){"text"===e?(document.querySelector(".image-mode").style.display="none",document.querySelector(".text-mode").style.display="block"):"image"===e&&(document.querySelector(".text-mode").style.display="none",document.querySelector(".image-mode").style.display="block")}function changeMode(e,t){currentMode=t;let a=e,l,n,i=/.+\.([^.]+)$/.exec(a);if(i){let r=CodeMirror.findModeByExtension(i[1]);r&&(l=r.mode,n=r.mime)}else if(/\//.test(a)){let o=CodeMirror.findModeByMIME(a);o&&(l=o.mode,n=a)}else l=n=a;l&&(fileManagerEditor.setOption("mode",n),CodeMirror.autoLoadMode(fileManagerEditor,l))}