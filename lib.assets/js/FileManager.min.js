let selectedItem=null,contentModified=!0,currentMode=null;function initFileManager(){document.getElementById("dir-tree").addEventListener("click",function(e){if(e.target){if(e.target.classList.contains("dir")){let t=e.target.dataset.dir,i=e.target.closest("li"),n=i.querySelector("ul");n?i.setAttribute("data-open","true"===i.getAttribute("data-open")?"false":"true"):(n=document.createElement("ul"),i.appendChild(n),loadDirContent(t,n,i),i.setAttribute("data-open","true"))}else if(e.target.classList.contains("file")){let a=e.target;openFile(a.dataset.file,a.dataset.extension)}}}),document.querySelector(".btn-save-file").addEventListener("click",function(e){let t;saveFile(document.querySelector(".file-path").value,fileManagerEditor.getValue())}),document.querySelector(".btn-open-file").addEventListener("click",function(e){let t=document.querySelector(".file-path").value,i=getFileExtension(t);openTextFile(t,i)});let e=document.getElementById("dir-tree"),t=document.getElementById("context-menu");e.addEventListener("contextmenu",function(e){e.preventDefault();let i=e.target.closest("li");if(i&&i.dataset&&i.dataset.type){selectedItem=e.target;let n="",a=i.dataset.type,l="";"file"===a?(n=i.querySelector("span").dataset.file,l=(l=i.querySelector("span").dataset.extension).toLowerCase()):"dir"===a&&(n=i.querySelector("span").dataset.dir);let r=e.pageX,o=e.pageY;t.className="context-menu";let d=t.querySelector("ul");d.innerHTML="","file"===a?(["svg"].includes(l)?d.innerHTML=`
                <li data-type="file" data-operation="view-image" data-file="${n}">View Image</li>
                <li data-type="file" data-operation="open" data-file="${n}">Open as Text</li>
                <li data-type="file" data-operation="rename" data-file="${n}">Rename File</li>
                <li data-type="file" data-operation="download" data-file="${n}">Download File</li>
                <li data-type="file" data-operation="delete" data-file="${n}">Delete File</li>
                `:d.innerHTML=`
                <li data-type="file" data-operation="open" data-file="${n}">Open File</li>
                <li data-type="file" data-operation="rename" data-file="${n}">Rename File</li>
                <li data-type="file" data-operation="download" data-file="${n}">Download File</li>
                <li data-type="file" data-operation="delete" data-file="${n}">Delete File</li>
                `,o+t.offsetHeight>window.innerHeight&&(o=window.innerHeight-t.offsetHeight-10),t.style.left=`${r}px`,t.style.top=`${o}px`,t.style.display="block"):"dir"===a?(d.innerHTML=`
              <li data-type="dir" data-operation="new-file" data-dir="${n}">Create New File</li>
              <li data-type="dir" data-operation="new-dir" data-dir="${n}">Create New Directory</li>
              <li data-type="dir" data-operation="upload-file" data-dir="${n}">Upload Files</li>
              <li data-type="dir" data-operation="open" data-dir="${n}">Expand Directory</li>
              <li data-type="dir" data-operation="refresh-dir" data-dir="${n}">Reload Directory</li>
              <li data-type="dir" data-operation="rename" data-dir="${n}">Rename Directory</li>
              <li data-type="dir" data-operation="compress" data-dir="${n}">Download Directory</li>
              <li data-type="dir" data-operation="delete" data-dir="${n}">Delete Directory</li>
              `,o+t.offsetHeight>window.innerHeight&&(o=window.innerHeight-t.offsetHeight-10),t.style.left=`${r}px`,t.style.top=`${o}px`,t.style.display="block"):(showRootContextMenu(e,t),e.preventDefault(),e.stopPropagation())}else showRootContextMenu(e,t),e.preventDefault(),e.stopPropagation()}),document.querySelector(".root-directory").addEventListener("contextmenu",function(e){showRootContextMenu(e,t),e.stopPropagation(),e.preventDefault()}),document.addEventListener("click",function(){t.style.display="none"}),t.addEventListener("click",function(e){let i=e.target.closest("li");if(null!=i){let n=i.dataset.operation;if(n){let a="",l=i.dataset.type;switch("file"===l?a=i.dataset.file:"dir"===l&&(a=i.dataset.dir),n){case"view-image":viewImage(a),setDisplayMode("image");break;case"root-new-file":createNewFile("");break;case"reset":resetFileManager();break;case"root-dowload":downloadFile("","dir");break;case"new-file":createNewFile(a);break;case"upload-file":uploadFile(a);break;case"new-dir":createNewDirectory(a);break;case"root-new-dir":createNewDirectory("");break;case"open":selectedItem.click();break;case"refresh-dir":refreshDirectory(a);break;case"rename":renameFile(a,l);break;case"download":downloadFile(a,l);break;case"delete":deleteFile(a,l);break;case"compress":compressDirectory(a)}t.style.display="none"}}}),document.querySelector(".file-path").addEventListener("change",function(e){let t=e.target.value,i=getFileExtension(t);i&&changeMode(t,i)}),initCodeMirror(),fileManagerEditor.refresh()}function showRootContextMenu(e,t){e.preventDefault(),selectedItem=null;let i=e.pageX,n=e.pageY;t.className="context-menu";let a=t.querySelector("ul");a.innerHTML=`
    <li data-type="dir" data-operation="root-new-file" data-dir="">Create New File</li>
    <li data-type="dir" data-operation="root-new-dir" data-dir="">Create New Directory</li>
    <li data-type="dir" data-operation="upload-file" data-dir="">Upload Files</li>
    <li data-type="dir" data-operation="reset" data-dir="">Reset Content</li>
    <li data-type="dir" data-operation="root-dowload" data-dir="">Download All</li>
    `,n+t.offsetHeight>window.innerHeight&&(n=window.innerHeight-t.offsetHeight-10),t.style.left=`${i}px`,t.style.top=`${n}px`,t.style.display="block"}function uploadFile(e){let t=document.createElement("input");t.type="file",t.accept="*",t.multiple=!0,t.style.display="none",t.addEventListener("change",function(t){let i=t.target.files;if(i){let n=new FormData;for(let a=0;a<i.length;a++)n.append("files[]",i[a]);n.append("dir",e),increaseAjaxPending(),fetch("lib.ajax/file-manager-upload.php",{method:"POST",body:n}).then(e=>e.json()).then(e=>{if(decreaseAjaxPending(),"success"==e.status){if(null!=selectedItem){let t=selectedItem.closest("li"),i=t.querySelector("ul");null==i&&(i=document.createElement("ul"),t.appendChild(i)),null!=t&&(displayDirContent(e.dirs,i,!0),t.setAttribute("data-open","true"))}else resetFileManager()}else console.error("Error uploading file:",e.error)}).catch(e=>{decreaseAjaxPending(),console.error("Error uploading file:",e)})}}),t.click()}function createNewFile(e){let t=""!==e?e+"/new-file.txt":"new-file.txt";document.querySelector(".file-path").value=t,document.querySelector(".btn-save-file").disabled=!1,fileManagerEditor.setValue(""),changeMode(t,"txt"),setDisplayMode("text"),fileManagerEditor.focus()}function createNewDirectory(e){let t="new-directory";""!=e&&(t=e+"/"+t),asyncPrompt("Enter new directory name","Create Directory",[{caption:"OK",fn:function(e){let t=null,i=null,n="/";null!=selectedItem&&(t=selectedItem.closest("li"),i=selectedItem.closest("li").querySelector("ul"),n=t?t.querySelector("span").dataset.dir:"/"),increaseAjaxPending(),fetch("lib.ajax/file-manager-create-directory.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,type:"dir",dir:n})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=t&&t.removeAttribute("data-loading"),e.dirs?null!=t&&null!=i?displayDirContent(e.dirs,i,!0):resetFileManager():"/"==n?resetFileManager():loadDirContent(n,i,t,!0)}).catch(e=>{decreaseAjaxPending(),null!=t&&t.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"Cancel",fn:function(){},class:"btn-secondary"}],t,function(){})}function renameFile(e,t){asyncPrompt("Enter new name for "+e,"Rename",[{caption:"OK",fn:function(i){let n=selectedItem.closest("ul").closest("li"),a=selectedItem.closest("ul"),l=n?n.querySelector("span").dataset.dir:"/";increaseAjaxPending(),fetch("lib.ajax/file-manager-rename.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,newName:i,type:t})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=n&&n.removeAttribute("data-loading"),e.dirs?displayDirContent(e.dirs,a,!0):"/"==l?resetFileManager():loadDirContent(l,a,n,!0)}).catch(e=>{decreaseAjaxPending(),null!=n&&n.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"Cancel",fn:function(){},class:"btn-secondary"}],e,function(e){})}function downloadFile(e,t){let i=`lib.ajax/file-manager-download.php?name=${encodeURIComponent(e)}&type=${encodeURIComponent(t)}`,n=document.createElement("a");n.href=i,n.download=e,n.click()}function deleteFile(e,t){asyncAlert("Do you want to delete "+e+"?","Confirmation",[{caption:"Yes",fn(){let i=selectedItem.closest("li");increaseAjaxPending(),fetch("lib.ajax/file-manager-delete.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e,type:t})}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{decreaseAjaxPending(),null!=i&&i.parentNode.removeChild(i)}).catch(e=>{decreaseAjaxPending(),null!=i&&i.removeAttribute("data-loading")})},class:"btn-primary"},{caption:"No",fn(){},class:"btn-secondary"}])}function compressDirectory(e){asyncAlert("Do you want to compress "+e+"?","Confirmation",[{caption:"Yes",fn(){let t=`lib.ajax/file-manager-download.php?name=${encodeURIComponent(e)}&type=dir`,i=document.createElement("a");i.href=t,i.download=e,i.click()},class:"btn-primary"},{caption:"No",fn(){},class:"btn-secondary"}])}function getCaller(){try{throw Error()}catch(e){let t=e.stack.split("\n");if(t.length>2){let i=t[2],n=i.match(/at (\w+)/);return n?n[1]:"Unknown"}return"Unknown"}}function resetFileManager(){let e=document.querySelector("#dir-tree");fileManagerEditor&&fileManagerEditor.setValue(""),document.querySelector(".btn-save-file").disabled=!0,document.querySelector("#dir-tree").innerHTML="",document.querySelector(".file-path").value="",loadDirContent("",e,null,!0)}function getFileExtension(e){let t=/\.(\w+)$/.exec(e);return t?t[1]:""}function getFileBaseName(e){let t=e.split(/[\\/]/).pop(),i=t.lastIndexOf(".");return -1===i?t:t.substring(0,i)}function format(){let e=fileManagerEditor.lineCount();fileManagerEditor.autoFormatRange({line:0,ch:0},{line:e})}function refreshDirectory(e){let t=selectedItem.closest("li"),i=t.querySelector("ul");null==i&&(i=document.createElement("ul"),t.appendChild(i)),loadDirContent(e,i,t,!0),null!=t&&t.setAttribute("data-open","true")}function loadDirContent(e,t,i,n){null!=i&&i.setAttribute("data-loading","true"),increaseAjaxPending(),$.ajax({url:"lib.ajax/file-manager-load-dir.php",method:"GET",data:{dir:e},dataType:"json",success:function(e){decreaseAjaxPending(),null!=i&&i.removeAttribute("data-loading"),displayDirContent(e,t,n)},error:function(e,t,n){decreaseAjaxPending(),null!=i&&i.removeAttribute("data-loading"),console.error("AJAX Error:",t,n)}})}function displayDirContent(e,t,i){t.innerHTML="",e?.length&&e.forEach(function(e){if("dir"===e.type){let i=document.createElement("li");i.dataset.type=e.type;let n=document.createElement("span");n.textContent=e.name,n.dataset.dir=e.path,n.classList.add("dir"),i.appendChild(n),t.appendChild(i)}else if("file"===e.type){let a=document.createElement("li");a.dataset.type=e.type;let l=document.createElement("span");l.textContent=e.name,l.dataset.file=e.path,l.dataset.extension=e.extension,l.classList.add("file"),a.appendChild(l),t.appendChild(a)}})}function getDirectoryName(e){if("string"!=typeof e||""===e.trim())return console.warn("Invalid path provided"),"";e=e.trim().replace(/\/+$/,"");let t=e.lastIndexOf("/");return t<=0?"":e.substring(0,t).replace(/^\/+/,"")}function saveFile(e,t){let i=new FormData;i.append("file",e),i.append("content",t),increaseAjaxPending(),fetch("lib.ajax/file-manager-save-file.php",{method:"POST",body:i}).then(e=>e.json()).then(e=>{decreaseAjaxPending();let t=null,i=null,n=getDirectoryName(document.querySelector(".file-path").value);if(n.length>0){let a=`span[data-dir="${n}"]`;i=document.querySelector(a).closest("li")}null!=selectedItem?(i=selectedItem.closest("li"),null==(t=selectedItem.closest("li").querySelector("ul"))&&(t=document.createElement("ul"),i.appendChild(t)),e.dirs)?(i.removeAttribute("data-loading"),displayDirContent(e.dirs,t,!0),null!=i&&i.setAttribute("data-open","true")):loadDirContent("",document.querySelector("#dir-tree"),null,!0):null!=i&&e.dirs?(i.removeAttribute("data-loading"),displayDirContent(e.dirs,t,!0),null!=i&&i.setAttribute("data-open","true")):loadDirContent("",document.querySelector("#dir-tree"),null,!0)}).catch(e=>{decreaseAjaxPending()})}function openFile(e,t){t||(t=getFileExtension(e));let i=t.toLowerCase();["jpg","jpeg","png","gif","webp","bmp","ico","pdf","xls","xlsx","ods","csv","docx","sqlite","db","ttf","otf","woff","woff2","eot","mp3","wav","flac","m4a","mp4","ogg","webm","avi","mov","wmv","flv","mkv","3gp"].includes(i)?["jpg","jpeg","png","gif","webp","bmp","ico"].includes(i)?(viewImage(e),setDisplayMode("image")):["sqlite","db"].includes(i)?(initDatabaseOnce(e),setDisplayMode("database")):["pdf","xls","xlsx","csv","ods","docx"].includes(i)?(initDocumentViewerOnce(e),setDisplayMode("document")):["ttf","otf","woff","woff2","eot"].includes(i)?(initFontViewerOnce(e,"font-frame"),setDisplayMode("frame")):["mp4","ogg","webm","avi","mov","wmv","flv","mkv","3gp"].includes(i)?(initFrameViewerOnce(e,"video-frame"),setDisplayMode("frame")):["mp3","wav","flac","m4a"].includes(i)?(initFrameViewerOnce(e,"audio-frame"),setDisplayMode("frame")):fileDiv.textContent="Cannot open this file.":(null===currentMode&&changeMode(e,t),setDisplayMode("text"),openTextFile(e,t))}function viewImage(e){increaseAjaxPending(),fetch("lib.ajax/file-manager-load-image.php?file="+encodeURIComponent(e)).then(e=>e.text()).then(e=>{let t=document.querySelector(".media-display"),i=document.createElement("img");i.src=e,i.style.maxWidth="100%",i.style.maxHeight="400px",t.innerHTML="",t.appendChild(i),decreaseAjaxPending()}).catch(e=>{decreaseAjaxPending()})}function initFrameViewerOnce(e,t){$("#frame-viewer").html(`<iframe class="${t}" src="lib.ajax/file-manager-load-file.php?file=${encodeURIComponent(e)}" frameborder="0"></iframe>`)}function initFontViewerOnce(e,t){$("#frame-viewer").html(`<iframe class="${t}" src="lib.ajax/file-managet-font-viewer.php?file=${encodeURIComponent(e)}" frameborder="0"></iframe>`)}function initDatabaseOnce(e){let t=Array.from(document.querySelectorAll(".script-for-sqlite-viewer"));if(0===t.length){console.error("No <script class='script-for-sqlite-viewer'> elements found.");return}let i=t.every(e=>"true"===e.dataset.loaded);if(i){runDatabaseInit(e);return}let n=t.filter(e=>"true"!==e.dataset.loaded).length;t.forEach(t=>{if("true"===t.dataset.loaded)return;let i=t.getAttribute("data-src");if(!i){console.warn("Missing data-src for script:",t),n--;return}let a=document.createElement("script");a.src=i,a.onload=function(){t.dataset.loaded="true",0==--n&&runDatabaseInit(e)},a.onerror=function(){console.error("Failed to load script:",i),n--},document.body.appendChild(a)})}function runDatabaseInit(e){document.querySelector(".database-display").innerHTML=createDatabaseResource(),curretDatabaseName=getFileBaseName(e),loadDatabaseFromUrl("lib.ajax/file-manager-load-file.php?file="+encodeURIComponent(e)),document.querySelector(".sqlite-file-path").textContent=e,setDisplayMode("database")}function initDocumentViewerOnce(e){let t=Array.from(document.querySelectorAll(".script-for-document-viewer"));if(0===t.length){console.error("No <script class='script-for-document-viewer'> elements found.");return}let i=t.every(e=>"true"===e.dataset.loaded);if(i){runDocumentViewerInit(e);return}let n=t.filter(e=>"true"!==e.dataset.loaded).length;t.forEach(t=>{if("true"===t.dataset.loaded)return;let i=t.getAttribute("data-src");if(!i){console.warn("Missing data-src for script:",t),n--;return}let a=document.createElement("script");a.src=i,a.onload=function(){t.dataset.loaded="true",0==--n&&runDocumentViewerInit(e)},a.onerror=function(){console.error("Failed to load script:",i),n--},document.body.appendChild(a)})}function runDocumentViewerInit(e){previewFile("lib.ajax/file-manager-load-file.php?file="+encodeURIComponent(e)),setDisplayMode("document")}function openTextFile(e,t){document.querySelector(".btn-open-file").disabled=!0,document.querySelector(".btn-save-file").disabled=!0,setDisplayMode("text"),document.querySelector(".file-path").value=e,fileManagerEditor.setValue("Loading..."),changeMode("any.txt","txt"),increaseAjaxPending(),fetch("lib.ajax/file-manager-load-file.php?file="+encodeURIComponent(e)).then(e=>e.text()).then(i=>{changeMode(e,t),fileManagerEditor.setValue(i),document.querySelector(".btn-open-file").disabled=!1,document.querySelector(".btn-save-file").disabled=!1,decreaseAjaxPending()}).catch(e=>{document.querySelector(".btn-open-file").disabled=!1,document.querySelector(".btn-save-file").disabled=!1,setDisplayMode(""),decreaseAjaxPending()})}function setDisplayMode(e){["text","image","database","document","frame"].forEach(t=>{let i=document.querySelector(`.${t}-mode`);i&&(i.style.display=t===e?"block":"none")}),["text","image","database","document"].includes(e)&&$("#frame-viewer").html("")}function changeMode(e,t){currentMode=t;let i=e,n,a,l=/.+\.([^.]+)$/.exec(i);if(l){let r=CodeMirror.findModeByExtension(l[1]);r&&(n=r.mode,a=r.mime)}else if(/\//.test(i)){let o=CodeMirror.findModeByMIME(i);o&&(n=o.mode,a=i)}else n=a=i;n&&(fileManagerEditor.setOption("mode",a),CodeMirror.autoLoadMode(fileManagerEditor,n))}const editorModeMap={yaml:{mode:"text/x-yaml",indentUnit:2},yml:{mode:"text/x-yaml",indentUnit:2},js:{mode:"text/javascript",indentUnit:2},json:{mode:"application/json",indentUnit:2},css:{mode:"text/css",indentUnit:2},xml:{mode:"application/xml",indentUnit:2},html:{mode:"text/html",indentUnit:2},htm:{mode:"text/html",indentUnit:2},md:{mode:"text/x-markdown",indentUnit:2},markdown:{mode:"text/x-markdown",indentUnit:2},ts:{mode:"text/typescript",indentUnit:2},tsx:{mode:"text/typescript",indentUnit:2},jsx:{mode:"text/jsx",indentUnit:2},vue:{mode:"text/x-vue",indentUnit:2},rb:{mode:"text/x-ruby",indentUnit:2},sh:{mode:"text/x-sh",indentUnit:2},conf:{mode:"text/x-properties",indentUnit:2},cfg:{mode:"text/x-properties",indentUnit:2},properties:{mode:"text/x-properties",indentUnit:2},ini:{mode:"text/x-properties",indentUnit:2},env:{mode:"text/x-properties",indentUnit:2},php:{mode:"application/x-httpd-php",indentUnit:4},py:{mode:"text/x-python",indentUnit:4},java:{mode:"text/x-java",indentUnit:4},c:{mode:"text/x-csrc",indentUnit:4},cpp:{mode:"text/x-csrc",indentUnit:4},h:{mode:"text/x-csrc",indentUnit:4},go:{mode:"text/x-go",indentUnit:4},sql:{mode:"text/x-sql",indentUnit:4},log:{mode:"text/plain",indentUnit:2},txt:{mode:"text/plain",indentUnit:2},csv:{mode:"text/plain",indentUnit:2}};function initCodeMirror(){if("undefined"==typeof CodeMirror){console.error("CodeMirror library not found. Please ensure codemirror.js is loaded.");return}modeInput=document.getElementById("filename"),CodeMirror.modeURL="lib.assets/cm/mode/%N/%N.js",fileManagerEditor=CodeMirror.fromTextArea(document.getElementById("code"),{lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,indentUnit:4,indentWithTabs:!1}),window.setEditorModeByFilename=function(e){let t="text/plain",i=2,n=!1,a=e.lastIndexOf("."),l=a>-1?e.substring(a+1).toLowerCase():"",r=editorModeMap[l];if(r)t=r.mode,i=r.indentUnit,void 0!==r.indentWithTabs&&(n=r.indentWithTabs);else if(l){let o=CodeMirror.findModeByExtension(l);o&&(t=o.mime)}fileManagerEditor.setOption("mode",t),fileManagerEditor.setOption("indentWithTabs",n),fileManagerEditor.setOption("indentUnit",i);let d=CodeMirror.findModeByMIME(t)?.mode||t;CodeMirror.autoLoadMode(fileManagerEditor,d),console.log(`Editor mode set to: ${t} for file: ${e} (Indent: ${i} spaces, Tabs: ${n?"Yes":"No"})`)},window.addEventListener("resize",function(e){let t=document.querySelector("#file-content").offsetWidth-16,i=document.innerHeight-160;fileManagerEditor.setSize(t,i)});let e=document.querySelector("#file-content").offsetWidth-16,t=document.innerHeight-160;fileManagerEditor.setSize(e,t)}