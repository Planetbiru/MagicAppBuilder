class Entity{constructor(e,t){this.index=t,this.name=e,this.columns=[],this.foreignKeys=[],this.data=[],this.description="",this.creationDate=null,this.modificationDate=null,this.creator=null,this.modifier=null}static valueOf(e){let t=new Entity(e.name,e.index);return e.columns&&e.columns.forEach(e=>{t.addColumn(Column.valueOf(e))}),e.data&&t.setData(e.data),e.description&&(t.description=e.description),e.creationDate&&(t.creationDate=e.creationDate),e.modificationDate&&(t.modificationDate=e.modificationDate),e.creator&&(t.creator=e.creator),e.modifier&&(t.modifier=e.modifier),t.foreignKeys=e.foreignKeys,t}addColumn(e){this.columns.push(e)}removeColumn(e){this.columns.splice(e,1)}setData(e){this.data=e||[]}appendData(e){if(!e||0===e.length)return 0;(!this.data||Array.isArray(this.data))&&(this.data=[]);let t=this.getPrimaryKeyColumns();if(0===t.length)return this.data.push(...e),e.length;let n=new Set;this.data.forEach(e=>{let r=t.map(t=>e[t]).join("__");n.add(r)});let r=0;return e.forEach(e=>{let a=t.map(t=>e[t]).join("__");!n.has(a)&&(this.data.push(e),n.add(a),r++)}),r}getData(){return this.data}countPrimaryKey(){return this.columns.filter(e=>e.primaryKey).length}getPrimaryKeyColumns(){return this.columns.filter(e=>e.primaryKey).map(e=>e.name)}getPrimaryKeyColumnsAsString(e="mysql"){let t=this.getPrimaryKeyColumns();return"mysql"===e?t.map(e=>`\`${e}\``).join(", "):t.join(", ")}getForeignKeys(){return this.foreignKeys}toSQL(e="mysql",t=!1){let n=this.countPrimaryKey()>1,r=[],a=[],s="";if(s+=`-- TABLE ${this.name} BEGIN\r
\r
`,s+=`CREATE TABLE IF NOT EXISTS ${this.name} (\r
`,this.columns.forEach(t=>{r.push(`	${t.toSQL(e,n)}`)}),n&&r.push(`	PRIMARY KEY(${this.getPrimaryKeyColumnsAsString(e)})`),t&&this.foreignKeys){let i=Array.isArray(this.foreignKeys)?this.foreignKeys:Object.values(this.foreignKeys);i.forEach(t=>{let n=this.createForeignKey(t,e);n&&r.push(`	${n}`);let s=this.createIndexStandalone(t,e);s&&a.push(s)})}return s+=r.join(",\r\n"),s+="\r\n);\r\n\r\n",a.length&&(s+=a.join("\r\n")+"\r\n\r\n"),s+=`-- TABLE ${this.name} END\r
\r
`}createForeignKey(e,t="mysql"){if(!e||!e.columnName||!e.referencedTable||!e.referencedColumn)return"";let n=e.name?`CONSTRAINT ${e.name} `:"",r=e=>{if(!e)return"";let t=e.toUpperCase();return["NO ACTION","RESTRICT","CASCADE","SET NULL","SET DEFAULT"].includes(t)?t:""},a="",s="";if("postgresql"===t){let i=r(e.onUpdate),l=r(e.onDelete);i&&(a=` ON UPDATE ${i}`),l&&(s=` ON DELETE ${l}`);let o=e.deferrable?" DEFERRABLE INITIALLY DEFERRED":"";return`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${a}${s}${o}`}if("sqlite"===t){let m=["CASCADE","SET NULL","SET DEFAULT","NO ACTION"];return e.onUpdate&&m.includes(e.onUpdate.toUpperCase())&&(a=` ON UPDATE ${e.onUpdate.toUpperCase()}`),e.onDelete&&m.includes(e.onDelete.toUpperCase())&&(s=` ON DELETE ${e.onDelete.toUpperCase()}`),`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${a}${s}`}return e.onUpdate&&(a=` ON UPDATE ${e.onUpdate.toUpperCase()}`),e.onDelete&&(s=` ON DELETE ${e.onDelete.toUpperCase()}`),`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${a}${s}`}createIndex(e,t="mysql"){if(!e||!e.columnName)return"";let n=e.name;return(n?n.startsWith("fk_")?n="idx_"+n.substring(3):e.columnName&&(n="idx_"+this.name+"_"+e.columnName):n=`idx_${this.name}_${e.columnName}`,"mysql"===t)?`INDEX ${n} (${e.columnName})`:""}createIndexStandalone(e,t="mysql"){if(!e||!e.columnName)return"";let n=e.name;switch(n?n.startsWith("fk_")?n="idx_"+n.substring(3):e.columnName&&(n="idx_"+this.name+"_"+e.columnName):n=`idx_${this.name}_${e.columnName}`,t){case"mysql":case"sqlserver":return`CREATE INDEX ${n} ON ${this.name} (${e.columnName});`;case"postgresql":case"sqlite":return`CREATE INDEX IF NOT EXISTS ${n} ON ${this.name} (${e.columnName});`;default:return""}}toSQLInsert(e="mysql",t=100){if(!this.data||0===this.data.length)return"";let n=this.columns.map(e=>e.name),r=[];for(let a=0;a<this.data.length;a+=t){let s=this.data.slice(a,a+t),i=s.map(t=>"("+n.map(n=>{let r=this.columns.find(e=>e.name===n),a=!!r&&r.nullable;return this.formatValue(t[n],r,e,a)}).join(", ")+")"),l=`INSERT INTO ${this.name} (${n.join(", ")}) VALUES
${i.join(",\n")};\r
`;r.push(l)}return r.join("\n")}createInsert(e,t){let n=t.join(", "),r=t.map(t=>{let n=this.columns.find(e=>e.name===t),r=!n||n.nullable;return this.formatValue(e[t],n,"mysql",r)}).join(", ");return`INSERT INTO ${this.name} (${n}) VALUES (${r});`}formatValue(e,t,n="mysql",r=!0){let a=t.type.toLowerCase(),s=t.length,i=t.isTypeText(a),l=t.isTypeInteger(a),o=t.isTypeFloat(a),m=t.isTypeBoolean(a,s),u=null==e||"string"==typeof e&&""===e.trim()||!i&&"null"===String(e).toLowerCase();return u?r?"null":void 0!==t.default&&null!==t.default?this.formatValue(t.default,t,n,!0):m?this.formatBoolean(e,n,!1,t.default):l||o?"0":"''":m?this.formatBoolean(e,n,r,t.default):l||o?e.toString():this.quoteString(e,n)}formatBoolean(e,t="mysql",n=!0,r=null){let a=null==e||"string"==typeof e&&""===e.trim()||"string"==typeof e&&"null"===e.trim().toLowerCase();if(a)return n?"null":null!=r?this.formatBoolean(r,t,!1):"postgresql"===t.toLowerCase()?"false":"0";let s=String(e).toLowerCase().trim(),i="true"===s||"1"===s||"yes"===s||"on"===s;return"postgresql"===t.toLowerCase()?i?"true":"false":i?"1":"0"}quoteString(e,t="mysql"){let n=String(e);switch(n=n.replace(/'/g,"''"),t.toLowerCase()){case"mysql":default:n=n.replace(/\\/g,"\\\\");break;case"postgresql":return`E'${n=n.replace(/\\/g,"\\\\")}'`;case"sqlite":case"sqlserver":}return`'${n}'`}}