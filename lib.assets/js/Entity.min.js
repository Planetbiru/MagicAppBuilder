class Entity{constructor(e,t){this.index=t,this.name=e,this.columns=[],this.foreignKeys=[],this.indexes=[],this.data=[],this.description="",this.creationDate=null,this.modificationDate=null,this.creator=null,this.modifier=null}static valueOf(e){let t=new Entity(e.name,e.index);return e.columns&&e.columns.forEach(e=>{t.addColumn(Column.valueOf(e))}),e.data&&t.setData(e.data),e.description&&(t.description=e.description),e.creationDate&&(t.creationDate=e.creationDate),e.modificationDate&&(t.modificationDate=e.modificationDate),e.creator&&(t.creator=e.creator),e.modifier&&(t.modifier=e.modifier),t.foreignKeys=e.foreignKeys,t.indexes=e.indexes||[],t}addColumn(e){this.columns.push(e)}removeColumn(e){this.columns.splice(e,1)}setData(e){this.data=e||[]}appendData(e){if(!e||0===e.length)return 0;(!this.data||Array.isArray(this.data))&&(this.data=[]);let t=this.getPrimaryKeyColumns();if(0===t.length)return this.data.push(...e),e.length;let n=new Set;this.data.forEach(e=>{let s=t.map(t=>e[t]).join("__");n.add(s)});let s=0;return e.forEach(e=>{let r=t.map(t=>e[t]).join("__");!n.has(r)&&(this.data.push(e),n.add(r),s++)}),s}getData(){return this.data}countPrimaryKey(){return this.columns.filter(e=>e.primaryKey).length}getPrimaryKeyColumns(){return this.columns.filter(e=>e.primaryKey).map(e=>e.name)}getPrimaryKeyColumnsAsString(e="mysql"){let t=this.getPrimaryKeyColumns();return"mysql"===e?t.map(e=>`\`${e}\``).join(", "):t.join(", ")}getForeignKeys(){return this.foreignKeys}toSQL(e="mysql",t=!1,n=!1){let s=this.countPrimaryKey()>1,r=[],i=[],a="";a+=`-- TABLE ${this.name} BEGIN\r
\r
`,a+=`CREATE TABLE ${"mysql"===e||"postgresql"===e||"sqlite"===e?"IF NOT EXISTS ":""}${this.name} (\r
`,this.columns.forEach(t=>{r.push(`	${t.toSQL(e,s)}`)}),s&&r.push(`	PRIMARY KEY(${this.getPrimaryKeyColumnsAsString(e)})`);let l=new Set;if(n&&this.indexes&&Array.isArray(this.indexes)&&this.indexes.forEach(t=>{if(t&&t.columns&&t.columns.length>0){let n=t.columns.slice().sort().join(",");if(l.has(n))return;l.add(n);let s=t.name||`idx_${this.name}_${t.columns.join("_")}`,a=t.unique?"UNIQUE ":"";if("mysql"===e){let o=t.columns.map(e=>`\`${e}\``).join(", ");r.push(`	${a}INDEX \`${s}\` (${o})`)}else{let m=t.columns.map(e=>`${e}`).join(", "),u=`${s}`,h=`${this.name}`;i.push(`CREATE ${a}INDEX ${"sqlite"===e||"postgresql"===e?"IF NOT EXISTS ":""}${u} ON ${h} (${m});`)}}}),t&&this.foreignKeys){let o=Array.isArray(this.foreignKeys)?this.foreignKeys:Object.values(this.foreignKeys);o.forEach(t=>{let n=this.createForeignKey(t,e);n&&r.push(`	${n}`);let s=t.columnName.split(",").map(e=>e.trim()),a=s.slice().sort().join(",");if(!l.has(a)){let o=this.createIndexStandalone(t,e);o&&(i.push(o),l.add(a))}})}return a+=r.join(",\r\n"),a+="\r\n);\r\n\r\n",i.length&&(a+=i.join("\r\n")+"\r\n\r\n"),a+=`-- TABLE ${this.name} END\r
\r
`}createIndexStatements(e="mysql",t=!0){let n=[];if(!t||!this.indexes||!Array.isArray(this.indexes))return n;let s="postgresql"===e||"sqlite"===e?"IF NOT EXISTS ":"";return this.indexes.forEach(e=>{if(!e||!e.columns||0===e.columns.length)return;let t=e.name||`idx_${this.name}_${e.columns.join("_")}`,r=e.unique?"UNIQUE ":"",i=e.columns.join(", ");n.push(`CREATE ${r}INDEX ${s}${t} ON ${this.name} (${i});`)}),n}createForeignKey(e,t="mysql"){if(!e||!e.columnName||!e.referencedTable||!e.referencedColumn)return"";let n=e.name?`CONSTRAINT ${e.name} `:"",s=e=>{if(!e)return"";let t=e.toUpperCase();return["NO ACTION","RESTRICT","CASCADE","SET NULL","SET DEFAULT"].includes(t)?t:""},r="",i="";if("postgresql"===t){let a=s(e.onUpdate),l=s(e.onDelete);a&&(r=` ON UPDATE ${a}`),l&&(i=` ON DELETE ${l}`);let o=e.deferrable?" DEFERRABLE INITIALLY DEFERRED":"";return`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${r}${i}${o}`}if("sqlite"===t){let m=["CASCADE","SET NULL","SET DEFAULT","NO ACTION"];return e.onUpdate&&m.includes(e.onUpdate.toUpperCase())&&(r=` ON UPDATE ${e.onUpdate.toUpperCase()}`),e.onDelete&&m.includes(e.onDelete.toUpperCase())&&(i=` ON DELETE ${e.onDelete.toUpperCase()}`),`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${r}${i}`}return e.onUpdate&&(r=` ON UPDATE ${e.onUpdate.toUpperCase()}`),e.onDelete&&(i=` ON DELETE ${e.onDelete.toUpperCase()}`),`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${r}${i}`}createIndex(e,t="mysql"){if(!e||!e.columnName)return"";let n=e.name;return(n?n.startsWith("fk_")?n="idx_"+n.substring(3):e.columnName&&(n="idx_"+this.name+"_"+e.columnName):n=`idx_${this.name}_${e.columnName}`,"mysql"===t)?`INDEX ${n} (${e.columnName})`:""}createIndexStandalone(e,t="mysql"){if(!e||!e.columnName)return"";let n=e.name;switch(n?n.startsWith("fk_")?n="idx_"+n.substring(3):e.columnName&&(n="idx_"+this.name+"_"+e.columnName):n=`idx_${this.name}_${e.columnName}`,t){case"mysql":case"sqlserver":return`CREATE INDEX ${n} ON ${this.name} (${e.columnName});`;case"postgresql":case"sqlite":return`CREATE INDEX IF NOT EXISTS ${n} ON ${this.name} (${e.columnName});`;default:return""}}toSQLInsert(e="mysql",t=100){if(!this.data||0===this.data.length)return"";let n=this.columns.map(e=>e.name),s=[];for(let r=0;r<this.data.length;r+=t){let i=this.data.slice(r,r+t),a=i.map(t=>"("+n.map(n=>{let s=this.columns.find(e=>e.name===n),r=!!s&&s.nullable;return this.formatValue(t[n],s,e,r)}).join(", ")+")"),l=`INSERT INTO ${this.name} (${n.join(", ")}) VALUES
${a.join(",\n")};\r
`;s.push(l)}return s.join("\n")}createInsert(e,t){let n=t.join(", "),s=t.map(t=>{let n=this.columns.find(e=>e.name===t),s=!n||n.nullable;return this.formatValue(e[t],n,"mysql",s)}).join(", ");return`INSERT INTO ${this.name} (${n}) VALUES (${s});`}formatValue(e,t,n="mysql",s=!0){let r=t.type.toLowerCase(),i=t.length,a=t.isTypeText(r),l=t.isTypeInteger(r),o=t.isTypeFloat(r),m=t.isTypeBoolean(r,i),u=null==e||"string"==typeof e&&""===e.trim()||!a&&"null"===String(e).toLowerCase();return u?s?"null":void 0!==t.default&&null!==t.default?this.formatValue(t.default,t,n,!0):m?this.formatBoolean(e,n,!1,t.default):l||o?"0":"''":m?this.formatBoolean(e,n,s,t.default):l||o?e.toString():this.quoteString(e,n)}formatBoolean(e,t="mysql",n=!0,s=null){let r=null==e||"string"==typeof e&&""===e.trim()||"string"==typeof e&&"null"===e.trim().toLowerCase();if(r)return n?"null":null!=s?this.formatBoolean(s,t,!1):"postgresql"===t.toLowerCase()?"false":"0";let i=String(e).toLowerCase().trim(),a="true"===i||"1"===i||"yes"===i||"on"===i;return"postgresql"===t.toLowerCase()?a?"true":"false":a?"1":"0"}quoteString(e,t="mysql"){let n=String(e);switch(n=n.replace(/'/g,"''"),t.toLowerCase()){case"mysql":default:n=n.replace(/\\/g,"\\\\");break;case"postgresql":return`E'${n=n.replace(/\\/g,"\\\\")}'`;case"sqlite":case"sqlserver":}return`'${n}'`}}