class Entity{constructor(e,t){this.index=t,this.name=e,this.columns=[],this.foreignKeys=[],this.indexes=[],this.data=[],this.description="",this.creationDate=null,this.modificationDate=null,this.creator=null,this.modifier=null}static valueOf(e){let t=new Entity(e.name,e.index);return e.columns&&e.columns.forEach(e=>{t.addColumn(Column.valueOf(e))}),e.data&&t.setData(e.data),e.description&&(t.description=e.description),e.creationDate&&(t.creationDate=e.creationDate),e.modificationDate&&(t.modificationDate=e.modificationDate),e.creator&&(t.creator=e.creator),e.modifier&&(t.modifier=e.modifier),t.foreignKeys=e.foreignKeys,t.indexes=e.indexes||[],t}addColumn(e){this.columns.push(e)}removeColumn(e){this.columns.splice(e,1)}setData(e){this.data=e||[]}appendData(e){if(!e||0===e.length)return 0;(!this.data||Array.isArray(this.data))&&(this.data=[]);let t=this.getPrimaryKeyColumns();if(0===t.length)return this.data.push(...e),e.length;let n=new Set;this.data.forEach(e=>{let r=t.map(t=>e[t]).join("__");n.add(r)});let r=0;return e.forEach(e=>{let s=t.map(t=>e[t]).join("__");!n.has(s)&&(this.data.push(e),n.add(s),r++)}),r}getData(){return this.data}countPrimaryKey(){return this.columns.filter(e=>e.primaryKey).length}getPrimaryKeyColumns(){return this.columns.filter(e=>e.primaryKey).map(e=>e.name)}getPrimaryKeyColumnsAsString(e="mysql"){let t=this.getPrimaryKeyColumns();return"mysql"===e?t.map(e=>`\`${e}\``).join(", "):t.join(", ")}getForeignKeys(){return this.foreignKeys}toSQL(e="mysql",t=!1,n=!1){let r=this.countPrimaryKey()>1,s=[],a=[],i="";if(i+=`-- TABLE ${this.name} BEGIN\r
\r
`,i+=`CREATE TABLE ${"mysql"===e||"postgresql"===e||"sqlite"===e?"IF NOT EXISTS ":""}${this.name} (\r
`,this.columns.forEach(t=>{s.push(`	${t.toSQL(e,r)}`)}),r&&s.push(`	PRIMARY KEY(${this.getPrimaryKeyColumnsAsString(e)})`),n&&this.indexes&&Array.isArray(this.indexes)&&this.indexes.forEach(t=>{if(t&&t.columns&&t.columns.length>0){let n=t.name||`idx_${this.name}_${t.columns.join("_")}`,r=t.unique?"UNIQUE ":"";if("mysql"===e){let i=t.columns.map(e=>`${e}`).join(", ");s.push(`	${r}INDEX \`${n}\` (${i})`)}else{let l=t.columns.map(e=>`${e}`).join(", "),o=`${n}`,m=`${this.name}`;a.push(`CREATE ${r}INDEX ${"sqlite"===e||"postgresql"===e?"IF NOT EXISTS ":""}${o} ON ${m} (${l});`)}}}),t&&this.foreignKeys){let l=Array.isArray(this.foreignKeys)?this.foreignKeys:Object.values(this.foreignKeys);l.forEach(t=>{let n=this.createForeignKey(t,e);n&&s.push(`	${n}`);let r=this.createIndexStandalone(t,e);r&&a.push(r)})}return i+=s.join(",\r\n"),i+="\r\n);\r\n\r\n",a.length&&(i+=a.join("\r\n")+"\r\n\r\n"),i+=`-- TABLE ${this.name} END\r
\r
`}createForeignKey(e,t="mysql"){if(!e||!e.columnName||!e.referencedTable||!e.referencedColumn)return"";let n=e.name?`CONSTRAINT ${e.name} `:"",r=e=>{if(!e)return"";let t=e.toUpperCase();return["NO ACTION","RESTRICT","CASCADE","SET NULL","SET DEFAULT"].includes(t)?t:""},s="",a="";if("postgresql"===t){let i=r(e.onUpdate),l=r(e.onDelete);i&&(s=` ON UPDATE ${i}`),l&&(a=` ON DELETE ${l}`);let o=e.deferrable?" DEFERRABLE INITIALLY DEFERRED":"";return`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${s}${a}${o}`}if("sqlite"===t){let m=["CASCADE","SET NULL","SET DEFAULT","NO ACTION"];return e.onUpdate&&m.includes(e.onUpdate.toUpperCase())&&(s=` ON UPDATE ${e.onUpdate.toUpperCase()}`),e.onDelete&&m.includes(e.onDelete.toUpperCase())&&(a=` ON DELETE ${e.onDelete.toUpperCase()}`),`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${s}${a}`}return e.onUpdate&&(s=` ON UPDATE ${e.onUpdate.toUpperCase()}`),e.onDelete&&(a=` ON DELETE ${e.onDelete.toUpperCase()}`),`${n}FOREIGN KEY (${e.columnName}) REFERENCES ${e.referencedTable}(${e.referencedColumn})${s}${a}`}createIndex(e,t="mysql"){if(!e||!e.columnName)return"";let n=e.name;return(n?n.startsWith("fk_")?n="idx_"+n.substring(3):e.columnName&&(n="idx_"+this.name+"_"+e.columnName):n=`idx_${this.name}_${e.columnName}`,"mysql"===t)?`INDEX ${n} (${e.columnName})`:""}createIndexStandalone(e,t="mysql"){if(!e||!e.columnName)return"";let n=e.name;switch(n?n.startsWith("fk_")?n="idx_"+n.substring(3):e.columnName&&(n="idx_"+this.name+"_"+e.columnName):n=`idx_${this.name}_${e.columnName}`,t){case"mysql":case"sqlserver":return`CREATE INDEX ${n} ON ${this.name} (${e.columnName});`;case"postgresql":case"sqlite":return`CREATE INDEX IF NOT EXISTS ${n} ON ${this.name} (${e.columnName});`;default:return""}}toSQLInsert(e="mysql",t=100){if(!this.data||0===this.data.length)return"";let n=this.columns.map(e=>e.name),r=[];for(let s=0;s<this.data.length;s+=t){let a=this.data.slice(s,s+t),i=a.map(t=>"("+n.map(n=>{let r=this.columns.find(e=>e.name===n),s=!!r&&r.nullable;return this.formatValue(t[n],r,e,s)}).join(", ")+")"),l=`INSERT INTO ${this.name} (${n.join(", ")}) VALUES
${i.join(",\n")};\r
`;r.push(l)}return r.join("\n")}createInsert(e,t){let n=t.join(", "),r=t.map(t=>{let n=this.columns.find(e=>e.name===t),r=!n||n.nullable;return this.formatValue(e[t],n,"mysql",r)}).join(", ");return`INSERT INTO ${this.name} (${n}) VALUES (${r});`}formatValue(e,t,n="mysql",r=!0){let s=t.type.toLowerCase(),a=t.length,i=t.isTypeText(s),l=t.isTypeInteger(s),o=t.isTypeFloat(s),m=t.isTypeBoolean(s,a),u=null==e||"string"==typeof e&&""===e.trim()||!i&&"null"===String(e).toLowerCase();return u?r?"null":void 0!==t.default&&null!==t.default?this.formatValue(t.default,t,n,!0):m?this.formatBoolean(e,n,!1,t.default):l||o?"0":"''":m?this.formatBoolean(e,n,r,t.default):l||o?e.toString():this.quoteString(e,n)}formatBoolean(e,t="mysql",n=!0,r=null){let s=null==e||"string"==typeof e&&""===e.trim()||"string"==typeof e&&"null"===e.trim().toLowerCase();if(s)return n?"null":null!=r?this.formatBoolean(r,t,!1):"postgresql"===t.toLowerCase()?"false":"0";let a=String(e).toLowerCase().trim(),i="true"===a||"1"===a||"yes"===a||"on"===a;return"postgresql"===t.toLowerCase()?i?"true":"false":i?"1":"0"}quoteString(e,t="mysql"){let n=String(e);switch(n=n.replace(/'/g,"''"),t.toLowerCase()){case"mysql":default:n=n.replace(/\\/g,"\\\\");break;case"postgresql":return`E'${n=n.replace(/\\/g,"\\\\")}'`;case"sqlite":case"sqlserver":}return`'${n}'`}}