let currentData=null,selectedRowIndex=null,columnInfo=[],db,currentSqliteTableName=null,curretDatabaseName=null,exportType="";function loadDatabaseFromUrl(e){fetch(e).then(e=>{if(!e.ok)throw Error("Failed to load database. Please check the URL.");return e.arrayBuffer()}).then(e=>{let t=new Uint8Array(e);initSqlJs({locateFile:e=>"lib.assets/wasm/sql-wasm.wasm"}).then(e=>{let l=(db=new e.Database(t)).exec("SELECT name FROM sqlite_master WHERE type='table';"),a=document.querySelector("#sqlite-table-sidebar #sqlite-table-list");a.innerHTML="",l?.[0]?.values?.length?(l[0].values.forEach(e=>{let t=document.createElement("li"),l=e[0],n=document.createElement("a");n.href="#",n.innerText=l,n.classList.add("sqlite-table-content"),n.addEventListener("click",function(e){e.preventDefault(),displayTableData(db,l),hilightTable(e)});let r=document.createElement("a");r.href="#",r.innerText="â˜°",r.classList.add("sqlite-table-structure"),r.addEventListener("click",function(e){e.preventDefault(),displayTableStructure(db,l),hilightTable(e)}),t.appendChild(r),t.appendChild(document.createTextNode(" ")),t.appendChild(n),a.appendChild(t)}),document.getElementById("sqliteDownloadAllSqlButton").disabled=!1):db=null})}).catch(e=>{alert(`Error loading database from server: ${e.message}`)})}function displayTableStructure(e,t){currentSqliteTableName=t;let l=e.exec(`PRAGMA table_info(${t});`),a=document.getElementById("sqlite-output");if(a.innerHTML="",exportType="structure",document.getElementById("sqliteDownloadSqlButton").disabled=!1,l.length>0){let n=`<h3>Table Structure: ${t}</h3>
                           <table class="sqlite-table-data">
                               <thead>
                                   <tr>
                                       <th>Column Name</th>
                                       <th>Data Type</th>
                                       <th>Not Null</th>
                                       <th>Default</th>
                                       <th>Primary Key</th>
                                   </tr>
                               </thead>
                               <tbody>`;l[0].values.forEach(e=>{n+="<tr>",n+=`<td>${e[1]}</td>`,n+=`<td>${e[2]}</td>`,n+=`<td>${1===e[3]?"Yes":"No"}</td>`,n+=`<td>${null===e[4]?"":e[4]}</td>`,n+=`<td>${1===e[5]?"Yes":"No"}</td>`,n+="</tr>"}),n+="</tbody></table>",a.innerHTML=n}else a.innerHTML="No structure found."}function displayTableData(e,t){currentSqliteTableName=t;let l=e.exec("SELECT * FROM "+t),a=document.getElementById("sqlite-output");a.innerHTML="",exportType="structure+data",document.getElementById("sqliteDownloadSqlButton").disabled=!1,columnInfo=e.exec(`PRAGMA table_info(${t});`)[0].values,l.length>0?(a.innerHTML=`<h3>Table Content: ${t}</h3>`+createTable(l[0]),currentData=l[0]):a.innerHTML=`<h3>Table Content: ${t}</h3><p>No data found.</p>`}function createTable(e){let t='<table class="sqlite-table-data"><thead><tr>';return e.columns.forEach(e=>{t+=`<th>${e}</th>`}),t+="</tr></thead><tbody>",e.values.forEach(e=>{t+="<tr>",e.forEach(e=>{t+=`<td>${null!==e?e:""}</td>`}),t+="</tr>"}),t+="</tbody></table>"}function getDataType(e){let t=columnInfo.find(t=>t[1]===e);return t?t[2]:"UNKNOWN"}function hilightTable(e){let t=e.target.closest("li"),l=t.closest("ul").querySelectorAll("li");l.forEach(e=>{e.classList.remove("highlight")}),t.classList.add("highlight")}const SQLITE_EXPORT_BATCH_SIZE=50;function sqliteDownloadAllSql(){let e=db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");if(0===e.length||0===e[0].values.length)return;let t=e[0].values.map(e=>e[0]),l="-- SQL Export for All Tables\r\n\r\n";t.forEach(e=>{let t=db.exec(`PRAGMA table_info(${e});`),a={};if(t.length>0){let n=t[0].values.map(e=>{let t=e[1],l=e[2];a[t]=l.toUpperCase();let n=1===e[3]?"NOT NULL":"",r=e[4]?`DEFAULT ${e[4]}`:"",i=1===e[5]?"PRIMARY KEY":"";return`${t} ${l} ${n} ${r} ${i}`.trim()}).join(",\r\n  ");l+=`-- Table: ${e}\r
`,l+=`CREATE TABLE ${e} (\r
  ${n}\r
);\r
\r
`}let r=db.exec(`SELECT * FROM ${e};`);if(r.length>0){let i=r[0].columns,s=r[0].values;for(let o=0;o<s.length;o+=50){let d=s.slice(o,o+50),c=d.map(e=>{let t=e.map((e,t)=>{if(null===e)return"NULL";let l=i[t],n=a[l]||"";return/(INT|REAL|NUM|DECIMAL|DOUBLE|FLOAT|BOOL)/.test(n)?e:`'${e.toString().replace(/'/g,"''")}'`});return`(${t.join(", ")})`});l+=`INSERT INTO ${e} (${i.join(", ")}) VALUES\r
${c.join(",\r\n")}\r
;\r
`}l+="\r\n"}});let a=new Blob([l],{type:"text/sql"}),n=URL.createObjectURL(a),r=document.createElement("a");r.href=n,r.download=`${curretDatabaseName}.sql`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}function sqliteDownloadSql(){let e=db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");if(0===e.length||0===e[0].values.length)return;let t=currentSqliteTableName;if(!t)return;let l=`-- SQL Export for Table ${t}\r
\r
`,a=db.exec(`PRAGMA table_info(${t});`),n={};if(-1!=exportType.indexOf("structure")&&a.length>0){let r=a[0].values.map(e=>{let t=e[1],l=e[2];n[t]=l.toUpperCase();let a=1===e[3]?"NOT NULL":"",r=e[4]?`DEFAULT ${e[4]}`:"",i=1===e[5]?"PRIMARY KEY":"";return`${t} ${l} ${a} ${r} ${i}`.trim()}).join(",\r\n  ");l+=`-- Table: ${t}\r
`,l+=`CREATE TABLE ${t} (\r
  ${r}\r
);\r
\r
`}if(-1!=exportType.indexOf("data")){let i=db.exec(`SELECT * FROM ${t};`);if(i.length>0){let s=i[0].columns,o=i[0].values;for(let d=0;d<o.length;d+=50){let c=o.slice(d,d+50),u=c.map(e=>{let t=e.map((e,t)=>{if(null===e)return"NULL";let l=s[t],a=n[l]||"";return/(INT|REAL|NUM|DECIMAL|DOUBLE|FLOAT|BOOL)/.test(a)?e:`'${e.toString().replace(/'/g,"''")}'`});return`(${t.join(", ")})`});l+=`INSERT INTO ${t} (${s.join(", ")}) VALUES\r
${u.join(",\r\n")}\r
;\r
`}l+="\r\n"}}let b=new Blob([l],{type:"text/sql"}),h=URL.createObjectURL(b),p=document.createElement("a");p.href=h,p.download=`${t}.sql`,document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(h)}function createDatabaseResource(){return`
    <div id="sqlite-app-container">
      <aside id="sqlite-table-sidebar" class="sqlite-sidebar">
        <div class="sqlite-header-section">Tables</div>
        <div id="sqlite-table-container">
          <ul id="sqlite-table-list"></ul>
        </div>
      </aside>

      <main id="sqlite-table-main" class="sqlite-main">
        <div class="sqlite-input-area sqlite-header-section">
          <button class="btn btn-primary" id="sqliteDownloadSqlButton" onclick="sqliteDownloadSql()" disabled>Export Table to SQL</button>
          <button class="btn btn-primary" id="sqliteDownloadAllSqlButton" onclick="sqliteDownloadAllSql()" disabled>Export Database to SQL</button>
          <span class="sql-file-source btn btn-secondary"><span class="sqlite-file-path"></span></span>
        </div>
        <div id="sqlite-output"></div>
      </main>
    </div>
  `}