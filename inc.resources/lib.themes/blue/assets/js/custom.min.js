class UrlSorter{constructor(e=window.location.toString()){this.originalUrl=e,this.originalQueryParams={},this.currentOrderBy="",this.currentOrderType="",this.newOrderBy="",this.newOrderType="",this._parseUrl()}_parseUrl(){let e=this.originalUrl.split("#")[0].split("?");this.baseURL=e[0];let t=e[1]||"",a=this.baseURL.split("/");this.baseName=a[a.length-1]||"";t.split("&").forEach(e=>{let t=e.split("=");""!==t[0]&&(this.originalQueryParams[t[0]]=t[1])}),this.currentOrderBy=this.originalQueryParams.orderby||"",this.currentOrderType=this.originalQueryParams.ordertype||"",this.newOrderBy=this.currentOrderBy,this.newOrderType=this.currentOrderType}getOrderBy(){return this.currentOrderBy}getOrderType(){return this.currentOrderType}setOrderBy(e){this.newOrderBy=e}setOrderType(e){this.newOrderType=e}getOriginalQueryParams(){let e={...this.originalQueryParams};return delete e.orderby,delete e.ordertype,e}buildRelativeUrl(){let e={...this.originalQueryParams};this.newOrderBy?e.orderby=this.newOrderBy:delete e.orderby,this.newOrderType?e.ordertype=this.newOrderType:delete e.ordertype;let t=[];for(let a in e)e.hasOwnProperty(a)&&void 0!==e[a]&&null!==e[a]&&""!==e[a]&&t.push(`${a}=${e[a]}`);let r=t.join("&"),i=this.baseName;return r&&(i+="?"+r),i}}function getFormUrl(e,t){let a=new URLSearchParams;for(let[r,i]of t.entries())a.append(r,i);let n=e.getAttribute("action")||window.location.pathname;return`${n}?${a.toString()}`}function fetchUrl(e,t){fetch(e,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.text()).then(a=>{t.innerHTML=a,history.pushState(null,"",e);let r=t.querySelector("table");r&&makeTableSortable(r);let i=t.querySelector("table tbody");i&&sortDataByDrag(i)}).catch(e=>{console.error("AJAX form error:",e)})}function initDateTimePicker(){$('input[type="date"], input[type="time"], input[type="datetime"], input[type="datetime-local"]').each(function(e,t){let a=$(this),r,i={date:"date",time:"time",datetime:"date-time","datetime-local":"date-time"}[a.attr("type")];if(void 0===a.attr("data-multiple-input")){a.attr("type","text"),a.addClass(`${i}-picker`);let n=`<div class="input-datetime-wrapper ${i}">
        ${a[0].outerHTML}
        </div>`;a.replaceWith(n)}}),$(".date-picker").length&&$(".date-picker").each(function(){let e=$(this).data("mindate")||!1,t=$(this).data("maxdate")||!1;$(this).datetimepicker({minDate:e,maxDate:t,format:"YYYY-MM-DD",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")})}),$(".time-picker").length&&$(".time-picker").datetimepicker({format:"HH:mm:ss",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")}),$(".date-time-picker").length&&$(".date-time-picker").each(function(){let e=$(this).data("mindate")||!1,t=$(this).data("maxdate")||!1;$(this).datetimepicker({minDate:e,maxDate:t,format:"YYYY-MM-DD HH:mm:ss",useCurrent:"day",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")})})}let lastUrl=null;function initSortTable(e="table.table-sort-by-column"){let t=document.querySelectorAll(e);t.forEach(function(e){makeTableSortable(e)})}function makeTableSortable(e){let t=document.location.toString(),a=e.querySelector("thead tr");if(a){let r=a.querySelectorAll("td.order-controll");r.forEach(function(e){let a=e.getAttribute("data-col-name");if(a){let r=new UrlSorter(t);if(a===r.getOrderBy()){let i="desc"===r.getOrderType()?"asc":"desc";r.setOrderType(i),e.setAttribute("data-order-method",r.getOrderType())}else r.setOrderBy(a),r.setOrderType("asc");let n=e.querySelector("a");n&&(n.href=r.buildRelativeUrl())}})}}function initSortData(){document.querySelectorAll("tbody.data-table-manual-sort").forEach(function(e){sortDataByDrag(e)})}function sortDataByDrag(e){Sortable.create(e,{animation:150,scroll:!0,handle:".data-sort-handler",onEnd:function(){updateNumber($(e))}})}function initCheckAll(){document.addEventListener("change",function(e){let t=e.target.closest(".check-master");if(!t)return;let a=t.checked,r=t.dataset.selector;document.querySelectorAll(".check-slave"+r).forEach(function(e){e.checked=a})})}function initMultipleInput(){$("input[data-multi-input]").each(function(e,t){let a=$(this).is('input[type="date"], input[type="time"], input[type="datetime"], input[type="datetime-local"]'),r={maxHeight:120,trimInput:a,clearOnHide:!0,debug:!1};a&&(r.minWidth=260),new PicoTagEditor(t,r,function(e,t,r){if(!a)return;let i=$(e),n={date:"date",time:"time",datetime:"date-time","datetime-local":"date-time"}[i.attr("type")]||"";i.attr("type","text").addClass(`${n}-picker-multiple pico-tag-edit`),i.wrap(`<div class="input-datetime-wrapper ${n}"></div>`),i=$(t).find(".pico-tag-edit"),r.inputElement=i[0];let l=getDatePickerOptions(i,!1);l&&i.datetimepicker(l).on("dp.change",()=>i.datetimepicker("hide")).on("dp.enter",()=>{let e=i.val();""===e.trim()||(r.addTag(e),i.val(""),r.settings.debug||r.waitingForHide(1500))})})})}function getDatePickerOptions(e,t){let a={};return e.hasClass("date-picker-multiple")?a={minDate:e.data("mindate")||!1,maxDate:e.data("maxdate")||!1,format:"YYYY-MM-DD",debug:t}:e.hasClass("time-picker-multiple")?a={format:"HH:mm:ss",debug:t}:e.hasClass("date-time-picker-multiple")&&(a={minDate:e.data("mindate")||!1,maxDate:e.data("maxdate")||!1,format:"YYYY-MM-DD HH:mm:ss",useCurrent:"day",debug:t}),Object.keys(a).length?a:null}function customConfirm({title:e="Confirmation",message:t="Are you sure?",okText:a="OK",cancelText:r="Cancel"}){return new Promise(i=>{document.getElementById("customConfirmTitle").innerText=e,document.getElementById("customConfirmMessage").innerText=t,document.getElementById("customConfirmOk").innerText=a,document.getElementById("customConfirmCancel").innerText=r;let n=document.getElementById("customConfirmOk"),l=document.getElementById("customConfirmCancel"),o=()=>{n.removeEventListener("click",d),l.removeEventListener("click",s)},d=()=>{o(),$("#customConfirmModal").modal("hide"),i(!0)},s=()=>{o(),$("#customConfirmModal").modal("hide"),i(!1)};n.addEventListener("click",d),l.addEventListener("click",s),$("#customConfirmModal").modal("show")})}function initAjaxSupport(){let e=document.createElement("div");e.innerHTML=`
  <div class="modal fade" id="customConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customConfirmTitle">Confirm</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">\xd7</span>
          </button>
        </div>
        <div class="modal-body" id="customConfirmMessage">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="customConfirmOk">OK</button>
          <button type="button" class="btn btn-secondary" id="customConfirmCancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  `,document.querySelector("body").appendChild(e),document.addEventListener("click",function(e){let t=e.target.closest(".data-section");if(!t)return;let a=e.target.closest('button[type="submit"]');if(!a)return;let r=a.closest("form");if(!r)return;let i=r.closest(".data-section"),n=i&&"true"===i.dataset.ajaxSupport,l="true"===a.dataset.confirmation,o=()=>{if(n){let e=new FormData(r);a.name&&e.append(a.name,a.value),fetch(window.location.href,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:e}).then(e=>e.text()).then(e=>{i.innerHTML=e;let t=i.querySelector("table");t&&makeTableSortable(t);let a=i.querySelector("table tbody");a&&sortDataByDrag(a)}).catch(e=>{console.error("AJAX form error:",e)})}else{let t=document.createElement("input");t.type="hidden",t.classList.add("hidden-user-action"),t.style.display="none",t.name=a.name,t.value=a.value,r.appendChild(t),r.submit(),r.removeChild(t)}};if(l){e.preventDefault();let d=a.dataset.onclikTitle||"Confirmation",s=a.dataset.onclikMessage||"Are you sure?",c=a.dataset.okButtonLabel||"OK",u=a.dataset.cancelButtonLabel||"Cancel";customConfirm({title:d,message:s,okText:c,cancelText:u}).then(e=>{e&&o()})}else e.preventDefault(),o()}),document.addEventListener("click",function(e){let t=e.target.closest(".data-section");if(!t)return;let a=e.target.closest(".pagination-number .page-selector a");if(a||(a=e.target.closest(".order-controll a")),!a)return;let r=a.closest(".data-section");if(!r||"true"!==r.dataset.ajaxSupport)return;e.preventDefault();let i=a.getAttribute("href");lastUrl=i,fetch(i,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.text()).then(e=>{r.innerHTML=e,history.pushState(null,"",i);let t=r.querySelector("table");t&&makeTableSortable(t);let a=r.querySelector("table tbody");a&&sortDataByDrag(a)}).catch(e=>{console.error("Pagination AJAX error:",e)})});let t=document.querySelector(".filter-section form");t&&t.addEventListener("submit",function(e){let t=e.target.closest(".page.page-list"),a=t?t.querySelector('.data-section[data-ajax-support="true"]'):null;if(!a)return;let r=e.target,i=r.closest("form");if(!i)return;let n=a&&"true"===a.dataset.ajaxSupport,l="true"===r.dataset.confirmation,o=()=>{if(n){let e=new FormData(i);r.name&&"string"==typeof r.value&&e.append(r.name,r.value);let t=new URLSearchParams;for(let[l,o]of e.entries())t.append(l,o);let d=`${window.location.pathname}?${t.toString()}`;fetchUrl(d,a)}else{if(r.name&&!i.querySelector(`input[name="${r.name}"]`)){let s=document.createElement("input");s.type="hidden",s.name=r.name,s.value=r.value,i.appendChild(s)}i.submit()}};if(l){e.preventDefault();let d=r.dataset.onclikTitle||"Confirmation",s=r.dataset.onclikMessage||"Are you sure?",c=r.dataset.okButtonLabel||"OK",u=r.dataset.cancelButtonLabel||"Cancel";customConfirm({title:d,message:s,okText:c,cancelText:u}).then(e=>{e&&o()})}else e.preventDefault(),o()});let a=document.querySelector(".page.page-list"),r=a?a.querySelector('.data-section[data-ajax-support="true"]'):null;if(r){let i=document.querySelector("#show_require_approval_data");i&&i.addEventListener("click",function(e){e.preventDefault();let t=new FormData(e.target.form);t.append(e.target.name,e.target.value);let a=getFormUrl(e.target.form,t);fetchUrl(a,r)});let n=document.querySelector("#export_data");n&&n.addEventListener("click",function(e){e.preventDefault();let t=new FormData(e.target.form);t.append(e.target.name,e.target.value),window.location=getFormUrl(e.target.form,t)})}window.addEventListener("popstate",function(){let e=document.querySelector('.data-section[data-ajax-support="true"]');if(!e)return;let t=window.location.href;fetch(t,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.text()).then(t=>{e.innerHTML=t;let a=e.querySelector("table");a&&makeTableSortable(a);let r=e.querySelector("table tbody");r&&sortDataByDrag(r)}).catch(e=>{console.error("Failed to reload content on popstate:",e)})})}function initMultipleSelect(){document.querySelectorAll("select[multiple]").forEach(e=>new MultiSelect(e))}function initOrderUrl(e){let t=new URLSearchParams(e),a=t.get("orderby"),r=t.get("ordertype");if(void 0!==a){let i=$("<input />");i.attr("type","hidden"),i.attr("name","orderby"),i.attr("value",a),$('form.filter-form [name="orderby"]').length&&$('form.filter-form [name="orderby"]').remove(),$("form.filter-form").append(i)}if(void 0!==r){let n=$("<input />");n.attr("type","hidden"),n.attr("name","ordertype"),n.attr("value",r),$('form.filter-form [name="ordertype"]').length&&$('form.filter-form [name="ordertype"]').remove(),$("form.filter-form").append(n)}}function updateNumber(e){let t=e.closest("form");t.find("span.new-sort-order").length&&t.find("span.new-sort-order").remove();let a=$("<span />");a.addClass("new-sort-order"),t.append(a);let r=parseInt(e.attr("data-offset")),i=0;e.find("tr").each(function(e){let t=$(this),n=r+ ++i;t.find(".data-number").text(n);let l=t.attr("data-primary-key"),o=$("<input />");o.attr({type:"hidden",name:"new_order[]",value:JSON.stringify({primary_key:l,sort_order:n})}),a.append(o)}),e.closest("form").find('button[name="user_action"][value="sort_order"]').removeAttr("disabled")}function saveOrder(){}function splitWithTail(e,t,a){let r=e.split(t),i=r.slice(a).join(t),n=r.slice(0,a);return n.push(i),n}function initNotifications(e,t,a,r){let i=document.querySelector(e);if(void 0!==t.data){t.data.forEach(e=>{let t=document.createElement("a");t.className="dropdown-item",t.href=e.link,t.innerHTML=`${e.title} <br><small class="text-muted">${e.time}</small>`,t.dataset.id=e.id,i.appendChild(t)});let n="";if(t.totalData>99?n="99+":t.totalData>0&&t.totalData<=99&&(n=t.totalData),i.closest("li.nav-item").setAttribute("data-badge",n),t.data.length>0){let l=document.createElement("div");l.classList.add("menu-separator"),i.appendChild(l)}}else i.closest("li.nav-item").setAttribute("data-badge","");let o=document.createElement("a");o.className="dropdown-item",o.href=a,o.innerHTML=r,i.appendChild(o)}function initMessages(e,t,a,r){let i=document.querySelector(e);if(void 0!==t.data){t.data.forEach(e=>{let t=document.createElement("a");t.className="dropdown-item",t.href=e.link,t.innerHTML=`${e.title} <br><small class="text-muted">${e.time}</small>`,t.dataset.id=e.id,i.appendChild(t)});let n="";if(t.totalData>99?n="99+":t.totalData>0&&t.totalData<=99&&(n=t.totalData),i.closest("li.nav-item").setAttribute("data-badge",n),t.data.length>0){let l=document.createElement("div");l.classList.add("menu-separator"),i.appendChild(l)}}else i.closest("li.nav-item").setAttribute("data-badge","");let o=document.createElement("a");o.className="dropdown-item",o.href=a,o.innerHTML=r,i.appendChild(o)}function initPage(){document.querySelectorAll(".toggle-sidebar").forEach(e=>{e.addEventListener("click",()=>{document.body.clientWidth>=992?document.body.classList.toggle("sidebar-hidden"):document.body.classList.toggle("sidebar-show");let e=document.body.classList.contains("sidebar-hidden");window.localStorage.setItem("MagicAppBuilder.sidebarHidden",e?"true":"false")})}),document.querySelector(".toggle-mode").addEventListener("click",()=>{document.body.classList.toggle("dark-mode"),document.body.classList.toggle("light-mode");let e="";document.body.classList.contains("dark-mode")?(e="dark-mode",document.querySelector('meta[name="theme-color"]').setAttribute("content",themeDark)):(e="light-mode",document.querySelector('meta[name="theme-color"]').setAttribute("content",themeLight)),window.localStorage.setItem("MagicAppBuilder.colorMode",e)})}function camelToSnake(e){return e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1_$2").toLowerCase()}function restoreFormData(e,t,a){document.addEventListener("DOMContentLoaded",()=>{doRestoreFormData(e,t,a)})}function doRestoreFormData(e,t,a){let r=document.querySelector(a);if(!r){console.warn("Form not found:",a);return}for(let[i,n]of(t=camelToSnake(t),Object.entries(e))){let l=camelToSnake(i),o=r.querySelectorAll(`[name="${l}"]`);o.forEach(e=>{let a=e.type;"checkbox"===a?e.checked=Array.isArray(n)?n.includes(e.value):Boolean(n):"radio"===a?e.checked=e.value===n:"SELECT"===e.tagName?Array.from(e.options).forEach(e=>{e.selected=Array.isArray(n)?n.includes(e.value):e.value===n}):e.value=n,l===t?(e.classList.add("is-invalid"),e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus()):e.classList.remove("is-invalid")})}}document.addEventListener("DOMContentLoaded",()=>{initPage(),initCheckAll(),initAjaxSupport(),initMultipleInput(),initDateTimePicker(),initMultipleSelect(),initSortTable(),initSortData(),initOrderUrl(window.location.search)});