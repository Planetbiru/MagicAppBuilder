function getFormUrl(e,t){let a=new URLSearchParams;for(let[i,r]of t.entries())a.append(i,r);let n=e.getAttribute("action")||window.location.pathname;return`${n}?${a.toString()}`}function fetchUrl(e,t){fetch(e,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.text()).then(a=>{t.innerHTML=a,history.pushState(null,"",e);let i=t.querySelector("table");i&&makeTableSortable(i);let r=t.querySelector("table tbody");r&&sortDataByDrag(r)}).catch(e=>{console.error("AJAX form error:",e)})}function initDateTimePicker(){$('input[type="date"], input[type="time"], input[type="datetime"], input[type="datetime-local"]').each(function(e,t){let a=$(this),i,r={date:"date",time:"time",datetime:"date-time","datetime-local":"date-time"}[a.attr("type")];if(void 0===a.attr("data-multiple-input")){a.attr("type","text"),a.addClass(`${r}-picker`);let n=`<div class="input-datetime-wrapper ${r}">
        ${a[0].outerHTML}
        </div>`;a.replaceWith(n)}}),$(".date-picker").length&&$(".date-picker").each(function(){let e=$(this).data("mindate")||!1,t=$(this).data("maxdate")||!1;$(this).datetimepicker({minDate:e,maxDate:t,format:"YYYY-MM-DD",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")})}),$(".time-picker").length&&$(".time-picker").datetimepicker({format:"HH:mm:ss",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")}),$(".date-time-picker").length&&$(".date-time-picker").each(function(){let e=$(this).data("mindate")||!1,t=$(this).data("maxdate")||!1;$(this).datetimepicker({minDate:e,maxDate:t,format:"YYYY-MM-DD HH:mm:ss",useCurrent:"day",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")})})}let lastUrl=null;function initSortTable(e="table.table-sort-by-column"){let t=document.querySelectorAll(e);t.forEach(function(e){makeTableSortable(e)})}function makeTableSortable(e){let t=document.location.toString(),a=e.querySelector("thead tr");if(a){let i=a.querySelectorAll("td.order-controll");i.forEach(function(e){let a=e.getAttribute("data-col-name");if(a){let i=new UrlSorter(t);if(a===i.getOrderBy()){let r="desc"===i.getOrderType()?"asc":"desc";i.setOrderType(r),e.setAttribute("data-order-method",i.getOrderType())}else i.setOrderBy(a),i.setOrderType("asc");let n=e.querySelector("a");n&&(n.href=i.buildRelativeUrl())}})}}function initSortData(){document.querySelectorAll("tbody.data-table-manual-sort").forEach(function(e){sortDataByDrag(e)})}function sortDataByDrag(e){Sortable.create(e,{animation:150,scroll:!0,handle:".data-sort-handler",onEnd:function(){updateNumber($(e))}})}function initCheckAll(){document.addEventListener("change",function(e){let t=e.target.closest(".check-master");if(!t)return;let a=t.checked,i=t.dataset.selector;document.querySelectorAll(".check-slave"+i).forEach(function(e){e.checked=a})})}function initMultipleInput(){$("input[data-multi-input]").each(function(e,t){let a=$(this).is('input[type="date"], input[type="time"], input[type="datetime"], input[type="datetime-local"]'),i={maxHeight:120,trimInput:a,clearOnHide:!0,debug:!1};a&&(i.minWidth=260),new PicoTagEditor(t,i,function(e,t,i){if(!a)return;let r=$(e),n={date:"date",time:"time",datetime:"date-time","datetime-local":"date-time"}[r.attr("type")]||"";r.attr("type","text").addClass(`${n}-picker-multiple pico-tag-edit`),r.wrap(`<div class="input-datetime-wrapper ${n}"></div>`),r=$(t).find(".pico-tag-edit"),i.inputElement=r[0];let l=getDatePickerOptions(r,!1);l&&r.datetimepicker(l).on("dp.change",()=>r.datetimepicker("hide")).on("dp.enter",()=>{let e=r.val();""===e.trim()||(i.addTag(e),r.val(""),i.settings.debug||i.waitingForHide(1500))})})})}function getDatePickerOptions(e,t){let a={};return e.hasClass("date-picker-multiple")?a={minDate:e.data("mindate")||!1,maxDate:e.data("maxdate")||!1,format:"YYYY-MM-DD",debug:t}:e.hasClass("time-picker-multiple")?a={format:"HH:mm:ss",debug:t}:e.hasClass("date-time-picker-multiple")&&(a={minDate:e.data("mindate")||!1,maxDate:e.data("maxdate")||!1,format:"YYYY-MM-DD HH:mm:ss",useCurrent:"day",debug:t}),Object.keys(a).length?a:null}function customConfirm({title:e="Confirmation",message:t="Are you sure?",okText:a="OK",cancelText:i="Cancel"}){return new Promise(r=>{document.getElementById("customConfirmTitle").innerText=e,document.getElementById("customConfirmMessage").innerText=t,document.getElementById("customConfirmOk").innerText=a,document.getElementById("customConfirmCancel").innerText=i;let n=document.getElementById("customConfirmOk"),l=document.getElementById("customConfirmCancel"),o=()=>{n.removeEventListener("click",d),l.removeEventListener("click",s)},d=()=>{o(),$("#customConfirmModal").modal("hide"),r(!0)},s=()=>{o(),$("#customConfirmModal").modal("hide"),r(!1)};n.addEventListener("click",d),l.addEventListener("click",s),$("#customConfirmModal").modal("show")})}function initAjaxSupport(){let e=document.createElement("div");e.innerHTML=`
  <div class="modal fade" id="customConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customConfirmTitle">Confirm</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">\xd7</span>
          </button>
        </div>
        <div class="modal-body" id="customConfirmMessage">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="customConfirmOk">OK</button>
          <button type="button" class="btn btn-secondary" id="customConfirmCancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  `,document.querySelector("body").appendChild(e),document.addEventListener("click",function(e){let t=e.target.closest(".data-section");if(!t)return;let a=e.target.closest('button[type="submit"]');if(!a)return;let i=a.closest("form");if(!i)return;let r=i.closest(".data-section"),n=r&&"true"===r.dataset.ajaxSupport,l="true"===a.dataset.confirmation,o=()=>{if(n){let e=new FormData(i);a.name&&e.append(a.name,a.value),fetch(window.location.href,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:e}).then(e=>e.text()).then(e=>{r.innerHTML=e;let t=r.querySelector("table");t&&makeTableSortable(t);let a=r.querySelector("table tbody");a&&sortDataByDrag(a)}).catch(e=>{console.error("AJAX form error:",e)})}else{let t=document.createElement("input");t.type="hidden",t.classList.add("hidden-user-action"),t.style.display="none",t.name=a.name,t.value=a.value,i.appendChild(t),i.submit(),i.removeChild(t)}};if(l){e.preventDefault();let d=a.dataset.onclikTitle||"Confirmation",s=a.dataset.onclikMessage||"Are you sure?",c=a.dataset.okButtonLabel||"OK",m=a.dataset.cancelButtonLabel||"Cancel";customConfirm({title:d,message:s,okText:c,cancelText:m}).then(e=>{e&&o()})}else e.preventDefault(),o()}),document.addEventListener("click",function(e){let t=e.target.closest(".data-section");if(!t)return;let a=e.target.closest(".pagination-number .page-selector a");if(a||(a=e.target.closest(".order-controll a")),!a)return;let i=a.closest(".data-section");if(!i||"true"!==i.dataset.ajaxSupport)return;e.preventDefault();let r=a.getAttribute("href");lastUrl=r,fetchUrl(r,i)});let t=document.querySelector(".filter-section form");t&&t.addEventListener("submit",function(e){let t=e.target.closest(".page.page-list"),a=t?t.querySelector('.data-section[data-ajax-support="true"]'):null;if(!a)return;let i=e.target,r=i.closest("form");if(!r)return;let n=a&&"true"===a.dataset.ajaxSupport,l="true"===i.dataset.confirmation,o=()=>{if(n){let e=new FormData(r);i.name&&"string"==typeof i.value&&e.append(i.name,i.value);let t=new URLSearchParams;for(let[l,o]of e.entries())t.append(l,o);let d=`${window.location.pathname}?${t.toString()}`;fetchUrl(d,a)}else{if(i.name&&!r.querySelector(`input[name="${i.name}"]`)){let s=document.createElement("input");s.type="hidden",s.name=i.name,s.value=i.value,r.appendChild(s)}r.submit()}};if(l){e.preventDefault();let d=i.dataset.onclikTitle||"Confirmation",s=i.dataset.onclikMessage||"Are you sure?",c=i.dataset.okButtonLabel||"OK",m=i.dataset.cancelButtonLabel||"Cancel";customConfirm({title:d,message:s,okText:c,cancelText:m}).then(e=>{e&&o()})}else e.preventDefault(),o()});let a=document.querySelector(".page.page-list"),i=a?a.querySelector('.data-section[data-ajax-support="true"]'):null;if(i){let r=document.querySelector("#show_require_approval_data");r&&r.addEventListener("click",function(e){e.preventDefault();let t=new FormData(e.target.form);t.append(e.target.name,e.target.value);let a=getFormUrl(e.target.form,t);fetchUrl(a,i)});let n=document.querySelector("#export_data");n&&n.addEventListener("click",function(e){e.preventDefault();let t=new FormData(e.target.form);t.append(e.target.name,e.target.value),window.location=getFormUrl(e.target.form,t)})}window.addEventListener("popstate",function(){let e=document.querySelector('.data-section[data-ajax-support="true"]');if(!e)return;let t=window.location.href;fetchUrl(t,e)})}function initMultipleSelect(){document.querySelectorAll("select[multiple]").forEach(e=>new MultiSelect(e))}function initOrderUrl(e){let t=new URLSearchParams(e),a=t.get("orderby"),i=t.get("ordertype");if(void 0!==a){let r=$("<input />");r.attr("type","hidden"),r.attr("name","orderby"),r.attr("value",a),$('form.filter-form [name="orderby"]').length&&$('form.filter-form [name="orderby"]').remove(),$("form.filter-form").append(r)}if(void 0!==i){let n=$("<input />");n.attr("type","hidden"),n.attr("name","ordertype"),n.attr("value",i),$('form.filter-form [name="ordertype"]').length&&$('form.filter-form [name="ordertype"]').remove(),$("form.filter-form").append(n)}}function updateNumber(e){let t=e.closest("form");t.find("span.new-sort-order").length&&t.find("span.new-sort-order").remove();let a=$("<span />");a.addClass("new-sort-order"),t.append(a);let i=parseInt(e.attr("data-offset")),r=0;e.find("tr").each(function(e){let t=$(this),n=i+ ++r;t.find(".data-number").text(n);let l=t.attr("data-primary-key"),o=$("<input />");o.attr({type:"hidden",name:"new_order[]",value:JSON.stringify({primary_key:l,sort_order:n})}),a.append(o)}),e.closest("form").find('button[name="user_action"][value="sort_order"]').removeAttr("disabled")}function saveOrder(){}function splitWithTail(e,t,a){let i=e.split(t),r=i.slice(a).join(t),n=i.slice(0,a);return n.push(r),n}function initNotifications(e,t,a,i){let r=document.querySelector(e);if(void 0!==t.data){t.data.forEach(e=>{let t=document.createElement("a");t.className="dropdown-item",t.href=e.link,t.innerHTML=`${e.title} <br><small class="text-muted">${e.time}</small>`,t.dataset.id=e.id,r.appendChild(t)});let n="";if(t.totalData>99?n="99+":t.totalData>0&&t.totalData<=99&&(n=t.totalData),r.closest("li.nav-item").setAttribute("data-badge",n),t.data.length>0){let l=document.createElement("div");l.classList.add("menu-separator"),r.appendChild(l)}}else r.closest("li.nav-item").setAttribute("data-badge","");let o=document.createElement("a");o.className="dropdown-item",o.href=a,o.innerHTML=i,r.appendChild(o)}function initMessages(e,t,a,i){let r=document.querySelector(e);if(void 0!==t.data){t.data.forEach(e=>{let t=document.createElement("a");t.className="dropdown-item",t.href=e.link,t.innerHTML=`${e.title} <br><small class="text-muted">${e.time}</small>`,t.dataset.id=e.id,r.appendChild(t)});let n="";if(t.totalData>99?n="99+":t.totalData>0&&t.totalData<=99&&(n=t.totalData),r.closest("li.nav-item").setAttribute("data-badge",n),t.data.length>0){let l=document.createElement("div");l.classList.add("menu-separator"),r.appendChild(l)}}else r.closest("li.nav-item").setAttribute("data-badge","");let o=document.createElement("a");o.className="dropdown-item",o.href=a,o.innerHTML=i,r.appendChild(o)}function initPage(){document.querySelectorAll(".toggle-sidebar").forEach(e=>{e.addEventListener("click",()=>{document.body.clientWidth>=992?document.body.classList.toggle("sidebar-hidden"):document.body.classList.toggle("sidebar-show");let e=document.body.classList.contains("sidebar-hidden");window.localStorage.setItem("MagicAppBuilder.sidebarHidden",e?"true":"false")})}),document.querySelector(".toggle-mode").addEventListener("click",()=>{document.body.classList.toggle("dark-mode"),document.body.classList.toggle("light-mode");let e="";document.body.classList.contains("dark-mode")?(e="dark-mode",document.querySelector('meta[name="theme-color"]').setAttribute("content",themeDark)):(e="light-mode",document.querySelector('meta[name="theme-color"]').setAttribute("content",themeLight)),window.localStorage.setItem("MagicAppBuilder.colorMode",e)})}function camelToSnake(e){return e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1_$2").toLowerCase()}function restoreFormData(e,t,a){document.addEventListener("DOMContentLoaded",()=>{doRestoreFormData(e,t,a)})}function doRestoreFormData(e,t,a){let i=document.querySelector(a);if(!i){console.warn("Form not found:",a);return}for(let[r,n]of(t=camelToSnake(t),Object.entries(e))){let l=camelToSnake(r),o=i.querySelectorAll(`[name="${l}"]`);o.forEach(e=>{let a=e.type;"checkbox"===a?e.checked=Array.isArray(n)?n.includes(e.value):Boolean(n):"radio"===a?e.checked=e.value===n:"SELECT"===e.tagName?Array.from(e.options).forEach(e=>{e.selected=Array.isArray(n)?n.includes(e.value):e.value===n}):e.value=n,l===t?(e.classList.add("is-invalid"),e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus()):e.classList.remove("is-invalid")})}}function initSearchMenu(){let e=$("#sidebarMenu"),t=$("#menuSearchResults"),a=$("#menuSearch");a.on("input",function(){let a=$(this).val().toLowerCase();if(t.empty(),a.length>0)e.hide();else{e.show();return}let i=[];e.find("a").each(function(){let e=$(this),t=e.attr("href"),r=e.text().trim();!(!t||t.startsWith("#"))&&r.toLowerCase().includes(a)&&i.push({text:r,href:t})}),0===i.length?t.append('<li class="list-group-item text-muted">No matches found</li>'):i.forEach(e=>{t.append(`<li class="list-group-item"><a href="${e.href}">${e.text}</a></li>`)})})}document.addEventListener("DOMContentLoaded",()=>{initPage(),initCheckAll(),initAjaxSupport(),initMultipleInput(),initDateTimePicker(),initMultipleSelect(),initSortTable(),initSortData(),initOrderUrl(window.location.search),initSearchMenu()});