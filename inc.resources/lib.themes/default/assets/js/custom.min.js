function getFormUrl(e,t){let a=new URLSearchParams;for(let[r,n]of t.entries())a.append(r,n);let i=e.getAttribute("action")||window.location.pathname;return`${i}?${a.toString()}`}function fetchUrl(e,t){fetch(e,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>{if(401===e.status){let t=document.querySelector(".ajax-login-form");return t&&t.remove(),e.text().then(e=>{console.log(e);let t=document.createElement("div");t.classList.add("ajax-login-form"),t.innerHTML=e,document.body.appendChild(t);let a=t.querySelector(".loginModal");return a?$(a).modal({backdrop:"static",keyboard:!1,show:!0}):console.warn("Login modal element not found in response HTML"),null})}return e.text()}).then(a=>{if(!a)return;t.innerHTML=a,history.pushState(null,"",e);let r=t.querySelector("table");r&&makeTableSortable(r);let n=t.querySelector("table tbody");n&&sortDataByDrag(n)}).catch(e=>{console.error("AJAX form error:",e)})}function loginAjax(){let e;fetch("login.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:`username=${encodeURIComponent(document.querySelector('.loginModal input[name="username"]').value)}&password=${encodeURIComponent(document.querySelector('.loginModal input[name="password"]').value)}`}).then(e=>{if(e.ok)$(".loginModal").modal("hide");else if(401===e.status){let t=document.querySelector(".loginModal .login-error");t&&(t.style.display="block")}else{let a=document.querySelector(".loginModal .login-error");a&&(a.style.display="block"),console.warn("Unexpected login response status:",e.status)}}).catch(e=>{let t=document.querySelector(".loginModal .login-error");t&&(t.style.display="block"),console.error("Login AJAX error:",e)})}function initDateTimePicker(){$('input[type="date"], input[type="time"], input[type="datetime"], input[type="datetime-local"]').each(function(e,t){let a=$(this),r,n={date:"date",time:"time",datetime:"date-time","datetime-local":"date-time"}[a.attr("type")];if(void 0===a.attr("data-multiple-input")){a.attr("type","text"),a.addClass(`${n}-picker`);let i=`<div class="input-datetime-wrapper ${n}">
        ${a[0].outerHTML}
        </div>`;a.replaceWith(i)}}),$(".date-picker").length&&$(".date-picker").each(function(){let e=$(this).data("mindate")||!1,t=$(this).data("maxdate")||!1;$(this).datetimepicker({minDate:e,maxDate:t,format:"YYYY-MM-DD",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")})}),$(".time-picker").length&&$(".time-picker").datetimepicker({format:"HH:mm:ss",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")}),$(".date-time-picker").length&&$(".date-time-picker").each(function(){let e=$(this).data("mindate")||!1,t=$(this).data("maxdate")||!1;$(this).datetimepicker({minDate:e,maxDate:t,format:"YYYY-MM-DD HH:mm:ss",useCurrent:"day",debug:!1}).on("dp.change",function(e){$(this).datetimepicker("hide")})})}let lastUrl=null;function initSortTable(e="table.table-sort-by-column"){let t=document.querySelectorAll(e);t.forEach(function(e){makeTableSortable(e)})}function makeTableSortable(e){let t=document.location.toString(),a=e.querySelector("thead tr");if(a){let r=a.querySelectorAll("td.order-controll");r.forEach(function(e){let a=e.getAttribute("data-col-name");if(a){let r=new UrlSorter(t);if(a===r.getOrderBy()){let n="desc"===r.getOrderType()?"asc":"desc";r.setOrderType(n),e.setAttribute("data-order-method",r.getOrderType())}else r.setOrderBy(a),r.setOrderType("asc");let i=e.querySelector("a");i&&(i.href=r.buildRelativeUrl())}})}}function initSortData(){document.querySelectorAll("tbody.data-table-manual-sort").forEach(function(e){sortDataByDrag(e)})}function sortDataByDrag(e){Sortable.create(e,{animation:150,scroll:!0,handle:".data-sort-handler",onEnd:function(){updateNumber($(e))}})}function initCheckAll(){document.addEventListener("change",function(e){let t=e.target.closest(".check-master");if(!t)return;let a=t.checked,r=t.dataset.selector;document.querySelectorAll(".check-slave"+r).forEach(function(e){e.checked=a})})}function initMultipleInput(){$("input[data-multi-input]").each(function(e,t){let a=$(this).is('input[type="date"], input[type="time"], input[type="datetime"], input[type="datetime-local"]'),r={maxHeight:120,trimInput:a,clearOnHide:!0,debug:!1};a&&(r.minWidth=260),new PicoTagEditor(t,r,function(e,t,r){if(!a)return;let n=$(e),i={date:"date",time:"time",datetime:"date-time","datetime-local":"date-time"}[n.attr("type")]||"";n.attr("type","text").addClass(`${i}-picker-multiple pico-tag-edit`),n.wrap(`<div class="input-datetime-wrapper ${i}"></div>`),n=$(t).find(".pico-tag-edit"),r.inputElement=n[0];let l=getDatePickerOptions(n,!1);l&&n.datetimepicker(l).on("dp.change",()=>n.datetimepicker("hide")).on("dp.enter",()=>{let e=n.val();""===e.trim()||(r.addTag(e),n.val(""),r.settings.debug||r.waitingForHide(1500))})})})}function getDatePickerOptions(e,t){let a={};return e.hasClass("date-picker-multiple")?a={minDate:e.data("mindate")||!1,maxDate:e.data("maxdate")||!1,format:"YYYY-MM-DD",debug:t}:e.hasClass("time-picker-multiple")?a={format:"HH:mm:ss",debug:t}:e.hasClass("date-time-picker-multiple")&&(a={minDate:e.data("mindate")||!1,maxDate:e.data("maxdate")||!1,format:"YYYY-MM-DD HH:mm:ss",useCurrent:"day",debug:t}),Object.keys(a).length?a:null}function customConfirm({title:e="Confirmation",message:t="Are you sure?",okText:a="OK",cancelText:r="Cancel"}){return new Promise(n=>{document.getElementById("customConfirmTitle").innerText=e,document.getElementById("customConfirmMessage").innerText=t,document.getElementById("customConfirmOk").innerText=a,document.getElementById("customConfirmCancel").innerText=r;let i=document.getElementById("customConfirmOk"),l=document.getElementById("customConfirmCancel"),o=()=>{i.removeEventListener("click",d),l.removeEventListener("click",s)},d=()=>{o(),$("#customConfirmModal").modal("hide"),n(!0)},s=()=>{o(),$("#customConfirmModal").modal("hide"),n(!1)};i.addEventListener("click",d),l.addEventListener("click",s),$("#customConfirmModal").modal("show")})}function initAjaxSupport(){let e=document.createElement("div");e.innerHTML=`
  <div class="modal fade" id="customConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customConfirmTitle">Confirm</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">\xd7</span>
          </button>
        </div>
        <div class="modal-body" id="customConfirmMessage">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="customConfirmOk">OK</button>
          <button type="button" class="btn btn-secondary" id="customConfirmCancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  `,document.querySelector("body").appendChild(e),document.addEventListener("click",function(e){let t=e.target.closest(".data-section");if(!t)return;let a=e.target.closest('button[type="submit"]');if(!a)return;let r=a.closest("form");if(!r)return;let n=r.closest(".data-section"),i=n&&"true"===n.dataset.ajaxSupport,l="true"===a.dataset.confirmation,o=()=>{if(i){let e=new FormData(r);a.name&&e.append(a.name,a.value),fetch(window.location.href,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:e}).then(e=>{if(401===e.status){let t=document.querySelector(".ajax-login-form");return t&&t.remove(),e.text().then(e=>{let t=document.createElement("div");t.classList.add("ajax-login-form"),t.innerHTML=e,document.body.appendChild(t);let a=t.querySelector(".loginModal");return a?$(a).modal({backdrop:"static",keyboard:!1,show:!0}):console.warn("Login modal element not found in response HTML"),null})}return e.text()}).then(e=>{if(!e)return;n.innerHTML=e;let t=n.querySelector("table");t&&makeTableSortable(t);let a=n.querySelector("table tbody");a&&sortDataByDrag(a)}).catch(e=>{console.error("AJAX form error:",e)})}else{let t=document.createElement("input");t.type="hidden",t.classList.add("hidden-user-action"),t.style.display="none",t.name=a.name,t.value=a.value,r.appendChild(t),r.submit(),r.removeChild(t)}};if(l){e.preventDefault();let d=a.dataset.onclikTitle||"Confirmation",s=a.dataset.onclikMessage||"Are you sure?",c=a.dataset.okButtonLabel||"OK",u=a.dataset.cancelButtonLabel||"Cancel";customConfirm({title:d,message:s,okText:c,cancelText:u}).then(e=>{e&&o()})}else e.preventDefault(),o()}),document.addEventListener("click",function(e){let t=e.target.closest(".data-section");if(!t)return;let a=e.target.closest(".pagination-number .page-selector a");if(a||(a=e.target.closest(".order-controll a")),!a)return;let r=a.closest(".data-section");if(!r||"true"!==r.dataset.ajaxSupport)return;e.preventDefault();let n=a.getAttribute("href");lastUrl=n,fetchUrl(n,r)});let t=document.querySelector(".filter-section form");t&&t.addEventListener("submit",function(e){let t=e.target.closest(".page.page-list"),a=t?t.querySelector('.data-section[data-ajax-support="true"]'):null;if(!a)return;let r=e.target,n=r.closest("form");if(!n)return;let i=a&&"true"===a.dataset.ajaxSupport,l="true"===r.dataset.confirmation,o=()=>{if(i){let e=new FormData(n);r.name&&"string"==typeof r.value&&e.append(r.name,r.value);let t=new URLSearchParams;for(let[l,o]of e.entries())t.append(l,o);let d=`${window.location.pathname}?${t.toString()}`;fetchUrl(d,a)}else{if(r.name&&!n.querySelector(`input[name="${r.name}"]`)){let s=document.createElement("input");s.type="hidden",s.name=r.name,s.value=r.value,n.appendChild(s)}n.submit()}};if(l){e.preventDefault();let d=r.dataset.onclikTitle||"Confirmation",s=r.dataset.onclikMessage||"Are you sure?",c=r.dataset.okButtonLabel||"OK",u=r.dataset.cancelButtonLabel||"Cancel";customConfirm({title:d,message:s,okText:c,cancelText:u}).then(e=>{e&&o()})}else e.preventDefault(),o()});let a=document.querySelector(".page.page-list"),r=a?a.querySelector('.data-section[data-ajax-support="true"]'):null;if(r){let n=document.querySelector("#show_require_approval_data");n&&n.addEventListener("click",function(e){e.preventDefault();let t=new FormData(e.target.form);t.append(e.target.name,e.target.value);let a=getFormUrl(e.target.form,t);fetchUrl(a,r)});let i=document.querySelector("#export_data");i&&i.addEventListener("click",function(e){e.preventDefault();let t=new FormData(e.target.form);t.append(e.target.name,e.target.value),window.location=getFormUrl(e.target.form,t)})}window.addEventListener("popstate",function(){let e=document.querySelector('.data-section[data-ajax-support="true"]');if(!e)return;let t=window.location.href;fetchUrl(t,e)})}function initMultipleSelect(){document.querySelectorAll("select[multiple]").forEach(e=>new MultiSelect(e))}function initOrderUrl(e){let t=new URLSearchParams(e),a=t.get("orderby"),r=t.get("ordertype");if(void 0!==a){let n=$("<input />");n.attr("type","hidden"),n.attr("name","orderby"),n.attr("value",a),$('form.filter-form [name="orderby"]').length&&$('form.filter-form [name="orderby"]').remove(),$("form.filter-form").append(n)}if(void 0!==r){let i=$("<input />");i.attr("type","hidden"),i.attr("name","ordertype"),i.attr("value",r),$('form.filter-form [name="ordertype"]').length&&$('form.filter-form [name="ordertype"]').remove(),$("form.filter-form").append(i)}}function updateNumber(e){let t=e.closest("form");t.find("span.new-sort-order").length&&t.find("span.new-sort-order").remove();let a=$("<span />");a.addClass("new-sort-order"),t.append(a);let r=parseInt(e.attr("data-offset")),n=0;e.find("tr").each(function(e){let t=$(this),i=r+ ++n;t.find(".data-number").text(i);let l=t.attr("data-primary-key"),o=$("<input />");o.attr({type:"hidden",name:"new_order[]",value:JSON.stringify({primary_key:l,sort_order:i})}),a.append(o)}),e.closest("form").find('button[name="user_action"][value="sort_order"]').removeAttr("disabled")}function saveOrder(){}function splitWithTail(e,t,a){let r=e.split(t),n=r.slice(a).join(t),i=r.slice(0,a);return i.push(n),i}function initNotifications(e,t,a,r){let n=document.querySelector(e);if(void 0!==t.data){t.data.forEach(e=>{let t=document.createElement("a");t.className="dropdown-item",t.href=e.link,t.innerHTML=`${e.title} <br><small class="text-muted">${e.time}</small>`,t.dataset.id=e.id,n.appendChild(t)});let i="";if(t.totalData>99?i="99+":t.totalData>0&&t.totalData<=99&&(i=t.totalData),n.closest("li.nav-item").setAttribute("data-badge",i),t.data.length>0){let l=document.createElement("div");l.classList.add("menu-separator"),n.appendChild(l)}}else n.closest("li.nav-item").setAttribute("data-badge","");let o=document.createElement("a");o.className="dropdown-item",o.href=a,o.innerHTML=r,n.appendChild(o)}function initMessages(e,t,a,r){let n=document.querySelector(e);if(void 0!==t.data){t.data.forEach(e=>{let t=document.createElement("a");t.className="dropdown-item",t.href=e.link,t.innerHTML=`${e.title} <br><small class="text-muted">${e.time}</small>`,t.dataset.id=e.id,n.appendChild(t)});let i="";if(t.totalData>99?i="99+":t.totalData>0&&t.totalData<=99&&(i=t.totalData),n.closest("li.nav-item").setAttribute("data-badge",i),t.data.length>0){let l=document.createElement("div");l.classList.add("menu-separator"),n.appendChild(l)}}else n.closest("li.nav-item").setAttribute("data-badge","");let o=document.createElement("a");o.className="dropdown-item",o.href=a,o.innerHTML=r,n.appendChild(o)}function initPage(){document.querySelectorAll(".toggle-sidebar").forEach(e=>{e.addEventListener("click",()=>{document.body.clientWidth>=992?document.body.classList.toggle("sidebar-hidden"):document.body.classList.toggle("sidebar-show");let e=document.body.classList.contains("sidebar-hidden");window.localStorage.setItem("MagicAppBuilder.sidebarHidden",e?"true":"false")})}),document.querySelector(".toggle-mode").addEventListener("click",()=>{document.body.classList.toggle("dark-mode"),document.body.classList.toggle("light-mode");let e="";document.body.classList.contains("dark-mode")?(e="dark-mode",document.querySelector('meta[name="theme-color"]').setAttribute("content",themeDark)):(e="light-mode",document.querySelector('meta[name="theme-color"]').setAttribute("content",themeLight)),window.localStorage.setItem("MagicAppBuilder.colorMode",e)})}function camelToSnake(e){return e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1_$2").toLowerCase()}function restoreFormData(e,t,a){document.addEventListener("DOMContentLoaded",()=>{doRestoreFormData(e,t,a)})}function doRestoreFormData(e,t,a){let r=document.querySelector(a);if(!r){console.warn("Form not found:",a);return}for(let[n,i]of(t=camelToSnake(t),Object.entries(e))){let l=camelToSnake(n),o=r.querySelectorAll(`[name="${l}"]`);o.forEach(e=>{let a=e.type;"checkbox"===a?e.checked=Array.isArray(i)?i.includes(e.value):Boolean(i):"radio"===a?e.checked=e.value===i:"SELECT"===e.tagName?Array.from(e.options).forEach(e=>{e.selected=Array.isArray(i)?i.includes(e.value):e.value===i}):e.value=i,l===t?(e.classList.add("is-invalid"),e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus()):e.classList.remove("is-invalid")})}}function initSearchMenu(){let e=$("#sidebarMenu"),t=$("#menuSearchResults"),a=$("#menuSearch");a.on("input",function(){let r=$(this).val().toLowerCase();if(t.empty(),r.length>0)e.hide();else{e.show();return}let n=[];e.find("a").each(function(){let e=$(this),t=e.attr("href"),a=e.text().trim();!(!t||t.startsWith("#"))&&a.toLowerCase().includes(r)&&n.push({text:a,href:t})});let i=a.closest(".menu-search-box").attr("data-no-match-found");0===n.length?t.append(`<li class="list-group-item text-muted"><div class="data-no-match-found">${i}</div></li>`):n.forEach(e=>{t.append(`<li class="list-group-item"><a href="${e.href}">${e.text}</a></li>`)})})}document.addEventListener("DOMContentLoaded",()=>{initPage(),initCheckAll(),initAjaxSupport(),initMultipleInput(),initDateTimePicker(),initMultipleSelect(),initSortTable(),initSortData(),initOrderUrl(window.location.search),initSearchMenu()});