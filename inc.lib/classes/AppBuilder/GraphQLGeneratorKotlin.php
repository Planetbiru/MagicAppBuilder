<?php

namespace AppBuilder;
use MagicObject\Util\PicoStringUtil;

/**
 * The `GraphQLGeneratorKotlin` class is a powerful tool designed to automatically generate a complete Spring Boot GraphQL API in Kotlin from a JSON file that defines database entities.
 * It inspects the schema to understand tables, columns, primary keys, and foreign key relationships.
 * Based on this analysis, it produces Kotlin code for entities, repositories, DTOs, and GraphQL controllers, along with GraphQL schema files, and a comprehensive API manual in Markdown format.
 * This class streamlines the process of scaffolding a GraphQL API, reducing manual effort and ensuring consistency between the database schema and the API.
 * 
 * @package AppBuilder
 */
class GraphQLGeneratorKotlin extends GraphQLGeneratorBase
{
    
    /**
     * @var array<string, string> Project configuration for pom.xml and package structure.
     */
    private $projectConfig = array();
    
    /**
     * @var bool Whether to enable verbose logging in the generated application.
     */
    private $verboseLogging = false;
    
    /**
     * @var bool Whether the generated application should require login.
     */
    private $requireLogin = true;

    /**
     * Constructor.
     *
     * @param array $schema Decoded JSON schema.
     * @param array|null $reservedColumns Reserved column definitions.
     * @param array $backendHandledColumns Columns handled by the backend.
     * @param bool $useCache Whether to use in-memory caching for queries.
     * @param array $projectConfig Project configuration details.
     * @param bool $verboseLogging Whether to enable verbose logging.
     * @param bool $requireLogin Whether the generated application should require login.
     */
    public function __construct($schema, $reservedColumns = null, $backendHandledColumns = array(), $useCache = false, $projectConfig = array(), $verboseLogging = false, $requireLogin = true)
    {
        parent::__construct($schema, $reservedColumns, $backendHandledColumns, $useCache);

        $this->projectConfig = array_merge(array(
            'groupId' => 'io.magicapp.generated',
            'artifactId' => 'graphql-app',
            'version' => '0.0.1-SNAPSHOT',
            'name' => 'GraphQL App',
            'description' => 'GraphQL API generated by MagicAppBuilder',
            'kotlinVersion' => '1.9.23', // Kotlin version
            'javaVersion' => '21',
            'packageName' => 'io.magicapp.generated.graphqlapp',
            'verboseLogging' => $verboseLogging,
            'requireLogin' => $requireLogin
        ), $projectConfig);
        
        $this->verboseLogging = $verboseLogging;
        $this->requireLogin = $requireLogin;
    }

    /**
     * Maps a database type to a Kotlin type.
     *
     * @param string $dbType The database column type (e.g., VARCHAR, INT, TIMESTAMP).
     * @param int|null $length The length of the column.
     * @return string The corresponding Kotlin type string.
     */
    private function mapDbTypeToKotlinType($dbType, $length = null)
    {
        $dbType = strtolower($dbType);
        if (strpos($dbType, 'varchar') !== false || strpos($dbType, 'text') !== false) {
            return 'String';
        }
        if (strpos($dbType, 'timestamp') !== false) {
            return 'java.time.LocalDateTime';
        }
        if (strpos($dbType, 'date') !== false) {
            return 'java.time.LocalDate';
        }
        if (strpos($dbType, 'decimal') !== false || strpos($dbType, 'float') !== false || strpos($dbType, 'double') !== false) {
            return 'Double';
        }
        if ((strpos($dbType, 'tinyint') !== false && isset($length) && $length == '1') || strpos($dbType, 'bool') !== false || strpos($dbType, 'bit') !== false) {
            return 'Boolean';
        }
        if (strpos($dbType, 'int') !== false) {
            return 'Int'; // Use Kotlin's Int
        }
        return 'String'; // Default fallback
    }

    /**
     * Generates a markdown manual with examples for all queries and mutations.
     *
     * @return string The markdown content.
     */
    public function generateManual()
    {
        $manualContent = "# GraphQL API Manual\r\n\r\n";
        $manualContent .= "This document provides examples for all available queries and mutations for your Spring Boot application.\r\n\r\n";
        
        $manualContent .= "## Dependencies\r\n\r\n";
        $manualContent .= "All required dependencies are defined in the `build.gradle.kts` file. Gradle will handle downloading them automatically.\r\n\r\n";

        $manualContent .= "## Database Connection\r\n\r\n";
        $manualContent .= "This API requires a database connection. You must configure the `src/main/resources/application.properties` file. Here is an example for connecting to a MySQL database:\r\n\r\n";
        $manualContent .= "```properties\r\n";
        $manualContent .= "spring.datasource.url=jdbc:mysql://localhost:3306/your_database_name\r\n";
        $manualContent .= "spring.datasource.username=your_username\r_n";
        $manualContent .= "spring.datasource.password=your_password\r\n";
        $manualContent .= "```\r\n\r\n";

        $manualContent .= "---\r\n\r\n";

        foreach ($this->analyzedSchema as $tableName => $tableInfo) {
            $camelName = $this->camelCase($tableName);
            $pluralCamelName = $this->pluralize($camelName);
            $ucCamelName = $this->pascalCase($tableName);

            $manualContent .= "## " . $ucCamelName . "\r\n\r\n";

            // --- Get Fields for examples ---
            $fieldsString = $this->getFieldsForManual($tableInfo, false);
            $mutationFieldsString = $this->getFieldsForManual($tableInfo, true); // No relations for mutation return

            // --- Query Examples ---
            $manualContent .= "### Queries\r\n\r\n";

            // Get Single Item
            $manualContent .= "#### Get a single " . $camelName . "\r\n\r\n";
            $manualContent .= "```graphql\r\n";
            $manualContent .= "query Get" . $ucCamelName . " {\r\n";
            $manualContent .= "  " . $camelName . "(id: \"your-" . $camelName . "-id\") {\r\n";
            $manualContent .= $fieldsString;
            $manualContent .= "  }\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";

            // Get List
            $manualContent .= "#### Get a list of " . $pluralCamelName . " (with filter & sort)\r\n\r\n";
            $manualContent .= "Supports `limit`, `offset`, `orderBy`, and `filter`.\r\n\r\n";

            // Find a good column for the filter example
            $filterField = $tableInfo['primaryKey'];
            $filterValue = '"your-' . $camelName . '-id"';
            $filterOperator = 'EQUALS';

            foreach ($tableInfo['columns'] as $columnName => $columnInfo) {
                if (($columnName === 'name' || $columnName === 'title') && !$columnInfo['isForeignKey']) {
                    $filterField = $columnName;
                    $filterValue = '"some-text"';
                    $filterOperator = 'CONTAINS';
                    break;
                }
            }

            $manualContent .= "```graphql\r\n";
            $manualContent .= "query Get" . $this->pascalCase($pluralCamelName) . " {\r\n";
            $manualContent .= "  " . $pluralCamelName . "(\r\n    limit: 10, \r\n    offset: 0, \r\n    orderBy: [{field: \"" . $tableInfo['primaryKey'] . "\", direction: DESC}],\r\n    filter: [{field: \"" . $filterField . "\", value: " . $filterValue . ", operator: " . $filterOperator . "}]\r\n  ) {\r\n";
            $manualContent .= "    items {\r\n";
            $manualContent .= preg_replace('/^/m', '      ', $fieldsString); // Indent fields
            $manualContent .= "    }\r\n";
            $manualContent .= "    total\r\n";
            $manualContent .= "  }\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";

            // --- Mutation Examples ---
            $manualContent .= "### Mutations\r\n\r\n";

            list($inputFieldsString, $inputExampleString) = $this->getInputFieldsForManual($tableInfo);

            // Create
            $manualContent .= "#### Create a new " . $camelName . "\r\n\r\n";
            $manualContent .= "```graphql\r\n";
            $manualContent .= "mutation Create" . $ucCamelName . " {\r\n";
            $manualContent .= "  create" . $ucCamelName . "(input: {\r\n" . $inputExampleString . "  }) {\r\n";
            $manualContent .= $mutationFieldsString;
            $manualContent .= "  }\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";

            // Update
            $manualContent .= "#### Update an existing " . $camelName . "\r\n\r\n";
            $manualContent .= "```graphql\r\n";
            $manualContent .= "mutation Update" . $ucCamelName . " {\r\n";
            $manualContent .= "  update" . $ucCamelName . "(id: \"your-" . $camelName . "-id\", input: {\r\n" . $inputExampleString . "  }) {\r\n";
            $manualContent .= $mutationFieldsString;
            $manualContent .= "  }\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";

            // Delete
            $manualContent .= "#### Delete a " . $camelName . "\r\n\r\n";
            $manualContent .= "Returns `true` on success.\r\n\r\n";
            $manualContent .= "```graphql\r\n";
            $manualContent .= "mutation Delete" . $ucCamelName . " {\r\n";
            $manualContent .= "  delete" . $ucCamelName . "(id: \"your-" . $camelName . "-id\")\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";
        }

        return $manualContent;
    }
    
    
    /**
     * Main function to generate all files for the Spring Boot project.
     *
     * @return array An array of file definitions, each with 'name' and 'content'.
     */
    public function generate()
    {
        $files = array();
        $packagePath = 'src/main/kotlin/' . str_replace('.', '/', $this->projectConfig['packageName']);

        $files[] = ['name' => 'pom.xml', 'content' => $this->generatePom()];
        $files[] = ['name' => 'mvnw.cmd', 'content' => $this->generateMvnwCmd()];
        $files[] = ['name' => 'mvnw', 'content' => $this->generateMvnw()];
        $files[] = ['name' => '.mvn/wrapper\maven-wrapper.properties', 'content' => 'wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
'];

        // 2. Main Application Class
        $files[] = ['name' => $packagePath . '/' . $this->pascalCase($this->projectConfig['artifactId']) . 'Application.kt', 'content' => $this->generateMainAppClass()];

        // 3. GraphQL Schema, Entities, Repositories, DTOs, Controllers
        $allSchemaParts = array();
        $allQueryFields = array();
        $allMutationFields = array();

        foreach ($this->analyzedSchema as $tableName => $tableInfo) {
            $pascalName = $this->pascalCase($tableName);
            $files[] = ['name' => $packagePath . '/model/entity/' . $pascalName . '.kt', 'content' => $this->generateEntityClass($tableName, $tableInfo)];
            $files[] = ['name' => $packagePath . '/model/repository/' . $pascalName . 'Repository.kt', 'content' => $this->generateRepositoryInterface($tableName, $tableInfo)];
            $files[] = ['name' => $packagePath . '/model/dto/' . $pascalName . 'Input.kt', 'content' => $this->generateDtoClass($tableName, $tableInfo)];
            $files[] = ['name' => $packagePath . '/controller/' . $pascalName . 'Controller.kt', 'content' => $this->generateControllerClass($tableName, $tableInfo)];

            $schemaParts = $this->getSchemaPartsForTable($tableName, $tableInfo);
            $allSchemaParts[] = $schemaParts['types'];
            $allQueryFields[] = $schemaParts['queries'];
            $allMutationFields[] = $schemaParts['mutations'];
        }

        // 4. Combined GraphQL Schema
        $files[] = ['name' => 'src/main/resources/graphql/schema.graphqls', 'content' => $this->generateCombinedSchema($allSchemaParts, $allQueryFields, $allMutationFields)];

        $staticFiles = $this->generateStaticFiles($files, $packagePath);
        return array_merge($files, $staticFiles);

        /*
        
        // 4. Utility and DTO classes (converted to Kotlin)
        // Note: The original Java generator has many utility classes. Each needs a Kotlin equivalent.
        // For brevity, I'm showing the conversion pattern with a few key files.
        $files[] = ['name' => $packagePath . '/model/dto/core/FilterInput.kt', 'content' => $this->generateFilterInputDtoKt()];
        $files[] = ['name' => $packagePath . '/model/dto/core/SortInput.kt', 'content' => $this->generateSortInputDtoKt()];
        $files[] = ['name' => $packagePath . '/util/SpecificationBuilder.kt', 'content' => $this->generateSpecificationBuilderKt()];
        $files[] = ['name' => $packagePath . '/util/FilterCriteria.kt', 'content' => $this->generateFilterCriteriaKt()];
        $files[] = ['name' => $packagePath . '/util/SearchOperation.kt', 'content' => $this->generateSearchOperationKt()];
        $files[] = ['name' => $packagePath . '/util/GenericSpecification.kt', 'content' => $this->generateGenericSpecificationKt()];
        $files[] = ['name' => $packagePath . '/util/QueryUtil.kt', 'content' => $this->generateQueryUtilKt()];
        $files[] = ['name' => $packagePath . '/util/AuditTrailUtil.kt', 'content' => $this->generateAuditTrailUtilKt()];
        $files[] = ['name' => $packagePath . '/util/ValueUtil.kt', 'content' => $this->generateValueUtilKt()];
        $files[] = ['name' => $packagePath . '/util/ScalarValueUtil.kt', 'content' => $this->generateScalarValueUtilKt()];

        // 6. Security and Auth files (converted to Kotlin)
        $files[] = ['name' => $packagePath . '/config/SecurityConfig.kt', 'content' => $this->generateSecurityConfigKt()];
        $files[] = ['name' => $packagePath . '/config/CorsConfig.kt', 'content' => $this->generateCorsConfigKt()];
        $files[] = ['name' => $packagePath . '/config/Sha1PasswordEncoder.kt', 'content' => $this->generateSha1PasswordEncoderKt()];
        $files[] = ['name' => $packagePath . '/config/ObjectScalar.kt', 'content' => $this->generateObjectScalarKt()];
        $files[] = ['name' => $packagePath . '/config/GraphQlConfig.kt', 'content' => $this->generateGraphQlConfigKt()];
        
        $files[] = ['name' => $packagePath . '/model/entity/core/Admin.kt', 'content' => $this->generateAdminEntityKt()];
        $files[] = ['name' => $packagePath . '/model/entity/core/AdminLevel.kt', 'content' => $this->generateAdminLevelEntityKt()];
        $files[] = ['name' => $packagePath . '/model/entity/core/Message.kt', 'content' => $this->generateMessageEntityKt()];
        $files[] = ['name' => $packagePath . '/model/entity/core/MessageFolder.kt', 'content' => $this->generateMessageFolderEntityKt()];
        $files[] = ['name' => $packagePath . '/model/entity/core/Notification.kt', 'content' => $this->generateNotificationEntityKt()];
        
        $files[] = ['name' => $packagePath . '/model/repository/core/AdminLevelRepository.kt', 'content' => $this->generateAdminLevelRepositoryKt()];
        $files[] = ['name' => $packagePath . '/model/repository/core/AdminRepository.kt', 'content' => $this->generateAdminRepositoryKt()];
        $files[] = ['name' => $packagePath . '/model/repository/core/MessageFolderRepository.kt', 'content' => $this->generateMessageFolderRepositoryKt()];
        $files[] = ['name' => $packagePath . '/model/repository/core/MessageRepository.kt', 'content' => $this->generateMessageRepositoryKt()];
        $files[] = ['name' => $packagePath . '/model/repository/core/NotificationRepository.kt', 'content' => $this->generateNotificationRepositoryKt()];

        $files[] = ['name' => $packagePath . '/service/JpaUserDetailsService.kt', 'content' => $this->generateUserDetailsServiceKt()];
        $files[] = ['name' => $packagePath . '/controller/dto/LoginRequest.kt', 'content' => $this->generateLoginRequestDtoKt()];
        $files[] = ['name' => $packagePath . '/controller/dto/LoginResponse.kt', 'content' => $this->generateLoginResponseDtoKt()];

        $files[] = ['name' => $packagePath . '/controller/core/AdminController.kt', 'content' => $this->generateAdminController()];
        $files[] = ['name' => $packagePath . '/controller/core/AuthController.kt', 'content' => $this->generateAuthController()];        
        $files[] = ['name' => $packagePath . '/controller/core/FrontendConfigController.kt', 'content' => $this->generateFrontendConfigController()];
        $files[] = ['name' => $packagePath . '/controller/core/MessageController.kt', 'content' => $this->generateMessageController()];
        $files[] = ['name' => $packagePath . '/controller/core/NotificationController.kt', 'content' => $this->generateNotificationController()];
        $files[] = ['name' => $packagePath . '/controller/core/UserProfileController.kt', 'content' => $this->generateUserProfileController()];
        

        return $files;
        */
    }

    private function generateStaticFiles($files, $packagePath)
    {
        $baseDir = dirname(dirname(dirname(__DIR__))) . '/inc.graphql-resources/backend/kotlin/';

        // 5. Utility and DTO classes (converted to Kotlin)
        $files[] = ['name' => $packagePath . '/model/dto/core/FilterInput.kt', 
                    'content' => $this->getKotlinFileTemplate('model/dto/core/FilterInput.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/dto/core/SortInput.kt', 
                    'content' => $this->getKotlinFileTemplate('model/dto/core/SortInput.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/SpecificationBuilder.kt', 
                    'content' => $this->getKotlinFileTemplate('util/SpecificationBuilder.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/FilterCriteria.kt', 
                    'content' => $this->getKotlinFileTemplate('util/FilterCriteria.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/SearchOperation.kt', 
                    'content' => $this->getKotlinFileTemplate('util/SearchOperation.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/GenericSpecification.kt', 
                    'content' => $this->getKotlinFileTemplate('util/GenericSpecification.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/QueryUtil.kt', 
                    'content' => $this->getKotlinFileTemplate('util/QueryUtil.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/AuditTrailUtil.kt', 
                    'content' => $this->getKotlinFileTemplate('util/AuditTrailUtil.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/ValueUtil.kt', 
                    'content' => $this->getKotlinFileTemplate('util/ValueUtil.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/ScalarValueUtil.kt', 
                    'content' => $this->getKotlinFileTemplate('util/ScalarValueUtil.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/util/I18nUtil.kt', 
                    'content' => $this->getKotlinFileTemplate('util/I18nUtil.kt', $this->projectConfig, $baseDir)];


        // 6. Security and Auth files
        $files[] = ['name' => $packagePath . '/config/SecurityConfig.kt', 
                    'content' => $this->getKotlinFileTemplate('config/SecurityConfig.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/config/CorsConfig.kt', 
                    'content' => $this->getKotlinFileTemplate('config/CorsConfig.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/config/Sha1PasswordEncoder.kt', 
                    'content' => $this->getKotlinFileTemplate('config/Sha1PasswordEncoder.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/config/ObjectScalar.kt', 
                    'content' => $this->getKotlinFileTemplate('config/ObjectScalar.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/config/GraphQlConfig.kt', 
                    'content' => $this->getKotlinFileTemplate('config/GraphQlConfig.kt', $this->projectConfig, $baseDir)];


        // Entities
        $files[] = ['name' => $packagePath . '/model/entity/core/Admin.kt',
                    'content' => $this->getKotlinFileTemplate('model/entity/core/Admin.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/entity/core/AdminLevel.kt',
                    'content' => $this->getKotlinFileTemplate('model/entity/core/AdminLevel.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/entity/core/Message.kt',
                    'content' => $this->getKotlinFileTemplate('model/entity/core/Message.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/entity/core/MessageFolder.kt',
                    'content' => $this->getKotlinFileTemplate('model/entity/core/MessageFolder.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/entity/core/Notification.kt',
                    'content' => $this->getKotlinFileTemplate('model/entity/core/Notification.kt', $this->projectConfig, $baseDir)];


        // Repositories
        $files[] = ['name' => $packagePath . '/model/repository/core/AdminLevelRepository.kt', 
                    'content' => $this->getKotlinFileTemplate('model/repository/core/AdminLevelRepository.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/repository/core/AdminRepository.kt', 
                    'content' => $this->getKotlinFileTemplate('model/repository/core/AdminRepository.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/repository/core/MessageFolderRepository.kt', 
                    'content' => $this->getKotlinFileTemplate('model/repository/core/MessageFolderRepository.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/repository/core/MessageRepository.kt', 
                    'content' => $this->getKotlinFileTemplate('model/repository/core/MessageRepository.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/model/repository/core/NotificationRepository.kt', 
                    'content' => $this->getKotlinFileTemplate('model/repository/core/NotificationRepository.kt', $this->projectConfig, $baseDir)];


        // Services & DTOs
        $files[] = ['name' => $packagePath . '/service/JpaUserDetailsService.kt', 
                    'content' => $this->getKotlinFileTemplate('service/JpaUserDetailsService.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/controller/dto/LoginRequest.kt', 
                    'content' => $this->getKotlinFileTemplate('controller/dto/LoginRequest.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/controller/dto/LoginResponse.kt', 
                    'content' => $this->getKotlinFileTemplate('controller/dto/LoginResponse.kt', $this->projectConfig, $baseDir)];


        // Controllers
        $files[] = ['name' => $packagePath . '/controller/core/AdminController.kt', 
                    'content' => $this->getKotlinFileTemplate('controller/core/AdminController.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/controller/core/AuthController.kt', 
                    'content' => $this->getKotlinFileTemplate('controller/core/AuthController.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/controller/core/FrontendConfigController.kt', 
                    'content' => $this->getKotlinFileTemplate('controller/core/FrontendConfigController.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/controller/core/MessageController.kt', 
                    'content' => $this->getKotlinFileTemplate('controller/core/MessageController.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/controller/core/NotificationController.kt', 
                    'content' => $this->getKotlinFileTemplate('controller/core/NotificationController.kt', $this->projectConfig, $baseDir)];

        $files[] = ['name' => $packagePath . '/controller/core/UserProfileController.kt', 
                    'content' => $this->getKotlinFileTemplate('controller/core/UserProfileController.kt', $this->projectConfig, $baseDir)];

        return $files;
    }

    /**
     * Loads a Kotlin template file, applies package prefix detection,
     * replaces placeholders using projectConfig, and returns the processed content.
     *
     * @param string $path           Path relative to "templates/kotlin/" (e.g. "util/QueryUtil.kt")
     * @param array  $projectConfig  Configuration array for placeholder replacement
     *
     * @return string Processed Kotlin content
     * @throws Exception If template file is not found
     */
    public function getKotlinFileTemplate($path, $projectConfig, $baseDir)
    {
        
        $templateFile = $baseDir . $path;

        if (!file_exists($templateFile)) {
            throw new \Exception("Template not found: " . $templateFile);
        }

        // Load file
        $content = file_get_contents($templateFile);

        $content = str_replace('com.planetbiru.graphqlapplication', $projectConfig['packageName'], $content);

        return $content;
    }


    private function generateMvnw()
    {
        return <<<CMD
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.4
#
# Optional ENV vars
# -----------------
#   JAVA_HOME - location of a JDK home dir, required when download maven via java source
#   MVNW_REPOURL - repo url base for downloading maven distribution
#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output
# ----------------------------------------------------------------------------

set -euf
[ "\${MVNW_VERBOSE-}" != debug ] || set -x

# OS specific support.
native_path() { printf %s\\n "\$1"; }
case "\$(uname)" in
CYGWIN* | MINGW*)
  [ -z "\${JAVA_HOME-}" ] || JAVA_HOME="\$(cygpath --unix "\$JAVA_HOME")"
  native_path() { cygpath --path --windows "\$1"; }
  ;;
esac

# set JAVACMD and JAVACCMD
set_java_home() {
  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched
  if [ -n "\${JAVA_HOME-}" ]; then
    if [ -x "\$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="\$JAVA_HOME/jre/sh/java"
      JAVACCMD="\$JAVA_HOME/jre/sh/javac"
    else
      JAVACMD="\$JAVA_HOME/bin/java"
      JAVACCMD="\$JAVA_HOME/bin/javac"

      if [ ! -x "\$JAVACMD" ] || [ ! -x "\$JAVACCMD" ]; then
        echo "The JAVA_HOME environment variable is not defined correctly, so mvnw cannot run." >&2
        echo "JAVA_HOME is set to \"\$JAVA_HOME\", but \"\\\$JAVA_HOME/bin/java\" or \"\\\$JAVA_HOME/bin/javac\" does not exist." >&2
        return 1
      fi
    fi
  else
    JAVACMD="\$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v java
    )" || :
    JAVACCMD="\$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v javac
    )" || :

    if [ ! -x "\${JAVACMD-}" ] || [ ! -x "\${JAVACCMD-}" ]; then
      echo "The java/javac command does not exist in PATH nor is JAVA_HOME set, so mvnw cannot run." >&2
      return 1
    fi
  fi
}

# hash string like Java String::hashCode
hash_string() {
  str="\${1:-}" h=0
  while [ -n "\$str" ]; do
    char="\${str%"\${str#?}"}"
    h=\$(((h * 31 + \$(LC_CTYPE=C printf %d "'\$char")) % 4294967296))
    str="\${str#?}"
  done
  printf %x\\n \$h
}

verbose() { :; }
[ "\${MVNW_VERBOSE-}" != true ] || verbose() { printf %s\\n "\${1-}"; }

die() {
  printf %s\\n "\$1" >&2
  exit 1
}

trim() {
  # MWRAPPER-139:
  #   Trims trailing and leading whitespace, carriage returns, tabs, and linefeeds.
  #   Needed for removing poorly interpreted newline sequences when running in more
  #   exotic environments such as mingw bash on Windows.
  printf "%s" "\${1}" | tr -d '[:space:]'
}

scriptDir="\$(dirname "\$0")"
scriptName="\$(basename "\$0")"

# parse distributionUrl and optional distributionSha256Sum, requires .mvn/wrapper/maven-wrapper.properties
while IFS="=" read -r key value; do
  case "\${key-}" in
  distributionUrl) distributionUrl=\$(trim "\${value-}") ;;
  distributionSha256Sum) distributionSha256Sum=\$(trim "\${value-}") ;;
  esac
done <"\$scriptDir/.mvn/wrapper/maven-wrapper.properties"
[ -n "\${distributionUrl-}" ] || die "cannot read distributionUrl property in \$scriptDir/.mvn/wrapper/maven-wrapper.properties"

case "\${distributionUrl##*/}" in
maven-mvnd-*bin.*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  case "\${PROCESSOR_ARCHITECTURE-}\${PROCESSOR_ARCHITEW6432-}:\$(uname -a)" in
  *AMD64:CYGWIN* | *AMD64:MINGW*) distributionPlatform=windows-amd64 ;;
  :Darwin*x86_64) distributionPlatform=darwin-amd64 ;;
  :Darwin*arm64) distributionPlatform=darwin-aarch64 ;;
  :Linux*x86_64*) distributionPlatform=linux-amd64 ;;
  *)
    echo "Cannot detect native platform for mvnd on \$(uname)-\$(uname -m), use pure java version" >&2
    distributionPlatform=linux-amd64
    ;;
  esac
  distributionUrl="\${distributionUrl%-bin.*}-\$distributionPlatform.zip"
  ;;
maven-mvnd-*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;
*) MVN_CMD="mvn\${scriptName#mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;
esac

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
[ -z "\${MVNW_REPOURL-}" ] || distributionUrl="\$MVNW_REPOURL\$_MVNW_REPO_PATTERN\${distributionUrl#*"\$_MVNW_REPO_PATTERN"}"
distributionUrlName="\${distributionUrl##*/}"
distributionUrlNameMain="\${distributionUrlName%.*}"
distributionUrlNameMain="\${distributionUrlNameMain%-bin}"
MAVEN_USER_HOME="\${MAVEN_USER_HOME:-\${HOME}/.m2}"
MAVEN_HOME="\${MAVEN_USER_HOME}/wrapper/dists/\${distributionUrlNameMain-}/\$(hash_string "\$distributionUrl")"

exec_maven() {
  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :
  exec "\$MAVEN_HOME/bin/\$MVN_CMD" "\$@" || die "cannot exec \$MAVEN_HOME/bin/\$MVN_CMD"
}

if [ -d "\$MAVEN_HOME" ]; then
  verbose "found existing MAVEN_HOME at \$MAVEN_HOME"
  exec_maven "\$@"
fi

case "\${distributionUrl-}" in
*?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;
*) die "distributionUrl is not valid, must match *-bin.zip or maven-mvnd-*.zip, but found '\${distributionUrl-}'" ;;
esac

# prepare tmp dir
if TMP_DOWNLOAD_DIR="\$(mktemp -d)" && [ -d "\$TMP_DOWNLOAD_DIR" ]; then
  clean() { rm -rf -- "\$TMP_DOWNLOAD_DIR"; }
  trap clean HUP INT TERM EXIT
else
  die "cannot create temp dir"
fi

mkdir -p -- "\${MAVEN_HOME%/*}"

# Download and Install Apache Maven
verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
verbose "Downloading from: \$distributionUrl"
verbose "Downloading to: \$TMP_DOWNLOAD_DIR/\$distributionUrlName"

# select .zip or .tar.gz
if ! command -v unzip >/dev/null; then
  distributionUrl="\${distributionUrl%.zip}.tar.gz"
  distributionUrlName="\${distributionUrl##*/}"
fi

# verbose opt
__MVNW_QUIET_WGET=--quiet __MVNW_QUIET_CURL=--silent __MVNW_QUIET_UNZIP=-q __MVNW_QUIET_TAR=''
[ "\${MVNW_VERBOSE-}" != true ] || __MVNW_QUIET_WGET='' __MVNW_QUIET_CURL='' __MVNW_QUIET_UNZIP='' __MVNW_QUIET_TAR=v

# normalize http auth
case "\${MVNW_PASSWORD:+has-password}" in
'') MVNW_USERNAME='' MVNW_PASSWORD='' ;;
has-password) [ -n "\${MVNW_USERNAME-}" ] || MVNW_USERNAME='' MVNW_PASSWORD='' ;;
esac

if [ -z "\${MVNW_USERNAME-}" ] && command -v wget >/dev/null; then
  verbose "Found wget ... using wget"
  wget \${__MVNW_QUIET_WGET:+"\$__MVNW_QUIET_WGET"} "\$distributionUrl" -O "\$TMP_DOWNLOAD_DIR/\$distributionUrlName" || die "wget: Failed to fetch \$distributionUrl"
elif [ -z "\${MVNW_USERNAME-}" ] && command -v curl >/dev/null; then
  verbose "Found curl ... using curl"
  curl \${__MVNW_QUIET_CURL:+"\$__MVNW_QUIET_CURL"} -f -L -o "\$TMP_DOWNLOAD_DIR/\$distributionUrlName" "\$distributionUrl" || die "curl: Failed to fetch \$distributionUrl"
elif set_java_home; then
  verbose "Falling back to use Java to download"
  javaSource="\$TMP_DOWNLOAD_DIR/Downloader.java"
  targetZip="\$TMP_DOWNLOAD_DIR/\$distributionUrlName"
  cat >"\$javaSource" <<-END
	public class Downloader extends java.net.Authenticator
	{
	  protected java.net.PasswordAuthentication getPasswordAuthentication()
	  {
	    return new java.net.PasswordAuthentication( System.getenv( "MVNW_USERNAME" ), System.getenv( "MVNW_PASSWORD" ).toCharArray() );
	  }
	  public static void main( String[] args ) throws Exception
	  {
	    setDefault( new Downloader() );
	    java.nio.file.Files.copy( java.net.URI.create( args[0] ).toURL().openStream(), java.nio.file.Paths.get( args[1] ).toAbsolutePath().normalize() );
	  }
	}
	END
  # For Cygwin/MinGW, switch paths to Windows format before running javac and java
  verbose " - Compiling Downloader.java ..."
  "\$(native_path "\$JAVACCMD")" "\$(native_path "\$javaSource")" || die "Failed to compile Downloader.java"
  verbose " - Running Downloader.java ..."
  "\$(native_path "\$JAVACMD")" -cp "\$(native_path "\$TMP_DOWNLOAD_DIR")" Downloader "\$distributionUrl" "\$(native_path "\$targetZip")"
fi

# If specified, validate the SHA-256 sum of the Maven distribution zip file
if [ -n "\${distributionSha256Sum-}" ]; then
  distributionSha256Result=false
  if [ "\$MVN_CMD" = mvnd.sh ]; then
    echo "Checksum validation is not supported for maven-mvnd." >&2
    echo "Please disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  elif command -v sha256sum >/dev/null; then
    if echo "\$distributionSha256Sum  \$TMP_DOWNLOAD_DIR/\$distributionUrlName" | sha256sum -c - >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  elif command -v shasum >/dev/null; then
    if echo "\$distributionSha256Sum  \$TMP_DOWNLOAD_DIR/\$distributionUrlName" | shasum -a 256 -c >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  else
    echo "Checksum validation was requested but neither 'sha256sum' or 'shasum' are available." >&2
    echo "Please install either command, or disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  fi
  if [ \$distributionSha256Result = false ]; then
    echo "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised." >&2
    echo "If you updated your Maven version, you need to update the specified distributionSha256Sum property." >&2
    exit 1
  fi
fi

# unzip and move
if command -v unzip >/dev/null; then
  unzip \${__MVNW_QUIET_UNZIP:+"\$__MVNW_QUIET_UNZIP"} "\$TMP_DOWNLOAD_DIR/\$distributionUrlName" -d "\$TMP_DOWNLOAD_DIR" || die "failed to unzip"
else
  tar xzf\${__MVNW_QUIET_TAR:+"\$__MVNW_QUIET_TAR"} "\$TMP_DOWNLOAD_DIR/\$distributionUrlName" -C "\$TMP_DOWNLOAD_DIR" || die "failed to untar"
fi

# Find the actual extracted directory name (handles snapshots where filename != directory name)
actualDistributionDir=""

# First try the expected directory name (for regular distributions)
if [ -d "\$TMP_DOWNLOAD_DIR/\$distributionUrlNameMain" ]; then
  if [ -f "\$TMP_DOWNLOAD_DIR/\$distributionUrlNameMain/bin/\$MVN_CMD" ]; then
    actualDistributionDir="\$distributionUrlNameMain"
  fi
fi

# If not found, search for any directory with the Maven executable (for snapshots)
if [ -z "\$actualDistributionDir" ]; then
  # enable globbing to iterate over items
  set +f
  for dir in "\$TMP_DOWNLOAD_DIR"/*; do
    if [ -d "\$dir" ]; then
      if [ -f "\$dir/bin/\$MVN_CMD" ]; then
        actualDistributionDir="\$(basename "\$dir")"
        break
      fi
    fi
  done
  set -f
fi

if [ -z "\$actualDistributionDir" ]; then
  verbose "Contents of \$TMP_DOWNLOAD_DIR:"
  verbose "\$(ls -la "\$TMP_DOWNLOAD_DIR")"
  die "Could not find Maven distribution directory in extracted archive"
fi

verbose "Found extracted Maven distribution directory: \$actualDistributionDir"
printf %s\\n "\$distributionUrl" >"\$TMP_DOWNLOAD_DIR/\$actualDistributionDir/mvnw.url"
mv -- "\$TMP_DOWNLOAD_DIR/\$actualDistributionDir" "\$MAVEN_HOME" || [ -d "\$MAVEN_HOME" ] || die "fail to move MAVEN_HOME"

clean || :
exec_maven "\$@"
CMD;
    }

    private function generatePom()
    {
        $package = $this->projectConfig['packageName'];
        return <<<POM
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.5</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.planetbiru.graphqlapplication</groupId>
    <artifactId>graphql-application</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>GraphQL Application</name>
    <description>GraphQL Application</description>
    <properties>
        <java.version>21</java.version>
        <kotlin.version>1.9.23</kotlin.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-graphql</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.session</groupId>
            <artifactId>spring-session-data-redis</artifactId>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.module</groupId>
            <artifactId>jackson-module-kotlin</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-reflect</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-stdlib</artifactId>
        </dependency>

        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.mariadb.jdbc</groupId>
            <artifactId>mariadb-java-client</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>com.microsoft.sqlserver</groupId>
            <artifactId>mssql-jdbc</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.xerial</groupId>
            <artifactId>sqlite-jdbc</artifactId>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-webflux</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.graphql</groupId>
            <artifactId>spring-graphql-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <sourceDirectory>\${project.basedir}/src/main/kotlin</sourceDirectory>
        <testSourceDirectory>\${project.basedir}/src/test/kotlin</testSourceDirectory>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
            <plugin>
                <groupId>org.jetbrains.kotlin</groupId>
                <artifactId>kotlin-maven-plugin</artifactId>
                <version>\${kotlin.version}</version>
                <executions>
                    <execution>
                        <id>compile</id>
                        <phase>compile</phase>
                        <goals>
                            <goal>compile</goal>
                        </goals>
                    </execution>
                    <execution>
                        <id>test-compile</id>
                        <phase>test-compile</phase>
                        <goals> <goal>test-compile</goal> </goals>
                    </execution>
                </executions>
                <configuration>
                    <args>
                        <arg>-Xjsr305=strict</arg>
                    </args>
                    <compilerPlugins>
                        <plugin>all-open</plugin>
                        <plugin>no-arg</plugin>
                    </compilerPlugins>
                    <pluginOptions>
                        <option>all-open:annotation=org.springframework.stereotype.Component</option>
                        <option>all-open:annotation=org.springframework.transaction.annotation.Transactional</option>
                        <option>all-open:annotation=org.springframework.scheduling.annotation.Async</option>
                        <option>all-open:annotation=org.springframework.cache.annotation.Cacheable</option>
                        <option>all-open:annotation=org.springframework.boot.test.context.SpringBootTest</option>
                        <option>all-open:annotation=org.springframework.validation.annotation.Validated</option>
                        <option>no-arg:annotation=jakarta.persistence.Entity</option>
                    </pluginOptions>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>org.jetbrains.kotlin</groupId>
                        <artifactId>kotlin-maven-allopen</artifactId>
                        <version>\${kotlin.version}</version>
                    </dependency>
                    <dependency>
                        <groupId>org.jetbrains.kotlin</groupId>
                        <artifactId>kotlin-maven-noarg</artifactId>
                        <version>\${kotlin.version}</version>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>
    </build>

</project>
POM;
    }

    private function generateMvnwCmd()
    {
        return <<<CMD
<# : batch portion
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    http://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Apache Maven Wrapper startup batch script, version 3.3.4
@REM
@REM Optional ENV vars
@REM   MVNW_REPOURL - repo url base for downloading maven distribution
@REM   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
@REM   MVNW_VERBOSE - true: enable verbose log; others: silence the output
@REM ----------------------------------------------------------------------------

@IF "%__MVNW_ARG0_NAME__%"=="" (SET __MVNW_ARG0_NAME__=%~nx0)
@SET __MVNW_CMD__=
@SET __MVNW_ERROR__=
@SET __MVNW_PSMODULEP_SAVE=%PSModulePath%
@SET PSModulePath=
@FOR /F "usebackq tokens=1* delims==" %%A IN (`powershell -noprofile "& {\$scriptDir='%~dp0'; \$script='%__MVNW_ARG0_NAME__%'; icm -ScriptBlock ([Scriptblock]::Create((Get-Content -Raw '%~f0'))) -NoNewScope}"`) DO @(
  IF "%%A"=="MVN_CMD" (set __MVNW_CMD__=%%B) ELSE IF "%%B"=="" (echo %%A) ELSE (echo %%A=%%B)
)
@SET PSModulePath=%__MVNW_PSMODULEP_SAVE%
@SET __MVNW_PSMODULEP_SAVE=
@SET __MVNW_ARG0_NAME__=
@SET MVNW_USERNAME=
@SET MVNW_PASSWORD=
@IF NOT "%__MVNW_CMD__%"=="" ("%__MVNW_CMD__%" %*)
@echo Cannot start maven from wrapper >&2 && exit /b 1
@GOTO :EOF
: end batch / begin powershell #>

\$ErrorActionPreference = "Stop"
if (\$env:MVNW_VERBOSE -eq "true") {
  \$VerbosePreference = "Continue"
}

# calculate distributionUrl, requires .mvn/wrapper/maven-wrapper.properties
\$distributionUrl = (Get-Content -Raw "\$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionUrl
if (!\$distributionUrl) {
  Write-Error "cannot read distributionUrl property in \$scriptDir/.mvn/wrapper/maven-wrapper.properties"
}

switch -wildcard -casesensitive ( \$(\$distributionUrl -replace '^.*/','') ) {
  "maven-mvnd-*" {
    \$USE_MVND = \$true
    \$distributionUrl = \$distributionUrl -replace '-bin\.[^.]*\$',"-windows-amd64.zip"
    \$MVN_CMD = "mvnd.cmd"
    break
  }
  default {
    \$USE_MVND = \$false
    \$MVN_CMD = \$script -replace '^mvnw','mvn'
    break
  }
}

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
if (\$env:MVNW_REPOURL) {
  \$MVNW_REPO_PATTERN = if (\$USE_MVND -eq \$False) { "/org/apache/maven/" } else { "/maven/mvnd/" }
  \$distributionUrl = "\$env:MVNW_REPOURL\$MVNW_REPO_PATTERN\$(\$distributionUrl -replace "^.*\$MVNW_REPO_PATTERN",'')"
}
\$distributionUrlName = \$distributionUrl -replace '^.*/',''
\$distributionUrlNameMain = \$distributionUrlName -replace '\.[^.]*\$','' -replace '-bin\$',''

\$MAVEN_M2_PATH = "\$HOME/.m2"
if (\$env:MAVEN_USER_HOME) {
  \$MAVEN_M2_PATH = "\$env:MAVEN_USER_HOME"
}

if (-not (Test-Path -Path \$MAVEN_M2_PATH)) {
    New-Item -Path \$MAVEN_M2_PATH -ItemType Directory | Out-Null
}

\$MAVEN_WRAPPER_DISTS = \$null
if ((Get-Item \$MAVEN_M2_PATH).Target[0] -eq \$null) {
  \$MAVEN_WRAPPER_DISTS = "\$MAVEN_M2_PATH/wrapper/dists"
} else {
  \$MAVEN_WRAPPER_DISTS = (Get-Item \$MAVEN_M2_PATH).Target[0] + "/wrapper/dists"
}

\$MAVEN_HOME_PARENT = "\$MAVEN_WRAPPER_DISTS/\$distributionUrlNameMain"
\$MAVEN_HOME_NAME = ([System.Security.Cryptography.SHA256]::Create().ComputeHash([byte[]][char[]]\$distributionUrl) | ForEach-Object {\$_.ToString("x2")}) -join ''
\$MAVEN_HOME = "\$MAVEN_HOME_PARENT/\$MAVEN_HOME_NAME"

if (Test-Path -Path "\$MAVEN_HOME" -PathType Container) {
  Write-Verbose "found existing MAVEN_HOME at \$MAVEN_HOME"
  Write-Output "MVN_CMD=\$MAVEN_HOME/bin/\$MVN_CMD"
  exit \$?
}

if (! \$distributionUrlNameMain -or (\$distributionUrlName -eq \$distributionUrlNameMain)) {
  Write-Error "distributionUrl is not valid, must end with *-bin.zip, but found \$distributionUrl"
}

# prepare tmp dir
\$TMP_DOWNLOAD_DIR_HOLDER = New-TemporaryFile
\$TMP_DOWNLOAD_DIR = New-Item -Itemtype Directory -Path "\$TMP_DOWNLOAD_DIR_HOLDER.dir"
\$TMP_DOWNLOAD_DIR_HOLDER.Delete() | Out-Null
trap {
  if (\$TMP_DOWNLOAD_DIR.Exists) {
    try { Remove-Item \$TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
    catch { Write-Warning "Cannot remove \$TMP_DOWNLOAD_DIR" }
  }
}

New-Item -Itemtype Directory -Path "\$MAVEN_HOME_PARENT" -Force | Out-Null

# Download and Install Apache Maven
Write-Verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
Write-Verbose "Downloading from: \$distributionUrl"
Write-Verbose "Downloading to: \$TMP_DOWNLOAD_DIR/\$distributionUrlName"

\$webclient = New-Object System.Net.WebClient
if (\$env:MVNW_USERNAME -and \$env:MVNW_PASSWORD) {
  \$webclient.Credentials = New-Object System.Net.NetworkCredential(\$env:MVNW_USERNAME, \$env:MVNW_PASSWORD)
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
\$webclient.DownloadFile(\$distributionUrl, "\$TMP_DOWNLOAD_DIR/\$distributionUrlName") | Out-Null

# If specified, validate the SHA-256 sum of the Maven distribution zip file
\$distributionSha256Sum = (Get-Content -Raw "\$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionSha256Sum
if (\$distributionSha256Sum) {
  if (\$USE_MVND) {
    Write-Error "Checksum validation is not supported for maven-mvnd. `nPlease disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties."
  }
  Import-Module \$PSHOME\Modules\Microsoft.PowerShell.Utility -Function Get-FileHash
  if ((Get-FileHash "\$TMP_DOWNLOAD_DIR/\$distributionUrlName" -Algorithm SHA256).Hash.ToLower() -ne \$distributionSha256Sum) {
    Write-Error "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised. If you updated your Maven version, you need to update the specified distributionSha256Sum property."
  }
}

# unzip and move
Expand-Archive "\$TMP_DOWNLOAD_DIR/\$distributionUrlName" -DestinationPath "\$TMP_DOWNLOAD_DIR" | Out-Null

# Find the actual extracted directory name (handles snapshots where filename != directory name)
\$actualDistributionDir = ""

# First try the expected directory name (for regular distributions)
\$expectedPath = Join-Path "\$TMP_DOWNLOAD_DIR" "\$distributionUrlNameMain"
\$expectedMvnPath = Join-Path "\$expectedPath" "bin/\$MVN_CMD"
if ((Test-Path -Path \$expectedPath -PathType Container) -and (Test-Path -Path \$expectedMvnPath -PathType Leaf)) {
  \$actualDistributionDir = \$distributionUrlNameMain
}

# If not found, search for any directory with the Maven executable (for snapshots)
if (!\$actualDistributionDir) {
  Get-ChildItem -Path "\$TMP_DOWNLOAD_DIR" -Directory | ForEach-Object {
    \$testPath = Join-Path \$_.FullName "bin/\$MVN_CMD"
    if (Test-Path -Path \$testPath -PathType Leaf) {
      \$actualDistributionDir = \$_.Name
    }
  }
}

if (!\$actualDistributionDir) {
  Write-Error "Could not find Maven distribution directory in extracted archive"
}

Write-Verbose "Found extracted Maven distribution directory: \$actualDistributionDir"
Rename-Item -Path "\$TMP_DOWNLOAD_DIR/\$actualDistributionDir" -NewName \$MAVEN_HOME_NAME | Out-Null
try {
  Move-Item -Path "\$TMP_DOWNLOAD_DIR/\$MAVEN_HOME_NAME" -Destination \$MAVEN_HOME_PARENT | Out-Null
} catch {
  if (! (Test-Path -Path "\$MAVEN_HOME" -PathType Container)) {
    Write-Error "fail to move MAVEN_HOME"
  }
} finally {
  try { Remove-Item \$TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
  catch { Write-Warning "Cannot remove \$TMP_DOWNLOAD_DIR" }
}

Write-Output "MVN_CMD=\$MAVEN_HOME/bin/\$MVN_CMD"
CMD;
    }

    /**
     * Generates the application.properties file.
     * @return string The content of application.properties.
     */
    public function generateApplicationProperties() {
        $requireLoginValue = $this->requireLogin ? 'true' : 'false';
        return <<<PROPERTIES
############################################
# 1. APPLICATION
############################################

# The name of the Spring Boot application.
spring.application.name={$this->projectConfig['name']}

spring.main.allow-bean-definition-overriding=true

# Default language used for internationalization (i18n).
app.i18n.default-language=en


############################################
# 2. SECURITY SETTINGS
############################################

# Whether user login is required to access protected endpoints.
app.security.require-login=false

# Enables CORS (Cross-Origin Resource Sharing).
app.security.cors.enabled=true

# List of allowed origins for CORS requests.
app.security.cors.allowed-origins=http://localhost,http://127.0.0.1,http://localhost:3000,http://localhost:4000,http://127.0.0.1:4000,http://127.0.0.1:3000,http://localhost:8080

# Additional global override to allow all origins (*). Not recommended for production.
app.cors.origins="*"


############################################
# 3. SESSION MANAGEMENT
############################################

# Session store type. "none" means using default servlet container session.
spring.session.store-type=none

# Disables Redis repository auto-configuration.
spring.data.redis.repositories.enabled=false

# Excludes Redis auto-configuration since Redis is not used.
spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration

# Session timeout duration.
server.servlet.session.timeout=30m

# Maximum lifetime for the session cookie.
server.servlet.session.cookie.max-age=30m


############################################
# 4. DATABASE CONFIGURATION
############################################

# JDBC connection URL for the MySQL database.
spring.datasource.url={DB_URL}

# Database username.
spring.datasource.username={DB_USER}

# Database password. Should be moved to environment variables for security.
spring.datasource.password={DB_PASS}

# MySQL JDBC driver class name.
spring.datasource.driver-class-name={DB_DRIVER_CLASS}


############################################
# 5. JPA / HIBERNATE
############################################

# Whether Hibernate should show executed SQL statements in logs.
spring.jpa.show-sql=false

# Hibernate SQL dialect for MySQL.
spring.jpa.properties.hibernate.dialect={DB_DIALECT}

# Uses the same column names as in the database without name conversion.
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl


############################################
# 6. GRAPHQL CONFIGURATION
############################################

# Enables GraphiQL web interface for testing GraphQL queries.
spring.graphql.graphiql.enabled=true

# Folder where GraphQL schema files are located.
spring.graphql.schema.locations=classpath:graphql/

# File extension for GraphQL schema definition files.
spring.graphql.schema.file-extensions=.graphqls


############################################
# 7. CACHING (Optional)
############################################

# Enables Caffeine caching if uncommented.
# spring.cache.type=caffeine


############################################
# 8. REDIS CONFIG (FOR application-redis.properties)
############################################

# Enables Redis session store when using Redis profile.
# spring.session.store-type=redis

# Redis server hostname.
# spring.data.redis.host=localhost

# Redis server port.
# spring.data.redis.port=6379

# Session timeout when using Redis-backed sessions.
# spring.session.timeout=30m

PROPERTIES;
    }

    /**
     * Generates the main Spring Boot application class in Kotlin.
     *
     * @return string The content of the main application class.
     */
    private function generateMainAppClass() {
        $className = $this->pascalCase($this->projectConfig['artifactId']) . 'Application';
        $packageName = $this->projectConfig['packageName'];
        $cacheImport = $this->useCache ? "import org.springframework.cache.annotation.EnableCaching\n" : "";
        $cacheAnnotation = $this->useCache ? "@EnableCaching\n" : "";

        return <<<KOTLIN
package $packageName

import org.springframework.boot.autoconfigure.SpringBootApplication
import org.springframework.boot.runApplication
$cacheImport
$cacheAnnotation
@SpringBootApplication
class $className

fun main(args: Array<String>) {
    runApplication<$className>(*args)
}
KOTLIN;
    }

    /**
     * Generates the Kotlin entity data class for a given table.
     *
     * @param string $tableName The name of the database table.
     * @param array $tableInfo The information about the table's columns.
     * @return string The content of the entity class.
     */
    private function generateEntityClass($tableName, $tableInfo) {
        $className = $this->pascalCase($tableName);
        $packageName = $this->projectConfig['packageName'];
        
        $imports = "import jakarta.persistence.*\nimport java.io.Serializable\n";
        $fields = "";
        $importSet = array();

        $nCols = count($tableInfo['columns']);
        $i = 1;

        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            $kotlinType = $this->mapDbTypeToKotlinType($colInfo['type'], $colInfo['length']);
            $fieldName = $this->camelCase($colName);
            
            if (strpos($kotlinType, 'LocalDateTime') !== false) {
                $importSet['java.time.LocalDateTime'] = "import java.time.LocalDateTime";
                $importSet['JsonFormat'] = "import com.fasterxml.jackson.annotation.JsonFormat";
                $fields .= "    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = \"yyyy-MM-dd HH:mm:ss\")\n";
            } else if (strpos($kotlinType, 'LocalDate') !== false) {
                $importSet['java.time.LocalDate'] = "import java.time.LocalDate";
                $importSet['JsonFormat'] = "import com.fasterxml.jackson.annotation.JsonFormat";
                $fields .= "    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = \"yyyy-MM-dd\")\n";
            }
            
            if ($colInfo['isPrimaryKey']) {
                $fields .= "    @Id\n";
                if ($colInfo['isAutoIncrement']) {
                    if($colInfo['primaryKeyValue'] == 'autogenerated') {
                        $fields .= "    @GeneratedValue(strategy = GenerationType.IDENTITY)\n";
                    }
                }
            }
            
            if ($colInfo['isForeignKey']) {
                $importSet['JsonIgnore'] = "import com.fasterxml.jackson.annotation.JsonIgnore";
                $importSet['NotFound'] = "import org.hibernate.annotations.NotFound";
                $importSet['NotFoundAction'] = "import org.hibernate.annotations.NotFoundAction";
                
                $refTableName = $colInfo['references'];
                $refClassName = $this->pascalCase($refTableName);
                $refFieldName = $this->camelCase($refTableName);

                // Foreign key column
                $fields .= "    @Column(name = \"$colName\")\n";
                $fields .= "    var $fieldName: " . basename(str_replace('\\', '/', $kotlinType)) . "? = null,\n\n";
                
                // Relationship
                $fields .= "    @JsonIgnore\n";
                $fields .= "    @ManyToOne(fetch = FetchType.LAZY)\n";
                $fields .= "    @NotFound(action = NotFoundAction.IGNORE)\n";
                $fields .= "    @JoinColumn(name = \"$colName\", insertable = false, updatable = false)\n";
                $fields .= "    var $refFieldName: $refClassName? = null,\n\n";
                continue;
            } else if ($fieldName !== $colName) {
                $fields .= "    @Column(name = \"$colName\")\n";
            }
            
            $fields .= "    var $fieldName: " . basename(str_replace('\\', '/', $kotlinType)) . "? = null,\n\n";
            
        }
        
        $imports .= implode("\n", $importSet);

        // Use 'class' instead of 'data class' if there are no fields to avoid compilation errors.
        $classType = !empty(trim($fields)) ? 'data class' : 'class';
        $fields = rtrim($fields);
        $fields = rtrim($fields, ", ");

        return <<<KOTLIN
package $packageName.model.entity;

$imports

@Entity
@Table(name = "$tableName")
$classType $className(
$fields
) : Serializable
KOTLIN;
    }

    /**
     * Generates the Kotlin repository interface for a given table.
     *
     * @param string $tableName The name of the database table.
     * @param array $tableInfo The information about the table's columns.
     * @return string The content of the repository interface.
     */
    private function generateRepositoryInterface($tableName, $tableInfo) {
        $className = $this->pascalCase($tableName);
        $packageName = $this->projectConfig['packageName'];
        $pkKotlinType = 'String';
        foreach ($tableInfo['columns'] as $col) {
            if ($col['isPrimaryKey']) {
                $pkKotlinType = $this->mapDbTypeToKotlinType($col['type'], $col['length']);
                break;
            }
        }

        $imports = "import org.springframework.data.jpa.repository.JpaRepository\n";
        $imports .= "import org.springframework.data.jpa.repository.JpaSpecificationExecutor\n";
        $imports .= "import org.springframework.stereotype.Repository\n";
        $imports .= "import $packageName.model.entity.$className\n";

        $modifying = "";
        $findByIdMethod = "";

        $pkInfo = $this->findPrimaryKeyInfo($tableInfo);
        if ($pkInfo) {
            $pkCamelCase = $this->camelCase($pkInfo['name']);
            $pkUpperCamelCase = $this->pascalCase($pkInfo['name']);
            $pkKotlinType = $this->mapDbTypeToKotlinType($pkInfo['type'], $pkInfo['length']);

            if (!$pkInfo['isAutoIncrement'] && $pkInfo['primaryKeyValue'] != 'autogenerated') {
                $imports .= "import org.springframework.data.jpa.repository.Modifying\n";
                $imports .= "import org.springframework.data.jpa.repository.Query\n";
                $imports .= "import org.springframework.data.repository.query.Param\n";
                $imports .= "import org.springframework.transaction.annotation.Transactional\n";
                $modifying = "\n    @Modifying\n";
                $modifying .= "    @Transactional\n";
                $modifying .= "    @Query(\"UPDATE $className a SET a.$pkCamelCase = :newId WHERE a.$pkCamelCase = :oldId\")\n";
                $modifying .= "    fun update{$pkUpperCamelCase}(@Param(\"oldId\") oldId: $pkKotlinType, @Param(\"newId\") newId: $pkKotlinType): Int\n";
            }
        }

        return <<<KOTLIN
package $packageName.model.repository

{$imports}

@Repository
interface {$className}Repository : JpaRepository<$className, $pkKotlinType>, JpaSpecificationExecutor<$className> {
    {$modifying}
}
KOTLIN;
    }

    /**
     * Generates the DTO data class for a given table.
     * @param string $tableName The name of the database table.
     * @param array $tableInfo The information about the table's columns.
     * @return string The content of the DTO class.
     */
    private function generateDtoClass($tableName, $tableInfo) {
        $className = $this->pascalCase($tableName) . "Input";
        $packageName = $this->projectConfig['packageName'];

        $backendHandledColumnNames = $this->getBackendHandledColumnNames();
        $fields = "";
        $importSet = array();

        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            if ($colName === $tableInfo['primaryKey'] && ($colInfo['isAutoIncrement'] || $colInfo['primaryKeyValue'] == 'autogenerated')) {
                continue;
            }
            if(in_array($colName, $backendHandledColumnNames)) {
                continue;
            }
            
            $kotlinType = $this->mapDbTypeToKotlinType($colInfo['type'], $colInfo['length']);
            $fieldName = $this->camelCase($colName);

            if (strpos($kotlinType, 'LocalDateTime') !== false) {
                $importSet['java.time.LocalDateTime'] = "import java.time.LocalDateTime";
            } else if (strpos($kotlinType, 'LocalDate') !== false) {
                $importSet['java.time.LocalDate'] = "import java.time.LocalDate";
            }

            $fields .= "    val $fieldName: " . basename(str_replace('\\', '/', $kotlinType)) . "? = null,\n";
        }
        
        $imports = implode("\n", $importSet);
        $trimmedFields = rtrim(trim($fields), ',');

        return <<<KOTLIN
package $packageName.model.dto

$imports

data class $className(
$trimmedFields
)
KOTLIN;
    }

    /**
     * Generates the Controller class for a given table in Kotlin.
     * @param string $tableName The name of the database table.
     * @param array $tableInfo The information about the table's columns.
     * @return string The content of the Controller class.
     */
    private function generateControllerClass($tableName, $tableInfo) {
        $camelName = $this->camelCase($tableName);
        $ucCamelName = $this->pascalCase($tableName);
        $pluralCamelName = $this->pluralize($camelName);
        $package = $this->projectConfig['packageName'];
        
        $pkInfo = $this->findPrimaryKeyInfo($tableInfo);
        $pkKotlinType = 'String';
        $pkAutogenerated = false;
        if ($pkInfo) {
            $pkKotlinType = $this->mapDbTypeToKotlinType($pkInfo['type'], $pkInfo['length']);
            $pkAutogenerated = $pkInfo['isAutoIncrement'] || $pkInfo['primaryKeyValue'] == 'autogenerated';
        }
        $pkKotlinType = 'String';
        foreach ($tableInfo['columns'] as $col) {
            if ($col['isPrimaryKey']) {
                $pkKotlinType = $this->mapDbTypeToKotlinType($col['type'], $col['length']);
                break;
            }
        }

        $fieldResolvers = $this->generateFieldResolversKt($tableName, $tableInfo);
        $importScalarValueUtil = strpos($fieldResolvers, 'ScalarValueUtil') !== false ? "\nimport $package.util.ScalarValueUtil" : "";

        $returnUpdate = "        return {$camelName}Repository.save(entity)\n";
        if (!$pkAutogenerated && $pkInfo) {
            $pkCamelCase = $this->camelCase($pkInfo['name']);
            $pkUpperCamelCase = $this->pascalCase($pkInfo['name']);
            $returnUpdate = "        {$camelName}Repository.save(entity)\n";
            $returnUpdate .= "        // Update $pkCamelCase\n";
            $returnUpdate .= "        dtoInput.$pkCamelCase?.let {\n";
            $returnUpdate .= "            val rowsAffected = {$camelName}Repository.update{$pkUpperCamelCase}(entity.$pkCamelCase!!, it)\n";
            $returnUpdate .= "            if (rowsAffected > 0) {\n";
            $returnUpdate .= "                entity.$pkCamelCase = it\n";
            $returnUpdate .= "            }\n";
            $returnUpdate .= "        }\n";
            $returnUpdate .= "        return entity\n";
        }

        $relatedEntityImports = "";
        foreach ($tableInfo['columns'] as $colInfo) {
            if ($colInfo['isForeignKey']) {
                $refClassName = $this->pascalCase($colInfo['references']);
                $relatedEntityImports .= "\nimport $package.model.entity.$refClassName";
            }
        }

        return <<<KOTLIN
package $package.controller

import $package.model.dto.core.FilterInput
import $package.model.dto.core.SortInput
import $package.model.dto.{$ucCamelName}Input
import $package.model.entity.$ucCamelName
import $package.model.repository.{$ucCamelName}Repository
import $package.model.repository.core.AdminRepository
import $package.util.I18nUtil
import $package.util.QueryUtil
import $package.util.ValueUtil
import $package.util.AuditTrailUtil$importScalarValueUtil$relatedEntityImports

import org.springframework.graphql.data.method.annotation.Argument
import org.springframework.graphql.data.method.annotation.MutationMapping
import org.springframework.graphql.data.method.annotation.QueryMapping
import org.springframework.graphql.data.method.annotation.SchemaMapping

import org.springframework.stereotype.Controller
import org.springframework.transaction.annotation.Transactional
import org.springframework.web.bind.annotation.RequestHeader

import graphql.schema.DataFetchingEnvironment

import java.util.Optional

@Controller
class {$ucCamelName}Controller(
    private val {$camelName}Repository: {$ucCamelName}Repository,
    private val i18n: I18nUtil
) {

    @QueryMapping
    fun {$camelName}(@Argument id: $pkKotlinType): $ucCamelName? {
        return {$camelName}Repository.findById(id).orElse(null)
    }

    @QueryMapping
    fun {$pluralCamelName}(
        @Argument limit: Int?,
        @Argument offset: Int?,
        @Argument page: Int?,
        @Argument size: Int?,
        @Argument orderBy: List<SortInput>?,
        @Argument filter: List<FilterInput>?
    ): Map<String, Any> {
        val pageable = QueryUtil.createPageable(limit, offset, page, size, orderBy)
        val specification = QueryUtil.createSpecification<$ucCamelName>(filter)
        val resultPage = {$camelName}Repository.findAll(specification, pageable)
        return QueryUtil.createPageResultMap(resultPage)
    }

    @MutationMapping
    @Transactional
    fun create{$ucCamelName}(
        @Argument input: Map<String, Any>
    ): $ucCamelName {
        val lang = AuditTrailUtil.getLanguageId()
        val dtoInput = ValueUtil.convertSnakeCaseToDto(input, {$ucCamelName}Input::class.java)
        val entity = {$ucCamelName}()
{$this->generateDtoToEntityMappingKt($tableName, $tableInfo, 'entity', 'dtoInput', 'create')}
        return {$camelName}Repository.save(entity)
    }

    @MutationMapping
    @Transactional
    fun update{$ucCamelName}(
        @Argument id: $pkKotlinType,
        @Argument input: Map<String, Any>
    ): $ucCamelName {
        val lang = AuditTrailUtil.getLanguageId()
        val dtoInput = ValueUtil.convertSnakeCaseToDto(input, {$ucCamelName}Input::class.java)
        val entity = {$camelName}Repository.findById(id)
            .orElseThrow { RuntimeException(i18n.t("no_item_found_with_id", lang, "$tableName", id)) }
{$this->generateDtoToEntityMappingKt($tableName, $tableInfo, 'entity', 'dtoInput', 'update')}
$returnUpdate
    }

    @MutationMapping
    @Transactional
    fun delete{$ucCamelName}(@Argument id: $pkKotlinType): Boolean {
        {$camelName}Repository.deleteById(id)
        return true
    }
{$this->generateToggleActiveMutationKt($tableName, $tableInfo)}
$fieldResolvers
}
KOTLIN;
    }

    /**
     * Maps Kotlin types to GraphQL types.
     *
     * @param string $kotlinType The Kotlin type.
     * @return string The corresponding GraphQL type.
     */
    private function mapKotlinTypeToGqlType($kotlinType) {
        $baseType = basename(str_replace('\\', '/', $kotlinType));
        switch ($baseType) {
            case 'Int':
                return 'Int';
            case 'Double':
            case 'Float':
                return 'Float';
            case 'Boolean':
                return 'Boolean';
            case 'String':
            case 'LocalDate':
            case 'LocalDateTime':
                return 'String'; // Or custom scalars
            default:
                return 'String';
        }
    }
    
    /**
     * Get project configuration.
     */
    public function getProjectConfig()
    {
        return $this->projectConfig;
    }

    /**
     * Generates the GraphQL schema parts for a given table.
     *
     * @param string $tableName The name of the table.
     * @param array $tableInfo The table information including columns and primary key.
     * @return array An array containing 'types', 'queries', and 'mutations' strings.
     */
    private function getSchemaPartsForTable($tableName, $tableInfo) {
        $camelName = $this->camelCase($tableName);
        $ucCamelName = $this->pascalCase($tableName);
        $pluralCamelName = $this->pluralize($camelName);

        // Type fields
        $fields = "";
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            $gqlType = $this->mapKotlinTypeToGqlType($this->mapDbTypeToKotlinType($colInfo['type'], $colInfo['length']));
            $fieldName = $colName; // Use original snake_case name
            if ($colInfo['isForeignKey']) {
                $refUcCamelName = $this->pascalCase($colInfo['references']);
                $fields .= "    $fieldName: $gqlType\n"; // Keep the ID field
                $fields .= "    {$colInfo['references']}: $refUcCamelName\n"; // Use original table name for relation
            } else {
                $fields .= "    $fieldName: $gqlType\n";
            }
        }

        // Input fields
        $inputFields = "";
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            if ($colName === $tableInfo['primaryKey'] && ($colInfo['isAutoIncrement'] || $colInfo['primaryKeyValue'] == 'autogenerated')) {
                continue;
            }
            $gqlType = $this->mapKotlinTypeToGqlType($this->mapDbTypeToKotlinType($colInfo['type'], $colInfo['length']));
            $fieldName = $colName; // Use original snake_case name
            $inputFields .= "    $fieldName: $gqlType\n";
        }

        $types = <<<GQL
type $ucCamelName {
$fields}

input {$ucCamelName}Input {
$inputFields}

type {$ucCamelName}Page {
    items: [$ucCamelName],
    total: Int,
    limit: Int,
    page: Int,
    totalPages: Int,
    hasNext: Boolean,
    hasPrevious: Boolean
}
GQL;
        $pkType = $this->mapKotlinTypeToGqlType($this->mapDbTypeToKotlinType($tableInfo['columns'][$tableInfo['primaryKey']]['type'], $tableInfo['columns'][$tableInfo['primaryKey']]['length']));

        $queries = "    {$camelName}(id: {$pkType}!): $ucCamelName\n";
        $queries .= "    {$pluralCamelName}(limit: Int, offset: Int, page: Int, size: Int, orderBy: [SortInput], filter: [FilterInput]): {$ucCamelName}Page\n";

        $mutations = "    create{$ucCamelName}(input: {$ucCamelName}Input!): $ucCamelName\n";
        $mutations .= "    update{$ucCamelName}(id: {$pkType}!, input: {$ucCamelName}Input!): $ucCamelName\n";
        $mutations .= "    delete{$ucCamelName}(id: {$pkType}!): Boolean\n";
        
        if ($tableInfo['hasActiveColumn']) {
            $activeField = $this->camelCase($this->activeField);
            $mutations .= "    toggle{$ucCamelName}Active(id: {$pkType}!, $activeField: Boolean!): $ucCamelName\n";
        }

        return [
            'types' => $types,
            'queries' => $queries,
            'mutations' => $mutations
        ];
    }

    /**
     * Combines all schema parts into a single GraphQL schema string.
     *
     * @param array $allSchemaParts Array of type definitions.
     * @param array $allQueryFields Array of query definitions.
     * @param array $allMutationFields Array of mutation definitions.
     * @return string The complete GraphQL schema.
     */
    private function generateCombinedSchema($allSchemaParts, $allQueryFields, $allMutationFields) {
        $typesString = implode("\n", $allSchemaParts);
        $queriesString = implode("", $allQueryFields);
        $mutationsString = implode("", $allMutationFields);

        return <<<GQL
enum SortDirection {
    ASC
    DESC
}

enum FilterOperator {
    EQUALS
    NOT_EQUALS
    CONTAINS
    GREATER_THAN
    GREATER_THAN_OR_EQUALS
    LESS_THAN
    LESS_THAN_OR_EQUALS
    IN
    NOT_IN
}

input SortInput {
    field: String!
    direction: SortDirection
}

input FilterInput {
    field: String!
    value: Object
    operator: FilterOperator
}

$typesString

type Query {
$queriesString}

scalar Object

type Mutation {
$mutationsString}
GQL;
    }

    /**
     * Generates the FilterInput DTO class in Kotlin.
     * @return string The Kotlin code for FilterInput.kt.
     */
    private function generateFilterInputDtoKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.model.dto

data class FilterInput(
    val field: String,
    val value: Any?,
    val operator: String?
)
KOTLIN;
    }

    /**
     * Generates the SortInput DTO class in Kotlin.
     * @return string The Kotlin code for SortInput.kt.
     */
    private function generateSortInputDtoKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.model.dto

data class SortInput(
    val field: String,
    val direction: String? = "ASC"
)
KOTLIN;
    }

    /**
     * Generates the QueryUtil object in Kotlin.
     *
     * @return string The Kotlin code for QueryUtil.kt.
     */
    private function generateQueryUtilKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.util

import $package.model.dto.core.FilterInput
import $package.model.dto.core.SortInput
import org.springframework.data.domain.Page
import org.springframework.data.domain.PageRequest
import org.springframework.data.domain.Pageable
import org.springframework.data.domain.Sort
import org.springframework.data.jpa.domain.Specification

object QueryUtil {

    fun createPageable(limit: Int?, offset: Int?, page: Int?, size: Int?, orderBy: List<SortInput>?): Pageable {
        val pageSize = limit ?: size ?: 20
        val pageNum = when {
            offset != null && pageSize > 0 -> offset / pageSize
            page != null -> if (page > 0) page - 1 else 0
            else -> 0
        }

        val sort = orderBy?.map {
            Sort.Order(Sort.Direction.fromString(it.direction ?: "ASC"), it.field)
        }?.let { Sort.by(it) } ?: Sort.unsorted()

        return PageRequest.of(pageNum, pageSize, sort)
    }

    fun <T> createPageResultMap(resultPage: Page<T>): Map<String, Any> {
        return mapOf(
            "items" to resultPage.content,
            "total" to resultPage.totalElements,
            "limit" to resultPage.size,
            "page" to resultPage.number + 1,
            "totalPages" to resultPage.totalPages,
            "hasNext" to resultPage.hasNext(),
            "hasPrevious" to resultPage.hasPrevious()
        )
    }

    fun <T> createSpecification(filter: List<FilterInput>?): Specification<T> {
        if (filter.isNullOrEmpty()) {
            return Specification.where(null)
        }
        val builder = SpecificationBuilder<T>()
        filter.forEach { f ->
            f.value?.let { builder.with(f.field, SearchOperation.valueOf(f.operator?.uppercase() ?: "EQUALS"), it) }
        }
        return builder.build() ?: Specification.where(null)
    }
}
KOTLIN;
    }

    /**
     * Generates the SecurityConfig class for application security in Kotlin.
     *
     * @return string The Kotlin code for SecurityConfig.kt.
     */
    private function generateSecurityConfigKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.config

import $package.service.JpaUserDetailsService
import org.springframework.beans.factory.annotation.Value
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty
import org.springframework.context.annotation.Bean
import org.springframework.context.annotation.Configuration
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity
import org.springframework.security.config.annotation.web.builders.HttpSecurity
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity
import org.springframework.security.config.annotation.web.invoke
import org.springframework.security.web.SecurityFilterChain
import org.springframework.security.web.util.matcher.AntPathRequestMatcher
import org.springframework.session.data.redis.config.annotation.web.http.EnableRedisHttpSession

@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true)
class SecurityConfig(
    private val jpaUserDetailsService: JpaUserDetailsService,
) {

    @Value("\\\${app.security.require-login}")
    private val requireLogin: Boolean = true

    @Bean
    fun securityFilterChain(http: HttpSecurity): SecurityFilterChain {

        http {
            csrf {
                ignoringRequestMatchers(
                    AntPathRequestMatcher("/login"),
                    AntPathRequestMatcher("/logout"),
                    AntPathRequestMatcher("/graphql/**")
                )
            }

            authorizeHttpRequests {

                if (requireLogin) {

                    // daftar endpoint publik (dipanggil satu-satu)
                    authorize(AntPathRequestMatcher("/login"), permitAll)
                    authorize(AntPathRequestMatcher("/logout"), permitAll)
                    authorize(AntPathRequestMatcher("/graphiql/**"), permitAll)
                    authorize(AntPathRequestMatcher("/vendor/**"), permitAll)
                    authorize(AntPathRequestMatcher("/index.html"), permitAll)
                    authorize(AntPathRequestMatcher("/"), permitAll)
                    authorize(AntPathRequestMatcher("/*.js"), permitAll)
                    authorize(AntPathRequestMatcher("/*.css"), permitAll)
                    authorize(AntPathRequestMatcher("/*.ico"), permitAll)
                    authorize(AntPathRequestMatcher("/assets/**"), permitAll)
                    authorize(AntPathRequestMatcher("/langs/**"), permitAll)

                    // selain itu wajib login
                    authorize(anyRequest, authenticated)

                } else {
                    authorize(anyRequest, permitAll)
                }
            }
        }

        return http.build()
    }

    @Configuration
    @ConditionalOnProperty(value = ["spring.session.store-type"], havingValue = "redis")
    @EnableRedisHttpSession
    class RedisSessionConfig
}
KOTLIN;
    }

    /**
     * Generates the CorsConfig class for CORS configuration in Kotlin.
     * @return string The Kotlin code for CorsConfig.kt.
     */
    private function generateCorsConfigKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.config

import org.springframework.beans.factory.annotation.Value
import org.springframework.context.annotation.Bean
import org.springframework.context.annotation.Configuration
import org.springframework.web.servlet.config.annotation.CorsRegistry
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer

@Configuration
class CorsConfig(
    @Value("\\\${app.cors.origins}") private val origins: String
) {
    @Bean
    fun corsConfigurer(): WebMvcConfigurer {
        return object : WebMvcConfigurer {
            override fun addCorsMappings(registry: CorsRegistry) {
                registry.addMapping("/**")
                    .allowedOrigins(*origins.split(",").map { it.trim() }.toTypedArray())
                    .allowedMethods("*")
            }
        }
    }
}
KOTLIN;
    }

    /**
     * Generates the Sha1PasswordEncoder class in Kotlin.
     * @return string The Kotlin code for Sha1PasswordEncoder.kt.
     */
    private function generateSha1PasswordEncoderKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.config

import org.springframework.security.crypto.password.PasswordEncoder
import org.springframework.stereotype.Component
import java.math.BigInteger
import java.security.MessageDigest

@Component
class Sha1PasswordEncoder : PasswordEncoder {

    override fun encode(rawPassword: CharSequence): String {
        return sha1(sha1(rawPassword.toString()))
    }

    override fun matches(rawPassword: CharSequence, encodedPassword: String): Boolean {
        return encodedPassword == encode(rawPassword)
    }

    fun sha1(input: String): String {
        val md = MessageDigest.getInstance("SHA-1")
        val messageDigest = md.digest(input.toByteArray())
        val no = BigInteger(1, messageDigest)
        var hashtext = no.toString(16)
        while (hashtext.length < 40) {
            hashtext = "0\$hashtext"
        }
        return hashtext
    }
}
KOTLIN;
    }

    /**
     * Generates the JpaUserDetailsService class in Kotlin.
     * @return string The Kotlin code for JpaUserDetailsService.kt.
     */
    private function generateUserDetailsServiceKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.service

import $package.model.repository.core.AdminRepository
import org.springframework.security.core.userdetails.User
import org.springframework.security.core.userdetails.UserDetails
import org.springframework.security.core.userdetails.UserDetailsService
import org.springframework.security.core.userdetails.UsernameNotFoundException
import org.springframework.stereotype.Service

@Service
class JpaUserDetailsService(private val adminRepository: AdminRepository) : UserDetailsService {

    override fun loadUserByUsername(username: String): UserDetails {
        val admin = adminRepository.findByUsername(username)
            .orElseThrow { UsernameNotFoundException("Username not found: \$username") }

        return User.withUsername(admin.username!!)
            .password(admin.password!!)
            .authorities("USER").build()
    }
}
KOTLIN;
    }

    private function generateNotificationEntityKt()
    {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package com.planetbiru.graphqlapplication.model.entity.core

import jakarta.persistence.*
import java.time.LocalDateTime

@Entity
@Table(name = "notification")
data class Notification(
    @Id
    @Column(name = "notification_id", nullable = false, length = 40)
    var notificationId: String,

    @Column(name = "notification_type", length = 40)
    var notificationType: String? = null,

    @Column(name = "admin_group", length = 40)
    var adminGroup: String? = null,

    @Column(name = "admin_id", length = 40, insertable = false, updatable = false)
    var adminId: String? = null,

    @Column(name = "icon", length = 40)
    var icon: String? = null,

    @Column(name = "subject", length = 255)
    var subject: String? = null,

    @Lob
    @Column(name = "content")
    var content: String? = null,

    @Lob
    @Column(name = "link")
    var link: String? = null,

    @Column(name = "is_read")
    var isRead: Boolean = false,

    @Column(name = "time_create")
    var timeCreate: LocalDateTime? = null,

    @Column(name = "ip_create", length = 50)
    var ipCreate: String? = null,

    @Column(name = "time_read")
    var timeRead: LocalDateTime? = null,

    @Column(name = "ip_read", length = 50)
    var ipRead: String? = null,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "admin_id", referencedColumnName = "admin_id")
    val admin: Admin? = null
)
KOTLIN;
    }

    private function generateMessageFolderEntityKt()
    {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package com.planetbiru.graphqlapplication.model.entity.core

import jakarta.persistence.*
import java.time.LocalDateTime

@Entity
@Table(name = "message_folder")
data class MessageFolder(
    @Id
    @Column(name = "message_folder_id", nullable = false, length = 40)
    var messageFolderId: String,

    @Column(name = "name", length = 100)
    var name: String? = null,

    @Column(name = "admin_id", length = 40)
    var adminId: String? = null,

    @Column(name = "sort_order")
    var sortOrder: Int? = null,

    @Column(name = "time_create")
    var timeCreate: LocalDateTime? = null,

    @Column(name = "time_edit")
    var timeEdit: LocalDateTime? = null,

    @Column(name = "admin_create", length = 40)
    var adminCreate: String? = null,

    @Column(name = "admin_edit", length = 40)
    var adminEdit: String? = null,

    @Column(name = "ip_create", length = 50)
    var ipCreate: String? = null,

    @Column(name = "ip_edit", length = 50)
    var ipEdit: String? = null,

    @Column(name = "active")
    var active: Boolean? = true,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "admin_id", referencedColumnName = "admin_id", insertable = false, updatable = false)
    val admin: Admin? = null
)
KOTLIN;
    }

    private function generateMessageEntityKt()
    {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package com.planetbiru.graphqlapplication.model.entity.core

import jakarta.persistence.*
import java.time.LocalDateTime

@Entity
@Table(name = "message")
data class Message(
    @Id
    @Column(name = "message_id", nullable = false, length = 40)
    var messageId: String,

    @Column(name = "message_direction", length = 40)
    var messageDirection: String? = null,

    @Column(name = "sender_id", length = 40, insertable = false, updatable = false)
    var senderId: String? = null,

    @Column(name = "receiver_id", length = 40, insertable = false, updatable = false)
    var receiverId: String? = null,

    @Column(name = "message_folder_id", length = 40, insertable = false, updatable = false)
    var messageFolderId: String? = null,

    @Column(name = "icon", length = 40)
    var icon: String? = null,

    @Column(name = "subject", length = 255)
    var subject: String? = null,

    @Lob
    @Column(name = "content")
    var content: String? = null,

    @Lob
    @Column(name = "link")
    var link: String? = null,

    @Column(name = "is_read")
    var isRead: Boolean = false,

    @Column(name = "time_create")
    var timeCreate: LocalDateTime? = null,

    @Column(name = "ip_create", length = 50)
    var ipCreate: String? = null,

    @Column(name = "time_read")
    var timeRead: LocalDateTime? = null,

    @Column(name = "ip_read", length = 50)
    var ipRead: String? = null,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "sender_id", referencedColumnName = "admin_id")
    val sender: Admin? = null,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "receiver_id", referencedColumnName = "admin_id")
    val receiver: Admin? = null,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "message_folder_id", referencedColumnName = "message_folder_id")
    val messageFolder: MessageFolder? = null
)
KOTLIN;
    }

    private function generateAdminLevelEntityKt()
    {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package com.planetbiru.graphqlapplication.model.entity.core

import jakarta.persistence.Column
import jakarta.persistence.Entity
import jakarta.persistence.Id
import jakarta.persistence.Table
import java.time.LocalDateTime

@Entity
@Table(name = "admin_level")
data class AdminLevel(
    @Id
    @Column(name = "admin_level_id")
    val adminLevelId: String,

    @Column(name = "name")
    val name: String? = null,

    @Column(name = "special_access")
    val specialAccess: Boolean? = false,

    @Column(name = "sort_order")
    val sortOrder: Int? = 0,

    @Column(name = "default_data")
    val defaultData: Boolean? = false,

    @Column(name = "active")
    val active: Boolean? = true
)
KOTLIN;
    }

    /**
     * Generates the Admin entity class in Kotlin.
     * @return string The Kotlin code for Admin.kt.
     */
    private function generateAdminEntityKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.model.entity.core

import jakarta.persistence.Column
import jakarta.persistence.Entity
import jakarta.persistence.Id
import jakarta.persistence.Table

@Entity
@Table(name = "admin")
data class Admin(
    @Id
    @Column(name = "admin_id")
    var adminId: String? = null,
    var username: String? = null,
    var password: String? = null,
    var name: String? = null,
    var email: String? = null,
    var phone: String? = null,
    @Column(name = "admin_level_id")
    var adminLevelId: String? = null
)
KOTLIN;
    }

    /**
     * Generates the AdminRepository interface in Kotlin.
     * @return string The Kotlin code for AdminRepository.kt.
     */
    private function generateAdminRepositoryKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.model.repository.core

import $package.model.entity.core.Admin
import org.springframework.data.jpa.repository.JpaRepository
import java.util.Optional

interface AdminRepository : JpaRepository<Admin, String> {
    fun findByUsername(username: String): Optional<Admin>
}
KOTLIN;
    }

    /**
     * Generates the LoginRequest DTO in Kotlin.
     * @return string The Kotlin code for LoginRequest.kt.
     */
    private function generateLoginRequestDtoKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.controller.dto

data class LoginRequest(
    val username: String,
    val password: String
)
KOTLIN;
    }

    /**
     * Generates the LoginResponse DTO in Kotlin.
     * @return string The Kotlin code for LoginResponse.kt.
     */
    private function generateLoginResponseDtoKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.controller.dto

data class LoginResponse(
    val success: Boolean,
    val message: String
)
KOTLIN;
    }

    private function generateFrontendConfigController()
    {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.controller.core

import $package.util.I18nUtil
import jakarta.servlet.http.HttpSession
import org.springframework.beans.factory.annotation.Value
import org.springframework.core.io.Resource
import org.springframework.core.io.ResourceLoader
import org.springframework.core.io.support.ResourcePatternResolver
import org.springframework.http.HttpStatus
import org.springframework.http.MediaType
import org.springframework.http.ResponseEntity
import org.springframework.util.StreamUtils
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.RequestHeader
import org.springframework.web.bind.annotation.RequestParam
import java.io.FileNotFoundException
import java.io.IOException
import java.nio.charset.StandardCharsets
import java.util.Locale

data class ThemeDto(val name: String, val title: String)

/**
 * REST controller for serving frontend configuration.
 */
@org.springframework.web.bind.annotation.RestController
class FrontendConfigController(
    private val resourceLoader: ResourceLoader,
    private val resourcePatternResolver: ResourcePatternResolver,
    @Value("\\\${app.security.require-login}") private val requireLogin: Boolean,
    private val i18n: I18nUtil
) {

    /**
     * {@code GET /frontend-config} : get the frontend configuration.
     *
     * @return the [ResponseEntity] with status `200 (OK)` and the configuration in body,
     * or with status `401 (Unauthorized)` if login is required,
     * or with status `500 (Internal Server Error)` if the configuration file could not be read.
     */
    @GetMapping("/frontend-config")
    fun getFrontendConfig(
        session: HttpSession,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?
    ): ResponseEntity<String> {
        if (requireLogin && session.getAttribute("username") == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(i18n.t("unauthorized", lang))
        }

        return try {
            val resource = resourceLoader.getResource("classpath:static/config/frontend-config.json")
            val config = StreamUtils.copyToString(resource.inputStream, StandardCharsets.UTF_8)
            ResponseEntity.ok()
                .header("Cache-Control", "no-store, no-cache, must-revalidate, max-age=0")
                .header("Pragma", "no-cache")
                .header("Expires", "0")
                .contentType(MediaType.APPLICATION_JSON)
                .body(config)
        } catch (e: IOException) {
            ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(i18n.t("error_reading_frontend_config", lang))
        }
    }

    /**
     * {@code GET /available-language.json} : get the available languages configuration.
     *
     * @return the [ResponseEntity] with status `200 (OK)` and the configuration in body,
     * or with status `500 (Internal Server Error)` if the configuration file could not be read.
     */
    @GetMapping("/available-language")
    fun getAvailableLanguages(
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?
    ): ResponseEntity<String> {
        try {
            val resource = resourceLoader.getResource("classpath:static/langs/available-language.json")
            val config = StreamUtils.copyToString(resource.inputStream, StandardCharsets.UTF_8)
            return ResponseEntity.ok()
                .header("Cache-Control", "no-store, no-cache, must-revalidate, max-age=0")
                .header("Pragma", "no-cache")
                .header("Expires", "0")
                .contentType(MediaType.APPLICATION_JSON).body(config)
        } catch (e: IOException) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(i18n.t("error_reading_language_config", lang))
        }
    }

    /**
     * {@code GET /available-theme.json} : get the list of available themes.
     *
     * @return the [ResponseEntity] with status `200 (OK)` and the list of themes in body,
     * or with status `500 (Internal Server Error)` if an error occurs.
     */
    @GetMapping("/available-theme")
    fun getAvailableThemes(
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?
    ): ResponseEntity<Any> {
        try {
            val resources: Array<Resource> = resourcePatternResolver.getResources("classpath:static/assets/themes/*/style.min.css")
            val themes = resources.mapNotNull { resource ->
                try {
                    val themeDir = resource.file.parentFile
                    if (themeDir.isDirectory) {
                        val themeName = themeDir.name
                        val title = themeName.replace('-', ' ').replace('_', ' ')
                            .split(' ')
                            .joinToString(" ") { it.replaceFirstChar { char -> if (char.isLowerCase()) char.titlecase(Locale.getDefault()) else char.toString() } }
                        ThemeDto(name = themeName, title = title)
                    } else {
                        null
                    }
                } catch (e: IOException) {
                    // Ignore resources that are not file-based (e.g., inside a JAR)
                    null
                }
            }
            return ResponseEntity.ok()
                .header("Cache-Control", "no-store, no-cache, must-revalidate, max-age=0")
                .header("Pragma", "no-cache")
                .header("Expires", "0")
                .contentType(MediaType.APPLICATION_JSON).body(themes)
        } catch (e: IOException) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(i18n.t("error_scanning_themes", lang))
        }
    }
}
KOTLIN;
    }

    private function generateMessageController()
    {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.controller.core

import $package.model.entity.core.Message
import $package.model.repository.core.MessageRepository
import $package.util.I18nUtil
import jakarta.servlet.http.HttpServletRequest
import jakarta.servlet.http.HttpSession
import org.springframework.data.domain.PageRequest
import org.springframework.data.domain.Sort
import org.springframework.http.HttpStatus
import org.springframework.http.MediaType
import org.springframework.http.ResponseEntity
import org.springframework.stereotype.Controller
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.PostMapping
import org.springframework.web.bind.annotation.RequestHeader
import org.springframework.web.bind.annotation.RequestParam
import java.time.LocalDateTime

@Controller
class MessageController(
    private val messageRepository: MessageRepository,
    private val i18n: I18nUtil
) {

    private fun getCurrentAdminId(session: HttpSession): String? {
        return session.getAttribute("adminId") as? String
    }

    @GetMapping("/message")
    fun handleMessageGet(
        @RequestParam(required = false) messageId: String?,
        @RequestParam(required = false) search: String?,
        @RequestParam(defaultValue = "1") page: Int,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?,
        session: HttpSession
    ): ResponseEntity<String> {
        val currentAdminId = getCurrentAdminId(session)
            ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(i18n.t("unauthorized", lang))

        val htmlContent = if (messageId != null) {
            buildDetailView(messageId, currentAdminId, lang)
        } else {
            buildListView(search, page, currentAdminId, lang)
        }

        return ResponseEntity.ok().contentType(MediaType.TEXT_HTML).body(htmlContent)
    }

    @PostMapping("/message")
    fun handleMessagePost(
        session: HttpSession,
        request: HttpServletRequest,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?
    ): ResponseEntity<*> {
        val currentAdminId = getCurrentAdminId(session)
            ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(mapOf("success" to false, "message" to i18n.t("unauthorized", lang)))

        val params = request.parameterMap.mapValues { it.value.firstOrNull() ?: "" }
        val action = params["action"]
        val messageId = params["messageId"] ?: return ResponseEntity.badRequest().body(mapOf("success" to false, "message" to i18n.t("message_id_required", lang)))

        return try {
            when (action) {
                "mark_as_unread" -> markAsUnread(messageId, currentAdminId, lang)
                "delete" -> deleteMessage(messageId, currentAdminId, lang)
                else -> ResponseEntity.badRequest().body(mapOf("success" to false, "message" to i18n.t("invalid_action", lang)))
            }
        } catch (e: Exception) {
            ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(mapOf("success" to false, "message" to e.message))
        }
    }

    private fun markAsUnread(messageId: String, currentAdminId: String, lang: String?): ResponseEntity<*> {
        val message = messageRepository.findById(messageId).orElseThrow { RuntimeException(i18n.t("message_not_found", lang)) }
        if (message.receiverId == currentAdminId) {
            message.isRead = false
            message.timeRead = null
            messageRepository.save(message)
            return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("message_marked_as_unread", lang)))
        }
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(mapOf("success" to false, "message" to i18n.t("forbidden", lang)))
    }

    private fun deleteMessage(messageId: String, currentAdminId: String, lang: String?): ResponseEntity<*> {
        val message = messageRepository.findById(messageId).orElseThrow { RuntimeException(i18n.t("message_not_found", lang)) }
        if (message.senderId == currentAdminId || message.receiverId == currentAdminId) {
            messageRepository.delete(message)
            return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("message_deleted_successfully", lang)))
        }
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(mapOf("success" to false, "message" to i18n.t("forbidden", lang)))
    }

    private fun buildListView(search: String?, page: Int, currentAdminId: String, lang: String?): String {
        val pageSize = 20
        val pageable = PageRequest.of(page - 1, pageSize, Sort.by("timeCreate").descending())

        val messagePage = if (!search.isNullOrBlank()) {
            messageRepository.findBySenderIdOrReceiverIdAndSearch(currentAdminId, search, pageable)
        } else {
            messageRepository.findBySenderIdOrReceiverId(currentAdminId, currentAdminId, pageable)
        }

        val messages = messagePage.content

        val messageItems = if (messages.isNotEmpty()) {
            messages.joinToString("") { message ->
                val isReadClass = if (message.isRead) "read" else "unread"
                val contentSnippet = message.content?.take(150)?.let { if (it.length == 150) "\$it..." else it } ?: ""
                val actionButtons = if (message.receiverId == currentAdminId && message.isRead) {
                    """
                    <button class="btn btn-sm btn-secondary" onclick="markMessageAsUnread('\${message.messageId}', 'list')">\${i18n.t("mark_as_unread", lang)}</button>
                    <button class="btn btn-sm btn-danger" onclick="handleMessageDelete('\${message.messageId}')">\${i18n.t("delete", lang)}</button>
                    """
                } else ""

                """
                <div class="message-item \$isReadClass">
                    <span class="message-status-indicator"></span>
                    <div class="message-header">
                        <div class="message-link-wrapper">
                            <a href="#message?messageId=\${message.messageId}" class="message-link">
                                <span class="message-sender">\${message.sender?.name ?: i18n.t("system", lang)}</span>
                                <span class="message-subject">\${message.subject ?: ""}</span>
                            </a>
                            <span class="message-time">\${message.timeCreate}</span>
                            \$actionButtons
                        </div>
                    </div>
                    <div class="message-content">\${contentSnippet}</div>
                </div>
                """
            }
        } else {
            "<p>\${i18n.t("no_message", lang)}</p>"
        }

        // Simplified pagination for brevity
        return """
        <div id="filter-container" class="filter-container" style="display: block;">
            <form id="message-search-form" class="search-form" onsubmit="handleMessageSearch(event)">
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="search_message">\${i18n.t("search", lang)}</label>
                        <input type="text" name="search" id="search_message" placeholder="\${i18n.t("search", lang)}" value="\${search ?: ""}">
                    </div>
                    <button type="submit" class="btn btn-primary">\${i18n.t("search", lang)}</button>
                </div>
            </form>
        </div>
        <div class="message-list-container">
            \$messageItems
        </div>
        """.trimIndent()
    }

    private fun buildDetailView(messageId: String, currentAdminId: String, lang: String?): String {
        val messageOpt = messageRepository.findByMessageIdAndUser(messageId, currentAdminId)
        if (messageOpt.isEmpty) {
            return """<div class="table-container detail-view">\${i18n.t("no_message", lang)}</div>"""
        }

        val message = messageOpt.get()

        // Mark as read
        if (message.receiverId == currentAdminId && !message.isRead) {
            message.isRead = true
            message.timeRead = LocalDateTime.now()
            messageRepository.save(message)
        }

        val actionButtons = if (message.receiverId == currentAdminId && message.isRead) {
            """
            <button class="btn btn-primary" onclick="markMessageAsUnread('\${message.messageId}', 'detail')">\${i18n.t("mark_as_unread", lang)}</button>
            <button class="btn btn-danger" onclick="handleMessageDelete('\${message.messageId}')">\${i18n.t("delete", lang)}</button>
            """
        } else ""

        val statusHtml = if (message.isRead) {
            """<span class="status-read">\${i18n.t("read_at", lang)} \${message.timeRead}</span>"""
        } else {
            """<span class="status-unread">\${i18n.t("unread", lang)}</span>"""
        }

        return """
        <div class="back-controls">
            <button id="back-to-list" class="btn btn-secondary" onclick="backToList('message')">\${i18n.t("back_to_list", lang)}</button>
            \$actionButtons
        </div>
        <div class="message-container">
            <div class="message-header">
                <h3>\${message.subject ?: ""}</h3>
                <div class="message-meta">
                    <div><strong>\${i18n.t("from", lang)}:</strong> \${message.sender?.name ?: i18n.t("system", lang)}</div>
                    <div><strong>\${i18n.t("to", lang)}:</strong> \${message.receiver?.name ?: i18n.t("system", lang)}</div>
                    <div><strong>\${i18n.t("time", lang)}:</strong> \${message.timeCreate}</div>
                    <div><strong>\${i18n.t("status", lang)}:</strong> \$statusHtml</div>
                </div>
            </div>
            <div class="message-body">
                \${message.content?.replace("\n", "<br>") ?: ""}
            </div>
        </div>
        """.trimIndent()
    }
}
KOTLIN;
    }
    private function generateNotificationController()
    {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.controller.core

import $package.model.repository.core.AdminRepository
import $package.model.repository.core.NotificationRepository
import $package.util.I18nUtil
import jakarta.servlet.http.HttpServletRequest
import jakarta.servlet.http.HttpSession
import org.springframework.data.domain.PageRequest
import org.springframework.data.domain.Sort
import org.springframework.http.HttpStatus
import org.springframework.http.MediaType
import org.springframework.http.ResponseEntity
import org.springframework.stereotype.Controller
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.PostMapping
import org.springframework.web.bind.annotation.RequestHeader
import org.springframework.web.bind.annotation.RequestParam
import java.time.LocalDateTime

@Controller
class NotificationController(
    private val notificationRepository: NotificationRepository,
    private val adminRepository: AdminRepository,
    private val i18n: I18nUtil
) {

    private fun getCurrentAdminId(session: HttpSession): String? {
        return session.getAttribute("adminId") as? String
    }

    @GetMapping("/notification")
    fun handleNotificationGet(
        @RequestParam(required = false) notificationId: String?,
        @RequestParam(required = false) search: String?,
        @RequestParam(defaultValue = "1") page: Int,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?,
        session: HttpSession,
        request: HttpServletRequest
    ): ResponseEntity<String> {
        val currentAdminId = getCurrentAdminId(session)
            ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(i18n.t("unauthorized", lang))

        val admin = adminRepository.findById(currentAdminId).orElse(null)
            ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(i18n.t("admin_not_found", lang))

        val htmlContent = if (notificationId != null) {
            buildDetailView(notificationId, admin.adminId, admin.adminLevelId, request.remoteAddr, lang)
        } else {
            buildListView(search, page, admin.adminId, admin.adminLevelId, lang)
        }

        return ResponseEntity.ok().contentType(MediaType.TEXT_HTML).body(htmlContent)
    }

    @PostMapping("/notification")
    fun handleNotificationPost(
        session: HttpSession,
        request: HttpServletRequest,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?
    ): ResponseEntity<*> {
        val currentAdminId = getCurrentAdminId(session)
            ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(mapOf("success" to false, "message" to i18n.t("unauthorized", lang)))

        val admin = adminRepository.findById(currentAdminId).orElse(null)
            ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(mapOf("success" to false, "message" to i18n.t("admin_not_found", lang)))

        val params = request.parameterMap.mapValues { it.value.firstOrNull() ?: "" }
        val action = params["action"]
        val notificationId = params["notificationId"] ?: return ResponseEntity.badRequest().body(mapOf("success" to false, "message" to i18n.t("notification_id_required", lang)))

        return try {
            when (action) {
                "mark_as_unread" -> markAsUnread(notificationId, admin.adminId, admin.adminLevelId, lang)
                "delete" -> deleteNotification(notificationId, admin.adminId, admin.adminLevelId, lang)
                else -> ResponseEntity.badRequest().body(mapOf("success" to false, "message" to i18n.t("invalid_action", lang)))
            }
        } catch (e: Exception) {
            ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(mapOf("success" to false, "message" to e.message))
        }
    }

    private fun markAsUnread(notificationId: String, adminId: String, adminLevelId: String?, lang: String?): ResponseEntity<*> {
        val notification = notificationRepository.findById(notificationId).orElseThrow { RuntimeException(i18n.t("notification_not_found", lang)) }
        if (notification.adminId == adminId || notification.adminGroup == adminLevelId) {
            notification.isRead = false
            notification.timeRead = null
            notificationRepository.save(notification)
            return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("notification_marked_as_unread", lang)))
        }
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(mapOf("success" to false, "message" to i18n.t("forbidden", lang)))
    }

    private fun deleteNotification(notificationId: String, adminId: String, adminLevelId: String?, lang: String?): ResponseEntity<*> {
        val notification = notificationRepository.findById(notificationId).orElseThrow { RuntimeException(i18n.t("notification_not_found", lang)) }
        if (notification.adminId == adminId || notification.adminGroup == adminLevelId) {
            notificationRepository.delete(notification)
            return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("notification_deleted_successfully", lang)))
        }
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(mapOf("success" to false, "message" to i18n.t("forbidden", lang)))
    }

    private fun buildListView(search: String?, page: Int, adminId: String, adminLevelId: String?, lang: String?): String {
        val pageSize = 20
        val pageable = PageRequest.of(page - 1, pageSize, Sort.by("timeCreate").descending())

        val notificationPage = if (!search.isNullOrBlank()) {
            notificationRepository.findByAdminIdOrAdminGroupAndSearch(adminId, adminLevelId, search, pageable)
        } else {
            notificationRepository.findByAdminIdOrAdminGroup(adminId, adminLevelId, pageable)
        }

        val notifications = notificationPage.content

        val notificationItems = if (notifications.isNotEmpty()) {
            notifications.joinToString("") { notification ->
                val isReadClass = if (notification.isRead) "read" else "unread"
                val contentSnippet = notification.content?.take(150)?.let { if (it.length == 150) "\$it..." else it } ?: ""
                val actionButtons = if (notification.isRead) {
                    """
                    <button class="btn btn-sm btn-secondary" onclick="markNotificationAsUnread('\${notification.notificationId}', 'list')">\${i18n.t("mark_as_unread", lang)}</button>
                    <button class="btn btn-sm btn-danger" onclick="handleNotificationDelete('\${notification.notificationId}')">\${i18n.t("delete", lang)}</button>
                    """
                } else ""

                """
                <div class="message-item \$isReadClass">
                    <span class="message-status-indicator"></span>
                    <div class="notification-header">
                        <div class="message-link-wrapper">
                            <a href="#notification?notificationId=\${notification.notificationId}" class="message-link">
                                <span class="message-subject">\${notification.subject ?: ""}</span>
                            </a>
                            <span class="message-time">\${notification.timeCreate}</span>
                            \$actionButtons
                        </div>
                    </div>
                    <div class="message-content">\${contentSnippet}</div>
                </div>
                """
            }
        } else {
            "<p>No notification</p>"
        }

        // Simplified pagination for brevity
        return """
        <div id="filter-container" class="filter-container" style="display: block;">
            <form id="notification-search-form" class="search-form" onsubmit="handleNotificationSearch(event)">
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="search_notification">\${i18n.t("search", lang)}</label>
                        <input type="text" name="search" id="search_notification" placeholder="\${i18n.t("search", lang)}" value="\${search ?: ""}">
                    </div>
                    <button type="submit" class="btn btn-primary">\${i18n.t("search", lang)}</button>
                </div>
            </form>
        </div>
        <div class="message-list-container">
            \$notificationItems
        </div>
        """.trimIndent()
    }

    private fun buildDetailView(notificationId: String, adminId: String, adminLevelId: String?, ipRead: String, lang: String?): String {
        val notificationOpt = notificationRepository.findByIdAndAdmin(notificationId, adminId, adminLevelId)
        if (notificationOpt.isEmpty) {
            return """<div class="table-container detail-view">\${i18n.t("no_notification", lang)}</div>"""
        }

        val notification = notificationOpt.get()

        // Mark as read
        if (!notification.isRead) {
            notification.isRead = true
            notification.timeRead = LocalDateTime.now()
            notification.ipRead = ipRead
            notificationRepository.save(notification)
        }

        val actionButtons = if (notification.isRead) {
            """
            <button class="btn btn-primary" onclick="markNotificationAsUnread('\${notification.notificationId}', 'detail')">\${i18n.t("mark_as_unread", lang)}</button>
            <button class="btn btn-danger" onclick="handleNotificationDelete('\${notification.notificationId}')">\${i18n.t("delete", lang)}</button>
            """
        } else ""

        val statusHtml = if (notification.isRead) {
            """<span class="status-read">\${i18n.t("read_at", lang)} \${notification.timeRead}</span>"""
        } else {
            """<span class="status-unread">\${i18n.t("unread", lang)}</span>"""
        }

        val linkButton = if (!notification.link.isNullOrBlank()) {
            """<p><a href="\${notification.link}" target="_blank" class="btn btn-primary mt-3">\${i18n.t("more_info", lang)}</a></p>"""
        } else ""

        return """
        <div class="back-controls">
            <button id="back-to-list" class="btn btn-secondary" onclick="backToList('notification')">\${i18n.t("back_to_list", lang)}</button>
            \$actionButtons
        </div>
        <div class="notification-container">
            <div class="notification-header">
                <h3>\${notification.subject ?: ""}</h3>
                <div class="message-meta">
                    <div><strong>\${i18n.t("time", lang)}:</strong> \${notification.timeCreate}</div>
                    <div><strong>\${i18n.t("status", lang)}:</strong> \$statusHtml</div>
                </div>
            </div>
            <div class="message-body">
                \${notification.content?.replace("\n", "<br>") ?: ""}
                \$linkButton
            </div>
        </div>
        """.trimIndent()
    }
}
KOTLIN;
    }

    private function generateUserProfileController()
    {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.controller.core

import $package.model.repository.core.AdminRepository
import jakarta.servlet.http.HttpSession
import org.springframework.graphql.data.method.annotation.QueryMapping
import org.springframework.security.access.prepost.PreAuthorize
import org.springframework.stereotype.Controller

data class UserProfile(val username: String)

@Controller
class UserProfileController(private val adminRepository: AdminRepository) {

    @QueryMapping
    @PreAuthorize("isAuthenticated()")
    fun userProfile(session: HttpSession): UserProfile? {
        val username = session.getAttribute("username") as? String
        if (username != null) {
            val adminOptional = adminRepository.findByUsername(username)
            if (adminOptional.isPresent) {
                val admin = adminOptional.get()
                return UserProfile(username = admin.username!!)
            }
        }
        return null
    }

    @QueryMapping
    fun me(session: HttpSession): Map<String, Any?> {
        return mapOf("username" to session.getAttribute("username"))
    }
}
KOTLIN;

    }

    private function generateAdminController() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.controller.core

import $package.config.Sha1PasswordEncoder
import $package.util.I18nUtil
import $package.model.entity.core.Admin
import $package.model.repository.core.AdminLevelRepository
import $package.model.repository.core.AdminRepository
import jakarta.servlet.http.HttpServletRequest
import jakarta.servlet.http.HttpSession
import org.springframework.data.domain.PageRequest
import org.springframework.data.domain.Sort
import org.springframework.data.jpa.domain.Specification
import org.springframework.http.HttpStatus
import org.springframework.http.MediaType
import org.springframework.http.ResponseEntity
import org.springframework.stereotype.Controller
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.RequestHeader
import org.springframework.web.bind.annotation.PostMapping
import org.springframework.web.bind.annotation.RequestParam
import $package.model.entity.core.AdminLevel
import java.time.LocalDateTime
import java.util.UUID

@Controller
class AdminController(
    private val adminRepository: AdminRepository,
    private val adminLevelRepository: AdminLevelRepository,
    private val passwordEncoder: Sha1PasswordEncoder,
    private val i18n: I18nUtil
) {

    private fun getCurrentAdminId(session: HttpSession): String? {
        return session.getAttribute("adminId") as? String
    }

    @GetMapping("/admin")
    fun handleAdminGet(
        @RequestParam(required = false) action: String?,
        @RequestParam(required = false) adminId: String?,
        @RequestParam(required = false) search: String?,
        @RequestParam(defaultValue = "1") page: Int,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?,
        session: HttpSession,
        request: HttpServletRequest
    ): ResponseEntity<String> {
        val currentAdminId = getCurrentAdminId(session)
            ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(i18n.t("unauthorized", lang))

        val htmlContent = when (action) {
            "create" -> buildCreateEditForm(null, lang)
            "edit" -> adminRepository.findById(adminId ?: "").map { buildCreateEditForm(it, lang) }.orElse(i18n.t("admin_not_found", lang))
            "change-password" -> buildChangePasswordForm(adminId, lang)
            "detail" -> adminRepository.findById(adminId ?: "").map { buildDetailView(it, currentAdminId, lang) }.orElse(i18n.t("admin_not_found", lang))
            else -> buildListView(search, page, currentAdminId, lang)
        }

        return ResponseEntity.ok().contentType(MediaType.TEXT_HTML).body(htmlContent)
    }

    @PostMapping("/admin")
    fun handleAdminPost(
        @RequestParam action: String,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?,
        session: HttpSession,
        request: HttpServletRequest
    ): ResponseEntity<*> {
        val currentAdminId = getCurrentAdminId(session)
            ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(mapOf("success" to false, "message" to i18n.t("unauthorized", lang)))

        // Manually build the parameters map from the request to reliably handle multipart/form-data
        val params = request.parameterMap.mapValues { entry ->
            entry.value.firstOrNull() ?: ""
        }
        return try {
            when (params["action"]) {
                "create" -> createAdmin(params, currentAdminId, request.remoteAddr, lang)
                "update" -> updateAdmin(params, currentAdminId, request.remoteAddr, lang)
                "toggle_active" -> toggleAdminActive(params, currentAdminId, lang)
                "change_password" -> changeAdminPassword(params, lang)
                "delete" -> deleteAdmin(params, currentAdminId, lang)
                else -> ResponseEntity.badRequest().body(mapOf("success" to false, "message" to i18n.t("invalid_action", lang)))
            }
        } catch (e: Exception) {
            ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(mapOf("success" to false, "message" to e.message))
        }
    }

    private fun createAdmin(params: Map<String, String>, currentAdminId: String, ip: String, lang: String?): ResponseEntity<*> {
        val password = params["password"] ?: throw IllegalArgumentException(i18n.t("password_is_required", lang))
        if (password.isBlank()) throw IllegalArgumentException(i18n.t("password_is_required", lang))

        val username = params["username"] ?: throw IllegalArgumentException("Username is required.")
        val newAdmin = Admin(
            adminId = UUID.randomUUID().toString(),
            name = params["name"],
            username = username,
            email = params["email"],
            password = passwordEncoder.encode(password),
            adminLevelId = params["admin_level_id"],
            active = params["active"] == "on",
            timeCreate = LocalDateTime.now(),
            adminCreate = currentAdminId,
            ipCreate = ip
        )
        adminRepository.save(newAdmin)
        return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("admin_created_successfully", lang)))
    }

    private fun updateAdmin(params: Map<String, String>, currentAdminId: String, ip: String, lang: String?): ResponseEntity<*> {
        val adminId = params["adminId"] ?: throw IllegalArgumentException(i18n.t("admin_id_required", lang))
        val adminToUpdate = adminRepository.findById(adminId).orElseThrow { RuntimeException(i18n.t("admin_not_found", lang)) }

        var active = params["active"] == "on"
        var adminLevelId = params["admin_level_id"]

        // Prevent user from deactivating or changing their own level
        if (adminId == currentAdminId) {
            active = true
            adminLevelId = adminToUpdate.adminLevelId
        }

        val username = params["username"] ?: adminToUpdate.username
        val updatedAdmin = adminToUpdate.copy(
            name = params["name"],
            username = username,
            email = params["email"],
            adminLevelId = adminLevelId,
            active = active,
            timeEdit = LocalDateTime.now(),
            adminEdit = currentAdminId, // This will now work
            ipEdit = ip // This will now work
        )
        adminRepository.save(updatedAdmin)
        return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("admin_updated_successfully", lang)))
    }

    private fun toggleAdminActive(params: Map<String, String>, currentAdminId: String, lang: String?): ResponseEntity<*> {
        val adminId = params["adminId"] ?: throw IllegalArgumentException(i18n.t("admin_id_required", lang))
        if (adminId == currentAdminId) throw IllegalStateException(i18n.t("cannot_deactivate_self", lang))

        val admin = adminRepository.findById(adminId).orElseThrow { RuntimeException(i18n.t("admin_not_found", lang)) }
        admin.active = !admin.active
        adminRepository.save(admin)
        return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("admin_status_updated", lang)))
    }

    private fun changeAdminPassword(params: Map<String, String>, lang: String?): ResponseEntity<*> {
        val adminId = params["adminId"] ?: throw IllegalArgumentException(i18n.t("admin_id_required", lang))
        val password = params["password"] ?: throw IllegalArgumentException(i18n.t("password_is_required", lang))
        if (password.isBlank()) throw IllegalArgumentException(i18n.t("password_is_required", lang))

        val admin = adminRepository.findById(adminId).orElseThrow { RuntimeException(i18n.t("admin_not_found", lang)) }
        admin.password = passwordEncoder.encode(password)
        adminRepository.save(admin)
        return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("password_updated_successfully", lang)))
    }

    private fun deleteAdmin(params: Map<String, String>, currentAdminId: String, lang: String?): ResponseEntity<*> {
        val adminId = params["adminId"] ?: throw IllegalArgumentException(i18n.t("admin_id_required", lang))
        if (adminId == currentAdminId) throw IllegalStateException(i18n.t("cannot_delete_self", lang))

        adminRepository.deleteById(adminId)
        return ResponseEntity.ok(mapOf("success" to true, "message" to i18n.t("admin_deleted_successfully", lang)))
    }

    // --- HTML View Builders ---
    
    private fun otherUsersController(admin: Admin, currentAdminId: String, lang: String?): String {
        if (admin.adminId == currentAdminId) {
            return ""
        }
        val toggleAction = if (admin.active) i18n.t("deactivate", lang) else i18n.t("activate", lang)
        val toggleClass = if (admin.active) "btn-warning" else "btn-success"
        return """
            <a href="javascript:;" onclick="handleAdminToggleActive('\${admin.adminId}')" class="btn btn-sm \${toggleClass}">\${toggleAction}</a>
            <a href="javascript:;" onclick="handleAdminDelete('\${admin.adminId}')" class="btn btn-sm btn-danger">\${i18n.t("delete", lang)}</a>
        """.trimIndent()
    }

    private fun buildListView(search: String?, page: Int, currentAdminId: String, lang: String?): String {
        val pageSize = 20
        val pageable = PageRequest.of(page - 1, pageSize, Sort.by("name"))

        val adminPage = if (!search.isNullOrBlank()) {
            adminRepository.findByNameContainingOrUsernameContaining(search, search, pageable)
        } else {
            adminRepository.findAll(pageable)
        }

        val admins = adminPage.content 
        

        val rows = if (admins.isNotEmpty()) {
            admins.joinToString("") { admin: Admin ->
                """
                <tr class="\${if (!admin.active) "inactive" else "active"}">
                    <td>\${admin.name ?: ""}</td>
                    <td>\${admin.username ?: ""}</td>
                    <td>\${admin.email ?: ""}</td>
                    <td>\${admin.adminLevel?.name ?: ""}</td>
                    <td>\${if (admin.active) i18n.t("active", lang) else i18n.t("inactive", lang)}</td>
                    <td class="actions">
                        <a href="#admin?action=detail&adminId=\${admin.adminId}" class="btn btn-sm btn-info">\${i18n.t("view", lang)}</a>
                        <a href="#admin?action=edit&adminId=\${admin.adminId}" class="btn btn-sm btn-primary">\${i18n.t("edit", lang)}</a>
                        \${otherUsersController(admin, currentAdminId, lang)}
                    </td>
                </tr>
                """.trimIndent()
            }
        } else {
            """<tr><td colspan="6">\${i18n.t("no_admins_found", lang)}</td></tr>"""
        }

        // Simplified pagination for brevity
        return """
        <div id="filter-container" class="filter-container" style="display: block;">
            <form id="admin-search-form" class="search-form" onsubmit="handleAdminSearch(event)"> 
                <div class="filter-controls">
                    
                    <div class="form-group">
                        <label for="username">\${i18n.t("name", lang)} or \${i18n.t("username", lang)}</label>
                        <input type="text" name="search" id="username" placeholder="\${i18n.t("name", lang)} or \${i18n.t("username", lang)}" value="\${search ?: ""}">
                    </div>
                    <button type="submit" class="btn btn-primary">\${i18n.t("search", lang)}</button>
                    <a href="#admin?action=create" class="btn btn-primary">\${i18n.t("add_new_admin", lang)}</a>
                    
                </div>
            </form>
        </div>

        <div class="table-container">
            <table class="table table-data-list table-striped">
                <thead><tr><th>\${i18n.t("name", lang)}</th><th>\${i18n.t("username", lang)}</th><th>\${i18n.t("email", lang)}</th><th>\${i18n.t("admin_level", lang)}</th><th>\${i18n.t("status", lang)}</th><th>\${i18n.t("actions", lang)}</th></tr></thead>
                <tbody>\$rows</tbody>
            </table>
        </div>
        """.trimIndent()
    }

    private fun buildDetailView(admin: Admin, currentAdminId: String, lang: String?): String {
        val actionButtons = if (admin.adminId != currentAdminId) {
            """
            <a href="#admin?action=change-password&adminId=\${admin.adminId}" class="btn btn-warning">\${i18n.t("update_password", lang)}</a>
            <button class="btn \${if (admin.active) "btn-warning" else "btn-success"}" onclick="handleAdminToggleActive('\${admin.adminId}')">
                \${if (admin.active) i18n.t("deactivate", lang) else i18n.t("activate", lang)}
            </button>
            <button class="btn btn-danger" onclick="handleAdminDelete('\${admin.adminId}')">\${i18n.t("delete", lang)}</button>
            """.trimIndent()
        } else ""

        return """
        <div class="back-controls">
            <a href="#admin" class="btn btn-secondary">\${i18n.t("back_to_list", lang)}</a>
            <a href="#admin?action=edit&adminId=\${admin.adminId}" class="btn btn-primary">\${i18n.t("edit", lang)}</a>
            \$actionButtons
        </div>
        <div class="table-container detail-view">
            <table class="table">
                <tbody>
                    <tr><td><strong>\${i18n.t("admin_id", lang)}</strong></td><td>\${admin.adminId}</td></tr>
                    <tr><td><strong>\${i18n.t("name", lang)}</strong></td><td>\${admin.name ?: ""}</td></tr>
                    <tr><td><strong>\${i18n.t("username", lang)}</strong></td><td>\${admin.username ?: ""}</td></tr>
                    <tr><td><strong>\${i18n.t("email", lang)}</strong></td><td>\${admin.email ?: ""}</td></tr>
                    <tr><td><strong>\${i18n.t("admin_level", lang)}</strong></td><td>\${admin.adminLevel?.name ?: ""}</td></tr>
                    <tr><td><strong>\${i18n.t("status", lang)}</strong></td><td>\${if (admin.active) i18n.t("active", lang) else i18n.t("inactive", lang)}</td></tr>
                    <tr><td><strong>\${i18n.t("time_create", lang)}</strong></td><td>\${admin.timeCreate}</td></tr>
                    <tr><td><strong>\${i18n.t("time_edit", lang)}</strong></td><td>\${admin.timeEdit ?: ""}</td></tr>
                </tbody>
            </table>
        </div>
        """.trimIndent()
    }

    private fun buildCreateEditForm(admin: Admin?, lang: String?): String {
        val isCreate = admin == null
        val adminLevels = adminLevelRepository.findByActive(true)
        val levelOptions = adminLevels.joinToString("") { level: AdminLevel ->
            val selected = if (admin?.adminLevelId == level.adminLevelId) "selected" else ""
            """<option value="\${level.adminLevelId}" \$selected>\${level.name}</option>"""
        }

        return """
        <div class="back-controls">
            <a href="#admin" class="btn btn-secondary">\${i18n.t("back_to_list", lang)}</a>
        </div>
        <div class="table-container detail-view">
            <h3>\${if (isCreate) i18n.t("add_new_admin", lang) else i18n.t("edit_admin", lang)}</h3>
            <form id="admin-form" class="form-group" onsubmit="handleAdminSave(event, '\${admin?.adminId ?: ""}'); return false;">
                <input type="hidden" name="action" value="\${if (isCreate) "create" else "update"}">
                <input type="hidden" name="adminId" value="\${admin?.adminId ?: ""}">
                <table class="table table-borderless">
                    <tr>
                        <td>\${i18n.t("name", lang)}</td>
                        <td><input type="text" name="name" value="\${admin?.name ?: ""}" required autocomplete="off"></td>
                    </tr>
                    <tr>
                        <td>\${i18n.t("username", lang)}</td>
                        <td><input type="text" name="username" value="\${admin?.username ?: ""}" required autocomplete="off"></td>
                    </tr>
                    <tr>
                        <td>\${i18n.t("email", lang)}</td>
                        <td><input type="email" name="email" value="\${admin?.email ?: ""}" required autocomplete="off"></td>
                    </tr>
                    \${if (isCreate) """
                    <tr>
                        <td>\${i18n.t("password", lang)}</td>
                        <td><input type="password" name="password" required autocomplete="new-password"></td>
                    </tr>
                    """ else ""}
                    <tr>
                        <td>\${i18n.t("admin_level", lang)}</td>
                        <td>
                            <select name="admin_level_id" required>
                                <option value="">\${i18n.t("select_option", lang)}</option>
                                \$levelOptions
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>\${i18n.t("active", lang)}</td>
                        <td><input type="checkbox" name="active" \${if (admin?.active != false) "checked" else ""} value="on"></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button type="submit" class="btn btn-success">\${i18n.t("save", lang)}</button>
                            <a href="#admin" class="btn btn-secondary">\${i18n.t("cancel", lang)}</a>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        """.trimIndent()
    }

    private fun buildChangePasswordForm(adminId: String?, lang: String?): String {
        if (adminId.isNullOrBlank()) return i18n.t("admin_id_required", lang)
        return """
        <div class="back-controls">
            <a href="#admin?action=detail&adminId=\$adminId" class="btn btn-secondary">\${i18n.t("back_to_detail", lang)}</a>
        </div>
        <div class="table-container detail-view">
            <h3>Change Password</h3>
            <form id="change-password-form" class="form-group" onsubmit="handleAdminChangePassword(event, '\$adminId'); return false;">
                 <input type="hidden" name="action" value="change_password">
                 <input type="hidden" name="adminId" value="\$adminId">
                <table class="table table-borderless">
                    <tr>
                        <td>\${i18n.t("new_password", lang)}</td>
                        <td><input type="password" name="password" required autocomplete="new-password"></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button type="submit" class="btn btn-success">\${i18n.t("update", lang)}</button>
                            <a href="#admin?action=detail&adminId=\$adminId" class="btn btn-secondary">\${i18n.t("cancel", lang)}</a>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        """.trimIndent()
    }
}
KOTLIN;
    }
    /**
     * Generates the AuthController class in Kotlin.
     * @return string The Kotlin code for AuthController.kt.
     */
    private function generateAuthController() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.controller.core

import $package.config.Sha1PasswordEncoder
import $package.controller.dto.LoginResponse
import $package.util.I18nUtil
import $package.model.repository.core.AdminRepository
import jakarta.servlet.http.HttpServletRequest
import jakarta.servlet.http.HttpSession
import org.springframework.beans.factory.annotation.Value
import org.springframework.http.HttpStatus
import org.springframework.http.ResponseEntity
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken
import org.springframework.security.core.authority.SimpleGrantedAuthority
import org.springframework.security.core.context.SecurityContextHolder
import org.springframework.web.bind.annotation.RequestHeader
import org.springframework.web.bind.annotation.*


@RestController
class AuthController(
    private val adminRepository: AdminRepository,
    private val passwordEncoder: Sha1PasswordEncoder,
    private val i18n: I18nUtil,
    @Value("\\\${app.security.require-login}")
    private val requireLogin: Boolean
) {

    @PostMapping("/login")
    fun login(
        @RequestParam username: String,
        @RequestParam password: String,
        session: HttpSession,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?
    ): ResponseEntity<LoginResponse> {

        if (!requireLogin) {
            return ResponseEntity.ok(LoginResponse(true, i18n.t("success", lang)))
        }

        val singleHashedPassword = passwordEncoder.sha1(password)
        val adminOptional = adminRepository.findByUsername(username)

        if (adminOptional.isPresent) {
            val admin = adminOptional.get()
            if (admin.password == passwordEncoder.encode(password)) {
                session.setAttribute("username", admin.username!!)
                session.setAttribute("password", singleHashedPassword)
                session.setAttribute("adminId", admin.adminId)

                val authorities = listOf(SimpleGrantedAuthority("ROLE_ADMIN"))
                val auth = UsernamePasswordAuthenticationToken(admin.username, null, authorities)
                SecurityContextHolder.getContext().authentication = auth

                return ResponseEntity.ok(LoginResponse(true, i18n.t("login_successful", lang)))
            }
        }

        return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
            .body(LoginResponse(false, i18n.t("invalid_credentials", lang)))
    }

    @RequestMapping(value = ["/logout"], method = [RequestMethod.GET, RequestMethod.POST])
    fun logout(
        request: HttpServletRequest,
        @RequestHeader(value = "X-Language-Id", required = false) lang: String?
    ): ResponseEntity<LoginResponse> {
        if (!requireLogin) {
            return ResponseEntity.ok(LoginResponse(true, i18n.t("success", lang)))
        }
        request.session.invalidate()
        SecurityContextHolder.clearContext()
        return ResponseEntity.ok(LoginResponse(true, i18n.t("logout_successful", lang)))
    }
}
KOTLIN;
    }

    // The following methods are placeholders for the full conversion.
    // The original Java generator has many more files it creates (Admin entities, Auth controllers, etc.).
    // Each would need a corresponding `generate...Kt()` method here.

    /**
     * Get whether to enable verbose logging in the generated application.
     *
     * @return bool True if verbose logging is enabled, false otherwise.
     */ 
    public function getVerboseLogging()
    {
        return $this->verboseLogging;
    }

    private function findPrimaryKeyInfo($tableInfo)
    {
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            if ($colInfo['isPrimaryKey']) {
                return array_merge($colInfo, ['name' => $colName]);
            }
        }
        return null;
    }

    private function generateDtoToEntityMappingKt($tableName, $tableInfo, $entityVar, $dtoVar, $action) {
        $mappingCode = "";

        $backendHandledColumnNames = $this->getBackendHandledColumnNames();

        if ($action == 'create') {
            $pkInfo = $this->findPrimaryKeyInfo($tableInfo);
            if ($pkInfo && !$pkInfo['isAutoIncrement'] && $pkInfo['primaryKeyValue'] != 'autogenerated') {
                $pkCamelCase = $this->camelCase($pkInfo['name']);
                $mappingCode .= "        if (dtoInput.$pkCamelCase.isNullOrBlank()) {\n";
                $mappingCode .= "            throw RuntimeException(\"Invalid input: $pkCamelCase is required\")\n";
                $mappingCode .= "        }\n";
            }
        }
        $columnNames = [];
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            $columnNames[] = $colName;
            if ($colName === $tableInfo['primaryKey'] && ($colInfo['isAutoIncrement'] || $colInfo['primaryKeyValue'] == 'autogenerated' || $action == 'update')) {
                continue;
            }
            if (in_array($colName, $backendHandledColumnNames)) {
                continue;
            }
            
            $camelColName = $this->camelCase($colName);
            $mappingCode .= "        dtoInput.$camelColName?.let { $entityVar.$camelColName = it }\n";
        }

        $hasTimeEdit = false;
        $hasAdminEdit = false;
        $hasIpEdit = false;

        foreach($this->backendHandledColumns as $key => $col) {
            if ($action == 'create' && $key == 'timeCreate' && in_array($col['columnName'], $columnNames)) {
                $mappingCode .= "        $entityVar.".$this->camelCase($col['columnName'])." = java.time.LocalDateTime.now()\n";
            }
            if ($action == 'create' && $key == 'adminCreate' && in_array($col['columnName'], $columnNames)) {
                $mappingCode .= "        $entityVar.".$this->camelCase($col['columnName'])." = AuditTrailUtil.getUserId()\n";
            }
            if ($action == 'create' && $key == 'ipCreate' && in_array($col['columnName'], $columnNames)) {
                $mappingCode .= "        $entityVar.".$this->camelCase($col['columnName'])." = AuditTrailUtil.getUserIp()\n";
            }
            if ($key == 'timeEdit' && in_array($col['columnName'], $columnNames)) {
                $hasTimeEdit = true;
            }
            if ($key == 'adminEdit' && in_array($col['columnName'], $columnNames)) {
                $hasAdminEdit = true;
            }
            if ($key == 'ipEdit' && in_array($col['columnName'], $columnNames)) {
                $hasIpEdit = true;
            }
        }

        if ($hasTimeEdit) $mappingCode .= "        $entityVar.".$this->camelCase($this->backendHandledColumns['timeEdit']['columnName'])." = java.time.LocalDateTime.now()\n";
        if ($hasAdminEdit) $mappingCode .= "        $entityVar.".$this->camelCase($this->backendHandledColumns['adminEdit']['columnName'])." = AuditTrailUtil.getUserId()\n";
        if ($hasIpEdit) $mappingCode .= "        $entityVar.".$this->camelCase($this->backendHandledColumns['ipEdit']['columnName'])." = AuditTrailUtil.getUserIp()\n";

        return $mappingCode;
    }

    private function generateToggleActiveMutationKt($tableName, $tableInfo)
    {
        if (!$tableInfo['hasActiveColumn']) {
            return "";
        }
        
        $columnNames = [];

        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            $columnNames[] = $colName;
        }

        $camelName = $this->camelCase($tableName);
        $ucCamelName = $this->pascalCase($tableName);
        $activeField = $this->activeField;
        $camelActiveField = $this->camelCase($activeField);
        $ucActiveField = $this->pascalCase($activeField);
        
        $pkInfo = $this->findPrimaryKeyInfo($tableInfo);
        $pkKotlinType = $pkInfo ? $this->mapDbTypeToKotlinType($pkInfo['type'], $pkInfo['length']) : 'String';

        $mappingCode = "";
        if (isset($this->backendHandledColumns['timeEdit']) && in_array($this->backendHandledColumns['timeEdit']['columnName'], $columnNames)) {
            $mappingCode .= "        entity.".$this->camelCase($this->backendHandledColumns['timeEdit']['columnName'])." = java.time.LocalDateTime.now()\n";
        }
        if (isset($this->backendHandledColumns['adminEdit']) && in_array($this->backendHandledColumns['adminEdit']['columnName'], $columnNames)) {
            $mappingCode .= "        entity.".$this->camelCase($this->backendHandledColumns['adminEdit']['columnName'])." = AuditTrailUtil.getUserId()\n";
        }
        if (isset($this->backendHandledColumns['ipEdit']) && in_array($this->backendHandledColumns['ipEdit']['columnName'], $columnNames)) {
            $mappingCode .= "        entity.".$this->camelCase($this->backendHandledColumns['ipEdit']['columnName'])." = AuditTrailUtil.getUserIp()\n";
        }

        return <<<KOTLIN

    @MutationMapping
    @Transactional
    fun toggle{$ucCamelName}Active(
        @Argument id: $pkKotlinType,
        @Argument(name = "$activeField") $activeField: Boolean
    ): $ucCamelName {
        val lang = AuditTrailUtil.getLanguageId()
        val entity = {$camelName}Repository.findById(id)
                .orElseThrow { RuntimeException(i18n.t("no_item_found_with_id", lang, "$tableName", id)) }
        entity.$camelActiveField = $activeField
$mappingCode
        return {$camelName}Repository.save(entity)
    }
KOTLIN;
    }

    private function generateFieldResolversKt($tableName, $tableInfo) {
        $resolvers = "";
        $ucCamelTableName = $this->pascalCase($tableName);
        $camelTableName = $this->camelCase($tableName);
    
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            $camelColName = $this->camelCase($colName);
            $ucCamelColName = $this->pascalCase($colName);
    
            if ($colName !== $camelColName) {
                $kotlinType = $this->mapDbTypeToKotlinType($colInfo['type'], $colInfo['length']);
                $baseKotlinType = basename(str_replace('\\', '/', $kotlinType));

                $returnValue = "$camelTableName.$camelColName";

                if(strpos($baseKotlinType, 'LocalDateTime') !== false) {
                    $baseKotlinType = 'String?';
                    $returnValue = "ScalarValueUtil.localDateTimeToString($returnValue)";
                }
                else if(strpos($baseKotlinType, 'LocalDate') !== false) {
                    $baseKotlinType = 'String?';
                    $returnValue = "ScalarValueUtil.localDateToString($returnValue)";
                }
                else if(strpos($baseKotlinType, 'LocalTime') !== false) {
                    $baseKotlinType = 'String?';
                    $returnValue = "ScalarValueUtil.localTimeToString($returnValue)";
                }
                else {
                    $baseKotlinType = $baseKotlinType.'?';
                }

                $resolvers .= "\n    @SchemaMapping(typeName = \"$ucCamelTableName\", field = \"$colName\")\n";
                $resolvers .= "    fun get{$ucCamelColName}($camelTableName: $ucCamelTableName): $baseKotlinType {\n";
                $resolvers .= "        return $returnValue\n";
                $resolvers .= "    }\n";
            }
    
            if ($colInfo['isForeignKey']) {
                $refTableName = $colInfo['references'];
                $refCamelName = $this->camelCase($refTableName);
                $refUcCamelName = $this->pascalCase($refTableName);

                $resolvers .= "\n    @SchemaMapping(typeName = \"$ucCamelTableName\", field = \"$refTableName\")\n";
                $resolvers .= "    fun get".ucfirst($refCamelName)."($camelTableName: $ucCamelTableName): $refUcCamelName? {\n";
                $resolvers .= "        return $camelTableName.$refCamelName\n";
                $resolvers .= "    }\n";
            }
        }
    
        return $resolvers;
    }

    private function generateSpecificationBuilderKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.util

import jakarta.persistence.criteria.Predicate
import org.springframework.data.jpa.domain.Specification

class SpecificationBuilder<T> {
    private val params: MutableList<FilterCriteria> = mutableListOf()

    fun with(key: String, operation: SearchOperation, value: Any?): SpecificationBuilder<T> {
        params.add(FilterCriteria(key, operation, value))
        return this
    }

    fun build(): Specification<T>? {
        if (params.isEmpty()) {
            return null
        }

        val specs: List<Specification<T>> = params.map { criteria ->
            Specification<T> { root, query, builder ->
                val value = criteria.value
                val key = criteria.key
                when (criteria.operation) {
                    SearchOperation.EQUALS -> builder.equal(root.get<Any>(key), value)
                    SearchOperation.CONTAINS -> builder.like(root.get(key), "%\$value%")
                    SearchOperation.GREATER_THAN -> builder.greaterThan(root.get(key), value as Comparable<Any>)
                    SearchOperation.LESS_THAN -> builder.lessThan(root.get(key), value as Comparable<Any>)
                    else -> builder.conjunction() // Return a predicate that is always true for unhandled cases
                }
            }
        }

        return specs.reduceOrNull { acc, spec -> acc.and(spec) }
    }
}
KOTLIN;
    }

    private function generateFilterCriteriaKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.util

data class FilterCriteria(
    val key: String,
    val operation: SearchOperation,
    val value: Any?
)
KOTLIN;
    }

    private function generateSearchOperationKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.util

enum class SearchOperation {
    EQUALS,
    NOT_EQUALS,
    CONTAINS,
    GREATER_THAN,
    GREATER_THAN_OR_EQUALS,
    LESS_THAN,
    LESS_THAN_OR_EQUALS,
    IN,
    NOT_IN
}
KOTLIN;
    }

    private function generateGenericSpecificationKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.util

import jakarta.persistence.criteria.CriteriaBuilder
import jakarta.persistence.criteria.CriteriaQuery
import jakarta.persistence.criteria.Predicate
import jakarta.persistence.criteria.Root
import org.springframework.data.jpa.domain.Specification

class GenericSpecification<T>(private val criteria: FilterCriteria) : Specification<T> {

    override fun toPredicate(root: Root<T>, query: CriteriaQuery<*>, builder: CriteriaBuilder): Predicate? {
        val key = criteria.key
        val value = criteria.value
        val fieldType = root.get<Any>(key).javaType

        val typedValue = value?.let {
            val stringValue = it.toString()
            when (fieldType) {
                Integer::class.java, Int::class.java -> stringValue.toIntOrNull()
                Long::class.java, Long::class.java -> stringValue.toLongOrNull()
                Double::class.java, Double::class.java -> stringValue.toDoubleOrNull()
                Float::class.java, Float::class.java -> stringValue.toFloatOrNull()
                Boolean::class.java, Boolean::class.java -> stringValue.toBoolean()
                else -> stringValue
            }
        }

        @Suppress("UNCHECKED_CAST")
        return when (criteria.operation) {
            SearchOperation.EQUALS -> builder.equal(root.get<Any>(key), typedValue)
            SearchOperation.NOT_EQUALS -> builder.notEqual(root.get<Any>(key), typedValue)
            SearchOperation.GREATER_THAN -> {
                val comparableValue = typedValue as? Comparable<Any>
                comparableValue?.let { builder.greaterThan(root.get(key), it) }
            }
            SearchOperation.GREATER_THAN_OR_EQUALS -> {
                val comparableValue = typedValue as? Comparable<Any>
                comparableValue?.let { builder.greaterThanOrEqualTo(root.get(key), it) }
            }
            SearchOperation.LESS_THAN -> {
                val comparableValue = typedValue as? Comparable<Any>
                comparableValue?.let { builder.lessThan(root.get(key), it) }
            }
            SearchOperation.LESS_THAN_OR_EQUALS -> {
                val comparableValue = typedValue as? Comparable<Any>
                comparableValue?.let { builder.lessThanOrEqualTo(root.get(key), it) }
            }
            SearchOperation.CONTAINS -> if (fieldType == String::class.java) builder.like(root.get(key), "%\$typedValue%") else builder.equal(root.get<Any>(key), typedValue)
            SearchOperation.IN -> root.get<Any>(key).`in`(typedValue as? Collection<*>)
            SearchOperation.NOT_IN -> builder.not(root.get<Any>(key).`in`(typedValue as? Collection<*>))
        }
    }
}
KOTLIN;
    }

    /**
     * Generates the AuditTrailUtil object in Kotlin.
     * @return string The Kotlin code for AuditTrailUtil.kt.
     */
    private function generateAuditTrailUtilKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.util

import jakarta.servlet.http.HttpServletRequest
import org.springframework.web.context.request.RequestContextHolder
import org.springframework.web.context.request.ServletRequestAttributes

object AuditTrailUtil {

    /**
     * Retrieves the client's IP address from the current request.
     * It checks for the 'X-FORWARDED-FOR' header first.
     */
    fun getUserIp(): String? {
        val request = (RequestContextHolder.getRequestAttributes() as? ServletRequestAttributes)?.request ?: return null
        var remoteAddr = request.getHeader("X-FORWARDED-FOR")
        if (remoteAddr.isNullOrEmpty()) {
            remoteAddr = request.remoteAddr
        } else {
            remoteAddr = remoteAddr.split(",")[0].trim()
        }
        return remoteAddr
    }

    /**
     * Retrieves the ID of the currently authenticated admin user from the session.
     */
    fun getUserId(): String? {
        val request = (RequestContextHolder.getRequestAttributes() as? ServletRequestAttributes)?.request ?: return null
        val session = request.getSession(false)
        return session?.getAttribute("adminId") as? String
    }
}
KOTLIN;
    }

    /**
     * Generates the ValueUtil object in Kotlin for handling naming conversions and map-to-DTO conversions.
     * @return string The content of the ValueUtil class.
     */
    private function generateValueUtilKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.util

import com.fasterxml.jackson.databind.DeserializationFeature
import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule
import com.fasterxml.jackson.module.kotlin.registerKotlinModule

object ValueUtil {

    private val MAPPER: ObjectMapper = ObjectMapper().apply {
        registerKotlinModule()
        registerModule(JavaTimeModule())
        configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)
        configure(DeserializationFeature.ACCEPT_FLOAT_AS_INT, true)
    }

    /**
     * Converts a Map with snake_case keys directly to a target DTO.
     */
    fun <T> convertSnakeCaseToDto(snakeCaseMap: Map<String, Any>?, targetClass: Class<T>): T {
        val camelCaseMap = convertSnakeToCamelCase(snakeCaseMap)
        return MAPPER.convertValue(camelCaseMap, targetClass)
    }

    /**
     * Converts the keys of a Map from snake_case to camelCase.
     */
    private fun convertSnakeToCamelCase(snakeCaseMap: Map<String, Any>?): Map<String, Any> {
        if (snakeCaseMap == null) {
            return emptyMap()
        }
        return snakeCaseMap.mapKeys { toCamelCase(it.key) }
    }

    /**
     * Converts a single snake_case string to camelCase.
     */
    fun toCamelCase(snakeCase: String): String {
        return snakeCase.split('_').reduceIndexed { index, acc, part ->
            if (index == 0) part else acc + part.replaceFirstChar { it.uppercase() }
        }
    }
}
KOTLIN;
    }

    /**
     * Generates the `ScalarValueUtil` object in Kotlin.
     * @return string The content of the `ScalarValueUtil` class.
     */
    private function generateScalarValueUtilKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.util

import java.time.LocalDate
import java.time.LocalDateTime
import java.time.format.DateTimeFormatter

object ScalarValueUtil {

    private const val DATE_TIME_FORMAT = "yyyy-MM-dd HH:mm:ss"
    private const val DATE_FORMAT = "yyyy-MM-dd"

    private val dateTimeFormatter = DateTimeFormatter.ofPattern(DATE_TIME_FORMAT)
    private val dateFormatter = DateTimeFormatter.ofPattern(DATE_FORMAT)

    fun localDateTimeToString(datetime: LocalDateTime?): String? {
        return datetime?.format(dateTimeFormatter)
    }

    fun localDateToString(date: LocalDate?): String? {
        return date?.format(dateFormatter)
    }

    fun stringToLocalDateTime(datetime: String?): LocalDateTime? {
        return if (datetime.isNullOrEmpty()) null else LocalDateTime.parse(datetime, dateTimeFormatter)
    }

    fun stringToLocalDate(date: String?): LocalDate? {
        return if (date.isNullOrEmpty()) null else LocalDate.parse(date, dateFormatter)
    }
}
KOTLIN;
    }

    /**
     * Generates the ObjectScalar class for GraphQL custom scalar type in Kotlin.
     * @return string The Java code for ObjectScalar.java.
     */
    private function generateObjectScalarKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.config

import graphql.language.Value
import graphql.language.ObjectValue
import graphql.schema.Coercing
import graphql.schema.CoercingParseLiteralException
import graphql.GraphQLContext
import org.springframework.stereotype.Component
import java.util.Locale

@Component
class ObjectScalar : Coercing<Any?, Any?> {
    override fun serialize(dataFetcherResult: Any, graphQLContext: GraphQLContext, locale: Locale): Any? {
        return dataFetcherResult
    }

    override fun parseValue(input: Any, graphQLContext: GraphQLContext, locale: Locale): Any? {
        return input
    }

    fun parseLiteral(
        input: Value<*>,
        variables: Map<String, Any>,
        graphQLContext: GraphQLContext,
        locale: Locale
    ): Any? {
        return if (input is ObjectValue) {
            input.objectFields.associate { it.name to it.value }
        } else {
            throw CoercingParseLiteralException("Expected an ObjectValue literal but was: \$input")
        }
    }
}
KOTLIN;
    }

    /**
     * Generates the GraphQlConfig class for GraphQL configuration in Kotlin.
     * @return string The Java code for GraphQlConfig.java.
     */
    private function generateGraphQlConfigKt() {
        $package = $this->projectConfig['packageName'];
        return <<<KOTLIN
package $package.config

import $package.config.ObjectScalar
import graphql.schema.GraphQLScalarType
import org.springframework.context.annotation.Bean
import org.springframework.context.annotation.Configuration
import org.springframework.graphql.execution.RuntimeWiringConfigurer

@Configuration
class GraphQlConfig {
    @Bean
    fun runtimeWiringConfigurer(objectScalar: ObjectScalar): RuntimeWiringConfigurer {
        val objectScalar = GraphQLScalarType.newScalar()
            .name("Object")
            .description("A custom scalar that can represent any JSON-like object.")
            .coercing(objectScalar)
            .build()

        return RuntimeWiringConfigurer { builder ->
            builder.scalar(objectScalar)
        }
    }
}
KOTLIN;
    }

    
}