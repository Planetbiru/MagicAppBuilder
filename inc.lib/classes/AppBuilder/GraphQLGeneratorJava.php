<?php

namespace AppBuilder;
use MagicObject\Util\PicoStringUtil;

/**
 * The `GraphQLGeneratorJava` class is a powerful tool designed to automatically generate a complete Spring Boot GraphQL API from a JSON file that defines database entities.
 * It inspects the schema to understand tables, columns, primary keys, and foreign key relationships.
 * Based on this analysis, it produces Java code for entities, repositories, DTOs, and GraphQL controllers, along with GraphQL schema files, and a comprehensive API manual in Markdown format.
 * This class streamlines the process of scaffolding a GraphQL API, reducing manual effort and ensuring consistency between the database schema and the API.
 * 
 * @package AppBuilder
 */
class GraphQLGeneratorJava extends GraphQLGeneratorBase
{
    
    /**
     * @var array<string, string> Project configuration for pom.xml and package structure.
     */
    private $projectConfig = array();
    
    /**
     * @var bool Whether to enable verbose logging in the generated application.
     */
    private $verboseLogging = false;
    
    /**
     * @var bool Whether the generated application should require login.
     */
    private $requireLogin = true;

    /**
     * Constructor.
     *
     * @param array $schema Decoded JSON schema.
     * @param array|null $reservedColumns Reserved column definitions.
     * @param array $backendHandledColumns Columns handled by the backend.
     * @param bool $useCache Whether to use in-memory caching for queries.
     * @param array $projectConfig Project configuration details.
     * @param bool $verboseLogging Whether to enable verbose logging.
     */
    public function __construct($schema, $reservedColumns = null, $backendHandledColumns = array(), $useCache = false, $projectConfig = array(), $verboseLogging = false, $requireLogin = true)
    {
        parent::__construct($schema, $reservedColumns, $backendHandledColumns, $useCache);

        $this->projectConfig = array_merge(array(
            'groupId' => 'io.magicapp.generated',
            'artifactId' => 'graphql-app',
            'version' => '0.0.1-SNAPSHOT',
            'name' => 'GraphQL App',
            'description' => 'GraphQL API generated by MagicAppBuilder',
            'javaVersion' => '21',
            'packageName' => 'io.magicapp.generated.graphqlapp',
            'verboseLogging' => $verboseLogging,
            'requireLogin' => $requireLogin
        ), $projectConfig);
        
        $this->verboseLogging = $verboseLogging;
        $this->requireLogin = $requireLogin;
    }

    /**
     * Maps a database type to a Java type.
     *
     * @param string $dbType The database column type (e.g., VARCHAR, INT, TIMESTAMP).
     * @param int|null $length The length of the column.
     * @return string The corresponding Java type string.
     */
    private function mapDbTypeToJavaType($dbType, $length = null)
    {
        $dbType = strtolower($dbType);
        if (strpos($dbType, 'varchar') !== false || strpos($dbType, 'text') !== false) {
            return 'String';
        }
        if (strpos($dbType, 'timestamp') !== false) {
            return 'java.time.LocalDateTime';
        }
        if (strpos($dbType, 'date') !== false) {
            return 'java.time.LocalDate';
        }
        if (strpos($dbType, 'decimal') !== false || strpos($dbType, 'float') !== false || strpos($dbType, 'double') !== false) {
            return 'Double';
        }
        if ((strpos($dbType, 'tinyint') !== false && isset($length) && $length == '1') || strpos($dbType, 'bool') !== false || strpos($dbType, 'bit') !== false) {
            return 'Boolean';
        }
        if (strpos($dbType, 'int') !== false) {
            return 'Integer';
        }
        return 'String'; // Default fallback
    }
    
    private function getFirstKey($array)
    {
        foreach ($array as $key => $value) {
            return $key;
        }
        return null;
    }

    /**
     * Generates a markdown manual with examples for all queries and mutations.
     *
     * @return string The markdown content.
     */
    public function generateManual()
    {
        $manualContent = "# GraphQL API Manual\r\n\r\n";
        $manualContent .= "This document provides examples for all available queries and mutations for your Spring Boot application.\r\n\r\n";
        
        $manualContent .= "## Dependencies\r\n\r\n";
        $manualContent .= "All required dependencies are defined in the `pom.xml` file. Maven will handle downloading them automatically.\r\n\r\n";

        $manualContent .= "## Database Connection\r\n\r\n";
        $manualContent .= "This API requires a database connection. You must configure the `src/main/resources/application.properties` file. Here is an example for connecting to a MySQL database:\r\n\r\n";
        $manualContent .= "```properties\r\n";
        $manualContent .= "spring.application.name=YourAppName\r\n\r\n";
        $manualContent .= "# Database Configuration (Please update with your details)\r\n";
        $manualContent .= "app.security.require-login=true\r\n\r\n";
        $manualContent .= "# Default language for i18n\r\n";
        $manualContent .= "app.i18n.default-language=en\r\n\r\n";
        $manualContent .= "# Session Management (optional, uncomment to use Redis)\r\n";
        $manualContent .= "# spring.session.store-type=redis\r\n";
        $manualContent .= "# spring.data.redis.host=localhost\r\n";
        $manualContent .= "# spring.data.redis.port=6379\r\n";
        $manualContent .= "# spring.session.timeout=30m\r\n\r\n";
        $manualContent .= "# Session and Cookie Lifetime\r\n";
        $manualContent .= "# Set session timeout. e.g., 30m for 30 minutes, 1h for 1 hour.\r\n";
        $manualContent .= "server.servlet.session.timeout=30m\r\n";
        $manualContent .= "server.servlet.session.cookie.max-age=30m\r\n\r\n";
        $manualContent .= "# CORS Configuration (Cross-Origin Resource Sharing)\r\n";
        $manualContent .= "app.security.cors.enabled=true\r\n";
        $manualContent .= "app.security.cors.allowed-origins=http://localhost,http://127.0.0.1,http://localhost:3000,http://localhost:8080\r\n\r\n";
        $manualContent .= "spring.datasource.url=jdbc:mysql://localhost:3306/your_database_name\r\n";
        $manualContent .= "spring.datasource.username=your_username\r\n";
        $manualContent .= "spring.datasource.password=your_password\r\n";
        $manualContent .= "spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver\r\n\r\n";
        $manualContent .= "# JPA/Hibernate Configuration\r\n";
        $manualContent .= "spring.jpa.hibernate.ddl-auto=update\r\n";
        $manualContent .= "spring.jpa.show-sql=false\r\n";
        $manualContent .= "spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect\r\n";
        $manualContent .= "spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl\r\n\r\n";
        $manualContent .= "# GraphQL Properties\r\n";
        $manualContent .= "spring.graphql.graphiql.enabled=true\r\n";
        $manualContent .= "spring.graphql.schema.locations=classpath:graphql/\r\n";
        $manualContent .= "spring.graphql.schema.file-extensions=.graphqls\r\n";
        $manualContent .= "```\r\n\r\n";
        $manualContent .= "Make sure to replace `your_database_name`, `your_username`, and `your_password` with your actual database credentials.\r\n\r\n";


        $manualContent .= "### Integration with MagicAppBuilder\r\n\r\n";
        $manualContent .= "If you are integrating with MagicAppBuilder, you can use the database connection from an existing connection:\r\n\r\n";
        $manualContent .= "The generator will automatically populate the `application.properties` file with the connection details from your MagicAppBuilder project.\r\n\r\n";

        $manualContent .= "---\r\n\r\n";

        $manualContent .= "## In-Memory Cache\r\n\r\n";
        $manualContent .= "The auto-generated API can be configured to use Spring's caching abstraction. To enable it, you would add `@EnableCaching` to your main application class and configure a cache manager (e.g., Caffeine, EhCache, Redis) in your `application.properties`.\r\n\r\n";
        $manualContent .= "### Benefits\r\n\r\n";
        $manualContent .= "- **Reduced Database Load**: Fewer queries are executed on the database.\r\n";
        $manualContent .= "- **Faster Response Times**: Retrieving data from memory is significantly faster than from the database.\r\n\r\n";
        $manualContent .= "### How to Use\r\n\r\n";
        $manualContent .= "You can enable or disable this cache in the generator settings. When enabled, `@Cacheable` annotations will be added to the appropriate repository methods.\r\n\r\n";
        
        // Use the first table name as an example, or a placeholder if no tables exist.
        $exampleTableName = !empty($this->analyzedSchema) ? $this->getFirstKey($this->analyzedSchema) : 'yourEntity';

        $manualContent .= "```java\r\n";
        $manualContent .= "@Cacheable(value = \"".$this->camelCase($exampleTableName)."\", key = \"#id\")\r\n";
        $manualContent .= "Optional<".ucfirst($this->camelCase($exampleTableName))."> findById(String id);\r\n";
        $manualContent .= "```\r\n\r\n";

        $manualContent .= "---\r\n\r\n";
        
        $manualContent .= "## Security Considerations\r\n\r\n";
        $manualContent .= "For production or any publicly exposed environments, it is strongly recommended to remove files that are not essential for the API's runtime operations. This helps to minimize the attack surface and prevent potential information disclosure.\r\n\r\n";
        $manualContent .= "Please consider deleting the following files from your production server:\r\n\r\n";
        $manualContent .= "- **`manual.md`**: This file contains API documentation and is not needed for runtime.\r\n";
        $manualContent .= "\r\n";
        $manualContent .= "---\r\n\r\n";

        /*

        foreach ($this->analyzedSchema as $tableName => $tableInfo) {
            $camelName = $this->camelCase($tableName);
            $pluralCamelName = $this->pluralize($camelName);
            $ucCamelName = ucfirst($camelName);

            $manualContent .= "## " . $ucCamelName . "\r\n\r\n";

            // --- Get Fields for examples ---
            $fieldsString = $this->getFieldsForManual($tableInfo, false);
            $mutationFieldsString = $this->getFieldsForManual($tableInfo, true); // No relations for mutation return

            // --- Query Examples ---
            $manualContent .= "### Queries\r\n\r\n";

            // Get Single Item
            $manualContent .= "#### Get a single " . $camelName . "\r\n\r\n";
            $manualContent .= "```graphql\r\n";
            $manualContent .= "query Get" . $ucCamelName . " {\r\n";
            $manualContent .= "  " . $camelName . "(id: \"your-" . $camelName . "-id\") {\r\n";
            $manualContent .= $fieldsString;
            $manualContent .= "  }\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";

            // Get List
            $manualContent .= "#### Get a list of " . $pluralCamelName . " (with filter & sort)\r\n\r\n";
            $manualContent .= "Supports `limit`, `offset`, `orderBy`, and `filter`.\r\n\r\n";

            // Find a good column for the filter example
            $filterField = $tableInfo['primaryKey'];
            $filterValue = '"your-' . $camelName . '-id"';
            $filterOperator = 'EQUALS';

            // Prefer 'name' or 'title' for a CONTAINS filter
            foreach ($tableInfo['columns'] as $columnName => $columnInfo) {
                if (($columnName === 'name' || $columnName === 'title') && !$columnInfo['isForeignKey']) {
                    $filterField = $columnName;
                    $filterValue = '"some-text"';
                    $filterOperator = 'CONTAINS';
                    break;
                }
            }

            $manualContent .= "```graphql\r\n";
            $manualContent .= "query Get" . ucfirst($pluralCamelName) . " {\r\n";
            $manualContent .= "  " . $pluralCamelName . "(\r\n    limit: 10, \r\n    offset: 0, \r\n    orderBy: [{field: \"" . $tableInfo['primaryKey'] . "\", direction: DESC}],\r\n    filter: [{field: \"" . $filterField . "\", value: " . $filterValue . ", operator: " . $filterOperator . "}]\r\n  ) {\r\n";
            $manualContent .= "    items {\r\n";
            $manualContent .= preg_replace('/^/m', '  ', $fieldsString); // Indent fields
            $manualContent .= "    }\r\n";
            $manualContent .= "    total\r\n";
            $manualContent .= "    limit\r\n";
            $manualContent .= "    page\r\n";
            $manualContent .= "    totalPages\r\n";
            $manualContent .= "    hasNext\r\n";
            $manualContent .= "    hasPrevious\r\n";
            $manualContent .= "  }\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";

            // --- Mutation Examples ---
            $manualContent .= "### Mutations\r\n\r\n";

            // Get Input Fields for mutations
            list($inputFieldsString, $inputExampleString) = $this->getInputFieldsForManual($tableInfo);

            // Create
            $manualContent .= "#### Create a new " . $camelName . "\r\n\r\n";
            $manualContent .= "```graphql\r\n";
            $manualContent .= "mutation Create" . $ucCamelName . " {\r\n";
            $manualContent .= "  create" . $ucCamelName . "(input: {\r\n" . $inputExampleString . "  }) {\r\n";
            $manualContent .= $mutationFieldsString;
            $manualContent .= "  }\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";

            // Update
            $manualContent .= "#### Update an existing " . $camelName . "\r\n\r\n";
            $manualContent .= "```graphql\r\n";
            $manualContent .= "mutation Update" . $ucCamelName . " {\r\n";
            $manualContent .= "  update" . $ucCamelName . "(id: \"your-" . $camelName . "-id\", input: {\r\n" . $inputExampleString . "  }) {\r\n";
            $manualContent .= $mutationFieldsString;
            $manualContent .= "  }\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";

            // Delete
            $manualContent .= "#### Delete a " . $camelName . "\r\n\r\n";
            $manualContent .= "Returns `true` on success.\r\n\r\n";
            $manualContent .= "```graphql\r\n";
            $manualContent .= "mutation Delete" . $ucCamelName . " {\r\n";
            $manualContent .= "  delete" . $ucCamelName . "(id: \"your-" . $camelName . "-id\")\r\n";
            $manualContent .= "}\r\n";
            $manualContent .= "```\r\n\r\n";
        }

        // --- API Reference Guide ---
        $manualContent .= "## API Reference Guide\r\n\r\n";
        $manualContent .= "This section provides a reference for common arguments used in list queries.\r\n\r\n";

        // Filtering
        $manualContent .= "### Filtering (`filter`)\r\n\r\n";
        $manualContent .= "The `filter` argument allows you to narrow down results based on field values. It accepts a list of filter objects, which are combined with `AND` logic.\r\n\r\n";
        $manualContent .= "| Operator       | Description                                      | Example                                                |\r\n";
        $manualContent .= "|----------------|--------------------------------------------------|--------------------------------------------------------|\r\n";
        $manualContent .= "| `EQUALS`       | Finds records where the field exactly matches the value. | `{field: \"status\", value: \"published\"}`                |\r\n";
        $manualContent .= "| `NOT_EQUALS`   | Finds records where the field does not match the value. | `{field: \"status\", value: \"archived\", operator: NOT_EQUALS}` |\r\n";
        $manualContent .= "| `CONTAINS`     | Finds records where the text field contains the value (`LIKE '%value%'`). | `{field: \"title\", value: \"love\", operator: CONTAINS}` |\r\n";
        $manualContent .= "| `GREATER_THAN_OR_EQUALS` | Finds records where the numeric/date field is greater than or equal to the value. | `{field: \"price\", value: \"99.99\", operator: GREATER_THAN_OR_EQUALS}` |\r\n";
        $manualContent .= "| `GREATER_THAN` | Finds records where the numeric/date field is greater than the value. | `{field: \"price\", value: \"100\", operator: GREATER_THAN}` |\r\n";
        $manualContent .= "| `LESS_THAN_OR_EQUALS`    | Finds records where the numeric/date field is less than or equal to the value. | `{field: \"stock\", value: \"10\", operator: LESS_THAN_OR_EQUALS}`   |\r\n";
        $manualContent .= "| `LESS_THAN`    | Finds records where the numeric/date field is less than the value. | `{field: \"stock\", value: \"10\", operator: LESS_THAN}`   |\r\n";
        $manualContent .= "| `IN` / `NOT_IN` | Finds records where the field value is in (or not in) a comma-separated list of values. | `{field: \"category_id\", value: \"1,2,3\", operator: IN}` |\r\n\r\n";

        // Sorting
        $manualContent .= "### Sorting (`orderBy`)\r\n\r\n";
        $manualContent .= "The `orderBy` argument sorts the results. It accepts a list of sort objects.\r\n\r\n";
        $manualContent .= "- `field`: The name of the field to sort by (e.g., `\"name\"`).\r\n";
        $manualContent .= "- `direction`: The sort direction. Can be `ASC` (ascending) or `DESC` (descending). Defaults to `ASC`.\r\n\r\n";
        $manualContent .= "**Example:** `orderBy: [{field: \"release_date\", direction: DESC}]`\r\n\r\n";

        // Pagination
        $manualContent .= "### Pagination (`limit` & `offset`)\r\n\r\n";
        $manualContent .= "- `limit`: Specifies the maximum number of records to return.\r\n";
        $manualContent .= "- `offset`: Specifies the number of records to skip from the beginning.\r\n\r\n";
        $manualContent .= "**Example:** To get the second page of 10 items: `limit: 10, offset: 10`\r\n\r\n";
        */

        $manualContent .= $this->generateExample();

        return $manualContent;
    }
    
    /**
     * Generates the content for the composer.json file.
     * This includes the necessary dependencies for running the GraphQL API.
     *
     * @return string The XML formatted content for pom.xml.
     */
    public function generatePomXml()
    {
        $config = $this->projectConfig;
        return <<<XML
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.2.5</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>{$config['groupId']}</groupId>
	<artifactId>{$config['artifactId']}</artifactId>
	<version>{$config['version']}</version>
	<name>{$config['name']}</name>
	<description>{$config['description']}</description>
	<properties>
		<java.version>{$config['javaVersion']}</java.version>
        <!-- Explicitly set the main class to avoid ambiguity -->
        <start-class>{$config['packageName']}.{$this->pascalCase($config['artifactId'])}Application</start-class>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-graphql</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.session</groupId>
            <artifactId>spring-session-data-redis</artifactId>
        </dependency>

        <!-- Database Drivers -->
		<dependency>
			<groupId>com.mysql</groupId>
			<artifactId>mysql-connector-j</artifactId>
			<scope>runtime</scope>
		</dependency>
        <dependency>
            <groupId>org.mariadb.jdbc</groupId>
            <artifactId>mariadb-java-client</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>com.microsoft.sqlserver</groupId>
            <artifactId>mssql-jdbc</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.xerial</groupId>
            <artifactId>sqlite-jdbc</artifactId>
            <scope>runtime</scope>
        </dependency>
        <!-- End of Database Drivers -->

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework</groupId>
			<artifactId>spring-webflux</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.graphql</groupId>
			<artifactId>spring-graphql-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-test</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>

</project>
XML;
    }

    /**
     * Main function to generate all files for the Spring Boot project.
     *
     * @return array An array of file definitions, each with 'name' and 'content'.
     */
    public function generate()
    {
        $files = array();
        $this->projectConfig['basePackagePath'] = 'src/main/java/' . str_replace('.', '/', $this->projectConfig['packageName']);
        $packagePath = 'src/main/java/' . str_replace('.', '/', $this->projectConfig['packageName']);

        // 1. pom.xml
        $files[] = ['name' => 'pom.xml', 'content' => $this->generatePomXml()];

        // 3. Main Application Class
        $files[] = ['name' => $packagePath . '/' . $this->pascalCase($this->projectConfig['artifactId']) . 'Application.java', 'content' => $this->generateMainAppClass()];

        // 4. GraphQL Schema, Entities, Repositories, DTOs, Controllers
        $allSchemaParts = array();
        $allQueryFields = array();
        $allMutationFields = array();

        foreach ($this->analyzedSchema as $tableName => $tableInfo) {
            // Generate individual Java files
            $files[] = ['name' => $packagePath . '/model/entity/' . ucfirst($this->camelCase($tableName)) . '.java', 'content' => $this->generateEntityClass($tableName, $tableInfo)];
            $files[] = ['name' => $packagePath . '/model/repository/' . ucfirst($this->camelCase($tableName)) . 'Repository.java', 'content' => $this->generateRepositoryInterface($tableName, $tableInfo)];
            $files[] = ['name' => $packagePath . '/model/dto/' . ucfirst($this->camelCase($tableName)) . 'Input.java', 'content' => $this->generateDtoClass($tableName, $tableInfo)];
            $files[] = ['name' => $packagePath . '/controller/' . ucfirst($this->camelCase($tableName)) . 'Controller.java', 'content' => $this->generateControllerClass($tableName, $tableInfo)];

            // Collect schema parts to be merged later
            $schemaParts = $this->getSchemaPartsForTable($tableName, $tableInfo);
            $allSchemaParts[] = $schemaParts['types'];
            $allQueryFields[] = $schemaParts['queries'];
            $allMutationFields[] = $schemaParts['mutations'];
        }
        
        // 5. Specification and Filter classes
        $files[] = ['name' => $packagePath . '/util/SpecificationBuilder.java', 'content' => $this->generateSpecificationBuilder()];
        $files[] = ['name' => $packagePath . '/util/FilterCriteria.java', 'content' => $this->generateFilterCriteria()];
        $files[] = ['name' => $packagePath . '/util/SearchOperation.java', 'content' => $this->generateSearchOperation()];
        $files[] = ['name' => $packagePath . '/util/AuditTrailUtil.java', 'content' => $this->generateAuditTrailUtil()];
        $files[] = ['name' => $packagePath . '/util/GenericSpecification.java', 'content' => $this->generateGenericSpecification()];
        $files[] = ['name' => $packagePath . '/util/ScalarValueUtil.java', 'content' => $this->generateScalarValueUtil()];
        $files[] = ['name' => $packagePath . '/util/ValueUtil.java', 'content' => $this->generateValueUtil()];
        $files[] = ['name' => $packagePath . '/util/QueryUtil.java', 'content' => $this->generateQueryUtil()];
        $files[] = ['name' => $packagePath . '/util/I18nUtil.java', 'content' => $this->generateI18nUtil()];

        $files[] = ['name' => $packagePath . '/exceptions/GlobalExceptionHandler.java', 'content' => $this->geterateGlobalExceptionHandler()];

        // 5.1. DTOs for GraphQL inputs
        $files[] = ['name' => $packagePath . '/model/dto/FilterInput.java', 'content' => $this->generateFilterInputDto()];
        $files[] = ['name' => $packagePath . '/model/dto/SortInput.java', 'content' => $this->generateSortInputDto()];
        
        $files[] = ['name' => 'src/main/resources/frontend-config.json', 'content' => $this->generateFrontendConfigJson()];

        // 5.1. Generate the single, combined GraphQL schema file
        $files[] = ['name' => 'src/main/resources/graphql/schema.graphqls', 'content' => $this->generateCombinedSchema($allSchemaParts, $allQueryFields, $allMutationFields)];

        // 6. Security and Auth files
        $files[] = ['name' => $packagePath . '/config/SecurityConfig.java', 'content' => $this->generateSecurityConfig()];
        $files[] = ['name' => $packagePath . '/config/CorsConfig.java', 'content' => $this->generateCorsConfig()];
        $files[] = ['name' => $packagePath . '/config/SessionAuthFilter.java', 'content' => $this->generateSessionAuthFilter()];
        $files[] = ['name' => $packagePath . '/config/Sha1PasswordEncoder.java', 'content' => $this->generateSha1PasswordEncoder()];
        $files[] = ['name' => $packagePath . '/config/ObjectScalar.java', 'content' => $this->generateObjectScalar()];
        $files[] = ['name' => $packagePath . '/config/GraphQlConfig.java', 'content' => $this->generateGraphQlConfig()];

        $files[] = ['name' => $packagePath . '/model/entity/core/Admin.java', 'content' => $this->generateAdminEntity()];
        $files[] = ['name' => $packagePath . '/model/repository/core/AdminRepository.java', 'content' => $this->generateAdminRepository()];

        $files[] = ['name' => $packagePath . '/service/JpaUserDetailsService.java', 'content' => $this->generateUserDetailsService()];
        

        // 7. Auth and App Controllers
        $files[] = ['name' => $packagePath . '/controller/dto/LoginRequest.java', 'content' => $this->generateLoginRequestDto()];
        $files[] = ['name' => $packagePath . '/controller/dto/LoginResponse.java', 'content' => $this->generateLoginResponseDto()];

        $files[] = ['name' => $packagePath . '/controller/core/AuthController.java', 'content' => $this->generateAuthController()];
        $files[] = ['name' => $packagePath . '/controller/core/AppController.java', 'content' => $this->generateAppController()];
        $files[] = ['name' => $packagePath . '/controller/core/StaticAssetController.java', 'content' => $this->generateStaticAssetController()];

        $files[] = ['name' => $packagePath . '/controller/core/UpdatePasswordController.java', 'content' => $this->generateUpdatePasswordController()];
        $files[] = ['name' => $packagePath . '/controller/core/UserProfileController.java', 'content' => $this->generateUserProfileController()];
        $files[] = ['name' => $packagePath . '/controller/core/AdminController.java', 'content' => $this->generateAdminController()];

        $files[] = ['name' => $packagePath . '/controller/dto/ProfileUpdateRequest.java', 'content' => $this->generateProfileUpdateRequestDto()];
        

        return $files;
    }

    /**
     * Generates the application.properties file.
     * @return string The content of application.properties.
     */
    public function generateApplicationProperties() {
        $requireLoginValue = $this->requireLogin ? 'true' : 'false';
        return <<<PROPERTIES
spring.application.name={$this->projectConfig['name']}

# Database Configuration (Please update with your details)
app.security.require-login=$requireLoginValue

# Default language for i18n
app.i18n.default-language=en

# Session Management
spring.session.store-type=none # Default to none, uncomment below to use Redis
# spring.session.store-type=redis
# spring.data.redis.host=localhost
# spring.data.redis.port=6379
# spring.session.timeout=30m

# Session and Cookie Lifetime
# Set session timeout. e.g., 30m for 30 minutes, 1h for 1 hour.
server.servlet.session.timeout=30m
server.servlet.session.cookie.max-age=30m

# CORS Configuration (Cross-Origin Resource Sharing)
app.security.cors.enabled=true
app.security.cors.allowed-origins=http://localhost,http://127.0.0.1,http://localhost:3000,http://localhost:4000,http://127.0.0.1:4000,http://127.0.0.1:3000,http://localhost:8080

spring.datasource.url={DB_URL}
spring.datasource.username={DB_USER}
spring.datasource.password={DB_PASS}
spring.datasource.driver-class-name={DB_DRIVER_CLASS}

# JPA/Hibernate Configuration
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.dialect={DB_DIALECT}

# Use database column names directly without converting to camelCase
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl

# GraphQL Configuration
spring.graphql.graphiql.enabled=true
spring.graphql.schema.locations=classpath:graphql/
spring.graphql.schema.file-extensions=.graphqls

# Caching (optional)
# spring.cache.type=caffeine
PROPERTIES;
    }

    /**
     * Generates the main Spring Boot application class.
     *
     * @return string The content of the main application class.
     */
    private function generateMainAppClass() {
        $className = $this->pascalCase($this->projectConfig['artifactId']) . 'Application';
        $content = "package {$this->projectConfig['packageName']};\n\n";
        $content .= "import org.springframework.boot.autoconfigure.EnableAutoConfiguration;\n";
        $content .= "import org.springframework.boot.SpringApplication;\n";
        $content .= "import org.springframework.boot.autoconfigure.SpringBootApplication;\n";
        $content .= "import org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration;\n";
        $content .= "import org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration;\n";
        if ($this->useCache) {
            $content .= "import org.springframework.cache.annotation.EnableCaching;\n";
        }
        $content .= "\n";
        if ($this->useCache) {
            $content .= "@EnableCaching\n";
        }
        $content .= "@SpringBootApplication\n";
        $content .= "@EnableAutoConfiguration(exclude = {RedisAutoConfiguration.class, RedisRepositoriesAutoConfiguration.class})\n";
        $content .= "public class $className {\n\n";
        $content .= "    public static void main(String[] args) {\n";
        $content .= "        SpringApplication.run($className.class, args);\n";
        $content .= "    }\n\n";
        $content .= "}\n";
        return $content;
    }

    /**
     * Generates the Java entity class for a given table.
     *
     * @param string $tableName The name of the database table.
     * @param array $tableInfo The information about the table's columns.
     * @return string The content of the entity class.
     */
    private function generateEntityClass($tableName, $tableInfo) {
        $camelName = $this->camelCase($tableName);
        $className = ucfirst($camelName);
        $package = $this->projectConfig['packageName'];
        
        $imports = "import jakarta.persistence.*;\nimport lombok.Data;\nimport java.io.Serializable;\n";
        $fields = "";
        $hasLdt = false;
        $hasLd = false;
        $hasManyToOne = false;
        
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            $javaType = $this->mapDbTypeToJavaType($colInfo['type'], $colInfo['length']);
            $fieldName = $this->camelCase($colName);
            
            if (strpos($javaType, 'LocalDateTime') !== false)
            {
                $fields .= "    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = \"yyyy-MM-dd HH:mm:ss\")\n";
                $hasLdt = true;
            }
            else if (strpos($javaType, 'LocalDate') !== false) 
            {
                $fields .= "    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = \"yyyy-MM-dd\")\n";
                $hasLd = true;
            }
            
            if ($colInfo['isPrimaryKey']) {
                $fields .= "    @Id\n";
                if ($colInfo['isAutoIncrement']) {
                    if($colInfo['primaryKeyValue'] == 'autogenerated')
                    {
                        $fields .= "    @GeneratedValue(strategy = GenerationType.IDENTITY)\n";
                    }
                }
                if ($fieldName !== $colName) {
                    if($colInfo['primaryKeyValue'] == 'autogenerated')
                    {
                        $fields .= "    @GeneratedValue(strategy = GenerationType.UUID)\n";
                    }
                    $fields .= "    @Column(name = \"$colName\")\n";
                }
            } else if ($colInfo['isForeignKey']) {
                $hasManyToOne = true;
                $refTableName = $colInfo['references'];
                $refClassName = ucfirst($this->camelCase($refTableName));
                $refFieldName = $this->camelCase($refTableName);

                // Add the foreign key column field
                $fields .= "    @Column(name = \"$colName\")\n";
                $fields .= "    private " . basename(str_replace('\\', '/', $javaType)) . " $fieldName;\n\n";
                
                // Add the object relationship
                $fields .= "    @JsonIgnore\n";
                $fields .= "    @ManyToOne(fetch = FetchType.LAZY)\n";
                $fields .= "    @NotFound(action = NotFoundAction.IGNORE)\n";
                $fields .= "    @JoinColumn(name = \"$colName\", insertable = false, updatable = false)\n";
                $fields .= "    private $refClassName $refFieldName;\n\n";
                continue; // Skip the separate ID field generation for foreign keys
            } else if ($fieldName !== $colName) {
                $fields .= "    @Column(name = \"$colName\")\n";
            }
            // No need for @Column(name=...) if physical strategy is used and field name matches
            $fields .= "    private " . basename(str_replace(['\\', '.'], '/', $javaType)) . " $fieldName;\n\n";
        }

        if ($hasLdt) $imports .= "import java.time.LocalDateTime;\n";
        if ($hasLd) $imports .= "import java.time.LocalDate;\n";

        if ($hasManyToOne) {
            $imports .= "\n";
            $imports .= "import org.hibernate.annotations.NotFound;\n";
            $imports .= "import org.hibernate.annotations.NotFoundAction;\n";
            $imports .= "\n";
        }

        if ($hasLdt || $hasLd) $imports .= "import com.fasterxml.jackson.annotation.JsonFormat;\n";
        if ($hasManyToOne) $imports .= "import com.fasterxml.jackson.annotation.JsonIgnore;\n";
        $imports .= "import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n";

        return <<<JAVA
package $package.model.entity;

$imports
@Data
@JsonIgnoreProperties(ignoreUnknown = true)
@Entity
@Table(name = "$tableName")
public class $className implements Serializable {

$fields}
JAVA;
    }

    /**
     * Generates the Java interface for a given table's repository.
     *
     * @param string $tableName The name of the database table.
     * @param array $tableInfo The information about the table's columns.
     * @return string The content of the repository interface.
     */
    private function generateRepositoryInterface($tableName, $tableInfo) {
        $camelName = $this->camelCase($tableName);
        $className = ucfirst($camelName);
        $package = $this->projectConfig['packageName'];
        $pkJavaType = 'String';
        foreach ($tableInfo['columns'] as $col) {
            if ($col['isPrimaryKey']) {
                $pkJavaType = $this->mapDbTypeToJavaType($col['type'], $col['length']);
                break;
            }
        }

        $imports = "import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;\n\n";
        $imports .= "import $package.model.entity.$className;\n";


        $imports .= "import java.util.Optional;\n";
        $entityGraphAnnotation = $this->buildEntityGraphAnnotation($tableName);
        $findByIdMethod = "    @Override\n";
        $findByIdMethod .= "    Optional<$className> findById($pkJavaType id);";
        if(!empty($entityGraphAnnotation)) {
            $findByIdMethod = $entityGraphAnnotation . $findByIdMethod;
        }


        /*
        @Modifying
        @Query("UPDATE Blok b SET b.blokId = :newId WHERE b.blokId = :oldId")
        void updateId(@Param("oldId") String oldId, @Param("newId") String newId);
        */
        $modifying = "";
        foreach ($tableInfo['columns'] as $colname => $col) {
            if ($col['isPrimaryKey']) {
                $camelCasePk = $this->camelCase($colname);
                $upperCamelCasePk = ucfirst($camelCasePk);
                $pkJavaType = $this->mapDbTypeToJavaType($col['type'], $col['length']);
                $modifying = "\n    @Modifying\n";
                $modifying .= "    @Transactional\n";
                $modifying .= "    @Query(\"UPDATE $className a SET a.$camelCasePk = :newId WHERE a.$camelCasePk = :oldId\")\n";
                $modifying .= "    int update{$upperCamelCasePk}(@Param(\"oldId\") $pkJavaType oldId, @Param(\"newId\") $pkJavaType newId);\n";
            }
        }


        return <<<JAVA
package $package.model.repository;

$imports

@Repository
public interface {$className}Repository extends JpaRepository<$className, $pkJavaType>, JpaSpecificationExecutor<$className> {
$findByIdMethod
$modifying
}
JAVA;
    }

    /**
     * Builds the @EntityGraph annotation string by recursively finding all nested relationships.
     *
     * @param string $tableName The starting table name.
     * @return string The generated @EntityGraph annotation string.
     */
    private function buildEntityGraphAnnotation($tableName)
    {
        $allPaths = $this->getNestedAttributePaths($tableName);
        if (empty($allPaths)) {
            return "";
        }

        $quotedPaths = array_map(function($path) {
            return '"' . $path . '"';
        }, $allPaths);

        return "    @EntityGraph(attributePaths = {" . implode(', ', $quotedPaths) . "})\n";
    }

    /**
     * Recursively traverses entity relationships to build a list of nested attribute paths for @EntityGraph.
     *
     * @param string $tableName The current table to analyze.
     * @param string $currentPath The path prefix built so far (e.g., "subKlasifikasi.").
     * @param array $visited An array to prevent infinite loops in circular dependencies.
     * @return array A flat list of all nested attribute paths.
     */
    private function getNestedAttributePaths($tableName, $currentPath = '', &$visited = array())
    {
        if (isset($visited[$tableName])) {
            return []; // Avoid infinite recursion on circular dependencies
        }
        $visited[$tableName] = true;

        $paths = array();
        $tableInfo = $this->analyzedSchema[$tableName];

        foreach ($tableInfo['columns'] as $colInfo) {
            if ($colInfo['isForeignKey']) {
                $refTableName = $colInfo['references'];
                $attributeName = $this->camelCase($refTableName);
                $fullPath = $currentPath . $attributeName;
                $paths[] = $fullPath;

                // Recursively find paths from the referenced table
                $nestedPaths = $this->getNestedAttributePaths($refTableName, $fullPath . '.', $visited);
                $paths = array_merge($paths, $nestedPaths);
            }
        }

        // Backtrack for the current path
        unset($visited[$tableName]);

        return $paths;
    }

    /**
     * Generates the DTO class for a given table.
     * @param string $tableName The name of the database table.
     * @param array $tableInfo The information about the table's columns.
     * @return string The content of the DTO class.
     */
    private function generateDtoClass($tableName, $tableInfo) {
        $camelName = $this->camelCase($tableName);
        $className = ucfirst($camelName) . "Input";
        $package = $this->projectConfig['packageName'];

        $backendHandledColumnNames = $this->getBackendHandledColumnNames();

        $imports = "import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n\nimport lombok.Data;\n";
        $fields = "";
        $hasLdt = false;
        $hasLd = false;

        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            if ($colName === $tableInfo['primaryKey'] && ($colInfo['isAutoIncrement'] || $colInfo['primaryKeyValue'] == 'autogenerated')) {
                continue;
            }

            if(in_array($colName, $backendHandledColumnNames)) {
                continue;
            }
            
            if ($colInfo['isForeignKey']) {
                $javaType = $this->mapDbTypeToJavaType($colInfo['type'], $colInfo['length']);
            }
            else {
                $javaType = $this->mapDbTypeToJavaType($colInfo['type'], $colInfo['length']);
            }
            $fieldName = $this->camelCase($colName);

            if (strpos($javaType, 'LocalDateTime') !== false)
            {
                $fields .= "    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = \"yyyy-MM-dd HH:mm:ss\")\n";
                $hasLdt = true;
            }
            else if (strpos($javaType, 'LocalDate') !== false) 
            {
                $fields .= "    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = \"yyyy-MM-dd\")\n";
                $hasLd = true;
            }
            

            if ($fieldName !== $colName) {
                // TODO:
                // $fields .= "    @JsonProperty(\"$colName\")\n";
            }


            $fields .= "    private " . basename(str_replace(['\\', '.'], '/', $javaType)) . " $fieldName;\n\n";
        }

        if ($hasLdt || $hasLd) $imports .= "import com.fasterxml.jackson.annotation.JsonFormat;\n";
        if ($hasLdt) $imports .= "import java.time.LocalDateTime;\n";
        if ($hasLd) $imports .= "import java.time.LocalDate;\n";

        return <<<JAVA
package $package.model.dto;

$imports
@Data
@JsonIgnoreProperties(ignoreUnknown = true)
public class $className {
$fields}
JAVA;
    }

    /**
     * Generates the GlobalExceptionHandler class to handle exceptions across the application.
     * This class uses `@ControllerAdvice` and `@GraphQlExceptionHandler` to catch exceptions
     * and format them into standard GraphQL errors.
     *
     * @return string The Java code for the GlobalExceptionHandler class.
     */
    private function geterateGlobalExceptionHandler()
    {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.exceptions;

import graphql.GraphQLError;
import graphql.GraphqlErrorBuilder;
import org.springframework.graphql.data.method.annotation.GraphQlExceptionHandler;
import org.springframework.graphql.execution.ErrorType;
import org.springframework.web.bind.annotation.ControllerAdvice;

@ControllerAdvice
public class GlobalExceptionHandler {

    @GraphQlExceptionHandler
    public GraphQLError handleRuntimeException(RuntimeException ex) {
        ErrorType errorType = ErrorType.INTERNAL_ERROR;
        if (ex.getMessage() != null && ex.getMessage().toLowerCase().contains("not found")) {
            errorType = ErrorType.NOT_FOUND;
        } else if (ex.getMessage() != null && ex.getMessage().toLowerCase().contains("invalid")) {
            errorType = ErrorType.BAD_REQUEST;
        }

        return GraphqlErrorBuilder.newError().message(ex.getMessage()).errorType(errorType).build();
    }
}
JAVA;
    }

    /**
     * Generates the I18nUtil class for handling internationalization (i18n).
     * This utility class loads translation strings from JSON files located in
     * `src/main/resources/static/langs/i18n/`. It caches translations in memory
     * to improve performance and provides a `t()` method to retrieve translated
     * strings by key and language. It also supports a default language as a fallback.
     *
     * @return string The Java code for the I18nUtil class.
     */
    private function generateI18nUtil()
    {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ClassPathResource;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.io.InputStream;
import java.util.Collections;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Component
public class I18nUtil {

    private final ObjectMapper objectMapper;
    private final Map<String, Map<String, String>> translationsCache = new ConcurrentHashMap<>();

    @Value("\${app.i18n.default-language:en}")
    private String defaultLanguage;

    public I18nUtil(ObjectMapper objectMapper) {
        this.objectMapper = objectMapper;
    }

    private Map<String, String> loadTranslations(String lang) {
        return translationsCache.computeIfAbsent(lang, l -> {
            try {
                Resource resource = new ClassPathResource("static/langs/i18n/" + l + ".json");
                if (!resource.exists()) {
                    // If the requested language file doesn't exist, try loading the default
                    if (!l.equals(defaultLanguage)) {
                        return loadTranslations(defaultLanguage);
                    }
                    return Collections.emptyMap();
                }
                try (InputStream inputStream = resource.getInputStream()) {
                    return objectMapper.readValue(inputStream, new TypeReference<>() {});
                }
            } catch (IOException e) {
                // Log the error
                e.printStackTrace();
                return Collections.emptyMap();
            }
        });
    }

    public String t(String code, String lang) {
        return t(code, lang, null);
    }

    public String t(String code, String lang, Object[] args) {
        String language = (lang == null || lang.trim().isEmpty()) ? defaultLanguage : lang;
        Map<String, String> translations = loadTranslations(language);
        String message = translations.getOrDefault(code, snakaCaseToTitleCase(code));

        if (args != null && args.length > 0) {
            return String.format(message, args);
        }
        return message;
    }

    public String snakaCaseToTitleCase(String input) {
        StringBuilder result = new StringBuilder();
        boolean capitalizeNext = true;

        for (char c : input.toCharArray()) {
            if (c == '_') {
                capitalizeNext = true;
                result.append(" ");
            } else {
                if (capitalizeNext) {
                    result.append(Character.toUpperCase(c));
                    capitalizeNext = false;
                } else {
                    result.append(Character.toLowerCase(c)); 
                }
            }
        }

        return result.toString().trim();
    }

}
JAVA;
    }

    /**
     * Generates the QueryUtil Java class.
     * This utility class provides static methods to create Spring Data `Pageable` and `Specification` objects
     * from GraphQL arguments for pagination, sorting, and filtering. It centralizes the
     * logic for building database queries based on client requests.
     *
     * @return string The Java code for the QueryUtil class.
     */
    private function generateQueryUtil() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

import $package.model.dto.FilterInput;
import $package.model.dto.SortInput;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.data.domain.Page;

import java.util.List;
import java.util.Map;

/**
 * A utility class to help build Spring Data Pageable and Specification objects
 * from GraphQL query arguments. This centralizes the logic for pagination, sorting,
 * and filtering.
 */
public class QueryUtil {

    private QueryUtil() {
        // Private constructor to prevent instantiation
    }

    /**
     * Creates a Pageable object based on GraphQL pagination and sorting arguments.
     *
     * @param limit   The maximum number of items to return.
     * @param offset  The number of items to skip from the beginning.
     * @param page    The page number (1-based).
     * @param size    The size of a page.
     * @param orderBy A list of sorting criteria.
     * @return A {@link Pageable} object configured with the provided arguments.
     */
    public static Pageable createPageable(Integer limit, Integer offset, Integer page, Integer size, List<SortInput> orderBy) {
        int pageSize = (limit != null) ? limit : (size != null ? size : 20);
        int pageNum = 0;
        if (offset != null && pageSize > 0) {
            pageNum = offset / pageSize;
        } else if (page != null) {
            pageNum = page > 0 ? page - 1 : 0; // Convert 1-based page to 0-based
        }

        Sort sort = Sort.unsorted();
        if (orderBy != null && !orderBy.isEmpty()) {
            List<Sort.Order> orders = orderBy.stream()
                    .map(order -> new Sort.Order(Sort.Direction.fromString(order.getDirection()), ValueUtil.toCamelCase(order.getField())))
                    .toList();
            sort = Sort.by(orders);
        }

        return PageRequest.of(pageNum, pageSize, sort);
    }

    /**
     * Creates a Specification object from a list of filter criteria.
     *
     * @param filter A list of filtering criteria.
     * @param <T>    The entity type to which the specification will be applied.
     * @return A {@link Specification} object, or null if the filter is empty.
     */
    public static <T> Specification<T> createSpecification(List<FilterInput> filter) {
        SpecificationBuilder<T> builder = new SpecificationBuilder<>();
        if (filter != null) {
            for (FilterInput f : filter) {
                String operator = (f.getOperator() == null || f.getOperator().isEmpty()) ? "EQUALS" : f.getOperator().toUpperCase();
                builder.with(ValueUtil.toCamelCase(f.getField()), SearchOperation.valueOf(operator), f.getValue());
            }
        }
        return builder.build();
    }

    /**
     * Creates a Map representing the paginated result from a Page object.
     * This is commonly used to structure the response for GraphQL list queries.
     *
     * @param resultPage The {@link Page} object returned from a repository query.
     * @param <T>        The entity type contained in the page.
     * @return A {@link Map} containing pagination details and the list of items.
     */
    public static <T> Map<String, Object> createPageResultMap(Page<T> resultPage) {
        return Map.of(
            "items", resultPage.getContent(),
            "total", resultPage.getTotalElements(),
            "limit", resultPage.getSize(),
            "page", resultPage.getNumber() + 1, // Frontend pages are usually 1-based
            "totalPages", resultPage.getTotalPages(),
            "hasNext", resultPage.hasNext(),
            "hasPrevious", resultPage.hasPrevious()
        );
    }
}
JAVA;

    }

    /**
     * Generates the ValueUtil Java class for handling naming conversions and map-to-DTO conversions.
     *
     * @return string The content of the ValueUtil class.
     */
    private function generateValueUtil() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.DeserializationFeature; 
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;

/**
 * A utility class for handling naming conversions, specifically between snake_case
 * and camelCase, and for converting Maps to DTOs. This is particularly useful
 * for adapting data structures received from GraphQL arguments into strongly-typed
 * Java objects.
 */
public class ValueUtil {

    private static final ObjectMapper MAPPER = createObjectMapper();

    private ValueUtil() {
        // Private constructor to prevent public instantiation
    }

    private static ObjectMapper createObjectMapper() {
        ObjectMapper mapper = new ObjectMapper();
        
        // Ensures Jackson can convert from broader Java numeric types (like Long) to DTO Integer/Boolean fields.
        mapper.configure(DeserializationFeature.USE_BIG_INTEGER_FOR_INTS, false);
        mapper.configure(DeserializationFeature.ACCEPT_FLOAT_AS_INT, true);
        
        // If the input map has fields that don't exist in the DTO, they will be ignored.
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        
        return mapper;
    }

    /**
     * Converts the keys of a Map from snake_case to camelCase.
     * @param snakeCaseMap The input map with snake_case keys.
     * @return A new map with camelCase keys.
     */
    public static Map<String, Object> convertSnakeToCamelCase(Map<String, Object> snakeCaseMap) {
        if (snakeCaseMap == null) {
            return Collections.emptyMap();
        }
        Map<String, Object> camelCaseMap = new HashMap<>();
        for (Map.Entry<String, Object> entry : snakeCaseMap.entrySet()) {
            camelCaseMap.put(toCamelCase(entry.getKey()), entry.getValue());
        }
        return camelCaseMap;
    }

    /**
     * Converts a Map with camelCase keys to an instance of a target DTO class.
     * @param camelCaseMap The map with camelCase keys.
     * @param targetClass The class of the target DTO.
     * @param <T> The type of the DTO.
     * @return An instance of the target DTO populated with data from the map.
     */
    public static <T> T convertMapToDto(Map<String, Object> camelCaseMap, Class<T> targetClass) {
        if (camelCaseMap == null || camelCaseMap.isEmpty()) {
            try {
                return targetClass.getDeclaredConstructor().newInstance();
            } catch (Exception e) {
                throw new RuntimeException("Failed to instantiate empty target class: " + targetClass.getName(), e);
            }
        }
        return MAPPER.convertValue(camelCaseMap, targetClass);
    }
    
    /**
     * A convenience method that converts a Map with snake_case keys directly to a target DTO.
     * It first converts the keys to camelCase and then converts the map to the DTO.
     * @param snakeCaseMap The input map with snake_case keys.
     * @param targetClass The class of the target DTO.
     * @param <T> The type of the DTO.
     * @return An instance of the target DTO.
     */
    public static <T> T convertSnakeCaseToDto(Map<String, Object> snakeCaseMap, Class<T> targetClass) {
        Map<String, Object> camelCaseMap = convertSnakeToCamelCase(snakeCaseMap);
        return convertMapToDto(camelCaseMap, targetClass);
    }

    /**
     * Converts a single snake_case string to camelCase.
     * For example, "sort_order" becomes "sortOrder".
     * @param snakeCase The string in snake_case.
     * @return The converted string in camelCase.
     */
    public static String toCamelCase(String snakeCase) {
        if (snakeCase == null || snakeCase.isEmpty()) {
            return snakeCase;
        }
        StringBuilder builder = new StringBuilder();
        boolean nextUpper = false;
        for (char c : snakeCase.toCharArray()) {
            if (c == '_') {
                nextUpper = true;
            } else if (nextUpper) {
                builder.append(Character.toUpperCase(c));
                nextUpper = false;
            } else {
                builder.append(c);
            }
        }
        return builder.toString();
    }

    /**
     * Checks if an object has a valid value to be used as a primary key.
     * Valid value criteria:
     * 1. Not null.
     * 2. If it is a String, it must not be empty or contain only whitespace.
     *
     * @param value The object to be checked.
     * @return `true` if the value is valid, `false` otherwise.
     */
    public static boolean valuable(Object value) {
        if (value == null) {
            return false;
        }
        if (value instanceof String) {
            return !((String) value).trim().isEmpty();
        }
        return true;
    }
}
JAVA;
    }

    /**
     * Generates the `ScalarValueUtil` class, which provides utility methods
     * for parsing and formatting scalar values, especially for handling
     * custom GraphQL scalars like `Date` and `DateTime`.
     * @return string The content of the `ScalarValueUtil` class.
     */
    private function generateScalarValueUtil() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.UUID;

/**
 * Utility class for handling scalar value conversions, particularly for custom GraphQL scalars.
 * This class provides methods to parse string values into various data types and to format
 * date-time objects into strings and vice-versa.
 */
public class ScalarValueUtil {

    /**
     * The date-time format string "yyyy-MM-dd HH:mm:ss".
     */
    public static final String DATE_TIME_FORMAT = "yyyy-MM-dd HH:mm:ss";
    /**
     * The date format string "yyyy-MM-dd".
     */
    public static final String DATE_FORMAT = "yyyy-MM-dd";

    /**
     * Parses a string value into an object of a specified target type.
     * @param value The string value to parse.
     * @param targetType The target class type to convert the value into.
     * @return The parsed object of the target type.
     * @throws IllegalArgumentException if the target type is not supported.
     */
    public static Object parseValue(String value, Class<?> targetType) {
        if (targetType == String.class) {
            return value;
        } else if (targetType == Integer.class) {
            return Integer.parseInt(value);
        } else if (targetType == Long.class) {
            return Long.parseLong(value);
        } else if (targetType == Boolean.class) {
            return Boolean.parseBoolean(value);
        } else if (targetType == Double.class) {
            return Double.parseDouble(value);
        } else if (targetType == Float.class) {
            return Float.parseFloat(value);
        } else if (targetType == UUID.class) {
            return UUID.fromString(value);
        }
        // Add more type conversions as needed
        throw new IllegalArgumentException("Unsupported target type: " + targetType.getName());
    }

    /**
     * Converts a LocalDateTime object to a string using the defined DATE_TIME_FORMAT.
     * @param datetime The LocalDateTime object to convert.
     * @return A string representation of the date-time, or null if the input is null.
     */
    public static String localDateTimeToString(LocalDateTime datetime) {
        if (datetime == null) {
            return null;
        }
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(ScalarValueUtil.DATE_TIME_FORMAT);
        return datetime.format(formatter);
    }

    /**
     * Converts a LocalDate object to a date string using the defined DATE_FORMAT.
     * @param datetime The LocalDate object to convert.
     * @return A string representation of the date part, or null if the input is null.
     */
    public static String localDateToString(LocalDate datetime) {
        if (datetime == null) {
            return null;
        }
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(ScalarValueUtil.DATE_FORMAT);
        return datetime.format(formatter);
    }

    /**
     * Converts a string in the DATE_TIME_FORMAT to a LocalDateTime object.
     * @param datetime The string to convert.
     * @return A LocalDateTime object, or null if the input string is null or empty.
     */
    public static LocalDateTime stringToLocalDateTime(String datetime) {
        if (datetime == null || datetime.isEmpty()) {
            return null;
        }
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(ScalarValueUtil.DATE_TIME_FORMAT);
        return LocalDateTime.parse(datetime, formatter);
    }

    /**
     * Converts a string in the DATE_FORMAT to a LocalDateTime object. Note that the time components will be set to zero.
     * @param datetime The date string to convert.
     * @return A LocalDate object parsed from the date string, or null if the input string is null or empty.
     */
    public static LocalDate stringToLocalDate(String datetime) {
        if (datetime == null || datetime.isEmpty()) {
            return null;
        }
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(ScalarValueUtil.DATE_FORMAT);
        return LocalDate.parse(datetime, formatter);
    }
}
JAVA;
    }

    /**
     * Generates the Controller class for a given table.
     * @param string $tableName The name of the database table.
     * @param array $tableInfo The information about the table's columns.
     * @return string The content of the Controller class.
     */
    private function generateControllerClass($tableName, $tableInfo) {
        $camelName = $this->camelCase($tableName);
        $ucCamelName = ucfirst($camelName);
        $pluralCamelName = $this->pluralize($camelName);
        $package = $this->projectConfig['packageName'];
        $schemaMappings = "";
        $pkJavaType = 'String';
        $pkAutogenerated = false;
        foreach ($tableInfo['columns'] as $col) {
            if ($col['isPrimaryKey']) {
                $pkJavaType = $this->mapDbTypeToJavaType($col['type'], $col['length']);
                $pkAutogenerated = $col['isAutoIncrement'] || $col['primaryKeyValue'] == 'autogenerated';
                break;
            }
        }

        $relatedEntityImports = "";
        foreach ($tableInfo['columns'] as $colInfo) {
            if ($colInfo['isForeignKey']) {
                $refClassName = ucfirst($this->camelCase($colInfo['references']));
                $relatedEntityImports .= "\nimport $package.model.entity.$refClassName;";
            }
        }

        $fieldResolvers = $this->generateFieldResolvers($tableName, $tableInfo);
        if(strpos($fieldResolvers, 'ScalarValueUtil') !== false) {
            $importScalarValueUtil = "\nimport $package.util.ScalarValueUtil;";
        } else {
            $importScalarValueUtil = "";
        }

        $returnUpdate = "        return {$camelName}Repository.save({$camelName});\n";
        if(!$pkAutogenerated)
        {
            $returnUpdate = "        {$camelName}Repository.save({$camelName});\n";
            $returnUpdate .= "        int rowsAffected;\n";
            foreach ($tableInfo['columns'] as $colName => $col) {
                if ($col['isPrimaryKey']) {
                    $camelCasePk = $this->camelCase($colName);
                    $upperCamelCasePk = ucfirst($camelCasePk);;
                    $returnUpdate .= "        // Update $camelCasePk\n";
                    $returnUpdate .= "        if(ValueUtil.valuable(dtoInput.get{$upperCamelCasePk}())) {\n";
                    $returnUpdate .= "            rowsAffected = {$camelName}Repository.update{$upperCamelCasePk}({$camelName}.get{$upperCamelCasePk}(), dtoInput.get{$upperCamelCasePk}());\n";
                    $returnUpdate .= "            if (rowsAffected > 0) {\n";
                    $returnUpdate .= "                $camelName.set{$upperCamelCasePk}(dtoInput.get{$upperCamelCasePk}());\n";
                    $returnUpdate .= "            }\n";
                    $returnUpdate .= "        }\n";
                }
            }
            $returnUpdate .= "        return $camelName;\n";
        }

        $code = <<<JAVA
package $package.controller;

import $package.model.dto.FilterInput;
import $package.model.dto.SortInput;
import $package.model.dto.{$ucCamelName}Input;{$relatedEntityImports}
import $package.model.entity.$ucCamelName;
import $package.model.repository.{$ucCamelName}Repository;
import $package.util.AuditTrailUtil;
import $package.util.QueryUtil;
import $package.util.ValueUtil;$importScalarValueUtil
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.graphql.data.method.annotation.Argument;
import org.springframework.graphql.data.method.annotation.SchemaMapping;
import org.springframework.graphql.data.method.annotation.MutationMapping;
import org.springframework.graphql.data.method.annotation.QueryMapping;
import org.springframework.stereotype.Controller;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Map;

@Controller
public class {$ucCamelName}Controller {

    @Autowired
    private {$ucCamelName}Repository {$camelName}Repository;

    @QueryMapping
    public $ucCamelName {$camelName}(@Argument $pkJavaType id) {
        return {$camelName}Repository.findById(id).orElse(null);
    }

    @QueryMapping
    public Map<String, Object> {$pluralCamelName} (
            @Argument Integer limit,
            @Argument Integer offset,
            @Argument Integer page,
            @Argument Integer size,
            @Argument List<SortInput> orderBy,
            @Argument List<FilterInput> filter) {

        Pageable pageable = QueryUtil.createPageable(limit, offset, page, size, orderBy);
        Specification<$ucCamelName> specification = QueryUtil.createSpecification(filter);

        Page<$ucCamelName> resultPage = {$camelName}Repository.findAll(specification, pageable);

        return QueryUtil.createPageResultMap(resultPage);
    }

    @MutationMapping
    @Transactional
    public $ucCamelName create{$ucCamelName}(@Argument Map<String, Object> input) {
        $ucCamelName {$camelName} = new $ucCamelName();
        // Manual mapping from Map<String, Object> to Entity.
{$this->generateDtoToEntityMapping($tableName, $tableInfo, $camelName, 'dtoInput', 'create')}
        return {$camelName}Repository.save({$camelName});
    }

    @MutationMapping
    @Transactional
    public $ucCamelName update{$ucCamelName}(@Argument $pkJavaType id, @Argument Map<String, Object> input) {
        $ucCamelName {$camelName} = {$camelName}Repository.findById(id)
            .orElseThrow(() -> new RuntimeException("{$ucCamelName} not found with id " + id));
        // Manual mapping from Map<String, Object> to Entity.
{$this->generateDtoToEntityMapping($tableName, $tableInfo, $camelName, 'dtoInput', 'update')}
$returnUpdate    }

    @MutationMapping
    @Transactional
    public boolean delete{$ucCamelName}(@Argument $pkJavaType id) {
        {$camelName}Repository.deleteById(id);
        return true;
    }

{$this->generateToggleActiveMutation($tableName, $tableInfo)}
}
JAVA;

        // Inject field resolvers before the final closing brace
        
        $lastBracePos = strrpos($code, '}');
        if ($lastBracePos !== false) {
            // Insert the resolvers before the last closing brace of the class
            $code = substr_replace($code, $fieldResolvers, $lastBracePos, 0);
        }

        return $code;
    }

    /**
     * Generates field resolvers for foreign key relationships and camelCase to snake_case mapping.
     *
     * @param string $tableName The name of the table.
     * @param array $tableInfo The table information.
     * @return string The generated field resolver methods.
     */
    private function generateFieldResolvers($tableName, $tableInfo) {
        $resolvers = "";
        $ucCamelTableName = ucfirst($this->camelCase($tableName));
        $camelTableName = $this->camelCase($tableName);
    
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            $camelColName = $this->camelCase($colName);
            $ucCamelColName = ucfirst($camelColName);
    
            // Resolver for snake_case field to camelCase getter
            if ($colName !== $camelColName) {
                $javaType = $this->mapDbTypeToJavaType($colInfo['type'], $colInfo['length']);
                $baseJavaType = basename(str_replace('\\', '/', $javaType));

                $returnValue = "{$camelTableName}.get{$ucCamelColName}()";

                if(strpos($baseJavaType, 'LocalDateTime') !== false) {
                    $baseJavaType = 'String'; // Or custom scalar
                    $returnValue = "ScalarValueUtil.localDateTimeToString($returnValue)";
                }
                else if(strpos($baseJavaType, 'LocalDate') !== false) {
                    $baseJavaType = 'String'; // Or custom scalar
                    $returnValue = "ScalarValueUtil.localDateToString($returnValue)";
                }

                $upperCamelColName = PicoStringUtil::upperCamelize($colName);
                $resolvers .= "\n    @SchemaMapping(typeName = \"$ucCamelTableName\", field = \"$colName\")\n";
                $resolvers .= "    public $baseJavaType get{$upperCamelColName}($ucCamelTableName $camelTableName) {\n";
                $resolvers .= "        return $returnValue;\n";
                $resolvers .= "    }\n";
            }
    
            // Resolver for relationship objects
            if ($colInfo['isForeignKey']) {
                $refTableName = $colInfo['references'];
                $refCamelName = $this->camelCase($refTableName);
                $refUcCamelName = ucfirst($refCamelName);

                // Resolver for the related object itself
                $resolvers .= "\n    @SchemaMapping(typeName = \"$ucCamelTableName\", field = \"$refTableName\")\n";
                $resolvers .= "    public $refUcCamelName get".ucfirst($refCamelName)."($ucCamelTableName $camelTableName) {\n";
                $resolvers .= "        return {$camelTableName}.get".ucfirst($refCamelName)."();\n";
                $resolvers .= "    }\n";
            }
        }
    
        return $resolvers;
    }

    /**
     * Maps Java types to GraphQL types.
     *
     * @param string $javaType The Java type.
     * @return string The corresponding GraphQL type.
     */
    private function mapJavaTypeToGqlType($javaType) {
        $baseType = basename(str_replace('\\', '/', $javaType));
        switch ($baseType) {
            case 'Integer':
                return 'Int';
            case 'Double':
            case 'Float':
                return 'Float';
            case 'Boolean':
                return 'Boolean';
            case 'String':
            case 'LocalDate':
            case 'LocalDateTime':
                return 'String'; // Or custom scalars
            default:
                return 'String';
        }
    }
    
    /**
     * Get project configuration.
     */
    public function getProjectConfig()
    {
        return $this->projectConfig;
    }

    /**
     * Generates the SpecificationBuilder class for dynamic filtering.
     *
     * @return string The Java code for SpecificationBuilder.java.
     */
    private function generateSpecificationBuilder() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

import org.springframework.data.jpa.domain.Specification;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

public class SpecificationBuilder<T> {

    private final List<FilterCriteria> params;

    public SpecificationBuilder() {
        params = new ArrayList<>();
    }

    public SpecificationBuilder<T> with(String key, SearchOperation operation, Object value) {
        params.add(new FilterCriteria(key, operation, value));
        return this;
    }

    public Specification<T> build() {
        if (params.isEmpty()) {
            return null;
        }

        List<Specification<T>> specs = params.stream()
                .map(GenericSpecification<T>::new)
                .collect(Collectors.toList());

        Specification<T> result = specs.get(0);

        for (int i = 1; i < params.size(); i++) {
            result = Specification.where(result).and(specs.get(i));
        }
        return result;
    }
}
JAVA;
    }

    /**
     * Generates the FilterCriteria class for filtering specifications.
     *
     * @return string The Java code for FilterCriteria.java.
     */
    private function generateFilterCriteria() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class FilterCriteria {
    private String key;
    private SearchOperation operation;
    private Object value;
}
JAVA;
    }

    /**
     * Generates the AuditTrailUtil class for audit trail information.
     *
     * @return string The Java code for AuditTrailUtil.java.
     */
    private function generateAuditTrailUtil()
    {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

import java.text.SimpleDateFormat;
import java.util.Date;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

/**
 * Utility class for handling audit trail information such as user details and IP addresses.
 * This class provides static methods to access security and request context information.
 */
public final class AuditTrailUtil {

    private static final SimpleDateFormat DATE_FORMAT = new SimpleDateFormat("yyyy-MM-dd");
    private static final SimpleDateFormat DATETIME_FORMAT = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

    private AuditTrailUtil() {
        // Private constructor to prevent instantiation of this utility class.
    }

    /**
     * Retrieves the username of the currently authenticated user.
     *
     * @return The username of the logged-in user, or "" if no user is authenticated.
     */
    public static String getCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return "";
        }

        Object principal = authentication.getPrincipal();
        if ("anonymousUser".equals(principal)) {
            return "";
        }

        if (principal instanceof UserDetails userDetails) {
            return userDetails.getUsername();
        }

        return principal.toString();
    }

    /**
     * Retrieves the client's IP address from the current request.
     * It checks for the 'X-FORWARDED-FOR' header first, which is common for requests
     * coming through a proxy.
     *
     * @return The client's IP address, or "unknown" if the request context is not available.
     */
    public static String getUserIp() {
        ServletRequestAttributes sra = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (sra == null) {
            return "unknown"; // safer default
        }

        HttpServletRequest request = sra.getRequest();
        String remoteAddr = request.getHeader("X-FORWARDED-FOR");

        if (remoteAddr == null || remoteAddr.isEmpty()) {
            remoteAddr = request.getRemoteAddr();
        } else {
            // If there are multiple IPs (proxy chain), take the first one
            remoteAddr = remoteAddr.split(",")[0].trim();
        }

        return remoteAddr;
    }

    /**
     * Retrieves the ID of the currently authenticated admin user from the session.
     *
     * @return The admin ID as a String, or null if not found in the session.
     */
    public static String getUserId() {
        ServletRequestAttributes sra = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (sra == null) {
            return null;
        }

        HttpServletRequest request = sra.getRequest();
        HttpSession session = request.getSession(false); // Do not create a new session
        if (session != null) {
            Object adminId = session.getAttribute("adminId");
            if (adminId != null) {
                return adminId.toString();
            }
        }
        return null;
    }

    /**
     * Converts a long value into the appropriate object based on the specified data type.
     *
     * @param value     The long value to convert.
     * @param dataType  The target data type as a string (e.g., "String", "Integer", "DateTime").
     * @return The value converted into the specified type.
     */
    public static Object valueOf(long value, String dataType) {
        if (dataType == null) {
            return value;
        }

        switch (dataType.toLowerCase()) {
            case "string":
                return String.valueOf(value);

            case "integer":
                return (int) value;

            case "long":
                return value;

            case "double":
                return (double) value;

            case "float":
                return (float) value;

            case "boolean":
                return value != 0;

            case "date":
                // Return Date object (not String)
                return new Date(value);

            case "datestring":
                return DATE_FORMAT.format(new Date(value));

            case "datetime":
                // Return Date object
                return new Date(value);

            case "datetimestring":
                return DATETIME_FORMAT.format(new Date(value));

            default:
                return value;
        }
    }
}
JAVA;
    }

    /**
     * Generates the SearchOperation enum for filtering specifications.
     *
     * @return string The Java code for SearchOperation.java.
     */
    private function generateSearchOperation() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

public enum SearchOperation {
    EQUALS,
    NOT_EQUALS,
    CONTAINS,
    GREATER_THAN,
    GREATER_THAN_OR_EQUALS,
    LESS_THAN,
    LESS_THAN_OR_EQUALS,
    IN,
    NOT_IN;
}
JAVA;
    }

    /**
     * Generates the GenericSpecification class for dynamic filtering.
     *
     * @return string The Java code for GenericSpecification.java.
     */
    private function generateGenericSpecification() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.util;

import jakarta.persistence.criteria.CriteriaBuilder;
import jakarta.persistence.criteria.CriteriaQuery;
import jakarta.persistence.criteria.Predicate;
import jakarta.persistence.criteria.Root;
import org.springframework.data.jpa.domain.Specification;

@SuppressWarnings("serial")
public class GenericSpecification<T> implements Specification<T> {

    private final FilterCriteria criteria;

    public GenericSpecification(FilterCriteria criteria) {
        this.criteria = criteria;
    }

    @Override
    public Predicate toPredicate(Root<T> root, CriteriaQuery<?> query, CriteriaBuilder builder) {
        String key = criteria.getKey();
        Object value = criteria.getValue();

        // Get the expected Java type for the field from the JPA entity metadata
        Class<?> fieldType = root.get(key).getJavaType();
        Object typedValue = value;

        // Convert the incoming value (which can be String, BigDecimal, Boolean, etc.) to the correct type
        if (value != null) {
            String stringValue = value.toString();
            if (fieldType.equals(Integer.class) || fieldType.equals(int.class)) {
                typedValue = Integer.parseInt(stringValue);
            } else if (fieldType.equals(Long.class) || fieldType.equals(long.class)) {
                typedValue = Long.parseLong(stringValue);
            } else if (fieldType.equals(Double.class) || fieldType.equals(double.class)) {
                typedValue = Double.parseDouble(stringValue);
            } else if (fieldType.equals(Float.class) || fieldType.equals(float.class)) {
                typedValue = Float.parseFloat(stringValue);
            } else if (fieldType.equals(Boolean.class) || fieldType.equals(boolean.class)) {
                typedValue = Boolean.parseBoolean(stringValue);
            } else if (fieldType.equals(String.class)) {
                typedValue = stringValue;
            } else if (fieldType.isEnum()) {
                typedValue = Enum.valueOf((Class<Enum>) fieldType, stringValue);
            }
            // Note: java.time types might need specific parsing if required
        }

        switch (criteria.getOperation()) {
            case EQUALS:
                return builder.equal(root.get(key), typedValue);
            case NOT_EQUALS:
                return builder.notEqual(root.get(key), typedValue);
            case GREATER_THAN:
                return builder.greaterThan(root.get(key), typedValue.toString());
            case GREATER_THAN_OR_EQUALS:
                return builder.greaterThanOrEqualTo(root.get(key), typedValue.toString());
            case LESS_THAN:
                return builder.lessThan(root.get(key), typedValue.toString());
            case LESS_THAN_OR_EQUALS:
                return builder.lessThanOrEqualTo(root.get(key), typedValue.toString());
            case CONTAINS:
                if (root.get(key).getJavaType() == String.class) {
                    return builder.like(root.get(key), "%" + typedValue + "%");
                } else {
                    return builder.equal(root.get(key), typedValue);
                }
            case IN:
                return root.get(key).in((Object[]) typedValue);
            case NOT_IN:
                return builder.not(root.get(key).in((Object[]) typedValue));
            default:
                return null;
        }
    }
}
JAVA;
    }

    /**
     * Generates the SecurityConfig class for application security.
     *
     * @return string The Java code for SecurityConfig.java.
     */
    private function generateSecurityConfig() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package {$package}.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.session.data.redis.config.annotation.web.http.EnableRedisHttpSession;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.http.HttpStatus;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.HttpStatusEntryPoint;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;
import {$package}.service.JpaUserDetailsService;
import org.springframework.security.config.http.SessionCreationPolicy;
import {$package}.model.repository.core.AdminRepository;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.context.annotation.Bean;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    private final JpaUserDetailsService userDetailsService;
    private final AdminRepository adminRepository;

    @Value("\${app.security.require-login:true}")
    private boolean requireLogin;

    public SecurityConfig(JpaUserDetailsService userDetailsService, AdminRepository adminRepository) {
        this.userDetailsService = userDetailsService;
        this.adminRepository = adminRepository;
    }

    @Bean
    public Sha1PasswordEncoder passwordEncoder() 
    {
        return new Sha1PasswordEncoder();
    }
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.csrf(AbstractHttpConfigurer::disable);
        
        // Disable default logout handling in all cases, as we will manage it in AuthController
        http.logout(logout -> logout.disable());

        if (!requireLogin) {
            // If login is not required, permit all requests.
            http
                .authorizeHttpRequests(auth -> auth.anyRequest().permitAll())
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));
        } else {
            // If login is required, set up session-based security with our custom filter.
            SessionAuthFilter sessionAuthFilter = new SessionAuthFilter(adminRepository);
            http.addFilterBefore(sessionAuthFilter, UsernamePasswordAuthenticationFilter.class);

            AuthenticationEntryPoint apiEntryPoint = new HttpStatusEntryPoint(HttpStatus.UNAUTHORIZED);

            http            
                .authorizeHttpRequests(auth -> auth
                    .requestMatchers(
                        "/login", 
                        "/logout", 
                        "/",
                        "/index.html",
                        "/assets/**",
                        "/favicon.ico"
                    ).permitAll()
                    .requestMatchers(
                        "/graphiql/**",
                        "/vendor/**" // GraphiQL dependencies
                        ).permitAll() // Allow GraphiQL UI
                    .anyRequest().authenticated()
                )
                .userDetailsService(userDetailsService)
                .exceptionHandling(e -> e
                    // For API paths, return 401. For others, redirect to login.
                    .defaultAuthenticationEntryPointFor(
                        apiEntryPoint, new AntPathRequestMatcher("/graphql/**")
                    )
                );
        }

        return http.build();
    }
}

@Configuration
@ConditionalOnProperty(name = "spring.session.store-type", havingValue = "redis")
@EnableRedisHttpSession
class RedisSessionConfig {
    // This class is intentionally empty.
    // Its purpose is to conditionally enable Redis session management
    // based on the application properties.
}
JAVA;
    }

    /**
     * Generates the CorsConfig class for CORS configuration.
     *
     * @return string The Java code for CorsConfig.java.
     */
    private function generateCorsConfig() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package {$package}.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig {

    @Value("\${app.security.cors.allowed-origins:}")
    private String[] allowedOrigins;

    @Bean
    @ConditionalOnProperty(name = "app.security.cors.enabled", havingValue = "true")
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurer() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**") // Apply to all endpoints
                        .allowedOrigins(allowedOrigins)
                        .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                        .allowedHeaders("*")
                        .allowCredentials(true);
            }
        };
    }
}
JAVA;
    }
    
    /**
     * Generates the SessionAuthFilter class for session-based authentication.
     *
     * @return string The Java code for SessionAuthFilter.java.
     */
    private function generateSessionAuthFilter() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package {$package}.config;

import {$package}.model.repository.core.AdminRepository;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Collections;

public class SessionAuthFilter extends OncePerRequestFilter {

    private final AdminRepository adminRepository;

    public SessionAuthFilter(AdminRepository adminRepository) {
        this.adminRepository = adminRepository;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {

        HttpSession session = request.getSession(false);

        if (session != null && session.getAttribute("username") != null && session.getAttribute("password") != null) {
            String username = (String) session.getAttribute("username");
            String sessionPasswordHash = (String) session.getAttribute("password"); // This is sha1(password)

            adminRepository.findByUsername(username).ifPresent(admin -> {
                Sha1PasswordEncoder encoder = new Sha1PasswordEncoder();
                // We need to re-validate the session password against the one in the database.
                // The password in DB is sha1(sha1(plain_password))
                // The password in Session is sha1(plain_password)
                // So, we hash the session password again and compare with DB password.
                if (encoder.sha1(sessionPasswordHash).equals(admin.getPassword())) {
                    UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                            username, null, Collections.singletonList(new SimpleGrantedAuthority("ROLE_USER")));
                    SecurityContextHolder.getContext().setAuthentication(authToken);
                }
            });
        }
        filterChain.doFilter(request, response);
    }
}
JAVA;
    }

    /**
     * Generates the Sha1PasswordEncoder class for password encoding.
     *
     * @return string The Java code for Sha1PasswordEncoder.java.
     */
    private function generateSha1PasswordEncoder() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.config;

import org.springframework.security.crypto.password.PasswordEncoder;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.math.BigInteger;

public class Sha1PasswordEncoder implements PasswordEncoder {

    @Override
    public String encode(CharSequence rawPassword) {
        // This replicates sha1(sha1(password))
        return sha1(sha1(rawPassword.toString()));
    }

    @Override
    public boolean matches(CharSequence rawPassword, String encodedPassword) {
        // The rawPassword is the plain text from the login form.
        // The encodedPassword is the double-hashed password from the database.
        // We must double-hash the raw password to match what's in the database.
        return encodedPassword.equals(encode(rawPassword));
    }

    public String sha1(String input) {
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-1");
            byte[] messageDigest = md.digest(input.getBytes());
            BigInteger no = new BigInteger(1, messageDigest);
            String hashtext = no.toString(16);
            while (hashtext.length() < 40) { // SHA-1 is 40 chars long
                hashtext = "0" + hashtext;
            }
            return hashtext;
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException(e);
        }
    }
}
JAVA;
    }

    /**
     * Generates the JpaUserDetailsService class for loading user details.
     *
     * @return string The Java code for JpaUserDetailsService.java.
     */
    private function generateUserDetailsService() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.service;

import $package.model.repository.core.AdminRepository;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

@Service
public class JpaUserDetailsService implements UserDetailsService {

    private final AdminRepository adminRepository;

    public JpaUserDetailsService(AdminRepository adminRepository) {
        this.adminRepository = adminRepository;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        return adminRepository.findByUsername(username)
                .map(admin -> {
                    // The password stored in the database is sha1(sha1(password)).
                    // Spring Security's session authentication will compare against the session's password, which is sha1(password).
                    // Therefore, we must provide the double-hashed password here for the initial login check to succeed.
                    return User.withUsername(admin.getUsername()).password(admin.getPassword()).roles("USER").build();
                })
                .orElseThrow(() -> new UsernameNotFoundException("User not found with username: " + username));
    }
}
JAVA;
    }

    /**
     * Generates the Admin entity class.
     *
     * @return string The Java code for Admin.java.
     */
    private function generateAdminEntity() {
        $package = $this->projectConfig['packageName'];
        // A simplified Admin entity based on auth.php and login.php logic
        return <<<JAVA
package $package.model.entity.core;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.Data;

@Data
@Entity
@Table(name = "admin")
public class Admin {
    @Id
    @Column(name = "admin_id")
    private String adminId;
    private String username;
    private String password;
    private String name;
    private String email;
    private String phone;
    @Column(name = "admin_level_id")
    private String adminLevelId;
}
JAVA;
    }

    /**
     * Generates the AdminRepository interface.
     *
     * @return string The Java code for AdminRepository.java.
     */
    private function generateAdminRepository() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.model.repository.core;

import org.springframework.data.jpa.repository.JpaRepository;

import $package.model.entity.core.Admin;

import java.util.Optional;

public interface AdminRepository extends JpaRepository<Admin, String> {
    Optional<Admin> findByUsername(String username);
}
JAVA;
    }

    /**
     * Generates the LoginRequest class.
     *
     * @return string The Java code for LoginRequest.java.
     */
    private function generateLoginRequestDto() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.dto;

import lombok.Data;
@Data
public class LoginRequest {
    private String username;
    private String password;
}
JAVA;
    }

    /**
     * Generates the LoginResponse class.
     *
     * @return string The Java code for LoginResponse.java.
     */
    private function generateLoginResponseDto() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
@Data
@AllArgsConstructor
public class LoginResponse {
    private boolean success;
    private String message;
}
JAVA;
    }

    /**
     * Generates the AuthController class for handling authentication.
     *
     * @return string The Java code for AuthController.java.
     */
    private function generateAuthController() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.core;

import $package.config.Sha1PasswordEncoder;
import $package.controller.dto.LoginResponse;
import $package.model.repository.core.AdminRepository;
import jakarta.servlet.http.HttpSession;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class AuthController {

    @Value("\${app.security.require-login:true}")
    private boolean requireLogin;

    private final AdminRepository adminRepository;
    private final Sha1PasswordEncoder passwordEncoder;

    public AuthController(AdminRepository adminRepository, Sha1PasswordEncoder passwordEncoder) {
        this.adminRepository = adminRepository;
        this.passwordEncoder = passwordEncoder;
    }

    @PostMapping("/login")
    public ResponseEntity<LoginResponse> login(@RequestParam String username, @RequestParam String password, HttpSession session) {
        if (!requireLogin) {
            return ResponseEntity.ok(new LoginResponse(true, "Success"));
        }
        String singleHashedPassword = passwordEncoder.sha1(password);
        return adminRepository.findByUsername(username)
                .filter(admin -> admin.getPassword().equals(passwordEncoder.encode(password)))
                .map(admin -> {
                    session.setAttribute("username", admin.getUsername());
                    // Store the single-hashed password in the session for subsequent requests.
                    session.setAttribute("password", singleHashedPassword);
                    session.setAttribute("adminId", admin.getAdminId());
                    session.setAttribute("adminName", admin.getName());
                    session.setAttribute("adminEmail", admin.getEmail());
                    return ResponseEntity.ok(new LoginResponse(true, "Login successful"));
                })
                .orElse(ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(new LoginResponse(false, "Invalid credentials")));
    }

    @RequestMapping(value = "/logout", method = {RequestMethod.GET, RequestMethod.POST})
    public ResponseEntity<LoginResponse> logout(HttpServletRequest request) {
        if (!requireLogin) {
            return ResponseEntity.ok(new LoginResponse(true, "Success"));
        }
        HttpSession session = request.getSession(false); // Get session only if it exists, don't create a new one
        if (session != null) {
            session.invalidate();
        }
        return ResponseEntity.ok(new LoginResponse(true, "Logout successful"));
    }
}
JAVA;
    }

    /**
     * Generates the AppController class for various utility endpoints.
     *
     * @return string The Java code for AppController.java.
     */
    private function generateAppController() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.core;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@RestController
public class AppController {

    private final ResourceLoader resourceLoader;
    private final ObjectMapper objectMapper;

    public AppController(ResourceLoader resourceLoader, ObjectMapper objectMapper) {
        this.resourceLoader = resourceLoader;
        this.objectMapper = objectMapper;
    }

    // Replicates available-language.php
    @GetMapping(value = "/available-language", produces = "application/json")
    public Object getAvailableLanguages() throws IOException {
        Resource resource = resourceLoader.getResource("classpath:static/langs/available-language.json");
        String jsonContent = new String(Files.readAllBytes(Paths.get(resource.getURI())));
        return objectMapper.readValue(jsonContent, Object.class);
    }

    // Replicates available-theme.php
    @GetMapping("/available-theme")
    public Object[] getAvailableThemes() throws IOException {
        List<Map<String, String>> themes = new ArrayList<>();
        Resource resource = resourceLoader.getResource("classpath:static/assets/themes/");

        if (resource.exists()) {
            File themesDir = resource.getFile();
            if (themesDir.isDirectory()) {
                File[] themeSubDirs = themesDir.listFiles(File::isDirectory);
                if (themeSubDirs != null) {
                    for (File dir : themeSubDirs) {
                        String name = dir.getName();
                        String title = toTitleCase(name.replace('-', ' '));
                        themes.add(Map.of("name", name, "title", title));
                    }
                }
            }
        }
        return themes.toArray();
    }

    private String toTitleCase(String text) {
        if (text == null || text.isEmpty()) {
            return text;
        }
        StringBuilder converted = new StringBuilder();
        boolean convertNext = true;
        for (char ch : text.toCharArray()) {
            ch = convertNext ? Character.toTitleCase(ch) : Character.toLowerCase(ch);
            converted.append(ch);
            convertNext = Character.isSpaceChar(ch);
        }
        return converted.toString();
    }

    // Replicates frontend-config.php
    @GetMapping(value = "/frontend-config", produces = "application/json")
    public Object getFrontendConfig() throws IOException {
        Resource resource = resourceLoader.getResource("classpath:frontend-config.json");
        String jsonContent = new String(Files.readAllBytes(Paths.get(resource.getURI())));
        return objectMapper.readValue(jsonContent, Object.class);
    }
    
    // Other endpoints like /user-profile, /settings etc. would go here
}
JAVA;
    }

    /**
     * Generates the `AdminController` class for managing admin users.
     *
     * This controller provides RESTful endpoints for CRUD (Create, Read, Update, Delete) operations on the Admin entity.
     * Additionally, it handles functionalities such as toggling the active status, changing passwords,
     * and displaying the admin list and details. The methods within it directly generate HTML content
     * for the user interface (UI).
     *
     * @return string The Java code for the `AdminController` class.
     */
    private function generateAdminController() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.core;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import $package.util.I18nUtil;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

@RestController
@RequestMapping("/admin")
public class AdminController {

    @Autowired
    private NamedParameterJdbcTemplate jdbcTemplate;

    @Autowired
    private I18nUtil i18nUtil;

    @Value("classpath:frontend-config.json")
    private Resource configFile;

    private String sha1(String input) throws NoSuchAlgorithmException {
        MessageDigest md = MessageDigest.getInstance("SHA-1");
        byte[] result = md.digest(input.getBytes(StandardCharsets.UTF_8));
        StringBuilder sb = new StringBuilder();
        for (byte b : result) {
            sb.append(String.format("%02x", b));
        }
        return sb.toString();
    }

    private String hashPassword(String password) throws NoSuchAlgorithmException {
        return sha1(sha1(password));
    }

    private Map<String, Object> getAppAdmin(HttpSession session) {
        String username = (String) session.getAttribute("username");
        if (username == null) {
            return null;
        }
        String sql = "SELECT * FROM admin WHERE username = :username";
        MapSqlParameterSource params = new MapSqlParameterSource("username", username);
        try {
            return jdbcTemplate.queryForMap(sql, params);
        } catch (Exception e) {
            return null;
        }
    }

    @GetMapping(produces = MediaType.TEXT_HTML_VALUE)
    public ResponseEntity<String> handleAdminView(
            @RequestParam(value = "view", required = false, defaultValue = "list") String view,
            @RequestParam(value = "adminId", required = false) String adminId,
            @RequestParam(value = "search", required = false) String search,
            @RequestParam(value = "page", required = false, defaultValue = "1") int page,
            @RequestHeader(value = "X-Language-Id", required = false) String lang,
            HttpServletRequest request) {

        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("username") == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("User not authenticated");
        }

        try {
            switch (view) {
                case "create":
                    return ResponseEntity.ok(buildCreateEditForm(null, lang));
                case "edit":
                    return ResponseEntity.ok(buildCreateEditForm(adminId, lang));
                case "change-password":
                    return ResponseEntity.ok(buildChangePasswordForm(adminId, lang));
                case "detail":
                    return ResponseEntity.ok(buildDetailView(adminId, lang, session));
                default:
                    return ResponseEntity.ok(buildListView(search, page, lang));
            }
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(e.getMessage());
        }
    }

    @PostMapping
    public ResponseEntity<Map<String, Object>> handleAdminAction(
            @RequestParam("action") String action,
            HttpServletRequest request,
            @RequestHeader(value = "X-Language-Id", required = false) String lang) {

        HttpSession session = request.getSession(false);
        Map<String, Object> appAdmin = getAppAdmin(session);
        if (appAdmin == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of("success", false, "message", "User not authenticated"));
        }

        String adminId = request.getParameter("adminId");
        Map<String, Object> response = new HashMap<>();

        try {
            switch (action) {
                case "create":
                case "update":
                    return saveAdmin(request, action, adminId, appAdmin, lang);
                case "toggle_active":
                    return toggleActive(adminId, appAdmin, lang);
                case "change_password":
                    return changePassword(request, adminId, lang);
                case "delete":
                    return deleteAdmin(adminId, appAdmin, lang);
                default:
                    response.put("success", false);
                    response.put("message", "Invalid action");
                    return ResponseEntity.badRequest().body(response);
            }
        } catch (Exception e) {
            response.put("success", false);
            response.put("message", e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }

    private ResponseEntity<Map<String, Object>> saveAdmin(HttpServletRequest request, String action, String adminId, Map<String, Object> appAdmin, String lang) throws NoSuchAlgorithmException {
        String name = request.getParameter("name");
        String username = request.getParameter("username");
        String email = request.getParameter("email");
        String adminLevelId = request.getParameter("admin_level_id");
        boolean active = request.getParameter("active") != null;

        MapSqlParameterSource params = new MapSqlParameterSource();
        params.addValue("name", name);
        params.addValue("username", username);
        params.addValue("email", email);

        if ("create".equals(action)) {
            String password = request.getParameter("password");
            if (password == null || password.isEmpty()) {
                throw new IllegalArgumentException(i18nUtil.t("password_is_required", lang));
            }
            String hashedPassword = hashPassword(password);
            String newId = UUID.randomUUID().toString();

            String sql = "INSERT INTO admin (admin_id, name, username, email, password, admin_level_id, active, time_create, admin_create, ip_create) " +
                         "VALUES (:admin_id, :name, :username, :email, :password, :admin_level_id, :active, :time_create, :admin_create, :ip_create)";
            params.addValue("admin_id", newId);
            params.addValue("password", hashedPassword);
            params.addValue("admin_level_id", adminLevelId);
            params.addValue("active", active ? 1 : 0);
            params.addValue("time_create", new Date());
            params.addValue("admin_create", appAdmin.get("admin_id"));
            params.addValue("ip_create", request.getRemoteAddr());
            jdbcTemplate.update(sql, params);
            return ResponseEntity.ok(Map.of("success", true, "message", i18nUtil.t("admin_created_successfully", lang)));

        } else { // update
            if (adminId == null) throw new IllegalArgumentException(i18nUtil.t("admin_id_required", lang));

            // Prevent user from changing their own level or deactivating themselves
            if (adminId.equals(appAdmin.get("admin_id"))) {
                active = true;
                adminLevelId = (String) appAdmin.get("admin_level_id");
            }

            String sql = "UPDATE admin SET name = :name, username = :username, email = :email, admin_level_id = :admin_level_id, active = :active, " +
                         "time_edit = :time_edit, admin_edit = :admin_edit, ip_edit = :ip_edit WHERE admin_id = :admin_id";
            params.addValue("admin_level_id", adminLevelId);
            params.addValue("active", active ? 1 : 0);
            params.addValue("time_edit", new Date());
            params.addValue("admin_edit", appAdmin.get("admin_id"));
            params.addValue("ip_edit", request.getRemoteAddr());
            params.addValue("admin_id", adminId);
            jdbcTemplate.update(sql, params);
            return ResponseEntity.ok(Map.of("success", true, "message", i18nUtil.t("admin_updated_successfully", lang)));
        }
    }

    private ResponseEntity<Map<String, Object>> toggleActive(String adminId, Map<String, Object> appAdmin, String lang) {
        if (adminId == null) throw new IllegalArgumentException(i18nUtil.t("admin_id_required", lang));
        if (adminId.equals(appAdmin.get("admin_id"))) {
            throw new IllegalArgumentException(i18nUtil.t("cannot_deactivate_self", lang));
        }

        String sqlSelect = "SELECT active FROM admin WHERE admin_id = :admin_id";
        Boolean currentStatus = jdbcTemplate.queryForObject(sqlSelect, new MapSqlParameterSource("admin_id", adminId), Boolean.class);

        int newStatus = (currentStatus != null && currentStatus) ? 0 : 1;

        String sqlUpdate = "UPDATE admin SET active = :active WHERE admin_id = :admin_id";
        MapSqlParameterSource params = new MapSqlParameterSource();
        params.addValue("active", newStatus);
        params.addValue("admin_id", adminId);
        jdbcTemplate.update(sqlUpdate, params);

        return ResponseEntity.ok(Map.of("success", true, "message", i18nUtil.t("admin_status_updated", lang)));
    }

    private ResponseEntity<Map<String, Object>> changePassword(HttpServletRequest request, String adminId, String lang) throws NoSuchAlgorithmException {
        if (adminId == null) throw new IllegalArgumentException(i18nUtil.t("admin_id_required", lang));
        String password = request.getParameter("password");
        if (password == null || password.isEmpty()) {
            throw new IllegalArgumentException(i18nUtil.t("password_is_required", lang));
        }
        String hashedPassword = hashPassword(password);
        String sql = "UPDATE admin SET password = :password WHERE admin_id = :admin_id";
        MapSqlParameterSource params = new MapSqlParameterSource();
        params.addValue("password", hashedPassword);
        params.addValue("admin_id", adminId);
        jdbcTemplate.update(sql, params);
        return ResponseEntity.ok(Map.of("success", true, "message", i18nUtil.t("password_updated_successfully", lang)));
    }

    private ResponseEntity<Map<String, Object>> deleteAdmin(String adminId, Map<String, Object> appAdmin, String lang) {
        if (adminId == null) throw new IllegalArgumentException(i18nUtil.t("admin_id_required", lang));
        if (adminId.equals(appAdmin.get("admin_id"))) {
            throw new IllegalArgumentException(i18nUtil.t("cannot_delete_self", lang));
        }
        String sql = "DELETE FROM admin WHERE admin_id = :admin_id";
        jdbcTemplate.update(sql, new MapSqlParameterSource("admin_id", adminId));
        return ResponseEntity.ok(Map.of("success", true, "message", i18nUtil.t("admin_deleted_successfully", lang)));
    }

    private String buildListView(String search, int page, String lang) throws IOException {
        ObjectMapper mapper = new ObjectMapper();
        JsonNode rootNode = mapper.readTree(configFile.getInputStream());
        int pageSize = rootNode.path("pagination").path("pageSize").asInt(20);

        int offset = (page - 1) * pageSize;

        StringBuilder html = new StringBuilder();
        MapSqlParameterSource params = new MapSqlParameterSource();
        String whereClause = "";
        if (search != null && !search.isEmpty()) {
            whereClause = " WHERE (a.name LIKE :search OR a.username LIKE :search)";
            params.addValue("search", "%" + search + "%");
        }

        String countSql = "SELECT COUNT(*) FROM admin a" + whereClause;
        Integer totalAdmins = jdbcTemplate.queryForObject(countSql, params, Integer.class);
        int totalPages = (totalAdmins != null) ? (int) Math.ceil((double) totalAdmins / pageSize) : 0;

        String sql = "SELECT a.admin_id, a.name, a.username, a.email, a.active, al.name as admin_level_name " +
                "FROM admin a " +
                "LEFT JOIN admin_level al ON a.admin_level_id = al.admin_level_id " +
                whereClause +
                " ORDER BY a.name LIMIT :limit OFFSET :offset";
        params.addValue("limit", pageSize);
        params.addValue("offset", offset);

        List<Map<String, Object>> admins = jdbcTemplate.queryForList(sql, params);

        // Build search form
        html.append("<div id=\"filter-container\" class=\"filter-container\" style=\"display: block;\">")
            .append("<form id=\"admin-search-form\" class=\"search-form\" onsubmit=\"handleAdminSearch(event)\">")
            .append("<div class=\"filter-controls\">")
            .append("<div class=\"form-group\">")
            .append("<label for=\"username\">").append(i18nUtil.t("name", lang)).append("</label>")
            .append("<input type=\"text\" name=\"search\" id=\"username\" placeholder=\"").append(i18nUtil.t("name", lang)).append("\" value=\"").append(search != null ? search : "").append("\">")
            .append("</div>")
            .append("<button type=\"submit\" class=\"btn btn-primary\">").append(i18nUtil.t("search", lang)).append("</button>")
            .append("<a href=\"#admin?view=create\" class=\"btn btn-primary\">").append(i18nUtil.t("add_new_admin", lang)).append("</a>")
            .append("</div></form></div>");

        // Build table
        html.append("<div class=\"table-container\"><table class=\"table table-striped\"><thead><tr>")
            .append("<th>").append(i18nUtil.t("name", lang)).append("</th>")
            .append("<th>").append(i18nUtil.t("username", lang)).append("</th>")
            .append("<th>").append(i18nUtil.t("email", lang)).append("</th>")
            .append("<th>").append(i18nUtil.t("admin_level", lang)).append("</th>")
            .append("<th>").append(i18nUtil.t("status", lang)).append("</th>")
            .append("<th>").append(i18nUtil.t("actions", lang)).append("</th>")
            .append("</tr></thead><tbody>");

        if (admins.isEmpty()) {
            html.append("<tr><td colspan=\"6\">").append(i18nUtil.t("no_admins_found", lang)).append("</td></tr>");
        } else {
            for (Map<String, Object> admin : admins) {
                boolean isActive = (Boolean) admin.getOrDefault("active", false);
                String adminId = (String) admin.get("admin_id");
                html.append("<tr class=\"").append(isActive ? "" : "inactive").append("\">")
                    .append("<td>").append(admin.get("name")).append("</td>")
                    .append("<td>").append(admin.get("username")).append("</td>")
                    .append("<td>").append(admin.get("email")).append("</td>")
                    .append("<td>").append(admin.get("admin_level_name")).append("</td>")
                    .append("<td>").append(isActive ? i18nUtil.t("active", lang) : i18nUtil.t("inactive", lang)).append("</td>")
                    .append("<td class=\"actions\">")
                    .append("<a href=\"#admin?view=detail&adminId=").append(adminId).append("\" class=\"btn btn-sm btn-info\">").append(i18nUtil.t("view", lang)).append("</a> ")
                    .append("<a href=\"#admin?view=edit&adminId=").append(adminId).append("\" class=\"btn btn-sm btn-primary\">").append(i18nUtil.t("edit", lang)).append("</a>")
                    .append("</td></tr>");
            }
        }
        html.append("</tbody></table></div>");

        // Build pagination
        html.append("<div class=\"pagination-container\">");
        if (totalPages > 1) {
            String searchQuery = (search != null && !search.isEmpty()) ? "&search=" + search : "";
            html.append("<span>").append(i18nUtil.t("page_of", lang, new Object[]{page, totalPages, totalAdmins})).append("</span>");
            html.append("<div>");
            if (page > 1) {
                html.append("<a href=\"#admin?page=").append(page - 1).append(searchQuery).append("\" class=\"btn btn-secondary\">").append(i18nUtil.t("previous", lang)).append("</a> ");
            }
            if (page < totalPages) {
                html.append("<a href=\"#admin?page=").append(page + 1).append(searchQuery).append("\" class=\"btn btn-secondary\">").append(i18nUtil.t("next", lang)).append("</a>");
            }
            html.append("</div>");
        }
        html.append("</div>");

        return html.toString();
    }

    private String buildDetailView(String adminId, String lang, HttpSession session) {
        Map<String, Object> appAdmin = getAppAdmin(session);
        String sql = "SELECT a.*, al.name as admin_level_name FROM admin a LEFT JOIN admin_level al ON a.admin_level_id = al.admin_level_id WHERE a.admin_id = :admin_id";
        Map<String, Object> admin = jdbcTemplate.queryForMap(sql, new MapSqlParameterSource("admin_id", adminId));

        if (admin == null) {
            return "<p>" + i18nUtil.t("admin_not_found", lang) + "</p>";
        }

        boolean isActive = (Boolean) admin.getOrDefault("active", false);
        boolean isSelf = adminId.equals(appAdmin.get("admin_id"));

        StringBuilder html = new StringBuilder();
        html.append("<div class=\"back-controls\">")
            .append("<a href=\"#admin\" class=\"btn btn-secondary\">").append(i18nUtil.t("back_to_list", lang)).append("</a> ")
            .append("<a href=\"#admin?view=edit&adminId=").append(adminId).append("\" class=\"btn btn-primary\">").append(i18nUtil.t("edit", lang)).append("</a> ");

        if (!isSelf) {
            html.append("<a href=\"#admin?view=change-password&adminId=").append(adminId).append("\" class=\"btn btn-warning\">").append(i18nUtil.t("change_password", lang)).append("</a> ")
                .append("<button class=\"btn ").append(isActive ? "btn-warning" : "btn-success").append("\" onclick=\"handleAdminToggleActive('").append(adminId).append("', ").append(isActive).append(")\">")
                .append(isActive ? i18nUtil.t("deactivate", lang) : i18nUtil.t("activate", lang))
                .append("</button> ")
                .append("<button class=\"btn btn-danger\" onclick=\"handleAdminDelete('").append(adminId).append("')\">").append(i18nUtil.t("delete", lang)).append("</button>");
        }
        html.append("</div>");

        html.append("<div class=\"table-container detail-view\"><table class=\"table\"><tbody>")
            .append("<tr><td><strong>").append(i18nUtil.t("admin_id", lang)).append("</strong></td><td>").append(admin.get("admin_id")).append("</td></tr>")
            .append("<tr><td><strong>").append(i18nUtil.t("name", lang)).append("</strong></td><td>").append(admin.get("name")).append("</td></tr>")
            // ... other fields
            .append("<tr><td><strong>").append(i18nUtil.t("username", lang)).append("</strong></td><td>").append(admin.get("username")).append("</td></tr>")
            .append("<tr><td><strong>").append(i18nUtil.t("email", lang)).append("</strong></td><td>").append(admin.get("email")).append("</td></tr>")
            .append("<tr><td><strong>").append(i18nUtil.t("admin_level", lang)).append("</strong></td><td>").append(admin.get("admin_level_name")).append("</td></tr>")
            .append("<tr><td><strong>").append(i18nUtil.t("status", lang)).append("</strong></td><td>").append(isActive ? i18nUtil.t("active", lang) : i18nUtil.t("inactive", lang)).append("</td></tr>")
            .append("<tr><td><strong>").append(i18nUtil.t("time_create", lang)).append("</strong></td><td>").append(admin.get("time_create")).append("</td></tr>")
            .append("<tr><td><strong>").append(i18nUtil.t("time_edit", lang)).append("</strong></td><td>").append(admin.get("time_edit")).append("</td></tr>")
            .append("</tbody></table></div>");

        return html.toString();
    }

    private String buildCreateEditForm(String adminId, String lang) {
        Map<String, Object> admin = null;
        boolean isCreate = (adminId == null);
        if (!isCreate) {
            String sql = "SELECT * FROM admin WHERE admin_id = :admin_id";
            admin = jdbcTemplate.queryForMap(sql, new MapSqlParameterSource("admin_id", adminId));
        }

        String adminLevelsSql = "SELECT admin_level_id, name FROM admin_level WHERE active = 1 ORDER BY sort_order";
        List<Map<String, Object>> adminLevels = jdbcTemplate.queryForList(adminLevelsSql, new MapSqlParameterSource());

        StringBuilder html = new StringBuilder();
        html.append("<div class=\"back-controls\">")
            .append("<a href=\"#admin\" class=\"btn btn-secondary\">").append(i18nUtil.t("back_to_list", lang)).append("</a>")
            .append("</div>")
            .append("<div class=\"table-container detail-view\">")
            .append("<h3>").append(i18nUtil.t(isCreate ? "add_new_admin" : "edit_admin", lang)).append("</h3>")
            .append("<form id=\"admin-form\" class=\"form-group\" onsubmit=\"handleAdminSave(event, '").append(adminId != null ? adminId : "").append("'); return false;\">")
            .append("<table class=\"table table-borderless\">");

        // Name
        html.append("<tr><td>").append(i18nUtil.t("name", lang)).append("</td><td><input type=\"text\" name=\"name\" value=\"").append(admin != null ? admin.get("name") : "").append("\" required autocomplete=\"off\"></td></tr>");
        // Username
        html.append("<tr><td>").append(i18nUtil.t("username", lang)).append("</td><td><input type=\"text\" name=\"username\" value=\"").append(admin != null ? admin.get("username") : "").append("\" required autocomplete=\"off\"></td></tr>");
        // Email
        html.append("<tr><td>").append(i18nUtil.t("email", lang)).append("</td><td><input type=\"email\" name=\"email\" value=\"").append(admin != null ? admin.get("email") : "").append("\" required autocomplete=\"off\"></td></tr>");

        if (isCreate) {
            html.append("<tr><td>").append(i18nUtil.t("password", lang)).append("</td><td><input type=\"password\" name=\"password\" required autocomplete=\"new-password\"></td></tr>");
        }

        // Admin Level
        html.append("<tr><td>").append(i18nUtil.t("admin_level", lang)).append("</td><td><select name=\"admin_level_id\" required>");
        html.append("<option value=\"\">").append(i18nUtil.t("select_option", lang)).append("</option>");
        for (Map<String, Object> level : adminLevels) {
            String levelId = (String) level.get("admin_level_id");
            String selected = (admin != null && levelId.equals(admin.get("admin_level_id"))) ? "selected" : "";
            html.append("<option value=\"").append(levelId).append("\" ").append(selected).append(">").append(level.get("name")).append("</option>");
        }
        html.append("</select></td></tr>");

        // Active
        boolean isActive = (admin != null && (Boolean) admin.getOrDefault("active", false)) || isCreate;
        html.append("<tr><td>").append(i18nUtil.t("active", lang)).append("</td><td class=\"form-group form-element-checkbox\"><input type=\"checkbox\" name=\"active\" ").append(isActive ? "checked" : "").append("></td></tr>");

        // Buttons
        html.append("<tr><td></td><td>")
            .append("<button type=\"submit\" class=\"btn btn-success\">").append(i18nUtil.t("save", lang)).append("</button> ")
            .append("<a href=\"#admin\" class=\"btn btn-secondary\">").append(i18nUtil.t("cancel", lang)).append("</a>")
            .append("</td></tr>");

        html.append("</table></form></div>");
        return html.toString();
    }

    private String buildChangePasswordForm(String adminId, String lang) {
        StringBuilder html = new StringBuilder();
        html.append("<div class=\"back-controls\">")
            .append("<a href=\"#admin/detail/").append(adminId).append("\" class=\"btn btn-secondary\">").append(i18nUtil.t("back_to_detail", lang)).append("</a>")
            .append("</div>")
            .append("<div class=\"table-container detail-view\">")
            .append("<h3>").append(i18nUtil.t("change_password", lang)).append("</h3>")
            .append("<form id=\"change-password-form\" class=\"form-group\" onsubmit=\"handleAdminChangePassword(event, '").append(adminId).append("'); return false;\">")
            .append("<table class=\"table table-borderless\">")
            .append("<tr><td>").append(i18nUtil.t("new_password", lang)).append("</td><td><input type=\"password\" name=\"password\" required autocomplete=\"new-password\"></td></tr>")
            .append("<tr><td></td><td>")
            .append("<button type=\"submit\" class=\"btn btn-success\">").append(i18nUtil.t("update", lang)).append("</button> ")
            .append("<a href=\"#admin/detail/").append(adminId).append("\" class=\"btn btn-secondary\">").append(i18nUtil.t("cancel", lang)).append("</a>")
            .append("</td></tr>")
            .append("</table></form></div>");
        return html.toString();
    }
}
JAVA;
    }

    /**
     * Generates the UserProfileController class.
     * This controller is responsible for managing the current user's profile. It provides endpoints
     * to display the user's profile information and an edit form. It also handles the POST request
     * to update the user's details in the database. The views are rendered as HTML directly.
     *
     * @return string The Java code for the UserProfileController class.
     */
    private function generateUserProfileController() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.core;

import {$package}.util.I18nUtil;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Locale;
import java.util.Map;
import org.springframework.web.util.HtmlUtils;

@RestController
public class UserProfileController {

    @Autowired
    private NamedParameterJdbcTemplate jdbcTemplate;

    @Autowired
    private I18nUtil i18nUtil;

    /**
     * Handles GET requests to display the user's profile information as an HTML view.
     * This corresponds to the main profile view.
     *
     * @param request The incoming HttpServletRequest, used to get the session.
     * @return A ResponseEntity containing the HTML string for the view or an error.
     */
    @GetMapping(value = "/user-profile", produces = MediaType.TEXT_HTML_VALUE)
    public ResponseEntity<String> getUserProfileView(HttpServletRequest request, @RequestHeader(value = "X-Language-Id", required = false) String lang) {
        return generateProfileView(request, false, lang);
    }

    /**
     * Handles GET requests to display the user profile update form as an HTML view.
     * This corresponds to the edit profile page.
     *
     * @param request The incoming HttpServletRequest, used to get the session.
     * @return A ResponseEntity containing the HTML string for the form or an error.
     */
    @GetMapping(value = "/user-profile-update", produces = MediaType.TEXT_HTML_VALUE)
    public ResponseEntity<String> getUserProfileUpdateView(HttpServletRequest request, @RequestHeader(value = "X-Language-Id", required = false) String lang) {
        return generateProfileView(request, true, lang);
    }

    private ResponseEntity<String> generateProfileView(HttpServletRequest request, boolean isUpdateForm, String lang) {
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("username") == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("User not authenticated");
        }
        String username = (String) session.getAttribute("username");
        Locale locale = request.getLocale();

        String sql = "SELECT admin.*, (SELECT admin_level.name FROM admin_level WHERE admin_level.admin_level_id = admin.admin_level_id) AS admin_level_name FROM admin WHERE admin.username = :username";
        MapSqlParameterSource params = new MapSqlParameterSource("username", username);

        try {
            Map<String, Object> admin = jdbcTemplate.queryForMap(sql, params);
            String htmlContent = isUpdateForm ? buildUpdateFormHtml(admin, lang) : buildDetailViewHtml(admin, lang);
            return ResponseEntity.ok(htmlContent);
        } catch (Exception e) {
            // Log the exception
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(e.getMessage());
        }
    }

    private String buildDetailViewHtml(Map<String, Object> admin, String lang) {
        StringBuilder html = new StringBuilder();
        html.append("<div class=\"table-container detail-view\">")
            .append("<form action=\"\" class=\"form-group\">")
            .append("<table class=\"table table-borderless\">");

        // Helper lambda to append rows
        appendRow(html, i18nUtil.t("admin_id", lang), get(admin, "admin_id"));
        appendRow(html, i18nUtil.t("name", lang), get(admin, "name"));
        appendRow(html, i18nUtil.t("username", lang), get(admin, "username"));
        appendRow(html, i18nUtil.t("gender", lang), "M".equals(get(admin, "gender")) ? i18nUtil.t("male", lang) : i18nUtil.t("female", lang));
        appendRow(html, i18nUtil.t("birthday", lang), get(admin, "birth_day"));
        appendRow(html, i18nUtil.t("phone", lang), get(admin, "phone"));
        appendRow(html, i18nUtil.t("email", lang), get(admin, "email"));
        appendRow(html, i18nUtil.t("admin_level_id", lang), get(admin, "admin_level_name"));
        appendRow(html, i18nUtil.t("language_id", lang), get(admin, "language_id"));
        appendRow(html, i18nUtil.t("last_reset_password", lang), get(admin, "last_reset_password"));
        appendRow(html, i18nUtil.t("blocked", lang), (Boolean) admin.getOrDefault("blocked", false) ? i18nUtil.t("yes", lang) : i18nUtil.t("no", lang));
        appendRow(html, i18nUtil.t("active", lang), (Boolean) admin.getOrDefault("active", false) ? i18nUtil.t("yes", lang) : i18nUtil.t("no", lang));

        html.append("<tr><td></td><td>")
            .append("<button type=\"button\" class=\"btn btn-primary\" onclick=\"window.location='#user-profile-update'\">").append(i18nUtil.t("edit", lang)).append("</button> ")
            .append("<button type=\"button\" class=\"btn btn-warning\" onclick=\"window.location='#update-password'\">").append(i18nUtil.t("update_password", lang)).append("</button>")
            .append("</td></tr>");

        html.append("</table></form></div>");
        return html.toString();
    }

    private String buildUpdateFormHtml(Map<String, Object> admin, String lang) {
        StringBuilder html = new StringBuilder();
        html.append("<div class=\"table-container detail-view\">")
            .append("<form id=\"profile-update-form\" class=\"form-group\" onsubmit=\"handleProfileUpdate(event); return false;\">")
            .append("<table class=\"table table-borderless\">");

        appendInputRow(html, i18nUtil.t("admin_id", lang), "admin_id", get(admin, "admin_id"), true);
        appendInputRow(html, i18nUtil.t("name", lang), "name", get(admin, "name"), false);
        appendInputRow(html, i18nUtil.t("username", lang), "username", get(admin, "username"), true);

        // Gender select
        String gender = get(admin, "gender");
        html.append("<tr><td>").append(i18nUtil.t("gender", lang)).append("</td><td>")
            .append("<select name=\"gender\" class=\"form-control\">")
            .append("<option value=\"M\" ").append("M".equals(gender) ? "selected" : "").append(">").append(i18nUtil.t("male", lang)).append("</option>")
            .append("<option value=\"F\" ").append("F".equals(gender) ? "selected" : "").append(">").append(i18nUtil.t("female", lang)).append("</option>")
            .append("</select></td></tr>");

        appendInputRow(html, i18nUtil.t("birthday", lang), "birth_day", get(admin, "birth_day"), false, "date");
        appendInputRow(html, i18nUtil.t("phone", lang), "phone", get(admin, "phone"), false);
        appendInputRow(html, i18nUtil.t("email", lang), "email", get(admin, "email"), false, "email");

        // Buttons
        html.append("<tr><td></td><td>")
            .append("<button type=\"submit\" class=\"btn btn-success\">").append(i18nUtil.t("update", lang)).append("</button> ")
            .append("<button type=\"button\" class=\"btn btn-secondary\" onclick=\"window.location='#user-profile'\">").append(i18nUtil.t("cancel", lang)).append("</button>")
            .append("</td></tr>");

        html.append("</table></form></div>");
        return html.toString();
    }

    // --- Helper Methods ---

    private String get(Map<String, Object> map, String key) {
        Object value = map.get(key);
        return value != null ? HtmlUtils.htmlEscape(value.toString()) : "";
    }

    private void appendRow(StringBuilder sb, String label, String value) {
        sb.append("<tr><td>").append(label).append("</td><td>").append(value).append("</td></tr>");
    }

    private void appendInputRow(StringBuilder sb, String label, String name, String value, boolean readonly) {
        appendInputRow(sb, label, name, value, readonly, "text");
    }

    private void appendInputRow(StringBuilder sb, String label, String name, String value, boolean readonly, String type) {
        sb.append("<tr><td>").append(label).append("</td><td>")
            .append("<input type=\"").append(type).append("\" name=\"").append(name)
            .append("\" class=\"form-control\" value=\"").append(value)
            .append("\" autocomplete=\"off\" ").append(readonly ? "readonly" : "")
            .append("></td></tr>");
    }

    /**
     * Handles POST requests to update the user's profile.
     * It reads the updated profile data from the request body and updates the database.
     *
     * @param request The incoming HttpServletRequest, used to get the session and locale.
     * @return A ResponseEntity indicating success or failure.
     */
    @PostMapping("/user-profile")
    public ResponseEntity<Map<String, Object>> updateUserProfile(
            HttpServletRequest request,
            @RequestHeader(value = "X-Language-Id", required = false) String lang,
            @RequestParam("name") String name,
            @RequestParam("email") String email,
            @RequestParam("gender") String gender,
            @RequestParam("birth_day") String birthDay,
            @RequestParam("phone") String phone) {
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("username") == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of("success", false, "message", "User not authenticated"));
        }
        String username = (String) session.getAttribute("username");
        try {
            String sql = "UPDATE admin SET name = :name, email = :email, gender = :gender, birth_day = :birth_day, phone = :phone WHERE username = :username";

            MapSqlParameterSource params = new MapSqlParameterSource();
            params.addValue("name", name);
            params.addValue("email", email);
            params.addValue("gender", gender);
            params.addValue("birth_day", birthDay);
            params.addValue("phone", phone);
            params.addValue("username", username); // Use session username for security

            jdbcTemplate.update(sql, params);

            String successMessage = i18nUtil.t("profile_updated_successfully", lang);
            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", successMessage);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            // Log the exception
            String errorMessage = i18nUtil.t("failed_to_update_profile", lang, new Object[]{e.getMessage()});
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", errorMessage);

            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }
}
JAVA;
    }

    /**
     * Generates the UserProfileController class.
     * This controller is responsible for managing the current user's profile. It provides endpoints
     * to display the user's profile information and an edit form. It also handles the POST request
     * to update the user's details in the database. The views are rendered as HTML directly.
     *
     * @return string The Java code for the UserProfileController class.
     */
    private function generateUpdatePasswordController() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.core;

import $package.config.Sha1PasswordEncoder;
import $package.model.entity.core.Admin;
import $package.model.repository.core.AdminRepository;
import $package.util.I18nUtil;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.web.bind.annotation.*;

import java.util.Map;
import java.util.Optional;

@RestController
public class UpdatePasswordController {

    @Autowired
    private NamedParameterJdbcTemplate jdbcTemplate;

    @Autowired
    private AdminRepository adminRepository;

    @Autowired
    private Sha1PasswordEncoder passwordEncoder;

    @Autowired
    private I18nUtil i18nUtil;

    /**
     * Handles GET requests to display the update password form.
     * @param request The incoming HttpServletRequest to get the locale.
     * @return A ResponseEntity containing the HTML string for the form.
     */
    @GetMapping(value = "/update-password", produces = MediaType.TEXT_HTML_VALUE)
    public ResponseEntity<String> getUpdatePasswordView(HttpServletRequest request, @RequestHeader(value = "X-Language-Id", required = false) String lang) {
        String html = buildUpdatePasswordFormHtml(lang);
        return ResponseEntity.ok(html);
    }

    private String buildUpdatePasswordFormHtml(String lang) {
        return "<div class=\"table-container detail-view\">" +
                "<form id=\"password-update-form\" class=\"form-group\" onsubmit=\"handlePasswordUpdate(event); return false;\">" +
                "<table class=\"table table-borderless\">" +
                "<tr><td>" + i18nUtil.t("current_password", lang) + "</td>" +
                "<td><input type=\"password\" name=\"current_password\" class=\"form-control\" required autocomplete=\"current-password\"></td></tr>" +
                "<tr><td>" + i18nUtil.t("new_password", lang) + "</td>" +
                "<td><input type=\"password\" name=\"new_password\" class=\"form-control\" required autocomplete=\"new-password\"></td></tr>" +
                "<tr><td>" + i18nUtil.t("confirm_password", lang) + "</td>" +
                "<td><input type=\"password\" name=\"confirm_password\" class=\"form-control\" required autocomplete=\"new-password\"></td></tr>" +
                "<tr><td></td><td>" +
                "<button type=\"submit\" class=\"btn btn-success\">" + i18nUtil.t("update", lang) + "</button> " +
                "<button type=\"button\" class=\"btn btn-secondary\" onclick=\"window.location='#user-profile'\">" + i18nUtil.t("cancel", lang) + "</button>" +
                "</td></tr>" +
                "</table></form></div>";
    }

    /**
     * Handles POST requests to update the user's password.
     * @param request The incoming HttpServletRequest to get session and locale.
     * @param currentPassword The user's current password.
     * @param newPassword The new password.
     * @param confirmPassword The confirmation of the new password.
     * @return A ResponseEntity indicating success or failure.
     */
    @PostMapping("/update-password")
    public ResponseEntity<Map<String, Object>> updatePassword(
            HttpServletRequest request,
            @RequestHeader(value = "X-Language-Id", required = false) String lang,
            @RequestParam("current_password") String currentPassword,
            @RequestParam("new_password") String newPassword,
            @RequestParam("confirm_password") String confirmPassword) {

        HttpSession session = request.getSession(false);

        if (session == null || session.getAttribute("username") == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of("success", false, "message", "User not authenticated"));
        }
        String username = (String) session.getAttribute("username");

        if (!newPassword.equals(confirmPassword)) {
            return ResponseEntity.badRequest().body(Map.of("success", false, "message", i18nUtil.t("password_mismatch", lang)));
        }

        Optional<Admin> adminOptional = adminRepository.findByUsername(username);
        if (adminOptional.isEmpty()) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(Map.of("success", false, "message", "User not found"));
        }

        Admin admin = adminOptional.get();
        if (!passwordEncoder.matches(currentPassword, admin.getPassword())) { //NOSONAR
            return ResponseEntity.badRequest().body(Map.of("success", false, "message", i18nUtil.t("incorrect_current_password", lang)));
        }

        try {
            String newHashedPassword = passwordEncoder.encode(newPassword);
            String sql = "UPDATE admin SET password = :password WHERE username = :username";
            MapSqlParameterSource params = new MapSqlParameterSource();
            params.addValue("password", newHashedPassword);
            params.addValue("username", username);
            jdbcTemplate.update(sql, params);

            return ResponseEntity.ok(Map.of("success", true, "message", i18nUtil.t("password_updated_successfully", lang)));
        } catch (Exception e) {
            // Log the exception
            String errorMessage = i18nUtil.t("failed_to_update_password", lang, new Object[]{e.getMessage()});
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of("success", false, "message", errorMessage));
        }
    }
}
JAVA;
    }

    /**
     * Generates the StaticAssetController class.
     * This controller serves static assets like CSS, JavaScript, and images from the classpath.
     *
     * @return string The Java code for the StaticAssetController class.
     */
    private function generateStaticAssetController() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.core;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.ServletContext;
import org.springframework.core.io.ClassPathResource;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.HandlerMapping;

import java.io.IOException;
import java.nio.file.Files;

@RestController
public class StaticAssetController {

    private final ServletContext servletContext;

    public StaticAssetController(ServletContext servletContext) {
        this.servletContext = servletContext;
    }

    /**
     * Handles requests for static assets under /assets/**, /langs/**, etc.
     * It reads the requested file from the classpath's /static directory.
     *
     * @param request The incoming HTTP request.
     * @return A ResponseEntity containing the file's content or a 404 error.
     */
    @GetMapping({"/assets/**", "/langs/**"})
    public ResponseEntity<byte[]> getStaticAsset(HttpServletRequest request) {
        // Extract the path from the request URL (e.g., "assets/themes/style.css")
        String path = (String) request.getAttribute(HandlerMapping.PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE);

        // Construct the resource path within the classpath
        Resource resource = new ClassPathResource("static/" + path);

        if (resource.exists() && resource.isReadable()) {
            try {
                String mimeType = servletContext.getMimeType(resource.getFilename());
                MediaType mediaType = MediaType.parseMediaType(mimeType != null ? mimeType : MediaType.APPLICATION_OCTET_STREAM_VALUE);

                byte[] content = Files.readAllBytes(resource.getFile().toPath());

                return ResponseEntity.ok().contentType(mediaType).body(content);
            } catch (IOException e) {
                // Log the exception
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
            }
        } else {
            // If the file is not found, return a 404 error
            return ResponseEntity.status(HttpStatus.NOT_FOUND).build();
        }
    }
}
JAVA;
    }

    /**
     * Generates the ProfileUpdateRequest DTO class.
     *
     * @return string The Java code for ProfileUpdateRequest.java.
     */
    private function generateProfileUpdateRequestDto() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.controller.dto;

import lombok.Data;

@Data
public class ProfileUpdateRequest {
    private String name;
    private String email;
    private String gender;
    private String birthDay;
    private String phone;
}
JAVA;
    }

    /**
     * Generates the GraphQL schema parts for a given table.
     *
     * @param string $tableName The name of the table.
     * @param array $tableInfo The table information including columns and primary key.
     * @return array An array containing 'types', 'queries', and 'mutations' strings.
     */
    private function getSchemaPartsForTable($tableName, $tableInfo) {
        $camelName = $this->camelCase($tableName);
        $ucCamelName = ucfirst($camelName);
        $pluralCamelName = $this->pluralize($camelName);
        $backendHandledColumnNames = $this->getBackendHandledColumnNames();
        // Type fields
        $fields = "";
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            $gqlType = $this->mapJavaTypeToGqlType($this->mapDbTypeToJavaType($colInfo['type'], $colInfo['length']));
            $fieldName = $colName; // Use original snake_case name
            if ($colInfo['isForeignKey']) {
                $refUcCamelName = ucfirst($this->camelCase($colInfo['references']));
                $fields .= "    $fieldName: $gqlType\n"; // Keep the ID field
                $fields .= "    {$colInfo['references']}: $refUcCamelName\n"; // Use original table name for relation
            } else {
                $fields .= "    $fieldName: $gqlType\n";
            }
        }

        // Input fields
        $inputFields = "";
        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            if(in_array($colName, $backendHandledColumnNames))
            {
                continue;
            }
            if ($colName === $tableInfo['primaryKey'] && ($colInfo['isAutoIncrement'] || $colInfo['primaryKeyValue'] == 'autogenerated')) {
                continue;
            }
            $gqlType = $this->mapJavaTypeToGqlType($this->mapDbTypeToJavaType($colInfo['type'], $colInfo['length']));
            $fieldName = $colName; // Use original snake_case name
            $inputFields .= "    $fieldName: $gqlType\n";
        }

        $types = <<<GQL
type $ucCamelName {
$fields}

input {$ucCamelName}Input {
$inputFields}

type {$ucCamelName}Page {
    items: [$ucCamelName],
    total: Int,
    limit: Int,
    page: Int,
    totalPages: Int,
    hasNext: Boolean,
    hasPrevious: Boolean
}
GQL;
        $pkType = $this->mapJavaTypeToGqlType($this->mapDbTypeToJavaType($tableInfo['columns'][$tableInfo['primaryKey']]['type'], $tableInfo['columns'][$tableInfo['primaryKey']]['length']));

        $queries = "    {$camelName}(id: {$pkType}!): $ucCamelName\n";
        $queries .= "    {$pluralCamelName}(limit: Int, offset: Int, page: Int, size: Int, orderBy: [SortInput], filter: [FilterInput]): {$ucCamelName}Page\n";

        $mutations = "    create{$ucCamelName}(input: {$ucCamelName}Input!): $ucCamelName\n";
        $mutations .= "    update{$ucCamelName}(id: {$pkType}!, input: {$ucCamelName}Input!): $ucCamelName\n";
        $mutations .= "    delete{$ucCamelName}(id: {$pkType}!): Boolean\n";
        
        if ($tableInfo['hasActiveColumn']) {
            $activeField = $this->camelCase($this->activeField);
            $mutations .= "    toggle{$ucCamelName}Active(id: {$pkType}!, $activeField: Boolean!): $ucCamelName\n";
        }

        return [
            'types' => $types,
            'queries' => $queries,
            'mutations' => $mutations
        ];
    }

    /**
     * Generates the mapping code from a DTO to an Entity.
     *
     * @param string $tableName The name of the table.
     * @param array $tableInfo The table information.
     * @param string $entityVar The variable name of the entity.
     * @param string $dtoVar The variable name of the DTO.
     * @param string $action The action type (e.g., 'create' or 'update').
     * @return string The generated mapping code.
     */
    private function generateDtoToEntityMapping($tableName, $tableInfo, $entityVar, $dtoVar, $action) {
        $mappingCode = "";

        $mappingCode .= "        {$this->upperCamelCase($tableName)}Input {$dtoVar} = ValueUtil.convertSnakeCaseToDto(input, {$this->upperCamelCase($tableName)}Input.class);\n";


        $backendHandledColumnNames = $this->getBackendHandledColumnNames();
        $skippedColumns = array();
        $inputColumns = array();
        

        foreach ($tableInfo['columns'] as $colName => $colInfo) {
            
            if ($colName === $tableInfo['primaryKey'] && ($colInfo['isAutoIncrement'] || $colInfo['primaryKeyValue'] == 'autogenerated' || $action == 'update')) {
                continue;
            }
            if ($colName === $tableInfo['primaryKey'] && $action == 'create')
            {
                $camelCasePk = $this->camelCase($colName);
                $upperCamelCasePk = ucfirst($camelCasePk);
                $mappingCode .= "        // Validate  primary key\n";
                $mappingCode .= "        if(!ValueUtil.valuable(dtoInput.get{$upperCamelCasePk}()))\n";
                $mappingCode .= "        {\n";
                $mappingCode .= "            throw new RuntimeException(\"Invalid input: $camelCasePk is required\");\n";
                $mappingCode .= "        }\n";
            }
            $inputColumns[] = $colName;
            if(in_array($colName, $backendHandledColumnNames)) {
                $skippedColumns[] = $colName;
                continue;
            }
            
            $camelColName = $this->camelCase($colName);
            $ucCamelColName = ucfirst($camelColName);
            $mappingCode .= "        {$entityVar}.set{$ucCamelColName}({$dtoVar}.get{$ucCamelColName}());\n";
            
        }
        foreach($this->backendHandledColumns as $key=>$col)
        {
            $colName = $col['columnName'];
            if(in_array($colName, $inputColumns) || in_array($colName, $skippedColumns))
            {
                if($key == 'adminCreate' || $key == 'adminEdit')
                {
                    $mappingCode .= "        String appCurrentUserId = AuditTrailUtil.getUserId();\n";
                    break;
                }
            }
        }
        foreach($this->backendHandledColumns as $key=>$col)
        {
            $colName = $col['columnName'];
            if(in_array($colName, $inputColumns) || in_array($colName, $skippedColumns))
            {
                if($key == 'ipCreate' || $key == 'ipEdit')
                {
                    $mappingCode .= "        String appCurrentUserIp = AuditTrailUtil.getUserIp();\n";
                    break;
                }
            }
        }
        foreach($this->backendHandledColumns as $key=>$col)
        {
            
            $colName = $col['columnName'];
            if(in_array($colName, $inputColumns) || in_array($colName, $skippedColumns))
            {
                if($action == 'create')
                {
                    if($key == 'timeCreate')
                    {
                        $mappingCode .= "        {$entityVar}.set".ucfirst($this->camelCase($colName))."(java.time.LocalDateTime.now());\n";
                    }
                    if($key == 'adminCreate')
                    {
                        $mappingCode .= "        {$entityVar}.set".ucfirst($this->camelCase($colName))."(appCurrentUserId);\n";
                    }
                    if($key == 'ipCreate')
                    {
                        $mappingCode .= "        {$entityVar}.set".ucfirst($this->camelCase($colName))."(appCurrentUserIp);\n";
                    }
                }
                if($key == 'timeEdit')
                {
                    $mappingCode .= "        {$entityVar}.set".ucfirst($this->camelCase($colName))."(java.time.LocalDateTime.now());\n";
                }
                if($key == 'adminEdit')
                {
                    $mappingCode .= "        {$entityVar}.set".ucfirst($this->camelCase($colName))."(appCurrentUserId);\n";
                }
                if($key == 'ipEdit')
                {
                    $mappingCode .= "        {$entityVar}.set".ucfirst($this->camelCase($colName))."(appCurrentUserIp);\n";
                }

            }
        }

        return $mappingCode;
    }


    /**
     * Combines all schema parts into a single GraphQL schema string.
     *
     * @param array $allSchemaParts Array of type definitions.
     * @param array $allQueryFields Array of query definitions.
     * @param array $allMutationFields Array of mutation definitions.
     * @return string The complete GraphQL schema.
     */
    private function generateCombinedSchema($allSchemaParts, $allQueryFields, $allMutationFields) {
        $typesString = implode("\n", $allSchemaParts);
        $queriesString = implode("", $allQueryFields);
        $mutationsString = implode("", $allMutationFields);

        return <<<GQL
enum SortDirection {
    ASC
    DESC
}

enum FilterOperator {
    EQUALS
    NOT_EQUALS
    CONTAINS
    GREATER_THAN
    GREATER_THAN_OR_EQUALS
    LESS_THAN
    LESS_THAN_OR_EQUALS
    IN
    NOT_IN
}

input SortInput {
    field: String!
    direction: SortDirection
}

input FilterInput {
    field: String!
    value: Object
    operator: FilterOperator
}

$typesString

type Query {
$queriesString}

scalar Object

type Mutation {
$mutationsString}
GQL;
    }

    /**
     * Generates the FilterInput DTO class.
     * @return string The Java code for FilterInput.java.
     */
    private function generateFilterInputDto() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.model.dto;

import lombok.Data;

@Data
public class FilterInput {
    private String field;
    private Object value;
    private String operator;
}
JAVA;
    }

    /**
     * Generates the SortInput DTO class.
     * @return string The Java code for SortInput.java.
     */
    private function generateSortInputDto() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.model.dto;

import lombok.Data;

@Data
public class SortInput {
    private String field;
private String direction;

    public String getDirection() {
        return (direction == null || direction.isEmpty()) ? "ASC" : direction;
    }
}
JAVA;
    }

    /**
     * Generates the ObjectScalar class for GraphQL custom scalar type.
     *
     * @return string The Java code for ObjectScalar.java.
     */
    private function generateObjectScalar() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.config;

import graphql.language.ArrayValue;
import graphql.language.BooleanValue;
import graphql.language.FloatValue;
import graphql.language.IntValue;
import graphql.language.ObjectField;
import graphql.language.ObjectValue;
import graphql.language.StringValue;
import graphql.language.Value;
import graphql.schema.Coercing;
import graphql.schema.CoercingParseLiteralException;
import graphql.schema.CoercingParseValueException;
import graphql.schema.CoercingSerializeException;
import graphql.schema.GraphQLScalarType;
import java.util.stream.Collectors;

public class ObjectScalar implements Coercing<Object, Object> {

    public static final GraphQLScalarType INSTANCE = GraphQLScalarType.newScalar()
            .name("Object")
            .description("A custom scalar that can represent any JSON-like object.")
            .coercing(new ObjectScalar())
            .build();

    @Override
    public Object serialize(Object dataFetcherResult) throws CoercingSerializeException {
        return dataFetcherResult;
    }

    @Override
    public Object parseValue(Object input) throws CoercingParseValueException {
        return input;
    }

    @Override
    public Object parseLiteral(Object input) throws CoercingParseLiteralException {
        if (input instanceof StringValue) {
            return ((StringValue) input).getValue();
        } else if (input instanceof IntValue) {
            return ((IntValue) input).getValue();
        } else if (input instanceof FloatValue) {
            return ((FloatValue) input).getValue();
        } else if (input instanceof BooleanValue) {
            return ((BooleanValue) input).isValue();
        } else if (input instanceof ArrayValue) {
            return ((ArrayValue) input).getValues().stream().map(this::parseLiteral).collect(Collectors.toList());
        } else if (input instanceof ObjectValue) {
            return ((ObjectValue) input).getObjectFields().stream()
                    .collect(Collectors.toMap(ObjectField::getName, field -> parseLiteral(field.getValue())));
        }
        return null;
    }
}
JAVA;
    }

    /**
     * Generates the GraphQlConfig class for GraphQL configuration.
     *
     * @return string The Java code for GraphQlConfig.java.
     */
    private function generateGraphQlConfig() {
        $package = $this->projectConfig['packageName'];
        return <<<JAVA
package $package.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.graphql.execution.RuntimeWiringConfigurer;

@Configuration
public class GraphQlConfig {

    @Bean
    public RuntimeWiringConfigurer runtimeWiringConfigurer() {
        return wiringBuilder -> wiringBuilder.scalar(ObjectScalar.INSTANCE);
    }
}
JAVA;
    }

    /**
     * Get whether to enable verbose logging in the generated application.
     *
     * @return bool True if verbose logging is enabled, false otherwise.
     */ 
    public function getVerboseLogging()
    {
        return $this->verboseLogging;
    }

    /**
     * Generates the toggleActive mutation method if the table has an active column.
     *
     * @param string $tableName The name of the table.
     * @param array $tableInfo The table information.
     * @return string The generated Java method code, or an empty string.
     */
    private function generateToggleActiveMutation($tableName, $tableInfo)
    {
        if (!$tableInfo['hasActiveColumn']) {
            return "";
        }

        $camelName = $this->camelCase($tableName);
        $ucCamelName = ucfirst($camelName);
        $activeField = $this->activeField;
        $ucActiveField = ucfirst($this->camelCase($activeField));
        $pkJavaType = 'String'; // Default
        $inputColumns = array();
        foreach ($tableInfo['columns'] as $columnName=>$col) {
            $inputColumns[] = $columnName;
        }
        foreach ($tableInfo['columns'] as $col) {
            if ($col['isPrimaryKey']) {
                $pkJavaType = $this->mapDbTypeToJavaType($col['type'], $col['length']);
                break;
            }
        }

        $mappingCode = "";
        foreach($this->backendHandledColumns as $key=>$col)
        {
            $colName = $col['columnName'];
            if(in_array($colName, $inputColumns))
            {
                if($key == 'timeEdit')
                {
                    $mappingCode .= "        {$camelName}.set".ucfirst($this->camelCase($colName))."(java.time.LocalDateTime.now());\n";
                }
                if($key == 'adminEdit')
                {
                    $mappingCode .= "        {$camelName}.set".ucfirst($this->camelCase($colName))."(AuditTrailUtil.getUserId());\n";
                }
                if($key == 'ipEdit')
                {
                    $mappingCode .= "        {$camelName}.set".ucfirst($this->camelCase($colName))."(AuditTrailUtil.getUserIp());\n";
                }

            }
        }

        return <<<JAVA
    @MutationMapping
    @Transactional
    public $ucCamelName toggle{$ucCamelName}Active(@Argument $pkJavaType id, @Argument(name = "$activeField") boolean $activeField) {
        $ucCamelName $camelName = {$camelName}Repository.findById(id)
                .orElseThrow(() -> new RuntimeException("{$ucCamelName} not found with id " + id));
        $camelName.set$ucActiveField($activeField);\n{$mappingCode}        return {$camelName}Repository.save($camelName);
    }
JAVA;
    }
}
