const state={databaseTarget:{driver:"",host:"",port:"",username:"",password:"",databaseFilePath:"",databaseName:"",databseSchema:"",timeZone:""},databaseSource:{driver:"",host:"",port:"",username:"",password:"",databaseFilePath:"",databaseName:"",databseSchema:"",timeZone:""},maximumRecord:100,table:[]};function enableSmoothScroll(t){let e=0,a;t.addEventListener("wheel",r=>{r.preventDefault(),e+=r.deltaY,cancelAnimationFrame(a);let o=t.scrollTop,n=e,s=performance.now();function l(e){var r;let i=Math.min(1,(e-s)/400);t.scrollTop=o+(n-o)*(r=i,1-Math.pow(1-r,3)),i<1&&(a=requestAnimationFrame(l))}requestAnimationFrame(l)},{passive:!1})}function customAlert(t,e,a={}){let r=(dialogTemplate[e]||e).replace(/\{(\w+)\}/g,(t,e)=>a[e]??""),o=dialogTemplate[t]||t;$("#commonModal .modal-title").text(o),$("#commonModal .modal-body").text(r),$("#commonModal").modal("show")}function deepSet(t,e,a){let r=e.split("."),o=t;for(let n=0;n<r.length-1;n++){let s=r[n];s in o||(o[s]={}),o=o[s]}o[r[r.length-1]]="number"==typeof o[r[r.length-1]]?Number(a):a}function download(t,e){let a=document.createElement("a");a.href=URL.createObjectURL(new Blob([e],{type:"text/plain"})),a.download=t,a.click(),URL.revokeObjectURL(a.href)}function toYAML(t,e=0){let a=" \xa0".repeat(e);if(null===t)return"null";if(Array.isArray(t))return 0===t.length?"[]":t.map(t=>a+"- "+formatYAMLValue(t,e+1)).join("\n").replaceAll("\n"+a+" \xa0-","\n"+a+"-");if("object"==typeof t){let r=Object.keys(t);return 0===r.length?"{}":r.map(r=>{let o=t[r],n=escapeKey(r);return isScalar(o)?a+n+": "+scalarToYAML(o):a+n+":\n"+toYAML(o,e+1)}).join("\n")}return scalarToYAML(t)}function formatYAMLValue(t,e){return isScalar(t)?scalarToYAML(t):Array.isArray(t)&&t.every(isScalar)?t.map((t,a)=>(0===a?"":"\n"+" \xa0".repeat(e))+"- "+scalarToYAML(t)).join(""):"\n"+toYAML(t,e)}function isScalar(t){return null==t||["string","number","boolean"].includes(typeof t)}function needsQuote(t){return""===t||/[:#\-?&*!|>'"%@`{}\[\],\n\r\t]/.test(t)||/^\s|\s$/.test(t)||/^(true|false|null|~|yes|no|on|off)$/i.test(t)}function scalarToYAML(t){if(null==t)return"null";if("boolean"==typeof t)return t?"true":"false";if("number"==typeof t)return String(t);let e=String(t);return needsQuote(e)?JSON.stringify(e):e}function escapeKey(t){return needsQuote(t)?JSON.stringify(t):t}function refreshPreviews(){let t=JSON.stringify(state,null,2);$("#previewJson").text(t),$("#previewYaml").text(toYAML(state))}function addTableRow(t={target:"",source:"",map:[],preImportScript:[],postImportScript:[]},e=!1){let a=$($("#tplTableItem").html().trim()),r=a.find(".in-target");r.val(t.target||"");let o=a.find(".in-source");o.val(t.source||"");let n=a.find("details"),s=a.find(".btn-toggle");s.on("click",()=>{n.prop("open",!n.prop("open")),s.text(n.prop("open")?"Detail ▾":"Detail ▸")});let l=a.find(".map-list");function i(t,e=!1){let a=$($("#tplMapRow").html().trim()),r=a.find(".in-target-col"),o=a.find(".in-source-col");r.val(t?.target||""),o.val(t?.source||""),a.find(".btn-del-map").on("click",()=>{a.remove(),syncFromUI()}),r.on("input",syncFromUI),o.on("input",syncFromUI),l.append(a),e&&r.focus()}a.find(".btn-add-map").on("click",()=>i({},!0)),(t.map||[]).forEach(t=>{if("string"==typeof t&&t.includes(":")){let[e,a]=t.split(":");i({target:e.trim(),source:a.trim()})}else t&&"object"==typeof t&&i(t)});let c=a.find(".pre-script-list");function d(t="",e=!1){let a=$($("#tplScriptRow").html().trim()),r=a.find(".in-script");r.val(t),a.find(".btn-del-script").on("click",()=>{a.remove(),syncFromUI()}),r.on("input",syncFromUI),c.append(a),e&&r.focus()}a.find(".btn-add-pre-import-script").on("click",()=>d("",!0)),(t.preImportScript||[]).forEach(d);let p=a.find(".post-script-list");function m(t="",e=!1){let a=$($("#tplScriptRow").html().trim()),r=a.find(".in-script");r.val(t),a.find(".btn-del-script").on("click",()=>{a.remove(),syncFromUI()}),r.on("input",syncFromUI),p.append(a),e&&r.focus()}return a.find(".btn-add-post-import-script").on("click",()=>m("",!0)),(t.postImportScript||[]).forEach(m),a.find(".btn-del").on("click",()=>{a.remove(),syncFromUI()}),a.find(".btn-up").on("click",()=>{a.prev().length&&($("#tableList").insertBefore(a[0],a.prev()[0]),syncFromUI())}),a.find(".btn-down").on("click",()=>{a.next().length&&($("#tableList").insertBefore(a.next()[0],a[0]),syncFromUI())}),r.on("input",syncFromUI),o.on("input",syncFromUI),a.on("dragstart",t=>{$("body").css("cursor","move"),a.addClass("dragging"),t.originalEvent.dataTransfer.setData("text/plain","")}),a.on("drag",()=>$("body").css("cursor","move")),a.on("dragend",()=>{$("body").css("cursor",""),a.removeClass("dragging"),syncFromUI()}),$("#tableList").append(a),syncFromUI(),e&&r.focus(),a}function getDragAfterElement(t,e){let a=t.find(".table-item:not(.dragging)").toArray();return a.reduce((t,a)=>{let r=a.getBoundingClientRect(),o=e-r.top-r.height/2;return o<0&&o>t.offset?{offset:o,element:a}:t},{offset:Number.NEGATIVE_INFINITY}).element}function syncFromUI(){state.table=$("#tableList .table-item").toArray().map(t=>{let e=$(t),a=e.find(".in-target").val().trim(),r=e.find(".in-source").val().trim(),o=e.find(".map-list .map-row").toArray().map(t=>{let e=$(t),a=e.find(".in-target-col").val().trim(),r=e.find(".in-source-col").val().trim();return a||r?`${a} : ${r}`:null}).filter(Boolean),n=e.find(".pre-script-list .map-row .in-script").toArray().map(t=>$(t).val().trim()).filter(Boolean),s=e.find(".post-script-list .map-row .in-script").toArray().map(t=>$(t).val().trim()).filter(Boolean),l={target:a,source:r};return o.length&&(l.map=o),n.length&&(l.preImportScript=n),s.length&&(l.postImportScript=s),l}),refreshPreviews(),saveDraft()}function loadState(t){["databaseTarget","databaseSource","maximumRecord","table"].forEach(e=>{e in t||console.warn("Missing property:",e)}),Object.assign(state.databaseTarget,t.databaseTarget||{}),Object.assign(state.databaseSource,t.databaseSource||{}),state.maximumRecord=Number(t.maximumRecord)||0,state.table=Array.isArray(t.table)?t.table.map(normalizeEntry):[],$("#configForm input").each((t,e)=>{let a=$(e).data("path"),r=a.split(".").reduce((t,e)=>t&&t[e],state);void 0!==r&&$(e).val(r)}),$("#tableList").empty(),state.table.forEach(addTableRow),refreshPreviews(),saveDraft()}function normalizeEntry(t){let e={target:t.target||"",source:t.source||""};return t.map&&(e.map=t.map.map(t=>"string"==typeof t?t:`${t.target||""} : ${t.source||""}`)),t.preImportScript&&(e.preImportScript=[...t.preImportScript]),t.postImportScript&&(e.postImportScript=[...t.postImportScript]),e}const DRAFT_KEY="mapping-editor-draft-v1";function saveDraft(t){try{let e=JSON.stringify(state);return localStorage.setItem(DRAFT_KEY,e),t&&console.log("draft saved"),e}catch(a){return console.warn("Failed to save draft to local storage:",a),null}}function loadDraft(){try{let t=localStorage.getItem(DRAFT_KEY);return t?JSON.parse(t):null}catch(e){return console.warn("Failed to load draft from local storage:",e),null}}jQuery(function(){$("#configForm input").on("input",function(){deepSet(state,$(this).data("path"),"number"===this.type?Number($(this).val()):$(this).val()),refreshPreviews(),saveDraft()});let t=$("#tableList");if(t.on("dragover",e=>{e.preventDefault();let a=getDragAfterElement(t,e.originalEvent.clientY),r=$(".dragging");r.length&&(null==a?t.append(r):$(a).before(r))}),$("#btnAddTable").on("click",()=>addTableRow({},!0)),$("#btnClearAll").on("click",()=>{t.empty(),state.table=[],refreshPreviews(),saveDraft()}),$("#fileInput").on("change",t=>{$("#selectedFile").length&&$("#selectedFile").text(t.target.files[0].name)}),$("#btnImportJson").on("click",()=>{let t=document.getElementById("fileInput");if(!t.files.length)return customAlert("alert","info_select_file");let e=t.files[0],a=new FileReader;a.onload=function(t){try{let e=t.target.result,a=new Uint8Array(e),r="utf-8";255===a[0]&&254===a[1]?r="utf-16le":254===a[0]&&255===a[1]?r="utf-16be":255===a[0]&&254===a[1]&&0===a[2]&&0===a[3]?r="utf-32le":0===a[0]&&0===a[1]&&254===a[2]&&255===a[3]&&(r="utf-32be");let o=new TextDecoder(r),n=o.decode(a).trim(),s;if(n.startsWith("{"))try{s=JSON.parse(n),loadState(s)}catch(l){customAlert("error","error_parse_json",{msg:l.message});return}else try{s=jsyaml.load(n),loadState(s)}catch(i){customAlert("error","error_parse_yaml",{msg:i.message});return}}catch(c){customAlert("error","error_read_file",{msg:c.message})}},a.onerror=function(){customAlert("error","error_reader",{msg:a.error?.message||a.error?.name})},a.readAsArrayBuffer(e)}),$("#btnDownloadJson").on("click",()=>download("mapping.json",JSON.stringify(state,null,2))),$("#btnDownloadYaml").on("click",()=>download("mapping.yml",toYAML(state))),$("#btnSaveLocal").on("click",()=>{saveDraft(!0),customAlert("information","success_save_local")}),$("#btnLoadLocal").on("click",()=>{let t=loadDraft();t?loadState(t):customAlert("information","error_no_draft")}),$("#selectedFile").length){let e=document.getElementById("fileInput");e.files.length&&$("#selectedFile").text(e.files[0].name)}$("#btnAutogenerate").on("click",()=>{let t=$('[data-path="databaseTarget.driver"]').val(),e=$('[data-path="databaseTarget.host"]').val(),a=$('[data-path="databaseTarget.port"]').val(),r=$('[data-path="databaseTarget.username"]').val(),o=$('[data-path="databaseTarget.password"]').val(),n=$('[data-path="databaseTarget.databaseFilePath"]').val(),s=$('[data-path="databaseTarget.databaseName"]').val(),l=$('[data-path="databaseTarget.databseSchema"]').val(),i=$('[data-path="databaseTarget.timeZone"]').val(),c=$('[data-path="databaseSource.driver"]').val(),d=$('[data-path="databaseSource.host"]').val(),p=$('[data-path="databaseSource.port"]').val(),m=$('[data-path="databaseSource.username"]').val(),u=$('[data-path="databaseSource.password"]').val(),f=$('[data-path="databaseSource.databaseFilePath"]').val(),g=$('[data-path="databaseSource.databaseName"]').val(),b=$('[data-path="databaseSource.databseSchema"]').val(),h=$('[data-path="databaseSource.timeZone"]').val();$.ajax({type:"POST",dataType:"json",data:{targetDriver:t,targetHost:e,targetPort:a,targetUsername:r,targetPassword:o,targetDatabaseFilePath:n,targetDatabaseName:s,targetDatabaseSchema:l,targetTimeZone:i,sourceDriver:c,sourceHost:d,sourcePort:p,sourceUsername:m,sourcePassword:u,sourceDatabaseFilePath:f,sourceDatabaseName:g,sourceDatabaseSchema:b,sourceTimeZone:h},url:"../lib.ajax/database-migration-autogenerate.php",success:function(t){t.success?(loadState(t.data),customAlert("information","success_message")):customAlert("error","error_message",{msg:t.message})},error:function(t,e,a){customAlert("error","error_message",{msg:a})}})});let a=loadDraft();a?loadState(a):loadState(sampleData())});