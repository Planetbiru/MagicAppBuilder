class GraphQLClientApp{constructor(t={}){this.configUrl="frontend-config.php",this.apiUrl="graphql.php",this.loginUrl="login.php",this.logoutUrl="logout.php",this.entityLanguageUrl="entity-language.php",this.i18nUrl="language.php",this.languageConfigUrl="available-language.php",this.customRenderers=t.customRenderers||{},this.defaultActiveField=t.defaultActiveField||"active",this.languageId=null,this.supportedLanguages={},this.defaultLanguage="en",this.uiTranslations={},this.entityLanguagePack={},this.config=null,this.currentEntity=null,this.state={page:1,limit:10,filters:{},orderBy:{}},this.i18n={},this.dom={menu:document.getElementById("entity-menu"),title:document.getElementById("content-title"),body:document.getElementById("content-body"),modal:document.getElementById("form-modal"),modalTitle:document.getElementById("modal-title"),form:document.getElementById("entity-form"),closeModalBtn:document.querySelector(".close-button"),loginModal:document.getElementById("login-modal"),loginForm:document.getElementById("login-form"),loginCloseBtn:document.getElementById("login-close-button"),logoutBtn:document.querySelector(".logout-link"),logoutBtnDropdown:document.getElementById("logout-btn-dropdown"),sidebarToggle:document.getElementById("sidebar-toggle"),sidebar:document.getElementById("sidebar-nav"),mainContent:document.getElementById("main-content"),langMenu:document.getElementById("lang-menu"),filterContainer:document.getElementById("filter-container"),tableDataContainer:document.getElementById("table-data-container"),paginationContainer:document.getElementById("pagination-container"),loadingBar:document.getElementById("loading-bar"),themeToggle:document.getElementById("theme-toggle"),pageWrapper:document.getElementById("page-wrapper"),infoModal:document.getElementById("infoModal"),infoModalTitle:document.getElementById("infoModalTitle"),infoModalMessage:document.getElementById("infoModalMessage"),infoModalOk:document.getElementById("infoModalOk")},this.init()}initPage(){this.dom.sidebarToggle&&this.dom.sidebar&&this.dom.mainContent&&this.dom.sidebarToggle.addEventListener("click",()=>{this.dom.sidebar.classList.toggle("collapsed"),this.dom.mainContent.classList.toggle("expanded")}),document.querySelectorAll("[data-dropdown]").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();let i=t.dataset.dropdown,n=document.getElementById(i);n&&(document.querySelectorAll(".dropdown-menu.active").forEach(t=>{t!==n&&t.classList.remove("active")}),n.classList.toggle("active"))})}),window.addEventListener("click",()=>{document.querySelectorAll(".dropdown-menu.active").forEach(t=>t.classList.remove("active"))}),this.dom.logoutBtnDropdown&&(this.dom.logoutBtnDropdown.onclick=t=>this.handleLogout(t)),this.dom.langMenu.addEventListener("click",t=>{if(t.target.matches("a[data-lang]")){t.preventDefault();let e=t.target.dataset.lang;this.changeLanguage(e)}}),this.dom.themeToggle.addEventListener("click",()=>this.toggleTheme()),window.addEventListener("storage",t=>{"theme"===t.key&&this.applyTheme(t.newValue)});let t=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");this.applyTheme(t)}handleUnauthorized(){"block"!==this.dom.loginModal.style.display&&(this.dom.pageWrapper.style.display="none",document.getElementById("login-error").textContent=this.t("session_expired"),this.openLoginModal())}async init(){this.dom.loginCloseBtn.onclick=()=>this.closeLoginModal(),this.dom.loginForm.onsubmit=t=>this.handleLogin(t),this.dom.logoutBtn.onclick=t=>this.handleLogout(t);try{await this.initializeLanguage(),await this.loadI18n(),await this.loadConfig(),await this.loadLanguage(),this.applyI18n(),this.initPage(),window.onclick=t=>{t.target==this.dom.modal&&this.closeModal()},document.addEventListener("click",t=>{let e=t.target.closest('[data-dismiss="modal"]');if(e){let i=e.closest(".modal");i&&(i.id===this.dom.modal.id?this.closeModal():i.id===this.dom.loginModal.id?this.closeLoginModal():(i.id,this.dom.infoModal.id,i.classList.remove("show")))}}),this.buildMenu(),window.addEventListener("popstate",()=>this.handleRouteChange()),this.handleRouteChange()}catch(t){console.error("Initialization Error:",t),this.dom.body.innerHTML=`<p style="color: red;">Error: ${t.message}</p>`}}_invokeRenderHook(t,e){let i=e.entity.name;return!!this.customRenderers[i]&&"function"==typeof this.customRenderers[i][t]&&(this.customRenderers[i][t](e),!0)}async initializeLanguage(){try{let t=await fetch(this.languageConfigUrl);if(!t.ok)throw Error(`Could not fetch ${this.languageConfigUrl}`);let e=await t.json();this.supportedLanguages=e.supported,this.defaultLanguage=e.default,this.populateLangMenu();let i=localStorage.getItem("userLanguage"),n=this.defaultLanguage;if(i&&this.supportedLanguages[i])n=i;else{let a=navigator.language.split("-")[0];this.supportedLanguages[a]&&(n=a)}this.languageId=n,localStorage.setItem("userLanguage",this.languageId),localStorage.setItem("languageId",this.languageId),document.documentElement.lang=this.languageId}catch(s){console.error("Failed to initialize language configuration, falling back to default:",s),this.supportedLanguages={en:"English"},this.defaultLanguage="en",this.populateLangMenu(),this.languageId=this.defaultLanguage,localStorage.setItem("userLanguage",this.languageId),localStorage.setItem("languageId",this.languageId),document.documentElement.lang=this.languageId}}populateLangMenu(){for(let[t,e]of(this.dom.langMenu.innerHTML="",Object.entries(this.supportedLanguages))){let i=document.createElement("li"),n=document.createElement("a");n.href="#",n.dataset.lang=t,n.textContent=e,i.appendChild(n),this.dom.langMenu.appendChild(i)}}async loadConfig(){let t=await fetch(this.configUrl);if(401===t.status)throw this.handleUnauthorized(),Error("Authentication required.");if(!t.ok)throw Error(`Failed to load config from ${this.configUrl}`);this.config=await t.json(),this.config.pagination&&this.config.pagination.pageSize&&(this.state.limit=this.config.pagination.pageSize)}async loadLanguage(){try{if(this.entityLanguageUrl){let t=`${this.entityLanguageUrl}?lang=${this.languageId}`,e=await fetch(t);if(401===e.status)throw this.handleUnauthorized(),Error("Authentication required.");if(!e.ok)throw Error(`Failed to load language from ${this.entityLanguageUrl}`);let i=await e.json();for(let n in this.entityLanguagePack[this.languageId]={},i.entities)this.entityLanguagePack[this.languageId][n]=i.entities[n].columns}}catch(a){console.warn(`Could not load entity language file for '${this.languageId}'. Falling back to generated labels.`,a)}}async loadI18n(){try{if(this.i18nUrl){let t=`${this.i18nUrl}?lang=${this.languageId}`,e=await fetch(t);if(401===e.status)throw this.handleUnauthorized(),Error("Authentication required.");if(!e.ok)throw Error(`Failed to load i18n from ${this.i18nUrl}`);this.i18n=await e.json()}}catch(i){console.warn("Could not load language file. Falling back to key-based labels.",i),this.i18n={}}}applyI18n(){document.querySelectorAll("[data-i18n]").forEach(t=>{let e=t.getAttribute("data-i18n");"INPUT"===t.tagName||"TEXTAREA"===t.tagName?t.placeholder=this.t(e):t.textContent=this.t(e)}),document.querySelectorAll("[data-i18n-title]").forEach(t=>{let e=t.getAttribute("data-i18n-title");t.title=this.t(e)})}t(t,...e){let i=this.i18n[t];if(i)return e.forEach((t,e)=>{let n=RegExp(`\\{${e}\\}`,"g");i=i.replace(n,t)}),i;let n=this._generateLabelFromKey(t);return[n,...e].join(" ")}changeLanguage(t){localStorage.setItem("userLanguage",t),localStorage.setItem("languageId",t),window.location.reload()}toggleTheme(){let t=document.documentElement.getAttribute("data-theme")||"light",e="dark"===t?"light":"dark";this.applyTheme(e),localStorage.setItem("theme",e)}applyTheme(t){document.documentElement.setAttribute("data-theme",t)}getEntityLabel(t,e){let i=this.snakeCase(t.name);if(!this.entityLanguagePack||!this.entityLanguagePack[this.languageId])return this.snakeCaseToTitleCase(e);{let n=this.entityLanguagePack[this.languageId][t.name];return(n||(n=this.entityLanguagePack[this.languageId][i]),n&&n[e])?n[e]:this.snakeCaseToTitleCase(e)}}getPreferredLanguages(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:["en"]}buildMenu(){this.config&&this.config.entities&&(this.dom.menu.innerHTML="",Object.values(this.config.entities).forEach((t,e)=>{let i=document.createElement("li"),n=document.createElement("a");n.href=`#${t.name}`,n.textContent=t.displayName,n.onclick=e=>{e.preventDefault(),this.navigateTo(t.name,{limit:this.state.limit})},i.appendChild(n),this.dom.menu.appendChild(i)}))}async gqlQuery(t,e={}){this.dom.loadingBar.style.display="block";try{let i=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"xmlhttprequest",Accept:"application/json"},body:JSON.stringify({query:t,variables:e})});if(401===i.status)throw this.handleUnauthorized(),Error("Authentication required.");let n=await i.json();if(n.errors)throw console.error("GraphQL Errors:",n.errors),console.error(`Error: ${n.errors[0].message}`),Error(n.errors[0].message);return n.data}catch(a){throw a}finally{this.dom.loadingBar.style.display="none"}}navigateTo(t,e={}){let i=e.filters||{},n=e.orderBy||{},a=new URLSearchParams;a.set("page",e.page||1),a.set("limit",e.limit||10),Object.entries(i).forEach(([t,e])=>{e&&a.set(t,e)}),n.field&&(a.set("orderBy",n.field),a.set("orderDir",n.direction));let s=`${window.location.pathname}#${t}?${a.toString()}`;history.pushState({entityName:t,params:e},"",s),this.handleRouteChange()}navigateToDetail(t,e){let i=`${window.location.pathname}#${t}/detail/${e}`;history.pushState({entityName:t,id:e},"",i),this.handleRouteChange()}async handleRouteChange(){let t=window.location.hash.substring(1);if(!t||"#"===t){this.renderDashboardView();return}let[e,i]=t.split("?"),n=e.split("/"),a=n[0],s=n.length>1?n[1]:"list",l=n.length>2?n[2]:null,r=new URLSearchParams(i),o=this.config.entities[a];if(!o){this.dom.body.innerHTML=`<p>Entity "${a}" not found.</p>`;return}this.currentEntity=o;let d={};for(let[h,c]of r.entries())"page"!==h&&"limit"!==h&&(d[h]=c);let u={};r.has("orderBy")&&(u.field=r.get("orderBy"),u.direction=r.get("orderDir")||"ASC"),this.state={page:parseInt(r.get("page"))||1,limit:parseInt(r.get("limit"))||10,filters:d,orderBy:u},document.querySelectorAll("#entity-menu a").forEach(t=>t.classList.toggle("active",t.getAttribute("href")===`#${a}`)),"detail"===s&&l?(this.dom.filterContainer.style.display="none",this.clearListView(),await this.renderDetailView(l)):(this.dom.filterContainer.style.display="block",await this.renderListView(),await this.updateTableView())}renderDashboardView(){this.dom.title.textContent=this.t("dashboard"),document.querySelectorAll("#entity-menu a").forEach(t=>t.classList.remove("active")),this.dom.filterContainer.style.display="none",this.clearListView(),this.dom.tableDataContainer.innerHTML=`<p>${this.t("welcome_dashboard")}</p>`}async renderListView(){this.clearListView(),this.dom.title.textContent=this.t("list_of",this.currentEntity.displayName),await this.renderFilters()}async updateTableView(){let t=this.getFieldsForQuery(this.currentEntity,1),e=(this.state.page-1)*this.state.limit,i=[];this.currentEntity.filters&&Object.entries(this.state.filters).forEach(([t,e])=>{let n=this.currentEntity.filters.find(e=>e.name===t);e&&n&&i.push({field:t,value:e,operator:n.operator||"EQUALS"})});let n=[];this.state.orderBy&&this.state.orderBy.field&&n.push(this.state.orderBy);let a=`
query Get${this.currentEntity.pluralName}($limit: Int, $offset: Int, $orderBy: [SortInput], $filter: [FilterInput]) {
${this.currentEntity.pluralName}(limit: $limit, offset: $offset, orderBy: $orderBy, filter: $filter) {
items { ${t} }
total
limit
page
totalPages
hasNext
hasPrevious
}
}
`;try{this.dom.tableDataContainer.innerHTML=this.t("loading"),this.dom.paginationContainer.innerHTML="";let s=await this.gqlQuery(a,{limit:this.state.limit,offset:e,orderBy:n,filter:i}),l=s[this.currentEntity.pluralName];this.renderTable(l.items),this.renderPagination(l)}catch(r){this.dom.tableDataContainer.innerHTML=`<p style="color: red;">${r.message}</p>`}}renderTable(t){let e=Object.keys(this.currentEntity.columns),i=`
<div class="table-container">

<table class="table table-data-list table-striped">
<thead>
<tr>
${e.map(t=>{let e=this.state.orderBy.field===t,i=e?"ASC"===this.state.orderBy.direction?" &#9650;":" &#9660;":"";return`<th class="sortable" data-sort-key="${t}">
${this.getEntityLabel(this.currentEntity,t)}${i}
</th>`}).join("")} 
<th>${this.t("actions")}</th>
</tr>
</thead>
<tbody>
`;0===t.length?i+=`<tr><td colspan="${e.length+1}">${this.t("no_items_found")}</td></tr>`:t.forEach(t=>{let n=this.currentEntity.activeField||this.defaultActiveField,a=!0;this.currentEntity.hasActiveColumn&&(a=1===t[n]||"1"===t[n]||!0===t[n]),i+=`<tr${a?"":' class="inactive"'}>`,e.forEach(e=>{let n=this.currentEntity.columns[e],a=t[e],s=n.references;if(n.isForeignKey&&t[s]){let l=this.config.entities[s],r=l?l.displayField:"name";a=t[s]?t[s][r]:"N/A"}else if(e===this.currentEntity.activeField&&this.config.booleanDisplay){let o=1===a||"1"===a||!0===a;a=o?this.t(this.config.booleanDisplay.trueLabelKey):this.t(this.config.booleanDisplay.falseLabelKey)}i+=`<td>${null!==a?a:"N/A"}</td>`}),i+=this.renderActionButtons(t),i+="</tr>"}),i+="</tbody></table></div>",this.dom.tableDataContainer.innerHTML=i,document.querySelectorAll(".btn-detail").forEach(t=>t.onclick=t=>this.navigateToDetail(this.currentEntity.name,t.currentTarget.dataset.id)),document.querySelectorAll(".btn-edit").forEach(t=>t.onclick=t=>this.renderForm(t.currentTarget.dataset.id)),document.querySelectorAll(".btn-delete").forEach(t=>t.onclick=t=>this.handleDelete(t.currentTarget.dataset.id)),document.querySelectorAll(".btn-toggle-active").forEach(t=>t.onclick=t=>this.handleToggleActive(t.currentTarget.dataset.id,"true"===t.currentTarget.dataset.active)),document.querySelectorAll("th.sortable").forEach(t=>{t.style.cursor="pointer",t.onclick=()=>this.handleSort(t.dataset.sortKey)})}async renderFilters(){let t=this.currentEntity.filters&&this.currentEntity.filters.length>0,e="";if(t){for(let i of(e+='<div class="filter-controls">',this.currentEntity.filters)){let n=this.state.filters[i.name]||"";if(e+='<div class="form-group">',e+=`<label for="filter-${i.name}">${this.getEntityLabel(this.currentEntity,i.name)}</label>`,"select"===i.element){let a=this.currentEntity.columns[i.name];if(!a||!a.isForeignKey){console.error(`Filter "${i.name}" is of type 'select' but no corresponding foreign key column was found in the entity configuration.`);continue}let s=this.config.entities[this.camelCase(a.references)],l=s?await this.fetchAll(s):[],r=s.displayField||"name";e+=`<select id="filter-${i.name}" name="${i.name}">`,e+=`<option value="">${this.t("select_option")}</option>`,l.forEach(t=>{let i=t[s.primaryKey],a=t[r];e+=`<option value="${i}" ${String(i)===String(n)?"selected":""}>${a}</option>`}),e+="</select>"}else e+=`<input type="text" id="filter-${i.name}" name="${i.name}" value="${n}" placeholder="${this.getEntityLabel(this.currentEntity,i.name)}">`;e+="</div>"}e+=`<button id="search-btn" class="btn btn-primary">${this.t("search")}</button>`,e+=`<button id="reset-filter-btn" class="btn btn-secondary">${this.t("reset_filter")}</button>`}e+=`<button id="add-new-btn" class="btn btn-primary">${this.t("add_new",this.currentEntity.displayName)}</button>`,t&&(e+="</div>"),this.dom.filterContainer.innerHTML=e,t&&(document.getElementById("search-btn").onclick=()=>this.handleSearch(),document.getElementById("reset-filter-btn").onclick=()=>this.handleResetFilters(),this.dom.filterContainer.querySelectorAll(".filter-controls input, .filter-controls select").forEach(t=>{t.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),this.handleSearch())})})),document.getElementById("add-new-btn").onclick=()=>this.renderForm()}clearListView(){this.dom.filterContainer.innerHTML="",this.dom.tableDataContainer.innerHTML="",this.dom.paginationContainer.innerHTML=""}handleSearch(){let t={};this.dom.filterContainer.querySelectorAll("input, select").forEach(e=>{t[e.name]=e.value}),this.state.page=1,this.state.filters=t,this.updateUrlForState(),this.updateTableView()}handleResetFilters(){this.dom.filterContainer.querySelectorAll("input, select").forEach(t=>{t.value=""}),this.state.filters={},this.state.orderBy={},this.state.page=1,this.updateUrlForState(),this.updateTableView()}handleSort(t){let e="ASC";this.state.orderBy.field===t&&"ASC"===this.state.orderBy.direction&&(e="DESC"),this.state.orderBy={field:t,direction:e},this.state.page=1,this.updateUrlForState(),this.updateTableView()}renderActionButtons(t){let e=t[this.currentEntity.primaryKey],i='<td class="actions">';if(i+=`<button class="btn btn-sm btn-info btn-detail" data-id="${e}">${this.t("view")}</button> `,i+=`<button class="btn btn-sm btn-warning btn-edit" data-id="${e}">${this.t("edit")}</button> `,this.currentEntity.hasActiveColumn){let n=this.currentEntity.activeField||this.defaultActiveField,a=1===t[n]||"1"===t[n]||!0===t[n];i+=`<button class="btn btn-sm ${a?"btn-secondary":"btn-success"} btn-toggle-active" data-id="${e}" data-active="${a}">${a?this.t("deactivate"):this.t("activate")}</button> `}return i+`<button class="btn btn-sm btn-danger btn-delete" data-id="${e}">${this.t("delete")}</button></td>`}renderPagination(t){if(!t||0===t.total){this.dom.paginationContainer.innerHTML="";return}let e=this.state.page-1,i=this.state.page+1,n=t=>{let e=new URLSearchParams;return e.set("page",t),e.set("limit",this.state.limit),Object.entries(this.state.filters).forEach(([t,i])=>{i&&e.set(t,i)}),this.state.orderBy.field&&(e.set("orderBy",this.state.orderBy.field),e.set("orderDir",this.state.orderBy.direction)),`${window.location.pathname}#${this.currentEntity.name}?${e.toString()}`},a=t.hasPrevious?n(e):"#",s=t.hasNext?n(i):"#";this.dom.paginationContainer.innerHTML=`
<span>${this.t("page_of",t.page,t.totalPages,t.total)}</span>
<a id="prev-page" href="${a}" class="btn btn-secondary ${t.hasPrevious?"":"disabled"}">${this.t("previous")}</a>
<a id="next-page" href="${s}" class="btn btn-secondary ${t.hasNext?"":"disabled"}">${this.t("next")}</a>
`;let l=(t,e)=>{0===t.button&&!t.ctrlKey&&!t.metaKey&&(t.preventDefault(),t.currentTarget.classList.contains("disabled")||(this.state.page=e,this.updateUrlForState(),this.updateTableView()))};document.getElementById("prev-page").addEventListener("click",t=>l(t,e)),document.getElementById("next-page").addEventListener("click",t=>l(t,i))}updateUrlForState(){let t=new URLSearchParams;t.set("page",this.state.page),t.set("limit",this.state.limit),Object.entries(this.state.filters).forEach(([e,i])=>{i&&t.set(e,i)}),this.state.orderBy.field&&(t.set("orderBy",this.state.orderBy.field),t.set("orderDir",this.state.orderBy.direction));let e=`${window.location.pathname}#${this.currentEntity.name}?${t.toString()}`;history.pushState({entityName:this.currentEntity.name,params:this.state},"",e)}async renderDetailView(t){this.dom.title.textContent=this.t("detail_of",this.currentEntity.displayName);let e=this._invokeRenderHook("detail",{entity:this.currentEntity,container:this.dom.body,id:t});if(e)return;let i=this.getFieldsForQuery(this.currentEntity,2),n=`
query Get${this.currentEntity.name}($id: String!) {
${this.currentEntity.name}(id: $id) {
${i}
}
}
`;try{let a=await this.gqlQuery(n,{id:t}),s=a[this.currentEntity.name],l=`<div class="back-controls">
<button id="back-to-list" class="btn btn-secondary">${this.t("back_to_list")}</button>
</div>
<div class="table-container detail-view">
<table class="table">
<tbody>`;for(let r in this.currentEntity.columns){let o=this.currentEntity.columns[r],d=o.references;if(l+=`<tr>
<td>${this.getEntityLabel(this.currentEntity,r)}</td>
<td>`,o.isForeignKey&&s[d]){let h=s[d][this.currentEntity.displayField];null===h&&(h="N/A"),l+=`<span>${h}</span>`}else if(r===this.currentEntity.activeField&&this.config.booleanDisplay){let c=1===s[r]||"1"===s[r]||!0===s[r];c?l+=`<span>${this.t(this.config.booleanDisplay.trueLabelKey)}</span>`:l+=`<span>${this.t(this.config.booleanDisplay.falseLabelKey)}</span>`}else l+=`<span>${null!==s[r]?s[r]:"N/A"}</span>`;l+="</td></tr>"}l+="</tbody></table></div>",this.dom.tableDataContainer.innerHTML=l,document.getElementById("back-to-list").onclick=()=>history.back()}catch(u){this.dom.tableDataContainer.innerHTML=`<p style="color: red;">${this.t("failed_to_fetch_details")}</p>`}}async renderForm(t=null){this.dom.modalTitle.textContent=t?this.t("edit_entity",this.currentEntity.displayName):this.t("add_new_entity",this.currentEntity.displayName),this.dom.form.innerHTML=this.t("loading"),this.openModal();let e=this._invokeRenderHook(t?"update":"insert",{entity:this.currentEntity,container:this.dom.form,id:t});if(e)return;let i={};if(t){let n=this.getFieldsForQuery(this.currentEntity,2),a=`query GetForEdit($id: String!) { ${this.currentEntity.name}(id: $id) { ${n} } }`,s=await this.gqlQuery(a,{id:t});i=s[this.currentEntity.name]}let l="";for(let r in this.currentEntity.columns){if(r===this.currentEntity.primaryKey)continue;let o=this.currentEntity.columns[r],d="";if(o.isForeignKey&&i[o.references]?d=i[o.references][this.config.entities[this.camelCase(o.references)].primaryKey]:void 0!==i[r]&&(d=i[r]),l+='<div class="form-group">',l+=`<label for="${r}">${this.getEntityLabel(this.currentEntity,r)}</label>`,o.isForeignKey){let h=o.references,c=this.config.entities[this.camelCase(h)],u=c?await this.fetchAll(c,{activeOnly:!t}):[],g=c.displayField||"name";l+=`<select id="${r}" name="${r}">`,l+=`<option value="">${this.t("select_option")}</option>`,u.forEach(t=>{let e=t[c.primaryKey],i=t[g];l+=`<option value="${e}" ${e==d?"selected":""}>${i}</option>`}),l+="</select>"}else{let m=this.currentEntity.activeField||this.defaultActiveField,y="text";o.type.includes("int")&&(y="number"),(o.type.includes("boolean")||r===m)&&(y="checkbox"),"checkbox"===y?l+=`<input type="checkbox" id="${r}" name="${r}" ${d?"checked":""}>`:l+=`<input type="${y}" id="${r}" name="${r}" value="${d}">`}l+="</div>"}this.dom.form.innerHTML=l,this.dom.form.closest(".modal").querySelector(".modal-footer").innerHTML=`
<button type="submit" class="btn btn-primary">${this.t("save")}</button> 
<button type="button" class="btn btn-secondary" data-dismiss="modal">${this.t("close")}</button> `,this.dom.form.closest(".modal").querySelector(".modal-footer").querySelector('[type="submit"]').addEventListener("click",()=>this.handleSave(t)),this.dom.form.onsubmit=e=>{e.preventDefault(),this.handleSave(t)}}async handleSave(t){let e=this._invokeRenderHook(`save_${t?"update":"insert"}`,{entity:this.currentEntity,form:this.dom.form,id:t,app:this});if(e)return;this.currentEntity.activeField||this.defaultActiveField;let i=new FormData(this.dom.form),n={};for(let a in this.currentEntity.columns){if(a===this.currentEntity.primaryKey)continue;let s=this.currentEntity.columns[a];if(i.has(a)){let l=i.get(a);"checkbox"===this.dom.form.querySelector(`[name="${a}"]`).type&&(l=this.dom.form.querySelector(`[name="${a}"]`).checked),s.type.includes("boolean")||s.type.includes("int")?""===(l=!0===l?1:!1===l?0:l)||isNaN(l)||(l=Number(l)):s.type.includes("float")&&(l=l?Number(l):null),n[a]=l}}for(let r in this.currentEntity.columns){if(r===this.currentEntity.primaryKey)continue;let o=this.currentEntity.columns[r];"checkbox"===this.dom.form.querySelector(`[name="${r}"]`).type&&(this.dom.form.querySelector(`[name="${r}"]`).checked||(o.type.includes("boolean")?n[r]=!1:n[r]=0))}let d=this.ucFirst(this.currentEntity.name),h=t?`update${d}`:`create${d}`,c=this.getFieldsForQuery(this.currentEntity,1,!0),u=t=>{if("string"==typeof t){let e=t.replace(/\\/g,"\\\\").replace(/"/g,'\\"');return`"${e}"`}return null==t?"null":t},g=Object.entries(n).map(([t,e])=>`${t}: ${u(e)}`).join(", "),m=`input: {${g}}`;t&&(m=`id: "${t}", ${m}`);let y=`
mutation {
${h}(${m}) {
${c}
}
}
`;try{await this.gqlQuery(y),this.closeModal(),this.updateTableView()}catch(p){console.error(`Failed to save: ${p.message}`)}}async handleDelete(t){let e=await this.customConfirm({title:this.t("confirmation_title"),message:this.t("confirm_delete"),okText:this.t("delete"),cancelText:this.t("cancel")});if(!e)return;let i=this.ucFirst(this.currentEntity.name),n=`
mutation {
delete${i}(id: "${t}")
}
`;try{await this.gqlQuery(n),this.updateTableView(),this.closeConfirmModal()}catch(a){console.error(`Failed to delete: ${a.message}`)}}async handleToggleActive(t,e){let i=!e,n=i?"activate":"deactivate",a=await this.customConfirm({title:this.t("confirmation_title",""),message:this.t("confirm_toggle_active",this.t(n)),okText:this.t("yes"),cancelText:this.t("no")});if(!a)return;let s=this.ucFirst(this.currentEntity.name),l=this.currentEntity.activeField||this.defaultActiveField,r=`
mutation Toggle${s}Active {
toggle${s}Active(id: "${t}", ${l}: ${i}) {${l}}
}
`;try{await this.gqlQuery(r),this.updateTableView(),this.closeConfirmModal()}catch(o){console.error(`Failed to ${n}: ${o.message}`)}}customConfirm({title:t="Confirmation",message:e="Are you sure?",okText:i="OK",cancelText:n="Cancel"}){return new Promise(a=>{let s=document.getElementById("customConfirmModal"),l=s.querySelector(".modal-header .close-button"),r=s.querySelectorAll('[data-dismiss="modal"]');document.getElementById("customConfirmTitle").innerText=this.t(t),document.getElementById("customConfirmMessage").innerText=e;let o=document.getElementById("customConfirmOk"),d=document.getElementById("customConfirmCancel");o.innerText=this.t(i),d.innerText=this.t(n);let h=()=>{u(),a(!0)},c=()=>{u(),a(!1)},u=()=>{o.removeEventListener("click",h),d.removeEventListener("click",c),l.removeEventListener("click",c),r.forEach(t=>t.removeEventListener("click",c))};o.addEventListener("click",h,{once:!0}),d.addEventListener("click",c,{once:!0}),l.addEventListener("click",c,{once:!0}),r.forEach(t=>t.addEventListener("click",c)),this.openConfirmModal()})}openConfirmModal(){let t=document.getElementById("customConfirmModal");t.classList.add("show")}closeConfirmModal(){let t=document.getElementById("customConfirmModal");t.classList.remove("show")}customAlert({title:t="Info",message:e=""}){return new Promise(i=>{this.dom.infoModalTitle.innerText=this.t(t),this.dom.infoModalMessage.innerText=e,this.dom.infoModalOk.innerText=this.t("ok");let n=this.dom.infoModal.querySelector(".close-button"),a=()=>{this.dom.infoModal.classList.remove("show"),this.dom.infoModalOk.removeEventListener("click",a),n.removeEventListener("click",a),i()};this.dom.infoModalOk.addEventListener("click",a,{once:!0}),n.addEventListener("click",a,{once:!0}),this.openInfoModal()})}openInfoModal(){this.dom.infoModal.classList.add("show")}async handleLogin(t){t.preventDefault();let e=new FormData(this.dom.loginForm),i=document.getElementById("login-error");i.textContent="";let n=await fetch(this.loginUrl,{method:"POST",body:e,headers:{Accept:"application/json"}});if(n.ok){let a=await n.json();a.success?(this.closeLoginModal(),window.location.reload()):i.textContent=this.t("login_error")}else 401===n.status?i.textContent=this.t("invalid_credentials"):(i.textContent=this.t("login_error"),console.error("Login failed:",error),console.error("Login failed with status:",n.status))}async handleLogout(t){t.preventDefault();try{let e=await fetch(this.logoutUrl);e.ok?(this.dom.pageWrapper.style.display="none",this.openLoginModal()):await this.customAlert({title:"logout_failed_title",message:this.t("logout_failed")})}catch(i){console.error("Logout failed:",i),await this.customAlert({title:"logout_failed_title",message:this.t("logout_failed")})}}camelCase(t){return t.replace(/_([a-z])/g,t=>t[1].toUpperCase())}snakeCase(t){return t.replace(/([a-z0-9])([A-Z])/g,"$1_$2").toLowerCase()}titleCase(t){return t.replace(/\w\S*/g,t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase())}snakeCaseToTitleCase(t){return this.titleCase(t.replace(/_/g," "))}camelCaseToTitleCase(t){return this.titleCase(this.snakeCase(t).replace(/_/g," "))}ucFirst(t){return t.charAt(0).toUpperCase()+t.slice(1)}getFieldsForQuery(t,e=1,i=!1){if(e<0)return t.primaryKey;let n=[];for(let a in t.columns){let s=t.columns[a];if(s.isForeignKey&&!i){n.push(a);let l=s.references,r=this.config.entities[l];if(r){let o=this.snakeCase(l),d=`${o} { ${this.getFieldsForQuery(r,e-1)} }`;n.push(d)}}else s.isForeignKey||n.push(a)}return n.join(" ")}async fetchAll(t,e={}){let{activeOnly:i=!0}=e,n=this.getFieldsForQuery(t,0),a=[];if(i&&t.hasActiveColumn&&t.activeField){let s=t.columns[t.activeField],l=(s&&s.type.includes("boolean"),"1");a.push({field:t.activeField,value:l,operator:"EQUALS"})}let r=`query FetchAll($limit: Int, $filter: [FilterInput]) { ${t.pluralName}(limit: $limit, filter: $filter) { items { ${n} } } }`;try{let o=await this.gqlQuery(r,{limit:1e3,filter:a});return o[t.pluralName].items}catch(d){return console.error(`Failed to pre-fetch ${t.pluralName}:`,d),[]}}openModal(){this.dom.modal.style.display="block"}closeModal(){this.dom.modal.style.display="none",this.dom.form.innerHTML=""}openLoginModal(){this.dom.loginModal.style.display="block"}closeLoginModal(){this.dom.loginModal.style.display="none",this.dom.loginForm.reset(),document.getElementById("login-error").textContent=""}}GraphQLClientApp.prototype._generateLabelFromKey=function(t){return t.replace(/_/g," ").replace(/\w\S*/g,t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase())},document.addEventListener("DOMContentLoaded",()=>{new GraphQLClientApp({})});