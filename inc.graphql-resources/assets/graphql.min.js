class GraphQLClientApp{constructor(t={}){let e={configUrl:"frontend-config.php",apiUrl:"graphql.php",loginUrl:"login.php",logoutUrl:"logout.php",entityLanguageUrl:"entity-language.php",i18nUrl:"language.php",languageConfigUrl:"available-language.php",themeConfigUrl:"available-theme.php",defaultThemeUrl:"assets/style.min.css",customRenderers:{},defaultActiveField:"active",defaultDisplayField:"name",languageId:null,defaultLanguage:"en",pages:{}};Object.assign(this,e,t),this.supportedLanguages={},this.availableThemes=[],this.uiTranslations={},this.entityLanguagePack={},this.config=null,this.currentEntity=null,this.currentEntityDisplayName="",this.state={page:1,limit:10,filters:{},orderBy:{}},this.i18n={},this.dom={menu:document.getElementById("entity-menu"),menuFilterInput:document.getElementById("entity-menu-filter"),title:document.getElementById("content-title"),body:document.getElementById("content-body"),modal:document.getElementById("form-modal"),modalTitle:document.getElementById("modal-title"),form:document.getElementById("entity-form"),closeModalBtn:document.querySelector(".close-button"),loginModal:document.getElementById("login-modal"),loginForm:document.getElementById("login-form"),loginCloseBtn:document.getElementById("login-close-button"),logoutBtn:document.querySelector(".logout-link"),logoutBtnDropdown:document.getElementById("logout-btn-dropdown"),sidebarToggle:document.getElementById("sidebar-toggle"),sidebar:document.getElementById("sidebar-nav"),mainContent:document.getElementById("main-content"),langMenu:document.getElementById("lang-menu"),themeMenu:document.getElementById("theme-menu"),filterContainer:document.getElementById("filter-container"),tableDataContainer:document.getElementById("table-data-container"),paginationContainer:document.getElementById("pagination-container"),loadingBar:document.getElementById("loading-bar"),themeToggle:document.getElementById("theme-toggle"),pageWrapper:document.getElementById("page-wrapper"),infoModal:document.getElementById("infoModal"),infoModalTitle:document.getElementById("infoModalTitle"),infoModalMessage:document.getElementById("infoModalMessage"),infoModalOk:document.getElementById("infoModalOk"),themeStylesheet:document.getElementById("theme-stylesheet")},this.applicationTitle=document.querySelector('meta[name="title"]').getAttribute("content"),this.init()}initPage(){this.dom.sidebarToggle&&this.dom.sidebar&&this.dom.mainContent&&this.dom.sidebarToggle.addEventListener("click",()=>{let t=document.documentElement.classList.toggle("sidebar-collapsed");localStorage.setItem("sidebarCollapsed",t)}),this.dom.sidebar.classList.add("sidebar-animated"),document.querySelectorAll("[data-dropdown]").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();let i=t.dataset.dropdown,a=document.getElementById(i);a&&(document.querySelectorAll(".dropdown-menu.active").forEach(t=>{t!==a&&t.classList.remove("active")}),a.classList.toggle("active"))})}),window.addEventListener("click",()=>{document.querySelectorAll(".dropdown-menu.active").forEach(t=>t.classList.remove("active"))}),this.dom.logoutBtnDropdown&&(this.dom.logoutBtnDropdown.onclick=t=>this.handleLogout(t)),this.dom.langMenu.addEventListener("click",t=>{if(t.target.matches("a[data-lang]")){t.preventDefault();let e=t.target.dataset.lang;this.changeLanguage(e)}}),this.dom.themeMenu.addEventListener("click",t=>{if(t.target.matches("a[data-theme-name]")){t.preventDefault();let e=t.target.dataset.themeName;this.changeTheme(e),this.dom.themeMenu.classList.remove("active")}}),this.dom.themeToggle.addEventListener("click",()=>this.toggleTheme()),window.addEventListener("storage",t=>{"theme"===t.key&&this.applyTheme(t.newValue)}),this.dom.menuFilterInput&&this.dom.menuFilterInput.addEventListener("input",t=>this.filterMenu(t.target.value)),window.addEventListener("click",t=>{t.target.classList.contains("modal")&&(t.target.id===this.dom.modal.id?this.closeModal():t.target.id===this.dom.loginModal.id?this.closeLoginModal():"customConfirmModal"===t.target.id?this.closeConfirmModal():t.target.id===this.dom.infoModal.id&&this.dom.infoModal.classList.remove("show"))}),document.addEventListener("keydown",t=>{if("Escape"===t.key){let e=Array.from(document.querySelectorAll(".modal")).filter(t=>"block"===t.style.display||t.classList.contains("show")).sort((t,e)=>{let i=parseInt(window.getComputedStyle(t).zIndex,10)||0,a=parseInt(window.getComputedStyle(e).zIndex,10)||0;return a-i});e.length>0&&e[0].click()}})}handleUnauthorized(){"block"!==this.dom.loginModal.style.display&&(this.dom.pageWrapper.style.display="none",document.getElementById("login-error").textContent=this.t("session_expired"),this.openLoginModal())}async init(){this.dom.loginCloseBtn.onclick=()=>this.closeLoginModal(),this.dom.loginForm.onsubmit=t=>this.handleLogin(t),this.dom.logoutBtn.onclick=t=>this.handleLogout(t);try{await this.initializeLanguage(),await this.initializeTheme(),await this.loadI18n(),await this.loadConfig(),await this.loadLanguage(),this.applyI18n(),this.initPage(),window.onclick=t=>{},document.addEventListener("click",t=>{let e=t.target.closest('[data-dismiss="modal"]');if(e){let i=e.closest(".modal");i&&(i.id===this.dom.modal.id?this.closeModal():i.id===this.dom.loginModal.id?this.closeLoginModal():(i.id,this.dom.infoModal.id,i.classList.remove("show")))}}),this.buildMenu(),window.addEventListener("popstate",()=>this.handleRouteChange()),this.handleRouteChange()}catch(t){console.error("Initialization Error:",t),this.dom.body.innerHTML=`<p style="color: red;">Error: ${t.message}</p>`}}_invokeRenderHook(t,e){let i=e.entity.name;return!!this.customRenderers[i]&&"function"==typeof this.customRenderers[i][t]&&(this.customRenderers[i][t](e),!0)}async initializeLanguage(){try{let t=await fetch(this.languageConfigUrl);if(!t.ok)throw Error(`Could not fetch ${this.languageConfigUrl}`);let e=await t.json();this.supportedLanguages=e.supported,this.defaultLanguage=e.default;let i=localStorage.getItem("userLanguage"),a=this.defaultLanguage;if(i&&this.supportedLanguages[i])a=i;else{let n=navigator.language.split("-")[0];this.supportedLanguages[n]&&(a=n)}this.languageId=a,localStorage.setItem("userLanguage",this.languageId),localStorage.setItem("languageId",this.languageId),document.documentElement.lang=this.languageId,this.populateLangMenu()}catch(l){console.error("Failed to initialize language configuration, falling back to default:",l),this.supportedLanguages={en:"English"},this.defaultLanguage="en",this.languageId=this.defaultLanguage,localStorage.setItem("userLanguage",this.languageId),localStorage.setItem("languageId",this.languageId),document.documentElement.lang=this.languageId,this.populateLangMenu()}}populateLangMenu(){for(let[t,e]of(this.dom.langMenu.innerHTML="",Object.entries(this.supportedLanguages))){let i=document.createElement("li"),a=document.createElement("a");a.href="#",a.dataset.lang=t,t===this.languageId&&a.classList.add("active"),a.textContent=e,i.appendChild(a),this.dom.langMenu.appendChild(i)}}async initializeTheme(){try{let t=await fetch(this.themeConfigUrl);if(!t.ok)throw Error(`Could not fetch ${this.themeConfigUrl}`);this.availableThemes=await t.json();let e=localStorage.getItem("colorTheme"),i=null;e&&this.availableThemes.some(t=>t.name===e)&&(i=e),this.applyTheme(i),this.populateThemeMenu()}catch(a){console.error("Failed to initialize theme configuration:",a),this.applyTheme(null),this.populateThemeMenu()}finally{let n=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");this.applyThemeMode(n)}}async loadConfig(){let t=await fetch(this.configUrl);if(401===t.status)throw this.handleUnauthorized(),Error("Authentication required.");if(!t.ok)throw Error(`Failed to load config from ${this.configUrl}`);this.config=await t.json(),this.config.pagination&&this.config.pagination.pageSize&&(this.state.limit=this.config.pagination.pageSize)}async loadLanguage(){try{if(this.entityLanguageUrl){let t=`${this.entityLanguageUrl}?lang=${this.languageId}`,e=await fetch(t);if(401===e.status)throw this.handleUnauthorized(),Error("Authentication required.");if(!e.ok)throw Error(`Failed to load language from ${this.entityLanguageUrl}`);let i=await e.json();for(let a in this.entityLanguagePack[this.languageId]={},i.entities)void 0===this.entityLanguagePack[this.languageId][a]&&(this.entityLanguagePack[this.languageId][a]={}),this.entityLanguagePack[this.languageId][a].displayName=i.entities[a].displayName,this.entityLanguagePack[this.languageId][a].columns=i.entities[a].columns}}catch(n){console.warn(`Could not load entity language file for '${this.languageId}'. Falling back to generated labels.`,n)}}async loadI18n(){try{if(this.i18nUrl){let t=`${this.i18nUrl}?lang=${this.languageId}`,e=await fetch(t);if(401===e.status)throw this.handleUnauthorized(),Error("Authentication required.");if(!e.ok)throw Error(`Failed to load i18n from ${this.i18nUrl}`);this.i18n=await e.json()}}catch(i){console.warn("Could not load language file. Falling back to key-based labels.",i),this.i18n={}}}applyI18n(){document.querySelectorAll("[data-i18n]").forEach(t=>{if("entity-menu-filter"===t.id&&t.hasAttribute("placeholder")){t.placeholder=this.t("menu_filter");return}let e=t.getAttribute("data-i18n");"INPUT"===t.tagName||"TEXTAREA"===t.tagName?t.placeholder=this.t(e):t.textContent=this.t(e)}),document.querySelectorAll("[data-i18n-title]").forEach(t=>{let e=t.getAttribute("data-i18n-title");t.title=this.t(e)})}t(t,...e){let i=this.i18n[t];if(i)return e.forEach((t,e)=>{let a=RegExp(`\\{${e}\\}`,"g");i=i.replace(a,t)}),i;let a=this._generateLabelFromKey(t);return[a,...e].join(" ")}changeLanguage(t){localStorage.setItem("userLanguage",t),localStorage.setItem("languageId",t),window.location.reload()}toggleTheme(){let t=document.documentElement.getAttribute("data-theme")||"light",e="dark"===t?"light":"dark";this.applyThemeMode(e),localStorage.setItem("theme",e)}populateThemeMenu(){this.dom.themeMenu.innerHTML="";let t=localStorage.getItem("colorTheme");this.availableThemes.forEach(e=>{let i=document.createElement("li"),a=document.createElement("a");a.href="#",a.dataset.themeName=e.name,e.name===t&&a.classList.add("active"),a.textContent=e.title,i.appendChild(a),this.dom.themeMenu.appendChild(i)})}changeTheme(t){localStorage.setItem("colorTheme",t),this.applyTheme(t),this.dom.themeMenu.querySelectorAll("a").forEach(e=>{e.classList.toggle("active",e.dataset.themeName===t)})}async applyTheme(t){let e=t?`assets/themes/${t}/style.min.css`:this.defaultThemeUrl;if(this.dom.themeStylesheet&&this.dom.themeStylesheet.href.endsWith(e))return;let i=document.createElement("link");i.rel="stylesheet",i.href=e,document.head.appendChild(i),i.onload=()=>{let t=this.dom.themeStylesheet;t&&t.parentNode&&t.parentNode.removeChild(t),this.dom.themeStylesheet=i,i.id="theme-stylesheet"},i.onerror=()=>{console.error(`Failed to load theme: ${e}. Keeping the current theme.`),i.parentNode&&i.parentNode.removeChild(i)}}applyThemeMode(t){document.documentElement.setAttribute("data-theme",t)}getEntityLabel(t,e){let i=this.snakeCase(t.name);if(!this.entityLanguagePack||!this.entityLanguagePack[this.languageId])return this.snakeCaseToTitleCase(e);{let a=this.entityLanguagePack[this.languageId][t.name];return(a||(a=this.entityLanguagePack[this.languageId][i]),a&&a.columns&&a.columns[e])?a.columns[e]:this.snakeCaseToTitleCase(e)}}getTranslatedEntityName(t){if(!this.entityLanguagePack||!this.entityLanguagePack[this.languageId])return this.camelCaseToTitleCase(t.displayName);{let e=this.entityLanguagePack[this.languageId][t.originalName];return e&&e.displayName?e.displayName:this.camelCaseToTitleCase(t.displayName)}}getPreferredLanguages(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:["en"]}buildMenu(){let t=this;if(!this.config||!this.config.entities)return;this.dom.menu.innerHTML="";let e=Object.values(this.config.entities).sort((t,e)=>{let i=void 0!==t.sortOrder?t.sortOrder:1/0,a=void 0!==e.sortOrder?e.sortOrder:1/0;return i-a});e.forEach(e=>{let i=document.createElement("li"),a=document.createElement("a");a.href=`#${e.name}`,a.textContent=t.getTranslatedEntityName(e),a.onclick=t=>{t.preventDefault(),this.navigateTo(e.name,{limit:this.state.limit})},i.appendChild(a),this.dom.menu.appendChild(i)})}filterMenu(t){let e=t.toLowerCase().trim(),i=this.dom.menu.querySelectorAll("li");i.forEach(t=>{let i=t.textContent.toLowerCase();i.includes(e)?t.style.display="":t.style.display="none"})}async gqlQuery(t,e={}){this.dom.loadingBar.style.display="block";try{let i=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"xmlhttprequest","X-Language-Id":this.languageId,"Accept-Language":this.languageId,Accept:"application/json"},body:JSON.stringify({query:t,variables:e})});if(401===i.status)throw this.handleUnauthorized(),Error("Authentication required.");let a=await i.json();if(a.errors)throw console.error("GraphQL Errors:",a.errors),console.error(`Error: ${a.errors[0].message}`),Error(a.errors[0].message);return a.data}catch(n){throw n}finally{this.dom.loadingBar.style.display="none"}}navigateTo(t,e={}){let i=e.filters||{},a=e.orderBy||{},n=new URLSearchParams;n.set("page",e.page||1),n.set("limit",e.limit||10),Object.entries(i).forEach(([t,e])=>{e&&n.set(t,e)}),a.field&&(n.set("orderBy",a.field),n.set("orderDir",a.direction));let l=`${window.location.pathname}#${t}?${n.toString()}`;history.pushState({entityName:t,params:e},"",l),this.handleRouteChange()}navigateToDetail(t,e){let i=`${window.location.pathname}#${t}/detail/${e}`;history.pushState({entityName:t,id:e},"",i),this.handleRouteChange()}async handlePage(t){let e=this.pages[t];if(e)try{let i=this.t(e.title);if(this.dom.title.textContent=i,document.title=`${i} - ${this.applicationTitle}`,document.querySelectorAll("#entity-menu a").forEach(t=>t.classList.remove("active")),e.url){let[a,n]=e.url.split("?"),[l,s]=window.location.hash.split("?"),r=new URLSearchParams;new URLSearchParams(s).forEach((t,e)=>{r.set(e,t)});let o=`${a}?${r.toString()}`;this.dom.loadingBar.style.display="block";let d={method:e.method,headers:{"X-Requested-With":"xmlhttprequest","X-Language-Id":this.languageId,"Accept-Language":this.languageId,Accept:e.accept||"*"}};e.body&&(d.body=e.body);let h=await fetch(o,d);if(200!=h.status){"function"==typeof e.error&&e.error(h.status,h.statusText,this.dom.tableDataContainer,this.dom);return}let c;c=e?.accept&&-1!=e.accept?.indexOf("json")?await h.json():await h.text(),"function"==typeof e.success&&e.success(c,this.dom.tableDataContainer,this.dom)}else e.content&&"function"==typeof e.render&&e.render(e.content,this.dom.tableDataContainer,this.dom)}catch(u){throw u}finally{this.dom.loadingBar.style.display="none"}}async handleRouteChange(){let t=window.location.hash.substring(1);if(!t||"#"===t){this.renderDashboardView();return}let[e,i]=t.split("?"),a=e.split("/");if(this.pages[a[0]]){this.handlePage(a[0]);return}let n=a[0],l=a.length>1?a[1]:"list",s=a.length>2?a[2]:null,r=new URLSearchParams(i),o=this.config.entities[n];if(!o){this.dom.body.innerHTML=`<p>Page "${n}" not found.</p>`;return}this.currentEntity=o;let d=this.applicationTitle;this.currentEntityDisplayName=this.getTranslatedEntityName(o),document.title=`${this.currentEntityDisplayName} - ${d}`;let h={};for(let[c,u]of r.entries())"page"!==c&&"limit"!==c&&(h[c]=u);let m={};r.has("orderBy")&&(m.field=r.get("orderBy"),m.direction=r.get("orderDir")||"ASC");let g=r.get("limit"),y=null!==g?parseInt(g,10):this.state.limit||10;if(this.state={page:parseInt(r.get("page"))||1,limit:y,filters:h,orderBy:m},this.config&&this.config.pagination){let{minPageSize:p,maxPageSize:f}=this.config.pagination;p&&this.state.limit<p&&(this.state.limit=p),f&&this.state.limit>f&&(this.state.limit=f)}document.querySelectorAll("#entity-menu a").forEach(t=>t.classList.toggle("active",t.getAttribute("href")===`#${n}`)),"detail"===l&&s?(this.dom.filterContainer.style.display="none",this.clearListView(),await this.renderDetailView(s)):(this.dom.filterContainer.style.display="block",await this.renderListView(),await this.updateTableView())}renderDashboardView(){let t=this.t("dashboard");document.title=`${this.applicationTitle}`,this.dom.title.textContent=t,document.querySelectorAll("#entity-menu a").forEach(t=>t.classList.remove("active")),this.dom.filterContainer.style.display="none",this.clearListView(),this.dom.tableDataContainer.innerHTML=`<p>${this.t("welcome_dashboard")}</p>`}async renderListView(){this.clearListView(),this.dom.title.textContent=this.t("list_of",this.currentEntityDisplayName),await this.renderFilters()}async updateTableView(){let t=this.getFieldsForQuery(this.currentEntity,1),e=(this.state.page-1)*this.state.limit,i=[];this.currentEntity.filters&&Object.entries(this.state.filters).forEach(([t,e])=>{let a=this.currentEntity.filters.find(e=>e.name===t);e&&a&&i.push({field:t,value:e,operator:a.operator||"EQUALS"})});let a=[];this.state.orderBy&&this.state.orderBy.field&&a.push(this.state.orderBy);let n=`
query Get${this.currentEntity.pluralName}($limit: Int, $offset: Int, $orderBy: [SortInput], $filter: [FilterInput]) {
${this.currentEntity.pluralName}(limit: $limit, offset: $offset, orderBy: $orderBy, filter: $filter) {
items { ${t} }
total
limit
page
totalPages
hasNext
hasPrevious
}
}
`;try{this.dom.tableDataContainer.innerHTML=this.t("loading"),this.dom.paginationContainer.innerHTML="";let l=await this.gqlQuery(n,{limit:this.state.limit,offset:e,orderBy:a,filter:i}),s=l[this.currentEntity.pluralName];this.renderTable(s.items),this.renderPagination(s)}catch(r){this.dom.tableDataContainer.innerHTML=`<p style="color: red;">${r.message}</p>`}}renderTable(t){let e=Object.keys(this.currentEntity.columns),i=`
<div class="table-container">

<table class="table table-data-list table-striped">
<thead>
<tr>
${e.map(t=>{let e=this.state.orderBy.field===t,i=e?"ASC"===this.state.orderBy.direction?" &#9650;":" &#9660;":"";return`<th class="sortable" data-sort-key="${t}">
${this.getEntityLabel(this.currentEntity,t)}${i}
</th>`}).join("")} 
<th>${this.t("actions")}</th>
</tr>
</thead>
<tbody>
`;0===t.length?i+=`<tr><td colspan="${e.length+1}">${this.t("no_items_found")}</td></tr>`:t.forEach(t=>{let a=this.currentEntity.activeField||this.defaultActiveField,n=!0;this.currentEntity.hasActiveColumn&&(n=1===t[a]||"1"===t[a]||!0===t[a]),i+=`<tr${n?"":' class="inactive"'}>`,e.forEach(e=>{let a=this.currentEntity.columns[e],n=t[e],l=a.references;if(a.isForeignKey&&t[l]){let s=this.config.entities[this.camelCase(l)],r=s&&s.displayField?s.displayField:s.primaryKey;t[l]&&void 0!==t[l][r]?n=t[l][r]||"N/A":t[l]&&void 0!==t[l][s.primaryKey]&&(n=t[l][s.primaryKey])}else if((a.type.includes("boolean")||e===this.currentEntity.activeField)&&this.config.booleanDisplay){let o=1===n||"1"===n||!0===n;n=o?this.t(this.config.booleanDisplay.trueLabelKey):this.t(this.config.booleanDisplay.falseLabelKey)}i+=`<td>${null!==n?n:"N/A"}</td>`}),i+=this.renderActionButtons(t),i+="</tr>"}),i+="</tbody></table></div>",this.dom.tableDataContainer.innerHTML=i,document.querySelectorAll(".btn-detail").forEach(t=>t.onclick=t=>this.navigateToDetail(this.currentEntity.name,t.currentTarget.dataset.id)),document.querySelectorAll(".btn-edit").forEach(t=>t.onclick=t=>this.renderForm(t.currentTarget.dataset.id)),document.querySelectorAll(".btn-delete").forEach(t=>t.onclick=t=>this.handleDelete(t.currentTarget.dataset.id)),document.querySelectorAll(".btn-toggle-active").forEach(t=>t.onclick=t=>this.handleToggleActive(t.currentTarget.dataset.id,"true"===t.currentTarget.dataset.active)),document.querySelectorAll("th.sortable").forEach(t=>{t.style.cursor="pointer",t.onclick=()=>this.handleSort(t.dataset.sortKey)})}async renderFilters(){let t=this.currentEntity.filters&&this.currentEntity.filters.length>0,e="";if(t){for(let i of(e+='<div class="filter-controls">',this.currentEntity.filters)){let a=this.state.filters[i.name]||"";if(e+='<div class="form-group">',e+=`<label for="filter-${i.name}">${this.getEntityLabel(this.currentEntity,i.name)}</label>`,"select"===i.element){let n=this.currentEntity.columns[i.name];if(!n||!n.isForeignKey){console.error(`Filter "${i.name}" is of type 'select' but no corresponding foreign key column was found in the entity configuration.`);continue}let l=this.config.entities[this.camelCase(n.references)],s=l?await this.fetchAll(l):[],r=l.displayField||l.primaryKey;e+=`<select id="filter-${i.name}" name="${i.name}">`,e+=`<option value="">${this.t("select_option")}</option>`,s.forEach(t=>{let i=t[l.primaryKey],n=t[r]||i;e+=`<option value="${i}" ${String(i)===String(a)?"selected":""}>${n}</option>`}),e+="</select>"}else e+=`<input type="text" id="filter-${i.name}" name="${i.name}" value="${a}" placeholder="${this.getEntityLabel(this.currentEntity,i.name)}">`;e+="</div>"}e+=`<button id="search-btn" class="btn btn-primary">${this.t("search")}</button>`,e+=`<button id="reset-filter-btn" class="btn btn-secondary">${this.t("reset_filter")}</button>`}e+=`<button id="add-new-btn" class="btn btn-primary">${this.t("add_new",this.currentEntity.displayName)}</button>`,t&&(e+="</div>"),this.dom.filterContainer.innerHTML=e,t&&(document.getElementById("search-btn").onclick=()=>this.handleSearch(),document.getElementById("reset-filter-btn").onclick=()=>this.handleResetFilters(),this.dom.filterContainer.querySelectorAll(".filter-controls input, .filter-controls select").forEach(t=>{t.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),this.handleSearch())})})),document.getElementById("add-new-btn").onclick=()=>this.renderForm()}clearListView(){this.dom.filterContainer.innerHTML="",this.dom.tableDataContainer.innerHTML="",this.dom.paginationContainer.innerHTML="",this.dom.paginationContainer.style.display="none"}handleSearch(){let t={};this.dom.filterContainer.querySelectorAll("input, select").forEach(e=>{t[e.name]=e.value}),this.state.page=1,this.state.filters=t,this.updateUrlForState(),this.updateTableView()}handleResetFilters(){this.dom.filterContainer.querySelectorAll("input, select").forEach(t=>{t.value=""}),this.state.filters={},this.state.orderBy={},this.state.page=1,this.updateUrlForState(),this.updateTableView()}handleSort(t){let e="ASC";this.state.orderBy.field===t&&"ASC"===this.state.orderBy.direction&&(e="DESC"),this.state.orderBy={field:t,direction:e},this.state.page=1,this.updateUrlForState(),this.updateTableView()}renderActionButtons(t){let e=t[this.currentEntity.primaryKey],i='<td class="actions">';if(i+=`<button class="btn btn-sm btn-info btn-detail" data-id="${e}">${this.t("view")}</button> `,i+=`<button class="btn btn-sm btn-warning btn-edit" data-id="${e}">${this.t("edit")}</button> `,this.currentEntity.hasActiveColumn){let a=this.currentEntity.activeField||this.defaultActiveField,n=1===t[a]||"1"===t[a]||!0===t[a];i+=`<button class="btn btn-sm ${n?"btn-secondary":"btn-success"} btn-toggle-active" data-id="${e}" data-active="${n}">${n?this.t("deactivate"):this.t("activate")}</button> `}return i+`<button class="btn btn-sm btn-danger btn-delete" data-id="${e}">${this.t("delete")}</button></td>`}renderPagination(t){if(!t||0===t.total){this.dom.paginationContainer.innerHTML="";return}let e=this.state.page-1,i=this.state.page+1,a=t=>{let e=window.location.hash,[i,a]=e.split("?"),n=new URLSearchParams(a||"");n.set("page",t),n.set("limit",this.state.limit),Object.entries(this.state.filters).forEach(([t,e])=>{e?n.set(t,e):n.delete(t)}),this.state.orderBy.field?(n.set("orderBy",this.state.orderBy.field),n.set("orderDir",this.state.orderBy.direction)):(n.delete("orderBy"),n.delete("orderDir"));let l=this.currentEntity.name;return`${window.location.pathname}#${l}?${n.toString()}`},n=t.hasPrevious?a(e):"#",l=t.hasNext?a(i):"#";this.dom.paginationContainer.innerHTML=`
<span>${this.t("page_of",t.page,t.totalPages,t.total)}</span>
<a id="prev-page" href="${n}" class="btn btn-secondary ${t.hasPrevious?"":"disabled"}">${this.t("previous")}</a>
<a id="next-page" href="${l}" class="btn btn-secondary ${t.hasNext?"":"disabled"}">${this.t("next")}</a>
`,this.dom.paginationContainer.style.display="flex";let s=(t,e)=>{0===t.button&&!t.ctrlKey&&!t.metaKey&&(t.preventDefault(),t.currentTarget.classList.contains("disabled")||(this.state.page=e,this.updateUrlForState(),this.updateTableView()))};document.getElementById("prev-page").addEventListener("click",t=>s(t,e)),document.getElementById("next-page").addEventListener("click",t=>s(t,i))}updateUrlForState(){let t=new URLSearchParams;t.set("page",this.state.page),t.set("limit",this.state.limit),Object.entries(this.state.filters).forEach(([e,i])=>{i&&t.set(e,i)}),this.state.orderBy.field&&(t.set("orderBy",this.state.orderBy.field),t.set("orderDir",this.state.orderBy.direction));let e=`${window.location.pathname}#${this.currentEntity.name}?${t.toString()}`;history.pushState({entityName:this.currentEntity.name,params:this.state},"",e)}async renderDetailView(t){this.dom.title.textContent=this.t("detail_of",this.currentEntityDisplayName);let e=this._invokeRenderHook("detail",{entity:this.currentEntity,container:this.dom.body,id:t});if(e)return;let i=this.getFieldsForQuery(this.currentEntity,2),a=`
query Get${this.currentEntity.name}($id: String!) {
${this.currentEntity.name}(id: $id) {
${i}
}
}
`;try{let n=await this.gqlQuery(a,{id:t}),l=n[this.currentEntity.name],s=`<div class="back-controls">
<button id="back-to-list" class="btn btn-secondary">${this.t("back_to_list")}</button>
</div>
<div class="table-container detail-view">
<table class="table">
<tbody>`;for(let r in this.currentEntity.columns){let o=this.currentEntity.columns[r],d=o.references;if(s+=`<tr>
<td>${this.getEntityLabel(this.currentEntity,r)}</td>
<td>`,o.isForeignKey&&l[d]){let h=l[d][this.currentEntity.displayField];null===h&&(h="N/A"),s+=`<span>${h}</span>`}else if((o.type.includes("boolean")||r===this.currentEntity.activeField)&&this.config.booleanDisplay){let c=1===l[r]||"1"===l[r]||!0===l[r];s+=`<span>${c?this.t(this.config.booleanDisplay.trueLabelKey):this.t(this.config.booleanDisplay.falseLabelKey)}</span>`}else s+=`<span>${null!==l[r]?l[r]:"N/A"}</span>`;s+="</td></tr>"}s+="</tbody></table></div>",this.dom.tableDataContainer.innerHTML=s,document.getElementById("back-to-list").onclick=()=>history.back()}catch(u){this.dom.tableDataContainer.innerHTML=`<p style="color: red;">${this.t("failed_to_fetch_details")}</p>`}}async renderForm(t=null){this.dom.modalTitle.textContent=t?this.t("edit_entity",this.currentEntity.displayName):this.t("add_new_entity",this.currentEntity.displayName),this.dom.form.innerHTML=this.t("loading"),this.openModal();let e=t?"update":"insert",i=this._invokeRenderHook(e,{entity:this.currentEntity,container:this.dom.form,id:t});if(i)return;let a={};if(t){let n=this.getFieldsForQuery(this.currentEntity,2),l=`query GetForEdit($id: String!) { ${this.currentEntity.name}(id: $id) { ${n} } }`,s=await this.gqlQuery(l,{id:t});a=s[this.currentEntity.name]}let r="";for(let o in this.currentEntity.columns){if(o===this.currentEntity.primaryKey&&("insert"===e&&"autogenerated"===this.currentEntity.columns[o].primaryKeyValue||"update"===e&&"manual-all"!=this.currentEntity.columns[o].primaryKeyValue)||this.currentEntity.backendHandledColumns&&this.currentEntity.backendHandledColumns.includes(o))continue;let d=this.currentEntity.columns[o],h="";if(d.isForeignKey&&a[d.references]?h=a[d.references][this.config.entities[this.camelCase(d.references)].primaryKey]:void 0!==a[o]&&(h=a[o]),r+='<div class="form-group">',r+=`<label for="${o}">${this.getEntityLabel(this.currentEntity,o)}</label>`,d.isForeignKey){let c=d.references,u=this.config.entities[this.camelCase(c)],m=u?await this.fetchAll(u,{activeOnly:!t}):[],g=u.displayField||u.primaryKey;r+=`<select id="${o}" name="${o}">`,r+=`<option value="">${this.t("select_option")}</option>`,m.forEach(t=>{let e=t[u.primaryKey],i=t[g]||e;r+=`<option value="${e}" ${e==h?"selected":""}>${i}</option>`}),r+="</select>"}else{let y=this.currentEntity.activeField||this.defaultActiveField,p="text";d.type.includes("int")&&(p="number"),(d.type.includes("boolean")||o===y)&&(p="checkbox"),d.dataType.includes("datetime")||d.dataType.includes("timestamp")?p="datetime-local":d.dataType.includes("date")?p="date":d.dataType.includes("time")?p="time":d.dataType.includes("float")&&(p='number" step="any'),"checkbox"===p?r+=`<input type="checkbox" id="${o}" name="${o}" ${h?"checked":""}>`:r+=`<input type="${p}" id="${o}" name="${o}" value="${h}">`}r+="</div>"}this.dom.form.innerHTML=r,this.dom.form.closest(".modal").querySelector(".modal-footer").innerHTML=`
<button type="submit" class="btn btn-primary">${this.t("save")}</button> 
<button type="button" class="btn btn-secondary" data-dismiss="modal">${this.t("close")}</button> `,this.dom.form.closest(".modal").querySelector(".modal-footer").querySelector('[type="submit"]').addEventListener("click",()=>this.handleSave(t)),this.dom.form.onsubmit=e=>{e.preventDefault(),this.handleSave(t)}}async handleSave(t){let e=t?"update":"insert",i=this._invokeRenderHook(`save_${e}`,{entity:this.currentEntity,form:this.dom.form,id:t,app:this});if(i)return;this.currentEntity.activeField||this.defaultActiveField;let a=new FormData(this.dom.form),n={};for(let l in this.currentEntity.columns){if(l===this.currentEntity.primaryKey&&"autogenerated"===this.currentEntity.columns[l].primaryKeyValue)continue;if("update"==e&&l===this.currentEntity.primaryKey&&"manual-insert"===this.currentEntity.columns[l].primaryKeyValue){n[l]=t;continue}let s=this.currentEntity.columns[l];if(a.has(l)){let r=a.get(l);"checkbox"===this.dom.form.querySelector(`[name="${l}"]`).type&&(r=this.dom.form.querySelector(`[name="${l}"]`).checked),s.type.includes("boolean")||s.type.includes("int")?""===(r=!0===r?1:!1===r?0:r)||isNaN(r)||(r=Number(r)):s.type.includes("float")&&(r=r?Number(r):null),n[l]=r}}for(let o in this.currentEntity.columns){if(o===this.currentEntity.primaryKey)continue;let d=this.currentEntity.columns[o];this.dom.form.querySelector(`[name="${o}"]`)&&"checkbox"===this.dom.form.querySelector(`[name="${o}"]`).type&&(this.dom.form.querySelector(`[name="${o}"]`).checked||(d.type.includes("boolean")?n[o]=!1:n[o]=0))}let h=this.ucFirst(this.currentEntity.name),c=t?`update${h}`:`create${h}`,u=this.getFieldsForQuery(this.currentEntity,1,!0),m=t=>{if("string"==typeof t){let e=t.replace(/\\/g,"\\\\").replace(/"/g,'\\"');return`"${e}"`}return null==t?"null":t},g=Object.entries(n).map(([t,e])=>`${t}: ${m(e)}`).join(", "),y=`input: {${g}}`;t&&(y=`id: "${t}", ${y}`);let p=`
mutation {
${c}(${y}) {
${u}
}
}
`;try{await this.gqlQuery(p),this.closeModal(),this.updateTableView()}catch(f){console.error(`Failed to save: ${f.message}`)}}async handleDelete(t){let e=await this.customConfirm({title:this.t("confirmation_title"),message:this.t("confirm_delete"),okText:this.t("delete"),cancelText:this.t("cancel")});if(!e)return;let i=this.ucFirst(this.currentEntity.name),a=`
mutation {
delete${i}(id: "${t}")
}
`;try{await this.gqlQuery(a),this.updateTableView(),this.closeConfirmModal()}catch(n){console.error(`Failed to delete: ${n.message}`)}}async handleToggleActive(t,e){let i=!e,a=i?"activate":"deactivate",n=await this.customConfirm({title:this.t("confirmation_title",""),message:this.t("confirm_toggle_active",this.t(a)),okText:this.t("yes"),cancelText:this.t("no")});if(!n)return;let l=this.ucFirst(this.currentEntity.name),s=this.currentEntity.activeField||this.defaultActiveField,r=`
mutation Toggle${l}Active {
toggle${l}Active(id: "${t}", ${s}: ${i}) {${s}}
}
`;try{await this.gqlQuery(r),this.updateTableView(),this.closeConfirmModal()}catch(o){console.error(`Failed to ${a}: ${o.message}`)}}customConfirm({title:t="Confirmation",message:e="Are you sure?",okText:i="OK",cancelText:a="Cancel"}){return new Promise(n=>{let l=document.getElementById("customConfirmModal"),s=l.querySelector(".modal-header .close-button"),r=l.querySelectorAll('[data-dismiss="modal"]');document.getElementById("customConfirmTitle").innerText=this.t(t),document.getElementById("customConfirmMessage").innerText=e;let o=document.getElementById("customConfirmOk"),d=document.getElementById("customConfirmCancel");o.innerText=this.t(i),d.innerText=this.t(a);let h=()=>{u(),n(!0)},c=()=>{u(),n(!1)},u=()=>{o.removeEventListener("click",h),d.removeEventListener("click",c),s.removeEventListener("click",c),r.forEach(t=>t.removeEventListener("click",c))};o.addEventListener("click",h,{once:!0}),d.addEventListener("click",c,{once:!0}),s.addEventListener("click",c,{once:!0}),r.forEach(t=>t.addEventListener("click",c)),this.openConfirmModal()})}openConfirmModal(){let t=document.getElementById("customConfirmModal");t.classList.add("show")}closeConfirmModal(){let t=document.getElementById("customConfirmModal");t.classList.remove("show")}customAlert({title:t="Info",message:e=""}){return new Promise(i=>{this.dom.infoModalTitle.innerText=this.t(t),this.dom.infoModalMessage.innerText=e,this.dom.infoModalOk.innerText=this.t("ok");let a=this.dom.infoModal.querySelector(".close-button"),n=()=>{this.dom.infoModal.classList.remove("show"),this.dom.infoModalOk.removeEventListener("click",n),a.removeEventListener("click",n),i()};this.dom.infoModalOk.addEventListener("click",n,{once:!0}),a.addEventListener("click",n,{once:!0}),this.openInfoModal()})}openInfoModal(){this.dom.infoModal.classList.add("show")}async handleLogin(t){t.preventDefault();let e=new FormData(this.dom.loginForm),i=document.getElementById("login-error");i.textContent="";let a=await fetch(this.loginUrl,{method:"POST",body:e,headers:{"X-Requested-With":"xmlhttprequest","X-Language-Id":this.languageId,"Accept-Language":this.languageId,Accept:"application/json"}});if(a.ok){let n=await a.json();n.success?(this.closeLoginModal(),window.location.reload()):i.textContent=this.t("login_error")}else 401===a.status?i.textContent=this.t("invalid_credentials"):(i.textContent=this.t("login_error"),console.error("Login failed:",error),console.error("Login failed with status:",a.status))}async handleLogout(t){t.preventDefault();try{let e=await fetch(this.logoutUrl);e.ok?(this.dom.pageWrapper.style.display="none",this.openLoginModal()):await this.customAlert({title:"logout_failed_title",message:this.t("logout_failed")})}catch(i){console.error("Logout failed:",i),await this.customAlert({title:"logout_failed_title",message:this.t("logout_failed")})}}camelCase(t){return t?t.replace(/_([a-z])/g,t=>t[1].toUpperCase()):""}snakeCase(t){return t.replace(/([a-z0-9])([A-Z])/g,"$1_$2").toLowerCase()}titleCase(t){return t.replace(/\w\S*/g,t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase())}snakeCaseToTitleCase(t){return this.titleCase(t.replace(/_/g," "))}camelCaseToTitleCase(t){return this.titleCase(this.snakeCase(t).replace(/_/g," "))}ucFirst(t){return t.charAt(0).toUpperCase()+t.slice(1)}getFieldsForQuery(t,e=1,i=!1){if(e<0)return t.primaryKey;let a=[];for(let n in t.columns){let l=t.columns[n];if(l.isForeignKey&&!i){a.push(n);let s=l.references,r=this.config.entities[this.camelCase(s)];if(r){let o=s,d=`${o} { ${this.getFieldsForQuery(r,e-1)} }`;a.push(d)}}else l.isForeignKey||a.push(n)}return a.join(" ")}async fetchAll(t,e={}){let{activeOnly:i=!0}=e,a=this.getFieldsForQuery(t,0),n=[];if(i&&t.hasActiveColumn&&t.activeField){let l=t.columns[t.activeField],s=(l&&l.type.includes("boolean"),"1");n.push({field:t.activeField,value:s,operator:"EQUALS"})}let r=`query FetchAll($limit: Int, $filter: [FilterInput]) { ${t.pluralName}(limit: $limit, filter: $filter) { items { ${a} } } }`;try{let o=await this.gqlQuery(r,{limit:1e3,filter:n});return o[t.pluralName].items}catch(d){return console.error(`Failed to pre-fetch ${t.pluralName}:`,d),[]}}openModal(){this.dom.modal.style.display="block"}closeModal(){this.dom.modal.style.display="none",this.dom.form.innerHTML=""}openLoginModal(){this.dom.loginModal.style.display="block"}closeLoginModal(){this.dom.loginModal.style.display="none",this.dom.loginForm.reset(),document.getElementById("login-error").textContent=""}}GraphQLClientApp.prototype._generateLabelFromKey=function(t){return t.replace(/_/g," ").replace(/\w\S*/g,t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase())};