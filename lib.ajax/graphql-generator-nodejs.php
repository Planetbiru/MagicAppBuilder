<?php

use AppBuilder\GraphQLGeneratorNodeJs;
use MagicObject\SecretObject;
use MagicObject\Util\Parsedown;

function generateReadmeNodeJs($appName)
{
    return "# " . $appName . "\n\n" .
        "This is a Node.js GraphQL application generated by MagicAppBuilder.\n\n" .
        "This archive contains two separate zip files:\n" .
        "- `backend.zip`: The Node.js application.\n" .
        "- `frontend.zip`: The HTML, CSS, and JavaScript assets for the frontend.\n\n" .
        "## How to Run\n\n" .
        "### Backend\n\n" .
        "1.  Extract `backend.zip`.\n" .
        "2.  Ensure you have Node.js and npm installed.\n" .
        "3.  Install dependencies:\n" .
        "    ```bash\n    npm install\n    ```\n" .
        "4.  Create a `.env` file in the root directory and configure your database connection (see `.env.example` if it exists).\n" .
        "5.  Run the application:\n" .
        "    ```bash\n    npm start\n    ```\n" .
        "    For development with auto-reloading, use:\n" .
        "    ```bash\n    npm run dev\n    ```\n\n" .
        "The GraphQL endpoint will be available at `http://localhost:4000/graphql`.\n\n" .
        "### Frontend\n\n" .
        "1.  Extract `frontend.zip`.\n" .
        "2.  Serve the files using any local web server (e.g., `python -m http.server`, `npx serve`, or Apache/Nginx).\n" .
        "3.  Open `index.html` in your browser.\n";
}

function getDatabaseDialect($driver)
{
    $dialect = '';
    // # Supported dialects: 'mysql', 'postgres', 'sqlite', 'mariadb', 'mssql'
    if ($driver == 'mysql' || $driver == 'mariadb') {
        $dialect = 'mysql';
    } else if ($driver == 'pgsql') {
        $dialect = 'postgres';
    } else if ($driver == 'sqlite') {
        $dialect = 'sqlite';
    } else if ($driver == 'sqlsrv') {
        $dialect = 'mssql';
    }
    return $dialect;
}

function setDatabaseConfiguration($application, $databaseConfiguration)
{
    $appConfig = new SecretObject(null);

    // Get from database
    $projectDirectory = $application->getProjectDirectory();

    $yml = $projectDirectory . "/default.yml";

    if(file_exists($yml))
    {
        $appConfig->loadYamlFile($yml, false, true, true);
        $databaseConfig = $appConfig->getDatabase();
        if($databaseConfig != null)
        {
            $databaseConfiguration = str_replace('{DB_DRIVER}', str_replace("'", "\\'", $databaseConfig->getDriver()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_HOST}', str_replace("'", "\\'", $databaseConfig->getHost()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_NAME}', str_replace("'", "\\'", $databaseConfig->getDatabaseName()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_FILE}', str_replace("'", "\\'", $databaseConfig->getDatabaseFilePath()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_USER}', str_replace("'", "\\'", $databaseConfig->getUsername()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_PASS}', str_replace("'", "\\'", $databaseConfig->getPassword()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_CHARSET}', str_replace("'", "\\'", $databaseConfig->getCharset()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_PORT}', str_replace("'", "\\'", $databaseConfig->getPort()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_TIMEZONE}', str_replace("'", "\\'", $databaseConfig->getTimeZone()), $databaseConfiguration);
            $databaseConfiguration = str_replace('{DB_DIALECT}', getDatabaseDialect($databaseConfig->getDriver()), $databaseConfiguration);
        }
    }
    return $databaseConfiguration;
}

$reservedColumnMap = createReservedColumnMap(isset($reservedColumns['columns']) ? $reservedColumns['columns'] : []);

$backendHandledColumns = []; // Define if needed for Node.js version

try {
    /** @var \MagicObject\Database\PicoDatabase $databaseBuilder */
    $application = getApplication($databaseBuilder, $applicationId);

    $generator = new GraphQLGeneratorNodeJs(
        $schema,
        $reservedColumns,
        $backendHandledColumns,
        $inMemoryCache
    );

    // --- Create Backend ZIP ---
    $backendZip = new ZipArchive();
    $backendZipFilePath = tempnam(sys_get_temp_dir(), 'backend_');
    if ($backendZip->open($backendZipFilePath, ZipArchive::CREATE | ZipArchive::OVERWRITE) !== TRUE) {
        throw new Exception("Could not create backend ZIP file.");
    }

    $backendFiles = $generator->generate();

    foreach ($backendFiles as $file) {
        if ($file['name'] == '.env') {
            $file['content'] = setDatabaseConfiguration($application, $file['content']);
        }
        $backendZip->addFromString($file['name'], $file['content']);
    }
    $backendZip->close();

    // --- Create Frontend ZIP ---
    $frontendZip = new ZipArchive();
    $frontendZipFilePath = tempnam(sys_get_temp_dir(), 'frontend_');
    if ($frontendZip->open($frontendZipFilePath, ZipArchive::CREATE | ZipArchive::OVERWRITE) !== TRUE) {
        throw new Exception("Could not create frontend ZIP file.");
    }

    // Add generated frontend config files
    $frontendZip->addFromString('config/frontend-config.json', $generator->generateFrontendConfigJson());

    // Add language files
    $frontendZip->addFromString('langs/available-language.json', file_get_contents(dirname(__DIR__) . "/inc.graphql-resources/frontend/langs/available-language.json"));
    $entityLanguagePacks = $generator->generateFrontendLanguageJson();
    $frontendZip->addFromString('langs/entity/source.json', $entityLanguagePacks);
    $frontendZip->addFromString('langs/entity/en.json', $entityLanguagePacks); // Assume 'en' is default

    // Add i18n files
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/langs/i18n/en.json", 'langs/i18n/source.json');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/langs/i18n/en.json", 'langs/i18n/en.json');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/langs/i18n/id.json", 'langs/i18n/id.json');

    // Add assets
    addDirectoryToZip($frontendZip, dirname(__DIR__) . "/inc.graphql-resources/frontend/assets", 'assets');

    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/assets/style.scss", 'assets/style.scss');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/assets/style.css", 'assets/style.css');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/assets/style.css.map", 'assets/style.css.map');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/assets/style.min.css", 'assets/style.min.css');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/assets/app-npm.js", 'assets/app.js');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/assets/app-npm.min.js", 'assets/app.min.js');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/assets/graphql.js", 'assets/graphql.js');
    $frontendZip->addFile(dirname(__DIR__) . "/inc.graphql-resources/frontend/assets/graphql.min.js", 'assets/graphql.min.js');

    
    // Add index.html
    $indexFileContent = file_get_contents(dirname(__DIR__) . "/inc.graphql-resources/frontend/index.html");
    $indexFileContent = str_replace('{APP_NAME}', $application->getName(), $indexFileContent);
    $frontendZip->addFromString('index.html', $indexFileContent);

    // Add icon files
    addFilesWithPrefixToZip($frontendZip, dirname(__DIR__) . "/inc.graphql-resources/frontend", '', 'icon-');
    addFilesWithPrefixToZip($frontendZip, dirname(__DIR__) . "/inc.graphql-resources/frontend", '', 'android-icon-');
    addFilesWithPrefixToZip($frontendZip, dirname(__DIR__) . "/inc.graphql-resources/frontend", '', 'apple-icon-');
    addFilesWithPrefixToZip($frontendZip, dirname(__DIR__) . "/inc.graphql-resources/frontend", '', 'favicon');

    $frontendZip->close();

    // --- Create Main ZIP ---
    $mainZip = new ZipArchive();
    $mainZipFilePath = tempnam(sys_get_temp_dir(), 'main_zip_');
    if ($mainZip->open($mainZipFilePath, ZipArchive::CREATE | ZipArchive::OVERWRITE) !== TRUE) {
        throw new Exception("Could not create main ZIP file.");
    }

    // Add backend.zip and frontend.zip to the main zip
    $mainZip->addFile($backendZipFilePath, 'backend.zip');
    $mainZip->addFile($frontendZipFilePath, 'frontend.zip');

    // Add documentation to the root of the main zip
    $manualMd = $generator->generateManual();
    $mainZip->addFromString('manual.md', $manualMd);
    $appName = $application->getName();
    $manualHtml = generateManualHtml($manualMd, $appName);
    $manualHtml = str_replace("{{title}}", "GraphQL API Manual for ".$appName, $manualHtml);
    $parsedown = new Parsedown();
    $manualBody = $parsedown->text($manualMd);
    $manualHtml = str_replace("{{body}}", $manualBody, $manualHtml);
    $mainZip->addFromString('manual.html', $manualHtml);

    $readmeContent = generateReadmeNodeJs($appName);
    $mainZip->addFromString('README.md', $readmeContent);
    $mainZip->close();

    // Send the ZIP file as a download
    header('Content-Type: application/zip');
    header('Content-Disposition: attachment; filename="' . $application->getApplicationId() . '-graphql-nodejs.zip"');
    header('Content-Length: ' . filesize($mainZipFilePath));
    readfile($mainZipFilePath);

    // Delete the temporary file
    unlink($backendZipFilePath);
    unlink($frontendZipFilePath);
    unlink($mainZipFilePath);
    exit();

} catch (Exception $e) {
    header("Content-Type: application/json");
    echo json_encode(['success' => false, 'message' => $e->getMessage()]);
    exit();
}